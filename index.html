<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/" rel="canonical">
<link href="index-11.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
<link href="posts/nlp/word-embeddings/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item active"><a class="nav-link" href=".">Cloistered Monkey <span class="sr-only">(active)</span></a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/word-embeddings/">Word Embeddings</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/word-embeddings/" rel="bookmark"><time class="published dt-published" datetime="2020-09-29T19:25:16-07:00" itemprop="datePublished" title="2020-09-29 19:25">2020-09-29 19:25</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/word-embeddings/#orgab87d10">Beginning</a>
<ul>
<li><a href="posts/nlp/word-embeddings/#orgbd251d5">Set Up</a></li>
<li><a href="posts/nlp/word-embeddings/#org72b3a1b">The Embeddings</a></li>
</ul>
</li>
<li><a href="posts/nlp/word-embeddings/#org929df71">Middle</a>
<ul>
<li><a href="posts/nlp/word-embeddings/#org8feaa11">Inspecting the Embeddings</a></li>
<li><a href="posts/nlp/word-embeddings/#org6fa970b">Word Distance</a></li>
<li><a href="posts/nlp/word-embeddings/#orgb34f8fe">Linear Algebra on Word Embeddings</a></li>
<li><a href="posts/nlp/word-embeddings/#orgd229602">Predicting Capitals</a></li>
<li><a href="posts/nlp/word-embeddings/#orga128379">More Countries</a></li>
<li><a href="posts/nlp/word-embeddings/#org4e076a9">Sentence Vectors</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgab87d10">
<h2 id="orgab87d10">Beginning</h2>
<div class="outline-text-2" id="text-orgab87d10">
<p>This is a walk through a lab for week 3 of Coursera's Natural Language Processing course. It's going to use some pretrained word embeddings to develop some sense of how to use them.</p>
</div>
<div class="outline-3" id="outline-container-orgbd251d5">
<h3 id="orgbd251d5">Set Up</h3>
<div class="outline-text-3" id="text-orgbd251d5"></div>
<div class="outline-4" id="outline-container-org32d4de2">
<h4 id="org32d4de2">Imports</h4>
<div class="outline-text-4" id="text-org32d4de2">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9b3b761">
<h4 id="org9b3b761">Plotting</h4>
<div class="outline-text-4" id="text-org9b3b761">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"word-embeddings"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">)</span>
<span class="n">plot_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="k">with</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org72b3a1b">
<h3 id="org72b3a1b">The Embeddings</h3>
<div class="outline-text-3" id="text-org72b3a1b">
<p>Like I mentioned abovve, I'm going to use pre-trained word embeddings that have been pickled so I'll load them here.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WORD_EMBEDDINGS"</span><span class="p">])</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">embeddings</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">243</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org929df71">
<h2 id="org929df71">Middle</h2>
<div class="outline-text-2" id="text-org929df71"></div>
<div class="outline-3" id="outline-container-org8feaa11">
<h3 id="org8feaa11">Inspecting the Embeddings</h3>
<div class="outline-text-3" id="text-org8feaa11">
<p>The <code>embeddings</code> is a dictionary of words to word-vectors that represent them. Here's the first 5 words.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">embeddings</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
<pre class="example">
&lt;class 'dict'&gt;
['country', 'city', 'China', 'Iraq', 'oil']
</pre>
<div class="highlight">
<pre><span></span><span class="n">vector</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"country"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
<pre class="example">
&lt;class 'numpy.ndarray'&gt;
(300,)
</pre>
<p>Each word-embedding vector has 300 entries.</p>
</div>
<div class="outline-4" id="outline-container-org0c9d865">
<h4 id="org0c9d865">Plotting</h4>
<div class="outline-text-4" id="text-org0c9d865">
<p>Since there are 300 columns you can't easily visualize them without using PCA or some other method, but this is more about getting an intuition as to how the linear-algebra works, so instead we're going to reduce a subset of words to only two columns so that we can plot them.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'oil'</span><span class="p">,</span> <span class="s1">'gas'</span><span class="p">,</span> <span class="s1">'happy'</span><span class="p">,</span> <span class="s1">'sad'</span><span class="p">,</span> <span class="s1">'city'</span><span class="p">,</span> <span class="s1">'town'</span><span class="p">,</span> <span class="s1">'village'</span><span class="p">,</span> <span class="s1">'country'</span><span class="p">,</span> <span class="s1">'continent'</span><span class="p">,</span> <span class="s1">'petroleum'</span><span class="p">,</span> <span class="s1">'joyful'</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>
<span class="n">plot_columns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_columns</span><span class="p">]</span>
<span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">]</span>
<span class="n">plot_data</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>
<span class="n">origins</span> <span class="o">=</span> <span class="n">plot_data</span> <span class="o">*</span> <span class="mi">0</span>
<span class="n">origins</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>
<span class="n">combined_plot_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">origins</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">])</span>

<span class="n">segment_plot</span> <span class="o">=</span> <span class="n">combined_plot_data</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>
<span class="n">scatter_plot</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">segment_plot</span> <span class="o">*</span> <span class="n">scatter_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Embeddings Columns 3 and 2"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"embeddings_segments"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/word-embeddings/embeddings_segments.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>You can see that words like "village" and "town" are similar while "city" and "oil" are opposites for whatever reason. Oddly, "joyful" and "country" are also very similar (although I'm only looking at two out of three-hundred columns so that might not be the case once the other columns enter into place).</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org6fa970b">
<h3 id="org6fa970b">Word Distance</h3>
<div class="outline-text-3" id="text-org6fa970b">
<p>This is supposed to be a visualization of the difference vectors between <i>sad</i> and <i>happy</i> and <i>town</i> and <i>village</i>, but as far as I can see holoviews doesn't have the equivalent of matplotlib's arrow which lets you use the base coordinate and distance in each dimension to draw arrows, so it's kind of a fake version where I use the points directly. Oh, well.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'sad'</span><span class="p">,</span> <span class="s1">'happy'</span><span class="p">,</span> <span class="s1">'town'</span><span class="p">,</span> <span class="s1">'village'</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_columns</span><span class="p">]</span>
<span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">]</span>
<span class="n">plot_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">words</span>
</pre></div>
<p>This is the fake part - when you take the difference between two "points" it gives you a vector with the base at the origin so you have to add the base point back in to move it from the origin, but then all you're doing is undoing the subtraction, giving you what you started with.</p>
<div class="highlight">
<pre><span></span><span class="n">difference</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
    <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"happy"</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"sad"</span><span class="p">]</span> <span class="o">+</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"sad"</span><span class="p">],</span>
    <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"town"</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"village"</span><span class="p">]</span> <span class="o">+</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"village"</span><span class="p">]</span>
<span class="p">])</span>

<span class="n">difference</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"sad"</span><span class="p">,</span> <span class="s2">"village"</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">))</span>

<span class="n">difference</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">difference</span><span class="p">,</span>
                            <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="o">.</span><span class="n">Word</span><span class="o">==</span><span class="s2">"sad"</span><span class="p">],</span>
                            <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="o">.</span><span class="n">Word</span><span class="o">==</span><span class="s2">"village"</span><span class="p">]])</span>


<span class="n">with_origin</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">origins</span><span class="p">[</span><span class="n">origins</span><span class="o">.</span><span class="n">Word</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">words</span><span class="p">)],</span> <span class="n">plot_data</span><span class="p">])</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>
<span class="n">segments</span> <span class="o">=</span> <span class="n">with_origin</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">difference</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">distances</span> <span class="o">*</span> <span class="n">segments</span> <span class="o">*</span> <span class="n">scatter</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Vector Differences"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"vector_differences"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/word-embeddings/vector_differences.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
<div class="outline-3" id="outline-container-orgb34f8fe">
<h3 id="orgb34f8fe">Linear Algebra on Word Embeddings</h3>
<div class="outline-text-3" id="text-orgb34f8fe"></div>
<div class="outline-4" id="outline-container-org4a31959">
<h4 id="org4a31959">The <b>norm</b></h4>
<div class="outline-text-4" id="text-org4a31959">
<p>First I'll check out the <a href="https://www.wikiwand.com/en/Norm_(mathematics)">norm</a> of some word vectors using <a href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.norm.html">numpy.linalg.norm</a>. This calculates the Euclidean Distance between vectors (but oddly we won't use it here).</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">"town"</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">"sad"</span><span class="p">]))</span>
</pre></div>
<pre class="example">
2.3858097
2.9004838
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd229602">
<h3 id="orgd229602">Predicting Capitals</h3>
<div class="outline-text-3" id="text-orgd229602">
<p>Here we'll see how to use the embeddings to predict what country a city is the capital of. To encode the concept of "capital" into a vector we'll use the difference between a specific country and its real capital (in this case <i>France</i> and <i>Paris</i>).</p>
<div class="highlight">
<pre><span></span><span class="n">capital</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"France"</span><span class="p">]</span> <span class="o">-</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"Paris"</span><span class="p">]</span>
</pre></div>
<p>Now that we have the concept of a capital encoded as a word embedding we can add it to the embedding of "Madrid" to get a vector near where "Spain" would be. Note that although there is a "Spain" in the embeddings we're going to use this to see if we can find it without knowing that Madrid is the capital of Spain.</p>
<div class="highlight">
<pre><span></span><span class="n">country</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"Madrid"</span><span class="p">]</span> <span class="o">+</span> <span class="n">capital</span>
</pre></div>
<p>To make a prediction we have to find the embeddings that are closest to a country. We're going to convert the embeddings to a pandas DataFrame and since our embeddings are a dictionary of arrays we'll have to do a little unpacking first.</p>
<div class="highlight">
<pre><span></span><span class="n">keys</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">embeddings</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">embeddings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
</pre></div>
<p>Now we'll make a function to find the closest embeddings for a word vector.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">closest_word</span><span class="p">(</span><span class="n">vector</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Find the word closest to a given vector</span>

<span class="sd">    Args:</span>
<span class="sd">     vector: the vector to match</span>

<span class="sd">    Returns:</span>
<span class="sd">     name of the closest embedding</span>
<span class="sd">    """</span>
    <span class="n">differences</span> <span class="o">=</span> <span class="n">embeddings</span> <span class="o">-</span> <span class="n">vector</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">differences</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="p">(</span><span class="n">differences</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">),)))</span>

    <span class="k">return</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<p>Now we can check what word most closesly matches <i>Madrid + (France - Paris)</i>.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">country</span><span class="p">))</span>
</pre></div>
<pre class="example">
Spain
</pre>
<p>Like magic.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orga128379">
<h3 id="orga128379">More Countries</h3>
<div class="outline-text-3" id="text-orga128379">
<p>What happens if we use a different know country and its capital instead of France and Paris?</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Italy'</span><span class="p">]</span> <span class="o">-</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Rome'</span><span class="p">]</span>
                   <span class="o">+</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Madrid'</span><span class="p">]))</span>
</pre></div>
<pre class="example">
Spain
</pre>
<p>So swapping the capital derivation didn't change the prediction. Now we'll go back to using <code>France - Paris</code> but try different cities.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="s2">"Tokyo Moscow"</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{word} is the capital of {closest_word(embeddings.loc[word] + capital)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Tokyo is the capital of Japan
Moscow is the capital of Russia
</pre>
<p>That seems to be working, but here's a case where our search fails.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Lisbon'</span><span class="p">]</span> <span class="o">+</span> <span class="n">capital</span><span class="p">))</span>
</pre></div>
<pre class="example">
Lisbon
</pre>
<p>For some reason "Lisbon" is closer to itself than portugal. I tried it with Germany and Italy instead of France as the template capital but it still didn't work. If you try random cities from the embeddings you'll see that a fair amount of them fail.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org4e076a9">
<h3 id="org4e076a9">Sentence Vectors</h3>
<div class="outline-text-3" id="text-org4e076a9">
<p>To use this for sentences you construct a vector with all the vectors for each word and then sum up all the columns to get back to a single vector.</p>
<div class="highlight">
<pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s2">"Canada oil city town"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
<span class="n">summed</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">summed</span><span class="p">))</span>
</pre></div>
<pre class="example">
city
</pre>
<p>Not exciting, but that's how you do it.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/tweet-classifier-class/">Tweet Classifier Class</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/tweet-classifier-class/" rel="bookmark"><time class="published dt-published" datetime="2020-09-09T17:49:07-07:00" itemprop="datePublished" title="2020-09-09 17:49">2020-09-09 17:49</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/tweet-classifier-class/#orge245b73">Beginning</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org76b7dc6">Middle</a>
<ul>
<li><a href="posts/nlp/tweet-classifier-class/#org355871d">The Logistic Regression Class</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#orgd9d2f7e">Weights</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org66ddfb1">The Weights Setter</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org21e4576">Sigmoid</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org60180a8">This is the training function</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org6bc968d">Fit</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#orgd4552fc">Predict</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#orgaa943ea">Score</a></li>
</ul>
</li>
<li><a href="posts/nlp/tweet-classifier-class/#org35299e8">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orge245b73">
<h2 id="orge245b73">Beginning</h2>
<div class="outline-text-2" id="text-orge245b73">
<p>I implemented the Logistic Regression Tweet Sentiment Analysis classifier in <a href="posts/nlp/implementing-twitter-logistic-regression/">this post</a> but I'm going to re-use it later so this just gathers everything together. There's already a class called <code>TweetSentiment</code> but I'm going to add the training to this one as well as the tweet pre-processing and vectorization.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org76b7dc6">
<h2 id="org76b7dc6">Middle</h2>
<div class="outline-text-2" id="text-org76b7dc6">
<p>We'll start with the imports.</p>
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
<span class="kn">from</span> <span class="nn">.sentiment</span> <span class="kn">import</span> <span class="n">TweetSentiment</span>
<span class="kn">from</span> <span class="nn">.vectorizer</span> <span class="kn">import</span> <span class="n">TweetVectorizer</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org355871d">
<h3 id="org355871d">The Logistic Regression Class</h3>
<div class="outline-text-3" id="text-org355871d">
<div class="highlight">
<pre><span></span><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LogisticRegression</span><span class="p">:</span>
    <span class="sd">"""train and predict tweet sentiment</span>

<span class="sd">    Args:</span>
<span class="sd">     iterations: number of times to run gradient descent</span>
<span class="sd">     learning_rate: how fast to change the weights during training</span>
<span class="sd">    """</span>
    <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">_weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="bp">None</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd9d2f7e">
<h3 id="orgd9d2f7e">Weights</h3>
<div class="outline-text-3" id="text-orgd9d2f7e">
<p>These are the weights for the regression function (\(\theta\)).</p>
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">"""The weights for the regression</span>

<span class="sd">    Initially this will be an array of zeros.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org66ddfb1">
<h3 id="org66ddfb1">The Weights Setter</h3>
<div class="outline-text-3" id="text-org66ddfb1">
<div class="highlight">
<pre><span></span><span class="nd">@weights.setter</span>
<span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sd">"""Set the weights to a new value"""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">new_weights</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org21e4576">
<h3 id="org21e4576">Sigmoid</h3>
<div class="outline-text-3" id="text-org21e4576">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculates the logistic function value</span>

<span class="sd">    Args:</span>
<span class="sd">     vectors: a matrix of bias, positive, negative wordc ounts</span>

<span class="sd">    Returns:</span>
<span class="sd">     array of probabilities that the tweets are positive</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">vectors</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org60180a8">
<h3 id="org60180a8">This is the training function</h3>
<div class="outline-text-3" id="text-org60180a8">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">gradient_descent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">"""Finds the weights for the model</span>

<span class="sd">    Args:</span>
<span class="sd">     x: the tweet vectors</span>
<span class="sd">     y: the positive/negative labels</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">/=</span> <span class="n">rows</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>
        <span class="c1"># average loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)))</span> <span class="o">+</span>
                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_hat</span><span class="p">))))</span><span class="o">/</span><span class="n">rows</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_hat</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradient</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6bc968d">
<h3 id="org6bc968d">Fit</h3>
<div class="outline-text-3" id="text-org6bc968d">
<p>This is mostly an alias to make it match (somewhat) sklearn's methods.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""fits the weights for the logistic regression</span>

<span class="sd">    Note:</span>
<span class="sd">     as a side effect this also sets counter, loss, and sentimenter attributes</span>

<span class="sd">    Args:</span>
<span class="sd">     x_train: the training tweets</span>
<span class="sd">     y_train: the training labels</span>

<span class="sd">    Returns:</span>
<span class="sd">     The final mean loss (which is also saved as the =.loss= attribute)</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">processed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_descent</span><span class="p">(</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd4552fc">
<h3 id="orgd4552fc">Predict</h3>
<div class="outline-text-3" id="text-orgd4552fc">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""Predict the labels for the inputs</span>

<span class="sd">    Args:</span>
<span class="sd">     x: a list or array of tweets</span>

<span class="sd">    Returns:</span>
<span class="sd">     array of predicted labels for the tweets</span>
<span class="sd">    """</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">processed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">sentimenter</span> <span class="o">=</span> <span class="n">TweetSentiment</span><span class="p">(</span><span class="n">vectorizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sentimenter</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgaa943ea">
<h3 id="orgaa943ea">Score</h3>
<div class="outline-text-3" id="text-orgaa943ea">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Get the mean accuracy</span>

<span class="sd">    Args:</span>
<span class="sd">     x: arrray of tweets</span>
<span class="sd">     y: labels for the tweets</span>

<span class="sd">    Returns:</span>
<span class="sd">     mean accuracy</span>
<span class="sd">    """</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">correct</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org35299e8">
<h2 id="org35299e8">End</h2>
<div class="outline-text-2" id="text-org35299e8">
<p>Testing it out.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">expect</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.logistic_regression</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>

<span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>


<span class="n">Settings</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">,</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span>
                           <span class="n">learning_rate</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="o">=</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="mf">0.22043072</span>
<span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Accuracy: {accuracy}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Accuracy: 0.996
</pre></div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/visualizing-naive-bayes/">Visualizing Naive Bayes</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/visualizing-naive-bayes/" rel="bookmark"><time class="published dt-published" datetime="2020-08-31T06:16:19-07:00" itemprop="datePublished" title="2020-08-31 06:16">2020-08-31 06:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#orgcee6cee">Beginning</a>
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#org5720a72">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/visualizing-naive-bayes/#orge08b685">Middle</a>
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#org150f4f3">Log Likelihoods</a></li>
<li><a href="posts/nlp/visualizing-naive-bayes/#org22ea2ab">Confidence Ellipses</a></li>
</ul>
</li>
<li><a href="posts/nlp/visualizing-naive-bayes/#org308309c">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgcee6cee">
<h2 id="orgcee6cee">Beginning</h2>
<div class="outline-text-2" id="text-orgcee6cee">
<p>In the <a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/">previous post</a> I made a class-based version of the Naive Bayes Classifier for tweets. For this post I'm going to plot the model values. It turns out that we need to get at some values that the previous implementations hide so I'm going to re-calculate the likelihoods from scratch rather than alter the previous code.</p>
</div>
<div class="outline-3" id="outline-container-org5720a72">
<h3 id="org5720a72">Set Up</h3>
<div class="outline-text-3" id="text-org5720a72"></div>
<div class="outline-4" id="outline-container-orgba0e845">
<h4 id="orgba0e845">Imports</h4>
<div class="outline-text-4" id="text-orgba0e845">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Ellipse</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="kn">as</span> <span class="nn">transforms</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>

<span class="c1"># graeae</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org46a4b98">
<h4 id="org46a4b98">The Dotenv</h4>
<div class="outline-text-4" id="text-org46a4b98">
<div class="highlight">
<pre><span></span><span class="n">env_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">env_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org46b5cf7">
<h4 id="org46b5cf7">Plotting</h4>
<div class="outline-text-4" id="text-org46b5cf7">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"visualizing-naive-bayes"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">,</span> <span class="n">create_folder</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">plot_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="k">with</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">seaborn</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">"whitegrid"</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2163982">
<h4 id="org2163982">The Data</h4>
<div class="outline-text-4" id="text-org2163982">
<div class="highlight">
<pre><span></span><span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training: {len(train_raw):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Testing: {len(test_raw):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000
Testing: 2,000
</pre></div>
</div>
<div class="outline-4" id="outline-container-org3acd1b0">
<h4 id="org3acd1b0">The Word Counter</h4>
<div class="outline-text-4" id="text-org3acd1b0">
<p>This is a class to clean and tokenize the tweets and build up a Counter with the word counts.</p>
<div class="highlight">
<pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9b8e52c">
<h4 id="org9b8e52c">Constants</h4>
<div class="outline-text-4" id="text-org9b8e52c">
<div class="highlight">
<pre><span></span><span class="n">Sentiment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orge08b685">
<h2 id="orge08b685">Middle</h2>
<div class="outline-text-2" id="text-orge08b685"></div>
<div class="outline-3" id="outline-container-org150f4f3">
<h3 id="org150f4f3">Log Likelihoods</h3>
<div class="outline-text-3" id="text-org150f4f3"></div>
<div class="outline-4" id="outline-container-orgdb513aa">
<h4 id="orgdb513aa">Calculating the Likelihoods</h4>
<div class="outline-text-4" id="text-orgdb513aa">
<p>The first thing to plot are the log-likelihoods for positive and negative tweets. When I implemented the Naive Bayes Classifier I took advantage of the fact that we're making a binary classifier and took the odds ratio when making predictions, but for our plot we're going to need to undo the division and plot the numerator against the denominator.</p>
\begin{align} log \frac{P(tweet|pos)}{P(tweet|neg)} &amp;= log(P(tweet|pos)) - log(P(tweet|neg)) \\ positive = log(P(tweet|pos)) &amp;= \sum_{i=0}^{n}{log P(W_i|pos)}\\ negative = log(P(tweet|neg)) &amp;= \sum_{i=0}^{n}{log P(W_i|neg)}\\ \end{align}
<p>So, let's get the log-likelihoods.</p>
<div class="highlight">
<pre><span></span><span class="n">COUNTS</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">counts</span>

<span class="n">positive_loglikelihood</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">negative_loglikelihood</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">log_ratio</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">all_positive_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
    <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">COUNTS</span>
     <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
<span class="n">all_negative_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
    <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">COUNTS</span>
     <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span>

<span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">COUNTS</span><span class="p">}</span>
<span class="n">vocabulary_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>

<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
    <span class="n">this_word_positive_count</span> <span class="o">=</span> <span class="n">COUNTS</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
    <span class="n">this_word_negative_count</span> <span class="o">=</span> <span class="n">COUNTS</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>

    <span class="n">probability_word_is_positive</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_positive_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                    <span class="p">(</span><span class="n">all_positive_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>
    <span class="n">probability_word_is_negative</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_negative_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                    <span class="p">(</span><span class="n">all_negative_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>
    <span class="n">positive_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_positive</span><span class="p">)</span>
    <span class="n">negative_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_negative</span><span class="p">)</span>
    <span class="n">log_ratio</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">positive_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">-</span> <span class="n">negative_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
</pre></div>
<p>So now we have our positive and negative log-likelihoods and I'll put them into a pandas DataFrame to make it easier to plot.</p>
<div class="highlight">
<pre><span></span><span class="n">positive_document_likelihood</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">negative_document_likelihood</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sentiment</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>

    <span class="n">positive_document_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">positive_loglikelihood</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">))</span>
    <span class="n">negative_document_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">negative_loglikelihood</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">))</span>
    <span class="n">sentiment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">positive_document_likelihood</span><span class="p">,</span>
        <span class="n">negative</span> <span class="o">=</span> <span class="n">negative_document_likelihood</span><span class="p">,</span>
        <span class="n">sentiment</span><span class="o">=</span><span class="n">sentiment</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
<pre class="example">
     positive   negative  sentiment
0  -26.305672 -33.940649          1
1  -30.909803 -37.634516          1
2  -42.936400 -33.403567          0
3  -15.983546 -25.501140          1
4 -107.899933 -99.191875          0
</pre></div>
</div>
<div class="outline-4" id="outline-container-org3eabfbd">
<h4 id="org3eabfbd">Plotting the Likelihoods</h4>
<div class="outline-text-4" id="text-org3eabfbd">
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"sentiment"</span><span class="p">,</span>
                               <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                                   <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative"</span><span class="p">,</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                   <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                                   <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_vs_negative_sentiment"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/visualizing-naive-bayes/positive_vs_negative_sentiment.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It looks like the log likelihoods for the negatives are linearly separable.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org22ea2ab">
<h3 id="org22ea2ab">Confidence Ellipses</h3>
<div class="outline-text-3" id="text-org22ea2ab">
<p>Now we're going to plot a <a href="https://www.wikiwand.com/en/Confidence_region">Confidence Region</a>, which is a generalization of a confidence interval to higher dimensions. In this case we're going to create confidence ellipses. I'm not really sure about the details of the math to get them, but matplotlib has <a href="https://matplotlib.org/3.1.1/gallery/statistics/confidence_ellipse.html">a page</a> with a function to create a matplotlib plot for a confidence ellipse that I'm going to adapt.</p>
</div>
<div class="outline-4" id="outline-container-orga3acce6">
<h4 id="orga3acce6">The Ellipse Function</h4>
<div class="outline-text-4" id="text-orga3acce6">
<p>This is taken almost verbatim from matplotlib's page.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">confidence_ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Create a plot of the covariance confidence ellipse of `x` and `y`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x, y : array_like, shape (n, )</span>
<span class="sd">       Input data.</span>

<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">       The axes object to draw the ellipse into.</span>

<span class="sd">    n_std : float</span>
<span class="sd">       The number of standard deviations to determine the ellipse's radiuses.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.patches.Ellipse</span>

<span class="sd">    Other parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    kwargs : `~matplotlib.patches.Patch` properties</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"x and y must be the same size"</span><span class="p">)</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">pearson</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Using a special case to obtain the eigenvalues of this</span>
    <span class="c1"># two-dimensionl dataset.</span>
    <span class="n">ell_radius_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pearson</span><span class="p">)</span>
    <span class="n">ell_radius_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pearson</span><span class="p">)</span>
    <span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">ell_radius_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">height</span><span class="o">=</span><span class="n">ell_radius_y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span>
                      <span class="p">)</span>

    <span class="c1"># Calculating the stdandard deviation of x from</span>
    <span class="c1"># the squareroot of the variance and multiplying</span>
    <span class="c1"># with the given number of standard deviations.</span>
    <span class="n">scale_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>
    <span class="n">mean_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># calculating the stdandard deviation of y ...</span>
    <span class="n">scale_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>
    <span class="n">mean_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">transf</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Affine2D</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">rotate_deg</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">mean_x</span><span class="p">,</span> <span class="n">mean_y</span><span class="p">)</span>

    <span class="n">ellipse</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">transf</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">positives</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">sentiment</span><span class="o">==</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">]</span>
<span class="n">negatives</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">sentiment</span><span class="o">==</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">]</span>

<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">positives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">positives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$2\sigma$'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">negatives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">negatives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>

<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">positives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">positives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$3\sigma$'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">negatives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">negatives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>

<span class="n">SIZE</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">positives</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s2">"none"</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">)</span>
<span class="n">negatives</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>

<span class="n">LIMITS</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">LIMITS</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">LIMITS</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Confidence Ellipses"</span><span class="p">)</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">"ellipses.png"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="ellipses.png" src="posts/nlp/visualizing-naive-bayes/ellipses.png"></p>
</div>
<p>It's a bit squashed looking, since the results are so tight, but you can sort of see that the distributions are "left-skewed", with the points that fall outside of the \(3 \sigma\) range being the cases where the "positive" and "negative" values are both negative.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org308309c">
<h2 id="org308309c">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/">Class-Based Naive Bayes Tweet Sentiment Classifier</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/" rel="bookmark"><time class="published dt-published" datetime="2020-08-29T11:01:51-07:00" itemprop="datePublished" title="2020-08-29 11:01">2020-08-29 11:01</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orged9c18b">Beginning</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org9e38758">The Naive Bayes Classifier</a>
<ul>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org89aaaad">Imports</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org7df13cb">The Sentiment Constants</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orga454d48">The Declaration</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orga47d8e3">The Counter</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgd3dff11">The Vocabulary</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org173cacc">The logprior</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orga2955b4">The loglikelihood</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org91fd3f4">Predict Probability</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org0633832">Predict Sentiment</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgcc8f480">Check Rep</a></li>
</ul>
</li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org035ab93">Testing</a>
<ul>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org4c8d9fb">Imports</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org94eaf13">Test Setup</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org7639fb1">Can you construct it?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgbc8d994">Does it build the counter?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgb91c568">Does it build the logprior?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgb1cca3e">Does it build the vocabulary?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgf7f93f6">Does it build the log-likelihood?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgb22af01">Does it predict probabilities?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org8b75b8b">Does it predict the sentiment?</a></li>
</ul>
</li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org6c71627">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orged9c18b">
<h2 id="orged9c18b">Beginning</h2>
<div class="outline-text-2" id="text-orged9c18b">
<p>I <a href="posts/nlp/naive-bayes-twitter-sentiment-classification/">previously implemented</a> a Naive Bayes Classifier for Tweets as separate functions, and while that is useful for learningi I want to re-use it so I'm going to re-implement it as a class-based system.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org9e38758">
<h2 id="org9e38758">The Naive Bayes Classifier</h2>
<div class="outline-text-2" id="text-org9e38758"></div>
<div class="outline-3" id="outline-container-org89aaaad">
<h3 id="org89aaaad">Imports</h3>
<div class="outline-text-3" id="text-org89aaaad">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7df13cb">
<h3 id="org7df13cb">The Sentiment Constants</h3>
<div class="outline-text-3" id="text-org7df13cb">
<div class="highlight">
<pre><span></span><span class="n">Sentiment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga454d48">
<h3 id="orga454d48">The Declaration</h3>
<div class="outline-text-3" id="text-orga454d48">
<div class="highlight">
<pre><span></span><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NaiveBayes</span><span class="p">:</span>
    <span class="sd">"""Naive Bayes Sentiment Classifier for Tweets</span>

<span class="sd">    Args:</span>
<span class="sd">     tweets: the training tweets</span>
<span class="sd">     labels: the sentiment labels for the training tweets</span>
<span class="sd">    """</span>
    <span class="n">tweets</span><span class="p">:</span> <span class="n">Iterable</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Iterable</span>
    <span class="n">_counter</span><span class="p">:</span> <span class="n">WordCounter</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_logprior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_loglikelihood</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga47d8e3">
<h3 id="orga47d8e3">The Counter</h3>
<div class="outline-text-3" id="text-orga47d8e3">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WordCounter</span><span class="p">:</span>
    <span class="sd">"""The word processor/counter"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd3dff11">
<h3 id="orgd3dff11">The Vocabulary</h3>
<div class="outline-text-3" id="text-orgd3dff11">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
    <span class="sd">"""The unique tokens in the tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org173cacc">
<h3 id="org173cacc">The logprior</h3>
<div class="outline-text-3" id="text-org173cacc">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">logprior</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""the log-odds of the priors"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logprior</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">positive_documents</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">negative_documents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">positive_documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logprior</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">positive_documents</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">negative_documents</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logprior</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga2955b4">
<h3 id="orga2955b4">The loglikelihood</h3>
<div class="outline-text-3" id="text-orga2955b4">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">loglikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""The log-likelihoods for words"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span>        

        <span class="n">all_positive_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
             <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
        <span class="n">all_negative_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
             <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span>
        <span class="n">vocabulary_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">:</span>
            <span class="n">this_word_positive_count</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
            <span class="n">this_word_negative_count</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>

            <span class="n">probability_word_is_positive</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_positive_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                         <span class="p">(</span><span class="n">all_positive_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>
            <span class="n">probability_word_is_negative</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_negative_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                         <span class="p">(</span><span class="n">all_negative_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_positive</span><span class="p">)</span> <span class="o">-</span>
                                         <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_negative</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org91fd3f4">
<h3 id="org91fd3f4">Predict Probability</h3>
<div class="outline-text-3" id="text-org91fd3f4">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""predict the odds-ratio positive/negative</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: the tweet to predict</span>

<span class="sd">    Returns:</span>
<span class="sd">     log-odds-ratio for tweet (positive/negative)</span>
<span class="sd">    """</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprior</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglikelihood</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0633832">
<h3 id="org0633832">Predict Sentiment</h3>
<div class="outline-text-3" id="text-org0633832">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict_sentiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Predict whether the tweet's sentiment is positive or negative</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: the 'document' to analyze</span>

<span class="sd">    Returns:</span>
<span class="sd">     the sentiment (0=negative, 1=positive)</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_ratio</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgcc8f480">
<h3 id="orgcc8f480">Check Rep</h3>
<div class="outline-text-3" id="text-orgcc8f480">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">check_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sd">"""Does some basic checks of the input arguments"""</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org035ab93">
<h2 id="org035ab93">Testing</h2>
<div class="outline-text-2" id="text-org035ab93"></div>
<div class="outline-3" id="outline-container-org4c8d9fb">
<h3 id="org4c8d9fb">Imports</h3>
<div class="outline-text-3" id="text-org4c8d9fb">
<div class="highlight">
<pre><span></span><span class="sd">"""NaiveBayes Tweet Sentiment Classifier feature tests."""</span>

<span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be</span><span class="p">,</span>
    <span class="n">be_empty</span><span class="p">,</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">then</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">pytest_bdd</span>

<span class="c1"># this test repo</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.naive_bayes</span> <span class="kn">import</span> <span class="n">NaiveBayes</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org94eaf13">
<h3 id="org94eaf13">Test Setup</h3>
<div class="outline-text-3" id="text-org94eaf13">
<div class="highlight">
<pre><span></span><span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/naive_bayes.feature"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7639fb1">
<h3 id="org7639fb1">Can you construct it?</h3>
<div class="outline-text-3" id="text-org7639fb1">
<div class="highlight">
<pre><span></span>Feature: NaiveBayes Tweet Sentiment Classifier

Scenario: The user builds the classifier
  Given a Naive Bayes definition
  When the user builds the classifier
  Then it has the expected attributes
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user builds the classifier</span>


<span class="nd">@given</span><span class="p">(</span><span class="s1">'a Naive Bayes definition'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_naive_bayes_definition</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">NaiveBayes</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s1">'the user builds the classifier'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">the_user_builds_the_classifier</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="s2">"alfa bravo charley"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">definition</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                              <span class="n">labels</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s1">'it has the expected attributes'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">it_has_the_expected_attributes</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">check_rep</span><span class="p">()</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbc8d994">
<h3 id="orgbc8d994">Does it build the counter?</h3>
<div class="outline-text-3" id="text-orgbc8d994">
<div class="highlight">
<pre><span></span>Scenario: The user checks the counter
  Given a Naive Bayes classifier
  When the user checks the counter
  Then it is the expected counter
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user checks the counter</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Naive Bayes classifier"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">build_naive_classifier</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">NaiveBayes</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="p">[],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the counter"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">WordCounter</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter_definition</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter_definition</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span>
    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"neurotic.nlp.twitter.naive_bayes.WordCounter"</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counter_definition</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_counter</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">counter</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is the expected counter"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_counter</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb91c568">
<h3 id="orgb91c568">Does it build the logprior?</h3>
<div class="outline-text-3" id="text-orgb91c568">
<div class="highlight">
<pre><span></span>Scenario: The user checks the log-prior
 Given a valid Naive Bayes Classifier
 When the user checks the log-odds prior
 Then it is close enough
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user checks the log-prior</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a valid Naive Bayes Classifier"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_classifier</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"a blowfish"</span><span class="p">,</span> <span class="s2">"b closing"</span><span class="p">,</span> <span class="s2">"c that"</span><span class="p">,</span> <span class="s2">"d plane"</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({</span>
        <span class="p">(</span><span class="s2">"appl"</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>

    <span class="p">})</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">NaiveBayes</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                     <span class="n">labels</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">_counts</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counts</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the log-odds prior"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_log_odds_prior</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">logprior</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is close enough"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_close_enough</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb1cca3e">
<h3 id="orgb1cca3e">Does it build the vocabulary?</h3>
<div class="outline-text-3" id="text-orgb1cca3e">
<div class="highlight">
<pre><span></span>Scenario: The user checks the vocabulary
  Given a valid Naive Bayes Classifier
  When the user checks the vocabulary
  Then all the words are there
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user checks the vocabulary</span>
<span class="c1">#  Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the vocabulary"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_vocabulary</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
  <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">vocabulary</span>
  <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"appl"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">}</span>
  <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"all the words are there"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compare_words</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">^</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_empty</span><span class="p">)</span>
  <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf7f93f6">
<h3 id="orgf7f93f6">Does it build the log-likelihood?</h3>
<div class="outline-text-3" id="text-orgf7f93f6">
<div class="highlight">
<pre><span></span>Scenario: The user gets the log-likelihood dictionary
  Given a valid Naive Bayes Classifier
  When the user checks the loglikelihoods
  Then they are close enough
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user gets the log-likelihood dictionary</span>
<span class="c1">#  Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the loglikelihoods"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_log_likelihoods</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">appl</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">6</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span>
        <span class="n">b</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span>
        <span class="n">c</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"they are close enough"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_close_values</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">[</span><span class="n">word</span><span class="p">],</span>
                            <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">[</span><span class="n">word</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb22af01">
<h3 id="orgb22af01">Does it predict probabilities?</h3>
<div class="outline-text-3" id="text-orgb22af01">
<div class="highlight">
<pre><span></span>Scenario: User predicts tweet positive probability
  Given a valid Naive Bayes Classifier
  When the user makes a tweet prediction
  Then it is the expected probability
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: User predicts tweet positive probability</span>
<span class="c1">#   Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user makes a tweet prediction"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_prediction</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">logprior</span>
                         <span class="o">+</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">[</span><span class="s2">"c"</span><span class="p">]</span>
                         <span class="o">+</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">[</span><span class="s2">"b"</span><span class="p">])</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_ratio</span><span class="p">(</span>
        <span class="s2">"c you later b"</span>
    <span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is the expected probability"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_probability</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8b75b8b">
<h3 id="org8b75b8b">Does it predict the sentiment?</h3>
<div class="outline-text-3" id="text-org8b75b8b">
<div class="highlight">
<pre><span></span>Scenario: The user predicts tweet sentiment
  Given a valid Naive Bayes Classifier
  When the user predicts the sentiment of tweets
  Then the sentiments are the expected ones
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user predicts tweet sentiment</span>
<span class="c1">#   Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user predicts the sentiment of tweets"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_predict_sentiment</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_1</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_sentiment</span><span class="p">(</span><span class="s2">"c you later b"</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected_1</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_2</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_sentiment</span><span class="p">(</span><span class="s2">"apple banana tart"</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected_2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the sentiments are the expected ones"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_sentiments</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected_1</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected_2</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org6c71627">
<h2 id="org6c71627">End</h2>
<div class="outline-text-2" id="text-org6c71627">
<p>Now that we have the class-based version let's do a little <a href="posts/nlp/visualizing-naive-bayes/">visualization of the model</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/naive-bayes-twitter-sentiment-classification/">Implementing a Naive Bayes Twitter Sentiment Classifier</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/" rel="bookmark"><time class="published dt-published" datetime="2020-08-29T10:16:04-07:00" itemprop="datePublished" title="2020-08-29 10:16">2020-08-29 10:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org7dbc949">Beginning</a>
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org89b4a70">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org8fbeb8a">Middle</a>
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org257a319">Implementing the Model</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org6cb5e31">Making Predictions</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org81ac327">Filtering Words</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orgd923c1d">Error Analysis</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org9d154e4">Predict Your Own Tweet</a></li>
</ul>
</li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orgf03561d">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org7dbc949">
<h2 id="org7dbc949">Beginning</h2>
<div class="outline-text-2" id="text-org7dbc949">
<p>In the <a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/">previous post</a> I went through some of the background of how Naive Bayes works. In this post I'll implement a Naive Bayes Classifier to classify tweets by whether they are positive in sentiment or negative. The Naive Bayes model uses Bayes' rule to make its predictions and it's called "naive" because it makes the assumption that words in the document are independent (in the probability event sense) which allows us to use the multiplication rule to calculate our probabilities. It also uses the \(\textit{Bag of Words}\) assumption that word ordering isn't important.</p>
</div>
<div class="outline-3" id="outline-container-org89b4a70">
<h3 id="org89b4a70">Set Up</h3>
<div class="outline-text-3" id="text-org89b4a70">
<p>This first bit imports the needed dependencies followed by setting up the data and some helpers.</p>
</div>
<div class="outline-4" id="outline-container-orgdec7ea1">
<h4 id="orgdec7ea1">Imports</h4>
<div class="outline-text-4" id="text-orgdec7ea1">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge76bdf1">
<h4 id="orge76bdf1">Tabulate</h4>
<div class="outline-text-4" id="text-orge76bdf1">
<p>This sets up tabulate to make it a little simpler to display pandas DataFrames in org.</p>
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org788a447">
<h4 id="org788a447">The Dotenv</h4>
<div class="outline-text-4" id="text-org788a447">
<p>I put the path to the data files in a .env file so this loads it into the environment.</p>
<div class="highlight">
<pre><span></span><span class="n">env_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">env_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcfb4a10">
<h4 id="orgcfb4a10">Load the Twitter Data</h4>
<div class="outline-text-4" id="text-orgcfb4a10">
<p>I split the data <a href="posts/nlp/01-twitter-preprocessing-with-nltk/">previously</a> for the Logistic Regression twitter sentiment classifier so I'll load it here and skip building the sets.</p>
<div class="highlight">
<pre><span></span><span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training: {len(train_raw):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Testing: {len(test_raw):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000
Testing: 2,000
</pre>
<p>I'll also re-use the WordCounter from the Logistic Regression. Despite the name it also does tokenizing and cleaning.</p>
<div class="highlight">
<pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9d9af38">
<h4 id="org9d9af38">Constants</h4>
<div class="outline-text-4" id="text-org9d9af38">
<p>This was an object I created to store a few constant values.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">],</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Sentiment</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">Sentiment</span><span class="p">)</span>
</pre></div>
<pre class="example">
Namespace(decode={1: 'positive', 0: 'negative'}, encode={'positive': 1, 'negative': 0}, negative=0, positive=1)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8fbeb8a">
<h2 id="org8fbeb8a">Middle</h2>
<div class="outline-text-2" id="text-org8fbeb8a"></div>
<div class="outline-3" id="outline-container-org257a319">
<h3 id="org257a319">Implementing the Model</h3>
<div class="outline-text-3" id="text-org257a319">
<p>In an <a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/">earlier post</a> I wrote up a little of the background behind what we're doing and now I'm going to translate the math in that post into code.</p>
</div>
<div class="outline-4" id="outline-container-org38cb2b2">
<h4 id="org38cb2b2">Implementing The Training Function</h4>
<div class="outline-text-4" id="text-org38cb2b2">
<p>The first part of the problem - training the model by building up the probabilities.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_naive_bayes</span><span class="p">(</span><span class="n">counts</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span>
                      <span class="n">train_x</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                      <span class="n">train_y</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       counts: Counter from (word, label) to how often the word appears</span>
<span class="sd">       train_x: a list of tweets</span>
<span class="sd">       train_y: a list of labels correponding to the tweets (0,1)</span>

<span class="sd">    Returns:</span>
<span class="sd">       logprior: the log odds ratio</span>
<span class="sd">       loglikelihood: log likelihood dictionary for the Naive bayes equation</span>
<span class="sd">    """</span>
    <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">logprior</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">vocabulary</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">])</span>
    <span class="n">V</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>

    <span class="c1"># number of positive and negative words in the training set</span>
    <span class="n">N_pos</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
                 <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
    <span class="n">N_neg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
                 <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span>

    <span class="n">D</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>

    <span class="c1"># D_pos is number of positive documents</span>
    <span class="n">D_pos</span> <span class="o">=</span> <span class="n">train_y</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># D_neg is the number of negative documents</span>
    <span class="n">D_neg</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">D_pos</span>

    <span class="c1"># the log odds ratio</span>
    <span class="n">logprior</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_neg</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
        <span class="n">freq_pos</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
        <span class="n">freq_neg</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>

        <span class="c1"># the probability that the word is positive, and negative</span>
        <span class="n">p_w_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N_pos</span> <span class="o">+</span> <span class="n">V</span><span class="p">)</span>
        <span class="n">p_w_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_neg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N_neg</span> <span class="o">+</span> <span class="n">V</span><span class="p">)</span>

        <span class="n">loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_w_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_w_neg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span>
</pre></div>
<p>Now we can see what we get when we train our model.</p>
<div class="highlight">
<pre><span></span><span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">train_naive_bayes</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Log Prior: {logprior}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Words in Log Likelihood: {len(loglikelihood):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Log Prior: -0.006500022885560952
Words in Log Likelihood: 9,172
</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Positive Tweets: {len(train_raw[train_raw.label==Sentiment.positive]):,}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Negative Tweets: {len(train_raw[train_raw.label==Sentiment.negative]):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Positive Tweets: 3,987
Negative Tweets: 4,013
</pre>
<p>We get a negative value for the <code>logprior</code> because we have more negative tweets than positive tweets in the training set and the negative count is the second term when we calculate the difference for the <code>logprior</code>. If we evened it out it would drop to 0.</p>
<div class="highlight">
<pre><span></span><span class="n">all_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_raw</span><span class="p">,</span> <span class="n">test_raw</span><span class="p">])</span>
<span class="n">check</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">all_raw</span><span class="p">[</span><span class="n">all_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4000</span><span class="p">],</span> <span class="n">all_raw</span><span class="p">[</span><span class="n">all_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4000</span><span class="p">]])</span>
<span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">train_naive_bayes</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">check</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">check</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Log Prior: {logprior}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Log Likelihood: {len(loglikelihood)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Log Prior: 0.0
Log Likelihood: 9172
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6cb5e31">
<h3 id="org6cb5e31">Making Predictions</h3>
<div class="outline-text-3" id="text-org6cb5e31">
<p>Now that we have the model we can use it to make some predictions.</p>
<p>\[ p = logprior + \sum_i^N (loglikelihood_i) \]</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logprior</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       tweet: a tweet to classify</span>
<span class="sd">       logprior: the log odds ratio of prior probabilities</span>
<span class="sd">       loglikelihood: a dictionary of words mapped to their log likelihood ratios</span>

<span class="sd">    Returns:</span>
<span class="sd">       p: sum of the log-odds ratio for the tweet</span>
<span class="sd">    """</span>
    <span class="c1"># process the tweet to get a list of words</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logprior</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
</pre></div>
<p>Now test it with a tweet.</p>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s1">'She smiled.'</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'The positive to negative ratio is {p:0.2f}.'</span><span class="p">)</span>
</pre></div>
<pre class="example">
The positive to negative ratio is 1.44.
</pre>
<p>Since the ratio is greater than 0, we're predicting that the tweet has a positive sentiment.</p>
</div>
<div class="outline-4" id="outline-container-org9ad2871">
<h4 id="org9ad2871">Test The Model</h4>
<div class="outline-text-4" id="text-org9ad2871">
<p>Now we'll calculate the accuracy of the model against the test set.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_naive_bayes</span><span class="p">(</span><span class="n">test_x</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">test_y</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                     <span class="n">logprior</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       test_x: tweets to classify</span>
<span class="sd">       test_y: labels for test_x</span>
<span class="sd">       logprior: the logprior for the training set</span>
<span class="sd">       loglikelihood: a dictionary with the loglikelihoods for each word</span>

<span class="sd">    Returns:</span>
<span class="sd">       accuracy: (# of tweets classified correctly)/(total # of tweets)</span>
<span class="sd">    """</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">y_hats</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">test_x</span><span class="p">])</span>

    <span class="c1"># error is the average of the absolute values of the differences between y_hats and test_y</span>
    <span class="c1"># error = number wrong/number of tweets</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_hats</span> <span class="o">-</span> <span class="n">test_y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Accuracy is 1 minus the error</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">error</span>
    <span class="k">return</span> <span class="n">accuracy</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"Naive Bayes accuracy = </span><span class="si">%0.4f</span><span class="s2">"</span> <span class="o">%</span>
      <span class="p">(</span><span class="n">test_naive_bayes</span><span class="p">(</span><span class="n">test_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)))</span>
</pre></div>
<pre class="example">
Naive Bayes accuracy = 0.9955
</pre>
<p>Which looks good, but it might actually be overfitting - it looks too good. Now here's some example tweets to check.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'I am happy'</span><span class="p">,</span> <span class="s1">'I am bad'</span><span class="p">,</span> <span class="s1">'this movie should have been great.'</span><span class="p">,</span>
              <span class="s1">'great'</span><span class="p">,</span> <span class="s1">'great great'</span><span class="p">,</span> <span class="s1">'great great great'</span><span class="p">,</span> <span class="s1">'great great great great'</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'{tweet} -&gt; {p:.2f}'</span><span class="p">)</span>
</pre></div>
<pre class="example">
I am happy -&gt; 1.89
I am bad -&gt; -1.63
this movie should have been great. -&gt; 2.05
great -&gt; 2.06
great great -&gt; 4.13
great great great -&gt; 6.19
great great great great -&gt; 8.25
</pre>
<p>It looks like the word "great" throws off the third sentence which hints at being negative. What if we pass in a neutral (nonsensical) tweet?</p>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s2">"the answer is nicht in the umwelt"</span>
<span class="k">print</span><span class="p">(</span><span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">))</span>
</pre></div>
<pre class="example">
-0.41441957689474407
</pre>
<p>I don't know which of those words triggered the negative value</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="s2">"the answer is nicht in the umwelt"</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{word}:</span><span class="se">\t</span><span class="s2">{naive_bayes_predict(word, logprior, loglikelihood):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
the:    0.00
answer: -0.41
is:     0.00
nicht:  0.00
in:     0.00
the:    0.00
umwelt: 0.00
</pre>
<p>It only got one word, <code>answer</code> and that's negative for some reason. Go figure.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org81ac327">
<h3 id="org81ac327">Filtering Words</h3>
<div class="outline-text-3" id="text-org81ac327">
<p>This is sort of an aside, but one way to quickly filter tweets based on how positive or negative they are is to use the ratio of positive to negative counts and setting a threshold that has to be met to be included in the output.</p>
<p>\[ ratio = \frac{\text{pos_words} + 1}{\text{neg_words} + 1} \]</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Words</th>
<th class="org-right" scope="col">Positive word count</th>
<th class="org-right" scope="col">Negative Word Count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">glad</td>
<td class="org-right">41</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">arriv</td>
<td class="org-right">57</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-left">:(</td>
<td class="org-right">1</td>
<td class="org-right">3663</td>
</tr>
<tr>
<td class="org-left">:-(</td>
<td class="org-right">0</td>
<td class="org-right">378</td>
</tr>
</tbody>
</table>
</div>
<div class="outline-4" id="outline-container-org02f0030">
<h4 id="org02f0030">Get The Ratio</h4>
<div class="outline-text-4" id="text-org02f0030">
<p>As an intermediate step we'll create a function named <code>get_ratio</code> that looks up a word and calculates the positive to negative ratio.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_ratio</span><span class="p">(</span><span class="n">freqs</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       freqs: Counter with (word, sentiment) : count</span>
<span class="sd">       word: string to lookup</span>

<span class="sd">    Returns: </span>
<span class="sd">     dictionary with keys 'positive', 'negative', and 'ratio'.</span>
<span class="sd">       Example: {'positive': 10, 'negative': 20, 'ratio': 0.5}</span>
<span class="sd">    """</span>
    <span class="n">pos_neg_ratio</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)],</span>
        <span class="n">negative</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)],</span>
    <span class="p">)</span>

    <span class="c1"># calculate the ratio of positive to negative counts for the word</span>
    <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s1">'ratio'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"positive"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span>
        <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"negative"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos_neg_ratio</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">get_ratio</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="s1">'happi'</span><span class="p">))</span>
</pre></div>
<pre class="example">
{'positive': 160, 'negative': 23, 'ratio': 6.708333333333333}
</pre></div>
</div>
<div class="outline-4" id="outline-container-org0a2074c">
<h4 id="org0a2074c">Get Words By Threshold</h4>
<div class="outline-text-4" id="text-org0a2074c">
<p>Now we'll create the filter function. To make it simpler we'll assume that if we're filtering on the positive label then the ratio for a word to be included has to be equal to or greater than the given threshold while if the label is negative then a word has to be less than or equal to the threshold. Doing this means we're filtering to get words that are further toward the extremes of positive or negative (further from 0).</p>
<p>An example key-value pair would have this structure:</p>
<div class="highlight">
<pre><span></span><span class="p">{</span><span class="s1">'happi'</span><span class="p">:</span>
     <span class="p">{</span><span class="s1">'positive'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'negative'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">'ratio'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
 <span class="p">}</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_words_by_threshold</span><span class="p">(</span><span class="n">freqs</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       freqs: Counter of (word, sentiment): word count</span>
<span class="sd">       label: 1 for positive, 0 for negative</span>
<span class="sd">       threshold: ratio that will be used as the cutoff for including a word in the returned dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">       words: dictionary containing the word and information on its positive count, negative count, and ratio of positive to negative counts.</span>
<span class="sd">       example of a key value pair:</span>
<span class="sd">       {'happi':</span>
<span class="sd">           {'positive': 10, 'negative': 20, 'ratio': 0.5}</span>
<span class="sd">       }</span>
<span class="sd">    """</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
        <span class="n">pos_neg_ratio</span> <span class="o">=</span> <span class="n">get_ratio</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">label</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"ratio"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span> <span class="ow">and</span> <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"ratio"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)):</span>
            <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_neg_ratio</span>

    <span class="k">return</span> <span class="n">words</span>
</pre></div>
<p>Here's an example where we'll filter on negative sentiment so all the tweets should be negative and have a positive to negative ration less that the threshold.</p>
<div class="highlight">
<pre><span></span><span class="n">passed</span> <span class="o">=</span> <span class="n">get_words_by_threshold</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">passed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{count}</span><span class="se">\t</span><span class="s2">word: {word}</span><span class="se">\t</span><span class="s2">{info}"</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
1       word: :(        {'positive': 1, 'negative': 3705, 'ratio': 0.0005396654074473826}
2       word: :-(       {'positive': 0, 'negative': 407, 'ratio': 0.0024509803921568627}
3       word:  {'positive': 0, 'negative': 162, 'ratio': 0.006134969325153374}
4       word:  {'positive': 0, 'negative': 162, 'ratio': 0.006134969325153374}
5       word: believ   {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
6       word: will     {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
7       word: justin   {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
8       word:        {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
9       word:         {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
10      word: sad       {'positive': 3, 'negative': 100, 'ratio': 0.039603960396039604}
11      word: &gt;:(    {'positive': 0, 'negative': 36, 'ratio': 0.02702702702702703}
</pre>
<p>So our threshold gives us the eleven most negative words.</p>
<p>Now, what about filtering on the most positive words?</p>
<div class="highlight">
<pre><span></span><span class="n">passed</span> <span class="o">=</span> <span class="n">get_words_by_threshold</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">passed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{count}</span><span class="se">\t</span><span class="s2">word: {word}</span><span class="se">\t</span><span class="s2">{info}"</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
1       word: :)        {'positive': 2967, 'negative': 1, 'ratio': 1484.0}
2       word: :-)       {'positive': 547, 'negative': 0, 'ratio': 548.0}
3       word: :D        {'positive': 537, 'negative': 0, 'ratio': 538.0}
4       word: :p        {'positive': 113, 'negative': 0, 'ratio': 114.0}
5       word: fback     {'positive': 22, 'negative': 0, 'ratio': 23.0}
6       word: blog      {'positive': 29, 'negative': 2, 'ratio': 10.0}
7       word: followfriday      {'positive': 19, 'negative': 0, 'ratio': 20.0}
8       word: recent    {'positive': 9, 'negative': 0, 'ratio': 10.0}
9       word: stat      {'positive': 52, 'negative': 0, 'ratio': 53.0}
10      word: arriv     {'positive': 57, 'negative': 4, 'ratio': 11.6}
11      word: thx       {'positive': 11, 'negative': 0, 'ratio': 12.0}
12      word: here'     {'positive': 19, 'negative': 0, 'ratio': 20.0}
13      word: influenc  {'positive': 16, 'negative': 0, 'ratio': 17.0}
14      word: bam       {'positive': 34, 'negative': 0, 'ratio': 35.0}
15      word: warsaw    {'positive': 34, 'negative': 0, 'ratio': 35.0}
16      word: welcom    {'positive': 58, 'negative': 4, 'ratio': 11.8}
17      word: vid       {'positive': 9, 'negative': 0, 'ratio': 10.0}
18      word: ceo       {'positive': 9, 'negative': 0, 'ratio': 10.0}
19      word: 1month    {'positive': 9, 'negative': 0, 'ratio': 10.0}
20      word: flipkartfashionfriday     {'positive': 14, 'negative': 0, 'ratio': 15.0}
21      word: inde      {'positive': 10, 'negative': 0, 'ratio': 11.0}
22      word: glad      {'positive': 35, 'negative': 2, 'ratio': 12.0}
23      word: braindot  {'positive': 9, 'negative': 0, 'ratio': 10.0}
24      word: ;)        {'positive': 21, 'negative': 0, 'ratio': 22.0}
25      word: goodnight {'positive': 19, 'negative': 1, 'ratio': 10.0}
26      word: youth     {'positive': 10, 'negative': 0, 'ratio': 11.0}
27      word: shout     {'positive': 9, 'negative': 0, 'ratio': 10.0}
28      word: fantast   {'positive': 10, 'negative': 0, 'ratio': 11.0}
</pre>
<p>The first four make sense, but after that maybe not so much. "fback"?</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd923c1d">
<h3 id="orgd923c1d">Error Analysis</h3>
<div class="outline-text-3" id="text-orgd923c1d">
<p>Now let's look at some tweets that we got wrong. We're going to use <a href="https://numpy.org/doc/stable/reference/generated/numpy.sign.html">numpy.sign</a> which reduces numbers to <code>-1</code>, <code>0</code>, or <code>1</code>.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="s1">'Truth Predicted Tweet'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="n">y_hat</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">"{row.label}</span><span class="se">\t</span><span class="s2">{numpy.sign(y_hat) &gt; 0:d}</span><span class="se">\t</span><span class="s2">"</span>
            <span class="n">f</span><span class="s2">"{' '.join(counter.process(row.tweet)).encode('ascii', 'ignore')}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Truth Predicted Tweet
0       1       b'whatev stil l young &gt;:-('
1       0       b'look fun kik va 642 kik kikgirl french model orgasm hannib phonesex :)'
0       1       b'great news thank let us know :( hope good weekend'
0       1       b"amb pleas harry' jean :) ): ): ):"
0       1       b'srsli fuck u unfollow hope ur futur child unpar u &gt;:-('
1       0       b'ate last cooki shir 0 &gt;:d'
1       0       b'snapchat jennyjean 22 snapchat kikmeboy model french kikchat sabadodeganarseguidor sexysasunday :)'
1       0       b'add kik ughtm 545 kik kikmeguy kissm nude likeforfollow musicbiz sexysasunday :)'
0       1       b'sr financi analyst expedia inc bellevu wa financ expediajob job job hire'
</pre>
<p>For some reason it misses the <code>&gt;:-(</code> emoji and the <code>:)</code> - maybe they didn't occur in the training set. I think these woud be hard for a human to get too, unless you were well versed in tweets and emojis and maybe even then it would be hard</p>
</div>
</div>
<div class="outline-3" id="outline-container-org9d154e4">
<h3 id="org9d154e4">Predict Your Own Tweet</h3>
<div class="outline-text-3" id="text-org9d154e4">
<p>Let's try a random tweet not in the given training or test sets.</p>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s1">'my balls itch'</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{my_tweet} is a positive tweet: {numpy.sign(p) &gt; 0}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
my balls itch is a positive tweet: True
</pre>
<p>Hmmm. Maybe</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf03561d">
<h2 id="orgf03561d">End</h2>
<div class="outline-text-2" id="text-orgf03561d">
<p>I want to do more work with the Naive Bayes Classifier but this post is getting too long so I'm going to move on to other posts, the next being a <a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/">class-based implementation</a> of the model.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/">Using Naive Bayes to Classify Tweets by Sentiment</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/" rel="bookmark"><time class="published dt-published" datetime="2020-08-28T09:25:00-07:00" itemprop="datePublished" title="2020-08-28 09:25">2020-08-28 09:25</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/#orgefa3ba6">Beginning</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/#org873bca2">Middle</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/#org1884b3a">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgefa3ba6">
<h2 id="orgefa3ba6">Beginning</h2>
<div class="outline-text-2" id="text-orgefa3ba6">
<p>In a <a href="posts/nlp/implementing-twitter-logistic-regression/">previous post</a> I implemented a Logistic Regression model to classify twitter tweets as having a positive or negative sentiment. This time I'll be using the same data set (from <a href="http://www.nltk.org/">NLTK</a>) but implementing it with a <a href="https://www.wikiwand.com/en/Naive_Bayes_classifier">Naive Bayes</a> model. This post will look at some of the math behind it and the next one will translate the math into code.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org873bca2">
<h2 id="org873bca2">Middle</h2>
<div class="outline-text-2" id="text-org873bca2"></div>
<div class="outline-4" id="outline-container-orgd4e2d2b">
<h4 id="orgd4e2d2b">Bayesian Inference</h4>
<div class="outline-text-4" id="text-orgd4e2d2b">
<p>What we want is to take a document (<i>D</i>) - which is a tweet in this case - and guess its classification \(\hat{c}\). We do this by calculating the probability for both of our classifications (<i>positive</i> and <i>negative</i>) using Bayes' Rule and then choosing the classification with the higher probability.</p>
\begin{align} \hat{c} &amp;= \underset{c \in C}{\mathrm{argmax}} P(c|d)\\ &amp;= \underset{c \in C}{\mathrm{argmax}} P(D|c)P(c)\\ \end{align}
<p>So our guess as to what class the document belongs to is the classification with the highest probability given the document - and "the probability of the classification given the document", when translated using Bayes' Rule, becomes the probability of the document given the classification (the <i>likelihood</i> of the document) times the prior probability of any document belonging to the class. But then you might wonder - if there's only one of each document then won't the probability always be \(\frac{1}{c}\)? It would, so we use the words within the document to calculate the probability for the document. How? Well, I mentioned earlier that we make two assumptions - that the documents can be represented as a bag of words and that they are independent. The independent assumption allows us to figure out the total probability using the Multiplication Rule:</p>
<p>\[ P(A \cap B) = P(A)P(B) \]</p>
<p>The probability of A and B is the product of their probabilities. In this case we are calculating the probability of the document as the product of the conditional probabilities of the words given the class:</p>
<p>\[ P(D|c) = \prod_{i=1}^{n}P(w_i | c) \]</p>
<p>Where the <i>n</i> refers to the number of words in the document. Given this we could re-write the previous equation like this.</p>
\begin{align} \hat{c} &amp;= \underset{c \in C}{\textrm{argmax}} P(c) \prod_{i}^{n} P(w_i | c)\\ \end{align}
<p>But it turns out this form isn't really ideal. Among other things you're multiplying values that range from 0 to 1, with most values being less than 1, so the more classes you have, the smaller this number will get and you could end up with really small numbers leading to <a href="https://www.wikiwand.com/en/Arithmetic_underflow">underflow</a>. So we're going to do a log transform of the equation which will also simplify the computation a little (although nowadays I don't know that that's so much of a consideration).</p>
<p>\[ \hat{c} = \underset{c \in C}{\textrm{argmax}} \log{P(c)} + \sum_{i=1}^n \log{P(w_i|c)} \]</p>
<p>This is what we'll use to classify tweets after training the model by building up the probabilities.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org02e48f3">
<h4 id="org02e48f3">Ratios</h4>
<div class="outline-text-4" id="text-org02e48f3">
<p>While I wrote out the general case where you take the class with the highest probability, in this case we only have two classes, <i>positive</i> and <i>negative</i> so we can take advantage of this and make our classification using the ratio of the conditional probabilities for each class (the log <a href="https://www.wikiwand.com/en/Odds_ratio">odds ratio</a>). We're going to use the ratio of positive to negative.</p>
<p>\[ \log{\frac{P(positive|D)}{P(negative | D)}} = \log{\frac{P(positive)}{P(negative)}} + \sum_{i=1}^n \log{\frac{P(w_i|positive)}{P(w_i|negative)}} \]</p>
<p>Since <i>positive</i> is the numerator, and the log of values less than one are negative, this ratio will be positive when the review is likely positive and negative otherwise, so we can use the sign of this ratio to classify tweets.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org23a9518">
<h4 id="org23a9518">Priors and Log Priors</h4>
<div class="outline-text-4" id="text-org23a9518">
<p>Now we can start picking apart our ratio. The prior probabilities are just the fraction of our training set that matches a variable. So the prior probabilities of the document classifications can be described like this:</p>
\begin{align} P(D_{positive}) &amp;= \frac{\textit{number of positive tweets}}{\textit{total number of tweets}}\\ &amp;= \frac{D_{pos}}{D}\\ \end{align} \begin{align} P(D_{negative}) &amp;= \frac{\textit{number of negative tweets}}{\textit{total number of tweets}}\\ &amp;= \frac{D_{neg}}{D}\\ \end{align}
<p>But as I noted above we are going to use the ratio of the prior probabilities \(\frac{P(D_{pos})}{P(D_{neg})}\) and if you look at them, they have the same denominator (<i>D</i>) so taking the ratio of the probabilities means the denominator cancels out and we end up with the ratio of the positive to negative documents.</p>
\begin{align} \frac{P(D_{pos})}{P(D_{neg})} &amp;= \frac{\frac{D_{pos}}{D}}{\frac{D_{neg}}{D}}\\ &amp;= \frac{\left( \frac{D_{pos}}{\cancel{D}}\right) \left(\frac{\cancel{D}}{D_{neg}}\right) }{ \cancel{\left(\frac{D_{neg}}{D}\right)} \cancel{\left(\frac{D}{D_{neg}}\right)} }\\ &amp;= \frac{D_{pos}}{D_{neg}}\\ \end{align}
<p>And as I noted above, we'll be using a log transform so our ratio (which will be called <i>logprior</i>) needs to be transformed as well.</p>
\begin{align} \text{logprior} &amp;= log \left( \frac{P(D_{pos})}{P(D_{neg})} \right) \\ &amp;= log \left( \frac{D_{pos}}{D_{neg}} \right)\\ \end{align}
<p>Note that \(log(\frac{A}{B})\) is the same as \(log(A) - log(B)\). So the logprior can also be calculated as the difference between two logs:</p>
\begin{align} \text{logprior} &amp;= \log (P(D_{pos})) - \log (P(D_{neg})) \\ &amp;= \log (D_{pos}) - \log (D_{neg})\\ \end{align}
<p>I don't know that this helps any with computation, but it makes it clearer (to me) that the ratio will be positive when the tweet's sentiment is positive and negative when the sentiment is negative.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org541d416">
<h4 id="org541d416">Positive and Negative Word Probabilities</h4>
<div class="outline-text-4" id="text-org541d416">
<p>Now for the second part of our equation. To compute the positive probability and the negative probability for a specific word in the vocabulary, we'll use the following inputs:</p>
<ul class="org-ul">
<li>\(freq_{pos} =\) the number of times the word is counted in a document with a label of 1</li>
<li>\(freq_{neg} =\) the number of times the word is counted in a document with a label of 0</li>
<li>\(N_{pos} = \) the number of words in all the positive documents</li>
<li>\(N_{neg} = \) the number of words in all the negative documents</li>
<li><i>V</i> is the number of unique words in the entire set of documents</li>
<li><i>W</i> is a word in a document</li>
</ul>
<p>So now we can re-write our numerator and denominator for the second term.</p>
\begin{align} P(W|positive) &amp;= P(W_{pos})\\ &amp;= \frac{freq_{pos}}{N_{pos}}\\ \end{align} \begin{align} P(W | negative ) &amp;= P(W_{neg})\\ &amp;= \frac{freq_{neg}}{N_{neg}}\\ \end{align}
<p>Meaning that the likelihood of the word given the class is the number of times the word shows up in documents of that class divided by a count of all the unique words in the corpus. One thing to notice, though, is that our numerators have the count for a word within documents labeled with the classification, but it's not guaranteed that all of the words will show up in both classes (the word "horrible" might only show up in the negative tweets, for instance) so if a word shows up in one class but not the other, we might end up with a zero in the numerator or denominator and not only is division by zero not defined, but neither is the logarithm of zero. The solution is to add 1 to the numerator and the size of the vocabulary to the denominator (adding 1 for each word). Besides fixing our arithmetic problem there's some other more mathy reasons for doing this that are explained in this <a href="https://en.wikipedia.org/wiki/Additive_smoothing">wikipedia article</a>.</p>
<p>With those changes we now have:</p>
\begin{align} P(W_{pos}) &amp;= \frac{freq_{pos} + 1}{N_{pos} + V}\\ \end{align} \begin{align} P(W_{neg}) &amp;= \frac{freq_{neg} + 1}{N_{neg} + V}\\ \end{align}
<p>And the log-likelihood term becomes:</p>
\begin{align} \text{loglikelihood} &amp;= \log \left(\frac{P(W_{pos})}{P(W_{neg})} \right)\\ &amp;= \log P(W_{pos}) - \log P(W_{neg})\\ &amp;= \log \frac{freq_{pos} + 1}{N_{pos} + V} - \log \frac{freq_{neg} + 1}{N_{neg} + V} \end{align}</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1884b3a">
<h2 id="org1884b3a">End</h2>
<div class="outline-text-2" id="text-org1884b3a">
<p>Now that we have the math I'm going to implement the model using python in <a href="posts/nlp/naive-bayes-twitter-sentiment-classification/">this post</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/bibliographies/text-data-management-and-analysis/">Text Data Management and Analysis</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/bibliographies/text-data-management-and-analysis/" rel="bookmark"><time class="published dt-published" datetime="2020-07-30T13:23:23-07:00" itemprop="datePublished" title="2020-07-30 13:23">2020-07-30 13:23</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org4e47994">
<h2 id="org4e47994">Bibliography</h2>
<div class="outline-text-2" id="text-org4e47994">
<ul class="org-ul">
<li>Zhai C, Massung S. Text data management and analysis: a practical introduction to information retrieval and text mining. First edition. New York: Association for Computing Machinery; 2016. 510 p. (ACM books).</li>
</ul>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/bibliographies/sentiment-analysis-in-social-networks/">Sentiment Analysis In Social Networks</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/bibliographies/sentiment-analysis-in-social-networks/" rel="bookmark"><time class="published dt-published" datetime="2020-07-30T13:05:58-07:00" itemprop="datePublished" title="2020-07-30 13:05">2020-07-30 13:05</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org810ae12">
<h2 id="org810ae12">Bibliography</h2>
<div class="outline-text-2" id="text-org810ae12">
<ul class="org-ul">
<li>Pozzi FA, Fersini E, Messina E, Liu B, editors. Sentiment analysis in social networks. Elsevier Inc.: 2017. 263 p.</li>
</ul>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/bibliographies/bib-speech-and-language-processing-jurafsky-martin/">Speech and Language Processing</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/bibliographies/bib-speech-and-language-processing-jurafsky-martin/" rel="bookmark"><time class="published dt-published" datetime="2020-07-27T20:53:07-07:00" itemprop="datePublished" title="2020-07-27 20:53">2020-07-27 20:53</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org916923a">
<h2 id="org916923a">Citation</h2>
<div class="outline-text-2" id="text-org916923a">
<p>Jurafsky, D. & Martin, J. (2020). Speech and language processing : an introduction to natural language processing, computational linguistics, and speech recognition. 3rd Edition draft. <a href="https://web.stanford.edu/~jurafsky/slp3/">(URL)</a></p>
</div>
</div>
<div class="outline-2" id="outline-container-org08b8787">
<h2 id="org08b8787">Notes</h2>
<div class="outline-text-2" id="text-org08b8787">
<p>Online and PDF version of a (work in progress) revision to this text about text processing.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/the-tweet-vectorizer/">The Tweet Vectorizer</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/the-tweet-vectorizer/" rel="bookmark"><time class="published dt-published" datetime="2020-07-24T16:51:53-07:00" itemprop="datePublished" title="2020-07-24 16:51">2020-07-24 16:51</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/the-tweet-vectorizer/#org5b6fb74">Beginning</a>
<ul>
<li><a href="posts/nlp/the-tweet-vectorizer/#orge0949da">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/the-tweet-vectorizer/#orgf4e8b4f">Middle</a>
<ul>
<li><a href="posts/nlp/the-tweet-vectorizer/#org304a92e">The Tweet Vectors</a></li>
<li><a href="posts/nlp/the-tweet-vectorizer/#org8866183">The Tweet Vectorizer</a></li>
<li><a href="posts/nlp/the-tweet-vectorizer/#org500c898">Plotting The Vectors</a></li>
</ul>
</li>
<li><a href="posts/nlp/the-tweet-vectorizer/#orgd6addf0">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org5b6fb74">
<h2 id="org5b6fb74">Beginning</h2>
<div class="outline-text-2" id="text-org5b6fb74">
<p>In the previous post (<a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a>) I built up a word-counter now we're going to use it to create word-counters for our tweets.</p>
<p>We are going to be classifying <a href="https://help.twitter.com/en/using-twitter/how-to-tweet">tweets</a> by positive or negative sentiment, but tweets are free-form text (and images, but we're ignoring them) and we want numbers in a table form so in order to be able to work with the tweets we'll have to convert them somehow. That's what we'll be doing here.</p>
</div>
<div class="outline-3" id="outline-container-orge0949da">
<h3 id="orge0949da">Set Up</h3>
<div class="outline-text-3" id="text-orge0949da">
<p>This is some preliminary stuff so we have python ready to go.</p>
</div>
<div class="outline-4" id="outline-container-orgbe1961f">
<h4 id="orgbe1961f">Imports</h4>
<div class="outline-text-4" id="text-orgbe1961f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">bokeh.models.tools</span> <span class="kn">import</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>
<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># the vectorizer</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.vectorizer</span> <span class="kn">import</span> <span class="n">TweetVectorizer</span>

<span class="c1"># some helper stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgde2e65e">
<h4 id="orgde2e65e">The Environment</h4>
<div class="outline-text-4" id="text-orgde2e65e">
<p>I'm using environment variables (well, in this case a <code>.env</code> file) to keep track of where I save files so this loads the paths into the environment.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb853b2a">
<h4 id="orgb853b2a">The Data</h4>
<div class="outline-text-4" id="text-orgb853b2a">
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Sentiment</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
<p>The <code>training</code> frame has the cleaned, stemmed, and tokenized version of the tweets.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
tweet    [park, get, sunlight, :)]
label                            1
Name: 0, dtype: object
</pre>
<p>This is what we need for when things are working. The <code>train_raw</code> frame has the tweets as they come from NLTK.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
tweet    off to the park to get some sunlight : )
label                                           1
Name: 0, dtype: object
</pre>
<p>This is just for double-checking if things aren't working the way we expect.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org7aa73ef">
<h4 id="org7aa73ef">For Plotting</h4>
<div class="outline-text-4" id="text-org7aa73ef">
<p>These are some helpers for the plotting that I'll do later on.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"the-tweet-vectorizer"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/nlp/{SLUG}"</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3f12c99">
<h4 id="org3f12c99">The Token Counter</h4>
<div class="outline-text-4" id="text-org3f12c99">
<p>I made the counts in a previous post (<a href="posts/nlp/twitter-word-frequencies/">Twitter Word Frequencies</a>) so I'll just load it here.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_COUNTER"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf4e8b4f">
<h2 id="orgf4e8b4f">Middle</h2>
<div class="outline-text-2" id="text-orgf4e8b4f"></div>
<div class="outline-3" id="outline-container-org304a92e">
<h3 id="org304a92e">The Tweet Vectors</h3>
<div class="outline-text-3" id="text-org304a92e">
<p>In an earlier post we built a dictionary-like set to count the number of times each token was in a positive tweet and the number of times it was in a negative tweet. To represent a tweet as a vector we're going to sum the total counts for the tokens in the tweet when they are positive and when they are positive.</p>
<p>Come again?</p>
<p>Lets say you have a tweet <code>"a b c"</code> which tokenizes to <code>a, b, c</code> and you look up the positive and negative tweet counts for each token so you add them up, getting this:</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Token</th>
<th class="org-right" scope="col">Positive</th>
<th class="org-right" scope="col">Negative</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">a</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-left">b</td>
<td class="org-right">2</td>
<td class="org-right">5</td>
</tr>
<tr>
<td class="org-left">c</td>
<td class="org-right">3</td>
<td class="org-right">6</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Total</td>
<td class="org-right">6</td>
<td class="org-right">15</td>
</tr>
</tbody>
</table>
<p>The bottom row (<code>total</code>) has the values for our vector for any tweet containing the tokens <i>a, b,</i> and <i>c</i>. So to represent this tweet you would create a vector of the form:</p>
\begin{align} \hat{v} &amp;= \langle bias, positive, negative \rangle\\ &amp;= \langle 1, 6, 15\rangle\\ \end{align}
<p><b>Note:</b> The bias is always one (it just is).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org8866183">
<h3 id="org8866183">The Tweet Vectorizer</h3>
<div class="outline-text-3" id="text-org8866183">
<p>Here's where I'll create the class to create the vectors.</p>
</div>
<div class="outline-4" id="outline-container-org5491d81">
<h4 id="org5491d81">The Testing</h4>
<div class="outline-text-4" id="text-org5491d81">
<p>We'll start with some vaguely BDD-ish testing. First the tangles.</p>
<div class="highlight">
<pre><span></span>Feature: A Tweet Count Vectorizer

&lt;&lt;extract-features-feature&gt;&gt;

&lt;&lt;get-vectors-feature&gt;&gt;

&lt;&lt;reset-vectors-feature&gt;&gt;

&lt;&lt;check-rep-vectorizer-tweets-feature&gt;&gt;

&lt;&lt;check-rep-vectorizer-counter-feature&gt;&gt;
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be</span><span class="p">,</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">contain_exactly</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
    <span class="n">raise_error</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
    <span class="n">then</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this testing</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.vectorizer</span> <span class="kn">import</span> <span class="n">Columns</span><span class="p">,</span> <span class="n">TweetVectorizer</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>

<span class="n">and_also</span> <span class="o">=</span> <span class="n">then</span>
<span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/tweet_vectorizer.feature"</span><span class="p">)</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">extract</span><span class="o">-</span><span class="n">features</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">vectors</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">reset</span><span class="o">-</span><span class="n">vectors</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">vectorizer</span><span class="o">-</span><span class="n">tweets</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">rep</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">test</span><span class="o">-</span><span class="n">vectorizer</span><span class="o">-</span><span class="n">counter</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">rep</span><span class="o">&gt;&gt;</span>
</pre></div>
<p>And now we can move on to the tests.</p>
</div>
<ul class="org-ul">
<li><a id="orgf044700"></a>Extract Features<br>
<div class="outline-text-5" id="text-orgf044700">
<p>For training and testing I'm going to want to convert them in bulk, but first I'll create a method so that a single tweet can be vectorized.</p>
<div class="highlight">
<pre><span></span>Scenario: A user converts a tweet to a feature-vector

Given a Tweet Vectorizer
When the user converts a tweet to a feature-vector
Then it's the expected feature-vector
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: A user converts a tweet to a feature-vector</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_tweet_vectorizer</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">TWEETS</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">TOKENS</span> <span class="o">=</span> <span class="s2">"A B C"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">TOKENS</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({(</span><span class="s1">'A'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span>
                               <span class="p">(</span><span class="s1">'B'</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span><span class="mi">2</span><span class="p">,</span>
                               <span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">3</span><span class="p">})</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">WordCounter</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                          <span class="n">counts</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span>
                                          <span class="n">bias</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">"A B C"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user converts a tweet to a feature-vector"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="s2">"A B C"</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_array</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="s2">"A B C"</span><span class="p">,</span> <span class="n">as_array</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it's the expected feature-vector"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_feature_vectors</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_array</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected_array</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org0ae88db"></a>Get the Vectors<br>
<div class="outline-text-5" id="text-org0ae88db">
<div class="highlight">
<pre><span></span>Scenario: A user retrieves the count vectors
Given a user sets up the Count Vectorizer with tweets
When the user checks the count vectors
Then the first column is the bias colum
And the positive counts are correct
And the negative counts are correct
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Feature: A Tweet Count Vectorizer</span>

<span class="c1"># Scenario: A user retrieves the count vectors</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a user sets up the Count Vectorizer with tweets"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_vectorizer</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">TWEETS</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">TOKENS</span> <span class="o">=</span> <span class="s2">"A B C"</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">TOKENS</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">WordCounter</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({(</span><span class="s1">'A'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="p">(</span><span class="s1">'B'</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="p">(</span><span class="s1">'C'</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="mi">3</span><span class="p">})</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                          <span class="n">counts</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span>
                                          <span class="n">bias</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">TOKENS</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">negative</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                                      <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">TOKENS</span><span class="p">])</span>
                                      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)])</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
                                      <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">TOKENS</span><span class="p">])</span>
                                     <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TWEETS</span><span class="p">)])</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the count vectors"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_count_vectors</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="c1"># kind of silly, but useful for troubleshooting</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the first column is the bias colum"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_bias</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span><span class="p">[:,</span> <span class="n">Columns</span><span class="o">.</span><span class="n">bias</span><span class="p">]</span><span class="o">==</span><span class="n">katamari</span><span class="o">.</span><span class="n">bias</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@and_also</span><span class="p">(</span><span class="s2">"the positive counts are correct"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_positive_counts</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span><span class="p">[:,</span> <span class="n">Columns</span><span class="o">.</span><span class="n">positive</span><span class="p">]</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@and_also</span><span class="p">(</span><span class="s2">"the negative counts are correct"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_negative_counts</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">actual_vectors</span><span class="p">[:,</span> <span class="n">Columns</span><span class="o">.</span><span class="n">negative</span><span class="p">]</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">negative</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org5a04bf9"></a>Reset the Vectors<br>
<div class="outline-text-5" id="text-org5a04bf9">
<div class="highlight">
<pre><span></span>Scenario: The vectors are reset
Given a Tweet Vectorizer with the vectors set
When the user calls the reset method
Then the vectors are gone
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The vectors are reset</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer with the vectors set"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_vectors</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">faker</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectors</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">faker</span><span class="o">.</span><span class="n">sentence</span><span class="p">()],</span> <span class="n">counts</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_vectors</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">vectors</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user calls the reset method"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">call_reset</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">vectors</span><span class="p">))</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the vectors are gone"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_vectors_gone</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">_vectors</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="orgcb18948"></a>Check Rep<br>
<div class="outline-text-5" id="text-orgcb18948">
<div class="highlight">
<pre><span></span>Scenario: the check-rep is called with bad tweets
Given a Tweet Vectorizer with bad tweets
When check-rep is called
Then it raises an AssertionError
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: the check-rep is called with bad tweets</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer with bad tweets"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_bad_tweets</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                          <span class="n">counts</span><span class="o">=</span><span class="n">Counter</span><span class="p">())</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"check-rep is called"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">call_check_rep</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bad_call</span><span class="p">():</span>
        <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">check_rep</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">bad_call</span> <span class="o">=</span> <span class="n">bad_call</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it raises an AssertionError"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_assertion_error</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">bad_call</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">raise_error</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
<div class="highlight">
<pre><span></span>Scenario: the check-rep is called with a bad word-counter
Given a Tweet Vectorizer with the wrong counter object
When check-rep is called
Then it raises an AssertionError
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: the check-rep is called with a bad word-counter</span>


<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Tweet Vectorizer with the wrong counter object"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_bad_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="p">[</span><span class="s2">"apple"</span><span class="p">],</span> <span class="n">counts</span><span class="o">=</span><span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">())</span>
    <span class="k">return</span>

<span class="c1"># When check-rep is called</span>
<span class="c1"># Then it raises an AssertionError</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org5c91b8b">
<h4 id="org5c91b8b">The Implementation</h4>
<div class="outline-text-4" id="text-org5c91b8b">
<p>Okay, so now for the actual class.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">attr</span>


<span class="c1"># this package</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>

<span class="n">Columns</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">bias</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">positive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="n">TweetClass</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">positive</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># some types</span>
<span class="n">Tweets</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">Vector</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>


<span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TweetVectorizer</span><span class="p">:</span>
    <span class="sd">"""A tweet vectorizer</span>

<span class="sd">    Args:</span>
<span class="sd">     tweets: the pre-processed/tokenized tweets to vectorize</span>
<span class="sd">     counts: the counter with the tweet token counts</span>
<span class="sd">     processed: to not process the bulk tweets</span>
<span class="sd">     bias: constant to use for the bias</span>
<span class="sd">    """</span>
    <span class="n">tweets</span><span class="p">:</span> <span class="n">Tweets</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">Counter</span>
    <span class="n">processed</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">bias</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">_process</span><span class="p">:</span> <span class="n">TwitterProcessor</span><span class="o">=</span><span class="bp">None</span>
    <span class="n">_vectors</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TwitterProcessor</span><span class="p">:</span>
        <span class="sd">"""Processes tweet strings to tokens"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""The vectorized tweet counts"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span>

    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_array</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vector</span><span class="p">:</span>
        <span class="sd">"""converts a single tweet to an array of counts</span>

<span class="sd">       Args:</span>
<span class="sd">        tweet: a string tweet to count up</span>
<span class="sd">        as_array: whether to return an array instead of a list</span>

<span class="sd">       Returns:</span>
<span class="sd">        either a list of floats or a 1 x 3 array</span>
<span class="sd">       """</span>
        <span class="c1"># this is a hack to make this work both in bulk and one tweet at a time</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tweet</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
            <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">TweetClass</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
                 <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">)),</span>
            <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">TweetClass</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>
                                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vector</span><span class="p">])</span> <span class="k">if</span> <span class="n">as_array</span> <span class="k">else</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Removes the vectors"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">check_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Checks that the tweets and word-counter are set</span>

<span class="sd">       Raises:</span>
<span class="sd">        AssertionError if one of them isn't right</span>
<span class="sd">       """</span>
        <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Counter</span>
        <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org500c898">
<h3 id="org500c898">Plotting The Vectors</h3>
<div class="outline-text-3" id="text-org500c898">
<p>Now that we have a vectorizer definition, let's see what it looks like when we plot the training set. First, we'll have to convert the training set tweets to the vectors.</p>
<div class="highlight">
<pre><span></span><span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="n">counter</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span>
                        <span class="s2">"bias positive negative"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">data</span><span class="p">[</span><span class="s2">"Sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">decode</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">training</span><span class="o">.</span><span class="n">tweet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
['park' 'get' 'sunlight' ':)']
bias                1
positive         3139
negative          208
Sentiment    positive
Name: 0, dtype: object
</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">training</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tweet</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{token}</span><span class="se">\t</span><span class="s2">{counter.counts[(token, 1)]}"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{token}</span><span class="se">\t</span><span class="s2">{counter.counts[(token, 0)]}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
off to the park to get some sunlight : )
park    6
park    7
get     165
get     200
sunlight        1
sunlight        0
:)      2967
:)      1
</pre>
<p>So a smiley face seems to overwhelm other tokens.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
<pre class="example">
negative    4013
positive    3987
Name: Sentiment, dtype: int64
</pre>
<p>If you followed the previous post you can probably figure out that this is the training set. Weird but I hadn't noticed that they aren't exactly balanced Anyway, now the plot.</p>
<div class="highlight">
<pre><span></span><span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span>
    <span class="n">tooltips</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">"Positive"</span><span class="p">,</span> <span class="s2">"@positive{0,0}"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Negative"</span><span class="p">,</span> <span class="s2">"@negative{0,0}"</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">"Sentiment"</span><span class="p">,</span> <span class="s2">"@Sentiment"</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Sentiment"</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">])</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                               <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                               <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative Tweet Sentiment"</span><span class="p">,</span>
                           <span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_negative_scatter"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/the-tweet-vectorizer/positive_negative_scatter.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So, each point is a tweet and the color is what the tweet was classified as. I don't know why they seem to group in bunches, but you can sort of see that by using the token counts we've made them separable. This becomes even more obvious if we change the scale to a logarithmic one.</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Sentiment"</span><span class="p">,</span>
                           <span class="n">loglog</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover</span><span class="p">])</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                               <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                               <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                               <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                               <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                               <span class="n">apply_ranges</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative Tweet Sentiment (log-log)"</span><span class="p">,</span>
                           <span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_negative_scatter_log"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/the-tweet-vectorizer/positive_negative_scatter_log.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>I don't know why but the <code>xlim</code> and <code>ylim</code> arguments don't seem to work when you use a logarithmic scale, but if you zoom out using the <code>wheel zoom</code> tool (third icon from the top of the toolbar on the right) you'll see that there's a pretty good separation between the sentiment classifications.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd6addf0">
<h2 id="orgd6addf0">End</h2>
<div class="outline-text-2" id="text-orgd6addf0">
<p>So, that's it for vectorizing tweets I'll save the values so I don't have to re-do them again when I actually fit the model. Since I changed some values to make it better for plotting I'll change them back first.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentiment"</span><span class="p">:</span> <span class="s2">"sentiment"</span><span class="p">})</span>
<span class="n">data</span><span class="p">[</span><span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">encode</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAIN_VECTORS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
</pre></div>
<p>To make it consistent I'm going to convert the test set too.</p>
<div class="highlight">
<pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_PROCESSED"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">test_vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="s2">"bias positive negative"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">test_data</span><span class="p">[</span><span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">label</span>

<span class="n">test_data</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_VECTORS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
</pre></div>
<p>We also need to use the vectorizers to vectorize future tweets so I'll pickle them too.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_VECTORIZER"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">vectorizer</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</pre></div>
<p>Next up in the series: <a href="posts/nlp/implementing-twitter-logistic-regression/">Implementing Logistic Regression for Tweet Sentiment Analysis</a>.</p>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="next"><a href="index-11.html" rel="next">Older posts</a></li>
</ul>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script><!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script>
</body>
</html>
