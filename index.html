<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/" rel="canonical">
<link href="index-11.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
<link href="posts/nlp/more-matrix-math-in-python/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Neurotic-Networking/"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item active"><a class="nav-link" href=".">Cloistered Monkey <span class="sr-only">(active)</span></a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/more-matrix-math-in-python/">More Matrix Math in Python</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/more-matrix-math-in-python/" rel="bookmark"><time class="published dt-published" datetime="2020-10-06T21:10:51-07:00" itemprop="datePublished" title="2020-10-06 21:10">2020-10-06 21:10</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/more-matrix-math-in-python/#org4f957b2">Beginning</a>
<ul>
<li><a href="posts/nlp/more-matrix-math-in-python/#orgf174b26">Imports</a></li>
<li><a href="posts/nlp/more-matrix-math-in-python/#org0b108db">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/more-matrix-math-in-python/#orgad562c5">Middle</a>
<ul>
<li><a href="posts/nlp/more-matrix-math-in-python/#org98bd6df">More Rotations</a></li>
<li><a href="posts/nlp/more-matrix-math-in-python/#org4798c7e">The Frobenius Norm</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org4f957b2">
<h2 id="org4f957b2">Beginning</h2>
<div class="outline-text-2" id="text-org4f957b2">
<p>This is another lab from Coursera's NLP Specialization. This time it's about using numpy to perform vector operations.</p>
</div>
<div class="outline-3" id="outline-container-orgf174b26">
<h3 id="orgf174b26">Imports</h3>
<div class="outline-text-3" id="text-orgf174b26">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0b108db">
<h3 id="org0b108db">Set Up</h3>
<div class="outline-text-3" id="text-org0b108db"></div>
<div class="outline-4" id="outline-container-org71ab35b">
<h4 id="org71ab35b">Plotting</h4>
<div class="outline-text-4" id="text-org71ab35b">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"more-matrix-math-in-python"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgad562c5">
<h2 id="orgad562c5">Middle</h2>
<div class="outline-text-2" id="text-orgad562c5">
<p>Let's start with a simple matrix. We'll call it <code>R</code> because when we do our machine translation we'll need a <i>rotation matrix</i> which is named <code>R</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]])</span>
</pre></div>
<p>Now we'll create another matrix.</p>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
<pre class="example">
(1, 2)
</pre>
<p>Note the nested square brackets, this makes it a matrix and not a vector.</p>
</div>
<div class="outline-4" id="outline-container-orgdd7a401">
<h4 id="orgdd7a401">The Dot Product</h4>
<div class="outline-text-4" id="text-orgdd7a401">
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
<pre class="example">
[[ 2 -2]]
</pre>
<p>The rotation matrix (<code>R</code>) rotates and scales the matrix <code>x</code>. To see the effect we can plot the original vector <code>x</code> and the rotated version <code>y</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">Y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]))</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">Y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]))</span>

<span class="n">x_plot</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>
<span class="n">y_plot</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_plot</span> <span class="o">*</span> <span class="n">y_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Original and Rotated Vectors"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"original_and_rotate_vectors"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/more-matrix-math-in-python/original_and_rotate_vectors.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The blue segment is the original vector and the red is the rotated and scaled vector.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org98bd6df">
<h3 id="org98bd6df">More Rotations</h3>
<div class="outline-text-3" id="text-org98bd6df">
<p>In the previous section we rotated the vector using integer values, but if we wanted to rotate the vector a specific number of degrees then the way to do that is to use a rotation matrix.</p>
<p>\[ Ro = \begin{bmatrix} cos \theta & -sin \theta \\ sin \theta & cos \theta \end{bmatrix} \]</p>
<p>Let's start with a vector and rotate it \(100^o\).</p>
<div class="highlight">
<pre><span></span><span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">Ro</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
                  <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]])</span>

<span class="n">x_2</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">y_2</span> <span class="o">=</span> <span class="n">x_2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ro</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"The Rotation Matrix"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Ro</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">The Rotated Vector"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\n</span><span class="s1"> x2 norm </span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x_2</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\n</span><span class="s1"> y2 norm </span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y_2</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\n</span><span class="s1"> Rotation matrix norm </span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Ro</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Square Root of 2: </span><span class="si">{</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
The Rotation Matrix
          0         1
0 -0.173648 -0.984808
1  0.984808 -0.173648

The Rotated Vector
0    1.622319
1   -2.316912
dtype: float64

 x2 norm 2.8284271247461903

 y2 norm 2.82842712474619

 Rotation matrix norm 1.414213562373095
 Square Root of 2: 1.4142135623730951
</pre>
<p>You can see that in this case our transformed vector (<code>y2</code>) didn't change in length the way it did in the previous example. Let's plot it and see what it looks like.</p>
<div class="highlight">
<pre><span></span><span class="n">origin</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_2</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_2</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">COLUMNS</span> <span class="o">=</span> <span class="s2">"X Y"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">COLUMNS</span>
<span class="n">Y</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">COLUMNS</span>

<span class="n">x_plot</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>
<span class="n">y_plot</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_plot</span> <span class="o">*</span> <span class="n">y_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"100 Degree rotation"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"one_hundred_degree_rotation"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/more-matrix-math-in-python/one_hundred_degree_rotation.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Rotation matrices rotate anti-clockwise, which makes that look like more than a 100 degree rotation. I'm going to have to figure that out.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org4798c7e">
<h3 id="org4798c7e">The Frobenius Norm</h3>
<div class="outline-text-3" id="text-org4798c7e">
<p>\[ \| \vec a \| = \sqrt {{\vec a} \cdot {\vec a}} \]</p>
<p>For an \(R_2\) matrix, the Frobenius Norm looks like this:</p>
<p>\[ \| \mathrm{A} \|_{F} \equiv \sqrt{\sum_{i=1}^{m} \sum_{j=1}^{n}\left|a_{i j}\right|^{2}} \]</p>
<p>We can translate the second equation directly to numpy.</p>
<div class="highlight">
<pre><span></span><span class="n">some_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">frobenius_norm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">some_array</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The Frobenius Norm = </span><span class="si">{</span><span class="n">frobenius_norm</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
The Frobenius Norm = 4.0
</pre>
<p>So, you might be thinking, we've been using <code>numpy.linalg.norm</code> all this time, what's the difference?</p>
<div class="highlight">
<pre><span></span><span class="n">old_norm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">some_array</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">old_norm</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">old_norm</span> <span class="o">==</span> <span class="n">frobenius_norm</span>
</pre></div>
<pre class="example">
4.0
</pre>
<p>It turns out that the default for <code>norm</code> is the Frobenius Norm so you can calculate it either way.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/">PCA Dimensionality Reduction and Word Vectors</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/" rel="bookmark"><time class="published dt-published" datetime="2020-10-03T19:48:52-07:00" itemprop="datePublished" title="2020-10-03 19:48">2020-10-03 19:48</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/#org127f43e">Beginning</a>
<ul>
<li><a href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/#orgab44a39">Imports</a></li>
<li><a href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/#org17da39d">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/#orgd9d87c2">Middle</a>
<ul>
<li><a href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/#orgb99b24c">Predicting Relationships Among Words</a></li>
<li><a href="posts/nlp/pca-dimensionality-reduction-and-word-vectors/#org542774e">Plotting With PCA</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org127f43e">
<h2 id="org127f43e">Beginning</h2>
<div class="outline-text-2" id="text-org127f43e">
<p>This is an extension of the previous two posts about <a href="posts/nlp/word-embeddings/">Word Embeddings</a> and <a href="posts/nlp/pca-exploration/">Principal Component Analysis</a>. Once again we're going to start with pre-trained word embeddings rather than train our own and then take the embeddings and explore them to better understand them.</p>
</div>
<div class="outline-3" id="outline-container-orgab44a39">
<h3 id="orgab44a39">Imports</h3>
<div class="outline-text-3" id="text-orgab44a39">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org17da39d">
<h3 id="org17da39d">Set Up</h3>
<div class="outline-text-3" id="text-org17da39d"></div>
<div class="outline-4" id="outline-container-orgecfbb6d">
<h4 id="orgecfbb6d">The Timer</h4>
<div class="outline-text-4" id="text-orgecfbb6d">
<p>Just something to tell how long some processes take.</p>
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgbecb9ec">
<h4 id="orgbecb9ec">Plotting</h4>
<div class="outline-text-4" id="text-orgbecb9ec">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"pca-dimensionality-reduction-and-word-vectors"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Cycle</span><span class="p">([</span><span class="s2">"#4687b7"</span><span class="p">,</span> <span class="s2">"#ce7b6d"</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge1b32b1">
<h4 id="orge1b32b1">Randomness</h4>
<div class="outline-text-4" id="text-orge1b32b1">
<div class="highlight">
<pre><span></span><span class="n">numpy_random</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6ddfd56">
<h4 id="org6ddfd56">The Environment</h4>
<div class="outline-text-4" id="text-org6ddfd56">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8462295">
<h4 id="org8462295">The Embeddings</h4>
<div class="outline-text-4" id="text-org8462295">
<p>These are the same embeddings as in the <a href="posts/nlp/word-embeddings/">Word Embeddings</a> exploration. They're loaded a dictionary of arrays (vectors). The original source is the Google News pre-trained data set available from the <a href="https://code.google.com/archive/p/word2vec/">Word2Vec</a> archive, but it is 3.64 gigabytes so Coursera extracted a subset of it to work with.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WORD_EMBEDDINGS"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">243</span>
</pre></div>
<p>The instructors also provide some code to show you how to create a different subset and I'm assuming that what they're showing is the actual way that they built this dataset. For future reference, this is the code given.</p>
<div class="highlight">
<pre><span></span><span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">from</span> <span class="nn">gensim.models</span> <span class="kn">import</span> <span class="n">KeyedVectors</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="n">KeyedVectors</span><span class="o">.</span><span class="n">load_word2vec_format</span><span class="p">(</span><span class="s1">'./GoogleNews-vectors-negative300.bin'</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'capitals.txt'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">set_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="n">select_words</span> <span class="o">=</span> <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'king'</span><span class="p">,</span> <span class="s1">'queen'</span><span class="p">,</span> <span class="s1">'oil'</span><span class="p">,</span> <span class="s1">'gas'</span><span class="p">,</span> <span class="s1">'happy'</span><span class="p">,</span> <span class="s1">'sad'</span><span class="p">,</span> <span class="s1">'city'</span><span class="p">,</span> <span class="s1">'town'</span><span class="p">,</span> <span class="s1">'village'</span><span class="p">,</span> <span class="s1">'country'</span><span class="p">,</span> <span class="s1">'continent'</span><span class="p">,</span> <span class="s1">'petroleum'</span><span class="p">,</span> <span class="s1">'joyful'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">select_words</span><span class="p">:</span>
    <span class="n">set_words</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_word_embeddings</span><span class="p">(</span><span class="n">embeddings</span><span class="p">):</span>

    <span class="n">word_embeddings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">set_words</span><span class="p">:</span>
            <span class="n">word_embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">word_embeddings</span>

<span class="n">word_embeddings</span> <span class="o">=</span> <span class="n">get_word_embeddings</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org211c630">
<h4 id="org211c630">The Data</h4>
<div class="outline-text-4" id="text-org211c630">
<p>The data set is a space-separated-values file with no header.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"CAPITALS"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">" "</span><span class="p">,</span>
                       <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">"City 1"</span><span class="p">,</span> <span class="s2">"Country 1"</span><span class="p">,</span> <span class="s2">"City 2"</span><span class="p">,</span> <span class="s2">"Country 2"</span><span class="p">])</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
<pre class="example">
   City 1 Country 1   City 2    Country 2
0  Athens    Greece  Baghdad         Iraq
1  Athens    Greece  Bangkok     Thailand
2  Athens    Greece  Beijing        China
3  Athens    Greece   Berlin      Germany
4  Athens    Greece     Bern  Switzerland
</pre>
<p>It looks odd because this is actually an evaluation set. The first three columns are used to predict the fourth (e.g. <i>Athens, Greece,</i> and <i>Baghdad</i> are used to predict that <i>Baghdad</i> is the capital of <i>Iraq</i>).</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd9d87c2">
<h2 id="orgd9d87c2">Middle</h2>
<div class="outline-text-2" id="text-orgd9d87c2"></div>
<div class="outline-3" id="outline-container-orgb99b24c">
<h3 id="orgb99b24c">Predicting Relationships Among Words</h3>
<div class="outline-text-3" id="text-orgb99b24c">
<p>This part is about writing a function that will use the word embeddings to predict relationships among words.</p>
</div>
<div class="outline-4" id="outline-container-orgc07242c">
<h4 id="orgc07242c">Requirements</h4>
<div class="outline-text-4" id="text-orgc07242c">
<ul class="org-ul">
<li>The arguments will be three words</li>
<li>The first two will be considered related to each other somehow</li>
<li>The function will then predict a fourth word that is related to the third word in a way that is similar to the relationship between the first two words.</li>
</ul>
<p>Another way to look at is it that if you are given three words - <i>Athens, Greece,</i> and <i>Bangkok</i> then the function will fill in the blank for "Athens is to Greece as Bangkok is to __".</p>
<p>Because of our input data set what the function will end up doing is finding the capital of a country. But first we need a distance function.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgb1a4f6f">
<h4 id="orgb1a4f6f">Cosine Similarity</h4>
<div class="outline-text-4" id="text-orgb1a4f6f">\begin{align} \cos (\theta) &amp;=\frac{\mathbf{A} \cdot \mathbf{B}}{\|\mathbf{A}\|\|\mathbf{B}\|}\\ &amp;= \frac{\sum_{i=1}^{n} A_{i} B_{i}}{\sqrt{\sum_{i=1}^{n} A_{i}^{2}} \sqrt{\sum_{i=1}^{n} B_{i}^{2}}}\\ \end{align}
<ul class="org-ul">
<li><i>A</i> and <i>B</i> are the word vectors and \(A_i\) or \(B_i\) is the <i>ith</i> item of that vector</li>
<li>If the output is 0 then they are opposites and if the output is 1 then they are the same</li>
<li>If the number is between 0 and 1 then it is a similarity score</li>
<li>If the number is between 0 and -1 then it is a dissimilarity score</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">cosine_similarity</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">B</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">'''Calculates the cosine similarity between two arrays</span>

<span class="sd">    Args:</span>
<span class="sd">       A: a numpy array which corresponds to a word vector</span>
<span class="sd">       B: A numpy array which corresponds to a word vector</span>
<span class="sd">    Return:</span>
<span class="sd">       cos: numerical number representing the cosine similarity between A and B.</span>
<span class="sd">    '''</span>
    <span class="n">dot_product</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">norm_of_A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">norm_of_B</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">dot_product</span><span class="o">/</span><span class="p">(</span><span class="n">norm_of_A</span> <span class="o">*</span> <span class="n">norm_of_B</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cos</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">king</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"king"</span><span class="p">]</span>
<span class="n">queen</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"queen"</span><span class="p">]</span>
<span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">king</span><span class="p">,</span> <span class="n">queen</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The Cosine Similarity between 'king' and 'queen': </span><span class="si">{</span><span class="n">similarity</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.6510956</span>
<span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
The Cosine Similarity between 'king' and 'queen': 0.65.
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgeb6f1ca">
<h4 id="orgeb6f1ca">Euclidean Distance</h4>
<div class="outline-text-4" id="text-orgeb6f1ca">
<p>In addition to the Cosine Similarity we can use the (probably better known) Euclidean Distance.</p>
\begin{aligned} d(\mathbf{A}, \mathbf{B})=d(\mathbf{B}, \mathbf{A}) &amp;=\sqrt{\left(A_{1}-B_{1}\right)^{2}+\left(A_{2}-B_{2}\right)^{2}+\cdots+\left(A_{n}-B_{n}\right)^{2}} \\ &amp;=\sqrt{\sum_{i=1}^{n}\left(A_{i}-B_{i}\right)^{2}} \end{aligned}
<ul class="org-ul">
<li><i>n</i> is the number of elements in the vector</li>
<li><i>A</i> and <i>B</i> are the corresponding word vectors.</li>
<li>The more similar the words, the more likely the Euclidean distance will be close to 0 (and zero means they are the same).</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">euclidean</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">B</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculate the euclidean distance between two vectors</span>

<span class="sd">    Args:</span>
<span class="sd">       A: a numpy array which corresponds to a word vector</span>
<span class="sd">       B: A numpy array which corresponds to a word vector</span>
<span class="sd">    Return:</span>
<span class="sd">       d: numerical number representing the Euclidean distance between A and B.</span>
<span class="sd">    """</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">actual</span> <span class="o">=</span> <span class="n">euclidean</span><span class="p">(</span><span class="n">king</span><span class="p">,</span> <span class="n">queen</span><span class="p">)</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">2.4796925</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The Euclidean Distance between 'king' and 'queen' is </span><span class="si">{</span><span class="n">actual</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
The Euclidean Distance between 'king' and 'queen' is 2.48.
</pre></div>
</div>
<div class="outline-4" id="outline-container-orge5e3708">
<h4 id="orge5e3708">The Predictor</h4>
<div class="outline-text-4" id="text-orge5e3708">
<p>Here's whdere we make the function that tries to predict the Country for a given Capital City. This will use the cosine similarity. This first version will use brute-force.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_country</span><span class="p">(</span><span class="n">city1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">country1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">city2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""Find the country that has a particular capital city</span>

<span class="sd">    Args:</span>
<span class="sd">       city1: a string (the capital city of country1)</span>
<span class="sd">       country1: a string (the country of capital1)</span>
<span class="sd">       city2: a string (the capital city of country2)</span>
<span class="sd">       embeddings: a dictionary where the keys are words and values are their embeddings</span>
<span class="sd">    Return:</span>
<span class="sd">       countries: most likely country and its similarity score</span>
<span class="sd">    """</span>
    <span class="n">group</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">city1</span><span class="p">,</span> <span class="n">country1</span><span class="p">,</span> <span class="n">city2</span><span class="p">))</span>

    <span class="n">city1_emb</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">city1</span><span class="p">]</span>

    <span class="n">country1_emb</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">country1</span><span class="p">]</span>

    <span class="n">city2_emb</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">city2</span><span class="p">]</span>

    <span class="n">vec</span> <span class="o">=</span> <span class="n">country1_emb</span> <span class="o">-</span> <span class="n">city1_emb</span>  <span class="o">+</span> <span class="n">city2_emb</span>

    <span class="c1"># Initialize the similarity to -1 (it will be replaced by a similarities that are closer to +1)</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># initialize country to an empty string</span>
    <span class="n">country</span> <span class="o">=</span> <span class="s1">''</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">embeddings</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">word_emb</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
            <span class="c1"># calculate cosine similarity between embedding of country 2 and the word in the embeddings dictionary</span>
            <span class="n">cur_similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">word_emb</span><span class="p">)</span>

            <span class="c1"># if the cosine similarity is more similar than the previously best similarity...</span>
            <span class="k">if</span> <span class="n">cur_similarity</span> <span class="o">&gt;</span> <span class="n">similarity</span><span class="p">:</span>

                <span class="c1"># update the similarity to the new, better similarity</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="n">cur_similarity</span>

                <span class="c1"># store the country as a tuple, which contains the word and the similarity</span>
                <span class="n">country</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">similarity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">country</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">actual_country</span><span class="p">,</span> <span class="n">actual_similarity</span> <span class="o">=</span> <span class="n">get_country</span><span class="p">(</span><span class="s2">"Athens"</span><span class="p">,</span> <span class="s2">"Greece"</span><span class="p">,</span> <span class="s2">"Cairo"</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cairo is the capital of </span><span class="si">{</span><span class="n">actual_country</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>

<span class="n">expected_country</span><span class="p">,</span> <span class="n">expected_similarity</span> <span class="o">=</span> <span class="s2">"Egypt"</span><span class="p">,</span> <span class="mf">0.7626821</span>
<span class="n">expect</span><span class="p">(</span><span class="n">actual_country</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">expected_country</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">actual_similarity</span><span class="p">,</span> <span class="n">expected_similarity</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
Cairo is the capital of Egypt.
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgbb9408d">
<h4 id="orgbb9408d">Checking the Model Accuracy</h4>
<div class="outline-text-4" id="text-orgbb9408d">
<p>\[ \text{Accuracy}=\frac{\text{Correct # of predictions}}{\text{Total # of predictions}} \]</p>
<div class="highlight">
<pre><span></span><span class="n">country_getter</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">get_country</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_accuracy</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">'''Calculate the fraction of correct capitals</span>

<span class="sd">    Args:</span>
<span class="sd">       embeddings: a dictionary where the key is a word and the value is its embedding</span>

<span class="sd">    Return:</span>
<span class="sd">       accuracy: the accuracy of the model</span>
<span class="sd">    '''</span>
    <span class="n">num_correct</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># loop through the rows of the dataframe</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="c1"># get city1</span>
        <span class="n">city1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"City 1"</span><span class="p">]</span>

        <span class="c1"># get country1</span>
        <span class="n">country1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"Country 1"</span><span class="p">]</span>

        <span class="c1"># get city2</span>
        <span class="n">city2</span> <span class="o">=</span>  <span class="n">row</span><span class="p">[</span><span class="s2">"City 2"</span><span class="p">]</span>

        <span class="c1"># get country2</span>
        <span class="n">country2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"Country 2"</span><span class="p">]</span>

        <span class="c1"># use get_country to find the predicted country2</span>
        <span class="n">predicted_country2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">country_getter</span><span class="p">(</span><span class="n">city1</span><span class="o">=</span><span class="n">city1</span><span class="p">,</span> <span class="n">country1</span><span class="o">=</span><span class="n">country1</span><span class="p">,</span> <span class="n">city2</span><span class="o">=</span><span class="n">city2</span><span class="p">)</span>

        <span class="c1"># if the predicted country2 is the same as the actual country2...</span>
        <span class="k">if</span> <span class="n">predicted_country2</span> <span class="o">==</span> <span class="n">country2</span><span class="p">:</span>
            <span class="c1"># increment the number of correct by 1</span>
            <span class="n">num_correct</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># get the number of rows in the data dataframe (length of dataframe)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># calculate the accuracy by dividing the number correct by m</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">num_correct</span><span class="o">/</span><span class="n">m</span>
    <span class="k">return</span> <span class="n">accuracy</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">get_accuracy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">accuracy</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-10-07 17:50:28,897 graeae.timers.timer start: Started: 2020-10-07 17:50:28.897165
2020-10-07 17:50:50,755 graeae.timers.timer end: Ended: 2020-10-07 17:50:50.755424
2020-10-07 17:50:50,756 graeae.timers.timer end: Elapsed: 0:00:21.858259
Accuracy: 0.92
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org542774e">
<h3 id="org542774e">Plotting With PCA</h3>
<div class="outline-text-3" id="text-org542774e"></div>
<div class="outline-4" id="outline-container-orgbf49aa6">
<h4 id="orgbf49aa6">Computing the PCA</h4>
<div class="outline-text-4" id="text-orgbf49aa6">
<p>Now we'll write a function to do the Principal Component Analysis for our embeddings.</p>
<ul class="org-ul">
<li>The word vectors are of dimension 300.</li>
<li>Use PCA to change the 300 dimensions to <code>n_components</code> dimensions.</li>
<li>The new matrix should be of dimension <code>m, n_components</code> (<code>m</code> being the number of rows).</li>
<li></li>
<li>First de-mean the data</li>
<li>Get the eigenvalues using `linalg.eigh`. Use `eigh` rather than `eig` since R is symmetric. The performance gain when using `eigh` instead of `eig` is substantial.</li>
<li>Sort the eigenvectors and eigenvalues by decreasing order of the eigenvalues.</li>
<li>Get a subset of the eigenvectors (choose how many principle components you want to use using `n_components`).</li>
<li>Return the new transformation of the data by multiplying the eigenvectors with the original data.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">compute_pca</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_components</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""Calculate the principal components for X</span>

<span class="sd">    Args:</span>
<span class="sd">       X: of dimension (m,n) where each row corresponds to a word vector</span>
<span class="sd">       n_components: Number of components you want to keep.</span>

<span class="sd">    Return:</span>
<span class="sd">       X_reduced: data transformed in 2 dims/columns + regenerated original data</span>
<span class="sd">    """</span>
    <span class="c1"># you need to set axis to 0 or it will calculate the mean of the entire matrix instead of one per row</span>
    <span class="n">X_demeaned</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># calculate the covariance matrix</span>
    <span class="c1"># the default numpy.cov assumes the rows are variables, not columns so set rowvar to False</span>
    <span class="n">covariance_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X_demeaned</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># calculate eigenvectors & eigenvalues of the covariance matrix</span>
    <span class="n">eigen_vals</span><span class="p">,</span> <span class="n">eigen_vecs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">covariance_matrix</span><span class="p">)</span>

    <span class="c1"># sort eigenvalue in increasing order (get the indices from the sort)</span>
    <span class="n">idx_sorted</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">eigen_vals</span><span class="p">)</span>

    <span class="c1"># reverse the order so that it's from highest to lowest.</span>
    <span class="n">idx_sorted_decreasing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">idx_sorted</span><span class="p">))</span>

    <span class="c1"># sort the eigen values by idx_sorted_decreasing</span>
    <span class="n">eigen_vals_sorted</span> <span class="o">=</span> <span class="n">eigen_vals</span><span class="p">[</span><span class="n">idx_sorted_decreasing</span><span class="p">]</span>

    <span class="c1"># sort eigenvectors using the idx_sorted_decreasing indices</span>
    <span class="c1"># We're only sorting the columns so remember to get all the rows in the slice</span>
    <span class="n">eigen_vecs_sorted</span> <span class="o">=</span> <span class="n">eigen_vecs</span><span class="p">[:,</span> <span class="n">idx_sorted_decreasing</span><span class="p">]</span>

    <span class="c1"># select the first n eigenvectors (n is desired dimension</span>
    <span class="c1"># of rescaled data array, or dims_rescaled_data)</span>
    <span class="c1"># once again, make sure to get all the rows and only slice the columns</span>
    <span class="n">eigen_vecs_subset</span> <span class="o">=</span> <span class="n">eigen_vecs_sorted</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">]</span>

    <span class="c1"># transform the data by multiplying the transpose of the eigenvectors </span>
    <span class="c1"># with the transpose of the de-meaned data</span>
    <span class="c1"># Then take the transpose of that product.</span>
    <span class="n">X_reduced</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eigen_vecs_subset</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X_demeaned</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">X_reduced</span>
</pre></div>
<p>I was getting the wrong values because for some reason so I decided to take out the call to random (since the seed was being set the values were always the same anyway) and just declare the test input array.</p>
<div class="highlight">
<pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">4.17022005e-01</span><span class="p">,</span> <span class="mf">7.20324493e-01</span><span class="p">,</span> <span class="mf">1.14374817e-04</span><span class="p">,</span> <span class="mf">3.02332573e-01</span><span class="p">,</span>
                  <span class="mf">1.46755891e-01</span><span class="p">,</span> <span class="mf">9.23385948e-02</span><span class="p">,</span> <span class="mf">1.86260211e-01</span><span class="p">,</span> <span class="mf">3.45560727e-01</span><span class="p">,</span>
                  <span class="mf">3.96767474e-01</span><span class="p">,</span> <span class="mf">5.38816734e-01</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">4.19194514e-01</span><span class="p">,</span> <span class="mf">6.85219500e-01</span><span class="p">,</span> <span class="mf">2.04452250e-01</span><span class="p">,</span> <span class="mf">8.78117436e-01</span><span class="p">,</span>
                  <span class="mf">2.73875932e-02</span><span class="p">,</span> <span class="mf">6.70467510e-01</span><span class="p">,</span> <span class="mf">4.17304802e-01</span><span class="p">,</span> <span class="mf">5.58689828e-01</span><span class="p">,</span>
                  <span class="mf">1.40386939e-01</span><span class="p">,</span> <span class="mf">1.98101489e-01</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">8.00744569e-01</span><span class="p">,</span> <span class="mf">9.68261576e-01</span><span class="p">,</span> <span class="mf">3.13424178e-01</span><span class="p">,</span> <span class="mf">6.92322616e-01</span><span class="p">,</span>
                  <span class="mf">8.76389152e-01</span><span class="p">,</span> <span class="mf">8.94606664e-01</span><span class="p">,</span> <span class="mf">8.50442114e-02</span><span class="p">,</span> <span class="mf">3.90547832e-02</span><span class="p">,</span>
                  <span class="mf">1.69830420e-01</span><span class="p">,</span> <span class="mf">8.78142503e-01</span><span class="p">]])</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">X_reduced</span> <span class="o">=</span> <span class="n">compute_pca</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># eigen_vecs, eigen_subset, X_demeaned = compute_pca(X, n_components=2)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Your original matrix was "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">" and it became:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_reduced</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
 <span class="p">[</span><span class="mf">0.43437323</span><span class="p">,</span> <span class="mf">0.49820384</span><span class="p">],</span>
 <span class="p">[</span><span class="mf">0.42077249</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.50351448</span><span class="p">],</span>
 <span class="p">[</span><span class="o">-</span><span class="mf">0.85514571</span><span class="p">,</span> <span class="mf">0.00531064</span><span class="p">],</span>
<span class="p">])</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">X_reduced</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</pre></div>
<pre class="example">
Your original matrix was (3, 10) and it became:
[[ 0.43437323  0.49820384]
 [ 0.42077249 -0.50351448]
 [-0.85514571  0.00531064]]
</pre></div>
</div>
<div class="outline-4" id="outline-container-org6db6a8e">
<h4 id="org6db6a8e">Plot It</h4>
<div class="outline-text-4" id="text-org6db6a8e">
<p>We'll use most of the non-country words to create a plot to see how well the PCA does.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'oil'</span><span class="p">,</span> <span class="s1">'gas'</span><span class="p">,</span> <span class="s1">'happy'</span><span class="p">,</span> <span class="s1">'sad'</span><span class="p">,</span> <span class="s1">'city'</span><span class="p">,</span> <span class="s1">'town'</span><span class="p">,</span>
         <span class="s1">'village'</span><span class="p">,</span> <span class="s1">'country'</span><span class="p">,</span> <span class="s1">'continent'</span><span class="p">,</span> <span class="s1">'petroleum'</span><span class="p">,</span> <span class="s1">'joyful'</span><span class="p">]</span>
<span class="n">subset</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>
<span class="n">reduced</span> <span class="o">=</span> <span class="n">compute_pca</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
<span class="n">reduced</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">reduced</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">"X Y"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">reduced</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">,</span> <span class="n">text_baseline</span><span class="o">=</span><span class="s2">"top"</span><span class="p">)</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span> <span class="o">*</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"PCA of Words"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"pca_words"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/pca-dimensionality-reduction-and-word-vectors/pca_words.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It appears to have worked fairly well.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgb4d4817">
<h4 id="orgb4d4817">Sklearn Comparison</h4>
<div class="outline-text-4" id="text-orgb4d4817">
<p>As a comparison here's what SKlearn's PCA does.</p>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">reduced</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
<span class="n">reduced</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">reduced</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">"X Y"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">reduced</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">,</span> <span class="n">text_baseline</span><span class="o">=</span><span class="s2">"top"</span><span class="p">)</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span> <span class="o">*</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"PCA of Words (SKLearn)"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"sklearn_pca_words"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/pca-dimensionality-reduction-and-word-vectors/sklearn_pca_words.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>They look fairly comparable, I'll conclude that they are close (or close enough).</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/pca-exploration/">PCA Exploration</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/pca-exploration/" rel="bookmark"><time class="published dt-published" datetime="2020-10-01T17:53:17-07:00" itemprop="datePublished" title="2020-10-01 17:53">2020-10-01 17:53</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/pca-exploration/#orgde2e349">Beginning</a>
<ul>
<li><a href="posts/nlp/pca-exploration/#orgad13a88">Imports</a></li>
<li><a href="posts/nlp/pca-exploration/#orge850502">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/pca-exploration/#org77059c2">Middle</a>
<ul>
<li><a href="posts/nlp/pca-exploration/#orgbb8c815">Example One: Random Uniform Data</a></li>
<li><a href="posts/nlp/pca-exploration/#org01354ec">Example Two: Normal Random Data</a></li>
<li><a href="posts/nlp/pca-exploration/#orgc5878bf">Dimensionality Reduction</a></li>
</ul>
</li>
<li><a href="posts/nlp/pca-exploration/#org715e58d">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgde2e349">
<h2 id="orgde2e349">Beginning</h2>
<div class="outline-text-2" id="text-orgde2e349">
<p>In this post I'm going to walk through the Lab for Coursera's NLP Specialization in which we take a look at <a href="https://www.wikiwand.com/en/Principal_component_analysis">Principal Component Analysis</a> which we're going to use for Dimensionality Reduction later on. While PCA can be used as a black box it's useful to get an intuitive understanding of what it's doing so we'll take a look at a couple of simplified examples and pick apart a little bit of what's going on.</p>
</div>
<div class="outline-3" id="outline-container-orgad13a88">
<h3 id="orgad13a88">Imports</h3>
<div class="outline-text-3" id="text-orgad13a88">
<p>Just the usual suspects.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge850502">
<h3 id="orge850502">Set Up</h3>
<div class="outline-text-3" id="text-orge850502"></div>
<div class="outline-4" id="outline-container-org96ca09a">
<h4 id="org96ca09a">Plotting</h4>
<div class="outline-text-4" id="text-org96ca09a">
<p>This is a little bit of convenience code for the HoloViews plotting.</p>
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"pca-exploration"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Cycle</span><span class="p">([</span><span class="s2">"#4687b7"</span><span class="p">,</span> <span class="s2">"#ce7b6d"</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org75dfd39">
<h4 id="org75dfd39">Randomness</h4>
<div class="outline-text-4" id="text-org75dfd39">
<p><code>numpy's</code> <a href="https://numpy.org/devdocs/reference/random/generator.html">default_rng</a> creates a random-number generator. The only argument it takes is the <code>seed</code> which I'll set to 0.</p>
<div class="highlight">
<pre><span></span><span class="n">numpy_random</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org77059c2">
<h2 id="org77059c2">Middle</h2>
<div class="outline-text-2" id="text-org77059c2"></div>
<div class="outline-3" id="outline-container-orgbb8c815">
<h3 id="orgbb8c815">Example One: Random Uniform Data</h3>
<div class="outline-text-3" id="text-orgbb8c815">
<p>This first example will use a set of data that's in a straight line so that we can see a really basic example of what the PCA does to a straight line.</p>
</div>
<div class="outline-4" id="outline-container-org04d63ff">
<h4 id="org04d63ff">The Dataset</h4>
<div class="outline-text-4" id="text-org04d63ff">
<p>To start I'll create a dataset generated by numpy's <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.uniform.html">uniform</a> function, which takes three arguments - <code>low</code>, <code>high</code>, and <code>size</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">correlation</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">numpy_random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
<p>Since \(x=y\) we're going to end up with a line segment at a 45 degree angle.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org4c74f29">
<h4 id="org4c74f29">Center It</h4>
<div class="outline-text-4" id="text-org4c74f29">
<p>For PCA they recommend that you center the data by subtracting the mean.</p>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
<p><b>Note:</b> according to <a href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html">sklearn's PCA documentation</a> they center it for you so this is probably an unnecessary step.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf7e390c">
<h4 id="orgf7e390c">The PCA Transformation</h4>
<div class="outline-text-4" id="text-orgf7e390c">
<p>We're going to use <a href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html">sklearn's PCA</a> for Principal Component Analysis. The <code>n_components</code> argument is the number of components it will keep - we'll keep 2.</p>
<div class="highlight">
<pre><span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
<p>Now fit it to the data.</p>
<div class="highlight">
<pre><span></span><span class="n">transformation_model</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
<p>And then transform it.</p>
<div class="highlight">
<pre><span></span><span class="n">pca_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">transformation_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Principal Component 1"</span><span class="p">,</span> <span class="s2">"Principal Component 2"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org88229e7">
<h4 id="org88229e7">Plot the Transformation</h4>
<div class="outline-text-4" id="text-org88229e7">
<div class="highlight">
<pre><span></span><span class="n">original</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>
<span class="n">transformed</span> <span class="o">=</span> <span class="n">pca_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Principal Component 1"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Principal Component 2"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">original</span> <span class="o">*</span> <span class="n">transformed</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Correlated and PCA Data"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"correlated_data"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/pca-exploration/correlated_data.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Our blue line is the original data and the red line is the transformed data. So it looks like the PCA transform rotates the line to a horizontal one.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org33025d9">
<h4 id="org33025d9">Understanding the Model</h4>
<div class="outline-text-4" id="text-org33025d9">
<p>Now that we have the model we can look at the <a href="https://www.wikiwand.com/en/Eigenvalues_and_eigenvectors">Eigenvalues and Eigenvectors</a> that it created to do the transformation.</p>
</div>
<ul class="org-ul">
<li><a id="org4bd5375"></a>The Eigenvectors (principal component).<br>
<div class="outline-text-5" id="text-org4bd5375">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">transformation_model</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span>
</pre></div>
<pre class="example">
[[ 0.70710678  0.70710678]
 [-0.70710678  0.70710678]]
</pre>
<p>The numbers look a little inscrutable at first, but what you need to know that it's a <a href="https://www.wikiwand.com/en/Rotation_matrix">rotation matrix</a>.</p>
<p>\[ R = \begin{bmatrix} cos(45^o) & sin(45^o)\\ -sin(45^o) & cos(45^o)\\ \end{bmatrix} \]</p>
<p>And since our line is at a \(45^\circ\) angle, the values in the Eigenvectors are the sin and cos of \(45^\circ\) that are used to rotate the line flat.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">45</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">45</span><span class="p">)))</span>
</pre></div>
<pre class="example">
0.7071067811865476
0.7071067811865475
</pre></div>
</li>
<li><a id="org1250073"></a>The Eigenvalues (explained variance).<br>
<div class="outline-text-5" id="text-org1250073">
<p>Also part of the model are the eigenvalues which give the amount of variance explained by each of the components.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">transformation_model</span><span class="o">.</span><span class="n">explained_variance_</span><span class="p">)</span>
</pre></div>
<pre class="example">
[1.59912782e-01 7.31437644e-33]
</pre>
<p>So, what does that mean? Start with the fact that the equation for <a href="https://www.dummies.com/education/math/business-statistics/how-to-calculate-the-variance-and-standard-deviation-in-the-uniform-distribution/">variance of a uniform distribution</a> is:</p>
<p>\[ Var = \frac{(b - a)^2}{12} \]</p>
<p>And remember that hen we called the <code>uniform</code> function we set <code>b</code> to 2, and <code>a</code> to 1, so we get.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">((</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.08333333333333333
</pre>
<p>If you look at the Eigenvalues we got, the second term is \(7 \times 10^{-33}\) which is pretty much zero, and the first term is about <code>0.16</code>, so what we have here is.</p>
\begin{align} Var &amp;= \langle Var(x) + Var(y), 0\rangle\\ &amp;= \langle 0.083 + 0.083, 0 \rangle\\ &amp;= \langle 0.16, 0 \rangle\\ \end{align}
<p>It rounds more to 0.167, but close enough, the point is that the first component contributed all the variance and the second didn't contribute any.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org01354ec">
<h3 id="org01354ec">Example Two: Normal Random Data</h3>
<div class="outline-text-3" id="text-org01354ec">
<p>Now we'll move onto normally-distributed data so we can see something a little more interesting.</p>
</div>
<div class="outline-4" id="outline-container-org675a42b">
<h4 id="org675a42b">Generate the Data</h4>
<div class="outline-text-4" id="text-org675a42b">
<p>Now we'll to use numpy's random <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.normal.html">normal</a> function to generate the data. The three arguments it takes are <code>loc</code> (the mean), <code>scale</code> (the standard deviation), and <code>size</code> (the number of numbers to generate).</p>
<div class="highlight">
<pre><span></span><span class="n">standard_deviation_1</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">standard_deviation_2</span> <span class="o">=</span> <span class="mf">0.333</span>
<span class="n">points</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">numpy_random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">standard_deviation_1</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">numpy_random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">standard_deviation_2</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
</pre></div>
<p>Even though we specify that the mean is 0, because it the data is generated randomly it isn't exactly zero so we'll center it.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"x mean start: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y mean start: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">x mean: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y mean: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
x mean start: -0.012000607736595292
y mean start: -0.01409218413437418

x mean: 3.552713678800501e-18
y mean: 2.6645352591003758e-18
</pre></div>
</div>
<div class="outline-4" id="outline-container-org310b4ae">
<h4 id="org310b4ae">Plot It</h4>
<div class="outline-text-4" id="text-org310b4ae">
<p>And now a plot to show the data.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Random Normal Data"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"random_normal_data"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/pca-exploration/random_normal_data.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>As you can see, the data is pretty uncorrelated so we're going to rotate it to make it a little less of a blob.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org27b59ab">
<h4 id="org27b59ab">Rotate The Data</h4>
<div class="outline-text-4" id="text-org27b59ab">
<p>Now we're going to put the <code>x</code> and <code>y</code> data into a matrix and rotate it.</p>
<div class="highlight">
<pre><span></span><span class="n">covariance</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">in_degrees</span> <span class="o">=</span> <span class="mi">45</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">in_degrees</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"angle: </span><span class="si">{</span><span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span>
                               <span class="p">[</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">)</span>
</pre></div>
<pre class="example">
angle: 45.0

[[ 0.70710678  0.70710678]
 [-0.70710678  0.70710678]]
</pre>
<p>You might notice that this is the same rotation matrix that we had before with the sklearn eigenvectors, so we could have used that, but this is how you would roll your own.</p>
<p>Now we can apply the rotation by taking the dot-product between the data array and the rotation-matrix.</p>
<div class="highlight">
<pre><span></span><span class="n">rotated</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotation_matrix</span><span class="p">)</span>
<span class="n">rotated</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdde570b">
<h4 id="orgdde570b">Plot The Rotated Data</h4>
<div class="outline-text-4" id="text-orgdde570b">
<p>To get a sense of what our transformation did we can plot it. In addition we'll plot the axes created by the rotation matrix so we can see how they're related. So first thing is to unpack the axes contained within the rotation matrix. In addition we'll scale the axes by the standard deviation we used along each of the original axes to see how that relates to the shape of the data.</p>
<div class="highlight">
<pre><span></span><span class="n">FIRST_ROW</span><span class="p">,</span> <span class="n">SECOND_ROW</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">FIRST_COLUMN</span><span class="p">,</span> <span class="n">SECOND_COLUMN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">ORIGIN</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">SCALAR</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">FIRST_SPREAD</span><span class="p">,</span> <span class="n">SECOND_SPREAD</span> <span class="o">=</span> <span class="p">(</span><span class="n">standard_deviation_1</span> <span class="o">*</span> <span class="n">SCALAR</span><span class="p">,</span>
                               <span class="n">standard_deviation_2</span> <span class="o">*</span> <span class="n">SCALAR</span><span class="p">)</span>
<span class="n">COLUMNS</span> <span class="o">=</span> <span class="s2">"x y"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">first_axis</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
    <span class="n">ORIGIN</span><span class="p">,</span>
    <span class="n">rotation_matrix</span><span class="p">[</span><span class="n">FIRST_ROW</span><span class="p">][:]],</span>
                              <span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">)</span>
<span class="n">first_axis</span> <span class="o">*=</span> <span class="n">FIRST_SPREAD</span>


<span class="n">second_axis</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
    <span class="n">ORIGIN</span><span class="p">,</span>
    <span class="n">rotation_matrix</span><span class="p">[</span><span class="n">SECOND_ROW</span><span class="p">][:]],</span>
                               <span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">)</span>
<span class="n">second_axis</span> <span class="o">*=</span> <span class="n">SECOND_SPREAD</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">first_axis_plot</span> <span class="o">=</span> <span class="n">first_axis</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
<span class="n">second_axis_plot</span> <span class="o">=</span> <span class="n">second_axis</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"orange"</span><span class="p">)</span>
<span class="n">rotated_plot</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">rotated_plot</span> <span class="o">*</span> <span class="n">first_axis_plot</span> <span class="o">*</span> <span class="n">second_axis_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Rotated Normal Data"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"rotated_normal_data"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/pca-exploration/rotated_normal_data.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So our data is now grouped around a 45-degree angle and spread further along the axis that had more variance.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgced43fe">
<h4 id="orgced43fe">Apply the PCA</h4>
<div class="outline-text-4" id="text-orgced43fe">
<div class="highlight">
<pre><span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fitted</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rotated</span><span class="p">)</span>
</pre></div>
<p>Once again, the Eigenvectors (the transformation matirix).</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fitted</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span>
</pre></div>
<pre class="example">
[[-0.70844626 -0.70576476]
 [-0.70576476  0.70844626]]
</pre>
<p>And then the Eigenvalues (the variance).</p>
<div class="highlight">
<pre><span></span><span class="n">variance</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">explained_variance_</span>
<span class="nb">print</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>
</pre></div>
<pre class="example">
[1.05270169 0.10604603]
</pre>
<p>Now we apply the PCA transformation.</p>
<div class="highlight">
<pre><span></span><span class="n">pca_data</span> <span class="o">=</span> <span class="n">fitted</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rotated</span><span class="p">)</span>
<span class="n">pca_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">"x y"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcedd4a6">
<h4 id="orgcedd4a6">Plot the PCA Transformed Data</h4>
<div class="outline-text-4" id="text-orgcedd4a6">
<p>We're going to plot the rotated and the transformed data along with the axes for the rotated data so the first</p>
<div class="highlight">
<pre><span></span><span class="n">transformed</span> <span class="o">=</span> <span class="n">pca_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rotated_plot</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">first_axis_plot</span> <span class="o">=</span> <span class="n">first_axis</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
<span class="n">second_axis_plot</span> <span class="o">=</span> <span class="n">second_axis</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"orange"</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">transformed</span> <span class="o">*</span> <span class="n">rotated_plot</span> <span class="o">*</span> <span class="n">first_axis_plot</span> <span class="o">*</span> <span class="n">second_axis_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"PCA of Random Normal Data"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"pca_random_normal"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/pca-exploration/pca_random_normal.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
<div class="outline-4" id="outline-container-org667fb38">
<h4 id="org667fb38">Looking at the model</h4>
<div class="outline-text-4" id="text-org667fb38">
<ul class="org-ul">
<li>The rotation matrix took the original uncorrelated variables and transformed them into correllated variables (the blue circles).</li>
<li>Fitting the PCA to our correlated data finds the rotation matrix that was used to create the blue points.</li>
<li>Applying the PCA transformation undoes the rotation (but the spread doesn't return).</li>
</ul>
<p>Our orginal standard deviations were 1 and 0.333 and if we look at the Explained Variance it is roughly our original standard deviations squared.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0.99140088 0.32958007]
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc5878bf">
<h3 id="orgc5878bf">Dimensionality Reduction</h3>
<div class="outline-text-3" id="text-orgc5878bf">
<p>The previous sections were meant to understand what PCA is doing, but to use the PCA for visualization we will use it to reduce the number of dimensions of a data set so that it can be plotted. We can get a sense of how that works here by looking at our rotated data set with either the entire x-axis set to 0 or the entire y-axis set to 0.</p>
<div class="highlight">
<pre><span></span><span class="n">first_component</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">first_component</span><span class="p">[</span><span class="s2">"y"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">second_component</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">second_component</span><span class="p">[</span><span class="s2">"x"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">original</span> <span class="o">=</span> <span class="n">rotated</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
                                  <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">first</span> <span class="o">=</span> <span class="n">first_component</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span>
                                       <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">second</span> <span class="o">=</span> <span class="n">second_component</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span>
                                         <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">original</span> <span class="o">*</span> <span class="n">first</span> <span class="o">*</span> <span class="n">second</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Data Decomposition"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"data_decomposed"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/pca-exploration/data_decomposed.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>This is only a teaser to doing an actual dimensionality reduction.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org715e58d">
<h2 id="org715e58d">End</h2>
<div class="outline-text-2" id="text-org715e58d">
<p>This is a walk-through of a lab for Coursera's NLP Specialization.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/word-embeddings/">Word Embeddings</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/word-embeddings/" rel="bookmark"><time class="published dt-published" datetime="2020-09-29T19:25:16-07:00" itemprop="datePublished" title="2020-09-29 19:25">2020-09-29 19:25</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/word-embeddings/#orgd35bbee">Beginning</a>
<ul>
<li><a href="posts/nlp/word-embeddings/#org8e181f3">Set Up</a></li>
<li><a href="posts/nlp/word-embeddings/#org86e98c2">The Embeddings</a></li>
</ul>
</li>
<li><a href="posts/nlp/word-embeddings/#orga68ff60">Middle</a>
<ul>
<li><a href="posts/nlp/word-embeddings/#orgd8c1fda">Inspecting the Embeddings</a></li>
<li><a href="posts/nlp/word-embeddings/#orgb80ab13">Word Distance</a></li>
<li><a href="posts/nlp/word-embeddings/#orgc80ba66">Linear Algebra on Word Embeddings</a></li>
<li><a href="posts/nlp/word-embeddings/#org96c6af2">Predicting Capitals</a></li>
<li><a href="posts/nlp/word-embeddings/#org1b1a8e8">More Countries</a></li>
<li><a href="posts/nlp/word-embeddings/#orgf2be778">Sentence Vectors</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd35bbee">
<h2 id="orgd35bbee">Beginning</h2>
<div class="outline-text-2" id="text-orgd35bbee">
<p>This is a walk through a lab for week 3 of Coursera's Natural Language Processing course. It's going to use some pretrained word embeddings to develop some sense of how to use them.</p>
</div>
<div class="outline-3" id="outline-container-org8e181f3">
<h3 id="org8e181f3">Set Up</h3>
<div class="outline-text-3" id="text-org8e181f3"></div>
<div class="outline-4" id="outline-container-orgb859626">
<h4 id="orgb859626">Imports</h4>
<div class="outline-text-4" id="text-orgb859626">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7fe75e1">
<h4 id="org7fe75e1">Plotting</h4>
<div class="outline-text-4" id="text-org7fe75e1">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"word-embeddings"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">plot_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="k">with</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org86e98c2">
<h3 id="org86e98c2">The Embeddings</h3>
<div class="outline-text-3" id="text-org86e98c2">
<p>Like I mentioned abovve, I'm going to use pre-trained word embeddings that have been pickled so I'll load them here.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WORD_EMBEDDINGS"</span><span class="p">])</span>
<span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">embeddings</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">243</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orga68ff60">
<h2 id="orga68ff60">Middle</h2>
<div class="outline-text-2" id="text-orga68ff60"></div>
<div class="outline-3" id="outline-container-orgd8c1fda">
<h3 id="orgd8c1fda">Inspecting the Embeddings</h3>
<div class="outline-text-3" id="text-orgd8c1fda">
<p>The <code>embeddings</code> is a dictionary of words to word-vectors that represent them. Here's the first 5 words.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">embeddings</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
<pre class="example">
&lt;class 'dict'&gt;
['country', 'city', 'China', 'Iraq', 'oil']
</pre>
<div class="highlight">
<pre><span></span><span class="n">vector</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"country"</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
<pre class="example">
&lt;class 'numpy.ndarray'&gt;
(300,)
</pre>
<p>Each word-embedding vector has 300 entries.</p>
</div>
<div class="outline-4" id="outline-container-org16ec3ff">
<h4 id="org16ec3ff">Plotting</h4>
<div class="outline-text-4" id="text-org16ec3ff">
<p>Since there are 300 columns you can't easily visualize them without using PCA or some other method, but this is more about getting an intuition as to how the linear-algebra works, so instead we're going to reduce a subset of words to only two columns so that we can plot them.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'oil'</span><span class="p">,</span> <span class="s1">'gas'</span><span class="p">,</span> <span class="s1">'happy'</span><span class="p">,</span> <span class="s1">'sad'</span><span class="p">,</span> <span class="s1">'city'</span><span class="p">,</span> <span class="s1">'town'</span><span class="p">,</span> <span class="s1">'village'</span><span class="p">,</span> <span class="s1">'country'</span><span class="p">,</span> <span class="s1">'continent'</span><span class="p">,</span> <span class="s1">'petroleum'</span><span class="p">,</span> <span class="s1">'joyful'</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>
<span class="n">plot_columns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_columns</span><span class="p">]</span>
<span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">]</span>
<span class="n">plot_data</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>
<span class="n">origins</span> <span class="o">=</span> <span class="n">plot_data</span> <span class="o">*</span> <span class="mi">0</span>
<span class="n">origins</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>
<span class="n">combined_plot_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">origins</span><span class="p">,</span> <span class="n">plot_data</span><span class="p">])</span>

<span class="n">segment_plot</span> <span class="o">=</span> <span class="n">combined_plot_data</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>
<span class="n">scatter_plot</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">segment_plot</span> <span class="o">*</span> <span class="n">scatter_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Embeddings Columns 3 and 2"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"embeddings_segments"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/word-embeddings/embeddings_segments.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>You can see that words like "village" and "town" are similar while "city" and "oil" are opposites for whatever reason. Oddly, "joyful" and "country" are also very similar (although I'm only looking at two out of three-hundred columns so that might not be the case once the other columns enter into place).</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb80ab13">
<h3 id="orgb80ab13">Word Distance</h3>
<div class="outline-text-3" id="text-orgb80ab13">
<p>This is supposed to be a visualization of the difference vectors between <i>sad</i> and <i>happy</i> and <i>town</i> and <i>village</i>, but as far as I can see holoviews doesn't have the equivalent of matplotlib's arrow which lets you use the base coordinate and distance in each dimension to draw arrows, so it's kind of a fake version where I use the points directly. Oh, well.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'sad'</span><span class="p">,</span> <span class="s1">'happy'</span><span class="p">,</span> <span class="s1">'town'</span><span class="p">,</span> <span class="s1">'village'</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">embeddings</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_columns</span><span class="p">]</span>
<span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">]</span>
<span class="n">plot_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">words</span>
</pre></div>
<p>This is the fake part - when you take the difference between two "points" it gives you a vector with the base at the origin so you have to add the base point back in to move it from the origin, but then all you're doing is undoing the subtraction, giving you what you started with.</p>
<div class="highlight">
<pre><span></span><span class="n">difference</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
    <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"happy"</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"sad"</span><span class="p">]</span> <span class="o">+</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"sad"</span><span class="p">],</span>
    <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"town"</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"village"</span><span class="p">]</span> <span class="o">+</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"village"</span><span class="p">]</span>
<span class="p">])</span>

<span class="n">difference</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"sad"</span><span class="p">,</span> <span class="s2">"village"</span><span class="p">]</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">))</span>

<span class="n">difference</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">difference</span><span class="p">,</span>
                            <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="o">.</span><span class="n">Word</span><span class="o">==</span><span class="s2">"sad"</span><span class="p">],</span>
                            <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="o">.</span><span class="n">Word</span><span class="o">==</span><span class="s2">"village"</span><span class="p">]])</span>


<span class="n">with_origin</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">origins</span><span class="p">[</span><span class="n">origins</span><span class="o">.</span><span class="n">Word</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">words</span><span class="p">)],</span> <span class="n">plot_data</span><span class="p">])</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>
<span class="n">segments</span> <span class="o">=</span> <span class="n">with_origin</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">difference</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">distances</span> <span class="o">*</span> <span class="n">segments</span> <span class="o">*</span> <span class="n">scatter</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Vector Differences"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"vector_differences"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/word-embeddings/vector_differences.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
<div class="outline-3" id="outline-container-orgc80ba66">
<h3 id="orgc80ba66">Linear Algebra on Word Embeddings</h3>
<div class="outline-text-3" id="text-orgc80ba66"></div>
<div class="outline-4" id="outline-container-org4c866b7">
<h4 id="org4c866b7">The <b>norm</b></h4>
<div class="outline-text-4" id="text-org4c866b7">
<p>First I'll check out the <a href="https://www.wikiwand.com/en/Norm_(mathematics)">norm</a> of some word vectors using <a href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.norm.html">numpy.linalg.norm</a>. This calculates the Euclidean Distance between vectors (but oddly we won't use it here).</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">"town"</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">embeddings</span><span class="p">[</span><span class="s2">"sad"</span><span class="p">]))</span>
</pre></div>
<pre class="example">
2.3858097
2.9004838
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org96c6af2">
<h3 id="org96c6af2">Predicting Capitals</h3>
<div class="outline-text-3" id="text-org96c6af2">
<p>Here we'll see how to use the embeddings to predict what country a city is the capital of. To encode the concept of "capital" into a vector we'll use the difference between a specific country and its real capital (in this case <i>France</i> and <i>Paris</i>).</p>
<div class="highlight">
<pre><span></span><span class="n">capital</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"France"</span><span class="p">]</span> <span class="o">-</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"Paris"</span><span class="p">]</span>
</pre></div>
<p>Now that we have the concept of a capital encoded as a word embedding we can add it to the embedding of "Madrid" to get a vector near where "Spain" would be. Note that although there is a "Spain" in the embeddings we're going to use this to see if we can find it without knowing that Madrid is the capital of Spain.</p>
<div class="highlight">
<pre><span></span><span class="n">country</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="s2">"Madrid"</span><span class="p">]</span> <span class="o">+</span> <span class="n">capital</span>
</pre></div>
<p>To make a prediction we have to find the embeddings that are closest to a country. We're going to convert the embeddings to a pandas DataFrame and since our embeddings are a dictionary of arrays we'll have to do a little unpacking first.</p>
<div class="highlight">
<pre><span></span><span class="n">keys</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">embeddings</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">embeddings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
</pre></div>
<p>Now we'll make a function to find the closest embeddings for a word vector.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">closest_word</span><span class="p">(</span><span class="n">vector</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Find the word closest to a given vector</span>

<span class="sd">    Args:</span>
<span class="sd">     vector: the vector to match</span>

<span class="sd">    Returns:</span>
<span class="sd">     name of the closest embedding</span>
<span class="sd">    """</span>
    <span class="n">differences</span> <span class="o">=</span> <span class="n">embeddings</span> <span class="o">-</span> <span class="n">vector</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">differences</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="p">(</span><span class="n">differences</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">),)))</span>

    <span class="k">return</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<p>Now we can check what word most closesly matches <i>Madrid + (France - Paris)</i>.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">country</span><span class="p">))</span>
</pre></div>
<pre class="example">
Spain
</pre>
<p>Like magic.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org1b1a8e8">
<h3 id="org1b1a8e8">More Countries</h3>
<div class="outline-text-3" id="text-org1b1a8e8">
<p>What happens if we use a different know country and its capital instead of France and Paris?</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Italy'</span><span class="p">]</span> <span class="o">-</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Rome'</span><span class="p">]</span>
                   <span class="o">+</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Madrid'</span><span class="p">]))</span>
</pre></div>
<pre class="example">
Spain
</pre>
<p>So swapping the capital derivation didn't change the prediction. Now we'll go back to using <code>France - Paris</code> but try different cities.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="s2">"Tokyo Moscow"</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2"> is the capital of </span><span class="si">{</span><span class="n">closest_word</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+</span> <span class="n">capital</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Tokyo is the capital of Japan
Moscow is the capital of Russia
</pre>
<p>That seems to be working, but here's a case where our search fails.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Lisbon'</span><span class="p">]</span> <span class="o">+</span> <span class="n">capital</span><span class="p">))</span>
</pre></div>
<pre class="example">
Lisbon
</pre>
<p>For some reason "Lisbon" is closer to itself than portugal. I tried it with Germany and Italy instead of France as the template capital but it still didn't work. If you try random cities from the embeddings you'll see that a fair amount of them fail.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgf2be778">
<h3 id="orgf2be778">Sentence Vectors</h3>
<div class="outline-text-3" id="text-orgf2be778">
<p>To use this for sentences you construct a vector with all the vectors for each word and then sum up all the columns to get back to a single vector.</p>
<div class="highlight">
<pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s2">"Canada oil city town"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">embeddings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
<span class="n">summed</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">closest_word</span><span class="p">(</span><span class="n">summed</span><span class="p">))</span>
</pre></div>
<pre class="example">
city
</pre>
<p>Not exciting, but that's how you do it.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/tweet-classifier-class/">Tweet Classifier Class</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/tweet-classifier-class/" rel="bookmark"><time class="published dt-published" datetime="2020-09-09T17:49:07-07:00" itemprop="datePublished" title="2020-09-09 17:49">2020-09-09 17:49</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/tweet-classifier-class/#orgcb9abc6">Beginning</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org37eb6ba">Middle</a>
<ul>
<li><a href="posts/nlp/tweet-classifier-class/#orgd99f23b">The Logistic Regression Class</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#orgbe3ba9c">Weights</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#orgf14395b">The Weights Setter</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org7f1b746">Sigmoid</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#orge61dc4f">This is the training function</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org1ec6027">Fit</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org15c5ca3">Predict</a></li>
<li><a href="posts/nlp/tweet-classifier-class/#org2bba721">Score</a></li>
</ul>
</li>
<li><a href="posts/nlp/tweet-classifier-class/#org2933fa4">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgcb9abc6">
<h2 id="orgcb9abc6">Beginning</h2>
<div class="outline-text-2" id="text-orgcb9abc6">
<p>I implemented the Logistic Regression Tweet Sentiment Analysis classifier in <a href="posts/nlp/implementing-twitter-logistic-regression/">this post</a> but I'm going to re-use it later so this just gathers everything together. There's already a class called <code>TweetSentiment</code> but I'm going to add the training to this one as well as the tweet pre-processing and vectorization.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org37eb6ba">
<h2 id="org37eb6ba">Middle</h2>
<div class="outline-text-2" id="text-org37eb6ba">
<p>We'll start with the imports.</p>
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
<span class="kn">from</span> <span class="nn">.sentiment</span> <span class="kn">import</span> <span class="n">TweetSentiment</span>
<span class="kn">from</span> <span class="nn">.vectorizer</span> <span class="kn">import</span> <span class="n">TweetVectorizer</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgd99f23b">
<h3 id="orgd99f23b">The Logistic Regression Class</h3>
<div class="outline-text-3" id="text-orgd99f23b">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LogisticRegression</span><span class="p">:</span>
    <span class="sd">"""train and predict tweet sentiment</span>

<span class="sd">    Args:</span>
<span class="sd">     iterations: number of times to run gradient descent</span>
<span class="sd">     learning_rate: how fast to change the weights during training</span>
<span class="sd">    """</span>
    <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">_weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbe3ba9c">
<h3 id="orgbe3ba9c">Weights</h3>
<div class="outline-text-3" id="text-orgbe3ba9c">
<p>These are the weights for the regression function (\(\theta\)).</p>
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">"""The weights for the regression</span>

<span class="sd">    Initially this will be an array of zeros.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf14395b">
<h3 id="orgf14395b">The Weights Setter</h3>
<div class="outline-text-3" id="text-orgf14395b">
<div class="highlight">
<pre><span></span><span class="nd">@weights</span><span class="o">.</span><span class="n">setter</span>
<span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Set the weights to a new value"""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">new_weights</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7f1b746">
<h3 id="org7f1b746">Sigmoid</h3>
<div class="outline-text-3" id="text-org7f1b746">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculates the logistic function value</span>

<span class="sd">    Args:</span>
<span class="sd">     vectors: a matrix of bias, positive, negative wordc ounts</span>

<span class="sd">    Returns:</span>
<span class="sd">     array of probabilities that the tweets are positive</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">vectors</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge61dc4f">
<h3 id="orge61dc4f">This is the training function</h3>
<div class="outline-text-3" id="text-orge61dc4f">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">gradient_descent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">"""Finds the weights for the model</span>

<span class="sd">    Args:</span>
<span class="sd">     x: the tweet vectors</span>
<span class="sd">     y: the positive/negative labels</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">/=</span> <span class="n">rows</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>
        <span class="c1"># average loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)))</span> <span class="o">+</span>
                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_hat</span><span class="p">))))</span><span class="o">/</span><span class="n">rows</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_hat</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradient</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1ec6027">
<h3 id="org1ec6027">Fit</h3>
<div class="outline-text-3" id="text-org1ec6027">
<p>This is mostly an alias to make it match (somewhat) sklearn's methods.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""fits the weights for the logistic regression</span>

<span class="sd">    Note:</span>
<span class="sd">     as a side effect this also sets counter, loss, and sentimenter attributes</span>

<span class="sd">    Args:</span>
<span class="sd">     x_train: the training tweets</span>
<span class="sd">     y_train: the training labels</span>

<span class="sd">    Returns:</span>
<span class="sd">     The final mean loss (which is also saved as the =.loss= attribute)</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">processed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_descent</span><span class="p">(</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectors</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org15c5ca3">
<h3 id="org15c5ca3">Predict</h3>
<div class="outline-text-3" id="text-org15c5ca3">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""Predict the labels for the inputs</span>

<span class="sd">    Args:</span>
<span class="sd">     x: a list or array of tweets</span>

<span class="sd">    Returns:</span>
<span class="sd">     array of predicted labels for the tweets</span>
<span class="sd">    """</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TweetVectorizer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">processed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sentimenter</span> <span class="o">=</span> <span class="n">TweetSentiment</span><span class="p">(</span><span class="n">vectorizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sentimenter</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org2bba721">
<h3 id="org2bba721">Score</h3>
<div class="outline-text-3" id="text-org2bba721">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Get the mean accuracy</span>

<span class="sd">    Args:</span>
<span class="sd">     x: arrray of tweets</span>
<span class="sd">     y: labels for the tweets</span>

<span class="sd">    Returns:</span>
<span class="sd">     mean accuracy</span>
<span class="sd">    """</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">correct</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2933fa4">
<h2 id="org2933fa4">End</h2>
<div class="outline-text-2" id="text-org2933fa4">
<p>Testing it out.</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">expect</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.logistic_regression</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>

<span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>


<span class="n">Settings</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="p">,</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span>
                           <span class="n">learning_rate</span><span class="o">=</span><span class="n">Settings</span><span class="o">.</span><span class="n">eta</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="o">=</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">y_train</span><span class="o">=</span><span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="mf">0.22043072</span>
<span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Accuracy: 0.996
</pre></div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/visualizing-naive-bayes/">Visualizing Naive Bayes</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/visualizing-naive-bayes/" rel="bookmark"><time class="published dt-published" datetime="2020-08-31T06:16:19-07:00" itemprop="datePublished" title="2020-08-31 06:16">2020-08-31 06:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#org8fe78d9">Beginning</a>
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#orgd65b081">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/visualizing-naive-bayes/#orge4eed68">Middle</a>
<ul>
<li><a href="posts/nlp/visualizing-naive-bayes/#orgdfa4378">Log Likelihoods</a></li>
<li><a href="posts/nlp/visualizing-naive-bayes/#orgd6beae1">Confidence Ellipses</a></li>
</ul>
</li>
<li><a href="posts/nlp/visualizing-naive-bayes/#orgd8c4c12">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org8fe78d9">
<h2 id="org8fe78d9">Beginning</h2>
<div class="outline-text-2" id="text-org8fe78d9">
<p>In the <a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/">previous post</a> I made a class-based version of the Naive Bayes Classifier for tweets. For this post I'm going to plot the model values. It turns out that we need to get at some values that the previous implementations hide so I'm going to re-calculate the likelihoods from scratch rather than alter the previous code.</p>
</div>
<div class="outline-3" id="outline-container-orgd65b081">
<h3 id="orgd65b081">Set Up</h3>
<div class="outline-text-3" id="text-orgd65b081"></div>
<div class="outline-4" id="outline-container-org7cfd8c8">
<h4 id="org7cfd8c8">Imports</h4>
<div class="outline-text-4" id="text-org7cfd8c8">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Ellipse</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>

<span class="c1"># graeae</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgadffdc2">
<h4 id="orgadffdc2">The Dotenv</h4>
<div class="outline-text-4" id="text-orgadffdc2">
<div class="highlight">
<pre><span></span><span class="n">env_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">env_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc583790">
<h4 id="orgc583790">Plotting</h4>
<div class="outline-text-4" id="text-orgc583790">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"visualizing-naive-bayes"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">create_folder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plot_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_PLOT"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="k">with</span> <span class="n">plot_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">seaborn</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">"whitegrid"</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9cd2d4f">
<h4 id="org9cd2d4f">The Data</h4>
<div class="outline-text-4" id="text-org9cd2d4f">
<div class="highlight">
<pre><span></span><span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_raw</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Testing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_raw</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000
Testing: 2,000
</pre></div>
</div>
<div class="outline-4" id="outline-container-org95a125b">
<h4 id="org95a125b">The Word Counter</h4>
<div class="outline-text-4" id="text-org95a125b">
<p>This is a class to clean and tokenize the tweets and build up a Counter with the word counts.</p>
<div class="highlight">
<pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org48920da">
<h4 id="org48920da">Constants</h4>
<div class="outline-text-4" id="text-org48920da">
<div class="highlight">
<pre><span></span><span class="n">Sentiment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orge4eed68">
<h2 id="orge4eed68">Middle</h2>
<div class="outline-text-2" id="text-orge4eed68"></div>
<div class="outline-3" id="outline-container-orgdfa4378">
<h3 id="orgdfa4378">Log Likelihoods</h3>
<div class="outline-text-3" id="text-orgdfa4378"></div>
<div class="outline-4" id="outline-container-org98bbd38">
<h4 id="org98bbd38">Calculating the Likelihoods</h4>
<div class="outline-text-4" id="text-org98bbd38">
<p>The first thing to plot are the log-likelihoods for positive and negative tweets. When I implemented the Naive Bayes Classifier I took advantage of the fact that we're making a binary classifier and took the odds ratio when making predictions, but for our plot we're going to need to undo the division and plot the numerator against the denominator.</p>
\begin{align} log \frac{P(tweet|pos)}{P(tweet|neg)} &amp;= log(P(tweet|pos)) - log(P(tweet|neg)) \\ positive = log(P(tweet|pos)) &amp;= \sum_{i=0}^{n}{log P(W_i|pos)}\\ negative = log(P(tweet|neg)) &amp;= \sum_{i=0}^{n}{log P(W_i|neg)}\\ \end{align}
<p>So, let's get the log-likelihoods.</p>
<div class="highlight">
<pre><span></span><span class="n">COUNTS</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">counts</span>

<span class="n">positive_loglikelihood</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">negative_loglikelihood</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">log_ratio</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">all_positive_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
    <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">COUNTS</span>
     <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
<span class="n">all_negative_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
    <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">COUNTS</span>
     <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span>

<span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">COUNTS</span><span class="p">}</span>
<span class="n">vocabulary_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>

<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
    <span class="n">this_word_positive_count</span> <span class="o">=</span> <span class="n">COUNTS</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
    <span class="n">this_word_negative_count</span> <span class="o">=</span> <span class="n">COUNTS</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>

    <span class="n">probability_word_is_positive</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_positive_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                    <span class="p">(</span><span class="n">all_positive_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>
    <span class="n">probability_word_is_negative</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_negative_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                    <span class="p">(</span><span class="n">all_negative_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>
    <span class="n">positive_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_positive</span><span class="p">)</span>
    <span class="n">negative_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_negative</span><span class="p">)</span>
    <span class="n">log_ratio</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">positive_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">-</span> <span class="n">negative_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
</pre></div>
<p>So now we have our positive and negative log-likelihoods and I'll put them into a pandas DataFrame to make it easier to plot.</p>
<div class="highlight">
<pre><span></span><span class="n">positive_document_likelihood</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">negative_document_likelihood</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sentiment</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tweet</span><span class="p">)</span>

    <span class="n">positive_document_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">positive_loglikelihood</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">))</span>
    <span class="n">negative_document_likelihood</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">negative_loglikelihood</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">))</span>
    <span class="n">sentiment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">positive_document_likelihood</span><span class="p">,</span>
        <span class="n">negative</span> <span class="o">=</span> <span class="n">negative_document_likelihood</span><span class="p">,</span>
        <span class="n">sentiment</span><span class="o">=</span><span class="n">sentiment</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
<pre class="example">
     positive   negative  sentiment
0  -26.305672 -33.940649          1
1  -30.909803 -37.634516          1
2  -42.936400 -33.403567          0
3  -15.983546 -25.501140          1
4 -107.899933 -99.191875          0
</pre></div>
</div>
<div class="outline-4" id="outline-container-org73c5bad">
<h4 id="org73c5bad">Plotting the Likelihoods</h4>
<div class="outline-text-4" id="text-org73c5bad">
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"sentiment"</span><span class="p">,</span>
                               <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span> <span class="n">fill_alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                                   <span class="n">title</span><span class="o">=</span><span class="s2">"Positive vs Negative"</span><span class="p">,</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                   <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                                   <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">font_scale</span><span class="p">,</span>
                               <span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"positive_vs_negative_sentiment"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/visualizing-naive-bayes/positive_vs_negative_sentiment.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It looks like the log likelihoods for the negatives are linearly separable.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd6beae1">
<h3 id="orgd6beae1">Confidence Ellipses</h3>
<div class="outline-text-3" id="text-orgd6beae1">
<p>Now we're going to plot a <a href="https://www.wikiwand.com/en/Confidence_region">Confidence Region</a>, which is a generalization of a confidence interval to higher dimensions. In this case we're going to create confidence ellipses. I'm not really sure about the details of the math to get them, but matplotlib has <a href="https://matplotlib.org/3.1.1/gallery/statistics/confidence_ellipse.html">a page</a> with a function to create a matplotlib plot for a confidence ellipse that I'm going to adapt.</p>
</div>
<div class="outline-4" id="outline-container-org930a963">
<h4 id="org930a963">The Ellipse Function</h4>
<div class="outline-text-4" id="text-org930a963">
<p>This is taken almost verbatim from matplotlib's page.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">confidence_ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Create a plot of the covariance confidence ellipse of `x` and `y`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x, y : array_like, shape (n, )</span>
<span class="sd">       Input data.</span>

<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">       The axes object to draw the ellipse into.</span>

<span class="sd">    n_std : float</span>
<span class="sd">       The number of standard deviations to determine the ellipse's radiuses.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.patches.Ellipse</span>

<span class="sd">    Other parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    kwargs : `~matplotlib.patches.Patch` properties</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"x and y must be the same size"</span><span class="p">)</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">pearson</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Using a special case to obtain the eigenvalues of this</span>
    <span class="c1"># two-dimensionl dataset.</span>
    <span class="n">ell_radius_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pearson</span><span class="p">)</span>
    <span class="n">ell_radius_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pearson</span><span class="p">)</span>
    <span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                      <span class="n">width</span><span class="o">=</span><span class="n">ell_radius_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">height</span><span class="o">=</span><span class="n">ell_radius_y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span>
                      <span class="p">)</span>

    <span class="c1"># Calculating the stdandard deviation of x from</span>
    <span class="c1"># the squareroot of the variance and multiplying</span>
    <span class="c1"># with the given number of standard deviations.</span>
    <span class="n">scale_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>
    <span class="n">mean_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># calculating the stdandard deviation of y ...</span>
    <span class="n">scale_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>
    <span class="n">mean_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">transf</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Affine2D</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">rotate_deg</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">mean_x</span><span class="p">,</span> <span class="n">mean_y</span><span class="p">)</span>

    <span class="n">ellipse</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">transf</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">positives</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">sentiment</span><span class="o">==</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">]</span>
<span class="n">negatives</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">sentiment</span><span class="o">==</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">]</span>

<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">positives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">positives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$2\sigma$'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">negatives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">negatives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>

<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">positives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">positives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$3\sigma$'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
<span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">negatives</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">negatives</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>

<span class="n">SIZE</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">positives</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s2">"none"</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">)</span>
<span class="n">negatives</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"positive"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">"negative"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>

<span class="n">LIMITS</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">LIMITS</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">LIMITS</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Confidence Ellipses"</span><span class="p">)</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">"ellipses.png"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="ellipses.png" src="posts/nlp/visualizing-naive-bayes/ellipses.png"></p>
</div>
<p>It's a bit squashed looking, since the results are so tight, but you can sort of see that the distributions are "left-skewed", with the points that fall outside of the \(3 \sigma\) range being the cases where the "positive" and "negative" values are both negative.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd8c4c12">
<h2 id="orgd8c4c12">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/">Class-Based Naive Bayes Tweet Sentiment Classifier</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/" rel="bookmark"><time class="published dt-published" datetime="2020-08-29T11:01:51-07:00" itemprop="datePublished" title="2020-08-29 11:01">2020-08-29 11:01</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org9cacedf">Beginning</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org1b6a7d7">The Naive Bayes Classifier</a>
<ul>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org2942de1">Imports</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org9f33e48">The Sentiment Constants</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org61a9a7c">The Declaration</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgcffcb70">The Counter</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orge9eca8f">The Vocabulary</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org95dffe5">The logprior</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org3c0321d">The loglikelihood</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org7e2c7d5">Predict Probability</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgf7ec3a3">Predict Sentiment</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orged51cf2">Check Rep</a></li>
</ul>
</li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgb630b98">Testing</a>
<ul>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org854680b">Imports</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orga576cd0">Test Setup</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org16b19ca">Can you construct it?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgc1e5eef">Does it build the counter?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgbb6b1b5">Does it build the logprior?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#orgc5903e3">Does it build the vocabulary?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org1f5dbfd">Does it build the log-likelihood?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org6fa8570">Does it predict probabilities?</a></li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org5f81a29">Does it predict the sentiment?</a></li>
</ul>
</li>
<li><a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/#org0ec434a">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org9cacedf">
<h2 id="org9cacedf">Beginning</h2>
<div class="outline-text-2" id="text-org9cacedf">
<p>I <a href="posts/nlp/naive-bayes-twitter-sentiment-classification/">previously implemented</a> a Naive Bayes Classifier for Tweets as separate functions, and while that is useful for learningi I want to re-use it so I'm going to re-implement it as a class-based system.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org1b6a7d7">
<h2 id="org1b6a7d7">The Naive Bayes Classifier</h2>
<div class="outline-text-2" id="text-org1b6a7d7"></div>
<div class="outline-3" id="outline-container-org2942de1">
<h3 id="org2942de1">Imports</h3>
<div class="outline-text-3" id="text-org2942de1">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9f33e48">
<h3 id="org9f33e48">The Sentiment Constants</h3>
<div class="outline-text-3" id="text-org9f33e48">
<div class="highlight">
<pre><span></span><span class="n">Sentiment</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">positive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org61a9a7c">
<h3 id="org61a9a7c">The Declaration</h3>
<div class="outline-text-3" id="text-org61a9a7c">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NaiveBayes</span><span class="p">:</span>
    <span class="sd">"""Naive Bayes Sentiment Classifier for Tweets</span>

<span class="sd">    Args:</span>
<span class="sd">     tweets: the training tweets</span>
<span class="sd">     labels: the sentiment labels for the training tweets</span>
<span class="sd">    """</span>
    <span class="n">tweets</span><span class="p">:</span> <span class="n">Iterable</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Iterable</span>
    <span class="n">_counter</span><span class="p">:</span> <span class="n">WordCounter</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_logprior</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_loglikelihood</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgcffcb70">
<h3 id="orgcffcb70">The Counter</h3>
<div class="outline-text-3" id="text-orgcffcb70">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WordCounter</span><span class="p">:</span>
    <span class="sd">"""The word processor/counter"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge9eca8f">
<h3 id="orge9eca8f">The Vocabulary</h3>
<div class="outline-text-3" id="text-orge9eca8f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
    <span class="sd">"""The unique tokens in the tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org95dffe5">
<h3 id="org95dffe5">The logprior</h3>
<div class="outline-text-3" id="text-org95dffe5">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">logprior</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""the log-odds of the priors"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logprior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">positive_documents</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">negative_documents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">positive_documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logprior</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">positive_documents</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">negative_documents</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logprior</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org3c0321d">
<h3 id="org3c0321d">The loglikelihood</h3>
<div class="outline-text-3" id="text-org3c0321d">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">loglikelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""The log-likelihoods for words"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span>        

        <span class="n">all_positive_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
             <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
        <span class="n">all_negative_words</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
             <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span>
        <span class="n">vocabulary_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">:</span>
            <span class="n">this_word_positive_count</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
            <span class="n">this_word_negative_count</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>

            <span class="n">probability_word_is_positive</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_positive_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                         <span class="p">(</span><span class="n">all_positive_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>
            <span class="n">probability_word_is_negative</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_word_negative_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span>
                                         <span class="p">(</span><span class="n">all_negative_words</span> <span class="o">+</span> <span class="n">vocabulary_size</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_positive</span><span class="p">)</span> <span class="o">-</span>
                                         <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probability_word_is_negative</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loglikelihood</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7e2c7d5">
<h3 id="org7e2c7d5">Predict Probability</h3>
<div class="outline-text-3" id="text-org7e2c7d5">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""predict the odds-ratio positive/negative</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: the tweet to predict</span>

<span class="sd">    Returns:</span>
<span class="sd">     log-odds-ratio for tweet (positive/negative)</span>
<span class="sd">    """</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprior</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglikelihood</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf7ec3a3">
<h3 id="orgf7ec3a3">Predict Sentiment</h3>
<div class="outline-text-3" id="text-orgf7ec3a3">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict_sentiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Predict whether the tweet's sentiment is positive or negative</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: the 'document' to analyze</span>

<span class="sd">    Returns:</span>
<span class="sd">     the sentiment (0=negative, 1=positive)</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_ratio</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orged51cf2">
<h3 id="orged51cf2">Check Rep</h3>
<div class="outline-text-3" id="text-orged51cf2">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">check_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Does some basic checks of the input arguments"""</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb630b98">
<h2 id="orgb630b98">Testing</h2>
<div class="outline-text-2" id="text-orgb630b98"></div>
<div class="outline-3" id="outline-container-org854680b">
<h3 id="org854680b">Imports</h3>
<div class="outline-text-3" id="text-org854680b">
<div class="highlight">
<pre><span></span><span class="sd">"""NaiveBayes Tweet Sentiment Classifier feature tests."""</span>

<span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">be</span><span class="p">,</span>
    <span class="n">be_empty</span><span class="p">,</span>
    <span class="n">be_true</span><span class="p">,</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pytest_bdd</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">given</span><span class="p">,</span>
    <span class="n">scenarios</span><span class="p">,</span>
    <span class="n">then</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">pytest_bdd</span>

<span class="c1"># this test repo</span>
<span class="kn">from</span> <span class="nn">fixtures</span> <span class="kn">import</span> <span class="n">katamari</span>

<span class="c1"># software under test</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.naive_bayes</span> <span class="kn">import</span> <span class="n">NaiveBayes</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga576cd0">
<h3 id="orga576cd0">Test Setup</h3>
<div class="outline-text-3" id="text-orga576cd0">
<div class="highlight">
<pre><span></span><span class="n">scenarios</span><span class="p">(</span><span class="s2">"../../features/twitter/naive_bayes.feature"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org16b19ca">
<h3 id="org16b19ca">Can you construct it?</h3>
<div class="outline-text-3" id="text-org16b19ca">
<div class="highlight">
<pre><span></span>Feature: NaiveBayes Tweet Sentiment Classifier

Scenario: The user builds the classifier
  Given a Naive Bayes definition
  When the user builds the classifier
  Then it has the expected attributes
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user builds the classifier</span>


<span class="nd">@given</span><span class="p">(</span><span class="s1">'a Naive Bayes definition'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a_naive_bayes_definition</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">NaiveBayes</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s1">'the user builds the classifier'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">the_user_builds_the_classifier</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="s2">"alfa bravo charley"</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">definition</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                              <span class="n">labels</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s1">'it has the expected attributes'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">it_has_the_expected_attributes</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">check_rep</span><span class="p">()</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc1e5eef">
<h3 id="orgc1e5eef">Does it build the counter?</h3>
<div class="outline-text-3" id="text-orgc1e5eef">
<div class="highlight">
<pre><span></span>Scenario: The user checks the counter
  Given a Naive Bayes classifier
  When the user checks the counter
  Then it is the expected counter
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user checks the counter</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a Naive Bayes classifier"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">build_naive_classifier</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">NaiveBayes</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="p">[],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the counter"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">WordCounter</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter_definition</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counter_definition</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counter</span>
    <span class="n">mocker</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">"neurotic.nlp.twitter.naive_bayes.WordCounter"</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counter_definition</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_counter</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">counter</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is the expected counter"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_counter</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_counter</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">counter</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbb6b1b5">
<h3 id="orgbb6b1b5">Does it build the logprior?</h3>
<div class="outline-text-3" id="text-orgbb6b1b5">
<div class="highlight">
<pre><span></span>Scenario: The user checks the log-prior
 Given a valid Naive Bayes Classifier
 When the user checks the log-odds prior
 Then it is close enough
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user checks the log-prior</span>

<span class="nd">@given</span><span class="p">(</span><span class="s2">"a valid Naive Bayes Classifier"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">setup_classifier</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"a blowfish"</span><span class="p">,</span> <span class="s2">"b closing"</span><span class="p">,</span> <span class="s2">"c that"</span><span class="p">,</span> <span class="s2">"d plane"</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({</span>
        <span class="p">(</span><span class="s2">"appl"</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>

    <span class="p">})</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">NaiveBayes</span><span class="p">(</span><span class="n">tweets</span><span class="o">=</span><span class="n">katamari</span><span class="o">.</span><span class="n">tweets</span><span class="p">,</span>
                                     <span class="n">labels</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">_counts</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">counts</span>
    <span class="k">return</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the log-odds prior"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_log_odds_prior</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">logprior</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is close enough"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_close_enough</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc5903e3">
<h3 id="orgc5903e3">Does it build the vocabulary?</h3>
<div class="outline-text-3" id="text-orgc5903e3">
<div class="highlight">
<pre><span></span>Scenario: The user checks the vocabulary
  Given a valid Naive Bayes Classifier
  When the user checks the vocabulary
  Then all the words are there
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user checks the vocabulary</span>
<span class="c1">#  Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the vocabulary"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_vocabulary</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
  <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">vocabulary</span>
  <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"appl"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">}</span>
  <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"all the words are there"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compare_words</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">^</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_empty</span><span class="p">)</span>
  <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1f5dbfd">
<h3 id="org1f5dbfd">Does it build the log-likelihood?</h3>
<div class="outline-text-3" id="text-org1f5dbfd">
<div class="highlight">
<pre><span></span>Scenario: The user gets the log-likelihood dictionary
  Given a valid Naive Bayes Classifier
  When the user checks the loglikelihoods
  Then they are close enough
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user gets the log-likelihood dictionary</span>
<span class="c1">#  Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user checks the loglikelihoods"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_log_likelihoods</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">appl</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">6</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span>
        <span class="n">b</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span>
        <span class="n">c</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"they are close enough"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_close_values</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">[</span><span class="n">word</span><span class="p">],</span>
                            <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">[</span><span class="n">word</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6fa8570">
<h3 id="org6fa8570">Does it predict probabilities?</h3>
<div class="outline-text-3" id="text-org6fa8570">
<div class="highlight">
<pre><span></span>Scenario: User predicts tweet positive probability
  Given a valid Naive Bayes Classifier
  When the user makes a tweet prediction
  Then it is the expected probability
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: User predicts tweet positive probability</span>
<span class="c1">#   Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user makes a tweet prediction"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_prediction</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">logprior</span>
                         <span class="o">+</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">[</span><span class="s2">"c"</span><span class="p">]</span>
                         <span class="o">+</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">[</span><span class="s2">"b"</span><span class="p">])</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_ratio</span><span class="p">(</span>
        <span class="s2">"c you later b"</span>
    <span class="p">)</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"it is the expected probability"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_probability</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual</span><span class="p">,</span> <span class="n">katamari</span><span class="o">.</span><span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5f81a29">
<h3 id="org5f81a29">Does it predict the sentiment?</h3>
<div class="outline-text-3" id="text-org5f81a29">
<div class="highlight">
<pre><span></span>Scenario: The user predicts tweet sentiment
  Given a valid Naive Bayes Classifier
  When the user predicts the sentiment of tweets
  Then the sentiments are the expected ones
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># Scenario: The user predicts tweet sentiment</span>
<span class="c1">#   Given a valid Naive Bayes Classifier</span>


<span class="nd">@when</span><span class="p">(</span><span class="s2">"the user predicts the sentiment of tweets"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_predict_sentiment</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_1</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_sentiment</span><span class="p">(</span><span class="s2">"c you later b"</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected_1</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">katamari</span><span class="o">.</span><span class="n">actual_2</span> <span class="o">=</span> <span class="n">katamari</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_sentiment</span><span class="p">(</span><span class="s2">"apple banana tart"</span><span class="p">)</span>
    <span class="n">katamari</span><span class="o">.</span><span class="n">expected_2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>


<span class="nd">@then</span><span class="p">(</span><span class="s2">"the sentiments are the expected ones"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expect_sentiments</span><span class="p">(</span><span class="n">katamari</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected_1</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">actual_2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">katamari</span><span class="o">.</span><span class="n">expected_2</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0ec434a">
<h2 id="org0ec434a">End</h2>
<div class="outline-text-2" id="text-org0ec434a">
<p>Now that we have the class-based version let's do a little <a href="posts/nlp/visualizing-naive-bayes/">visualization of the model</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/naive-bayes-twitter-sentiment-classification/">Implementing a Naive Bayes Twitter Sentiment Classifier</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/" rel="bookmark"><time class="published dt-published" datetime="2020-08-29T10:16:04-07:00" itemprop="datePublished" title="2020-08-29 10:16">2020-08-29 10:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org492d197">Beginning</a>
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orga1e8b9c">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org0fb3632">Middle</a>
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org3bce091">Implementing the Model</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orgdfe19cb">Making Predictions</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#orgd671c38">Filtering Words</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org33209c2">Error Analysis</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org640155a">Predict Your Own Tweet</a></li>
</ul>
</li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification/#org3129fd2">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org492d197">
<h2 id="org492d197">Beginning</h2>
<div class="outline-text-2" id="text-org492d197">
<p>In the <a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/">previous post</a> I went through some of the background of how Naive Bayes works. In this post I'll implement a Naive Bayes Classifier to classify tweets by whether they are positive in sentiment or negative. The Naive Bayes model uses Bayes' rule to make its predictions and it's called "naive" because it makes the assumption that words in the document are independent (in the probability event sense) which allows us to use the multiplication rule to calculate our probabilities. It also uses the \(\textit{Bag of Words}\) assumption that word ordering isn't important.</p>
</div>
<div class="outline-3" id="outline-container-orga1e8b9c">
<h3 id="orga1e8b9c">Set Up</h3>
<div class="outline-text-3" id="text-orga1e8b9c">
<p>This first bit imports the needed dependencies followed by setting up the data and some helpers.</p>
</div>
<div class="outline-4" id="outline-container-org268b818">
<h4 id="org268b818">Imports</h4>
<div class="outline-text-4" id="text-org268b818">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.counter</span> <span class="kn">import</span> <span class="n">WordCounter</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org388fea3">
<h4 id="org388fea3">Tabulate</h4>
<div class="outline-text-4" id="text-org388fea3">
<p>This sets up tabulate to make it a little simpler to display pandas DataFrames in org.</p>
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf1b67db">
<h4 id="orgf1b67db">The Dotenv</h4>
<div class="outline-text-4" id="text-orgf1b67db">
<p>I put the path to the data files in a .env file so this loads it into the environment.</p>
<div class="highlight">
<pre><span></span><span class="n">env_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">env_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">env_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6d7f1fd">
<h4 id="org6d7f1fd">Load the Twitter Data</h4>
<div class="outline-text-4" id="text-org6d7f1fd">
<p>I split the data <a href="posts/nlp/01-twitter-preprocessing-with-nltk/">previously</a> for the Logistic Regression twitter sentiment classifier so I'll load it here and skip building the sets.</p>
<div class="highlight">
<pre><span></span><span class="n">train_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TRAINING_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>

<span class="n">test_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_TEST_RAW"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_raw</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Testing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_raw</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training: 8,000
Testing: 2,000
</pre>
<p>I'll also re-use the WordCounter from the Logistic Regression. Despite the name it also does tokenizing and cleaning.</p>
<div class="highlight">
<pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">WordCounter</span><span class="p">(</span><span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org41ee906">
<h4 id="org41ee906">Constants</h4>
<div class="outline-text-4" id="text-org41ee906">
<p>This was an object I created to store a few constant values.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"TWITTER_SENTIMENT"</span><span class="p">],</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">Sentiment</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Sentiment</span><span class="p">)</span>
</pre></div>
<pre class="example">
Namespace(decode={1: 'positive', 0: 'negative'}, encode={'positive': 1, 'negative': 0}, negative=0, positive=1)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0fb3632">
<h2 id="org0fb3632">Middle</h2>
<div class="outline-text-2" id="text-org0fb3632"></div>
<div class="outline-3" id="outline-container-org3bce091">
<h3 id="org3bce091">Implementing the Model</h3>
<div class="outline-text-3" id="text-org3bce091">
<p>In an <a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/">earlier post</a> I wrote up a little of the background behind what we're doing and now I'm going to translate the math in that post into code.</p>
</div>
<div class="outline-4" id="outline-container-org3fbf830">
<h4 id="org3fbf830">Implementing The Training Function</h4>
<div class="outline-text-4" id="text-org3fbf830">
<p>The first part of the problem - training the model by building up the probabilities.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_naive_bayes</span><span class="p">(</span><span class="n">counts</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span>
                      <span class="n">train_x</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                      <span class="n">train_y</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       counts: Counter from (word, label) to how often the word appears</span>
<span class="sd">       train_x: a list of tweets</span>
<span class="sd">       train_y: a list of labels correponding to the tweets (0,1)</span>

<span class="sd">    Returns:</span>
<span class="sd">       logprior: the log odds ratio</span>
<span class="sd">       loglikelihood: log likelihood dictionary for the Naive bayes equation</span>
<span class="sd">    """</span>
    <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">logprior</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">vocabulary</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">])</span>
    <span class="n">V</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>

    <span class="c1"># number of positive and negative words in the training set</span>
    <span class="n">N_pos</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
                 <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">))</span>
    <span class="n">N_neg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">counts</span><span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span><span class="p">)]</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">sentiment</span> <span class="ow">in</span> <span class="n">counts</span>
                 <span class="k">if</span> <span class="n">sentiment</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">))</span>

    <span class="n">D</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>

    <span class="c1"># D_pos is number of positive documents</span>
    <span class="n">D_pos</span> <span class="o">=</span> <span class="n">train_y</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># D_neg is the number of negative documents</span>
    <span class="n">D_neg</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">D_pos</span>

    <span class="c1"># the log odds ratio</span>
    <span class="n">logprior</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">D_neg</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
        <span class="n">freq_pos</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)]</span>
        <span class="n">freq_neg</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)]</span>

        <span class="c1"># the probability that the word is positive, and negative</span>
        <span class="n">p_w_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N_pos</span> <span class="o">+</span> <span class="n">V</span><span class="p">)</span>
        <span class="n">p_w_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_neg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N_neg</span> <span class="o">+</span> <span class="n">V</span><span class="p">)</span>

        <span class="n">loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_w_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_w_neg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span>
</pre></div>
<p>Now we can see what we get when we train our model.</p>
<div class="highlight">
<pre><span></span><span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">train_naive_bayes</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Log Prior: </span><span class="si">{</span><span class="n">logprior</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Words in Log Likelihood: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loglikelihood</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Log Prior: -0.006500022885560952
Words in Log Likelihood: 9,172
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Positive Tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_raw</span><span class="p">[</span><span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">])</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Negative Tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_raw</span><span class="p">[</span><span class="n">train_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">])</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Positive Tweets: 3,987
Negative Tweets: 4,013
</pre>
<p>We get a negative value for the <code>logprior</code> because we have more negative tweets than positive tweets in the training set and the negative count is the second term when we calculate the difference for the <code>logprior</code>. If we evened it out it would drop to 0.</p>
<div class="highlight">
<pre><span></span><span class="n">all_raw</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_raw</span><span class="p">,</span> <span class="n">test_raw</span><span class="p">])</span>
<span class="n">check</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">all_raw</span><span class="p">[</span><span class="n">all_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4000</span><span class="p">],</span> <span class="n">all_raw</span><span class="p">[</span><span class="n">all_raw</span><span class="o">.</span><span class="n">label</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4000</span><span class="p">]])</span>
<span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span> <span class="o">=</span> <span class="n">train_naive_bayes</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">check</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">check</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Log Prior: </span><span class="si">{</span><span class="n">logprior</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Log Likelihood: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loglikelihood</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Log Prior: 0.0
Log Likelihood: 9172
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgdfe19cb">
<h3 id="orgdfe19cb">Making Predictions</h3>
<div class="outline-text-3" id="text-orgdfe19cb">
<p>Now that we have the model we can use it to make some predictions.</p>
<p>\[ p = logprior + \sum_i^N (loglikelihood_i) \]</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">logprior</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       tweet: a tweet to classify</span>
<span class="sd">       logprior: the log odds ratio of prior probabilities</span>
<span class="sd">       loglikelihood: a dictionary of words mapped to their log likelihood ratios</span>

<span class="sd">    Returns:</span>
<span class="sd">       p: sum of the log-odds ratio for the tweet</span>
<span class="sd">    """</span>
    <span class="c1"># process the tweet to get a list of words</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logprior</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loglikelihood</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
</pre></div>
<p>Now test it with a tweet.</p>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s1">'She smiled.'</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'The positive to negative ratio is </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">.'</span><span class="p">)</span>
</pre></div>
<pre class="example">
The positive to negative ratio is 1.44.
</pre>
<p>Since the ratio is greater than 0, we're predicting that the tweet has a positive sentiment.</p>
</div>
<div class="outline-4" id="outline-container-org0477406">
<h4 id="org0477406">Test The Model</h4>
<div class="outline-text-4" id="text-org0477406">
<p>Now we'll calculate the accuracy of the model against the test set.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_naive_bayes</span><span class="p">(</span><span class="n">test_x</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">test_y</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                     <span class="n">logprior</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       test_x: tweets to classify</span>
<span class="sd">       test_y: labels for test_x</span>
<span class="sd">       logprior: the logprior for the training set</span>
<span class="sd">       loglikelihood: a dictionary with the loglikelihoods for each word</span>

<span class="sd">    Returns:</span>
<span class="sd">       accuracy: (# of tweets classified correctly)/(total # of tweets)</span>
<span class="sd">    """</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">y_hats</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">test_x</span><span class="p">])</span>

    <span class="c1"># error is the average of the absolute values of the differences between y_hats and test_y</span>
    <span class="c1"># error = number wrong/number of tweets</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_hats</span> <span class="o">-</span> <span class="n">test_y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Accuracy is 1 minus the error</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">error</span>
    <span class="k">return</span> <span class="n">accuracy</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Naive Bayes accuracy = </span><span class="si">%0.4f</span><span class="s2">"</span> <span class="o">%</span>
      <span class="p">(</span><span class="n">test_naive_bayes</span><span class="p">(</span><span class="n">test_raw</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)))</span>
</pre></div>
<pre class="example">
Naive Bayes accuracy = 0.9955
</pre>
<p>Which looks good, but it might actually be overfitting - it looks too good. Now here's some example tweets to check.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'I am happy'</span><span class="p">,</span> <span class="s1">'I am bad'</span><span class="p">,</span> <span class="s1">'this movie should have been great.'</span><span class="p">,</span>
              <span class="s1">'great'</span><span class="p">,</span> <span class="s1">'great great'</span><span class="p">,</span> <span class="s1">'great great great'</span><span class="p">,</span> <span class="s1">'great great great great'</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">tweet</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example">
I am happy -&gt; 1.89
I am bad -&gt; -1.63
this movie should have been great. -&gt; 2.05
great -&gt; 2.06
great great -&gt; 4.13
great great great -&gt; 6.19
great great great great -&gt; 8.25
</pre>
<p>It looks like the word "great" throws off the third sentence which hints at being negative. What if we pass in a neutral (nonsensical) tweet?</p>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s2">"the answer is nicht in the umwelt"</span>
<span class="nb">print</span><span class="p">(</span><span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">))</span>
</pre></div>
<pre class="example">
-0.41441957689474407
</pre>
<p>I don't know which of those words triggered the negative value</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="s2">"the answer is nicht in the umwelt"</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
the:    0.00
answer: -0.41
is:     0.00
nicht:  0.00
in:     0.00
the:    0.00
umwelt: 0.00
</pre>
<p>It only got one word, <code>answer</code> and that's negative for some reason. Go figure.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd671c38">
<h3 id="orgd671c38">Filtering Words</h3>
<div class="outline-text-3" id="text-orgd671c38">
<p>This is sort of an aside, but one way to quickly filter tweets based on how positive or negative they are is to use the ratio of positive to negative counts and setting a threshold that has to be met to be included in the output.</p>
<p>\[ ratio = \frac{\text{pos_words} + 1}{\text{neg_words} + 1} \]</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Words</th>
<th class="org-right" scope="col">Positive word count</th>
<th class="org-right" scope="col">Negative Word Count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">glad</td>
<td class="org-right">41</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">arriv</td>
<td class="org-right">57</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-left">:(</td>
<td class="org-right">1</td>
<td class="org-right">3663</td>
</tr>
<tr>
<td class="org-left">:-(</td>
<td class="org-right">0</td>
<td class="org-right">378</td>
</tr>
</tbody>
</table>
</div>
<div class="outline-4" id="outline-container-org9cc1bb7">
<h4 id="org9cc1bb7">Get The Ratio</h4>
<div class="outline-text-4" id="text-org9cc1bb7">
<p>As an intermediate step we'll create a function named <code>get_ratio</code> that looks up a word and calculates the positive to negative ratio.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_ratio</span><span class="p">(</span><span class="n">freqs</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       freqs: Counter with (word, sentiment) : count</span>
<span class="sd">       word: string to lookup</span>

<span class="sd">    Returns: </span>
<span class="sd">     dictionary with keys 'positive', 'negative', and 'ratio'.</span>
<span class="sd">       Example: {'positive': 10, 'negative': 20, 'ratio': 0.5}</span>
<span class="sd">    """</span>
    <span class="n">pos_neg_ratio</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">)],</span>
        <span class="n">negative</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[(</span><span class="n">word</span><span class="p">,</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">)],</span>
    <span class="p">)</span>

    <span class="c1"># calculate the ratio of positive to negative counts for the word</span>
    <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s1">'ratio'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"positive"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span>
        <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"negative"</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos_neg_ratio</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_ratio</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="s1">'happi'</span><span class="p">))</span>
</pre></div>
<pre class="example">
{'positive': 160, 'negative': 23, 'ratio': 6.708333333333333}
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgedaeb08">
<h4 id="orgedaeb08">Get Words By Threshold</h4>
<div class="outline-text-4" id="text-orgedaeb08">
<p>Now we'll create the filter function. To make it simpler we'll assume that if we're filtering on the positive label then the ratio for a word to be included has to be equal to or greater than the given threshold while if the label is negative then a word has to be less than or equal to the threshold. Doing this means we're filtering to get words that are further toward the extremes of positive or negative (further from 0).</p>
<p>An example key-value pair would have this structure:</p>
<div class="highlight">
<pre><span></span><span class="p">{</span><span class="s1">'happi'</span><span class="p">:</span>
     <span class="p">{</span><span class="s1">'positive'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'negative'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">'ratio'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
 <span class="p">}</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_words_by_threshold</span><span class="p">(</span><span class="n">freqs</span><span class="p">:</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Args:</span>
<span class="sd">       freqs: Counter of (word, sentiment): word count</span>
<span class="sd">       label: 1 for positive, 0 for negative</span>
<span class="sd">       threshold: ratio that will be used as the cutoff for including a word in the returned dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">       words: dictionary containing the word and information on its positive count, negative count, and ratio of positive to negative counts.</span>
<span class="sd">       example of a key value pair:</span>
<span class="sd">       {'happi':</span>
<span class="sd">           {'positive': 10, 'negative': 20, 'ratio': 0.5}</span>
<span class="sd">       }</span>
<span class="sd">    """</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">:</span>
        <span class="n">pos_neg_ratio</span> <span class="o">=</span> <span class="n">get_ratio</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">label</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"ratio"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span> <span class="ow">and</span> <span class="n">pos_neg_ratio</span><span class="p">[</span><span class="s2">"ratio"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)):</span>
            <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_neg_ratio</span>

    <span class="k">return</span> <span class="n">words</span>
</pre></div>
<p>Here's an example where we'll filter on negative sentiment so all the tweets should be negative and have a positive to negative ration less that the threshold.</p>
<div class="highlight">
<pre><span></span><span class="n">passed</span> <span class="o">=</span> <span class="n">get_words_by_threshold</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">passed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="se">\t</span><span class="s2">word: </span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
1       word: :(        {'positive': 1, 'negative': 3705, 'ratio': 0.0005396654074473826}
2       word: :-(       {'positive': 0, 'negative': 407, 'ratio': 0.0024509803921568627}
3       word:  {'positive': 0, 'negative': 162, 'ratio': 0.006134969325153374}
4       word:  {'positive': 0, 'negative': 162, 'ratio': 0.006134969325153374}
5       word: believ   {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
6       word: will     {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
7       word: justin   {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
8       word:        {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
9       word:         {'positive': 0, 'negative': 27, 'ratio': 0.03571428571428571}
10      word: sad       {'positive': 3, 'negative': 100, 'ratio': 0.039603960396039604}
11      word: &gt;:(    {'positive': 0, 'negative': 36, 'ratio': 0.02702702702702703}
</pre>
<p>So our threshold gives us the eleven most negative words.</p>
<p>Now, what about filtering on the most positive words?</p>
<div class="highlight">
<pre><span></span><span class="n">passed</span> <span class="o">=</span> <span class="n">get_words_by_threshold</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Sentiment</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">passed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="se">\t</span><span class="s2">word: </span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
1       word: :)        {'positive': 2967, 'negative': 1, 'ratio': 1484.0}
2       word: :-)       {'positive': 547, 'negative': 0, 'ratio': 548.0}
3       word: :D        {'positive': 537, 'negative': 0, 'ratio': 538.0}
4       word: :p        {'positive': 113, 'negative': 0, 'ratio': 114.0}
5       word: fback     {'positive': 22, 'negative': 0, 'ratio': 23.0}
6       word: blog      {'positive': 29, 'negative': 2, 'ratio': 10.0}
7       word: followfriday      {'positive': 19, 'negative': 0, 'ratio': 20.0}
8       word: recent    {'positive': 9, 'negative': 0, 'ratio': 10.0}
9       word: stat      {'positive': 52, 'negative': 0, 'ratio': 53.0}
10      word: arriv     {'positive': 57, 'negative': 4, 'ratio': 11.6}
11      word: thx       {'positive': 11, 'negative': 0, 'ratio': 12.0}
12      word: here'     {'positive': 19, 'negative': 0, 'ratio': 20.0}
13      word: influenc  {'positive': 16, 'negative': 0, 'ratio': 17.0}
14      word: bam       {'positive': 34, 'negative': 0, 'ratio': 35.0}
15      word: warsaw    {'positive': 34, 'negative': 0, 'ratio': 35.0}
16      word: welcom    {'positive': 58, 'negative': 4, 'ratio': 11.8}
17      word: vid       {'positive': 9, 'negative': 0, 'ratio': 10.0}
18      word: ceo       {'positive': 9, 'negative': 0, 'ratio': 10.0}
19      word: 1month    {'positive': 9, 'negative': 0, 'ratio': 10.0}
20      word: flipkartfashionfriday     {'positive': 14, 'negative': 0, 'ratio': 15.0}
21      word: inde      {'positive': 10, 'negative': 0, 'ratio': 11.0}
22      word: glad      {'positive': 35, 'negative': 2, 'ratio': 12.0}
23      word: braindot  {'positive': 9, 'negative': 0, 'ratio': 10.0}
24      word: ;)        {'positive': 21, 'negative': 0, 'ratio': 22.0}
25      word: goodnight {'positive': 19, 'negative': 1, 'ratio': 10.0}
26      word: youth     {'positive': 10, 'negative': 0, 'ratio': 11.0}
27      word: shout     {'positive': 9, 'negative': 0, 'ratio': 10.0}
28      word: fantast   {'positive': 10, 'negative': 0, 'ratio': 11.0}
</pre>
<p>The first four make sense, but after that maybe not so much. "fback"?</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org33209c2">
<h3 id="org33209c2">Error Analysis</h3>
<div class="outline-text-3" id="text-org33209c2">
<p>Now let's look at some tweets that we got wrong. We're going to use <a href="https://numpy.org/doc/stable/reference/generated/numpy.sign.html">numpy.sign</a> which reduces numbers to <code>-1</code>, <code>0</code>, or <code>1</code>.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'Truth Predicted Tweet'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="n">y_hat</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y_hat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="se">\t</span><span class="s2">"</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tweet</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">,</span> <span class="s1">'ignore'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Truth Predicted Tweet
0       1       b'whatev stil l young &gt;:-('
1       0       b'look fun kik va 642 kik kikgirl french model orgasm hannib phonesex :)'
0       1       b'great news thank let us know :( hope good weekend'
0       1       b"amb pleas harry' jean :) ): ): ):"
0       1       b'srsli fuck u unfollow hope ur futur child unpar u &gt;:-('
1       0       b'ate last cooki shir 0 &gt;:d'
1       0       b'snapchat jennyjean 22 snapchat kikmeboy model french kikchat sabadodeganarseguidor sexysasunday :)'
1       0       b'add kik ughtm 545 kik kikmeguy kissm nude likeforfollow musicbiz sexysasunday :)'
0       1       b'sr financi analyst expedia inc bellevu wa financ expediajob job job hire'
</pre>
<p>For some reason it misses the <code>&gt;:-(</code> emoji and the <code>:)</code> - maybe they didn't occur in the training set. I think these woud be hard for a human to get too, unless you were well versed in tweets and emojis and maybe even then it would be hard</p>
</div>
</div>
<div class="outline-3" id="outline-container-org640155a">
<h3 id="org640155a">Predict Your Own Tweet</h3>
<div class="outline-text-3" id="text-org640155a">
<p>Let's try a random tweet not in the given training or test sets.</p>
<div class="highlight">
<pre><span></span><span class="n">my_tweet</span> <span class="o">=</span> <span class="s1">'my balls itch'</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">naive_bayes_predict</span><span class="p">(</span><span class="n">my_tweet</span><span class="p">,</span> <span class="n">logprior</span><span class="p">,</span> <span class="n">loglikelihood</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">my_tweet</span><span class="si">}</span><span class="s2"> is a positive tweet: </span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
my balls itch is a positive tweet: True
</pre>
<p>Hmmm. Maybe</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3129fd2">
<h2 id="org3129fd2">End</h2>
<div class="outline-text-2" id="text-org3129fd2">
<p>I want to do more work with the Naive Bayes Classifier but this post is getting too long so I'm going to move on to other posts, the next being a <a href="posts/nlp/class-based-naive-bayes-tweet-sentiment-classifier/">class-based implementation</a> of the model.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/">Using Naive Bayes to Classify Tweets by Sentiment</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/" rel="bookmark"><time class="published dt-published" datetime="2020-08-28T09:25:00-07:00" itemprop="datePublished" title="2020-08-28 09:25">2020-08-28 09:25</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/#org567fdce">Beginning</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/#org825f8a4">Middle</a></li>
<li><a href="posts/nlp/naive-bayes-twitter-sentiment-classification-background/#org240e8e2">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org567fdce">
<h2 id="org567fdce">Beginning</h2>
<div class="outline-text-2" id="text-org567fdce">
<p>In a <a href="posts/nlp/implementing-twitter-logistic-regression/">previous post</a> I implemented a Logistic Regression model to classify twitter tweets as having a positive or negative sentiment. This time I'll be using the same data set (from <a href="http://www.nltk.org/">NLTK</a>) but implementing it with a <a href="https://www.wikiwand.com/en/Naive_Bayes_classifier">Naive Bayes</a> model. This post will look at some of the math behind it and the next one will translate the math into code.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org825f8a4">
<h2 id="org825f8a4">Middle</h2>
<div class="outline-text-2" id="text-org825f8a4"></div>
<div class="outline-4" id="outline-container-orgb7158bb">
<h4 id="orgb7158bb">Bayesian Inference</h4>
<div class="outline-text-4" id="text-orgb7158bb">
<p>What we want is to take a document (<i>D</i>) - which is a tweet in this case - and guess its classification \(\hat{c}\). We do this by calculating the probability for both of our classifications (<i>positive</i> and <i>negative</i>) using Bayes' Rule and then choosing the classification with the higher probability.</p>
\begin{align} \hat{c} &amp;= \underset{c \in C}{\mathrm{argmax}} P(c|d)\\ &amp;= \underset{c \in C}{\mathrm{argmax}} P(D|c)P(c)\\ \end{align}
<p>So our guess as to what class the document belongs to is the classification with the highest probability given the document - and "the probability of the classification given the document", when translated using Bayes' Rule, becomes the probability of the document given the classification (the <i>likelihood</i> of the document) times the prior probability of any document belonging to the class. But then you might wonder - if there's only one of each document then won't the probability always be \(\frac{1}{c}\)? It would, so we use the words within the document to calculate the probability for the document. How? Well, I mentioned earlier that we make two assumptions - that the documents can be represented as a bag of words and that they are independent. The independent assumption allows us to figure out the total probability using the Multiplication Rule:</p>
<p>\[ P(A \cap B) = P(A)P(B) \]</p>
<p>The probability of A and B is the product of their probabilities. In this case we are calculating the probability of the document as the product of the conditional probabilities of the words given the class:</p>
<p>\[ P(D|c) = \prod_{i=1}^{n}P(w_i | c) \]</p>
<p>Where the <i>n</i> refers to the number of words in the document. Given this we could re-write the previous equation like this.</p>
\begin{align} \hat{c} &amp;= \underset{c \in C}{\textrm{argmax}} P(c) \prod_{i}^{n} P(w_i | c)\\ \end{align}
<p>But it turns out this form isn't really ideal. Among other things you're multiplying values that range from 0 to 1, with most values being less than 1, so the more classes you have, the smaller this number will get and you could end up with really small numbers leading to <a href="https://www.wikiwand.com/en/Arithmetic_underflow">underflow</a>. So we're going to do a log transform of the equation which will also simplify the computation a little (although nowadays I don't know that that's so much of a consideration).</p>
<p>\[ \hat{c} = \underset{c \in C}{\textrm{argmax}} \log{P(c)} + \sum_{i=1}^n \log{P(w_i|c)} \]</p>
<p>This is what we'll use to classify tweets after training the model by building up the probabilities.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgab446b0">
<h4 id="orgab446b0">Ratios</h4>
<div class="outline-text-4" id="text-orgab446b0">
<p>While I wrote out the general case where you take the class with the highest probability, in this case we only have two classes, <i>positive</i> and <i>negative</i> so we can take advantage of this and make our classification using the ratio of the conditional probabilities for each class (the log <a href="https://www.wikiwand.com/en/Odds_ratio">odds ratio</a>). We're going to use the ratio of positive to negative.</p>
<p>\[ \log{\frac{P(positive|D)}{P(negative | D)}} = \log{\frac{P(positive)}{P(negative)}} + \sum_{i=1}^n \log{\frac{P(w_i|positive)}{P(w_i|negative)}} \]</p>
<p>Since <i>positive</i> is the numerator, and the log of values less than one are negative, this ratio will be positive when the review is likely positive and negative otherwise, so we can use the sign of this ratio to classify tweets.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgfac174e">
<h4 id="orgfac174e">Priors and Log Priors</h4>
<div class="outline-text-4" id="text-orgfac174e">
<p>Now we can start picking apart our ratio. The prior probabilities are just the fraction of our training set that matches a variable. So the prior probabilities of the document classifications can be described like this:</p>
\begin{align} P(D_{positive}) &amp;= \frac{\textit{number of positive tweets}}{\textit{total number of tweets}}\\ &amp;= \frac{D_{pos}}{D}\\ \end{align} \begin{align} P(D_{negative}) &amp;= \frac{\textit{number of negative tweets}}{\textit{total number of tweets}}\\ &amp;= \frac{D_{neg}}{D}\\ \end{align}
<p>But as I noted above we are going to use the ratio of the prior probabilities \(\frac{P(D_{pos})}{P(D_{neg})}\) and if you look at them, they have the same denominator (<i>D</i>) so taking the ratio of the probabilities means the denominator cancels out and we end up with the ratio of the positive to negative documents.</p>
\begin{align} \frac{P(D_{pos})}{P(D_{neg})} &amp;= \frac{\frac{D_{pos}}{D}}{\frac{D_{neg}}{D}}\\ &amp;= \frac{\left( \frac{D_{pos}}{\cancel{D}}\right) \left(\frac{\cancel{D}}{D_{neg}}\right) }{ \cancel{\left(\frac{D_{neg}}{D}\right)} \cancel{\left(\frac{D}{D_{neg}}\right)} }\\ &amp;= \frac{D_{pos}}{D_{neg}}\\ \end{align}
<p>And as I noted above, we'll be using a log transform so our ratio (which will be called <i>logprior</i>) needs to be transformed as well.</p>
\begin{align} \text{logprior} &amp;= log \left( \frac{P(D_{pos})}{P(D_{neg})} \right) \\ &amp;= log \left( \frac{D_{pos}}{D_{neg}} \right)\\ \end{align}
<p>Note that \(log(\frac{A}{B})\) is the same as \(log(A) - log(B)\). So the logprior can also be calculated as the difference between two logs:</p>
\begin{align} \text{logprior} &amp;= \log (P(D_{pos})) - \log (P(D_{neg})) \\ &amp;= \log (D_{pos}) - \log (D_{neg})\\ \end{align}
<p>I don't know that this helps any with computation, but it makes it clearer (to me) that the ratio will be positive when the tweet's sentiment is positive and negative when the sentiment is negative.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgc700cb6">
<h4 id="orgc700cb6">Positive and Negative Word Probabilities</h4>
<div class="outline-text-4" id="text-orgc700cb6">
<p>Now for the second part of our equation. To compute the positive probability and the negative probability for a specific word in the vocabulary, we'll use the following inputs:</p>
<ul class="org-ul">
<li>\(freq_{pos} =\) the number of times the word is counted in a document with a label of 1</li>
<li>\(freq_{neg} =\) the number of times the word is counted in a document with a label of 0</li>
<li>\(N_{pos} = \) the number of words in all the positive documents</li>
<li>\(N_{neg} = \) the number of words in all the negative documents</li>
<li><i>V</i> is the number of unique words in the entire set of documents</li>
<li><i>W</i> is a word in a document</li>
</ul>
<p>So now we can re-write our numerator and denominator for the second term.</p>
\begin{align} P(W|positive) &amp;= P(W_{pos})\\ &amp;= \frac{freq_{pos}}{N_{pos}}\\ \end{align} \begin{align} P(W | negative ) &amp;= P(W_{neg})\\ &amp;= \frac{freq_{neg}}{N_{neg}}\\ \end{align}
<p>Meaning that the likelihood of the word given the class is the number of times the word shows up in documents of that class divided by a count of all the unique words in the corpus. One thing to notice, though, is that our numerators have the count for a word within documents labeled with the classification, but it's not guaranteed that all of the words will show up in both classes (the word "horrible" might only show up in the negative tweets, for instance) so if a word shows up in one class but not the other, we might end up with a zero in the numerator or denominator and not only is division by zero not defined, but neither is the logarithm of zero. The solution is to add 1 to the numerator and the size of the vocabulary to the denominator (adding 1 for each word). Besides fixing our arithmetic problem there's some other more mathy reasons for doing this that are explained in this <a href="https://en.wikipedia.org/wiki/Additive_smoothing">wikipedia article</a>.</p>
<p>With those changes we now have:</p>
\begin{align} P(W_{pos}) &amp;= \frac{freq_{pos} + 1}{N_{pos} + V}\\ \end{align} \begin{align} P(W_{neg}) &amp;= \frac{freq_{neg} + 1}{N_{neg} + V}\\ \end{align}
<p>And the log-likelihood term becomes:</p>
\begin{align} \text{loglikelihood} &amp;= \log \left(\frac{P(W_{pos})}{P(W_{neg})} \right)\\ &amp;= \log P(W_{pos}) - \log P(W_{neg})\\ &amp;= \log \frac{freq_{pos} + 1}{N_{pos} + V} - \log \frac{freq_{neg} + 1}{N_{neg} + V} \end{align}</div>
</div>
</div>
<div class="outline-2" id="outline-container-org240e8e2">
<h2 id="org240e8e2">End</h2>
<div class="outline-text-2" id="text-org240e8e2">
<p>Now that we have the math I'm going to implement the model using python in <a href="posts/nlp/naive-bayes-twitter-sentiment-classification/">this post</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/bibliographies/text-data-management-and-analysis/">Text Data Management and Analysis</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/bibliographies/text-data-management-and-analysis/" rel="bookmark"><time class="published dt-published" datetime="2020-07-30T13:23:23-07:00" itemprop="datePublished" title="2020-07-30 13:23">2020-07-30 13:23</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org3839c37">
<h2 id="org3839c37">Bibliography</h2>
<div class="outline-text-2" id="text-org3839c37">
<ul class="org-ul">
<li>Zhai C, Massung S. Text data management and analysis: a practical introduction to information retrieval and text mining. First edition. New York: Association for Computing Machinery; 2016. 510 p. (ACM books).</li>
</ul>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="next"><a href="index-11.html" rel="next">Older posts</a></li>
</ul>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script><!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script>
</body>
</html>
