<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/" rel="canonical">
<link href="index-18.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
<link href="posts/nlp/ner-testing-the-model/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item active"><a class="nav-link" href=".">Cloistered Monkey <span class="sr-only">(active)</span></a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-testing-the-model/">NER: Testing the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-testing-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:03:18-08:00" itemprop="datePublished" title="2021-01-13 15:03">2021-01-13 15:03</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-testing-the-model/#org9f512b6">Testing New Sentences</a>
<ul>
<li><a href="posts/nlp/ner-testing-the-model/#org06156ca">Set Up the Model and Maps</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-testing-the-model/#org9f84dda">Middle</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org9f512b6">
<h2 id="org9f512b6">Testing New Sentences</h2>
<div class="outline-text-2" id="text-org9f512b6">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/">The Previous Post</a></li>
</ul>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="p">(</span><span class="n">NER</span><span class="p">,</span>
                                                   <span class="n">NERData</span><span class="p">,</span>
                                                   <span class="n">TOKEN</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org06156ca">
<h3 id="org06156ca">Set Up the Model and Maps</h3>
<div class="outline-text-3" id="text-org06156ca">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">),</span>
            <span class="n">tag_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span><span class="o">.</span><span class="n">model</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/ner/model.pkl.gz"</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_35180_50
  LSTM_50
  Dense_18
  LogSoftmax
]
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org9f84dda">
<h2 id="org9f84dda">Middle</h2>
<div class="outline-text-2" id="text-org9f84dda">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
            <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">unknown</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Predicts the named entities in a sentence</span>

<span class="sd">    Args:</span>
<span class="sd">     sentence: the sentence to analyze</span>
<span class="sd">     model: the NER model</span>
<span class="sd">     vocabulary: token to id map</span>
<span class="sd">     tags: tag to id map</span>
<span class="sd">     unknown: key in the vocabulary for unknown tokens</span>
<span class="sd">    """</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">unknown</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
    <span class="n">batch_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)))</span>
    <span class="n">batch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">tokens</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">predictions</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s2">"Bilbo Baggins, the Shire's director of trade and manufacturing policy for the Lord Sauron, said in an interview on Sunday morning that Rumblefish was working to prepare for the possibility of a second wave of the Coronavirus in the Fall, although he said it wouldnâ€™t necessarily come before the fall of the Empire and the rise of the corpse brigade in July"</span>

<span class="k">def</span> <span class="nf">print_predictions</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="o">!=</span> <span class="s1">'O'</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">print_predictions</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
</pre></div>
<pre class="example">
Lord - B-org
Sauron, - I-org
Sunday - B-tim
morning - I-tim
July - B-tim
</pre>
<div class="highlight">
<pre><span></span><span class="n">print_predictions</span><span class="p">(</span><span class="s2">"anyone lived in a pretty how town "</span>
                  <span class="s2">"(with up so floating many bells down) "</span>
                  <span class="s2">"spring summer autumn winter "</span>
                  <span class="s2">"he sang his didn't he danced his did."</span><span class="p">)</span>
</pre></div>
<pre class="example">
summer - I-tim
autumn - I-tim
</pre>
<p>Hmm, that's interesting.</p>
<div class="highlight">
<pre><span></span><span class="n">print_predictions</span><span class="p">(</span><span class="s2">"Spring Summer Autumn Winter"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Summer - B-eve
</pre>
<p>Some kind of anti-spring bias.</p>
<div class="highlight">
<pre><span></span><span class="n">print_predictions</span><span class="p">(</span><span class="s2">"Boogie booty bunny butt"</span><span class="p">)</span>
</pre></div>
<pre class="example">
booty - B-per
</pre>
<p>Well, I suppose I'd have to match the dataset to put more weird things in there.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-evaluating-the-model/">NER: Evaluating the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-evaluating-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:02:42-08:00" itemprop="datePublished" title="2021-01-13 15:02">2021-01-13 15:02</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgb4ddedc">Beginning</a>
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgdfb686e">Imports</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/#org18d66ab">Set Up</a>
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgc6199e0">Plotting</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/#org124c1e0">The Previous Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/ner-evaluating-the-model/#org9ed62b9">Middle</a>
<ul>
<li><a href="posts/nlp/ner-evaluating-the-model/#orga519145">A Test Input</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/#orgc0dfa1c">Plotting</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb4ddedc">
<h2 id="orgb4ddedc">Beginning</h2>
<div class="outline-text-2" id="text-orgb4ddedc">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-training-the-model/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-testing-the-model/">The Next Post</a></li>
</ul>
<p>Now we'll evaluate our model using the test set. To do this we'll need to create a mask to avoid counting the padding tokens when computing the accuracy.</p>
<ul class="org-ul">
<li><b>Step 1</b>: Calling <code>model(sentences)</code> will give us the predicted output.</li>
<li><b>Step 2</b>: The output will be the prediction with an added dimension. For each word in each sentence there will be a vector of probabilities for each tag type. For each word in each sentence we'll need to pick the maximum valued tag. This will require <a href="https://numpy.org/doc/stable/reference/generated/numpy.argmax.html"><code>np.argmax</code></a> and careful use of the <code>axis</code> argument.</li>
<li><b>Step 3</b>: Create a mask to prevent counting pad characters. It will have the same dimensions as the output.</li>
<li><b>Step 4</b>: Compute the accuracy metric by comparing the outputs against the test labels. Take the sum of that and divide by the total number of <b>unpadded</b> tokens. Use the mask value to mask the padded tokens.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-orgdfb686e">
<h3 id="orgdfb686e">Imports</h3>
<div class="outline-text-3" id="text-orgdfb686e">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">trax</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DataGenerator</span><span class="p">,</span>
                                                   <span class="n">NER</span><span class="p">,</span>
                                                   <span class="n">NERData</span><span class="p">,</span>
                                                   <span class="n">TOKEN</span><span class="p">)</span>
<span class="c1"># another project</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org18d66ab">
<h3 id="org18d66ab">Set Up</h3>
<div class="outline-text-3" id="text-org18d66ab"></div>
<div class="outline-4" id="outline-container-orgc6199e0">
<h4 id="orgc6199e0">Plotting</h4>
<div class="outline-text-4" id="text-orgc6199e0">
<div class="highlight">
<pre><span></span><span class="n">slug</span> <span class="o">=</span> <span class="s2">"ner-evaluating-the-model"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org124c1e0">
<h4 id="org124c1e0">The Previous Code</h4>
<div class="outline-text-4" id="text-org124c1e0">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">),</span>
            <span class="n">tag_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span><span class="o">.</span><span class="n">model</span>

<span class="n">Settings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Settings"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"batch_size"</span><span class="p">,</span> <span class="s2">"padding_id"</span><span class="p">,</span> <span class="s2">"seed"</span><span class="p">])</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                    <span class="n">padding_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">],</span>
                    <span class="n">seed</span><span class="o">=</span><span class="mi">33</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/ner/model.pkl.gz"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

<span class="n">test_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span>
                                   <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">padding_id</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_35180_50
  LSTM_50
  Dense_18
  LogSoftmax
]
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org9ed62b9">
<h2 id="org9ed62b9">Middle</h2>
<div class="outline-text-2" id="text-org9ed62b9">
<p>As a reminder, here's what happens when you apply a boolean comparison to a numpy array.</p>
<div class="highlight">
<pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
<pre class="example">
[False  True False False]
</pre></div>
<div class="outline-3" id="outline-container-orga519145">
<h3 id="orga519145">A Test Input</h3>
<div class="outline-text-3" id="text-orga519145">
<div class="highlight">
<pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">test_generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"x's shape: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> y's shape: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">predictions</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"predictions has shape: </span><span class="si">{</span><span class="n">predictions</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
x's shape: (64, 44) y's shape: (64, 44)
&lt;class 'jax.interpreters.xla._DeviceArray'&gt;
predictions has shape: (64, 44, 18)
</pre>
<p><b>Note:</b> the model's prediction has 3 axes:</p>
<ul class="org-ul">
<li>the number of examples</li>
<li>the number of words in each example (padded to be as long as the longest sentence in the batch)</li>
<li>the number of possible targets (the 17 named entity tags).</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">evaluate_prediction</span><span class="p">(</span><span class="n">pred</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">interpreters</span><span class="o">.</span><span class="n">xla</span><span class="o">.</span><span class="n">_DeviceArray</span><span class="p">,</span>
                        <span class="n">labels</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                        <span class="n">pad</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">padding_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculates the accuracy of a prediction</span>

<span class="sd">    Args:</span>
<span class="sd">      pred: prediction array with shape </span>
<span class="sd">           (num examples, max sentence length in batch, num of classes)</span>
<span class="sd">      labels: array of size (batch_size, seq_len)</span>
<span class="sd">      pad: integer representing pad character</span>

<span class="sd">    Returns:</span>
<span class="sd">      accuracy: fraction of correct predictions</span>
<span class="sd">    """</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">pad</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">outputs</span><span class="o">==</span><span class="n">labels</span><span class="p">)[</span><span class="n">mask</span><span class="p">])</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">evaluate_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"accuracy: "</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
</pre></div>
<pre class="example">
accuracy:  0.9636752
</pre>
<p>Hmm, does pretty good.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgc0dfa1c">
<h3 id="orgc0dfa1c">Plotting</h3>
<div class="outline-text-3" id="text-orgc0dfa1c">
<p>Let's look at running more batches. It occurred to me that you could also just do the whole set at once, I don't know what's special about using the batches.</p>
<div class="highlight">
<pre><span></span><span class="n">repetitions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
    <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">)</span><span class="o">/</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
<span class="n">nexts</span> <span class="o">=</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">test_generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">repetition</span> <span class="ow">in</span> <span class="n">repetitions</span><span class="p">)</span>
<span class="n">accuracies</span> <span class="o">=</span> <span class="p">[</span><span class="n">evaluate_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">nexts</span><span class="p">]</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">Accuracy</span><span class="o">=</span><span class="n">accuracies</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">"hist"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">tan</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Accuracy Distribution"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"accuracy_distribution"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/ner-evaluating-the-model/accuracy_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-training-the-model/">NER: Training the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-training-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:01:58-08:00" itemprop="datePublished" title="2021-01-13 15:01">2021-01-13 15:01</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-training-the-model/#org590a65e">Training the Model</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#org5776b32">Imports</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org54dd79c">Set Up</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#org4b3397d">Plotting</a></li>
<li><a href="posts/nlp/ner-training-the-model/#orgecc20b7">Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/ner-training-the-model/#org497a5c5">Middle</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#org10d3d0f">The Data Generators</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org38ecdc0">Training The Model</a></li>
<li><a href="posts/nlp/ner-training-the-model/#orga8135ac">Plotting the Metrics</a>
<ul>
<li><a href="posts/nlp/ner-training-the-model/#org1a7e7d5">Accuracy</a></li>
<li><a href="posts/nlp/ner-training-the-model/#org8b86653">Plotting Loss</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org590a65e">
<h2 id="org590a65e">Training the Model</h2>
<div class="outline-text-2" id="text-org590a65e">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-building-the-model/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/">The Next Post</a></li>
</ul>
</div>
<div class="outline-3" id="outline-container-org5776b32">
<h3 id="org5776b32">Imports</h3>
<div class="outline-text-3" id="text-org5776b32">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryFile</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">holoviews</span> <span class="kn">import</span> <span class="n">opts</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">trax.supervised</span> <span class="kn">import</span> <span class="n">training</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">trax</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DataGenerator</span><span class="p">,</span>
                                                   <span class="n">NER</span><span class="p">,</span>
                                                   <span class="n">NERData</span><span class="p">,</span>
                                                   <span class="n">TOKEN</span><span class="p">)</span>
<span class="c1"># another project</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org54dd79c">
<h3 id="org54dd79c">Set Up</h3>
<div class="outline-text-3" id="text-org54dd79c"></div>
<div class="outline-4" id="outline-container-org4b3397d">
<h4 id="org4b3397d">Plotting</h4>
<div class="outline-text-4" id="text-org4b3397d">
<div class="highlight">
<pre><span></span><span class="n">slug</span> <span class="o">=</span> <span class="s2">"ner-training-the-model"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgecc20b7">
<h4 id="orgecc20b7">Data</h4>
<div class="outline-text-4" id="text-orgecc20b7">
<div class="highlight">
<pre><span></span><span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="n">Settings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Settings"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"seed"</span><span class="p">,</span> <span class="s2">"batch_size"</span><span class="p">,</span> <span class="s2">"embedding_size"</span><span class="p">,</span> <span class="s2">"learning_rate"</span><span class="p">])</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">embedding_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">trainee</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">),</span>
              <span class="n">tag_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

<span class="n">training_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span>
                                   <span class="n">y</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                                   <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">validation_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">,</span>
                                     <span class="n">y</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_validate</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                     <span class="n">padding</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">speak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org497a5c5">
<h2 id="org497a5c5">Middle</h2>
<div class="outline-text-2" id="text-org497a5c5"></div>
<div class="outline-3" id="outline-container-org10d3d0f">
<h3 id="org10d3d0f">The Data Generators</h3>
<div class="outline-text-3" id="text-org10d3d0f">
<p>Before we start, we need to create the data generators for training and validation data. It is important that you mask padding in the loss weights of your data, which can be done using the <code>id_to_mask</code> argument of <code>trax.supervised.inputs.add_loss_weights</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">train_generator</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add_loss_weights</span><span class="p">(</span>
    <span class="n">training_generator</span><span class="p">,</span>
    <span class="n">id_to_mask</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">evaluate_generator</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">add_loss_weights</span><span class="p">(</span>
    <span class="n">validation_generator</span><span class="p">,</span>
    <span class="n">id_to_mask</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org38ecdc0">
<h3 id="org38ecdc0">Training The Model</h3>
<div class="outline-text-3" id="text-org38ecdc0">
<p>You will now write a function that takes in your model and trains it.</p>
<p>As you've seen in the previous assignments, you will first create the <a href="https://trax-ml.readthedocs.io/en/stable/trax.supervised.html#trax.supervised.training.TrainTask">TrainTask</a> and <a href="https://trax-ml.readthedocs.io/en/stable/trax.supervised.html#trax.supervised.training.EvalTask">EvalTask</a> using your data generator. Then you will use the <code>training.Loop</code> to train your model.</p>
<p><b>Instructions:</b> Implement the <code>train_model</code> program below to train the neural network above. Here is a list of things you should do:</p>
<ul class="org-ul">
<li>Create the trainer object by calling <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.Loop"><code>trax.supervised.training.Loop</code></a> and pass in the following:
<ul class="org-ul">
<li>model = NER</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.TrainTask">training task</a> that uses the train data generator defined in the cell above</li>
<li>loss_layer = <a href="https://github.com/google/trax/blob/22765bb18608d376d8cd660f9865760e4ff489cd/trax/layers/metrics.py#L71">tl.CrossEntropyLoss()</a></li>
<li>optimizer = <a href="https://github.com/google/trax/blob/03cb32995e83fc1455b0c8d1c81a14e894d0b7e3/trax/optimizers/adam.py#L23">trax.optimizers.Adam(0.01)</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.EvalTask">evaluation task</a> that uses the validation data generator defined in the cell above
<ul class="org-ul">
<li>metrics for <code>EvalTask</code>: <code>tl.CrossEntropyLoss()</code> and <code>tl.Accuracy()</code></li>
<li>in <code>EvalTask</code> set <code>n_eval_batches=10</code> for better evaluation accuracy</li>
</ul>
</li>
<li>output_dir = output_dir</li>
</ul>
</li>
</ul>
<p>You'll be using a <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.CrossEntropyLoss">cross entropy loss</a>, with an <a href="https://trax-ml.readthedocs.io/en/latest/trax.optimizers.html#trax.optimizers.adam.Adam">Adam optimizer</a>. Please read the <a href="https://trax-ml.readthedocs.io/en/latest/trax.html">trax</a> documentation to get a full understanding. The <a href="https://github.com/google/trax">trax GitHub</a> also contains some useful information and a link to a colab notebook.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">NER</span><span class="p">:</span> <span class="n">trax</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">,</span>
                <span class="n">train_generator</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                <span class="n">eval_generator</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                <span class="n">train_steps</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">steps_per_checkpoint</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="s2">"~/models/ner/"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">:</span>
    <span class="sd">"""Train the Named Entity Recognition Model</span>
<span class="sd">    Args: </span>
<span class="sd">      NER: the model you are building</span>
<span class="sd">      train_generator: The data generator for training examples</span>
<span class="sd">      eval_generator: The data generator for validation examples,</span>
<span class="sd">      train_steps: number of training steps</span>
<span class="sd">      output_dir: folder to save your model</span>

<span class="sd">    Returns:</span>
<span class="sd">      training_loop: a trax supervised training Loop</span>
<span class="sd">    """</span>
    <span class="n">train_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
        <span class="n">labeled_data</span><span class="o">=</span><span class="n">train_generator</span><span class="p">,</span>
        <span class="n">loss_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">WeightedCategoryCrossEntropy</span><span class="p">(),</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">),</span>
        <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="n">steps_per_checkpoint</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">eval_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
      <span class="n">labeled_data</span> <span class="o">=</span> <span class="n">eval_generator</span><span class="p">,</span>
      <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="o">.</span><span class="n">WeightedCategoryCrossEntropy</span><span class="p">(),</span>
                 <span class="n">layers</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span>
      <span class="n">n_eval_batches</span> <span class="o">=</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="p">)</span>

    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span>
        <span class="n">NER</span><span class="p">,</span>
        <span class="n">train_task</span><span class="p">,</span>
        <span class="n">eval_tasks</span><span class="o">=</span><span class="p">[</span><span class="n">eval_task</span><span class="p">],</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running </span><span class="si">{</span><span class="n">train_steps</span><span class="si">}</span><span class="s2"> steps"</span><span class="p">)</span>
    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span> <span class="o">=</span> <span class="n">train_steps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">training_loop</span>
</pre></div>
<p>For some reason they don't give you the option to turn off the print statements so I'm going to suppress all stdout.</p>
<div class="highlight">
<pre><span></span><span class="n">training_steps</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="n">real_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<span class="n">TIMER</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">with</span> <span class="n">TemporaryFile</span><span class="p">(</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">temp_file</span>
    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">trainee</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">train_generator</span><span class="p">,</span>
                                <span class="n">evaluate_generator</span><span class="p">,</span>
                                <span class="n">steps_per_checkpoint</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">train_steps</span><span class="o">=</span><span class="n">training_steps</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">TIMER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">real_stdout</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">TIMER</span><span class="o">.</span><span class="n">ended</span> <span class="o">-</span> <span class="n">TIMER</span><span class="o">.</span><span class="n">started</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0:03:51.538599
</pre></div>
</div>
<div class="outline-3" id="outline-container-orga8135ac">
<h3 id="orga8135ac">Plotting the Metrics</h3>
<div class="outline-text-3" id="text-orga8135ac"></div>
<div class="outline-4" id="outline-container-org1a7e7d5">
<h4 id="org1a7e7d5">Accuracy</h4>
<div class="outline-text-4" id="text-org1a7e7d5">
<div class="highlight">
<pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">training_loop</span><span class="o">.</span><span class="n">history</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span> <span class="s2">"metrics/Accuracy"</span><span class="p">),</span>
                         <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch Accuracy"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">Accuracy</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">maximum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">maximum</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s2">"Accuracy"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
                        <span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Accuracy"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_accuracy"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/ner-training-the-model/evaluation_accuracy.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
<div class="outline-4" id="outline-container-org8b86653">
<h4 id="org8b86653">Plotting Loss</h4>
<div class="outline-text-4" id="text-org8b86653">
<div class="highlight">
<pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"eval"</span><span class="p">,</span>
                                     <span class="s2">"metrics/WeightedCategoryCrossEntropy"</span><span class="p">),</span>
                         <span class="n">columns</span><span class="o">=</span><span class="s2">"Batch Loss"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">minimum</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">Loss</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
<span class="n">vline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">VLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">hline</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">minimum</span><span class="o">.</span><span class="n">Loss</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">HLine</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Batch"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Loss"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">hline</span> <span class="o">*</span> <span class="n">vline</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Evaluation Batch Cross Entropy"</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"evaluation_cross_entropy"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/ner-training-the-model/evaluation_cross_entropy.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So it looks like I passed the best point again and am probably overfitting. I wonder if they have a callback to grab the best model like pytorch does? I'm surprised at how fast these models train.</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-building-the-model/">NER: Building the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-building-the-model/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:01:26-08:00" itemprop="datePublished" title="2021-01-13 15:01">2021-01-13 15:01</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-building-the-model/#org01dafcc">Beginning</a>
<ul>
<li><a href="posts/nlp/ner-building-the-model/#orgc54369b">Imports</a></li>
<li><a href="posts/nlp/ner-building-the-model/#org88426d8">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-building-the-model/#orgba58d01">Middle</a>
<ul>
<li><a href="posts/nlp/ner-building-the-model/#orgea0208b">Inspecting the Model</a></li>
<li><a href="posts/nlp/ner-building-the-model/#org8a25dc2">Pack It Up for Later</a>
<ul>
<li><a href="posts/nlp/ner-building-the-model/#orge40b0a9">Imports</a></li>
<li><a href="posts/nlp/ner-building-the-model/#orge01cd59">Constants</a></li>
<li><a href="posts/nlp/ner-building-the-model/#org5bff2f8">The Model</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-building-the-model/#orgd04ddcb">Sanity Check</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org01dafcc">
<h2 id="org01dafcc">Beginning</h2>
<div class="outline-text-2" id="text-org01dafcc">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-data/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-training-the-model/">The Next Post</a></li>
</ul>
<p>Here we'll actually build the model.</p>
<ul class="org-ul">
<li>Feed the data into an Embedding layer, to produce more semantic entries</li>
<li>Feed it into an LSTM layer</li>
<li>Run the output through a linear layer</li>
<li>Run the result through a log softmax layer to get the predicted class for each word.</li>
</ul>
</div>
<div class="outline-3" id="outline-container-orgc54369b">
<h3 id="orgc54369b">Imports</h3>
<div class="outline-text-3" id="text-orgc54369b">
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">NERData</span><span class="p">,</span> <span class="n">TOKEN</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org88426d8">
<h3 id="org88426d8">Set Up</h3>
<div class="outline-text-3" id="text-org88426d8">
<div class="highlight">
<pre><span></span><span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="n">vocab</span> <span class="o">=</span> <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span>
<span class="n">tag_map</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgba58d01">
<h2 id="orgba58d01">Middle</h2>
<div class="outline-text-2" id="text-orgba58d01">
<p>These are the Trax components we'll use (the links are to the implementations on Github).</p>
<ul class="org-ul">
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/combinators.py#L26">tl.Serial</a>: Combinator that applies layers serially (by function composition).</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L113">tl.Embedding</a>: Initializes the embedding. In this case it is the dimension of the model by the size of the vocabulary.
<ul class="org-ul">
<li><code>tl.Embedding(vocab_size, d_feature)</code>.</li>
<li><code>vocab_size</code> is the number of unique words in the given vocabulary.</li>
<li><code>d_feature</code> is the number of elements in the word embedding (some choices for a word embedding size range from 150 to 300, for example).</li>
</ul>
</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/rnn.py#L87">tl.LSTM</a>:=Trax= LSTM layer of size d_model.
<ul class="org-ul">
<li><code>LSTM(n_units)</code> Builds an LSTM layer of n_cells.</li>
</ul>
</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L28)(https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py%23L28">tl.Dense</a>: A dense layer.
<ul class="org-ul">
<li><code>tl.Dense(n_units)</code>: The parameter <code>n_units</code> is the number of units chosen for this dense layer.</li>
</ul>
</li>
<li><a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L242">tl.LogSoftmax</a>: Log of the output probabilities.
<ul class="org-ul">
<li>Here, you don't need to set any parameters for <code>LogSoftMax()</code>.</li>
</ul>
</li>
</ul>
<p><b>Online documentation</b></p>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#module-trax.layers.combinators">tl.Serial</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Embedding">tl.Embedding</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.rnn.LSTM">tl.LSTM</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Dense">tl.Dense</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.LogSoftmax">tl.LogSoftmax</a></li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">NER</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">35181</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="n">tag_map</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Args: </span>
<span class="sd">      vocab_size: number of words in the vocabulary</span>
<span class="sd">      d_model: the embedding size</span>

<span class="sd">    Returns:</span>
<span class="sd">       model: a trax serial model</span>
<span class="sd">    """</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_feature</span><span class="o">=</span><span class="n">d_model</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">d_model</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tag_map</span><span class="p">)),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgea0208b">
<h3 id="orgea0208b">Inspecting the Model</h3>
<div class="outline-text-3" id="text-orgea0208b">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">NER</span><span class="p">()</span>
<span class="c1"># display your model</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_35181_50
  LSTM_50
  Dense_18
  LogSoftmax
]
</pre></div>
</div>
<div class="outline-3" id="outline-container-org8a25dc2">
<h3 id="org8a25dc2">Pack It Up for Later</h3>
<div class="outline-text-3" id="text-org8a25dc2"></div>
<div class="outline-4" id="outline-container-orge40b0a9">
<h4 id="orge40b0a9">Imports</h4>
<div class="outline-text-4" id="text-orge40b0a9">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="kn">import</span> <span class="nn">attr</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge01cd59">
<h4 id="orge01cd59">Constants</h4>
<div class="outline-text-4" id="text-orge01cd59">
<div class="highlight">
<pre><span></span><span class="n">Settings</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Settings"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"embeddings_size"</span><span class="p">])</span>
<span class="n">SETTINGS</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5bff2f8">
<h4 id="org5bff2f8">The Model</h4>
<div class="outline-text-4" id="text-org5bff2f8">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NER</span><span class="p">:</span>
    <span class="sd">"""The named entity recognition model</span>

<span class="sd">    Args:</span>
<span class="sd">     vocabulary_size: number of tokens in the vocabulary</span>
<span class="sd">     tag_count: number of tags</span>
<span class="sd">     embeddings_size: the number of features in the embeddings layer</span>
<span class="sd">    """</span>
    <span class="n">vocabulary_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">tag_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">embeddings_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">SETTINGS</span><span class="o">.</span><span class="n">embeddings_size</span>
    <span class="n">_model</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgdc5ba4a"></a>The Actual Model<br>
<div class="outline-text-5" id="text-orgdc5ba4a">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
    <span class="sd">"""The NER model instance"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">,</span>
                             <span class="n">d_feature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_size</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_size</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_count</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgd04ddcb">
<h3 id="orgd04ddcb">Sanity Check</h3>
<div class="outline-text-3" id="text-orgd04ddcb">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">NER</span>

<span class="n">builder</span> <span class="o">=</span> <span class="n">NER</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="mi">666</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Serial[
  Embedding_122_50
  LSTM_50
  Dense_666
  LogSoftmax
]
</pre></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-data/">NER: Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-data/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T15:00:14-08:00" itemprop="datePublished" title="2021-01-13 15:00">2021-01-13 15:00</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-data/#org38f7aa9">The Data</a>
<ul>
<li><a href="posts/nlp/ner-data/#org5883759">Imports</a></li>
<li><a href="posts/nlp/ner-data/#org362657c">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-data/#orged37617">Middle</a>
<ul>
<li><a href="posts/nlp/ner-data/#org7b550f0">Reviewing The Dataset</a></li>
<li><a href="posts/nlp/ner-data/#org1a4a9d1">A Data Generator</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-data/#org8049c57">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/ner-data/#org14a0fab">Imports</a></li>
<li><a href="posts/nlp/ner-data/#org85fff6f">Some Types</a></li>
<li><a href="posts/nlp/ner-data/#org566db03">The Data Generator</a>
<ul>
<li><a href="posts/nlp/ner-data/#orga609f78">The Batch Generator</a></li>
<li><a href="posts/nlp/ner-data/#orgcb8d175">The Generator Method</a></li>
<li><a href="posts/nlp/ner-data/#orgdef3ca3">The Iterator Method</a></li>
<li><a href="posts/nlp/ner-data/#org858e1d7">The Next Method</a></li>
</ul>
</li>
<li><a href="posts/nlp/ner-data/#orgacb7400">Test It</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org38f7aa9">
<h2 id="org38f7aa9">The Data</h2>
<div class="outline-text-2" id="text-org38f7aa9">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/">The Previous Post</a></li>
<li><a href="posts/nlp/ner-building-the-model/">The Next Post</a></li>
</ul>
</div>
<div class="outline-3" id="outline-container-org5883759">
<h3 id="org5883759">Imports</h3>
<div class="outline-text-3" id="text-org5883759">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">NERData</span><span class="p">,</span> <span class="n">TOKEN</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org362657c">
<h3 id="org362657c">Set Up</h3>
<div class="outline-text-3" id="text-org362657c">
<div class="highlight">
<pre><span></span><span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="c1"># to make the functions pass we need to use their names (initially)</span>
<span class="n">vocab</span> <span class="o">=</span> <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vocabulary</span>
<span class="n">tag_map</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orged37617">
<h2 id="orged37617">Middle</h2>
<div class="outline-text-2" id="text-orged37617"></div>
<div class="outline-3" id="outline-container-org7b550f0">
<h3 id="org7b550f0">Reviewing The Dataset</h3>
<div class="outline-text-3" id="text-org7b550f0">
<p>As a review we can look at what's in the vocabulary.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="s2">"the"</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="s2">"The"</span><span class="p">])</span>
</pre></div>
<pre class="example">
9
35178
61
</pre>
<p>The vocabulary maps words in our vocabulary to unique integers. As you can see, we made it case-sensitive.</p>
<p>We also made a map for tags.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org3f2f153">
- O: 0
- B-geo: 1
- B-gpe: 2
- B-per: 3
- I-geo: 4
- B-org: 5
- I-org: 6
- B-tim: 7
- B-art: 8
- I-art: 9
- I-per: 10
- I-gpe: 11
- I-tim: 12
- B-nat: 13
- B-eve: 14
- I-eve: 15
- I-nat: 16
- UNK: 17
</pre>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Prefix</th>
<th class="org-left" scope="col">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">B</td>
<td class="org-left">Token Begins an entity</td>
</tr>
<tr>
<td class="org-left">I</td>
<td class="org-left">Token is Inside an entity</td>
</tr>
</tbody>
</table>
<p>This is to help when you have multi-token entities. So if you had the name "Burt Reynolds", "Burt" would be tagged <code>B-per</code> and "Reynolds" would be tagged "I-per".</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The number of tags is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tag_map</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The vocabulary size is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The training size is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The validation size is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"The first training sentence is "</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raw_data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Its corresponding label is"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" '</span><span class="si">{</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">raw_data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"The first training encoded sentence is "</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Its corresponding encoded label is"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org08634ec">
The number of tags is 18
The vocabulary size is 35,180
The training size is 33,570
The validation size is 7,194
The first training sentence is 
'Opposition leader Michael Howard said he hopes the government in coming weeks will try to uncover possible security flaws exploited in the attacks .'
Its corresponding label is
 'O O B-per I-per O O O O O O O O O O O O O O O O O O O O'
The first training encoded sentence is 
[7848, 538, 5951, 6187, 172, 502, 2453, 9, 293, 11, 5306, 822, 141, 1962, 7, 26689, 1176, 686, 11905, 14806, 11, 9, 292, 21]
Its corresponding encoded label is
[0, 0, 3, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
</pre></div>
</div>
<div class="outline-3" id="outline-container-org1a4a9d1">
<h3 id="org1a4a9d1">A Data Generator</h3>
<div class="outline-text-3" id="text-org1a4a9d1">
<p>The generator will have a main outer loop:</p>
<pre class="example" id="org97301f9">
while True:  
    yield((X,Y))  
</pre>
<p>runs continuously in the fashion of generators, pausing when yielding the next values. We will generate a batch_size output on each pass of this loop.</p>
<p>It has two inner loops.</p>
<ol class="org-ol">
<li>The first stores in temporal lists the data samples to be included in the next batch, and finds the maximum length of the sentences contained in it. By adjusting the length to include only the size of the longest sentence in each batch, overall computation is reduced.</li>
<li>The second loop moves those inputs from the temporal list into NumPy arrays pre-filled with pad values.</li>
</ol>
<p>There are three slightly out of the ordinary features.</p>
<ol class="org-ol">
<li>The first is the use of the NumPy <code>full</code> function to fill the NumPy arrays with a pad value. See <a href="https://numpy.org/doc/1.18/reference/generated/numpy.full.html"><code>full</code> function documentation</a>.</li>
<li>The second is tracking the current location in the incoming lists of sentences. Generators variables hold their values between invocations, so we create an <code>index</code> variable, initialize to zero, and increment by one for each sample included in a batch. However, we do not use the <code>index</code> to access the positions of the list of sentences directly. Instead, we use it to select one index from a list of indexes. In this way, we can change the order in which we traverse our original list, keeping untouched our original list.</li>
<li>The third also relates to wrapping. Because <code>batch_size</code> and the length of the input lists are not aligned, gathering a batch_size group of inputs may involve wrapping back to the beginning of the input loop. In our approach, it is just enough to reset the <code>index</code> to 0. We can re-shuffle the list of indexes to produce different batches each time.</li>
</ol>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">pad</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Generate batches of data for training</span>

<span class="sd">    Args: </span>
<span class="sd">      batch_size - size of each batch generated</span>
<span class="sd">      x - sentences where words are represented as integers</span>
<span class="sd">      y - tags associated with the sentences</span>
<span class="sd">      pad - number to use as the padding character</span>
<span class="sd">      shuffle - Whether to shuffle the data</span>
<span class="sd">      verbose - Whether to print information to stdout</span>

<span class="sd">    Yields:</span>
<span class="sd">     a tuple containing 2 elements:</span>
<span class="sd">       X - np.ndarray of dim (batch_size, max_len) of padded sentences</span>
<span class="sd">       Y - np.ndarray of dim (batch_size, max_len) of tags associated with the sentences in X</span>
<span class="sd">    """</span>    
    <span class="c1"># count the number of lines in data_lines</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># create an array with the indexes of data_lines that can be shuffled</span>
    <span class="n">lines_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">))</span>

    <span class="c1"># shuffle the indexes if shuffle is set to True</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># tracks current location in x, y</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">buffer_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">buffer_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
             <span class="c1"># if the index is greater than or equal to the number of lines in x</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">num_lines</span><span class="p">:</span>
                <span class="c1"># then reset the index to 0</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># re-shuffle the indexes if shuffle is set to True</span>
                <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

            <span class="c1"># The current position is obtained using `lines_index[index]`</span>
            <span class="c1"># Store the x value at the current position into the buffer_x</span>
            <span class="n">buffer_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">lines_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

            <span class="c1"># Store the y value at the current position into the buffer_y</span>
            <span class="n">buffer_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">lines_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

            <span class="n">lenx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>    <span class="c1">#length of current x[]</span>
            <span class="k">if</span> <span class="n">lenx</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="n">lenx</span>                   <span class="c1">#max_len tracks longest x[]</span>

            <span class="c1"># increment index by one</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>


        <span class="c1"># create X,Y, NumPy arrays of size (batch_size, max_len) 'full' of pad value</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_len</span><span class="p">),</span> <span class="n">pad</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_len</span><span class="p">),</span> <span class="n">pad</span><span class="p">)</span>

        <span class="c1"># copy values from lists to NumPy arrays. Use the buffered values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># get the example (sentence as a tensor)</span>
            <span class="c1"># in `buffer_x` at the `i` index</span>
            <span class="n">x_i</span> <span class="o">=</span> <span class="n">buffer_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># similarly, get the example's labels</span>
            <span class="c1"># in `buffer_y` at the `i` index</span>
            <span class="n">y_i</span> <span class="o">=</span> <span class="n">buffer_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Walk through each word in x_i</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_i</span><span class="p">)):</span>
                <span class="c1"># store the word in x_i at position j into X</span>
                <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                <span class="c1"># store the label in y_i at position j into Y</span>
                <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">"index="</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">yield</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">mini_sentences</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">8</span><span class="p">]</span>
<span class="n">mini_labels</span> <span class="o">=</span> <span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">8</span><span class="p">]</span>
<span class="n">dg</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">mini_sentences</span><span class="p">,</span> <span class="n">mini_labels</span><span class="p">,</span> <span class="n">vocab</span><span class="p">[</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
<span class="n">X2</span><span class="p">,</span> <span class="n">Y2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Y1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:],</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">Y1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span>
</pre></div>
<pre class="example">
index= 5
index= 2
(5, 27) (5, 27) (5, 24) (5, 24)
[ 7848   538  5951  6187   172   502  2453     9   293    11  5306   822
   141  1962     7 26689  1176   686 11905 14806    11     9   292    21
 35178 35178 35178] 
 [    0     0     3    10     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
 35178 35178 35178]
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org8049c57">
<h2 id="org8049c57">Bundle It Up</h2>
<div class="outline-text-2" id="text-org8049c57"></div>
<div class="outline-3" id="outline-container-org14a0fab">
<h3 id="org14a0fab">Imports</h3>
<div class="outline-text-3" id="text-org14a0fab">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org85fff6f">
<h3 id="org85fff6f">Some Types</h3>
<div class="outline-text-3" id="text-org85fff6f">
<div class="highlight">
<pre><span></span><span class="n">Vectors</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
<span class="n">Batch</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org566db03">
<h3 id="org566db03">The Data Generator</h3>
<div class="outline-text-3" id="text-org566db03">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">:</span>
    <span class="sd">"""A generator of data to train the NER Model</span>

<span class="sd">    Args:</span>
<span class="sd">     batch_size: how many lines to generate at once</span>
<span class="sd">     x: the encoded sentences</span>
<span class="sd">     y: the encoded labels </span>
<span class="sd">     padding: encoding to use for padding lines</span>
<span class="sd">     shuffle: whether to shuffle the data</span>
<span class="sd">     verbose: whether to print messages to stdout</span>
<span class="sd">    """</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Vectors</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">Vectors</span>
    <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">_batch</span><span class="p">:</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga609f78">
<h4 id="orga609f78">The Batch Generator</h4>
<div class="outline-text-4" id="text-orga609f78">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">batch_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Generates batches"""</span>
    <span class="n">line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">line_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">line_count</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">line_indices</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">x_batch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">y_batch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">longest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">line_count</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">line_indices</span><span class="p">)</span>

            <span class="n">x_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">line_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
            <span class="n">y_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">line_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

            <span class="n">longest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">longest</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]))</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">longest</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">longest</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span> 
            <span class="n">line</span> <span class="o">=</span> <span class="n">x_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">y_batch</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">batch_index</span><span class="p">,</span> <span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
                <span class="n">Y</span><span class="p">[</span><span class="n">batch_index</span><span class="p">,</span> <span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"index="</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">return</span>    
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcb8d175">
<h4 id="orgcb8d175">The Generator Method</h4>
<div class="outline-text-4" id="text-orgcb8d175">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""The instance of the generator"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdef3ca3">
<h4 id="orgdef3ca3">The Iterator Method</h4>
<div class="outline-text-4" id="text-orgdef3ca3">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org858e1d7">
<h4 id="org858e1d7">The Next Method</h4>
<div class="outline-text-4" id="text-org858e1d7">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Batch</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgacb7400">
<h3 id="orgacb7400">Test It</h3>
<div class="outline-text-3" id="text-orgacb7400">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">DataGenerator</span>

<span class="n">generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">],</span>
                          <span class="n">y</span><span class="o">=</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="mi">8</span><span class="p">],</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">padding</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">])</span>

<span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
<span class="n">X2</span><span class="p">,</span> <span class="n">Y2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Y1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:],</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">Y1</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span>
</pre></div>
<pre class="example">
(5, 27) (5, 27) (5, 24) (5, 24)
[ 7848   538  5951  6187   172   502  2453     9   293    11  5306   822
   141  1962     7 26689  1176   686 11905 14806    11     9   292    21
 35178 35178 35178] 
 [    0     0     3    10     0     0     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     0     0     0
 35178 35178 35178]
</pre></div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/named-entity-recognition/">Named Entity Recognition</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/named-entity-recognition/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T14:55:54-08:00" itemprop="datePublished" title="2021-01-13 14:55">2021-01-13 14:55</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/named-entity-recognition/#orge3f6b89">Named Entity Recognition (NER)</a>
<ul>
<li><a href="posts/nlp/named-entity-recognition/#orgd649de0">The Posts In Order</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orge3f6b89">
<h2 id="orge3f6b89">Named Entity Recognition (NER)</h2>
<div class="outline-text-2" id="text-orge3f6b89">
<p>We'll start with the question - "What is Named Entity Recognition (NER)?". NER is a subtask of information extraction that locates and classifies named entities in a text. The named entities could be organizations, persons, locations, times, etc.</p>
<p>We'll train a named entity recognition system that could be trained in a few seconds (on a GPU) and will get around 75% accuracy. Then we'll load in the exact version of the model, which was trained for a longer period of time. We can then evaluate the trained version of the model to get 96% accuracy! Finally, we'll test the named entity recognition system with new sentences.</p>
</div>
<div class="outline-3" id="outline-container-orgd649de0">
<h3 id="orgd649de0">The Posts In Order</h3>
<div class="outline-text-3" id="text-orgd649de0">
<p>These are the posts where we'll actually implement the code.</p>
<ul class="org-ul">
<li><a href="posts/nlp/ner-pre-processing-the-data/">Preprocessing The Data</a></li>
<li><a href="posts/nlp/ner-data/">Generating the Data</a></li>
<li><a href="posts/nlp/ner-building-the-model/">Building the Model</a></li>
<li><a href="posts/nlp/ner-training-the-model/">Training the Model</a></li>
<li><a href="posts/nlp/ner-evaluating-the-model/">Evaluating the Model</a></li>
<li><a href="posts/nlp/ner-testing-the-model/">Testing the Model</a></li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/ner-pre-processing-the-data/">NER: Pre-Processing the Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/ner-pre-processing-the-data/" rel="bookmark"><time class="published dt-published" datetime="2021-01-13T14:43:13-08:00" itemprop="datePublished" title="2021-01-13 14:43">2021-01-13 14:43</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orgb7b7736">Preprocessing The Data</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org3e9c44f">Imports</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orga2accc4">Set Up</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orgd79c9e6">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org8c5f2eb">Middle</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org520edb2">The Kaggle Data</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org7ccaaa4">Words and Tags</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org7fc741e">Sentences and Labels</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org6f257ab">To Numbers</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org61afc1c">The Train-Test Split</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orga8a1f3a">Bundling This Up</a>
<ul>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org32d11ae">Imports</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org841a937">Some Constants</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org08394b4">The Data Processor</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org6e1a362">Data Vectorizer</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org23fac43">The Splitter</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org95151bd">The Loader</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#orgbde1cbd">The Processor</a></li>
<li><a href="posts/nlp/ner-pre-processing-the-data/#org7440e8b">Testing It Out</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb7b7736">
<h2 id="orgb7b7736">Preprocessing The Data</h2>
<div class="outline-text-2" id="text-orgb7b7736">
<ul class="org-ul">
<li><a href="posts/nlp/named-entity-recognition/">The First Post</a></li>
<li><a href="posts/nlp/ner-data/">The Next Post</a></li>
</ul>
<p>We will be using a dataset from <a href="https://www.kaggle.com/abhinavwalia95/entity-annotated-corpus">Kaggle</a> which appears to have originally come from the <a href="https://gmb.let.rug.nl/">Groningen Meaning Bank</a> (a bank of texts, not money). The original data consists of four columns, the sentence number, the word, the part of speech of the word, and the tags. A few tags you might expect to see are:</p>
<ul class="org-ul">
<li>geo: geographical entity</li>
<li>org: organization</li>
<li>per: person</li>
<li>gpe: geopolitical entity</li>
<li>tim: time indicator</li>
<li>art: artifact</li>
<li>eve: event</li>
<li>nat: natural phenomenon</li>
<li>O: filler word</li>
</ul>
</div>
<div class="outline-3" id="outline-container-org3e9c44f">
<h3 id="org3e9c44f">Imports</h3>
<div class="outline-text-3" id="text-org3e9c44f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">equal</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga2accc4">
<h3 id="orga2accc4">Set Up</h3>
<div class="outline-text-3" id="text-orga2accc4"></div>
<div class="outline-4" id="outline-container-orgd79c9e6">
<h4 id="orgd79c9e6">The Dataset</h4>
<div class="outline-text-4" id="text-orgd79c9e6">
<p><b>Note:</b> to get the encoding for the file use <code>file</code>:</p>
<pre class="example" id="org31715d5">
file -bi ner_dataset.csv
</pre>
<p>In this case we get:</p>
<pre class="example" id="org2e01d64">
application/csv; charset=iso-8859-1
</pre>
<p>Since it isn't ASCII or ISO-8 we'll have to tell pandas what the encoding is.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"NER_DATASET"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"ISO-8859-1"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8c5f2eb">
<h2 id="org8c5f2eb">Middle</h2>
<div class="outline-text-2" id="text-org8c5f2eb"></div>
<div class="outline-3" id="outline-container-org520edb2">
<h3 id="org520edb2">The Kaggle Data</h3>
<div class="outline-text-3" id="text-org520edb2">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-right">
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Sentence #</th>
<th class="org-left" scope="col">Word</th>
<th class="org-left" scope="col">POS</th>
<th class="org-left" scope="col">Tag</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">Sentence: 1</td>
<td class="org-left">Thousands</td>
<td class="org-left">NNS</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-right">nan</td>
<td class="org-left">of</td>
<td class="org-left">IN</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">2</td>
<td class="org-right">nan</td>
<td class="org-left">demonstrators</td>
<td class="org-left">NNS</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">3</td>
<td class="org-right">nan</td>
<td class="org-left">have</td>
<td class="org-left">VBP</td>
<td class="org-left">O</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-right">nan</td>
<td class="org-left">marched</td>
<td class="org-left">VBN</td>
<td class="org-left">O</td>
</tr>
</tbody>
</table>
<p>As you can (kind of) tell, the sentences are broken up so that each row has one word in it.</p>
<p>To make it easier to work with I'm going to rename the columns.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentence #"</span><span class="p">:</span><span class="s2">"sentence"</span><span class="p">,</span> <span class="s2">"Word"</span><span class="p">:</span> <span class="s2">"word"</span><span class="p">,</span> <span class="s2">"Tag"</span><span class="p">:</span> <span class="s2">"tag"</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7ccaaa4">
<h3 id="org7ccaaa4">Words and Tags</h3>
<div class="outline-text-3" id="text-org7ccaaa4">
<p>The first thing we're going to do is separate out the words to build our vocabulary. The <code>vocabulary</code> will be a mapping of each word to an index so that we can convert our text to numbers for our model. In addition we're going to add a <code>&lt;PAD&gt;</code> token so that if our input is to short we can pad it to be the right size. And an <code>UNK</code> token in case we don't know a word.</p>
<div class="highlight">
<pre><span></span><span class="n">token</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"pad unknown"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Token</span> <span class="o">=</span> <span class="n">token</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"UNK"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
<span class="n">vocabulary</span><span class="p">[</span><span class="n">Token</span><span class="o">.</span><span class="n">pad</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="n">vocabulary</span><span class="p">[</span><span class="n">Token</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
35,180
</pre>
<p>We're going to do the same with the Tag column.</p>
<div class="highlight">
<pre><span></span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</pre></div>
<pre class="example">
{'O': 0, 'B-geo': 1, 'B-gpe': 2, 'B-per': 3, 'I-geo': 4, 'B-org': 5, 'I-org': 6, 'B-tim': 7, 'B-art': 8, 'I-art': 9, 'I-per': 10, 'I-gpe': 11, 'I-tim': 12, 'B-nat': 13, 'B-eve': 14, 'I-eve': 15, 'I-nat': 16}
</pre>
<p><b>Note:</b> This is actually cheating because I am using the whole dataset. Later on make sure to only use the training data.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org7fc741e">
<h3 id="org7fc741e">Sentences and Labels</h3>
<div class="outline-text-3" id="text-org7fc741e">
<p>We're also going to need to smash the words back into sentences. There's probably a clever pandas way to do this, but I'll just brute-force it. We'll also need to join the labels for the sentences into strings.</p>
<div class="highlight">
<pre><span></span><span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sentence</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pandas</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">sentence</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
47,958
47,958
['Thousands', 'of', 'demonstrators', 'have', 'marched', 'through', 'London', 'to', 'protest', 'the', 'war', 'in', 'Iraq', 'and', 'demand', 'the', 'withdrawal', 'of', 'British', 'troops', 'from', 'that', 'country', '.']
['O', 'O', 'O', 'O', 'O', 'O', 'B-geo', 'O', 'O', 'O', 'O', 'O', 'B-geo', 'O', 'O', 'O', 'O', 'O', 'B-gpe', 'O', 'O', 'O', 'O', 'O']
</pre>
<p>We're going to convert them to numbers so I didn't join them into strings.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org6f257ab">
<h3 id="org6f257ab">To Numbers</h3>
<div class="outline-text-3" id="text-org6f257ab">
<div class="highlight">
<pre><span></span><span class="n">sentence_vectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">Token</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span>
<span class="p">]</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence_vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentence_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 9, 15, 1, 16, 17, 18, 19, 20, 21]
</pre>
<div class="highlight">
<pre><span></span><span class="n">label_vectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sentence_labels</span><span class="p">]</span> <span class="k">for</span> <span class="n">sentence_labels</span> <span class="ow">in</span> <span class="n">labels</span>
<span class="p">]</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
[0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0]
</pre>
<p>In this case we're assuming that there's no unknown tags because they are only used for training and testing so we wouldn't expect to see one that isn't in our current dataset, unlike the sentences which are going to be used with new data and so might have tokens we haven't seen before.</p>
<p>We could add the padding here, but instead we're going to do it in the batch generator.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org61afc1c">
<h3 id="org61afc1c">The Train-Test Split</h3>
<div class="outline-text-3" id="text-org61afc1c">
<p>This time we're going to do a real train-validation-test split.</p>
<div class="highlight">
<pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Split"</span><span class="p">,</span> <span class="s2">"train validation test"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="mi">33570</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="mi">7194</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="mi">7194</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_leftovers</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">sentences</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="n">Split</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
<span class="n">x_validation</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_validation</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_leftovers</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">Split</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">train</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">train</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">validation</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_validation</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">validation</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">test</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">==</span> <span class="n">Split</span><span class="o">.</span><span class="n">test</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga8a1f3a">
<h3 id="orga8a1f3a">Bundling This Up</h3>
<div class="outline-text-3" id="text-orga8a1f3a"></div>
<div class="outline-4" id="outline-container-org32d11ae">
<h4 id="org32d11ae">Imports</h4>
<div class="outline-text-4" id="text-org32d11ae">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org841a937">
<h4 id="org841a937">Some Constants</h4>
<div class="outline-text-4" id="text-org841a937">
<div class="highlight">
<pre><span></span><span class="n">Read</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Read"</span><span class="p">,</span> <span class="s2">"dotenv key encoding"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">READ</span> <span class="o">=</span> <span class="n">Read</span><span class="p">(</span><span class="n">dotenv</span><span class="o">=</span><span class="s2">"posts/nlp/.env"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">"NER_DATASET"</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">"ISO-8859-1"</span><span class="p">)</span>

<span class="n">COLUMNS</span><span class="o">=</span><span class="p">{</span><span class="s2">"Sentence #"</span><span class="p">:</span><span class="s2">"sentence"</span><span class="p">,</span>
         <span class="s2">"Word"</span><span class="p">:</span> <span class="s2">"word"</span><span class="p">,</span>
         <span class="s2">"Tag"</span><span class="p">:</span> <span class="s2">"tag"</span><span class="p">}</span>

<span class="n">Token</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Token"</span><span class="p">,</span> <span class="s2">"pad unknown"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">TOKEN</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"UNK"</span><span class="p">)</span>

<span class="n">Splits</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Split"</span><span class="p">,</span> <span class="s2">"train validation test"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">SPLIT</span> <span class="o">=</span> <span class="n">Splits</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="mi">33570</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="mi">7194</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="mi">7194</span><span class="p">)</span>

<span class="n">DataSets</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"DataSets"</span><span class="p">,</span> <span class="p">[</span>
    <span class="s2">"x_train"</span><span class="p">,</span>
    <span class="s2">"y_train"</span><span class="p">,</span>
    <span class="s2">"x_validate"</span><span class="p">,</span>
    <span class="s2">"y_validate"</span><span class="p">,</span>
    <span class="s2">"x_test"</span><span class="p">,</span>
    <span class="s2">"y_test"</span>
<span class="p">])</span>

<span class="n">TheData</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"TheData"</span><span class="p">,</span> <span class="p">[</span>
    <span class="s2">"vocabulary"</span><span class="p">,</span>
    <span class="s2">"tags"</span><span class="p">,</span>
    <span class="s2">"data_sets"</span><span class="p">,</span>
    <span class="s2">"raw_data_sets"</span><span class="p">,</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org08394b4">
<h4 id="org08394b4">The Data Processor</h4>
<div class="outline-text-4" id="text-org08394b4">
<p>Each of the three sets needs to be vectorized since I'm not saving the sentences beforehand. So this class handles that.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataFlattener</span><span class="p">:</span>
    <span class="sd">"""Converts the kaggle data to sentences and labels</span>

<span class="sd">    Args:</span>
<span class="sd">     data: the data to convert</span>
<span class="sd">    """</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">_sentences</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_labels</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org6d405b6"></a>Sentences<br>
<div class="outline-text-5" id="text-org6d405b6">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""List of sentences from the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sentences_and_labels</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span>
</pre></div>
</div>
</li>
<li><a id="org94592ca"></a>Labels<br>
<div class="outline-text-5" id="text-org94592ca">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""List of labels from the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sentences_and_labels</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>
</pre></div>
</div>
</li>
<li><a id="org99a4839"></a>Sentences and Labels maker<br>
<div class="outline-text-5" id="text-org99a4839">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">set_sentences_and_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Converts the data to lists</span>
<span class="sd">    of sentence token lists and also sets the labels</span>
<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pandas</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">sentence</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">sentence</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org6e1a362">
<h4 id="org6e1a362">Data Vectorizer</h4>
<div class="outline-text-4" id="text-org6e1a362">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataVectorizer</span><span class="p">:</span>
    <span class="sd">"""Converts the data-set strings to vectors</span>

<span class="sd">    Args:</span>
<span class="sd">     data_sets: the split up data sets</span>
<span class="sd">     vocabulary: map from token to index</span>
<span class="sd">     tags: map from tag to index</span>
<span class="sd">    """</span>
    <span class="n">data_sets</span><span class="p">:</span> <span class="n">namedtuple</span>
    <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">_vectorized_datasets</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org82ac5d9"></a>Vectorized Data Sets<br>
<div class="outline-text-5" id="text-org82ac5d9">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vectorized_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""the original data sets converted to indices"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sentence_vectors</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_vectors</span><span class="p">,</span>
                                   <span class="n">to_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
        <span class="n">label_vectors</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_vectors</span><span class="p">,</span>
                                <span class="n">to_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span>
            <span class="n">x_train</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">),</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_train</span><span class="p">),</span>
            <span class="n">x_validate</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">),</span>
            <span class="n">y_validate</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_validate</span><span class="p">),</span>
            <span class="n">x_test</span> <span class="o">=</span> <span class="n">sentence_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">),</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">label_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">y_test</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorized_datasets</span>
</pre></div>
</div>
</li>
<li><a id="org53c7fc4"></a>Sentence Vectors<br>
<div class="outline-text-5" id="text-org53c7fc4">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">to_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">to_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Sentences converted to Integers</span>

<span class="sd">    Args:</span>
<span class="sd">     source: iterator of tokenized strings to convert</span>
<span class="sd">     to_index: map to convert the tokens to indices</span>

<span class="sd">    Returns:</span>
<span class="sd">     tokens in source converted to indices</span>
<span class="sd">    """</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span>
        <span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vectors</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org23fac43">
<h4 id="org23fac43">The Splitter</h4>
<div class="outline-text-4" id="text-org23fac43">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataSplitter</span><span class="p">:</span>
    <span class="sd">"""Splits up the training, testing, etc.</span>

<span class="sd">    Args:</span>
<span class="sd">     split: constants with the train, test counts</span>
<span class="sd">     sentences: input data to split</span>
<span class="sd">     labels: y-data to split</span>
<span class="sd">     random_state: seed for the splitting</span>
<span class="sd">    """</span>
    <span class="n">split</span><span class="p">:</span> <span class="n">namedtuple</span>
    <span class="n">sentences</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span>    
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_data_sets</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgc92ea2a"></a>Data Sets<br>
<div class="outline-text-5" id="text-orgc92ea2a">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""The Split data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">x_leftovers</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_leftovers</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">train_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">train</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">x_validate</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">x_leftovers</span><span class="p">,</span>
            <span class="n">y_leftovers</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">test</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span> <span class="o">=</span> <span class="n">DataSets</span><span class="p">(</span><span class="n">x_train</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span>
                                   <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                                   <span class="n">x_validate</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                                   <span class="n">y_validate</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span>
                                   <span class="n">x_test</span><span class="o">=</span><span class="n">x_test</span><span class="p">,</span>
                                   <span class="n">y_test</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
                                   <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_sets</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org95151bd">
<h4 id="org95151bd">The Loader</h4>
<div class="outline-text-4" id="text-org95151bd">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sd">"""Loads and converts the kaggle data</span>

<span class="sd">    Args:</span>
<span class="sd">      read: the stuff to download the data</span>
<span class="sd">    """</span>
    <span class="n">read</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">READ</span>    
    <span class="n">_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tags</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org5548e30"></a>The Kaggle Data<br>
<div class="outline-text-5" id="text-org5548e30">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">"""The original kaggle dataset"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">load_dotenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">dotenv</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">COLUMNS</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</li>
<li><a id="orgb36bd32"></a>The Vocabulary<br>
<div class="outline-text-5" id="text-orgb36bd32">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""map of word to index</span>

<span class="sd">    Note:</span>
<span class="sd">      This is creating a transformation of the entire data-set</span>
<span class="sd">    so it comes before the train-test-split so it uses the whole</span>
<span class="sd">    dataset, not just training</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">word</span><span class="p">:</span> <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">pad</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</li>
<li><a id="org1295804"></a>The Tags<br>
<div class="outline-text-5" id="text-org1295804">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""map of tag to index"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">[</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">unknown</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgbde1cbd">
<h4 id="orgbde1cbd">The Processor</h4>
<div class="outline-text-4" id="text-orgbde1cbd">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">NERData</span><span class="p">:</span>
    <span class="sd">"""Master NER Data preparer</span>

<span class="sd">    Args:</span>
<span class="sd">     read_constants: stuff to help load the dataset</span>
<span class="sd">     split_constants: stuff to help split the dataset</span>
<span class="sd">     random_state: seed for the splitting</span>
<span class="sd">    """</span>
    <span class="n">read_constants</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">READ</span>
    <span class="n">split_constants</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="n">SPLIT</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">33</span>
    <span class="n">_data</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_loader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_flattener</span><span class="p">:</span> <span class="n">DataFlattener</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_splitter</span><span class="p">:</span> <span class="n">DataSplitter</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vectorizer</span> <span class="o">=</span> <span class="n">DataVectorizer</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgaa2b53c"></a>The Data<br>
<div class="outline-text-5" id="text-orgaa2b53c">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""The split up data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">TheData</span><span class="p">(</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">raw_data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">data_sets</span><span class="p">,</span>
            <span class="n">data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">vectorized_datasets</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</li>
<li><a id="org55efb26"></a>The Loader<br>
<div class="outline-text-5" id="text-org55efb26">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">loader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
    <span class="sd">"""The loader of the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">read</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_constants</span><span class="p">,</span>            
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span>
</pre></div>
</div>
</li>
<li><a id="org93954cb"></a>The Flattener<br>
<div class="outline-text-5" id="text-org93954cb">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">flattener</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFlattener</span><span class="p">:</span>
    <span class="sd">"""The sentence and label builder"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span> <span class="o">=</span> <span class="n">DataFlattener</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flattener</span>
</pre></div>
</div>
</li>
<li><a id="org22ae9fb"></a>The Splitter<br>
<div class="outline-text-5" id="text-org22ae9fb">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataSplitter</span><span class="p">:</span>
    <span class="sd">"""The splitter upper for the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span> <span class="o">=</span> <span class="n">DataSplitter</span><span class="p">(</span>
            <span class="n">split</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_constants</span><span class="p">,</span>
            <span class="n">sentences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattener</span><span class="o">.</span><span class="n">sentences</span><span class="p">,</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattener</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitter</span>
</pre></div>
</div>
</li>
<li><a id="org311b951"></a>The Vectorizer<br>
<div class="outline-text-5" id="text-org311b951">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vectorizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataVectorizer</span><span class="p">:</span>
    <span class="sd">"""Vectorizes the raw-data sets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span> <span class="o">=</span> <span class="n">DataVectorizer</span><span class="p">(</span>
            <span class="n">data_sets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">data_sets</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectorizer</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org7440e8b">
<h4 id="org7440e8b">Testing It Out</h4>
<div class="outline-text-4" id="text-org7440e8b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.named_entity_recognition</span> <span class="kn">import</span> <span class="n">NERData</span>

<span class="n">ner</span> <span class="o">=</span> <span class="n">NERData</span><span class="p">()</span>

<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_train</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">train</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_validate</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">validation</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_sets</span><span class="o">.</span><span class="n">x_test</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">Split</span><span class="o">.</span><span class="n">test</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/rnns-and-vanishing-gradients/">RNNS and Vanishing Gradients</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/rnns-and-vanishing-gradients/" rel="bookmark"><time class="published dt-published" datetime="2021-01-10T18:52:32-08:00" itemprop="datePublished" title="2021-01-10 18:52">2021-01-10 18:52</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org98a7cf2">Vanishing Gradients</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orga1e80e2">Background</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org44f3412">Imports</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orge680ed3">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org3833fe2">Middle</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org0148401">The Data</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orga46f84d">The Sigmoid</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orgbaef3e9">The Gradient</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org14c2b17">Plotting the Sigmoid</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orgf62b2cf">The Numerical Impact</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org0e5c5cf">Multiplication & Decay</a></li>
</ul>
</li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org3c4f499">A Decay Simulation</a>
<ul>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org2fc8f45">Input data</a></li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#orgad5ea92">Plot The Decay</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/rnns-and-vanishing-gradients/#org90ef4ee">So, How Do You Fix This?</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org98a7cf2">
<h2 id="org98a7cf2">Vanishing Gradients</h2>
<div class="outline-text-2" id="text-org98a7cf2">
<p>This will be a look at the problem of vanishing gradients from an intuitive standpoint.</p>
</div>
<div class="outline-3" id="outline-container-orga1e80e2">
<h3 id="orga1e80e2">Background</h3>
<div class="outline-text-3" id="text-orga1e80e2">
<p>Adding layers to a neural network introduces multiplicative effects in both forward and backward propagation. The back-prop in particular presents a problem as the gradient of activation functions can be very small. Multiplied together across many layers, their product can be vanishingly small. This results in weights not being updated in the front layers and training not progressing.</p>
<p>Gradients of the sigmoid function, for example, are in the range 0 to 0.25. To calculate gradients for the front layers of a neural network the chain rule is used. This means that these tiny values are multiplied starting at the last layer, working backwards to the first layer, with the gradients shrinking exponentially at each step.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org44f3412">
<h3 id="org44f3412">Imports</h3>
<div class="outline-text-3" id="text-org44f3412">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># another project</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orge680ed3">
<h3 id="orge680ed3">Set Up</h3>
<div class="outline-text-3" id="text-orge680ed3">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"rnns-and-vanishing-gradients"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Plot"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"width"</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">,</span> <span class="s2">"fontscale"</span><span class="p">,</span> <span class="s2">"tan"</span><span class="p">,</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">])</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3833fe2">
<h2 id="org3833fe2">Middle</h2>
<div class="outline-text-2" id="text-org3833fe2"></div>
<div class="outline-3" id="outline-container-org0148401">
<h3 id="org0148401">The Data</h3>
<div class="outline-text-3" id="text-org0148401">
<p>This will be an evenly spaced set of points over an interval (see <a href="https://numpy.org/doc/stable/reference/generated/numpy.linspace.html">numpy.linspace</a>).</p>
<div class="highlight">
<pre><span></span><span class="n">STOP</span><span class="p">,</span> <span class="n">STEPS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">STOP</span><span class="p">,</span> <span class="n">STOP</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga46f84d">
<h3 id="orga46f84d">The Sigmoid</h3>
<div class="outline-text-3" id="text-orga46f84d">
<p>Our activation function will be the <a href="https://en.wikipedia.org/wiki/Sigmoid_function">sigmoid (wikipedia link)</a> (well, the logistic function).</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
</pre></div>
<p>Now we'll calculate the activations for our input data.</p>
<div class="highlight">
<pre><span></span><span class="n">activations</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbaef3e9">
<h3 id="orgbaef3e9">The Gradient</h3>
<div class="outline-text-3" id="text-orgbaef3e9">
<p>Our gradient is the derivative of the sigmoid.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">gradient</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
<p>Now we can get the gradients for our activations.</p>
<div class="highlight">
<pre><span></span><span class="n">gradients</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">activations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org14c2b17">
<h3 id="org14c2b17">Plotting the Sigmoid</h3>
<div class="outline-text-3" id="text-org14c2b17">
<div class="highlight">
<pre><span></span><span class="n">tangent_x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">tangent_y</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">tangent_x</span><span class="p">)</span>
<span class="n">span</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">gradient_tangent</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tangent_x</span><span class="p">))</span>

<span class="n">tangent_plot_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tangent_x</span> <span class="o">-</span> <span class="n">span</span><span class="p">,</span> <span class="n">tangent_x</span> <span class="o">+</span> <span class="n">span</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">)</span>
<span class="n">tangent_plot_y</span> <span class="o">=</span> <span class="n">tangent_y</span> <span class="o">+</span> <span class="n">gradient_tangent</span> <span class="o">*</span> <span class="p">(</span><span class="n">tangent_plot_x</span> <span class="o">-</span> <span class="n">tangent_x</span><span class="p">)</span>

<span class="n">frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">"X"</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
     <span class="s2">"Sigmoid"</span><span class="p">:</span> <span class="n">activations</span><span class="p">,</span>
     <span class="s2">"X-Tangent"</span><span class="p">:</span> <span class="n">tangent_plot_x</span><span class="p">,</span>
     <span class="s2">"Y-Tangent"</span><span class="p">:</span> <span class="n">tangent_plot_y</span><span class="p">,</span>
     <span class="s2">"Gradient"</span><span class="p">:</span> <span class="n">gradients</span><span class="p">})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Sigmoid"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">blue</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Gradient"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X-Tangent"</span><span class="p">,</span>
                       <span class="n">y</span><span class="o">=</span><span class="s2">"Y-Tangent"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">tan</span><span class="p">))</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">"Sigmoid and Tangent"</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"sigmoid_tangent"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/rnns-and-vanishing-gradients/sigmoid_tangent.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The thing to notice is that as the input data moves away from the center (at 0) the gradients get smaller in either direction, rapidly approaching zero.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgf62b2cf">
<h3 id="orgf62b2cf">The Numerical Impact</h3>
<div class="outline-text-3" id="text-orgf62b2cf"></div>
<div class="outline-4" id="outline-container-org0e5c5cf">
<h4 id="org0e5c5cf">Multiplication & Decay</h4>
<div class="outline-text-4" id="text-org0e5c5cf">
<p>Multiplying numbers smaller than 1 results in smaller and smaller numbers. Below is an example that finds the gradient for an input <i>x = 0</i> and multiplies it over n steps. Look how quickly it 'Vanishes' to almost zero. Yet \(\sigma(x=0) \implies 0.5\) which has a sigmoid gradient of 0.25 and that happens to be the largest sigmoid gradient possible.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org3c4f499">
<h3 id="org3c4f499">A Decay Simulation</h3>
<div class="outline-text-3" id="text-org3c4f499"></div>
<div class="outline-4" id="outline-container-org2fc8f45">
<h4 id="org2fc8f45">Input data</h4>
<div class="outline-text-4" id="text-org2fc8f45">
<div class="highlight">
<pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">gradients</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">steps</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"steps :"</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x value :"</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"sigmoid :"</span><span class="p">,</span> <span class="s2">"</span><span class="si">{:.5f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"gradient :"</span><span class="p">,</span> <span class="s2">"</span><span class="si">{:.5f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
steps : 6
x value : 0
sigmoid : 0.50000
gradient : 0.25000 

</pre></div>
</div>
<div class="outline-4" id="outline-container-orgad5ea92">
<h4 id="orgad5ea92">Plot The Decay</h4>
<div class="outline-text-4" id="text-orgad5ea92">
<div class="highlight">
<pre><span></span><span class="n">decaying_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">Step</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">Gradient</span><span class="o">=</span><span class="n">decaying_values</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Step"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Gradient"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Cumulative Gradient"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">PLOT</span><span class="o">.</span><span class="n">fontscale</span>
<span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"cumulative_gradient"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/rnns-and-vanishing-gradients/cumulative_gradient.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The point being that the gradients very quickly approach zero.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org90ef4ee">
<h2 id="org90ef4ee">So, How Do You Fix This?</h2>
<div class="outline-text-2" id="text-org90ef4ee">
<p>One solution is to use activation functions that don't have tiny gradients. Other solutions involve more sophisticated model design. But they're both discussions for another time.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-batch-generation/">Deep N-Grams: Batch Generation</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-batch-generation/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T17:08:48-08:00" itemprop="datePublished" title="2021-01-05 17:08">2021-01-05 17:08</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org67639f2">Generating Batches of Data</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgcd7fbef">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgcf37b1f">Set Up</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orge853a38">The DataLoader</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgd51095e">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgc605390">The Data Generator</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org2c31dd6">Implementing the Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org5607861">Try out the data generator.</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org5b5e2ce">Repeating Batch generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org80b75c2">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org62a8cd5">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgc81ef1f">Data Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgfc1131b">Line Count</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgdecc87c">Line Indices</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org3a93ee0">The Iterator Method</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#orgc308787">The Batch Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org5d1980c">The Generator</a></li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org1f7b07e">The Next Method</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-batch-generation/#org0c4fb77">Try It Out</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org67639f2">
<h2 id="org67639f2">Generating Batches of Data</h2>
<div class="outline-text-2" id="text-org67639f2">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">First Post</a></li>
<li><a href="posts/nlp/deep-n-grams-loading-the-data/">Previous Post</a></li>
<li><a href="posts/nlp/deep-n-grams-creating-the-model/">Next Post</a></li>
</ul>
<p>Most of the time in Natural Language Processing, and AI in general we use batches when training our data sets. Here, you will build a data generator that takes in a text and returns a batch of text lines (lines are sentences).</p>
<ul class="org-ul">
<li>The generator converts text lines (sentences) into numpy arrays of integers padded by zeros so that all arrays have the same length, which is the length of the longest sentence in the entire data set.</li>
</ul>
<p>This generator returns the data in a format that you could directly use in your model when computing the feed-forward pass of your algorithm. This iterator returns a batch of lines and a per-token mask. The batch is a tuple of three parts: inputs, targets, and mask. The inputs and targets are identical. The second column will be used to evaluate your predictions. Mask is 1 for non-padding tokens.</p>
</div>
<div class="outline-3" id="outline-container-orgcd7fbef">
<h3 id="orgcd7fbef">Imports</h3>
<div class="outline-text-3" id="text-orgcd7fbef">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">be_true</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn.data_loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgcf37b1f">
<h3 id="orgcf37b1f">Set Up</h3>
<div class="outline-text-3" id="text-orgcf37b1f"></div>
<div class="outline-4" id="outline-container-orge853a38">
<h4 id="orge853a38">The DataLoader</h4>
<div class="outline-text-4" id="text-orge853a38">
<div class="highlight">
<pre><span></span><span class="n">data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd51095e">
<h2 id="orgd51095e">Middle</h2>
<div class="outline-text-2" id="text-orgd51095e"></div>
<div class="outline-3" id="outline-container-orgc605390">
<h3 id="orgc605390">The Data Generator</h3>
<div class="outline-text-3" id="text-orgc605390">
<ul class="org-ul">
<li>While True loop: this will yield one batch at a time.</li>
<li>if index &gt;= num_lines, set index to 0.</li>
<li>The generator should return shuffled batches of data. To achieve this without modifying the actual lines a list containing the indexes of data_lines` is created. This list can be shuffled and used to get random batches everytime the index is reset.</li>
<li>if len(line) &lt; max_length append line to cur_batch.
<ul class="org-ul">
<li>Note that a line that has length equal to max_length should not be appended to the batch.</li>
<li>This is because when converting the characters into a tensor of integers, an additional end of sentence token id will be added.</li>
<li>So if max_length is 5, and a line has 4 characters, the tensor representing those 4 characters plus the end of sentence character will be f length 5, which is the max length.</li>
</ul>
</li>
<li>if len(cur_batch) == batch_size, go over every line, convert it to an int and store it.</li>
</ul>
<p><b>Remember that when calling np you are really calling trax.fastmath.numpy which is traxâ€™s version of numpy that is compatible with JAX. As a result of this, where you used to encounter the type numpy.ndarray now you will find the type jax.interpreters.xla.DeviceArray.</b></p>
<p><b>Hints:</b></p>
<ul class="org-ul">
<li>Use the line_to_tensor function above inside a list comprehension in order to pad lines with zeros.</li>
<li>Keep in mind that the length of the tensor is always 1 + the length of the original line of characters. Keep this in mind when setting the padding of zeros.</li>
</ul>
<p>To get it to pass you'll have to pass in the <code>to-tensor</code> method of the <code>DataLoader</code> so we'll need to alias it to match their definition.</p>
<div class="highlight">
<pre><span></span><span class="n">line_to_tensor</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">to_tensor</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org2c31dd6">
<h4 id="org2c31dd6">Implementing the Generator</h4>
<div class="outline-text-4" id="text-org2c31dd6">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                   <span class="n">line_to_tensor</span><span class="o">=</span><span class="n">line_to_tensor</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Generator function that yields batches of data</span>

<span class="sd">    Args:</span>
<span class="sd">       batch_size (int): number of examples (in this case, sentences) per batch.</span>
<span class="sd">       max_length (int): maximum length of the output tensor.</span>
<span class="sd">       NOTE: max_length includes the end-of-sentence character that will be added</span>
<span class="sd">               to the tensor.  </span>
<span class="sd">               Keep in mind that the length of the tensor is always 1 + the length</span>
<span class="sd">               of the original line of characters.</span>
<span class="sd">       data_lines (list): list of the sentences to group into batches.</span>
<span class="sd">       line_to_tensor (function, optional): function that converts line to tensor. Defaults to line_to_tensor.</span>
<span class="sd">       shuffle (bool, optional): True if the generator should generate random batches of data. Defaults to True.</span>

<span class="sd">    Yields:</span>
<span class="sd">       tuple: two copies of the batch (jax.interpreters.xla.DeviceArray) and mask (jax.interpreters.xla.DeviceArray).</span>
<span class="sd">       NOTE: jax.interpreters.xla.DeviceArray is trax's version of numpy.ndarray</span>
<span class="sd">    """</span>
    <span class="c1"># initialize the index that points to the current position in the lines index array</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># initialize the list that will contain the current batch</span>
    <span class="n">cur_batch</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># count the number of lines in data_lines</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_lines</span><span class="p">)</span>

    <span class="c1"># create an array with the indexes of data_lines that can be shuffled</span>
    <span class="n">lines_index</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">)]</span>

    <span class="c1"># shuffle line indexes if shuffle is set to True</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># if the index is greater or equal than to the number of lines in data_lines</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">num_lines</span><span class="p">:</span>
            <span class="c1"># then reset the index to 0</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># shuffle line indexes if shuffle is set to True</span>
            <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines_index</span><span class="p">)</span>

        <span class="c1"># get a line at the `lines_index[index]` position in data_lines</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">data_lines</span><span class="p">[</span><span class="n">lines_index</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>

        <span class="c1"># if the length of the line is less than max_length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
            <span class="c1"># append the line to the current batch</span>
            <span class="n">cur_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># increment the index by one</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># if the current batch is now equal to the desired batch size</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_batch</span><span class="p">)</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">:</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># go through each line (li) in cur_batch</span>
            <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">cur_batch</span><span class="p">:</span>
                <span class="c1"># convert the line (li) to a tensor of integers</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="n">line_to_tensor</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>

                <span class="c1"># Create a list of zeros to represent the padding</span>
                <span class="c1"># so that the tensor plus padding will have length `max_length`</span>
                <span class="n">pad</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>

                <span class="c1"># combine the tensor plus pad</span>
                <span class="n">tensor_pad</span> <span class="o">=</span> <span class="n">tensor</span> <span class="o">+</span> <span class="n">pad</span>

                <span class="c1"># append the padded tensor to the batch</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor_pad</span><span class="p">)</span>

                <span class="c1"># A mask for  tensor_pad is 1 wherever tensor_pad is not</span>
                <span class="c1"># 0 and 0 wherever tensor_pad is 0, i.e. if tensor_pad is</span>
                <span class="c1"># [1, 2, 3, 0, 0, 0] then example_mask should be</span>
                <span class="c1"># [1, 1, 1, 0, 0, 0]</span>
                <span class="c1"># Hint: Use a list comprehension for this</span>
                <span class="n">example_mask</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tensor_pad</span><span class="p">]</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_mask</span><span class="p">)</span>

            <span class="c1"># convert the batch (data type list) to a trax's numpy array</span>
            <span class="n">batch_np_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">mask_np_arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

            <span class="c1">### END CODE HERE ##</span>

            <span class="c1"># Yield two copies of the batch and mask.</span>
            <span class="k">yield</span> <span class="n">batch_np_arr</span><span class="p">,</span> <span class="n">batch_np_arr</span><span class="p">,</span> <span class="n">mask_np_arr</span>

            <span class="c1"># reset the current batch to an empty list</span>
            <span class="n">cur_batch</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5607861">
<h4 id="org5607861">Try out the data generator.</h4>
<div class="outline-text-4" id="text-org5607861">
<div class="highlight">
<pre><span></span><span class="n">tmp_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'12345678901'</span><span class="p">,</span>
             <span class="s1">'123456789'</span><span class="p">,</span>
             <span class="s1">'234567890'</span><span class="p">,</span>
             <span class="s1">'345678901'</span><span class="p">]</span>
</pre></div>
<p>Create a generator with a batch size of 2 and a maximum length of 10.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_data_gen</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                              <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                              <span class="n">data_lines</span><span class="o">=</span><span class="n">tmp_lines</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<p>Get one batch.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_data_gen</span><span class="p">)</span>
</pre></div>
<p>View the batch.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">):</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">bool</span><span class="p">((</span><span class="n">batch</span><span class="o">==</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
(DeviceArray([[49, 50, 51, 52, 53, 54, 55, 56, 57,  1],
             [50, 51, 52, 53, 54, 55, 56, 57, 48,  1]], dtype=int32), DeviceArray([[49, 50, 51, 52, 53, 54, 55, 56, 57,  1],
             [50, 51, 52, 53, 54, 55, 56, 57, 48,  1]], dtype=int32), DeviceArray([[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
             [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]], dtype=int32))
</pre>
<p>Now that you have your generator, you can just call them and they will return tensors which correspond to your lines in Shakespeare. The first column and the second column are identical. Now you can go ahead and start building your neural network.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org5b5e2ce">
<h3 id="org5b5e2ce">Repeating Batch generator</h3>
<div class="outline-text-3" id="text-org5b5e2ce">
<p>The way the iterator is currently defined, it will keep providing batches forever.</p>
<p>Although it is not needed, we want to show you the <code>itertools.cycle</code> function which is really useful when you have a generator that eventually stops.</p>
<p>Usually we want to cycle over the dataset multiple times during training (i.e. train for multiple <b>epochs</b>).</p>
<p>For small datasets we can use <a href="https://docs.python.org/3.8/library/itertools.html#itertools.cycle"><code>itertools.cycle</code></a> to achieve this easily.</p>
<div class="highlight">
<pre><span></span><span class="n">infinite_data_generator</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span>
    <span class="n">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">data_lines</span><span class="o">=</span><span class="n">tmp_lines</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">ten_lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">infinite_data_generator</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ten_lines</span><span class="p">))</span>
</pre></div>
<pre class="example">
10
</pre></div>
</div>
<div class="outline-3" id="outline-container-org80b75c2">
<h3 id="org80b75c2">Bundle It Up</h3>
<div class="outline-text-3" id="text-org80b75c2">
<p>As always, since this is going to be needed further down the road, I'll bundle it up.</p>
</div>
<div class="outline-4" id="outline-container-org62a8cd5">
<h4 id="org62a8cd5">Imports</h4>
<div class="outline-text-4" id="text-org62a8cd5">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn.data_loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc81ef1f">
<h4 id="orgc81ef1f">Data Generator</h4>
<div class="outline-text-4" id="text-orgc81ef1f">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">:</span>
    <span class="sd">"""Generates batches</span>

<span class="sd">    Args:</span>
<span class="sd">     data: lines of data</span>
<span class="sd">     data_loader: something with to-tensor method</span>
<span class="sd">     batch_size: size of the batches</span>
<span class="sd">     max_length: the maximum length for a line (longer lines will be ignored)</span>
<span class="sd">     shuffle: whether to shuffle the data</span>
<span class="sd">    """</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">data_loader</span><span class="p">:</span> <span class="n">DataLoader</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">_line_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">_line_indices</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_generator</span><span class="p">:</span> <span class="nb">object</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfc1131b">
<h4 id="orgfc1131b">Line Count</h4>
<div class="outline-text-4" id="text-orgfc1131b">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">line_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Number of lines in the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_count</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdecc87c">
<h4 id="orgdecc87c">Line Indices</h4>
<div class="outline-text-4" id="text-orgdecc87c">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">line_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Indices of the lines in the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_count</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3a93ee0">
<h4 id="org3a93ee0">The Iterator Method</h4>
<div class="outline-text-4" id="text-org3a93ee0">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""A pass-through for this method"""</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc308787">
<h4 id="orgc308787">The Batch Generator</h4>
<div class="outline-text-4" id="text-orgc308787">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Generator method that yields batches of data</span>

<span class="sd">    Yields:</span>
<span class="sd">     (batch, batch, mask)</span>
<span class="sd">    """</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_indices</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_count</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_line_indices</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
            <span class="n">current_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_batch</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">current_batch</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">tensor</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tensor</span><span class="p">])</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">current_batch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5d1980c">
<h4 id="org5d1980c">The Generator</h4>
<div class="outline-text-4" id="text-org5d1980c">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Infinite generator of batches"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1f7b07e">
<h4 id="org1f7b07e">The Next Method</h4>
<div class="outline-text-4" id="text-org1f7b07e">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""make this an iterator"""</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org0c4fb77">
<h3 id="org0c4fb77">Try It Out</h3>
<div class="outline-text-3" id="text-org0c4fb77">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">DataGenerator</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
<span class="n">test_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'12345678901'</span><span class="p">,</span>
              <span class="s1">'123456789'</span><span class="p">,</span>
              <span class="s1">'234567890'</span><span class="p">,</span>
              <span class="s1">'345678901'</span><span class="p">]</span>

<span class="n">generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">test_lines</span><span class="p">,</span>
                          <span class="n">data_loader</span><span class="o">=</span><span class="n">loader</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">actual</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="nb">bool</span><span class="p">((</span><span class="n">batch</span><span class="o">==</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/deep-n-grams-generating-sentences/">Deep N-Grams: Generating Sentences</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/deep-n-grams-generating-sentences/" rel="bookmark"><time class="published dt-published" datetime="2021-01-05T16:49:26-08:00" itemprop="datePublished" title="2021-01-05 16:49">2021-01-05 16:49</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#orgaec32e3">Generating New Sentences</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org16eebf2">Imports</a></li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org935d244">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#orgba3abb9">Middle</a>
<ul>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org1690989">The Gumbel Sample</a></li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org4653cab">A Predictor</a></li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org0e0bc78">Some Predictions</a></li>
</ul>
</li>
<li><a href="posts/nlp/deep-n-grams-generating-sentences/#org8f78caf">On statistical methods</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgaec32e3">
<h2 id="orgaec32e3">Generating New Sentences</h2>
<div class="outline-text-2" id="text-orgaec32e3">
<ul class="org-ul">
<li><a href="posts/nlp/deep-n-grams/">First Post</a></li>
<li><a href="posts/nlp/deep-n-grams-evaluating-the-model/">Previous Post</a></li>
</ul>
<p>Now we'll use the language model to generate new sentences for that we need to make draws from a <a href="https://en.wikipedia.org/wiki/Gumbel_distribution">Gumble distribution</a>.</p>
<p>The Gumbel Probability Density Function (PDF) is defined as: \[ f(z) = {1\over{\beta}}e^{\left(-z+e^{(-z)}\right)} \]</p>
<p>Where: \[ z = {(x - \mu)\over{\beta}} \]</p>
<p>The maximum value is what we choose as the prediction in the last step of a Recursive Neural Network <code>RNN</code> we are using for text generation. A sample of a random variable from an exponential distribution approaches the Gumbel distribution when the sample increases asymptotically. For that reason, the Gumbel distribution is used to sample from a categorical distribution.</p>
</div>
<div class="outline-3" id="outline-container-org16eebf2">
<h3 id="org16eebf2">Imports</h3>
<div class="outline-text-3" id="text-org16eebf2">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># from pypi</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.deep_rnn</span> <span class="kn">import</span> <span class="n">GRUModel</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org935d244">
<h3 id="org935d244">Set Up</h3>
<div class="outline-text-3" id="text-org935d244">
<div class="highlight">
<pre><span></span><span class="n">gru</span> <span class="o">=</span> <span class="n">GRUModel</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">model</span>
<span class="n">ours</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/gru-shakespeare-model/model.pkl.gz"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">init_from_file</span><span class="p">(</span><span class="n">ours</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgba3abb9">
<h2 id="orgba3abb9">Middle</h2>
<div class="outline-text-2" id="text-orgba3abb9"></div>
<div class="outline-3" id="outline-container-org1690989">
<h3 id="org1690989">The Gumbel Sample</h3>
<div class="outline-text-3" id="text-org1690989">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">gumbel_sample</span><span class="p">(</span><span class="n">log_probabilities</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                  <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Gumbel sampling from a categorical distribution</span>

<span class="sd">    Args:</span>
<span class="sd">     log_probabilities: model predictions for a given input</span>
<span class="sd">     temperature: fudge</span>

<span class="sd">    Returns:</span>
<span class="sd">     the maximum sample</span>
<span class="sd">    """</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span>
                             <span class="n">size</span><span class="o">=</span><span class="n">log_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">log_probabilities</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org4653cab">
<h3 id="org4653cab">A Predictor</h3>
<div class="outline-text-3" id="text-org4653cab">
<div class="highlight">
<pre><span></span><span class="n">END_OF_SENTENCE</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">number_of_characters</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">break_on</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">END_OF_SENTENCE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">"""Predicts characters</span>

<span class="sd">    Args:</span>
<span class="sd">     number_of_characters: how many characters to predict</span>
<span class="sd">     prefix: character to prompt the predictions</span>
<span class="sd">     break_on: identifier for character to prematurely stop on</span>

<span class="sd">    Returns:</span>
<span class="sd">     prefix followed by predicted characters</span>
<span class="sd">    """</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">character</span><span class="p">)</span> <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">maximum_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="n">number_of_characters</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_characters</span><span class="p">):</span>
        <span class="n">current_inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inputs</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">maximum_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">current_inputs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># Add batch dim.</span>
        <span class="n">next_character</span> <span class="o">=</span> <span class="n">gumbel_sample</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)])</span>
        <span class="n">inputs</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">next_character</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">break_on</span><span class="p">:</span>
            <span class="k">break</span>  <span class="c1"># EOS</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">next_character</span><span class="p">)))</span>

    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0e0bc78">
<h3 id="org0e0bc78">Some Predictions</h3>
<div class="outline-text-3" id="text-org0e0bc78">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
</pre></div>
<pre class="example">
you would not live at essenomed 
</pre>
<p>Yes, but I don't know anyone who would. Note that we are using a random sample, so repeatedly making predictions won't necessarily get you the same result.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
</pre></div>
<pre class="example">
[exeunt]
katharine       yes, you are like the 
le beau where's some of my prett
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="s2">"falstaff"</span><span class="p">))</span>
</pre></div>
<pre class="example">
falstaff        yea, marry, lady, she hath bianced three months.
</pre>
<p><i>bianced</i>?</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="s2">"beast"</span><span class="p">))</span>
</pre></div>
<pre class="example">
beastly, and god forbid, sir! our revenue's cannon,
</pre>
<div class="highlight">
<pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="s2">"finger"</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</pre></div>
<pre class="example">
finger, iago, an
finger, iago, and ask.
finger, iago, and ask.
finger, iago, and ask.
finger, iago, and ask.
</pre>
<p>So, if you feed it enough text, it becomes more deterministic.</p>
<div class="highlight">
<pre><span></span><span class="n">SPACE</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="s2">"iago"</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">start</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>    
</pre></div>
<pre class="example">
iago your husband if there never for you need no never
</pre>
<p>In the generated text above, you can see that the model generates text that makes sense capturing dependencies between words and without any input. A simple n-gram model would have not been able to capture all of that in one sentence.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8f78caf">
<h2 id="org8f78caf">On statistical methods</h2>
<div class="outline-text-2" id="text-org8f78caf">
<p>Using a statistical method will not give you results that are as good. The model would not be able to encode information seen previously in the data set and as a result, the perplexity will increase. The higher the perplexity, the worse your model is. Furthermore, statistical N-Gram models take up too much space and memory. As a result, it would be inefficient and too slow. Conversely, with deep neural networks, you can get a better perplexity. Note though, that learning about n-gram language models is still important and leads to a better understanding of deep neural networks.</p>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="next"><a href="index-18.html" rel="next">Older posts</a></li>
</ul>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script><!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
