<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/" rel="canonical">
<link href="index-16.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
<link href="posts/tensorflow-docker-setup/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item active"><a class="nav-link" href=".">Cloistered Monkey <span class="sr-only">(active)</span></a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/tensorflow-docker-setup/">Tensorflow Docker Setup</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/tensorflow-docker-setup/" rel="bookmark"><time class="published dt-published" datetime="2020-12-27T14:12:26-08:00" itemprop="datePublished" title="2020-12-27 14:12">2020-12-27 14:12</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/tensorflow-docker-setup/#org92e165a">Beginning</a></li>
<li><a href="posts/tensorflow-docker-setup/#orgfabe317">Setting Up</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org92e165a">
<h2 id="org92e165a">Beginning</h2>
<div class="outline-text-2" id="text-org92e165a">
<p>I recently re-started using tensorflow and the python interpreter kept crashing. It appears that they compiled the latest version to require <a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions#Advanced_Vector_Extensions_2">AVX2</a> and the server I was using has <a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions#Advanced_Vector_Extensions_2">AVX</a> but not AVX2. I couldn't find any documentation about this requirement, but running the code on a different machine that has both AVX and AVX2 got rid of the problem. This might be a transient problem, as the nightly build doesn't crash on either machine, but trying to run the nightly build with other code is a nightmare as it seems that every framework related to tensorflow tries to revert the version back to the broken one, so I gave up and changed machines. The process of setting up cuda and tensorflow over and over again proved difficult, as there's different ways to do it (through apt, using nvidia installers, building from source) and each presents a different problem. The version apt installs, for instance puts the folders in places the tensorflow <code>configure.py</code> file can't figure out (if you build tensorflow from source) and using the nvidia debian package for cudnn left my packages in a broken state, as it was trying to install something that then broke another packages requirements… Anyway, I'm going to try and avoid building tensorflow from source and run everything from docker containers.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgfabe317">
<h2 id="orgfabe317">Setting Up</h2>
<div class="outline-text-2" id="text-orgfabe317">
<p>I don't know for sure that this is necessary, but I followed <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker">nvidia's docker installation</a> instructions. If nothing else you can use it to check that the setup works. After that I setup tensorflow's container with a dockerfile:</p>
<div class="highlight">
<pre><span></span>FROM tensorflow/tensorflow:latest-gpu-py3-jupyter
RUN apt-get update &amp;& \
        apt-get install openssh-server --yes &amp;& \
        echo "Adding neurotic user" &amp;& \
        useradd --create-home --shell /bin/bash neurotic
COPY authorized_keys /home/neurotic/.ssh/
ENTRYPOINT service ssh restart &amp;& bash
</pre></div>
<p>The latest tensorflow container comes with python 2.7 as the default for some reason, and all the dependencies are installed with it in mind so to get python 3 (3.6 as of now) you need to specify the <code>py3</code> tag like I did in the from line. Additionally I use ssh-forwarding for jupyter kernels so I can work in emacs with them so I installed the ssh-server and also created a non-root user to run jupyter. The last line <code>ENTRYPOINT service ssh restart &amp;& bash</code> makes sure the ssh-server is running and opens up a bash shell. To build the container I used this command:</p>
<div class="highlight">
<pre><span></span>docker build -t neurotic-tensorflow .
</pre></div>
<p>This creates an image named <code>neurotic-tensorflow</code>. To run it I use this command:</p>
<div class="highlight">
<pre><span></span>docker run --gpus all -p 2222:22 --name data-neurotic \
       --mount type=bind,source=$HOME/projects/neurotic-networks,target=/home/neurotic/neurotic-networks \
       --mount type=bind,source=/media/data,target=/home/neurotic/data \
       -it neurotic-tensorflow bash
</pre></div>
<p>The <code>--gpus all</code> makes the GPUs available. The <code>-p 2222:22</code> flag maps the ssh-server in the container to port 2222 on the host. This allows you to ssh into the container using <code>ssh neurotic@localhost -p 2222</code> without knowing the IP address of the container. You can also grab the IP address and then ssh into it like it's another machine on the network:</p>
<div class="highlight">
<pre><span></span>docker inspect --format "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}" data-neurotic
</pre></div>
<p>Where <code>data-neurotic</code> is the name given to the container in the <code>docker run</code> command, but the advantage of the port mapping is that:</p>
<ul class="org-ul">
<li>You don't need to know the address of the container if you are on the host machine.</li>
<li>You can ssh into the container from another machine by substituting the host's IP address for <code>localhost</code> in the ssh command</li>
</ul>
<p>The <code>mount</code> options mount some folders into the container so we can share files.</p>
<p>Once you've run it you can restart it at any time using:</p>
<div class="highlight">
<pre><span></span>docker start data-neurotic
</pre></div>
<p>And if you need to run something as root you can attach the running container.</p>
<div class="highlight">
<pre><span></span>docker attach data-neurotic
</pre></div>
<p><b>NOTE:</b> The python 3 container has cuda 10.1 installed but the latest version of tensorflow expects 11.0 - and tensorflow seems to use hard-coded names. So to make it work you either have to upgrade cuda or symlink the file and rename it to look like the newer version.</p>
<div class="highlight">
<pre><span></span>ln -s /usr/local/cuda-10.1/targets/x86_64-linux/lib/libcudart.so.10.1 /usr/lib/x86_64-linux-gnu/libcudart.so.11.0
</pre></div>
<p>Tensorflow dependencies are incredibly convoluted and broken all over the place.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/sentiment-analysis-testing-the-model/">Sentiment Analysis: Testing the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/sentiment-analysis-testing-the-model/" rel="bookmark"><time class="published dt-published" datetime="2020-12-23T15:52:18-08:00" itemprop="datePublished" title="2020-12-23 15:52">2020-12-23 15:52</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org47987d7">Beginning</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org17f635f">Imports</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org6417961">Set Up</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org8c6e2dd">Download</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org0d9d9ef">The Data Generators</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org22bd990">The Model Builder</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#orge600456">The Accuracy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org5d98e79">Middle</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#orgb41a965">Testing the model on Validation Data</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org5a91631">Testing Some Custom Input</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#orgd221981">A Positive Sentence</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#orgdfc6315">A Negative Sentence</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org1d25300">On Pooh</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#org3454e9d">On Deep Nets</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/#orge6ac52b">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org47987d7">
<h2 id="org47987d7">Beginning</h2>
<div class="outline-text-2" id="text-org47987d7">
<p>Having trained our Deep Learning model for Sentiment Analysis <a href="posts/nlp/sentiment-analysis-training-the-model/">previously</a> we're now going to test how well it did.</p>
</div>
<div class="outline-3" id="outline-container-org17f635f">
<h3 id="org17f635f">Imports</h3>
<div class="outline-text-3" id="text-org17f635f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">trax.layers</span> <span class="k">as</span> <span class="nn">trax_layers</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.sentiment_network</span> <span class="kn">import</span> <span class="n">SentimentNetwork</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.tensor_generator</span> <span class="kn">import</span> <span class="n">TensorBuilder</span><span class="p">,</span> <span class="n">TensorGenerator</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6417961">
<h3 id="org6417961">Set Up</h3>
<div class="outline-text-3" id="text-org6417961"></div>
<div class="outline-4" id="outline-container-org8c6e2dd">
<h4 id="org8c6e2dd">Download</h4>
<div class="outline-text-4" id="text-org8c6e2dd">
<p>This is because of all the trouble getting trax and tensorflow working with CUDA means I have to keep re-building the Docker container I'm using.</p>
<div class="highlight">
<pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/data/datasets/nltk_data/"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"twitter_samples"</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0d9d9ef">
<h4 id="org0d9d9ef">The Data Generators</h4>
<div class="outline-text-4" id="text-org0d9d9ef">
<div class="highlight">
<pre><span></span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">converter</span> <span class="o">=</span> <span class="n">TensorBuilder</span><span class="p">()</span>
<span class="n">train_generator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">TensorGenerator</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span>
                                     <span class="n">positive_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">positive_training</span><span class="p">,</span>
                                     <span class="n">negative_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">negative_training</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">valid_generator</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">TensorGenerator</span><span class="p">,</span>
                          <span class="n">converter</span><span class="p">,</span>
                          <span class="n">positive_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">positive_validation</span><span class="p">,</span>
                          <span class="n">negative_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">negative_validation</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="n">TRAINING_GENERATOR</span><span class="o">=</span><span class="n">train_generator</span><span class="p">()</span>
<span class="n">VALIDATION_GENERATOR</span> <span class="o">=</span> <span class="n">valid_generator</span><span class="p">()</span>
<span class="n">SIZE_OF_VOCABULARY</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="n">TRAINING_LOOPS</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/models"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org22bd990">
<h4 id="org22bd990">The Model Builder</h4>
<div class="outline-text-4" id="text-org22bd990">
<div class="highlight">
<pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">SentimentNetwork</span><span class="p">(</span>
    <span class="n">training_generator</span><span class="o">=</span><span class="n">TRAINING_GENERATOR</span><span class="p">,</span>
    <span class="n">validation_generator</span><span class="o">=</span><span class="n">VALIDATION_GENERATOR</span><span class="p">,</span>
    <span class="n">vocabulary_size</span><span class="o">=</span><span class="n">SIZE_OF_VOCABULARY</span><span class="p">,</span>
    <span class="n">training_loops</span><span class="o">=</span><span class="n">TRAINING_LOOPS</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
<pre class="example">
WARNING:absl:No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)

Step    110: Ran 10 train steps in 4.89 secs
Step    110: train CrossEntropyLoss |  0.00662578
Step    110: eval  CrossEntropyLoss |  0.00139236
Step    110: eval          Accuracy |  1.00000000

Step    120: Ran 10 train steps in 2.61 secs
Step    120: train CrossEntropyLoss |  0.03323080
Step    120: eval  CrossEntropyLoss |  0.00684100
Step    120: eval          Accuracy |  1.00000000

Step    130: Ran 10 train steps in 1.27 secs
Step    130: train CrossEntropyLoss |  0.11124543
Step    130: eval  CrossEntropyLoss |  0.00011413
Step    130: eval          Accuracy |  1.00000000

Step    140: Ran 10 train steps in 0.71 secs
Step    140: train CrossEntropyLoss |  0.03609489
Step    140: eval  CrossEntropyLoss |  0.00000590
Step    140: eval          Accuracy |  1.00000000

Step    150: Ran 10 train steps in 1.92 secs
Step    150: train CrossEntropyLoss |  0.08605278
Step    150: eval  CrossEntropyLoss |  0.00003427
Step    150: eval          Accuracy |  1.00000000

Step    160: Ran 10 train steps in 1.31 secs
Step    160: train CrossEntropyLoss |  0.04926774
Step    160: eval  CrossEntropyLoss |  0.00003597
Step    160: eval          Accuracy |  1.00000000

Step    170: Ran 10 train steps in 1.30 secs
Step    170: train CrossEntropyLoss |  0.00986138
Step    170: eval  CrossEntropyLoss |  0.00026259
Step    170: eval          Accuracy |  1.00000000

Step    180: Ran 10 train steps in 0.76 secs
Step    180: train CrossEntropyLoss |  0.00773767
Step    180: eval  CrossEntropyLoss |  0.00038017
Step    180: eval          Accuracy |  1.00000000

Step    190: Ran 10 train steps in 1.35 secs
Step    190: train CrossEntropyLoss |  0.00555876
Step    190: eval  CrossEntropyLoss |  0.00000706
Step    190: eval          Accuracy |  1.00000000

Step    200: Ran 10 train steps in 0.76 secs
Step    200: train CrossEntropyLoss |  0.00381955
Step    200: eval  CrossEntropyLoss |  0.00000122
Step    200: eval          Accuracy |  1.00000000
</pre></div>
</div>
<div class="outline-4" id="outline-container-orge600456">
<h4 id="orge600456">The Accuracy</h4>
<div class="outline-text-4" id="text-orge600456">
<p>This is from the last post. I havent' figured out how to arrange all the code yet.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">compute_accuracy</span><span class="p">(</span><span class="n">preds</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">y_weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""Compute a batch accuracy</span>

<span class="sd">    Args: </span>
<span class="sd">       preds: a tensor of shape (dim_batch, output_dim) </span>
<span class="sd">       y: a tensor of shape (dim_batch,) with the true labels</span>
<span class="sd">       y_weights: a n.ndarray with the a weight for each example</span>

<span class="sd">    Returns: </span>
<span class="sd">       accuracy: a float between 0-1 </span>
<span class="sd">       weighted_num_correct (np.float32): Sum of the weighted correct predictions</span>
<span class="sd">       sum_weights (np.float32): Sum of the weights</span>
<span class="sd">    """</span>
    <span class="c1"># Create an array of booleans, </span>
    <span class="c1"># True if the probability of positive sentiment is greater than</span>
    <span class="c1"># the probability of negative sentiment</span>
    <span class="c1"># else False</span>
    <span class="n">is_pos</span> <span class="o">=</span>  <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># convert the array of booleans into an array of np.int32</span>
    <span class="n">is_pos_int</span> <span class="o">=</span> <span class="n">is_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># compare the array of predictions (as int32) with the target (labels) of type int32</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">is_pos_int</span> <span class="o">==</span> <span class="n">y</span>

    <span class="c1"># Count the sum of the weights.</span>
    <span class="n">sum_weights</span> <span class="o">=</span> <span class="n">y_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># convert the array of correct predictions (boolean) into an arrayof np.float32</span>
    <span class="n">correct_float</span> <span class="o">=</span> <span class="n">correct</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Multiply each prediction with its corresponding weight.</span>
    <span class="n">weighted_correct_float</span> <span class="o">=</span> <span class="n">correct_float</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y_weights</span><span class="p">)</span>

    <span class="c1"># Sum up the weighted correct predictions (of type np.float32), to go in the</span>
    <span class="c1"># denominator.</span>
    <span class="n">weighted_num_correct</span> <span class="o">=</span> <span class="n">weighted_correct_float</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Divide the number of weighted correct predictions by the sum of the</span>
    <span class="c1"># weights.</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">weighted_num_correct</span><span class="o">/</span><span class="n">sum_weights</span>

    <span class="k">return</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">weighted_num_correct</span><span class="p">,</span> <span class="n">sum_weights</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org5d98e79">
<h2 id="org5d98e79">Middle</h2>
<div class="outline-text-2" id="text-org5d98e79"></div>
<div class="outline-3" id="outline-container-orgb41a965">
<h3 id="orgb41a965">Testing the model on Validation Data</h3>
<div class="outline-text-3" id="text-orgb41a965">
<p>Now we'll test our model's prediction accuracy on validation data.</p>
<p>This program will take in a data generator and the model.</p>
<ul class="org-ul">
<li>The generator allows us to get batches of data. You can use it with a <code>for</code> loop:</li>
</ul>
<pre class="example">
for batch in iterator: 
   # do something with that batch
</pre>
<p><code>batch</code> has dimensions <code>(X, Y, weights)</code>.</p>
<ul class="org-ul">
<li>Column 0 corresponds to the tweet as a tensor (input).</li>
<li>Column 1 corresponds to its target (actual label, positive or negative sentiment).</li>
<li>Column 2 corresponds to the weights associated (example weights)</li>
<li>You can feed the tweet into model and it will return the predictions for the batch.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="c1"># UNQ_C8 (UNIQUE CELL IDENTIFIER, DO NOT EDIT)</span>
<span class="c1"># GRADED FUNCTION: test_model</span>
<span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="n">generator</span><span class="p">:</span> <span class="n">TensorGenerator</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Calculate the accuracy of the model</span>

<span class="sd">    Args: </span>
<span class="sd">       generator: an iterator instance that provides batches of inputs and targets</span>
<span class="sd">       model: a model instance </span>
<span class="sd">    Returns: </span>
<span class="sd">       accuracy: float corresponding to the accuracy</span>
<span class="sd">    """</span>

    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">total_num_correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_num_pred</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span> 

        <span class="c1"># Retrieve the inputs from the batch</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Retrieve the targets (actual labels) from the batch</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Retrieve the example weight.</span>
        <span class="n">example_weight</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Make predictions using the inputs</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># Calculate accuracy for the batch by comparing its predictions and targets</span>
        <span class="n">batch_accuracy</span><span class="p">,</span> <span class="n">batch_num_correct</span><span class="p">,</span> <span class="n">batch_num_pred</span> <span class="o">=</span> <span class="n">compute_accuracy</span><span class="p">(</span>
            <span class="n">pred</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">example_weight</span><span class="p">)</span>

        <span class="c1"># Update the total number of correct predictions</span>
        <span class="c1"># by adding the number of correct predictions from this batch</span>
        <span class="n">total_num_correct</span> <span class="o">+=</span> <span class="n">batch_num_correct</span>

        <span class="c1"># Update the total number of predictions </span>
        <span class="c1"># by adding the number of predictions made for the batch</span>
        <span class="n">total_num_pred</span> <span class="o">+=</span> <span class="n">batch_num_pred</span>

    <span class="c1"># Calculate accuracy over all examples</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">total_num_correct</span><span class="o">/</span><span class="n">total_num_pred</span>

    <span class="c1">### END CODE HERE ###</span>
    <span class="k">return</span> <span class="n">accuracy</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># DO NOT EDIT THIS CELL</span>
<span class="c1"># testing the accuracy of your model: this takes around 20 seconds</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">training_loop</span><span class="o">.</span><span class="n">eval_model</span>

<span class="c1"># we used all the data for the training and validation (oops)</span>
<span class="c1"># so we don't have any test data. Fix that later</span>
<span class="c1">#accuracy = test_model(VALIDATION_GENERATOR, model)</span>
<span class="n">generator</span> <span class="o">=</span> <span class="n">valid_generator</span><span class="p">(</span><span class="n">infinite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'The accuracy of your model on the validation set is </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
<pre class="example">
The accuracy of your model on the validation set is 0.9995
</pre></div>
</div>
<div class="outline-3" id="outline-container-org5a91631">
<h3 id="org5a91631">Testing Some Custom Input</h3>
<div class="outline-text-3" id="text-org5a91631">
<p>Finally, let's test some custom input. You will see that deepnets are more powerful than the older methods we have used before. Although we got close to 100% accuracy using Naive Bayes and Logistic Regression, that was because the task was way easier.</p>
<p>This is used to predict on a new sentence.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""Predicts the sentiment of the sentence</span>

<span class="sd">    Args:</span>
<span class="sd">     sentence to get the sentiment for</span>

<span class="sd">    Returns:</span>
<span class="sd">     predictions, sentiment</span>
<span class="sd">    """</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">sentence</span><span class="p">))</span>

    <span class="c1"># Batch size 1, add dimension for batch, to work with the model</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>

    <span class="c1"># predict with the model</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="c1"># Turn probabilities into categories</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">sentiment</span> <span class="o">=</span> <span class="s2">"positive"</span> <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">"negative"</span>

    <span class="k">return</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">sentiment</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s2">"It's such a nice day, think i'll be taking Sid to Ramsgate fish and chips for lunch at Peter's fish factory and then the beach maybe"</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">sentence</span><span class="p">))</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgd221981">
<h4 id="orgd221981">A Positive Sentence</h4>
<div class="outline-text-4" id="text-orgd221981">
<div class="highlight">
<pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s2">"It's such a nice day, think i'll be taking Sid to Ramsgate fish and chips for lunch at Peter's fish factory and then the beach maybe"</span>
<span class="n">tmp_pred</span><span class="p">,</span> <span class="n">tmp_sentiment</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The sentiment of the sentence </span><span class="se">\n</span><span class="s2">***</span><span class="se">\n\"</span><span class="si">{</span><span class="n">sentence</span><span class="si">}</span><span class="se">\"\n</span><span class="s2">***</span><span class="se">\n</span><span class="s2">is </span><span class="si">{</span><span class="n">tmp_sentiment</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
</pre></div>
<pre class="example">
The sentiment of the sentence 
***
"It's such a nice day, think i'll be taking Sid to Ramsgate fish and chips for lunch at Peter's fish factory and then the beach maybe"
***
is positive.
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgdfc6315">
<h4 id="orgdfc6315">A Negative Sentence</h4>
<div class="outline-text-4" id="text-orgdfc6315">
<div class="highlight">
<pre><span></span><span class="n">sentence</span> <span class="o">=</span> <span class="s2">"I hated my day, it was the worst, I'm so sad."</span>
<span class="n">tmp_pred</span><span class="p">,</span> <span class="n">tmp_sentiment</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The sentiment of the sentence </span><span class="se">\n</span><span class="s2">***</span><span class="se">\n\"</span><span class="si">{</span><span class="n">sentence</span><span class="si">}</span><span class="se">\"\n</span><span class="s2">***</span><span class="se">\n</span><span class="s2">is </span><span class="si">{</span><span class="n">tmp_sentiment</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
</pre></div>
<pre class="example">
The sentiment of the sentence 
***
"I hated my day, it was the worst, I'm so sad."
***
is negative.
</pre>
<p>Notice that the model works well even for complex sentences.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org1d25300">
<h4 id="org1d25300">On Pooh</h4>
<div class="outline-text-4" id="text-org1d25300">
<div class="highlight">
<pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"Oh, bother!"</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">predict</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Oh, bother!: (0, 'negative')
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org3454e9d">
<h3 id="org3454e9d">On Deep Nets</h3>
<div class="outline-text-3" id="text-org3454e9d">
<p>Deep nets allow you to understand and capture dependencies that you would have not been able to capture with a simple linear regression, or logistic regression.</p>
<ul class="org-ul">
<li>It also allows you to better use pre-trained embeddings for classification and tends to generalize better.</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orge6ac52b">
<h2 id="orge6ac52b">End</h2>
<div class="outline-text-2" id="text-orge6ac52b">
<p>So, there you have it, a Deep Learning Model for Sentiment Analysis built using Trax. Here are the prior posts in this series.</p>
<ul class="org-ul">
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/">Introduction</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/">Loading the Data</a></li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/">Defining the Model</a></li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/">Training the Model</a></li>
</ul>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/sentiment-analysis-training-the-model/">Sentiment Analysis: Training the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/sentiment-analysis-training-the-model/" rel="bookmark"><time class="published dt-published" datetime="2020-12-23T15:49:53-08:00" itemprop="datePublished" title="2020-12-23 15:49">2020-12-23 15:49</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#orge4b5232">Training the Model</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org8257135">Imports</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org3fbba37">Middle</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#orgae050ef">The Dataset</a></li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#orgad5b0d2">Here's the Model</a></li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org38c3d4a">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#orgfb0fd23">Imports</a></li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org68c87a4">The Trainer</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org8f89017">Practice In Making Predictions</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org20f5fd1">Compare 1 to 1 rather than comparing True to 1.</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org76bbd39">Evaluation</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#org0c9210f">5.1 Computing the accuracy of a batch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/#orgd017c43">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orge4b5232">
<h2 id="orge4b5232">Training the Model</h2>
<div class="outline-text-2" id="text-orge4b5232">
<p>In the <a href="posts/nlp/sentiment-analysis-defining-the-model/">previous post</a> we defined our Deep Learning model for Sentiment Analysis. Now we'll turn to training it on our data.</p>
<p>To train a model on a task, Trax defines an abstraction <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.TrainTask"><code>trax.supervised.training.TrainTask</code></a> which packages the training data, loss and optimizer (among other things) together into an object.</p>
<p>Similarly to training a model, Trax defines an abstraction <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.EvalTask"><code>trax.supervised.training.EvalTask</code></a> which packages the eval data and metrics (among other things) into another object.</p>
<p>The final piece tying things together is the <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.Loop"><code>trax.supervised.training.Loop</code></a> abstraction that is a very simpl eand flexible way to put everything together and train the model, all the while evaluating it and saving checkpoints. Using <code>Loop</code> will save you a lot of code compared to always writing the training loop by hand, like you did in courses 1 and 2. More importantly, you are less likely to have a bug in that code that would ruin your training.</p>
</div>
<div class="outline-3" id="outline-container-org8257135">
<h3 id="org8257135">Imports</h3>
<div class="outline-text-3" id="text-org8257135">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">trax.supervised</span> <span class="kn">import</span> <span class="n">training</span>

<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">trax</span>
<span class="kn">import</span> <span class="nn">trax.layers</span> <span class="k">as</span> <span class="nn">trax_layers</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.tensor_generator</span> <span class="kn">import</span> <span class="n">TensorBuilder</span><span class="p">,</span> <span class="n">TensorGenerator</span>
</pre></div>
<p>This next part (re-downloading the dataset) is just because I have to keep setting up new containers to get trax to work…</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"twitter_samples"</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="s2">"/home/neurotic/data/datasets/nltk_data/"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3fbba37">
<h2 id="org3fbba37">Middle</h2>
<div class="outline-text-2" id="text-org3fbba37"></div>
<div class="outline-3" id="outline-container-orgae050ef">
<h3 id="orgae050ef">The Dataset</h3>
<div class="outline-text-3" id="text-orgae050ef">
<div class="highlight">
<pre><span></span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">converter</span> <span class="o">=</span> <span class="n">TensorBuilder</span><span class="p">()</span>


<span class="n">train_generator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">TensorGenerator</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span>
                                     <span class="n">positive_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">positive_training</span><span class="p">,</span>
                                     <span class="n">negative_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">negative_training</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">training_generator</span> <span class="o">=</span> <span class="n">train_generator</span><span class="p">()</span>

<span class="n">valid_generator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">TensorGenerator</span><span class="p">,</span>
                          <span class="n">converter</span><span class="p">,</span>
                          <span class="n">positive_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">positive_validation</span><span class="p">,</span>
                          <span class="n">negative_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">negative_validation</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">validation_generator</span> <span class="o">=</span> <span class="n">valid_generator</span><span class="p">()</span>

<span class="n">size_of_vocabulary</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgad5b0d2">
<h3 id="orgad5b0d2">Here's the Model</h3>
<div class="outline-text-3" id="text-orgad5b0d2">
<p>This was defined in the clast post. It seems like too much trouble not to just copy it over.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">classifier</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">size_of_vocabulary</span><span class="p">,</span>
               <span class="n">embedding_dim</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
               <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
    <span class="sd">"""Creates the classifier model</span>

<span class="sd">    Args:</span>
<span class="sd">     vocab_size: number of tokens in the training vocabulary</span>
<span class="sd">     embedding_dim: output dimension for the Embedding layer</span>
<span class="sd">     output_dim: dimension for the Dense layer</span>

<span class="sd">    Returns:</span>
<span class="sd">     the composed layer-model</span>
<span class="sd">    """</span>
    <span class="n">embed_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
        <span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="c1"># Size of the vocabulary</span>
        <span class="n">d_feature</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">)</span>  <span class="c1"># Embedding dimension</span>

    <span class="n">mean_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">dense_output_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span> <span class="o">=</span> <span class="n">output_dim</span><span class="p">)</span>

    <span class="n">log_softmax_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
      <span class="n">embed_layer</span><span class="p">,</span>
      <span class="n">mean_layer</span><span class="p">,</span>
      <span class="n">dense_output_layer</span><span class="p">,</span>
      <span class="n">log_softmax_layer</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
<p>Now to train the model.</p>
<p>First define the <code>TrainTask</code>, <code>EvalTask</code> and <code>Loop</code> in preparation to training the model.</p>
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">271</span><span class="p">)</span>

<span class="c1"># train_generator(batch_size=batch_size, shuffle=True),</span>

<span class="n">train_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
    <span class="n">labeled_data</span><span class="o">=</span><span class="n">training_generator</span><span class="p">,</span>
    <span class="n">loss_layer</span><span class="o">=</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
    <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">eval_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
    <span class="n">labeled_data</span><span class="o">=</span><span class="n">validation_generator</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span>
<span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">()</span>
</pre></div>
<p>This defines a model trained using <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.CrossEntropyLoss">tl.CrossEntropyLoss</a> optimized with the <a href="https://trax-ml.readthedocs.io/en/latest/trax.optimizers.html#trax.optimizers.adam.Adam">trax.optimizers.Adam</a> optimizer, all the while tracking the accuracy using <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.Accuracy">tl.Accuracy</a> metric. We also track <code>tl.CrossEntropyLoss</code> on the validation set.</p>
<p>Now let's make an output directory and train the model.</p>
<div class="highlight">
<pre><span></span><span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">output_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">train_task</span><span class="p">,</span> <span class="n">eval_task</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
    <span class="sd">"""Create and run the training loop</span>

<span class="sd">    Args: </span>
<span class="sd">       classifier - the model you are building</span>
<span class="sd">       train_task - Training task</span>
<span class="sd">       eval_task - Evaluation task</span>
<span class="sd">       n_steps - the evaluation steps</span>
<span class="sd">       output_dir - folder to save your files</span>
<span class="sd">    Returns:</span>
<span class="sd">       trainer -  trax trainer</span>
<span class="sd">    """</span>
    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span>
                                <span class="n">model</span><span class="o">=</span><span class="n">classifier</span><span class="p">,</span> <span class="c1"># The learning model</span>
                                <span class="n">tasks</span><span class="o">=</span><span class="n">train_task</span><span class="p">,</span> <span class="c1"># The training task</span>
                                <span class="n">eval_tasks</span> <span class="o">=</span> <span class="n">eval_task</span><span class="p">,</span> <span class="c1"># The evaluation task</span>
                                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="p">)</span> <span class="c1"># The output directory</span>

    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span> <span class="o">=</span> <span class="n">n_steps</span><span class="p">)</span>
    <span class="c1"># Return the training_loop, since it has the model.</span>
    <span class="k">return</span> <span class="n">training_loop</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">training_loop</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_task</span><span class="p">,</span> <span class="n">eval_task</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
</pre></div>
<pre class="example">

Step    110: Ran 10 train steps in 6.06 secs
Step    110: train CrossEntropyLoss |  0.00527583
Step    110: eval  CrossEntropyLoss |  0.00304692
Step    110: eval          Accuracy |  1.00000000

Step    120: Ran 10 train steps in 2.06 secs
Step    120: train CrossEntropyLoss |  0.02130376
Step    120: eval  CrossEntropyLoss |  0.00000677
Step    120: eval          Accuracy |  1.00000000

Step    130: Ran 10 train steps in 0.75 secs
Step    130: train CrossEntropyLoss |  0.01026674
Step    130: eval  CrossEntropyLoss |  0.00424393
Step    130: eval          Accuracy |  1.00000000

Step    140: Ran 10 train steps in 1.33 secs
Step    140: train CrossEntropyLoss |  0.00172522
Step    140: eval  CrossEntropyLoss |  0.00004072
Step    140: eval          Accuracy |  1.00000000

Step    150: Ran 10 train steps in 0.77 secs
Step    150: train CrossEntropyLoss |  0.00002847
Step    150: eval  CrossEntropyLoss |  0.00000232
Step    150: eval          Accuracy |  1.00000000

Step    160: Ran 10 train steps in 0.78 secs
Step    160: train CrossEntropyLoss |  0.00002123
Step    160: eval  CrossEntropyLoss |  0.00104654
Step    160: eval          Accuracy |  1.00000000

Step    170: Ran 10 train steps in 0.79 secs
Step    170: train CrossEntropyLoss |  0.00001706
Step    170: eval  CrossEntropyLoss |  0.00000080
Step    170: eval          Accuracy |  1.00000000

Step    180: Ran 10 train steps in 0.83 secs
Step    180: train CrossEntropyLoss |  0.00001554
Step    180: eval  CrossEntropyLoss |  0.00000989
Step    180: eval          Accuracy |  1.00000000

Step    190: Ran 10 train steps in 0.85 secs
Step    190: train CrossEntropyLoss |  0.00639312
Step    190: eval  CrossEntropyLoss |  0.00255337
Step    190: eval          Accuracy |  1.00000000

Step    200: Ran 10 train steps in 0.85 secs
Step    200: train CrossEntropyLoss |  0.00124322
Step    200: eval  CrossEntropyLoss |  0.02190475
Step    200: eval          Accuracy |  1.00000000
</pre></div>
</div>
<div class="outline-3" id="outline-container-org38c3d4a">
<h3 id="org38c3d4a">Bundle It Up</h3>
<div class="outline-text-3" id="text-org38c3d4a">
<div class="highlight">
<pre><span></span><span class="o">&lt;&lt;</span><span class="n">imports</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">model</span><span class="o">-</span><span class="n">trainer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">training</span><span class="o">-</span><span class="n">task</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="nb">eval</span><span class="o">-</span><span class="n">task</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">training</span><span class="o">-</span><span class="n">loop</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">fit</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgfb0fd23">
<h4 id="orgfb0fd23">Imports</h4>
<div class="outline-text-4" id="text-orgfb0fd23">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">trax.supervised</span> <span class="kn">import</span> <span class="n">training</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">trax</span>
<span class="kn">import</span> <span class="nn">trax.layers</span> <span class="k">as</span> <span class="nn">trax_layers</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org68c87a4">
<h4 id="org68c87a4">The Trainer</h4>
<div class="outline-text-4" id="text-org68c87a4">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SentimentNetwork</span><span class="p">:</span>
    <span class="sd">"""Builds and Trains the Sentiment Analysis Model</span>

<span class="sd">    Args:</span>
<span class="sd">     training_generator: generator of training batches</span>
<span class="sd">     validation_generator: generator of validation batches</span>
<span class="sd">     vocabulary_size: number of tokens in the training vocabulary</span>
<span class="sd">     training_loops: number of times to run the training loop</span>
<span class="sd">     output_path: path to where to store the model</span>
<span class="sd">     embedding_dimension: output dimension for the Embedding layer</span>
<span class="sd">     output_dimension: dimension for the Dense layer</span>
<span class="sd">    """</span>
    <span class="n">vocabulary_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">training_generator</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">validation_generator</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">training_loops</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">embedding_dimension</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span>
    <span class="n">output_dimension</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">_model</span><span class="p">:</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training_task</span><span class="p">:</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_evaluation_task</span><span class="p">:</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training_loop</span><span class="p">:</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgfc763e4"></a>The Model<br>
<div class="outline-text-5" id="text-orgfc763e4">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
    <span class="sd">"""The Embeddings model"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
                <span class="n">vocab_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">,</span>
                <span class="n">d_feature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span><span class="p">),</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">),</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</pre></div>
</div>
</li>
<li><a id="org7424f67"></a>The Training Task<br>
<div class="outline-text-5" id="text-org7424f67">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">:</span>
    <span class="sd">"""The training task for training the model"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
            <span class="n">labeled_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_generator</span><span class="p">,</span>
            <span class="n">loss_layer</span><span class="o">=</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
            <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_task</span>
</pre></div>
</div>
</li>
<li><a id="org4735ea8"></a>Evaluation Task<br>
<div class="outline-text-5" id="text-org4735ea8">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">evaluation_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">:</span>
    <span class="sd">"""The validation evaluation task"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
            <span class="n">labeled_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_generator</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span>
                     <span class="n">trax_layers</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_task</span>
</pre></div>
</div>
</li>
<li><a id="orgeb6c47f"></a>Training Loop<br>
<div class="outline-text-5" id="text-orgeb6c47f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">:</span>
    <span class="sd">"""The thing to run the training"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_loop</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_task</span><span class="p">,</span>
            <span class="n">eval_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_task</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span> 
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_loop</span>
</pre></div>
</div>
</li>
<li><a id="orgb42cb1e"></a>Fitting the Model<br>
<div class="outline-text-5" id="text-orgb42cb1e">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Runs the training loop"""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_loops</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org8f89017">
<h3 id="org8f89017">Practice In Making Predictions</h3>
<div class="outline-text-3" id="text-org8f89017">
<p>Now that you have trained a model, you can access it as <code>training_loop.model</code> object. We will actually use <code>training_loop.eval_model</code> and in the next weeks you will learn why we sometimes use a different model for evaluation, e.g., one without dropout. For now, make predictions with your model.</p>
<p>Use the training data just to see how the prediction process works.</p>
<ul class="org-ul">
<li>Later, you will use validation data to evaluate your model's performance.</li>
</ul>
<p>Create a generator object.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_train_generator</span> <span class="o">=</span> <span class="n">train_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
<p>Get one batch.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_train_generator</span><span class="p">)</span>
</pre></div>
<p>Position 0 has the model inputs (tweets as tensors). Position 1 has the targets (the actual labels).</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_inputs</span><span class="p">,</span> <span class="n">tmp_targets</span><span class="p">,</span> <span class="n">tmp_example_weights</span> <span class="o">=</span> <span class="n">tmp_batch</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The batch is a tuple of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">)</span><span class="si">}</span><span class="s2"> because position 0 contains the tweets, and position 1 contains the targets."</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The shape of the tweet tensors is </span><span class="si">{</span><span class="n">tmp_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> (num of examples, length of tweet tensors)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The shape of the labels is </span><span class="si">{</span><span class="n">tmp_targets</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, which is the batch size."</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The shape of the example_weights is </span><span class="si">{</span><span class="n">tmp_example_weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, which is the same as inputs/targets size."</span><span class="p">)</span>
</pre></div>
<pre class="example">
The batch is a tuple of length 3 because position 0 contains the tweets, and position 1 contains the targets.
The shape of the tweet tensors is (16, 14) (num of examples, length of tweet tensors)
The shape of the labels is (16,), which is the batch size.
The shape of the example_weights is (16,), which is the same as inputs/targets size.
</pre>
<p>Feed the tweet tensors into the model to get a prediction.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_pred</span> <span class="o">=</span> <span class="n">training_loop</span><span class="o">.</span><span class="n">eval_model</span><span class="p">(</span><span class="n">tmp_inputs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The prediction shape is </span><span class="si">{</span><span class="n">tmp_pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, num of tensor_tweets as rows"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Column 0 is the probability of a negative sentiment (class 0)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Column 1 is the probability of a positive sentiment (class 1)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"View the prediction array"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_pred</span><span class="p">)</span>
</pre></div>
<pre class="example">
The prediction shape is (16, 2), num of tensor_tweets as rows
Column 0 is the probability of a negative sentiment (class 0)
Column 1 is the probability of a positive sentiment (class 1)

View the prediction array
[[-1.2960873e+01 -2.3841858e-06]
 [-5.6474457e+00 -3.5326481e-03]
 [-5.3460855e+00 -4.7781467e-03]
 [-7.6736917e+00 -4.6515465e-04]
 [-5.2682662e+00 -5.1658154e-03]
 [-1.0566207e+01 -2.5749207e-05]
 [-5.6388092e+00 -3.5634041e-03]
 [-3.9540453e+00 -1.9363165e-02]
 [ 0.0000000e+00 -2.0700916e+01]
 [ 0.0000000e+00 -2.2949795e+01]
 [ 0.0000000e+00 -2.3168846e+01]
 [ 0.0000000e+00 -2.4553205e+01]
 [-9.5367432e-07 -1.3878939e+01]
 [ 0.0000000e+00 -1.6655178e+01]
 [ 0.0000000e+00 -1.5975946e+01]
 [ 0.0000000e+00 -2.0577690e+01]]
</pre>
<p>To turn these probabilities into categories (negative or positive sentiment prediction), for each row:</p>
<ul class="org-ul">
<li>Compare the probabilities in each column.</li>
<li>If column 1 has a value greater than column 0, classify that as a positive tweet.</li>
<li>Otherwise if column 1 is less than or equal to column 0, classify that example as a negative tweet.</li>
</ul>
<p>Turn probabilites into category predictions.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_is_positive</span> <span class="o">=</span> <span class="n">tmp_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tmp_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_is_positive</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Neg log prob </span><span class="si">{</span><span class="n">tmp_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s2">Pos log prob </span><span class="si">{</span><span class="n">tmp_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s2"> is positive? </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\t</span><span class="s2"> actual </span><span class="si">{</span><span class="n">tmp_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Neg log prob -12.9609   Pos log prob -0.0000     is positive? True       actual 1
Neg log prob -5.6474    Pos log prob -0.0035     is positive? True       actual 1
Neg log prob -5.3461    Pos log prob -0.0048     is positive? True       actual 1
Neg log prob -7.6737    Pos log prob -0.0005     is positive? True       actual 1
Neg log prob -5.2683    Pos log prob -0.0052     is positive? True       actual 1
Neg log prob -10.5662   Pos log prob -0.0000     is positive? True       actual 1
Neg log prob -5.6388    Pos log prob -0.0036     is positive? True       actual 1
Neg log prob -3.9540    Pos log prob -0.0194     is positive? True       actual 1
Neg log prob 0.0000     Pos log prob -20.7009    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -22.9498    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -23.1688    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -24.5532    is positive? False      actual 0
Neg log prob -0.0000    Pos log prob -13.8789    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -16.6552    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -15.9759    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -20.5777    is positive? False      actual 0
</pre>
<p>Notice that since you are making a prediction using a training batch, it's more likely that the model's predictions match the actual targets (labels).</p>
<ul class="org-ul">
<li>Every prediction that the tweet is positive is also matching the actual target of 1 (positive sentiment).</li>
<li>Similarly, all predictions that the sentiment is not positive matches the actual target of 0 (negative sentiment)</li>
</ul>
<p>One more useful thing to know is how to compare if the prediction is matching the actual target (label).</p>
<ul class="org-ul">
<li>The result of calculation <code>is_positive</code> is a boolean.</li>
<li>The target is a type trax.fastmath.numpy.int32</li>
<li>If you expect to be doing division, you may prefer to work with decimal numbers with the data type type trax.fastmath.numpy.int32</li>
</ul>
<p>View the array of booleans.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Array of booleans"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_is_positive</span><span class="p">)</span>
</pre></div>
<pre class="example">
Array of booleans
DeviceArray([ True,  True,  True,  True,  True,  True,  True,  True,
             False, False, False, False, False, False, False, False],            dtype=bool)
</pre>
<p>Convert booleans to type int32.</p>
<ul class="org-ul">
<li>True is converted to 1</li>
<li>False is converted to 0</li>
</ul>
<div class="highlight">
<pre><span></span><span class="n">tmp_is_positive_int</span> <span class="o">=</span> <span class="n">tmp_is_positive</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">trax</span><span class="o">.</span><span class="n">fastmath</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</pre></div>
<p>View the array of integers.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Array of integers"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_is_positive_int</span><span class="p">)</span>
</pre></div>
<pre class="example">
Array of integers
DeviceArray([1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0], dtype=int32)
</pre>
<p>Convert boolean to type float32.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_is_positive_float</span> <span class="o">=</span> <span class="n">tmp_is_positive</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
<p>View the array of floats.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Array of floats"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_is_positive_float</span><span class="p">)</span>
</pre></div>
<pre class="example">
Array of floats
DeviceArray([1., 1., 1., 1., 1., 1., 1., 1., 0., 0., 0., 0., 0., 0., 0.,
             0.], dtype=float32)
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tmp_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
<pre class="example">
(16, 2)
</pre>
<p>Note that Python usually does type conversion for you when you compare a boolean to an integer.</p>
<ul class="org-ul">
<li>True compared to 1 is True, otherwise any other integer is False.</li>
<li>False compared to 0 is True, otherwise any ohter integer is False.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"True == 1: </span><span class="si">{</span><span class="kc">True</span> <span class="o">==</span> <span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"True == 2: </span><span class="si">{</span><span class="kc">True</span> <span class="o">==</span> <span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"False == 0: </span><span class="si">{</span><span class="kc">False</span> <span class="o">==</span> <span class="mi">0</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"False == 2: </span><span class="si">{</span><span class="kc">False</span> <span class="o">==</span> <span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
True == 1: True
True == 2: False
False == 0: True
False == 2: False
</pre>
<p>However, we recommend that you keep track of the data type of your variables to avoid unexpected outcomes. So it helps to convert the booleans into integers.</p>
</div>
<div class="outline-4" id="outline-container-org20f5fd1">
<h4 id="org20f5fd1">Compare 1 to 1 rather than comparing True to 1.</h4>
<div class="outline-text-4" id="text-org20f5fd1">
<p>Hopefully you are now familiar with what kinds of inputs and outputs the model uses when making a prediction.</p>
<ul class="org-ul">
<li>This will help you implement a function that estimates the accuracy of the model's predictions.</li>
</ul>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org76bbd39">
<h3 id="org76bbd39">Evaluation</h3>
<div class="outline-text-3" id="text-org76bbd39"></div>
<div class="outline-4" id="outline-container-org0c9210f">
<h4 id="org0c9210f">5.1 Computing the accuracy of a batch</h4>
<div class="outline-text-4" id="text-org0c9210f">
<p>You will now write a function that evaluates your model on the validation set and returns the accuracy.</p>
<ul class="org-ul">
<li><code>preds</code> contains the predictions.</li>
<li>Its dimensions are <code>(batch_size, output_dim)</code>. <code>output_dim</code> is two in this case. Column 0 contains the probability that the tweet belongs to class 0 (negative sentiment). Column 1 contains probability that it belongs to class 1 (positive sentiment).</li>
<li>If the probability in column 1 is greater than the probability in column 0, then interpret this as the model's prediction that the example has label 1 (positive sentiment).</li>
<li>Otherwise, if the probabilities are equal or the probability in column 0 is higher, the model's prediction is 0 (negative sentiment).</li>
<li><code>y</code> contains the actual labels.</li>
<li><code>y_weights</code> contains the weights to give to predictions.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">compute_accuracy</span><span class="p">(</span><span class="n">preds</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">y_weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">"""Compute a batch accuracy</span>

<span class="sd">    Args: </span>
<span class="sd">       preds: a tensor of shape (dim_batch, output_dim) </span>
<span class="sd">       y: a tensor of shape (dim_batch,) with the true labels</span>
<span class="sd">       y_weights: a n.ndarray with the a weight for each example</span>

<span class="sd">    Returns: </span>
<span class="sd">       accuracy: a float between 0-1 </span>
<span class="sd">       weighted_num_correct (np.float32): Sum of the weighted correct predictions</span>
<span class="sd">       sum_weights (np.float32): Sum of the weights</span>
<span class="sd">    """</span>
    <span class="c1"># Create an array of booleans, </span>
    <span class="c1"># True if the probability of positive sentiment is greater than</span>
    <span class="c1"># the probability of negative sentiment</span>
    <span class="c1"># else False</span>
    <span class="n">is_pos</span> <span class="o">=</span>  <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># convert the array of booleans into an array of np.int32</span>
    <span class="n">is_pos_int</span> <span class="o">=</span> <span class="n">is_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># compare the array of predictions (as int32) with the target (labels) of type int32</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">is_pos_int</span> <span class="o">==</span> <span class="n">y</span>

    <span class="c1"># Count the sum of the weights.</span>
    <span class="n">sum_weights</span> <span class="o">=</span> <span class="n">y_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># convert the array of correct predictions (boolean) into an arrayof np.float32</span>
    <span class="n">correct_float</span> <span class="o">=</span> <span class="n">correct</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Multiply each prediction with its corresponding weight.</span>
    <span class="n">weighted_correct_float</span> <span class="o">=</span> <span class="n">correct_float</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y_weights</span><span class="p">)</span>

    <span class="c1"># Sum up the weighted correct predictions (of type np.float32), to go in the</span>
    <span class="c1"># denominator.</span>
    <span class="n">weighted_num_correct</span> <span class="o">=</span> <span class="n">weighted_correct_float</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Divide the number of weighted correct predictions by the sum of the</span>
    <span class="c1"># weights.</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">weighted_num_correct</span><span class="o">/</span><span class="n">sum_weights</span>

    <span class="k">return</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">weighted_num_correct</span><span class="p">,</span> <span class="n">sum_weights</span>
</pre></div>
<p>Get one batch.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_val_generator</span> <span class="o">=</span> <span class="n">valid_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">tmp_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_val_generator</span><span class="p">)</span>
</pre></div>
<p>Position 0 has the model inputs (tweets as tensors) position 1 has the targets (the actual labels)</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_inputs</span><span class="p">,</span> <span class="n">tmp_targets</span><span class="p">,</span> <span class="n">tmp_example_weights</span> <span class="o">=</span> <span class="n">tmp_batch</span>
</pre></div>
<p>Feed the tweet tensors into the model to get a prediction.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_pred</span> <span class="o">=</span> <span class="n">training_loop</span><span class="o">.</span><span class="n">eval_model</span><span class="p">(</span><span class="n">tmp_inputs</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">tmp_acc</span><span class="p">,</span> <span class="n">tmp_num_correct</span><span class="p">,</span> <span class="n">tmp_num_predictions</span> <span class="o">=</span> <span class="n">compute_accuracy</span><span class="p">(</span><span class="n">preds</span><span class="o">=</span><span class="n">tmp_pred</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">tmp_targets</span><span class="p">,</span> <span class="n">y_weights</span><span class="o">=</span><span class="n">tmp_example_weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model's prediction accuracy on a single training batch is: </span><span class="si">{</span><span class="mi">100</span> <span class="o">*</span> <span class="n">tmp_acc</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted number of correct predictions </span><span class="si">{</span><span class="n">tmp_num_correct</span><span class="si">}</span><span class="s2">; weighted number of total observations predicted </span><span class="si">{</span><span class="n">tmp_num_predictions</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Model's prediction accuracy on a single training batch is: 100.0%
Weighted number of correct predictions 64.0; weighted number of total observations predicted 64
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd017c43">
<h2 id="orgd017c43">End</h2>
<div class="outline-text-2" id="text-orgd017c43">
<p>Now that we have a trained model, in the <a href="posts/nlp/sentiment-analysis-testing-the-model/">next post</a> we'll test how well it did.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/sentiment-analysis-defining-the-model/">Sentiment Analysis: Defining the Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/sentiment-analysis-defining-the-model/" rel="bookmark"><time class="published dt-published" datetime="2020-12-23T15:46:13-08:00" itemprop="datePublished" title="2020-12-23 15:46">2020-12-23 15:46</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#orgd5d52c2">Beginning</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#org2017d33">Imports</a></li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#orgea68f01">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#org6e1cf1e">Middle</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#org3b688ed">The Base Layer Class</a></li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#orgd0d345f">The ReLU class</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#org6942479">Test It</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#orgf4dae64">The Dense class</a></li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#org595d2f6">The Layers for the Trax-Based Model</a></li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#org5e34245">Dense</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#orgb8e3e42">Online Documentation</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#orgebd62dd">The Classifier Function</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/#org57ccf9a">Ending</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd5d52c2">
<h2 id="orgd5d52c2">Beginning</h2>
<div class="outline-text-2" id="text-orgd5d52c2">
<p>This continues a series on <a href="posts/nlp/sentiment-analysis-deep-learning-model/">sentiment analysis with deep learning</a>. In the <a href="posts/nlp/sentiment-analysis-pre-processing-the-data/">previous post</a> we loaded and processed our data set. In this post we'll see about actually defining the Neural Network.</p>
<p>In this part we will write your own library of layers. It will be very similar to the one used in Trax and also in Keras and PyTorch. The intention is that in writing our own small framework will help us understand how they all work and use them more effectively in the future.</p>
</div>
<div class="outline-3" id="outline-container-org2017d33">
<h3 id="org2017d33">Imports</h3>
<div class="outline-text-3" id="text-org2017d33">
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">be_true</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">fastmath</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">trax</span>
<span class="kn">import</span> <span class="nn">trax.layers</span> <span class="k">as</span> <span class="nn">trax_layers</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.tensor_generator</span> <span class="kn">import</span> <span class="n">TensorBuilder</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgea68f01">
<h3 id="orgea68f01">Set Up</h3>
<div class="outline-text-3" id="text-orgea68f01">
<p>Some aliases to get closer to what the notebook has.</p>
<div class="highlight">
<pre><span></span><span class="n">numpy_fastmath</span> <span class="o">=</span> <span class="n">fastmath</span><span class="o">.</span><span class="n">numpy</span>
<span class="n">random</span> <span class="o">=</span> <span class="n">fastmath</span><span class="o">.</span><span class="n">random</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org6e1cf1e">
<h2 id="org6e1cf1e">Middle</h2>
<div class="outline-text-2" id="text-org6e1cf1e"></div>
<div class="outline-3" id="outline-container-org3b688ed">
<h3 id="org3b688ed">The Base Layer Class</h3>
<div class="outline-text-3" id="text-org3b688ed">
<p>This will be the base class that the others will inherit from.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Layer</span><span class="p">:</span>
    <span class="sd">"""Base class for layers</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">"""The forward propagation method</span>

<span class="sd">       Raises:</span>
<span class="sd">        NotImplementedError - method is called but child hasn't implemented it</span>
<span class="sd">       """</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">init_weights_and_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_signature</span><span class="p">,</span> <span class="n">random_key</span><span class="p">):</span>
        <span class="sd">"""method to initialize the weights</span>
<span class="sd">       based on the input signature and random key,</span>
<span class="sd">       be implemented by subclasses of this Layer class</span>
<span class="sd">       """</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_signature</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""initializes and returns the weights</span>

<span class="sd">       Note:</span>
<span class="sd">        This is just an alias for the ``init_weights_and_state``</span>
<span class="sd">       method for some reason</span>

<span class="sd">       Args: </span>
<span class="sd">        input_signature: who knows?</span>
<span class="sd">        random_key: once again, who knows?</span>

<span class="sd">       Returns:</span>
<span class="sd">        the weights</span>
<span class="sd">       """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_weights_and_state</span><span class="p">(</span><span class="n">input_signature</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""This is an alias for the ``forward`` method</span>

<span class="sd">       Args:</span>
<span class="sd">        x: input array</span>

<span class="sd">       Returns:</span>
<span class="sd">        whatever the ``forward`` method does</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd0d345f">
<h3 id="orgd0d345f">The ReLU class</h3>
<div class="outline-text-3" id="text-orgd0d345f">
<p>Here's the ReLU function:</p>
<p>\[ \mathrm{ReLU}(x) = \mathrm{max}(0,x) \]</p>
<p>We'll implement the ReLU activation function below. The function will take in a matrix or vector and it transform all the negative numbers into 0 while keeping all the positive numbers intact.</p>
<p>Please use numpy.maximum(A,k) to find the maximum between each element in A and a scalar k.</p>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">Relu</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">"""Relu activation function implementation"""</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">""""Performs the activation</span>

<span class="sd">       Args: </span>
<span class="sd">           - x: the input</span>

<span class="sd">       Returns:</span>
<span class="sd">           - activation: all positive or 0 version of x</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org6942479">
<h4 id="org6942479">Test It</h4>
<div class="outline-text-4" id="text-org6942479">
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">relu_layer</span> <span class="o">=</span> <span class="n">Relu</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Test data is:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Output of Relu is:"</span><span class="p">)</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">relu_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>

<span class="n">expected</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]])</span>

<span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
Test data is:
[[-2. -1.  0.]
 [ 0.  1.  2.]]

Output of Relu is:
[[0. 0. 0.]
 [0. 1. 2.]]
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf4dae64">
<h3 id="orgf4dae64">The Dense class</h3>
<div class="outline-text-3" id="text-orgf4dae64">
<p>Implement the forward function of the Dense class.</p>
<ul class="org-ul">
<li>The forward function multiplies the input to the layer (<code>x</code>) by the weight matrix (<code>W</code>).</li>
</ul>
<p>\[ \mathrm{forward}(\mathbf{x},\mathbf{W}) = \mathbf{xW} \]</p>
<ul class="org-ul">
<li>You can use <code>numpy.dot</code> to perform the matrix multiplication.</li>
</ul>
<p>Note that for more efficient code execution, you will use the trax version of <code>math</code>, which includes a trax version of <code>numpy</code> and also <code>random</code>.</p>
<p>Implement the weight initializer <code>new_weights</code> function</p>
<ul class="org-ul">
<li>Weights are initialized with a random key.</li>
<li>The second parameter is a tuple for the desired shape of the weights (num_rows, num_cols)</li>
<li>The num of rows for weights should equal the number of columns in x, because for forward propagation, you will multiply x times weights.</li>
</ul>
<p>Please use <code>trax.fastmath.random.normal(key, shape, dtype=tf.float32)</code> to generate random values for the weight matrix. The key difference between this function and the standard <code>numpy</code> randomness is the explicit use of random keys, which need to be passed in. While it can look tedious at the first sight to pass the random key everywhere, you will learn in Course 4 why this is very helpful when implementing some advanced models.</p>
<ul class="org-ul">
<li><code>key</code> can be generated by calling <code>random.get_prng(seed)</code> and passing in a number for the <code>seed</code>.</li>
<li><code>shape</code> is a tuple with the desired shape of the weight matrix.
<ul class="org-ul">
<li>The number of rows in the weight matrix should equal the number of columns in the variable <code>x</code>. Since <code>x</code> may have 2 dimensions if it represents a single training example (row, col), or three dimensions (batch_size, row, col), get the last dimension from the tuple that holds the dimensions of x.</li>
<li>The number of columns in the weight matrix is the number of units chosen for that dense layer. Look at the <code>__init__</code> function to see which variable stores the number of units.</li>
</ul>
</li>
<li><code>dtype</code> is the data type of the values in the generated matrix; keep the default of <code>tf.float32</code>. In this case, don't explicitly set the dtype (just let it use the default value).</li>
</ul>
<p>Set the standard deviation of the random values to 0.1</p>
<ul class="org-ul">
<li>The values generated have a mean of 0 and standard deviation of 1.</li>
<li>Set the default standard deviation <code>stdev</code> to be 0.1 by multiplying the standard deviation to each of the values in the weight matrix.</li>
</ul>
<p>See how the fastmath.trax.random.normal function works.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">get_prng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"The random seed generated by random.get_prng"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_key</span><span class="p">)</span>
</pre></div>
<pre class="example">
WARNING:absl:No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
The random seed generated by random.get_prng
DeviceArray([0, 1], dtype=uint32)
</pre>
<p>For some reason tensorflow can't find the GPU. Setting the log level to 0 like the message suggests shows that it gives up after trying to find a TPU, there's no indication that it's looking for the GPU.</p>
<div class="highlight">
<pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">gpu_device_name</span><span class="p">())</span>
</pre></div>
<p>Hmmm. I'll have to troubleshoot that.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"choose a matrix with 2 rows and 3 columns"</span><span class="p">)</span>
<span class="n">tmp_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_shape</span><span class="p">)</span>
</pre></div>
<pre class="example">
choose a matrix with 2 rows and 3 columns
(2, 3)
</pre>
<p>Generate a weight matrix Note that you'll get an error if you try to set dtype to tf.float32, where tf is tensorflow Just avoid setting the dtype and allow it to use the default data type</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_weight</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">tmp_key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">tmp_shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Weight matrix generated with a normal distribution with mean 0 and stdev of 1"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_weight</span><span class="p">)</span>
</pre></div>
<pre class="example">
Weight matrix generated with a normal distribution with mean 0 and stdev of 1
DeviceArray([[ 0.957307  , -0.9699291 ,  1.0070664 ],
             [ 0.36619022,  0.17294823,  0.29092228]], dtype=float32)
</pre>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Dense</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A dense (fully-connected) layer.</span>

<span class="sd">    Args:</span>
<span class="sd">     - n_units: the number of columns for our weight matrix</span>
<span class="sd">     - init_stdev: standard deviation for our initial weights</span>
<span class="sd">    """</span>
    <span class="n">n_units</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">init_stdev</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.1</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""The dot product of the input and the weights</span>

<span class="sd">       Args:</span>
<span class="sd">        x: input to multipyl</span>

<span class="sd">       Returns:</span>
<span class="sd">        product of x and weights</span>
<span class="sd">       """</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_weights_and_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_signature</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
                               <span class="n">random_key</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""initializes the weights</span>

<span class="sd">       Args:</span>
<span class="sd">        input_signature: tuple whose final dimension will be the number of rows</span>
<span class="sd">        random_ke: something to start the random normal generator with</span>
<span class="sd">       """</span>
        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_signature</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># to allow for more than two-dimensional matrices,</span>
        <span class="c1"># we use the last column of the input shape, rather than assuming it's</span>
        <span class="c1"># column 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">random_key</span><span class="p">,</span>
                                      <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span><span class="p">))</span>
             <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_stdev</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">dense_layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1">#sets  number of units in dense layer</span>
<span class="n">random_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">get_prng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sets random seed</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">]])</span> <span class="c1"># input array </span>

<span class="n">dense_layer</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Weights are</span><span class="se">\n</span><span class="s2"> "</span><span class="p">,</span><span class="n">dense_layer</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="c1">#Returns randomly generated weights</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">dense_layer</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Foward function output is "</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="c1"># Returns multiplied values of units and weights</span>

<span class="n">expected_weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="o">-</span><span class="mf">0.02837108</span><span class="p">,</span>  <span class="mf">0.09368162</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10050076</span><span class="p">,</span>  <span class="mf">0.14165013</span><span class="p">,</span>  <span class="mf">0.10543301</span><span class="p">,</span>  <span class="mf">0.09108126</span><span class="p">,</span>
     <span class="o">-</span><span class="mf">0.04265672</span><span class="p">,</span>  <span class="mf">0.0986188</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.05575325</span><span class="p">,</span>  <span class="mf">0.00153249</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="mf">0.20785688</span><span class="p">,</span>  <span class="mf">0.0554837</span><span class="p">,</span>   <span class="mf">0.09142365</span><span class="p">,</span>  <span class="mf">0.05744595</span><span class="p">,</span>  <span class="mf">0.07227863</span><span class="p">,</span>  <span class="mf">0.01210617</span><span class="p">,</span>
     <span class="o">-</span><span class="mf">0.03237354</span><span class="p">,</span>  <span class="mf">0.16234995</span><span class="p">,</span>  <span class="mf">0.02450038</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.13809784</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="mf">0.06111237</span><span class="p">,</span>  <span class="mf">0.01403724</span><span class="p">,</span>  <span class="mf">0.08410042</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1094358</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.10775021</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.11396459</span><span class="p">,</span>
     <span class="o">-</span><span class="mf">0.05933381</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01557652</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.03832145</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.11144515</span><span class="p">]])</span>

<span class="n">expected_output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[[</span><span class="o">-</span><span class="mf">3.0395496</span><span class="p">,</span>   <span class="mf">0.9266802</span><span class="p">,</span>   <span class="mf">2.5414743</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.050473</span><span class="p">,</span>   <span class="o">-</span><span class="mf">1.9769388</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.582209</span><span class="p">,</span>
      <span class="o">-</span><span class="mf">1.7952735</span><span class="p">,</span>   <span class="mf">0.94427425</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8980402</span><span class="p">,</span>  <span class="o">-</span><span class="mf">3.7497487</span><span class="p">]])</span>

<span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dense_layer</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">expected_weights</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">expected_output</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
</pre></div>
<pre class="example">
Weights are
  [[-0.02837108  0.09368162 -0.10050076  0.14165013  0.10543301  0.09108126
  -0.04265672  0.0986188  -0.05575325  0.00153249]
 [-0.20785688  0.0554837   0.09142365  0.05744595  0.07227863  0.01210617
  -0.03237354  0.16234995  0.02450038 -0.13809784]
 [-0.06111237  0.01403724  0.08410042 -0.1094358  -0.10775021 -0.11396459
  -0.05933381 -0.01557652 -0.03832145 -0.11144515]]
Foward function output is  [[-3.03954965  0.92668021  2.54147445 -2.05047299 -1.97693891 -2.58220917
  -1.79527355  0.94427423 -0.89804017 -3.74974866]]
</pre></div>
</div>
<div class="outline-3" id="outline-container-org595d2f6">
<h3 id="org595d2f6">The Layers for the Trax-Based Model</h3>
<div class="outline-text-3" id="text-org595d2f6">
<p>For the model implementation we will use the Trax layers library. Trax layers are very similar to the ones we implemented above, but in addition to trainable weights they also have a non-trainable state. This state is used in layers like batch normalization and for inference - we will learn more about it later on.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org5e34245">
<h3 id="org5e34245">Dense</h3>
<div class="outline-text-3" id="text-org5e34245">
<p>First, look at the code of the Trax Dense layer and compare to the implementation above.</p>
<ul class="org-ul">
<li><a href="https://github.com/google/trax/blob/master/trax/layers/core.py#L29">Trax Dense layer implementation</a></li>
</ul>
<p>Another other important layer that we will use a lot is the <a href="https://github.com/google/trax/blob/master/trax/layers/combinators.py#L26">Serial</a> layer which allows us to execute one layer after another in sequence.</p>
<ul class="org-ul">
<li>You can pass in the layers as arguments to <code>Serial</code>, separated by commas.</li>
<li>For example: <code>tl.Serial(tl.Embeddings(...), tl.Mean(...), tl.Dense(...), tl.LogSoftmax(...))</code></li>
</ul>
<p>The layer classes have pretty good docstrings, unlike the fastmath stuff, so it might be useful to look at it - but it's too long to include here.</p>
<p>We're also going to use an <a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L113">Embedding</a></p>
<ul class="org-ul">
<li><code>tl.Embedding(vocab_size, d_feature)</code>.</li>
<li><code>vocab_size</code> is the number of unique words in the given vocabulary.</li>
<li><code>d_feature</code> is the number of elements in the word embedding (some choices for a word embedding size range from 150 to 300, for example).</li>
</ul>
<div class="highlight">
<pre><span></span><span class="n">tmp_embed</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">d_feature</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_embed</span><span class="p">)</span>
</pre></div>
<pre class="example">
Embedding_3_2
</pre>
<p>Another useful layer is the <a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L276">Mean</a> which calculates means across an axis. In this case, use axis = 1 (across rows) to get an average embedding vector (an embedding vector that is an average of all words in the vocabulary).</p>
<ul class="org-ul">
<li>For example, if the embedding matrix is 300 elements and vocab size is 10,000 words, taking the mean of the embedding matrix along axis=1 will yield a vector of 300 elements.</li>
</ul>
<p>Pretend the embedding matrix uses 2 elements for embedding the meaning of a word and has a vocabulary size of 3, so it has shape (2,3).</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_embed</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,],</span>
                         <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
                         <span class="p">])</span>
</pre></div>
<p>First take the mean along axis 0, which creates a vector whose length equals the vocabulary size (the number of columns).</p>
<div class="highlight">
<pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp_embed</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
<pre class="example">
array([2.5, 3.5, 4.5])
</pre>
<p>If you take the mean along axis 1 it creates a vector whose length equals the number of elements in a word embedding (the rows).</p>
<div class="highlight">
<pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp_embed</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
<pre class="example">
array([2., 5.])
</pre>
<p>Finally, a <a href="https://github.com/google/trax/blob/1372b903bb66b0daccee19fd0b1fdf44f659330b/trax/layers/core.py#L242">LogSoftmax</a> layer gives you a log-softmax output.</p>
</div>
<div class="outline-4" id="outline-container-orgb8e3e42">
<h4 id="orgb8e3e42">Online Documentation</h4>
<div class="outline-text-4" id="text-orgb8e3e42">
<p>For completeness, here's some links to the Read the Docs documentation for these layers.</p>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Dense">Dense</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#module-trax.layers.combinators">Serial</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Embedding">Embedding</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.Mean">Mean</a></li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.core.LogSoftmax">LogSoftmax</a></li>
</ul>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgebd62dd">
<h3 id="orgebd62dd">The Classifier Function</h3>
<div class="outline-text-3" id="text-orgebd62dd">
<div class="highlight">
<pre><span></span><span class="n">builder</span> <span class="o">=</span> <span class="n">TensorBuilder</span><span class="p">()</span>
<span class="n">size_of_vocabulary</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">classifier</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">size_of_vocabulary</span><span class="p">,</span>
               <span class="n">embedding_dim</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
               <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
    <span class="sd">"""Creates the classifier model</span>

<span class="sd">    Args:</span>
<span class="sd">     vocab_size: number of tokens in the training vocabulary</span>
<span class="sd">     embedding_dim: output dimension for the Embedding layer</span>
<span class="sd">     output_dim: dimension for the Dense layer</span>

<span class="sd">    Returns:</span>
<span class="sd">     the composed layer-model</span>
<span class="sd">    """</span>
    <span class="n">embed_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
        <span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="c1"># Size of the vocabulary</span>
        <span class="n">d_feature</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">)</span>  <span class="c1"># Embedding dimension</span>

    <span class="n">mean_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">dense_output_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span> <span class="o">=</span> <span class="n">output_dim</span><span class="p">)</span>

    <span class="n">log_softmax_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
      <span class="n">embed_layer</span><span class="p">,</span>
      <span class="n">mean_layer</span><span class="p">,</span>
      <span class="n">dense_output_layer</span><span class="p">,</span>
      <span class="n">log_softmax_layer</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">tmp_model</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_model</span><span class="p">)</span>
</pre></div>
<pre class="example">
&lt;class 'trax.layers.combinators.Serial'&gt;
Serial[
  Embedding_9164_256
  Mean
  Dense_2
  LogSoftmax
]
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org57ccf9a">
<h2 id="org57ccf9a">Ending</h2>
<div class="outline-text-2" id="text-org57ccf9a">
<p>Now that we have our Deep Learning model, we'll move on to <a href="posts/nlp/sentiment-analysis-training-the-model/">training it</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/sentiment-analysis-pre-processing-the-data/">Sentiment Analysis: Pre-processing the Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/" rel="bookmark"><time class="published dt-published" datetime="2020-12-23T15:43:02-08:00" itemprop="datePublished" title="2020-12-23 15:43">2020-12-23 15:43</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org47f4c1e">Beginning</a>
<ul>
<li>
<ul>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orga52990a">Imports</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org741dfb7">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org2957940">Middle</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orga3c1a3e">The NLTK Data</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org9135aff">Split It Up</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org8bddb04">Split positive set into validation and training</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orgca75864">Split negative set into validation and training</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orgd10c179">Combine the Data Sets</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org1a18030">Building the vocabulary</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org4326617">Converting a tweet to a tensor</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orgc0d974a">Creating a batch generator</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orga55ad22">data_generator</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org3972eb2">Test the train_generator</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org9a64226">Bundle It Up</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orga513780">Imports</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org431f777">Defaults</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org2db9bc6">NLTK Settings</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org9e891c9">Special Tokens</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org4771ee4">The Builder</a></li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#orgdc3cfe3">The Generator</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org5c773c5">Test It Out</a></li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/#org5c4395a">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org47f4c1e">
<h2 id="org47f4c1e">Beginning</h2>
<div class="outline-text-2" id="text-org47f4c1e">
<p>This is the next in a series about building a Deep Learning model for sentiment analysis. The first post was <a href="posts/nlp/sentiment-analysis-deep-learning-model/">this one</a>.</p>
</div>
<div class="outline-4" id="outline-container-orga52990a">
<h4 id="orga52990a">Imports</h4>
<div class="outline-text-4" id="text-orga52990a">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">contain_exactly</span><span class="p">,</span> <span class="n">equal</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>

<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org741dfb7">
<h3 id="org741dfb7">Set Up</h3>
<div class="outline-text-3" id="text-org741dfb7">
<p>The NLTK data has to be downloaded at least once.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"twitter_samples"</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="s2">"~/data/datasets/nltk_data/"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2957940">
<h2 id="org2957940">Middle</h2>
<div class="outline-text-2" id="text-org2957940"></div>
<div class="outline-3" id="outline-container-orga3c1a3e">
<h3 id="orga3c1a3e">The NLTK Data</h3>
<div class="outline-text-3" id="text-orga3c1a3e">
<div class="highlight">
<pre><span></span><span class="n">positive</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'positive_tweets.json'</span><span class="p">)</span>
<span class="n">negative</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="s1">'negative_tweets.json'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Positive Tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Negative Tweets: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">negative</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Positive Tweets: 5,000
Negative Tweets: 5,000
</pre></div>
</div>
<div class="outline-3" id="outline-container-org9135aff">
<h3 id="org9135aff">Split It Up</h3>
<div class="outline-text-3" id="text-org9135aff">
<p>Instead of randomly splitting the data we're going to do a straight slice.</p>
<div class="highlight">
<pre><span></span><span class="n">SPLIT</span> <span class="o">=</span> <span class="mi">4000</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org8bddb04">
<h4 id="org8bddb04">Split positive set into validation and training</h4>
<div class="outline-text-4" id="text-org8bddb04">
<div class="highlight">
<pre><span></span><span class="n">positive_validation</span>   <span class="o">=</span> <span class="n">positive</span><span class="p">[</span><span class="n">SPLIT</span><span class="p">:]</span>
<span class="n">positive_training</span>  <span class="o">=</span> <span class="n">positive</span><span class="p">[:</span><span class="n">SPLIT</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgca75864">
<h4 id="orgca75864">Split negative set into validation and training</h4>
<div class="outline-text-4" id="text-orgca75864">
<div class="highlight">
<pre><span></span><span class="n">negative_validation</span> <span class="o">=</span> <span class="n">negative</span><span class="p">[</span><span class="n">SPLIT</span><span class="p">:]</span>
<span class="n">negative_training</span>  <span class="o">=</span> <span class="n">negative</span><span class="p">[:</span><span class="n">SPLIT</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd10c179">
<h4 id="orgd10c179">Combine the Data Sets</h4>
<div class="outline-text-4" id="text-orgd10c179">
<p>The X data.</p>
<div class="highlight">
<pre><span></span><span class="n">train_x</span> <span class="o">=</span> <span class="n">positive_training</span> <span class="o">+</span> <span class="n">negative_training</span>
<span class="n">validation_x</span> <span class="o">=</span> <span class="n">positive_validation</span> <span class="o">+</span> <span class="n">negative_validation</span>
</pre></div>
<p>The labels (1 for positive, 0 for negative).</p>
<div class="highlight">
<pre><span></span><span class="n">train_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_training</span><span class="p">)),</span>
                       <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">negative_training</span><span class="p">)))</span>
<span class="n">validation_y</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">)),</span>
                             <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">negative_validation</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"length of train_x </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"length of validation_x </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_x</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
length of train_x 8,000
length of validation_x 2,000
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1a18030">
<h3 id="org1a18030">Building the vocabulary</h3>
<div class="outline-text-3" id="text-org1a18030">
<p>Now build the vocabulary.</p>
<ul class="org-ul">
<li>Map each word in each tweet to an integer (an "index").</li>
<li>The following code does this for you, but please read it and understand what it's doing.</li>
<li>Note that you will build the vocabulary based on the training data.</li>
<li>To do so, you will assign an index to everyword by iterating over your training set.</li>
</ul>
<p>The vocabulary will also include some special tokens</p>
<ul class="org-ul">
<li><code>__PAD__</code>: padding</li>
<li><code>&lt;/e&gt;</code>: end of line</li>
<li><code>__UNK__</code>: a token representing any word that is not in the vocabulary.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="n">Tokens</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s2">"__PAD__"</span><span class="p">,</span> <span class="n">ending</span><span class="o">=</span><span class="s2">"__&lt;/e&gt;__"</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s2">"__UNK__"</span><span class="p">)</span>
<span class="n">process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
<span class="n">vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">Tokens</span><span class="o">.</span><span class="n">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Tokens</span><span class="o">.</span><span class="n">ending</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Tokens</span><span class="o">.</span><span class="n">unknown</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">train_x</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
            <span class="n">vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Words in the vocabulary: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
<pre class="example">
Words in the vocabulary: 9,164
0: __PAD__: 0
1: __&lt;/e&gt;__: 1
2: __UNK__: 2
3: followfriday: 3
4: top: 4
</pre></div>
</div>
<div class="outline-3" id="outline-container-org4326617">
<h3 id="org4326617">Converting a tweet to a tensor</h3>
<div class="outline-text-3" id="text-org4326617">
<p>Now we'll write a function that will convert each tweet to a tensor (a list of unique integer IDs representing the processed tweet).</p>
<ul class="org-ul">
<li>Note, the returned data type will be a <b>regular Python `list()`</b>
<ul class="org-ul">
<li>You won't use TensorFlow in this function</li>
<li>You also won't use a numpy array</li>
<li>You also won't use trax.fastmath.numpy array</li>
</ul>
</li>
<li>
<p>For words in the tweet that are not in the vocabulary, set them to the unique ID for the token `__UNK__`.</p>
<p>For example, given this string:</p>
</li>
</ul>
<pre class="example">
'@happypuppy, is Maria happy?'
</pre>
<p>You first tokenize it.</p>
<pre class="example">
['maria', 'happi']
</pre>
<p>Then convert each word into the index for it.</p>
<pre class="example">
[2, 56]
</pre>
<p>Notice that the word "maria" is not in the vocabulary, so it is assigned the unique integer associated with the <code>__UNK__</code> token, because it is considered "unknown."</p>
<div class="highlight">
<pre><span></span><span class="c1"># UNQ_C1 (UNIQUE CELL IDENTIFIER, DO NOT EDIT)</span>
<span class="c1"># GRADED FUNCTION: tweet_to_tensor</span>
<span class="k">def</span> <span class="nf">tweet_to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                    <span class="n">unk_token</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">'__UNK__'</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Convert a tweet to a list of indices</span>

<span class="sd">    Args: </span>
<span class="sd">       tweet - A string containing a tweet</span>
<span class="sd">       vocab_dict - The words dictionary</span>
<span class="sd">       unk_token - The special string for unknown tokens</span>
<span class="sd">       verbose - Print info during runtime</span>

<span class="sd">    Returns:</span>
<span class="sd">       tensor_l - A python list with indices for the tweet tokens</span>
<span class="sd">    """</span>

    <span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
    <span class="c1"># Process the tweet into a list of words</span>
    <span class="c1"># where only important words are kept (stop words removed)</span>
    <span class="n">word_l</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"List of words from the processed tweet:"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">word_l</span><span class="p">)</span>

    <span class="c1"># Initialize the list that will contain the unique integer IDs of each word</span>
    <span class="n">tensor_l</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get the unique integer ID of the __UNK__ token</span>
    <span class="n">unk_ID</span> <span class="o">=</span> <span class="n">vocab_dict</span><span class="p">[</span><span class="n">unk_token</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The unique integer ID for the unk_token is </span><span class="si">{</span><span class="n">unk_ID</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># for each word in the list:</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_l</span><span class="p">:</span>

        <span class="c1"># Get the unique integer ID.</span>
        <span class="c1"># If the word doesn't exist in the vocab dictionary,</span>
        <span class="c1"># use the unique ID for __UNK__ instead.</span>
        <span class="n">word_ID</span> <span class="o">=</span> <span class="n">vocab_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">unk_ID</span><span class="p">)</span>
    <span class="c1">### END CODE HERE ###</span>

        <span class="c1"># Append the unique integer ID to the tensor list.</span>
        <span class="n">tensor_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_ID</span><span class="p">)</span> 

    <span class="k">return</span> <span class="n">tensor_l</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Actual tweet is</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">positive_validation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Tensor of tweet:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vocab_dict</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">))</span>
</pre></div>
<pre class="example">
Actual tweet is
 Bro:U wan cut hair anot,ur hair long Liao bo
Me:since ord liao,take it easy lor treat as save $ leave it longer :)
Bro:LOL Sibei xialan

Tensor of tweet:
 [1072, 96, 484, 2376, 750, 8220, 1132, 750, 53, 2, 2701, 796, 2, 2, 354, 606, 2, 3523, 1025, 602, 4599, 9, 1072, 158, 2, 2]
</pre>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_tweet_to_tensor</span><span class="p">():</span>
    <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[</span>

        <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span><span class="s2">"simple_test_check"</span><span class="p">,</span>
            <span class="s2">"input"</span><span class="p">:</span> <span class="p">[</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vocabulary</span><span class="p">],</span>
            <span class="s2">"expected"</span><span class="p">:[</span><span class="mi">444</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">567</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
            <span class="s2">"error"</span><span class="p">:</span><span class="s2">"The function gives bad output for val_pos[1]. Test failed"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span><span class="s2">"datatype_check"</span><span class="p">,</span>
            <span class="s2">"input"</span><span class="p">:[</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vocabulary</span><span class="p">],</span>
            <span class="s2">"expected"</span><span class="p">:</span><span class="nb">type</span><span class="p">([]),</span>
            <span class="s2">"error"</span><span class="p">:</span><span class="s2">"Datatype mismatch. Need only list not np.array"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span><span class="s2">"without_unk_check"</span><span class="p">,</span>
            <span class="s2">"input"</span><span class="p">:[</span><span class="n">positive_validation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vocabulary</span><span class="p">],</span>
            <span class="s2">"expected"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span>
            <span class="s2">"error"</span><span class="p">:</span><span class="s2">"Unk word check not done- Please check if you included mapping for unknown word"</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">test_case</span> <span class="ow">in</span> <span class="n">test_cases</span><span class="p">:</span>        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_case</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"simple_test_check"</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">test_case</span><span class="p">[</span><span class="s2">"expected"</span><span class="p">]</span> <span class="o">==</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'input'</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">test_case</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"datatype_check"</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tweet_to_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'input'</span><span class="p">]),</span> <span class="n">test_case</span><span class="p">[</span><span class="s2">"expected"</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">test_case</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"without_unk_check"</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'input'</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">test_case</span><span class="p">[</span><span class="s1">'error'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\033</span><span class="s2">[92m All tests passed"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="s2">" Tests passed out of 3"</span><span class="p">)</span>
<span class="n">test_tweet_to_tensor</span><span class="p">()</span>            
</pre></div>
<pre class="example">
The function gives bad output for val_pos[1]. Test failed
2  Tests passed out of 3
</pre>
<p>Their tweet processor wipes out everything after the start of a URL, even if it isn't part of the URL, so they have fewer tokens, so the indices won't match exactly.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgc0d974a">
<h3 id="orgc0d974a">Creating a batch generator</h3>
<div class="outline-text-3" id="text-orgc0d974a">
<p>Most of the time in Natural Language Processing, and AI in general we use batches when training our data sets.</p>
<ul class="org-ul">
<li>If instead of training with batches of examples, you were to train a model with one example at a time, it would take a very long time to train the model.</li>
<li>You will now build a data generator that takes in the positive/negative tweets and returns a batch of training examples. It returns the model inputs, the targets (positive or negative labels) and the weight for each target (ex: this allows us to treat some examples as more important to get right than others, but commonly this will all be 1.0).</li>
</ul>
<p>Once you create the generator, you could include it in a for loop:</p>
<pre class="example">
for batch_inputs, batch_targets, batch_example_weights in data_generator:
</pre>
<p>You can also get a single batch like this:</p>
<pre class="example">
batch_inputs, batch_targets, batch_example_weights = next(data_generator)
</pre>
<p>The generator returns the next batch each time it's called.</p>
<ul class="org-ul">
<li>This generator returns the data in a format (tensors) that you could directly use in your model.</li>
<li>It returns a triple: the inputs, targets, and loss weights:</li>
</ul>
<p>– Inputs is a tensor that contains the batch of tweets we put into the model. – Targets is the corresponding batch of labels that we train to generate. – Loss weights here are just 1s with same shape as targets. Next week, you will use it to mask input padding.</p>
</div>
<div class="outline-4" id="outline-container-orga55ad22">
<h4 id="orga55ad22">data_generator</h4>
<div class="outline-text-4" id="text-orga55ad22">
<p>A batch of spaghetti.</p>
<div class="highlight">
<pre><span></span><span class="c1"># UNQ_C2 (UNIQUE CELL IDENTIFIER, DO NOT EDIT)</span>
<span class="c1"># GRADED: Data generator</span>
<span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">data_pos</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">data_neg</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">loop</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Generates batches of data</span>

<span class="sd">    Args: </span>
<span class="sd">       data_pos - Set of positive examples</span>
<span class="sd">       data_neg - Set of negative examples</span>
<span class="sd">       batch_size - number of samples per batch. Must be even</span>
<span class="sd">       loop - True or False</span>
<span class="sd">       vocab_dict - The words dictionary</span>
<span class="sd">       shuffle - Shuffle the data order</span>

<span class="sd">    Yield:</span>
<span class="sd">       inputs - Subset of positive and negative examples</span>
<span class="sd">       targets - The corresponding labels for the subset</span>
<span class="sd">       example_weights - An array specifying the importance of each example        </span>
<span class="sd">    """</span>
<span class="c1">### START GIVEN CODE ###</span>
    <span class="c1"># make sure the batch size is an even number</span>
    <span class="c1"># to allow an equal number of positive and negative samples</span>
    <span class="k">assert</span> <span class="n">batch_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Number of positive examples in each batch is half of the batch size</span>
    <span class="c1"># same with number of negative examples in each batch</span>
    <span class="n">n_to_take</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># Use pos_index to walk through the data_pos array</span>
    <span class="c1"># same with neg_index and data_neg</span>
    <span class="n">pos_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">neg_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">len_data_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_pos</span><span class="p">)</span>
    <span class="n">len_data_neg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_neg</span><span class="p">)</span>

    <span class="c1"># Get and array with the data indexes</span>
    <span class="n">pos_index_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">len_data_pos</span><span class="p">))</span>
    <span class="n">neg_index_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">len_data_neg</span><span class="p">))</span>

    <span class="c1"># shuffle lines if shuffle is set to True</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pos_index_lines</span><span class="p">)</span>
        <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">neg_index_lines</span><span class="p">)</span>

    <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Loop indefinitely</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>  

        <span class="c1"># create a batch with positive and negative examples</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># First part: Pack n_to_take positive examples</span>

        <span class="c1"># Start from pos_index and increment i up to n_to_take</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_to_take</span><span class="p">):</span>

            <span class="c1"># If the positive index goes past the positive dataset length,</span>
            <span class="k">if</span> <span class="n">pos_index</span> <span class="o">&gt;=</span> <span class="n">len_data_pos</span><span class="p">:</span> 

                <span class="c1"># If loop is set to False, break once we reach the end of the dataset</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="c1"># If user wants to keep re-using the data, reset the index</span>
                <span class="n">pos_index</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                    <span class="c1"># Shuffle the index of the positive sample</span>
                    <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pos_index_lines</span><span class="p">)</span>

            <span class="c1"># get the tweet as pos_index</span>
            <span class="n">tweet</span> <span class="o">=</span> <span class="n">data_pos</span><span class="p">[</span><span class="n">pos_index_lines</span><span class="p">[</span><span class="n">pos_index</span><span class="p">]]</span>

            <span class="c1"># convert the tweet into tensors of integers representing the processed words</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">)</span>

            <span class="c1"># append the tensor to the batch list</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

            <span class="c1"># Increment pos_index by one</span>
            <span class="n">pos_index</span> <span class="o">=</span> <span class="n">pos_index</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1">### END GIVEN CODE ###</span>

<span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>

        <span class="c1"># Second part: Pack n_to_take negative examples</span>

        <span class="c1"># Using the same batch list, start from neg_index and increment i up to n_to_take</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neg_index</span><span class="p">,</span> <span class="n">n_to_take</span><span class="p">):</span>

            <span class="c1"># If the negative index goes past the negative dataset length,</span>
            <span class="k">if</span> <span class="n">neg_index</span> <span class="o">&gt;</span> <span class="n">len_data_neg</span><span class="p">:</span>

                <span class="c1"># If loop is set to False, break once we reach the end of the dataset</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="c1"># If user wants to keep re-using the data, reset the index</span>
                <span class="n">neg_index</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                    <span class="c1"># Shuffle the index of the negative sample</span>
                    <span class="n">rnd</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">neg_index_lines</span><span class="p">)</span>
            <span class="c1"># get the tweet at neg_index</span>
            <span class="n">tweet</span> <span class="o">=</span> <span class="n">data_neg</span><span class="p">[</span><span class="n">neg_index_lines</span><span class="p">[</span><span class="n">neg_index</span><span class="p">]]</span>

            <span class="c1"># convert the tweet into tensors of integers representing the processed words</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">tweet_to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">,</span> <span class="n">vocab_dict</span><span class="p">)</span>

            <span class="c1"># append the tensor to the batch list</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

            <span class="c1"># Increment neg_index by one</span>
            <span class="n">neg_index</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1">### END CODE HERE ###        </span>

<span class="c1">### START GIVEN CODE ###</span>
        <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1"># Update the start index for positive data </span>
        <span class="c1"># so that it's n_to_take positions after the current pos_index</span>
        <span class="n">pos_index</span> <span class="o">+=</span> <span class="n">n_to_take</span>

        <span class="c1"># Update the start index for negative data </span>
        <span class="c1"># so that it's n_to_take positions after the current neg_index</span>
        <span class="n">neg_index</span> <span class="o">+=</span> <span class="n">n_to_take</span>

        <span class="c1"># Get the max tweet length (the length of the longest tweet) </span>
        <span class="c1"># (you will pad all shorter tweets to have this length)</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span> 


        <span class="c1"># Initialize the input_l, which will </span>
        <span class="c1"># store the padded versions of the tensors</span>
        <span class="n">tensor_pad_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Pad shorter tweets with zeros</span>
        <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
<span class="c1">### END GIVEN CODE ###</span>

<span class="c1">### START CODE HERE (Replace instances of 'None' with your code) ###</span>
            <span class="c1"># Get the number of positions to pad for this tensor so that it will be max_len long</span>
            <span class="n">n_pad</span> <span class="o">=</span> <span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

            <span class="c1"># Generate a list of zeros, with length n_pad</span>
            <span class="n">pad_l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_pad</span>

            <span class="c1"># concatenate the tensor and the list of padded zeros</span>
            <span class="n">tensor_pad</span> <span class="o">=</span> <span class="n">tensor</span> <span class="o">+</span> <span class="n">pad_l</span>

            <span class="c1"># append the padded tensor to the list of padded tensors</span>
            <span class="n">tensor_pad_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor_pad</span><span class="p">)</span>

        <span class="c1"># convert the list of padded tensors to a numpy array</span>
        <span class="c1"># and store this as the model inputs</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tensor_pad_l</span><span class="p">)</span>

        <span class="c1"># Generate the list of targets for the positive examples (a list of ones)</span>
        <span class="c1"># The length is the number of positive examples in the batch</span>
        <span class="n">target_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[:</span><span class="n">n_to_take</span><span class="p">])</span>

        <span class="c1"># Generate the list of targets for the negative examples (a list of zeros)</span>
        <span class="c1"># The length is the number of negative examples in the batch</span>
        <span class="n">target_neg</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">n_to_take</span><span class="p">:])</span>

        <span class="c1"># Concatenate the positve and negative targets</span>
        <span class="n">target_l</span> <span class="o">=</span> <span class="n">target_pos</span> <span class="o">+</span> <span class="n">target_neg</span>

        <span class="c1"># Convert the target list into a numpy array</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_l</span><span class="p">)</span>

        <span class="c1"># Example weights: Treat all examples equally importantly.It should return an np.array. Hint: Use np.ones_like()</span>
        <span class="n">example_weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>


<span class="c1">### END CODE HERE ###</span>

<span class="c1">### GIVEN CODE ###</span>
        <span class="c1"># note we use yield and not return</span>
        <span class="k">yield</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">example_weights</span>
</pre></div>
<p>Now you can use your data generator to create a data generator for the training data, and another data generator for the validation data.</p>
<p>We will create a third data generator that does not loop, for testing the final accuracy of the model.</p>
<div class="highlight">
<pre><span></span><span class="c1"># Set the random number generator for the shuffle procedure</span>
<span class="n">rnd</span> <span class="o">=</span> <span class="n">random</span>
<span class="n">rnd</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> 

<span class="c1"># Create the training data generator</span>
<span class="k">def</span> <span class="nf">train_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">positive_training</span><span class="p">,</span> <span class="n">negative_training</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>

<span class="c1"># Create the validation data generator</span>
<span class="k">def</span> <span class="nf">val_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">,</span> <span class="n">negative_validation</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>

<span class="c1"># Create the validation data generator</span>
<span class="k">def</span> <span class="nf">test_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">positive_validation</span><span class="p">,</span> <span class="n">negative_validation</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                          <span class="kc">False</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>

<span class="c1"># Get a batch from the train_generator and inspect.</span>
<span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">example_weights</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">train_generator</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># this will print a list of 4 tensors padded with zeros</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Inputs: </span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Targets: </span><span class="si">{</span><span class="n">targets</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Example Weights: </span><span class="si">{</span><span class="n">example_weights</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example">
Inputs: [[2030 4492 3231    9    0    0    0    0    0    0    0]
 [5009  571 2025 1475 5233 3532  142 3532  132  464    9]
 [3798  111   96  587 2960 4007    0    0    0    0    0]
 [ 256 3798    0    0    0    0    0    0    0    0    0]]
Targets: [1 1 0 0]
Example Weights: [1 1 1 1]
</pre></div>
</div>
<div class="outline-4" id="outline-container-org3972eb2">
<h4 id="org3972eb2">Test the train_generator</h4>
<div class="outline-text-4" id="text-org3972eb2">
<p>Create a data generator for training data which produces batches of size 4 (for tensors and their respective targets).</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_data_gen</span> <span class="o">=</span> <span class="n">train_generator</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
<p>Call the data generator to get one batch and its targets.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_inputs</span><span class="p">,</span> <span class="n">tmp_targets</span><span class="p">,</span> <span class="n">tmp_example_weights</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_data_gen</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The inputs shape is </span><span class="si">{</span><span class="n">tmp_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The targets shape is </span><span class="si">{</span><span class="n">tmp_targets</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The example weights shape is </span><span class="si">{</span><span class="n">tmp_example_weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_inputs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"input tensor: </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">; target </span><span class="si">{</span><span class="n">tmp_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">; example weights </span><span class="si">{</span><span class="n">tmp_example_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
The inputs shape is (4, 14)
The targets shape is (4,)
The example weights shape is (4,)
input tensor: [3 4 5 6 7 8 9 0 0 0 0 0 0 0]; target 1; example weights 1
input tensor: [10 11 12 13 14 15 16 17 18 19 20  9 21 22]; target 1; example weights 1
input tensor: [5807 2931 3798    0    0    0    0    0    0    0    0    0    0    0]; target 0; example weights 1
input tensor: [ 865  261 3689 5808  313 4499  571 1248 2795  333 1220 3798    0    0]; target 0; example weights 1
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9a64226">
<h3 id="org9a64226">Bundle It Up</h3>
<div class="outline-text-3" id="text-org9a64226">
<div class="highlight">
<pre><span></span><span class="o">&lt;&lt;</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">defaults</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">nltk</span><span class="o">-</span><span class="n">settings</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">special</span><span class="o">-</span><span class="n">tokens</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">builder</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">positive</span><span class="o">-</span><span class="n">tweets</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">negative</span><span class="o">-</span><span class="n">tweets</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">positive</span><span class="o">-</span><span class="n">training</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">negative</span><span class="o">-</span><span class="n">training</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">positive</span><span class="o">-</span><span class="n">validation</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">negative</span><span class="o">-</span><span class="n">validation</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">twitter</span><span class="o">-</span><span class="n">processor</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">vocabulary</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">x</span><span class="o">-</span><span class="n">train</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">to</span><span class="o">-</span><span class="n">tensor</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">generator</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">positive</span><span class="o">-</span><span class="n">indices</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">negative</span><span class="o">-</span><span class="n">indices</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">positives</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">negatives</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">positive</span><span class="o">-</span><span class="n">generator</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">negative</span><span class="o">-</span><span class="n">generator</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">iterator</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="nb">next</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga513780">
<h4 id="orga513780">Imports</h4>
<div class="outline-text-4" id="text-orga513780">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">twitter_samples</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">.processor</span> <span class="kn">import</span> <span class="n">TwitterProcessor</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org431f777">
<h4 id="org431f777">Defaults</h4>
<div class="outline-text-4" id="text-org431f777">
<div class="highlight">
<pre><span></span><span class="n">Defaults</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">split</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2db9bc6">
<h4 id="org2db9bc6">NLTK Settings</h4>
<div class="outline-text-4" id="text-org2db9bc6">
<div class="highlight">
<pre><span></span><span class="n">NLTK</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">corpus</span><span class="o">=</span><span class="s2">"twitter_samples"</span><span class="p">,</span>
    <span class="n">negative</span> <span class="o">=</span> <span class="s2">"negative_tweets.json"</span><span class="p">,</span>
    <span class="n">positive</span><span class="o">=</span><span class="s2">"positive_tweets.json"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9e891c9">
<h4 id="org9e891c9">Special Tokens</h4>
<div class="outline-text-4" id="text-org9e891c9">
<div class="highlight">
<pre><span></span><span class="n">SpecialTokens</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="s2">"__PAD__"</span><span class="p">,</span>
                          <span class="n">ending</span><span class="o">=</span><span class="s2">"__&lt;/e&gt;__"</span><span class="p">,</span>
                          <span class="n">unknown</span><span class="o">=</span><span class="s2">"__UNK__"</span><span class="p">)</span>

<span class="n">SpecialIDs</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">ending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">unknown</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4771ee4">
<h4 id="org4771ee4">The Builder</h4>
<div class="outline-text-4" id="text-org4771ee4">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TensorBuilder</span><span class="p">:</span>
    <span class="sd">"""converts tweets to tensors</span>

<span class="sd">    Args: </span>
<span class="sd">     - split: where to split the training and validation data</span>
<span class="sd">    """</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">split</span>
    <span class="n">_positive</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_positive_training</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative_training</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_positive_validation</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative_validation</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_process</span><span class="p">:</span> <span class="n">TwitterProcessor</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_x_train</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgf21a92e"></a>Positive Tweets<br>
<div class="outline-text-5" id="text-orgf21a92e">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The raw positive NLTK tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positive</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="n">NLTK</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive</span>
</pre></div>
</div>
</li>
<li><a id="org3367a59"></a>Negative Tweets<br>
<div class="outline-text-5" id="text-org3367a59">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The raw negative NLTK tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative</span> <span class="o">=</span> <span class="n">twitter_samples</span><span class="o">.</span><span class="n">strings</span><span class="p">(</span><span class="n">NLTK</span><span class="o">.</span><span class="n">negative</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative</span>
</pre></div>
</div>
</li>
<li><a id="org6882a6f"></a>Positive Training<br>
<div class="outline-text-5" id="text-org6882a6f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive_training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The positive training data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_training</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positive_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_training</span>
</pre></div>
</div>
</li>
<li><a id="org9ddef12"></a>Negative Training<br>
<div class="outline-text-5" id="text-org9ddef12">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative_training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The negative training data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_training</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_training</span>
</pre></div>
</div>
</li>
<li><a id="org0d186d7"></a>Positive Validation<br>
<div class="outline-text-5" id="text-org0d186d7">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The positive validation data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positive_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_validation</span>
</pre></div>
</div>
</li>
<li><a id="orgaf7702c"></a>Negative Validation<br>
<div class="outline-text-5" id="text-orgaf7702c">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The negative validation data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_validation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negative_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_validation</span>
</pre></div>
</div>
</li>
<li><a id="org5b53efc"></a>Twitter Processor<br>
<div class="outline-text-5" id="text-org5b53efc">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TwitterProcessor</span><span class="p">:</span>
    <span class="sd">"""processor for tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">TwitterProcessor</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span>
</pre></div>
</div>
</li>
<li><a id="org943684d"></a>X Train<br>
<div class="outline-text-5" id="text-org943684d">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">x_train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The unprocessed training data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_training</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_training</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_train</span>
</pre></div>
</div>
</li>
<li><a id="org3d51e73"></a>The Vocabulary<br>
<div class="outline-text-5" id="text-org3d51e73">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""A map of token to numeric id"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="p">{</span><span class="n">SpecialTokens</span><span class="o">.</span><span class="n">padding</span><span class="p">:</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
                            <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">ending</span><span class="p">:</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">ending</span><span class="p">,</span>
                            <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">unknown</span><span class="p">:</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">unknown</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>
</pre></div>
</div>
</li>
<li><a id="org9fbf9f0"></a>To Tensor<br>
<div class="outline-text-5" id="text-org9fbf9f0">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tweet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Converts tweet to list of numeric identifiers</span>

<span class="sd">    Args:</span>
<span class="sd">     tweet: the string to convert</span>

<span class="sd">    Returns:</span>
<span class="sd">     list of IDs for the tweet</span>
<span class="sd">    """</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SpecialIDs</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tweet</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">tensor</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgdc3cfe3">
<h4 id="orgdc3cfe3">The Generator</h4>
<div class="outline-text-4" id="text-orgdc3cfe3">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TensorGenerator</span><span class="p">:</span>
    <span class="sd">"""Generates batches of vectorized-tweets</span>

<span class="sd">    Args:</span>
<span class="sd">     converter: TensorBuilder object</span>
<span class="sd">     positive_data: list of positive data</span>
<span class="sd">     negative_data: list of negative data</span>
<span class="sd">     batch_size: the size for each generated batch     </span>
<span class="sd">     shuffle: whether to shuffle the generated data</span>
<span class="sd">     infinite: whether to generate data forever</span>
<span class="sd">    """</span>
    <span class="n">converter</span><span class="p">:</span> <span class="n">TensorBuilder</span>
    <span class="n">positive_data</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">negative_data</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">infinite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_positive_indices</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negative_indices</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_positives</span><span class="p">:</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_negatives</span><span class="p">:</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org72e67e9"></a>Positive Indices<br>
<div class="outline-text-5" id="text-org72e67e9">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positive_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""The indices to use to grab the positive tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span>
</pre></div>
</div>
</li>
<li><a id="org28c4441"></a>Negative Indices<br>
<div class="outline-text-5" id="text-org28c4441">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negative_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Indices for the negative tweets"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negative_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span>
</pre></div>
</div>
</li>
<li><a id="orga61bc8b"></a>Positives<br>
<div class="outline-text-5" id="text-orga61bc8b">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">positives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""The positive index generator"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positives</span>
</pre></div>
</div>
</li>
<li><a id="org516d9ce"></a>Negatives<br>
<div class="outline-text-5" id="text-org516d9ce">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">negatives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""The negative index generator"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negatives</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_negatives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_generator</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negatives</span>
</pre></div>
</div>
</li>
<li><a id="orgd25b2ee"></a>Positive Generator<br>
<div class="outline-text-5" id="text-orgd25b2ee">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">positive_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Generator of indices for positive tweets"""</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_indices</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_positive_indices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org5094d2c"></a>Negative Generator<br>
<div class="outline-text-5" id="text-org5094d2c">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">negative_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""generator of indices for negative tweets"""</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negative_indices</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">infinite</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_negative_indices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
<li><a id="org2377fa0"></a>The Iterator<br>
<div class="outline-text-5" id="text-org2377fa0">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</li>
<li><a id="orgba64e1b"></a>The Next Method<br>
<div class="outline-text-5" id="text-orgba64e1b">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">half_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># get the indices</span>
    <span class="n">positives</span> <span class="o">=</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positives</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">half_batch</span><span class="p">))</span>
    <span class="n">negatives</span> <span class="o">=</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negatives</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">half_batch</span><span class="p">))</span>

    <span class="c1"># get the tweets</span>
    <span class="n">positives</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">positives</span><span class="p">)</span>
    <span class="n">negatives</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">negative_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">negatives</span><span class="p">)</span>

    <span class="c1"># get the token ids</span>
    <span class="k">try</span><span class="p">:</span>    
        <span class="n">positives</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">positives</span><span class="p">]</span>
        <span class="n">negatives</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">negatives</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="c1"># the next(self.positives) in the first generator will raise a</span>
        <span class="c1"># RuntimeError if</span>
        <span class="c1"># we're not running this infinitely</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="n">batch</span> <span class="o">=</span> <span class="n">positives</span> <span class="o">+</span> <span class="n">negatives</span>

    <span class="n">longest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">))</span>

    <span class="n">paddings</span> <span class="o">=</span> <span class="p">(</span><span class="n">longest</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span> <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
    <span class="n">paddings</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding</span> <span class="k">for</span> <span class="n">padding</span> <span class="ow">in</span> <span class="n">paddings</span><span class="p">)</span>

    <span class="n">padded</span> <span class="o">=</span> <span class="p">[</span><span class="n">tensor</span> <span class="o">+</span> <span class="n">padding</span> <span class="k">for</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">padding</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">paddings</span><span class="p">)]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">padded</span><span class="p">)</span>

    <span class="c1"># the labels for the inputs</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">half_batch</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">half_batch</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="c1"># default the weights to ones</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">weights</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org5c773c5">
<h3 id="org5c773c5">Test It Out</h3>
<div class="outline-text-3" id="text-org5c773c5">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.tensor_generator</span> <span class="kn">import</span> <span class="n">TensorBuilder</span><span class="p">,</span> <span class="n">TensorGenerator</span>

<span class="n">converter</span> <span class="o">=</span> <span class="n">TensorBuilder</span><span class="p">()</span>
<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">tweet</span> <span class="o">=</span> <span class="n">positive_validation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1072</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">484</span><span class="p">,</span> <span class="mi">2376</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">8220</span><span class="p">,</span> <span class="mi">1132</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2701</span><span class="p">,</span> <span class="mi">796</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
            <span class="mi">354</span><span class="p">,</span> <span class="mi">606</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3523</span><span class="p">,</span> <span class="mi">1025</span><span class="p">,</span> <span class="mi">602</span><span class="p">,</span> <span class="mi">4599</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1072</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<span class="n">actual</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">generator</span> <span class="o">=</span> <span class="n">TensorGenerator</span><span class="p">(</span><span class="n">converter</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">))</span>
</pre></div>
<pre class="example">
(array([[ 749, 1019,  313, 1020,   75],
       [1009,    9,    0,    0,    0],
       [3540, 6030, 6031, 3798,    0],
       [  50,   96, 3798,    0,    0]]), array([1, 1, 0, 0]), array([1, 1, 1, 1]))
</pre>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">break</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">))</span>
</pre></div>
<pre class="example">
[[  22 1228  434  354  227 2371    9]
 [ 267  160   89    0    0    0    0]
 [ 315 1008 8480 3798 2108  371 3233]
 [8232 8233  791 3798    0    0    0]]

[[1173 1061  586    9  896  729 1264  345 1062 1063]
 [3387  558  991 2166 3388 3231  558  238  120    0]
 [ 198 5997 3798    0    0    0    0    0    0    0]
 [ 223  310 3798    0    0    0    0    0    0    0]]

[[4015 4015 4015 4016  231 2117   57  422    9 4017 4018 4019   86   86]
 [2554   57  102  358   75    0    0    0    0    0    0    0    0    0]
 [  50   38  881 3798    0    0    0    0    0    0    0    0    0    0]
 [6729 6730 6731  382 3798    0    0    0    0    0    0    0    0    0]]

[[3479   75    0    0    0    0    0    0    0    0    0    0    0    0
     0    0    0]
 [4636 4637  233 4299  111  237 2626    9    0    0    0    0    0    0
     0    0    0]
 [  73  381  463 4321  142   96 7390 7391   92   85 1394 7392 5895 7393
    45 3798 7394]
 [8863 2844  991  127 5818    0    0    0    0    0    0    0    0    0
     0    0    0]]

[[ 226  615   22   75    0    0]
 [2135  703  237  435 3124    9]
 [2379 6264 3798    0    0    0]
 [6504 1912 2380 3798    0    0]]

[[5623  120    0    0    0    0    0    0    0    0]
 [ 133   54  102   63 1300   56    9   50   92 3181]
 [2094  383   73  464 3798    0    0    0    0    0]
 [ 223  101 8754  383 2085 5818 8755    0    0    0]]

(array([[ 374,   44, 2981,  435,  132,  111, 1040, 1382,    9,    0,    0,
           0],
       [ 369,  398,  283,    9, 2671, 1411,  136,  184,  769, 1262, 2061,
        3460],
       [1094, 9024,  315,  381, 3798,    0,    0,    0,    0,    0,    0,
           0],
       [9036, 3798,    0,    0,    0,    0,    0,    0,    0,    0,    0,
           0]]), array([1, 1, 0, 0]), array([1, 1, 1, 1]))
</pre>
<p>Ladies and gentlemen, we have ourselves a generator.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org5c4395a">
<h2 id="org5c4395a">End</h2>
<div class="outline-text-2" id="text-org5c4395a">
<p>Now that we have our data, the next step will be to <a href="posts/nlp/sentiment-analysis-defining-the-model/">define the model</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/sentiment-analysis-deep-learning-model/">Sentiment Analysis: Deep Learning Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/sentiment-analysis-deep-learning-model/" rel="bookmark"><time class="published dt-published" datetime="2020-12-23T15:14:07-08:00" itemprop="datePublished" title="2020-12-23 15:14">2020-12-23 15:14</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#org2cc8e2f">Beginning</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#orgea3cb7a">Imports</a></li>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#orgc5d0d34">Set Up</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#org76abe64">The Random Seed</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#org78a821a">Middle</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#orgbccfe33">Trax Review</a>
<ul>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#org7852b4c">JAX Arrays</a></li>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#orged57bc1">Squaring</a></li>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#orgf9af129">Gradients</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#org12033e6">End</a></li>
<li><a href="posts/nlp/sentiment-analysis-deep-learning-model/#org2190c98">Raw</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org2cc8e2f">
<h2 id="org2cc8e2f">Beginning</h2>
<div class="outline-text-2" id="text-org2cc8e2f">
<p>Previously we created sentiment analysis models using the Logistic Regression and Naive Bayes algorithms. However if we were to give those models an example like:</p>
<blockquote>
<p>This movie was almost good.</p>
</blockquote>
<p>The model would have predicted a positive sentiment for that review. That sentence, however, is expressing the negative sentiment that the movie was not good. To solve those kinds of misclassifications we will write a program that uses deep neural networks to identify sentiment in text.</p>
<p>This model will follow a similar structure to the Continuous Bag of Words Model (<a href="posts/nlp/introducing-the-cbow-model/">Introducing the CBOW Model</a>) that we looked at previously - indeed most of the deep nets have a similar structure. The only thing that changes is the model architecture, the inputs, and the outputs. Although we looked at <a href="https://github.com/google/trax">Trax</a> and <a href="https://jax.readthedocs.io/en/latest/index.html">JAX</a> in a previous post (<a href="posts/nlp/introducing-trax/">Introducing Trax</a>) we'll start off with a review of some of their features and then in future posts we'll implement the actual model. These are the other posts.</p>
<ul class="org-ul">
<li><a href="posts/nlp/sentiment-analysis-pre-processing-the-data/">Loading the Data</a></li>
<li><a href="posts/nlp/sentiment-analysis-defining-the-model/">Defining the Model</a></li>
<li><a href="posts/nlp/sentiment-analysis-training-the-model/">Training the Model</a></li>
<li><a href="posts/nlp/sentiment-analysis-testing-the-model/">Testing the Model</a></li>
</ul>
</div>
<div class="outline-3" id="outline-container-orgea3cb7a">
<h3 id="orgea3cb7a">Imports</h3>
<div class="outline-text-3" id="text-orgea3cb7a">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">import</span> <span class="nn">trax</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc5d0d34">
<h3 id="orgc5d0d34">Set Up</h3>
<div class="outline-text-3" id="text-orgc5d0d34"></div>
<div class="outline-4" id="outline-container-org76abe64">
<h4 id="org76abe64">The Random Seed</h4>
<div class="outline-text-4" id="text-org76abe64">
<div class="highlight">
<pre><span></span><span class="n">trax</span><span class="o">.</span><span class="n">supervised</span><span class="o">.</span><span class="n">trainer_lib</span><span class="o">.</span><span class="n">init_random_number_generators</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org78a821a">
<h2 id="org78a821a">Middle</h2>
<div class="outline-text-2" id="text-org78a821a"></div>
<div class="outline-3" id="outline-container-orgbccfe33">
<h3 id="orgbccfe33">Trax Review</h3>
<div class="outline-text-3" id="text-orgbccfe33"></div>
<div class="outline-4" id="outline-container-org7852b4c">
<h4 id="org7852b4c">JAX Arrays</h4>
<div class="outline-text-4" id="text-org7852b4c">
<p>First, the JAX reimplementation of numpy (from <a href="https://trax-ml.readthedocs.io/en/latest/trax.fastmath.html">Trax.fastmath</a>).</p>
<div class="highlight">
<pre><span></span><span class="n">an_array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">an_array</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">an_array</span><span class="p">))</span>
</pre></div>
<pre class="example">
DeviceArray(5., dtype=float32)
&lt;class 'jax.interpreters.xla._DeviceArray'&gt;
</pre>
<p><b>Note:</b> the trax library is strict about the typing so <code>5</code> won't work, it has to be a float.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orged57bc1">
<h4 id="orged57bc1">Squaring</h4>
<div class="outline-text-4" id="text-orged57bc1">
<p>Now we'll create a function to square the array.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"f(</span><span class="si">{</span><span class="n">an_array</span><span class="si">}</span><span class="s2">) -&gt; </span><span class="si">{</span><span class="n">square</span><span class="p">(</span><span class="n">an_array</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
f(5.0) -&gt; 25.0
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgf9af129">
<h4 id="orgf9af129">Gradients</h4>
<div class="outline-text-4" id="text-orgf9af129">
<p>The gradient (derivative) of function <code>f</code> with respect to its input <code>x</code> is the derivative of \(x^2\).</p>
<ul class="org-ul">
<li>The derivative of \(x^2\) is \(2x\).</li>
<li>When <i>x</i> is <i>5</i>, then <i>2x=10</i>.</li>
</ul>
<p>You can calculate the gradient of a function by using <code>trax.fastmath.grad(fun=)</code> and passing in the name of the function.</p>
<ul class="org-ul">
<li>In this case the function you want to take the gradient of is <code>square</code>.</li>
<li>The object returned (saved in <code>square_gradient</code> in this example) is a function that can calculate the gradient of <code>square</code> for a given <code>trax.fastmath.numpy</code> array.</li>
</ul>
<p>Use <code>trax.fastmath.grad</code> to calculate the gradient (derivative) of the function.</p>
<div class="highlight">
<pre><span></span><span class="n">square_gradient</span> <span class="o">=</span> <span class="n">trax</span><span class="o">.</span><span class="n">fastmath</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">square</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">square_gradient</span><span class="p">))</span>
</pre></div>
<pre class="example">
&lt;class 'function'&gt;
</pre>
<div class="highlight">
<pre><span></span><span class="n">gradient_calculation</span> <span class="o">=</span> <span class="n">square_gradient</span><span class="p">(</span><span class="n">an_array</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">gradient_calculation</span><span class="p">)</span>
</pre></div>
<pre class="example">
DeviceArray(10., dtype=float32)
</pre>
<p>The function returned by <code>trax.fastmath.grad</code> takes in <i>x=5</i> and calculates the gradient of <code>square</code>, which is <i>2x</i>, which equals <i>10</i>. The value is also stored as a DeviceArray from the jax library.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org12033e6">
<h2 id="org12033e6">End</h2>
<div class="outline-text-2" id="text-org12033e6">
<p>Now that we've had a brief review of Trax let's move on to <a href="posts/nlp/sentiment-analysis-pre-processing-the-data/">loading the data</a>.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org2190c98">
<h2 id="org2190c98">Raw</h2>
<div class="outline-text-2" id="text-org2190c98">
<pre class="example">
# import Layer from the utils.py file
from utils import Layer, load_tweets, process_tweet
#from utils import 






</pre></div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/data-generators/">Data Generators</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/data-generators/" rel="bookmark"><time class="published dt-published" datetime="2020-12-23T12:50:22-08:00" itemprop="datePublished" title="2020-12-23 12:50">2020-12-23 12:50</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/data-generators/#org3ab969e">Data generators</a>
<ul>
<li><a href="posts/nlp/data-generators/#org148b971">Imports</a></li>
</ul>
</li>
<li><a href="posts/nlp/data-generators/#org4644c65">Examples</a>
<ul>
<li><a href="posts/nlp/data-generators/#org078a9c0">An Example of a Circular List</a></li>
<li><a href="posts/nlp/data-generators/#org87157e1">Shuffling the data order</a></li>
<li><a href="posts/nlp/data-generators/#org1b45abe">Data Generator Function</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org3ab969e">
<h2 id="org3ab969e">Data generators</h2>
<div class="outline-text-2" id="text-org3ab969e">
<p>In Python, a <a href="https://wiki.python.org/moin/Generators">generator</a> is a function that behaves like an iterator. It will return the next item. In many AI applications, it is advantageous to have a data generator to handle loading and transforming data for different applications.</p>
<p>In the following example, we use a set of samples <code>a</code>, to derive a new set of samples, with more elements than the original set.</p>
<p><b>Note:</b> Pay attention to the use of list <code>lines_index</code> and variable <code>index</code> to traverse the original list.</p>
</div>
<div class="outline-3" id="outline-container-org148b971">
<h3 id="org148b971">Imports</h3>
<div class="outline-text-3" id="text-org148b971">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">be_true</span><span class="p">,</span> <span class="n">expect</span>
<span class="kn">import</span> <span class="nn">numpy</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4644c65">
<h2 id="org4644c65">Examples</h2>
<div class="outline-text-2" id="text-org4644c65"></div>
<div class="outline-3" id="outline-container-org078a9c0">
<h3 id="org078a9c0">An Example of a Circular List</h3>
<div class="outline-text-3" id="text-org078a9c0">
<p>This is sort of a fake generator that uses indices to make it look like it's infinite.</p>
<div class="highlight">
<pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">a_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c1"># similar to index in data_generator below</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>        <span class="c1"># `b` is longer than `a` forcing a wrap   </span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">a_size</span>    
</pre></div>
<pre class="example">
1,2,3,4,1,2,3,4,1,2,
</pre>
<p>There's a python built-in that's equivalent to this called <a href="https://docs.python.org/3/library/itertools.html#itertools.cycle">cycle</a>.</p>
<div class="highlight">
<pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cycle</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>    
</pre></div>
<pre class="example">
1,2,3,4,1,2,3,4,1,2,
</pre>
<p>And if you wanted to make your own generator version you could use the yield keyword.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">infinite</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">"""Generates elements infinitely</span>

<span class="sd">    Args:</span>
<span class="sd">     a: list</span>

<span class="sd">    Yields:</span>
<span class="sd">     elements of a</span>
<span class="sd">    """</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">end</span>
    <span class="k">return</span>

<span class="n">a_infinite</span> <span class="o">=</span> <span class="n">infinite</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a_infinite</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">","</span><span class="p">)</span>
</pre></div>
<pre class="example">
1,2,3,4,1,2,3,4,1,2,
</pre></div>
</div>
<div class="outline-3" id="outline-container-org87157e1">
<h3 id="org87157e1">Shuffling the data order</h3>
<div class="outline-text-3" id="text-org87157e1">
<p>In the next example, we will do the same as before, but shuffling the order of the elements in the output list. Note that here, our strategy of traversing using <code>lines_index</code> and <code>index</code> becomes very important, because we can simulate a shuffle in the input data, without doing that in reality.</p>
<div class="highlight">
<pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">a_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">data_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a_size</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Original order of indices: </span><span class="si">{</span><span class="n">data_indices</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Original order of indices: [0, 1, 2, 3]
</pre>
<p>If we shuffle the index_list we can change the order of our circular list without modifying the order or our original data.</p>
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data_indices</span><span class="p">)</span> <span class="c1"># Shuffle the order</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Shuffled order of indices: </span><span class="si">{</span><span class="n">data_indices</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Shuffled order of indices: [3, 0, 1, 2]
</pre>
<p>Now we create a list of random values from a that is larger than a.</p>
<div class="highlight">
<pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">data_indices</span><span class="p">]</span>
<span class="n">b_size</span> <span class="o">=</span> <span class="mi">10</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"New value order for first batch: </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">batch_counter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">data_index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">b_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b_size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">batch_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data_indices</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Shuffled Indexes for Batch No. </span><span class="si">{</span><span class="n">batch_counter</span><span class="si">}</span><span class="s2"> :</span><span class="si">{</span><span class="n">data_indices</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Values for Batch No.</span><span class="si">{</span><span class="n">batch_counter</span><span class="si">}</span><span class="s2"> :</span><span class="si">{</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">data_indices</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">data_indices</span><span class="p">[</span><span class="n">data_index</span><span class="p">]])</span>
    <span class="n">data_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">a_size</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Final value of b: </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2"> items"</span><span class="p">)</span>
</pre></div>
<pre class="example">
New value order for first batch: [1, 3, 4, 2]

Shuffled Indexes for Batch No. 2 :[1, 3, 2, 0]
Values for Batch No.2 :[2, 4, 3, 1]

Shuffled Indexes for Batch No. 3 :[0, 3, 2, 1]
Values for Batch No.3 :[1, 4, 3, 2]

Final value of b: [1, 3, 4, 2, 2, 4, 3, 1, 1, 4] with 10 items
</pre>
<p><b>Note:</b> We call an epoch each time that an algorithm passes over all the training examples. Shuffling the examples for each epoch is known to reduce variance, making the models more general and overfit less.</p>
<p>Using sample. instead.</p>
<div class="highlight">
<pre><span></span><span class="n">data_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a_size</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">a_size</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">data_indices</span><span class="p">]</span>
<span class="n">b_size</span> <span class="o">=</span> <span class="mi">10</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"New value order for first batch: </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">batch_counter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">data_index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">b_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b_size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">batch_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">data_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">data_indices</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">a_size</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Shuffled Indexes for Batch No. </span><span class="si">{</span><span class="n">batch_counter</span><span class="si">}</span><span class="s2"> :</span><span class="si">{</span><span class="n">data_indices</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Values for Batch No.</span><span class="si">{</span><span class="n">batch_counter</span><span class="si">}</span><span class="s2"> :</span><span class="si">{</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">data_indices</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">data_indices</span><span class="p">[</span><span class="n">data_index</span><span class="p">]])</span>
    <span class="n">data_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">a_size</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Final value of b: </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2"> items"</span><span class="p">)</span>
</pre></div>
<pre class="example">
New value order for first batch: [1, 4, 3, 2]

Shuffled Indexes for Batch No. 2 :[3, 0, 1, 2]
Values for Batch No.2 :[4, 1, 2, 3]

Shuffled Indexes for Batch No. 3 :[2, 0, 1, 3]
Values for Batch No.3 :[3, 1, 2, 4]

Final value of b: [1, 4, 3, 2, 4, 1, 2, 3, 3, 1] with 10 items
</pre></div>
</div>
<div class="outline-3" id="outline-container-org1b45abe">
<h3 id="org1b45abe">Data Generator Function</h3>
<div class="outline-text-3" id="text-org1b45abe">
<p>This will be a data generator function that takes in <code>batch_size, x, y shuffle</code> where x could be a large list of samples, and y is a list of the tags associated with those samples. Return a subset of those inputs in a tuple of two arrays <code>(X,Y)</code>. Each is an array of dimension (<code>batch_size</code>). If <code>shuffle=True</code>, the data will be traversed in a random form.</p>
<p>Which runs continuously in the fashion of generators, pausing when yielding the next values. We will generate a <code>batch_size</code> output on each pass of this loop.</p>
<p>It has an inner loop that stores the data samples in temporary lists <code>(X, Y)</code> which will be included in the next batch.</p>
<p>There are three slightly out-of-the-ordinary features to this function.</p>
<ol class="org-ol">
<li>The first is the use of a list of a predefined size to store the data for each batch. Using a predefined size list reduces the computation time if the elements in the array are of a fixed size, like numbers. If the elements are of different sizes, it is better to use an empty array and append one element at a time during the loop.</li>
<li>The second is tracking the current location in the incoming lists of samples. Generators variables hold their values between invocations, so we create an <code>index</code> variable, initialize to zero, and increment by one for each sample included in a batch. However, we do not use the <code>index</code> to access the positions of the list of sentences directly. Instead, we use it to select one index from a list of indexes. In this way, we can change the order in which we traverse our original list, keeping untouched our original list.</li>
<li>The third also relates to wrapping. Because <code>batch_size</code> and the length of the input lists are not aligned, gathering a <code>batch_size</code> group of inputs may involve wrapping back to the beginning of the input loop. In our approach, it is just enough to reset the <code>index</code> to 0. We can re-shuffle the list of indexes to produce different batches each time.</li>
</ol>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data_x</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">data_y</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Infinite batch generator</span>

<span class="sd">      Args: </span>
<span class="sd">       batch_size: the size to make batches</span>
<span class="sd">       data_x: list containing samples</span>
<span class="sd">       data_y: list containing labels</span>
<span class="sd">       shuffle: Shuffle the data order</span>

<span class="sd">      Yields:</span>
<span class="sd">       a tuple containing 2 elements:</span>
<span class="sd">       X - list of dim (batch_size) of samples</span>
<span class="sd">       Y - list of dim (batch_size) of labels</span>
<span class="sd">    """</span>
    <span class="n">amount_of_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_x</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">amount_of_data</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">re_shuffle</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="n">shuffler</span> <span class="o">=</span> <span class="n">re_shuffle</span> <span class="k">if</span> <span class="n">shuffle</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">source_indices</span> <span class="o">=</span> <span class="n">shuffler</span><span class="p">(</span><span class="n">data_x</span><span class="p">)</span>

    <span class="n">source_location</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">batch_location</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>                            
            <span class="n">X</span><span class="p">[</span><span class="n">batch_location</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_x</span><span class="p">[</span><span class="n">source_indices</span><span class="p">[</span><span class="n">source_location</span><span class="p">]]</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">batch_location</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_y</span><span class="p">[</span><span class="n">source_indices</span><span class="p">[</span><span class="n">source_location</span><span class="p">]]</span>
            <span class="n">source_location</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">amount_of_data</span>
            <span class="n">source_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">shuffler</span><span class="p">(</span><span class="n">data_x</span><span class="p">)</span> <span class="k">if</span> <span class="n">source_location</span> <span class="o">==</span> <span class="mi">0</span>
                              <span class="k">else</span> <span class="n">source_indices</span><span class="p">)</span>            
        <span class="k">yield</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
    <span class="k">return</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">test_data_generator</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Tests the un-shuffled version of the generator</span>

<span class="sd">    Raises:</span>
<span class="sd">     AssertionError: some value didn't match.</span>
<span class="sd">    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="n">generator</span> <span class="o">=</span> <span class="n">data_generator</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">(([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">]),</span>
                     <span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
                     <span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                     <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">])):</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">),</span> <span class="n">expected</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">be_true</span><span class="p">)</span>
    <span class="k">return</span>
<span class="n">test_data_generator</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/classes-and-subclasses/">Classes and Subclasses</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/classes-and-subclasses/" rel="bookmark"><time class="published dt-published" datetime="2020-12-20T21:13:13-08:00" itemprop="datePublished" title="2020-12-20 21:13">2020-12-20 21:13</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/classes-and-subclasses/#org2afa29e">Classes and Subclasses</a>
<ul>
<li><a href="posts/nlp/classes-and-subclasses/#org597a145">Imports</a></li>
</ul>
</li>
<li><a href="posts/nlp/classes-and-subclasses/#org2f2eb55">Middle</a>
<ul>
<li><a href="posts/nlp/classes-and-subclasses/#org2461d65">Part 1: Parameters, methods and instances</a>
<ul>
<li><a href="posts/nlp/classes-and-subclasses/#orgb1d77c0">The <code>__init__</code> method</a></li>
<li><a href="posts/nlp/classes-and-subclasses/#org892e30f">The <code>__call__</code> method</a></li>
<li><a href="posts/nlp/classes-and-subclasses/#org494cc5c">Custom methods</a></li>
</ul>
</li>
<li><a href="posts/nlp/classes-and-subclasses/#org70794f7">Part 2: Subclasses and Inheritance</a>
<ul>
<li><a href="posts/nlp/classes-and-subclasses/#org9839859">Inheritance</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org2afa29e">
<h2 id="org2afa29e">Classes and Subclasses</h2>
<div class="outline-text-2" id="text-org2afa29e">
<p>In this notebook, I will show you the basics of classes and subclasses in Python. As you've seen in the lectures from this week, `Trax` uses layer classes as building blocks for deep learning models, so it is important to understand how classes and subclasses behave in order to be able to build custom layers when needed.</p>
<p>By completing this notebook, you will:</p>
<ul class="org-ul">
<li>Be able to define classes and subclasses in Python</li>
<li>Understand how inheritance works in subclasses</li>
<li>Be able to work with instances</li>
</ul>
</div>
<div class="outline-3" id="outline-container-org597a145">
<h3 id="org597a145">Imports</h3>
<div class="outline-text-3" id="text-org597a145">
<div class="highlight">
<pre><span></span><span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
    <span class="n">raise_error</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">attr</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2f2eb55">
<h2 id="org2f2eb55">Middle</h2>
<div class="outline-text-2" id="text-org2f2eb55"></div>
<div class="outline-3" id="outline-container-org2461d65">
<h3 id="org2461d65">Part 1: Parameters, methods and instances</h3>
<div class="outline-text-3" id="text-org2461d65">
<p>First, let's define a class <code>SomeClass</code>.</p>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
<p><code>SomeClass</code> has one parameter <code>x</code> without any value. You can think of parameters as the variables that every object assigned to a class will have. So, at this point, any object of class <code>My_Class</code> would have a variable <code>x</code> equal to <code>None</code>. To check this, I'll create two instances of that class and get the value of <code>x</code> for both of them.</p>
<div class="highlight">
<pre><span></span><span class="n">instance_a</span><span class="o">=</span> <span class="n">SomeClass</span><span class="p">()</span>
<span class="n">instance_b</span><span class="o">=</span> <span class="n">SomeClass</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Parameter x of instance_a: </span><span class="si">{</span><span class="n">instance_a</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Parameter x of instance_b: </span><span class="si">{</span><span class="p">(</span><span class="n">instance_b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Parameter x of instance_a: None
Parameter x of instance_b: None
</pre>
<p>For an existing instance you can assign new values for any of its parameters. In the next cell, assign a value of <code>5</code> to the parameter <code>x</code> of <code>instance_a</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">instance_a</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Parameter x of instance_a: </span><span class="si">{</span><span class="n">instance_a</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Parameter x of instance_a: 5
</pre></div>
<div class="outline-4" id="outline-container-orgb1d77c0">
<h4 id="orgb1d77c0">The <code>__init__</code> method</h4>
<div class="outline-text-4" id="text-orgb1d77c0">
<p>When you want to assign values to the parameters of your class when an instance is created, it is necessary to define a special method: `__init__`. The `__init__` method is called when you create an instance of a class. It can have multiple arguments to initialize the paramenters of your instance. In the next cell I will define `My_Class` with an `__init__` method that takes the instance (`self`) and an argument `y` as inputs.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span> 
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">instance_c</span> <span class="o">=</span> <span class="n">SomeClass</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">instance_c</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
SomeClass(x=10)
</pre></div>
</div>
<div class="outline-4" id="outline-container-org892e30f">
<h4 id="org892e30f">The <code>__call__</code> method</h4>
<div class="outline-text-4" id="text-org892e30f">
<p>Another important method is the <code>__call__</code> method. It is performed whenever you call an initialized instance of a class. It can have multiple arguments and you can define it to do whatever you want like</p>
<ul class="org-ul">
<li>Change a parameter,</li>
<li>Print a message,</li>
<li>Create new variables, etc.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">z</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">instance_d</span> <span class="o">=</span> <span class="n">SomeClass</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
<p>And now, see what happens when <code>instance_d</code> is called with argument <code>10</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">instance_d</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
<pre class="example">
15
</pre>
<p>Now, you are ready to complete the following cell so any instance from <code>SomeClass</code>:</p>
<ul class="org-ul">
<li>Is initialized taking two arguments <code>y</code> and <code>z</code> and assigns them to <code>x_1</code> and <code>x_2</code>, respectively. And,</li>
<li>When called, takes the values of the parameters <code>x_1</code> and <code>x_2</code>, sums them, prints and returns the result.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span> 
    <span class="n">x_1</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">x_2</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_2</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Addition of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x_1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x_2</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
<p>Run the next cell to check your implementation. If everything is correct, you shouldn't get any errors.</p>
<div class="highlight">
<pre><span></span><span class="n">instance_e</span> <span class="o">=</span> <span class="n">SomeClass</span><span class="p">(</span><span class="n">x_1</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x_2</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_class_definition</span><span class="p">():</span>    
    <span class="n">expect</span><span class="p">(</span><span class="n">instance_e</span><span class="o">.</span><span class="n">x_1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">instance_e</span><span class="o">.</span><span class="n">x_2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">instance_e</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">25</span><span class="p">))</span>
    <span class="k">return</span>

<span class="n">test_class_definition</span><span class="p">()</span>
</pre></div>
<pre class="example">
Addition of 10 and 15 is 25
</pre></div>
</div>
<div class="outline-4" id="outline-container-org494cc5c">
<h4 id="org494cc5c">Custom methods</h4>
<div class="outline-text-4" id="text-org494cc5c">
<p>In addition to the <code>__init__</code> and <code>__call__</code> methods, your classes can have custom-built methods to do whatever you want when called. To define a custom method, you have to indicate its input arguments, the instructions that you want it to perform and the values to return (if any). In the next cell, <code>My_Class</code> is defined with <code>my_method</code> that multiplies the values of <code>x_1</code> and <code>x_2</code>, sums that product with an input <code>w</code>, and returns the result.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="n">x_1</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">x_2</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_2</span> 

    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_2</span> <span class="o">+</span> <span class="n">w</span>
</pre></div>
<p>Create an instance <code>instance_f</code> of <code>My_Class</code> with any integer values that you want for <code>x_1</code> and <code>x_2</code>. For that instance, see the result of calling <code>My_method</code>, with an argument <code>w</code> equal to <code>16</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">instance_f</span> <span class="o">=</span> <span class="n">SomeClass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Output of some_method: </span><span class="si">{</span><span class="n">instance_f</span><span class="o">.</span><span class="n">some_method</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Output of some_method: 26
</pre>
<p>As you can corroborate in the previous cell, to call a custom method <code>m</code>, with arguments <code>args</code>, for an instance <code>i</code> you must write <code>i.m(args)</code>. With that in mind, methods can call others within a class. In the following cell, try to define <code>new_method</code> which calls <code>my_method</code> with <code>v</code> as input argument. Try to do this on your own in the cell given below.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span> 
    <span class="n">x_1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">x_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_2</span> 

    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_2</span> <span class="o">+</span> <span class="n">w</span>

    <span class="k">def</span> <span class="nf">some_new_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_method</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">instance_g</span> <span class="o">=</span> <span class="n">SomeClass</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Output of some_method: </span><span class="si">{</span><span class="n">instance_g</span><span class="o">.</span><span class="n">some_method</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Output of some_new_method: </span><span class="si">{</span><span class="n">instance_g</span><span class="o">.</span><span class="n">some_new_method</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Output of some_method: 26
Output of some_new_method: 26
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org70794f7">
<h3 id="org70794f7">Part 2: Subclasses and Inheritance</h3>
<div class="outline-text-3" id="text-org70794f7">
<p><code>Trax</code> uses classes and subclasses to define layers. The base class in <code>Trax</code> is <code>layer</code>, which means that every layer from a deep learning model is defined as a subclass of the <code>layer</code> class. In this part of the notebook, you are going to see how subclasses work. To define a subclass <code>sub</code> from class <code>super</code>, you have to write <code>class sub(super):</code> and define any method and parameter that you want for your subclass. In the next cell, I define <code>sub_c</code> as a subclass of <code>My_Class</code> with only one method (<code>additional_method</code>).</p>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">SomeSub</span><span class="p">(</span><span class="n">SomeClass</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">additional_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_1</span><span class="p">)</span>
        <span class="k">return</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org9839859">
<h4 id="org9839859">Inheritance</h4>
<div class="outline-text-4" id="text-org9839859">
<p>When you define a subclass <code>sub</code>, every method and parameter is inherited from <code>super</code> class, including the <code>__init__</code> and <code>__call__</code> methods. This means that any instance from <code>sub</code> can use the methods defined in <code>super</code>. Run the following cell and see for yourself.</p>
<div class="highlight">
<pre><span></span><span class="n">instance_sub_a</span> <span class="o">=</span> <span class="n">SomeSub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Parameter x_1 of instance_sub_a: </span><span class="si">{</span><span class="n">instance_sub_a</span><span class="o">.</span><span class="n">x_1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Parameter x_2 of instance_sub_a: </span><span class="si">{</span><span class="n">instance_sub_a</span><span class="o">.</span><span class="n">x_2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Output of some_method of instance_sub_a: </span><span class="si">{</span><span class="n">instance_sub_a</span><span class="o">.</span><span class="n">some_method</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Parameter x_1 of instance_sub_a: 1
Parameter x_2 of instance_sub_a: 10
Output of my_method of instance_sub_a: 26
</pre>
<p>As you can see, <code>sub_c</code> does not have an initialization method <code>__init__</code>, it is inherited from <code>My_class</code>. However, you can overwrite any method you want by defining it again in the subclass. For instance, in the next cell define a class <code>sub_c</code> with a redefined <code>my_Method</code> that multiplies <code>x_1</code> and <code>x_2</code> but does not add any additional argument.</p>
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SomeSub</span><span class="p">(</span><span class="n">SomeClass</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">some_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_2</span> 
</pre></div>
<p>To check your implementation run the following cell.</p>
<div class="highlight">
<pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">SomeSub</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">some_method</span><span class="p">()</span>
<span class="n">expect</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Output of overridden my_method of test: </span><span class="si">{</span><span class="n">actual</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bad_call</span><span class="p">():</span>
    <span class="n">test</span><span class="o">.</span><span class="n">some_method</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="n">expect</span><span class="p">(</span><span class="n">bad_call</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">raise_error</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">))</span>
</pre></div>
<pre class="example">
Output of overridden my_method of test: 30
</pre>
<p>In the next cell, two instances are created, one of <code>My_Class</code> and another one of <code>sub_c</code>. The instances are initialized with equal <code>x_1</code> and <code>x_2</code> parameters.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">instance_sub_a</span> <span class="o">=</span> <span class="n">SomeSub</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
<span class="n">instance_a</span> <span class="o">=</span> <span class="n">SomeClass</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"My_method for an instance of sub_c returns: </span><span class="si">{</span><span class="n">instance_sub_a</span><span class="o">.</span><span class="n">some_method</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"My_method for an instance of My_Class returns: </span><span class="si">{</span><span class="n">instance_a</span><span class="o">.</span><span class="n">some_method</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
My_method for an instance of sub_c returns: 10
My_method for an instance of My_Class returns: 20
</pre>
<p>As you can see, even though <code>sub_c</code> is a subclass from <code>My_Class</code> and both instances are initialized with the same values, <code>My_method</code> returns different results for each instance because you overwrote <code>My_method</code> for <code>sub_c</code>.</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/introducing-trax/">Introducing Trax</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/introducing-trax/" rel="bookmark"><time class="published dt-published" datetime="2020-12-17T17:19:06-08:00" itemprop="datePublished" title="2020-12-17 17:19">2020-12-17 17:19</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/introducing-trax/#org8c87d1d">Background</a>
<ul>
<li><a href="posts/nlp/introducing-trax/#org0af11e6">Why Trax and not TensorFlow or PyTorch?</a></li>
<li><a href="posts/nlp/introducing-trax/#org4f7c15c">Why not Keras then?</a></li>
<li><a href="posts/nlp/introducing-trax/#org7e09db8">How to Code in Trax</a></li>
<li><a href="posts/nlp/introducing-trax/#org86b2d15">Trax, JAX, TensorFlow and Tensor2Tensor</a></li>
<li><a href="posts/nlp/introducing-trax/#org80ca3b2">Installing Trax</a></li>
<li><a href="posts/nlp/introducing-trax/#org565a01d">Imports</a></li>
</ul>
</li>
<li><a href="posts/nlp/introducing-trax/#org84850a0">Middle</a>
<ul>
<li><a href="posts/nlp/introducing-trax/#orgbb2ee77">Layers</a>
<ul>
<li><a href="posts/nlp/introducing-trax/#org2d43bcf">Relu Layer</a></li>
<li><a href="posts/nlp/introducing-trax/#orgaf00756">Concatenate Layer</a></li>
<li><a href="posts/nlp/introducing-trax/#orgb501b66">Configuring Layers</a></li>
<li><a href="posts/nlp/introducing-trax/#org12aac61">Layer Weights</a></li>
<li><a href="posts/nlp/introducing-trax/#orgf79088e">Custom Layers</a></li>
</ul>
</li>
<li><a href="posts/nlp/introducing-trax/#org0569355">Combinators</a>
<ul>
<li><a href="posts/nlp/introducing-trax/#org5cbddf7">Serial Combinator</a></li>
</ul>
</li>
<li><a href="posts/nlp/introducing-trax/#orgca2cddc">JAX</a></li>
</ul>
</li>
<li><a href="posts/nlp/introducing-trax/#orgdd8c779">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org8c87d1d">
<h2 id="org8c87d1d">Background</h2>
<div class="outline-text-2" id="text-org8c87d1d">
<p>This is going to be a first look at <a href="https://github.com/google/trax">Trax</a> a Deep Learning framework built by the Google Brain team.</p>
</div>
<div class="outline-3" id="outline-container-org0af11e6">
<h3 id="org0af11e6">Why Trax and not TensorFlow or PyTorch?</h3>
<div class="outline-text-3" id="text-org0af11e6">
<p>TensorFlow and PyTorch are both extensive frameworks that can do almost anything in deep learning. They offer a lot of flexibility, but that often means verbosity of syntax and extra time to code.</p>
<p>Trax is much more concise. It runs on a TensorFlow backend but allows you to train models with 1 line commands. Trax also runs end to end, allowing you to get data, model and train all with a single terse statement. This means you can focus on learning, instead of spending hours on the idiosyncrasies of a big framework's implementation.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org4f7c15c">
<h3 id="org4f7c15c">Why not Keras then?</h3>
<div class="outline-text-3" id="text-org4f7c15c">
<p>Keras is now part of Tensorflow itself from 2.0 onwards. Also, trax is good for implementing new state of the art algorithms like Transformers, Reformers, BERT because it is actively maintained by Google Brain Team for advanced deep learning tasks. It runs smoothly on CPUs,GPUs and TPUs as well with comparatively lesser modifications in code.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org7e09db8">
<h3 id="org7e09db8">How to Code in Trax</h3>
<div class="outline-text-3" id="text-org7e09db8">
<p>Building models in Trax relies on 2 key concepts:- <b>layers</b> and <b>combinators</b>. Trax layers are simple objects that process data and perform computations. They can be chained together into composite layers using Trax combinators, allowing you to build layers and models of any complexity.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org86b2d15">
<h3 id="org86b2d15">Trax, JAX, TensorFlow and Tensor2Tensor</h3>
<div class="outline-text-3" id="text-org86b2d15">
<p>You already know that Trax uses Tensorflow as a backend, but it also uses the <a href="https://github.com/google/jax">JAX</a> library to speed up computation too. You can view JAX as an enhanced and optimized version of numpy.</p>
<p>You import their version of numpy using <code>import trax.fastmath.numpy</code>. If you see this line, remember that when calling <code>numpy</code> you are really calling Trax’s version of numpy that is compatible with JAX.**</p>
<p>As a result of this, where you used to encounter the type <code>numpy.ndarray</code> now you will find the type <code>jax.interpreters.xla.DeviceArray</code>. The documentation for JAX is <a href="https://jax.readthedocs.io/en/latest/index.html">here</a> and specifically they have a page <a href="https://jax.readthedocs.io/en/latest/jax.numpy.html">with the numpy functions implemented so far</a>.</p>
<p><a href="https://tensorflow.github.io/tensor2tensor/">Tensor2Tensor</a> is another name you might have heard. It started as an end to end solution much like how Trax is designed, but it grew unwieldy and complicated. So you can view Trax as the new improved version that operates much faster and simpler.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org80ca3b2">
<h3 id="org80ca3b2">Installing Trax</h3>
<div class="outline-text-3" id="text-org80ca3b2">
<p>Note that there is another library called <a href="https://trax.readthedocs.io/en/latest/">TraX</a> which is something different.</p>
<p>We're going to use Trax version 1.3.1 here, so to install it with pip:</p>
<div class="highlight">
<pre><span></span>pip install trax==1.3.1
</pre></div>
<p>Note the <code>==</code> for the version, not <code>=</code>. This is a very big install so maybe take a break after you run it. You aren't going to get the full benefit of JAX if you don't have CUDA set up can use TPUs so make sure to set up CUDA if you're not using google colab. I also had to install <code>cmake</code> to get <code>trax</code> to install.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org565a01d">
<h3 id="org565a01d">Imports</h3>
<div class="outline-text-3" id="text-org565a01d">
<div class="highlight">
<pre><span></span><span class="c1"># pypi</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">shapes</span>
<span class="kn">from</span> <span class="nn">trax</span> <span class="kn">import</span> <span class="n">fastmath</span>
</pre></div>
<ul class="org-ul">
<li><a href="https://trax-ml.readthedocs.io/en/latest/notebooks/layers_intro.html">Layers</a> are the basic building blocks for Trax</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.html#module-trax.shapes">shapes</a> are used for data handling</li>
<li><a href="https://trax-ml.readthedocs.io/en/latest/trax.fastmath.html">fastmath</a> is the JAX version of numpy that can run on GPUs and TPUs</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org84850a0">
<h2 id="org84850a0">Middle</h2>
<div class="outline-text-2" id="text-org84850a0"></div>
<div class="outline-3" id="outline-container-orgbb2ee77">
<h3 id="orgbb2ee77">Layers</h3>
<div class="outline-text-3" id="text-orgbb2ee77">
<p>Layers are the core building blocks in Trax - they are the base classes. They take inputs, compute functions/custom calculations and return outputs.</p>
</div>
<div class="outline-4" id="outline-container-org2d43bcf">
<h4 id="org2d43bcf">Relu Layer</h4>
<div class="outline-text-4" id="text-org2d43bcf">
<p>First we'll build a ReLU activation function as a layer. A layer like this is one of the simplest types. Notice there is no object initialization so it works just like a math function.</p>
<p><b>Note: Activation functions are also layers in Trax, which might look odd if you have been using other frameworks for a longer time.</b></p>
<div class="highlight">
<pre><span></span><span class="n">relu</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Relu</span><span class="p">()</span>
</pre></div>
<p>You can inspect the properties of a layer:</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"-- Properties --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"name :"</span><span class="p">,</span> <span class="n">relu</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"expected inputs :"</span><span class="p">,</span> <span class="n">relu</span><span class="o">.</span><span class="n">n_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"promised outputs :"</span><span class="p">,</span> <span class="n">relu</span><span class="o">.</span><span class="n">n_out</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Properties --
name : Relu
expected inputs : 1
promised outputs : 1 

</pre>
<p>We'll make an input the layer using numpy.</p>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x :"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
x : [-2 -1  0  1  2] 

</pre>
<p>And see what it puts out.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Outputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y :"</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
<pre class="example">
WARNING:absl:No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
-- Outputs --
y : [0 0 0 1 2]
</pre>
<p>I don't know why but JAX doesn't thing I have a GPU, even though tensorflow does. This whole thing is a little messed up right now because the current release of tensorflow doesn't work on Ubuntu 20.10. I'm running it with the nightly build (2.5) but I have to install all the Trax dependencies one at a time or it will clobber the tensorflow installation with the older version (the one that doesn't work) so there's a lot of places for error.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgaf00756">
<h4 id="orgaf00756">Concatenate Layer</h4>
<div class="outline-text-4" id="text-orgaf00756">
<p>Now a layer that takes 2 inputs. Notice the change in the expected inputs property from 1 to 2.</p>
<p>First create a concatenate trax layer and check out its properties.</p>
<div class="highlight">
<pre><span></span><span class="n">concatenate</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Properties --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"name :"</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"expected inputs :"</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">.</span><span class="n">n_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"promised outputs :"</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">.</span><span class="n">n_out</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Properties --
name : Concatenate
expected inputs : 2
promised outputs : 1 

</pre>
<p>Now create the two inputs.</p>
<div class="highlight">
<pre><span></span><span class="n">x1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">])</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">/</span> <span class="o">-</span><span class="mi">10</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x1 :"</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x2 :"</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
x1 : [-10 -20 -30]
x2 : [1. 2. 3.] 

</pre>
<p>And now feed the inputs through the concatenate layer.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Outputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y :"</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Outputs --
y : [-10. -20. -30.   1.   2.   3.]
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgb501b66">
<h4 id="orgb501b66">Configuring Layers</h4>
<div class="outline-text-4" id="text-orgb501b66">
<p>You can change the default settings of layers. For example, you can change the expected inputs for a concatenate layer from 2 to 3 using the optional parameter <code>n_items</code>.</p>
<div class="highlight">
<pre><span></span><span class="n">concatenate_three</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">n_items</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Properties --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"name :"</span><span class="p">,</span> <span class="n">concatenate_three</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"expected inputs :"</span><span class="p">,</span> <span class="n">concatenate_three</span><span class="o">.</span><span class="n">n_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"promised outputs :"</span><span class="p">,</span> <span class="n">concatenate_three</span><span class="o">.</span><span class="n">n_out</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Properties --
name : Concatenate
expected inputs : 3
promised outputs : 1 

</pre>
<p>Create some inputs.</p>
<div class="highlight">
<pre><span></span><span class="n">x1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">])</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">/</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">x3</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">*</span> <span class="mf">0.99</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x1 :"</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x2 :"</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x3 :"</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
x1 : [-10 -20 -30]
x2 : [1. 2. 3.]
x3 : [0.99 1.98 2.97] 

</pre>
<p>And now do the concatenation.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">concatenate_three</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Outputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y :"</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Outputs --
y : [-10.   -20.   -30.     1.     2.     3.     0.99   1.98   2.97]
</pre></div>
</div>
<div class="outline-4" id="outline-container-org12aac61">
<h4 id="org12aac61">Layer Weights</h4>
<div class="outline-text-4" id="text-org12aac61">
<p>Some layer types include mutable weights and biases that are used in computation and training. Layers of this type require initialization before use.</p>
<p>For example the <code>LayerNorm</code> layer calculates normalized data, that is also scaled by weights and biases. During initialization you pass the data shape and data type of the inputs, so the layer can initialize compatible arrays of weights and biases.</p>
<p>Initialize it.</p>
<div class="highlight">
<pre><span></span><span class="n">norm</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">()</span>
</pre></div>
<p>Now some input data.</p>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"float"</span><span class="p">)</span>
</pre></div>
<p>Use the input data signature to get the shape and type for the initializing weights and biases. We need to convert the input datatype from the usual ndarray to a trax ShapeDtype</p>
<div class="highlight">
<pre><span></span><span class="n">norm</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Normal shape:"</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">"Data Type:"</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Shapes Trax:"</span><span class="p">,</span><span class="n">shapes</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="s2">"Data Type:"</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</pre></div>
<pre class="example">
Normal shape: (4,) Data Type: &lt;class 'tuple'&gt;
Shapes Trax: ShapeDtype{shape:(4,), dtype:float64} Data Type: &lt;class 'trax.shapes.ShapeDtype'&gt;
</pre>
<p>Here are its properties.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"-- Properties --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"name :"</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"expected inputs :"</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">n_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"promised outputs :"</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">n_out</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Properties --
name : LayerNorm
expected inputs : 1
promised outputs : 1
</pre>
<p>And the weights and biases.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"weights :"</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"biases :"</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
</pre></div>
<pre class="example">
weights : [1. 1. 1. 1.]
biases : [0. 0. 0. 0.]
</pre>
<p>We have our input array.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x :"</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
x : [0. 1. 2. 3.]
</pre>
<p>So we can inspect what the layer did to it.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Outputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y :"</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Outputs --
y : [-1.3416404  -0.44721344  0.44721344  1.3416404 ]
</pre>
<p>If you look at it you can see that the positives cancel out the negatives, giving us a sum of 0. I don't know why that's the norm, but maybe it'll become obvious later.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgf79088e">
<h4 id="orgf79088e">Custom Layers</h4>
<div class="outline-text-4" id="text-orgf79088e">
<p>You can create your own custom layers too and define custom functions for computations by using <code>layers.Fn</code>. Let me show you how.</p>
<div class="highlight">
<pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Fn</span><span class="p">)</span>
</pre></div>
<pre class="example">
Help on function Fn in module trax.layers.base:

Fn(name, f, n_out=1)
    Returns a layer with no weights that applies the function `f`.
    
    `f` can take and return any number of arguments, and takes only positional
    arguments -- no default or keyword arguments. It often uses JAX-numpy (`jnp`).
    The following, for example, would create a layer that takes two inputs and
    returns two outputs -- element-wise sums and maxima:
    
        `Fn('SumAndMax', lambda x0, x1: (x0 + x1, jnp.maximum(x0, x1)), n_out=2)`
    
    The layer's number of inputs (`n_in`) is automatically set to number of
    positional arguments in `f`, but you must explicitly set the number of
    outputs (`n_out`) whenever it's not the default value 1.
    
    Args:
      name: Class-like name for the resulting layer; for use in debugging.
      f: Pure function from input tensors to output tensors, where each input
          tensor is a separate positional arg, e.g., `f(x0, x1) --&gt; x0 + x1`.
          Output tensors must be packaged as specified in the `Layer` class
          docstring.
      n_out: Number of outputs promised by the layer; default value 1.
    
    Returns:
      Layer executing the function `f`.
</pre></div>
<ul class="org-ul">
<li><a id="org63cb15d"></a>Define a custom layer<br>
<div class="outline-text-5" id="text-org63cb15d">
<p>In this example we'll create a layer to calculate the input times 2.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">double_it</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">layers</span><span class="o">.</span><span class="n">Fn</span><span class="p">:</span>
    <span class="sd">"""A custom layer function that doubles any inputs</span>


<span class="sd">    Returns:</span>
<span class="sd">     a custom function that takes one numeric argument and doubles it</span>
<span class="sd">    """</span>
    <span class="n">layer_name</span> <span class="o">=</span> <span class="s2">"TimesTwo"</span>

    <span class="c1"># Custom function for the custom layer</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">Fn</span><span class="p">(</span><span class="n">layer_name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="orgb02950a"></a>Test it<br>
<div class="outline-text-5" id="text-orgb02950a">
<div class="highlight">
<pre><span></span><span class="n">double</span> <span class="o">=</span> <span class="n">double_it</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"-- Properties --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"name :"</span><span class="p">,</span> <span class="n">double</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"expected inputs :"</span><span class="p">,</span> <span class="n">double</span><span class="o">.</span><span class="n">n_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"promised outputs :"</span><span class="p">,</span> <span class="n">double</span><span class="o">.</span><span class="n">n_out</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Properties --
name : TimesTwo
expected inputs : 1
promised outputs : 1
</pre>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x :"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Outputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y :"</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
x : [1 2 3] 

-- Outputs --
y : [2 4 6]
</pre></div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org0569355">
<h3 id="org0569355">Combinators</h3>
<div class="outline-text-3" id="text-org0569355">
<p>You can combine layers to build more complex layers. Trax provides a set of objects named combinator layers to make this happen. Combinators are themselves layers, so behavior commutes.</p>
</div>
<div class="outline-4" id="outline-container-org5cbddf7">
<h4 id="org5cbddf7">Serial Combinator</h4>
<div class="outline-text-4" id="text-org5cbddf7">
<p>This is the most common and easiest to use. You could, for example, build a simple neural network by combining layers into a single layer using the <code>Serial</code> combinator. This new layer then acts just like a single layer, so you can inspect intputs, outputs and weights. Or even combine it into another layer! Combinators can then be used as trainable models. <i>Try adding more layers.</i></p>
<p><b>Note:As you must have guessed, if there is serial combinator, there must be a parallel combinator as well. Do try to explore about combinators and other layers from the trax documentation and look at the repo to understand how these layers are written.</b></p>
<div class="highlight">
<pre><span></span><span class="n">serial</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Relu</span><span class="p">(),</span>
    <span class="n">double</span><span class="p">,</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span> 
<span class="p">)</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="orgf06a950"></a>Initialization<br>
<div class="outline-text-5" id="text-orgf06a950">
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="c1">#input</span>
<span class="n">serial</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Serial Model --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Properties --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"name :"</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"sublayers :"</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">sublayers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"expected inputs :"</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">n_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"promised outputs :"</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">n_out</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"weights & biases:"</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Serial Model --
Serial[
  LayerNorm
  Relu
  TimesTwo
  Dense_2
  Dense_1
  LogSoftmax
] 

-- Properties --
name : Serial
sublayers : [LayerNorm, Relu, TimesTwo, Dense_2, Dense_1, LogSoftmax]
expected inputs : 1
promised outputs : 1
weights & biases: [(DeviceArray([1, 1, 1, 1, 1], dtype=int32), DeviceArray([0, 0, 0, 0, 0], dtype=int32)), (), (), (DeviceArray([[ 0.19178385,  0.1832077 ],
             [-0.36949775, -0.03924937],
             [ 0.43800744,  0.788491  ],
             [ 0.43107533, -0.3623491 ],
             [ 0.6186575 ,  0.04764405]], dtype=float32), DeviceArray([-3.0051979e-06,  1.4359505e-06], dtype=float32)), (DeviceArray([[-0.6747592],
             [-0.8550365]], dtype=float32), DeviceArray([-8.9325863e-07], dtype=float32)), ()] 
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"-- Inputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"x :"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">serial</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"-- Outputs --"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y :"</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
<pre class="example">
-- Inputs --
x : [-2 -1  0  1  2] 

-- Outputs --
y : [0.]
</pre></div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgca2cddc">
<h3 id="orgca2cddc">JAX</h3>
<div class="outline-text-3" id="text-orgca2cddc">
<p>Just remember to lookout for which numpy you are using, the regular numpy or Trax's JAX compatible numpy. Watch those import blocks. Numpy and fastmath.numpy have different data types.</p>
<p>Regular numpy.</p>
<div class="highlight">
<pre><span></span><span class="n">x_numpy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"good old numpy : "</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x_numpy</span><span class="p">),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
good old numpy :  &lt;class 'numpy.ndarray'&gt; 

</pre>
<p>Fastmath and jax numpy.</p>
<div class="highlight">
<pre><span></span><span class="n">x_jax</span> <span class="o">=</span> <span class="n">fastmath</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"jax trax numpy : "</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x_jax</span><span class="p">))</span>
</pre></div>
<pre class="example">
jax trax numpy :  &lt;class 'jax.interpreters.xla._DeviceArray'&gt;
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgdd8c779">
<h2 id="orgdd8c779">End</h2>
<div class="outline-text-2" id="text-orgdd8c779">
<ul class="org-ul">
<li>Trax is a concise framework, built on TensorFlow, for end to end machine learning. The key building blocks are layers and combinators.</li>
<li>This was a lab that was part of coursera's <b>Natural Language Processing with Sequence Models</b> course put up by DeepLearning.AI.</li>
</ul>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nlp/word-embeddings-visualizing-the-embeddings/">Word Embeddings: Visualizing the Embeddings</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/" rel="bookmark"><time class="published dt-published" datetime="2020-12-16T15:44:25-08:00" itemprop="datePublished" title="2020-12-16 15:44">2020-12-16 15:44</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/#org03849a3">Extracting and Visualizing the Embeddings</a>
<ul>
<li><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/#orgd34c266">Imports</a></li>
<li><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/#orgfee9e98">Set Up</a></li>
</ul>
</li>
<li><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/#org17fd13c">Middle</a>
<ul>
<li><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/#orgb015ac8">Set It Up</a></li>
<li><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/#org506af30">Visualizing</a></li>
</ul>
</li>
<li><a href="posts/nlp/word-embeddings-visualizing-the-embeddings/#org353c78b">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org03849a3">
<h2 id="org03849a3">Extracting and Visualizing the Embeddings</h2>
<div class="outline-text-2" id="text-org03849a3">
<p>In the <a href="posts/nlp/word-embeddings-training-the-model/">previous post</a> we built a Continuous Bag of Words model to predict a word based on the fraction of words each word surrounding it made up within a window (e.g. the fraction of the four words surrounding the word that each word made up). Now we're going to use the weights of the model as word embeddings and see if we can visualize them.</p>
</div>
<div class="outline-3" id="outline-container-orgd34c266">
<h3 id="orgd34c266">Imports</h3>
<div class="outline-text-3" id="text-orgd34c266">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.word_embeddings</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batches</span><span class="p">,</span>
    <span class="n">CBOW</span><span class="p">,</span>
    <span class="n">DataCleaner</span><span class="p">,</span>
    <span class="n">MetaData</span><span class="p">,</span>
    <span class="n">TheTrainer</span><span class="p">,</span>
    <span class="p">)</span>
<span class="c1"># my other stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgfee9e98">
<h3 id="orgfee9e98">Set Up</h3>
<div class="outline-text-3" id="text-orgfee9e98">
<div class="highlight">
<pre><span></span><span class="n">cleaner</span> <span class="o">=</span> <span class="n">DataCleaner</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">cleaner</span><span class="o">.</span><span class="n">processed</span><span class="p">)</span>
<span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">speak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"word-embeddings-visualizing-the-embeddings"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">"files/posts/nlp/</span><span class="si">{</span><span class="n">SLUG</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
 <span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">hidden_layer</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">half_window</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">repetitions</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">vocabulary_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">CBOW</span><span class="p">(</span><span class="n">hidden</span><span class="o">=</span><span class="n">hidden_layer</span><span class="p">,</span> <span class="n">vocabulary_size</span><span class="o">=</span><span class="n">vocabulary_size</span><span class="p">)</span>
<span class="n">batches</span> <span class="o">=</span> <span class="n">Batches</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cleaner</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span> <span class="n">word_to_index</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">word_to_index</span><span class="p">,</span>
                  <span class="n">half_window</span><span class="o">=</span><span class="n">half_window</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="n">repetitions</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">TheTrainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span> <span class="n">emit_point</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">trainer</span><span class="p">()</span>
</pre></div>
<pre class="example">
2020-12-16 16:32:17,189 graeae.timers.timer start: Started: 2020-12-16 16:32:17.189213
50: loss=9.88889093658385
new learning rate: 0.0198
100: loss=9.138356897918037
150: loss=9.149555378031549
new learning rate: 0.013068000000000001
200: loss=9.077599951734605
2020-12-16 16:32:37,403 graeae.timers.timer end: Ended: 2020-12-16 16:32:37.403860
2020-12-16 16:32:37,405 graeae.timers.timer end: Elapsed: 0:00:20.214647
250: loss=8.607763835003631
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">best_loss</span><span class="p">)</span>
</pre></div>
<pre class="example">
8.186490214727549
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org17fd13c">
<h2 id="org17fd13c">Middle</h2>
<div class="outline-text-2" id="text-org17fd13c"></div>
<div class="outline-3" id="outline-container-orgb015ac8">
<h3 id="orgb015ac8">Set It Up</h3>
<div class="outline-text-3" id="text-orgb015ac8">
<p>We're going to use the method of averaging the weights of the two layers to form the embeddings.</p>
<div class="highlight">
<pre><span></span><span class="n">embeddings</span> <span class="o">=</span> <span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">best_weights</span><span class="o">.</span><span class="n">input_weights</span><span class="o">.</span><span class="n">T</span>
              <span class="o">+</span> <span class="n">trainer</span><span class="o">.</span><span class="n">best_weights</span><span class="o">.</span><span class="n">hidden_weights</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
<p>And now our words.</p>
<div class="highlight">
<pre><span></span><span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"king"</span><span class="p">,</span> <span class="s2">"queen"</span><span class="p">,</span><span class="s2">"lord"</span><span class="p">,</span><span class="s2">"man"</span><span class="p">,</span> <span class="s2">"woman"</span><span class="p">,</span><span class="s2">"dog"</span><span class="p">,</span><span class="s2">"wolf"</span><span class="p">,</span>
         <span class="s2">"rich"</span><span class="p">,</span><span class="s2">"happy"</span><span class="p">,</span><span class="s2">"sad"</span><span class="p">]</span>
</pre></div>
<p>Now we need to translate the words into their indices so we can grab the rows in the mebedding that match.</p>
<div class="highlight">
<pre><span></span><span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">word_to_index</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span> 
</pre></div>
<pre class="example">
(10, 50) [2745, 3951, 2961, 3023, 5675, 1452, 5674, 4191, 2316, 4278]
</pre>
<p>There are 10 rows to match our ten words and 50 columns to match the number chosen for the hidden layer.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org506af30">
<h3 id="org506af30">Visualizing</h3>
<div class="outline-text-3" id="text-org506af30">
<p>We're going to use <a href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html">sklearn's PCA</a> for Principal Component Analysis. The <code>n_components</code> argument is the number of components it will keep - we'll keep 2.</p>
<div class="highlight">
<pre><span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">reduced</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">pca_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">reduced</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"X"</span><span class="p">,</span> <span class="s2">"Y"</span><span class="p">])</span>

<span class="n">pca_data</span><span class="p">[</span><span class="s2">"Word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">points</span> <span class="o">=</span> <span class="n">pca_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span>
                                 <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">pca_data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"X"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Y"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">"Word"</span><span class="p">,</span> <span class="n">text_baseline</span><span class="o">=</span><span class="s2">"top"</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span> <span class="o">*</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"PCA Embeddings"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"embeddings_pca"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="posts/nlp/word-embeddings-visualizing-the-embeddings/embeddings_pca.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Well, that's pretty horrible. Might need work.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org353c78b">
<h2 id="org353c78b">End</h2>
<div class="outline-text-2" id="text-org353c78b">
<p>This is the final post in the series looking at using a Continuous Bag of Words model to create word embeddings. Here are the other posts.</p>
<ul class="org-ul">
<li><a href="posts/nlp/word-embeddings-build-a-model/">Introduction</a></li>
<li><a href="posts/nlp/word-embeddings-shakespeare-data/">Loading the Data</a></li>
<li><a href="posts/nlp/word-embeddings-training-the-model/">Building and Training the CBOW Model</a></li>
</ul>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="next"><a href="index-16.html" rel="next">Older posts</a></li>
</ul>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script><!--End of body content-->
<footer id="footer"><a href="http://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
