<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Introduction to Gradient Descent." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Compare and Learn | In Too Deep</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/In-Too-Deep/posts/grokking/04_gradient_descent/compare-and-learn/" rel="canonical"><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../../site.webmanifest" rel="manifest">
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
<script async src="../../../assets/javascript/bokeh-1.3.4.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/nano/introduction-to-neural-networks/logistic-regression/" rel="prev" title="Logistic Regression" type="text/html">
<link href="/posts/nano/introduction-to-neural-networks/gradient-descent/" rel="next" title="Gradient Descent" type="text/html">
<meta content="In Too Deep" property="og:site_name">
<meta content="Compare and Learn" property="og:title">
<meta content="https://necromuralist.github.io/In-Too-Deep/posts/grokking/04_gradient_descent/compare-and-learn/" property="og:url">
<meta content="Introduction to Gradient Descent." property="og:description">
<meta content="article" property="og:type">
<meta content="2018-10-26T10:54:02-07:00" property="article:published_time">
<meta content="gradient descent" property="article:tag">
<meta content="grokking" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/In-Too-Deep/"><span id="blog-title">In Too Deep</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/In-Too-Deep/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/grokking/04_gradient_descent/compare-and-learn/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/grokking/04_gradient_descent/compare-and-learn/">Compare and Learn</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/grokking/04_gradient_descent/compare-and-learn/" rel="bookmark"><time class="published dt-published" datetime="2018-10-26T10:54:02-07:00" itemprop="datePublished" title="2018-10-26 10:54">2018-10-26 10:54</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/grokking/04_gradient_descent/compare-and-learn/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<p>i#t+BEGIN_COMMENT .. title: Compare and Learn .. slug: compare-and-learn .. date: 2018-10-26 10:54:02 UTC-07:00 .. tags: grokking,gradient descent .. category: Grokking .. link: .. description: Introduction to Gradient Descent. .. type: text #+END_COMMENT</p>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#orgfe7bdfd">Imports</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#org7637a94">What is this about?</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#org68e13cc">What's the next step after Predict?</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#orgb28f16b">So how do we learn?</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#org83d5768">Training the Model</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#org69d5574">Is there a better way to update the weights?</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#orgc309271">A Discursion On Derivatives</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#orgfbce50c">When does this work?</a></li>
<li><a href="/posts/grokking/04_gradient_descent/compare-and-learn/#org155e060">Fixing the Big Input Problem</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgfe7bdfd">
<h2 id="orgfe7bdfd">Imports</h2>
<div class="outline-text-2" id="text-orgfe7bdfd"></div>
<div class="outline-3" id="outline-container-org89a05fa">
<h3 id="org89a05fa">From PyPi</h3>
<div class="outline-text-3" id="text-org89a05fa">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org31c2624">
<h3 id="org31c2624">Setup the plotting</h3>
<div class="outline-text-3" id="text-org31c2624">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">figure_format</span><span class="o">=</span><span class="s1">'retina'</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">)</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org7637a94">
<h2 id="org7637a94">What is this about?</h2>
<div class="outline-text-2" id="text-org7637a94">
<p>The three main steps in training a model are:</p>
<ol class="org-ol">
<li>Predict</li>
<li>Compare</li>
<li>Learn</li>
</ol>
<p><i>Forward Propagation</i> was about the <i>Predict</i> step - we fed some inputs to a network and it output its predictions. Now we're going to look an steps 2 and 3 - <i>Compare</i> and <i>Learn</i>, the steps where we figure out how to improve the weights in our network.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org68e13cc">
<h2 id="org68e13cc">What's the next step after Predict?</h2>
<div class="outline-text-2" id="text-org68e13cc">
<p>As noted above, step 2 is <i>Compare</i> meaning compare our predictions with what we know to be the real answers (so this is <a href="https://en.wikipedia.org/wiki/Supervised_learning">supervised learning</a>) and see how well (or bad) we did.</p>
</div>
<div class="outline-3" id="outline-container-org7c12e44">
<h3 id="org7c12e44">Okay, but then what?</h3>
<div class="outline-text-3" id="text-org7c12e44">
<p>After <i>Compare</i> we move on to the <i>Learn</i> step where we adjust the weights based on the errors we found in <i>Compare</i>. In this case we'll use <a href="https://en.wikipedia.org/wiki/Gradient_descent">Gradient Descent</a> to find new weights for the network.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgf64c2f2">
<h3 id="orgf64c2f2">So, how do we find the error again?</h3>
<div class="outline-text-3" id="text-orgf64c2f2">
<p>There are many different ways to measure error, each with different positive and negative attributes, but in this case we're going to use <a href="https://en.wikipedia.org/wiki/Mean_squared_error">Mean Squared Error</a>. Here's an example with one measurement.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">weight</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">input_value</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">expected</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">actual</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">input_value</span>
<span class="c1"># you implicitly divide by 1 to get the mean of the square</span>
<span class="n">actual_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">expected_error</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected_error</span> <span class="o">-</span> <span class="n">actual_error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Error: {:.2f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_error</span><span class="p">))</span>
</pre></div>
<pre class="example">
Error: 0.30

</pre>
<p>Two things to note about the consequences of squaring the error - one is that it's always positive which is useful because you might have both positive and negative errors which would tend to cancel each other out when you take the mean (the <code>actual_error</code> above is a mean with an implied count of 1), even though both positive and negative errors are wrong, the other consequence is that the greater the error, the larger it grows (it follows a parabola instead of a line).</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Squared vs Unsquared Errors"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Squared Errors"</span> <span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Errors"</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
<div class="figure">
<p><img alt="squared_error.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/squared_error.png"></p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb28f16b">
<h2 id="orgb28f16b">So how do we learn?</h2>
<div class="outline-text-2" id="text-orgb28f16b">
<p>One method is <i>Hot-and-Cold Learning</i>. With this method you move your weights a little and pick the one that improves the error-rate. This first example will go back to the one feature network that tries to predict if a team will win using the average number of toes they have.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s2">"Toes"</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rankdir</span><span class="o">=</span><span class="s2">"LR"</span><span class="p">)</span>
<span class="c1"># input layer</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"Toes"</span><span class="p">)</span>

<span class="c1"># output layer</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"Win"</span><span class="p">)</span>

<span class="c1"># edge</span>
<span class="n">graph</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Weight"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"graphs/toes_model.dot"</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
<div class="figure">
<p><img alt="toes_model.dot.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/toes_model.dot.png"></p>
</div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">toes_model</span><span class="p">(</span><span class="n">toes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Predicts if the team will win based on the number of toes</span>

<span class="sd">    Return:</span>
<span class="sd">     predction: probability of winning</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">toes</span> <span class="o">*</span> <span class="n">weight</span>
</pre></div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">print_error</span><span class="p">(</span><span class="n">predicted</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"Toes Model"</span><span class="p">,</span>
                <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""Prints the (mean) squared error</span>

<span class="sd">    Args:</span>

<span class="sd">     predicted: what the model predicted</span>
<span class="sd">     actual: whether the team won or not</span>
<span class="sd">     label: something to identify the model</span>
<span class="sd">     separator: How to separate the output</span>
<span class="sd">    Returns:</span>
<span class="sd">     mse: the error</span>
<span class="sd">    """</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">predicted</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">print</span><span class="p">(</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">label</span><span class="p">,</span>
                          <span class="s2">"Predicted: {:.2f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">predicted</span><span class="p">),</span>
                          <span class="s2">"Actual: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual</span><span class="p">),</span>
                          <span class="s2">"MSE: {:.4f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">)]))</span>
    <span class="k">return</span> <span class="n">error</span>
</pre></div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">toes</span> <span class="o">=</span> <span class="mf">8.5</span>
<span class="n">actual</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">predicted</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">toes</span><span class="p">)</span>
<span class="n">error_original</span> <span class="o">=</span> <span class="n">print_error</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>
</pre></div>
<pre class="example">
Toes Model
Predicted: 0.85
Actual: 1
MSE: 0.0225

</pre>
<p>So our model has a Mean Squared Error of around 0.02, how do we make it better with the Hot and Cold Method? By trying a larger and smaller weight and using the one that makes the error smaller.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">weight_change</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">weight</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">knob_turned_up</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">toes</span><span class="p">,</span> <span class="n">weight</span> <span class="o">+</span> <span class="n">weight_change</span><span class="p">)</span>
<span class="n">knob_turned_down</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">toes</span><span class="p">,</span> <span class="n">weight</span> <span class="o">-</span> <span class="n">weight_change</span><span class="p">)</span>

<span class="n">error_up</span> <span class="o">=</span> <span class="n">print_error</span><span class="p">(</span><span class="n">knob_turned_up</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="s2">"Turned Up"</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
<span class="n">error_down</span> <span class="o">=</span> <span class="n">print_error</span><span class="p">(</span><span class="n">knob_turned_down</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="s2">"Turned Down"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Turned Up
Predicted: 0.94
Actual: 1
MSE: 0.0042

Turned Down
Predicted: 0.77
Actual: 1
MSE: 0.0552

</pre>
<p>Looking at the error, it looks like making the weight higher improved the score, so we should adjust our weight upwards.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">if</span> <span class="n">error_original</span> <span class="o">&gt;</span> <span class="n">error_up</span> <span class="ow">or</span> <span class="n">error_original</span> <span class="o">&gt;</span> <span class="n">error_down</span><span class="p">:</span>
    <span class="n">change_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">error_down</span> <span class="o">&lt;</span> <span class="n">error_original</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">weight_updated</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">+</span> <span class="n">change_direction</span> <span class="o">*</span> <span class="n">weight_change</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">toes</span><span class="p">,</span> <span class="n">weight_updated</span><span class="p">)</span>
    <span class="n">error_update</span> <span class="o">=</span> <span class="n">print_error</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="s2">"Updated Model"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">error_update</span> <span class="o">&lt;</span> <span class="n">error_original</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Model didn't improve."</span><span class="p">)</span>
</pre></div>
<pre class="example">
Updated Model
Predicted: 0.94
Actual: 1
MSE: 0.0042

</pre>
<p>So, this is what machine learning is really about, finding the parameters that give the best prediction. This is why it is often called a <b>search</b> problem - each of your parameters can have a variety of weights (infinite, actually) so what you are doing when you train your model is searching the space of weights to find the set that gives the best outcome for your metric. In this case we are looking to minimize our Mean Squared Error.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org83d5768">
<h2 id="org83d5768">Training the Model</h2>
<div class="outline-text-2" id="text-org83d5768">
<p>Rather than than trying to do the checks one at a time, we can run the Hot and Cold Learning in a loop to tune our model.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">weight</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">input_value</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">actual</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">weight_change</span> <span class="o">=</span> <span class="mf">0.001</span>

<span class="n">prediction</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">input_value</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
<span class="n">print_error</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="s2">"Step    1 Weight: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">optimal_step</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">**</span><span class="mi">8</span>
<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2001</span><span class="p">):</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">input_value</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">print_error</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span>
                         <span class="s2">"Step {:4} Weight: {:.2f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">weight</span><span class="p">),</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">100</span> <span class="k">else</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optimal_step</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
        <span class="n">optimal_step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">up_prediction</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">input_value</span><span class="p">,</span> <span class="n">weight</span> <span class="o">+</span> <span class="n">weight_change</span><span class="p">)</span>
    <span class="n">down_prediction</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">input_value</span><span class="p">,</span> <span class="n">weight</span> <span class="o">-</span> <span class="n">weight_change</span><span class="p">)</span>
    <span class="n">up_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">up_prediction</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">down_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">down_prediction</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">down_error</span> <span class="o">&lt;</span> <span class="n">up_error</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">weight</span> <span class="o">+=</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">weight_change</span>
    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Optimum Reached at Step {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optimal_step</span><span class="p">))</span>
</pre></div>
<pre class="example">
Step    1 Weight: 0.5   Predicted: 0.25 Actual: 0.8     MSE: 0.3025
Step  100 Weight: 0.60  Predicted: 0.30 Actual: 0.8     MSE: 0.2505
Step  200 Weight: 0.70  Predicted: 0.35 Actual: 0.8     MSE: 0.2030
Step  300 Weight: 0.80  Predicted: 0.40 Actual: 0.8     MSE: 0.1604
Step  400 Weight: 0.90  Predicted: 0.45 Actual: 0.8     MSE: 0.1229
Step  500 Weight: 1.00  Predicted: 0.50 Actual: 0.8     MSE: 0.0903
Step  600 Weight: 1.10  Predicted: 0.55 Actual: 0.8     MSE: 0.0628
Step  700 Weight: 1.20  Predicted: 0.60 Actual: 0.8     MSE: 0.0402
Step  800 Weight: 1.30  Predicted: 0.65 Actual: 0.8     MSE: 0.0227
Step  900 Weight: 1.40  Predicted: 0.70 Actual: 0.8     MSE: 0.0101
Step 1000 Weight: 1.50  Predicted: 0.75 Actual: 0.8     MSE: 0.0026
Step 1100 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1200 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1300 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1400 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1500 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1600 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1700 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1800 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 1900 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step 2000 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Optimum Reached at Step 1100
</pre>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Hot and Cold Mean Squared Error"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Training Repetition"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"MSE"</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="n">errors</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="hot_and_cold_error.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/hot_and_cold_error.png"></p>
</div>
<p>Looking at the output you can see that it reached an error of (nearly) zero at the 1,100th repetition. Based on the plot it looks like it kind of slowed down at the end, which is odd since we're using addition and subtraction, but I guess as the weight gets bigger the proportion of change you add becomes less.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Hot and Cold Mean Squared Error vs Weights"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Weight"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"MSE"</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="s2">"."</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="hot_and_cold_weights_vs_error.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/hot_and_cold_weights_vs_error.png"></p>
</div>
<p>Our optimal weight appears to be 1.6. Given the simplicity of our model we can check by solving the equation.</p>
<p>\[ prediction = weight \times input\\ weight = \frac{prediction}{input} \]</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">prediction</span><span class="o">/</span><span class="n">input_value</span><span class="p">)</span>
</pre></div>
<pre class="example">
1.6009999999999343

</pre>
<p>So, that looks about right.</p>
</div>
<div class="outline-3" id="outline-container-org55b654b">
<h3 id="org55b654b">Pros and Cons of Hot and Cold Learning</h3>
<div class="outline-text-3" id="text-org55b654b">
<p>The main thing that Hot and Cold Learning has going for it is that it is simple to understand and implement. There are a couple of problems with it though:</p>
<ul class="org-ul">
<li>You have to make multiple predictions per knob to make a decision on the change to make.</li>
<li>The amount you change the weight at each step can make it impossible to get the right weight, and in most cases you won't have just one input value so it's hard to know what to pick</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org69d5574">
<h2 id="org69d5574">Is there a better way to update the weights?</h2>
<div class="outline-text-2" id="text-org69d5574">
<p>With <i>Hot and Cold Learning</i> we make multiple predictions to decide which direction to add a set amount to the weight. But we can instead use the error to change our weight, and in doing so we will change both direction and scale based on the error. In this case <i>error</i> means "pure error", or just the difference between the prediction and the actual value.</p>
<p>\[ error = prediction - actual \]</p>
<p>Since we don't square it the error will be positive if our prediction is too high and negative if it is too low. We don't want to just use the difference, though, because we are adjusting a weight that gets multiplied by the input, so we need to scale the amount of change by the input.</p>
<p>Note that the ordering is now important - you have to subtract the error in the version above and add it if the terms are switched.</p>
<p>\[ adjustment = error * input\\ weights' = weights - adjustment \]</p>
<p>This is the method of <a href="https://en.wikipedia.org/wiki/Gradient_descent">Gradient Descent</a>. This is how it looks run on our previous problem.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">weight</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">input_value</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">actual</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="n">prediction</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">input_value</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
<span class="n">print_error</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="s2">"Step    1 Weight: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">optimal_step</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">**</span><span class="mi">8</span>
<span class="n">optimal_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">print_every</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">stop_after</span> <span class="o">=</span> <span class="mi">30</span>
<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2001</span><span class="p">):</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">toes_model</span><span class="p">(</span><span class="n">input_value</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="n">input_value</span>
    <span class="n">weight</span> <span class="o">-=</span> <span class="n">difference</span>
    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>    
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">print_error</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span>
                         <span class="s2">"Step {:4} Weight: {:.2f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">weight</span><span class="p">),</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">step</span> <span class="o">%</span> <span class="n">print_every</span> <span class="k">else</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optimal_step</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
        <span class="n">optimal_step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
        <span class="n">optimal_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">optimal_count</span> <span class="o">&gt;=</span> <span class="n">stop_after</span><span class="p">:</span>
        <span class="k">break</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Optimum Reached at Step {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optimal_step</span><span class="p">))</span>
</pre></div>
<pre class="example">
Step    1 Weight: 0.5   Predicted: 0.25 Actual: 0.8     MSE: 0.3025
Step    5 Weight: 1.34  Predicted: 0.63 Actual: 0.8     MSE: 0.0303
Step   10 Weight: 1.54  Predicted: 0.76 Actual: 0.8     MSE: 0.0017
Step   15 Weight: 1.59  Predicted: 0.79 Actual: 0.8     MSE: 0.0001
Step   20 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   25 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   30 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   35 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   40 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   45 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   50 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   55 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Step   60 Weight: 1.60  Predicted: 0.80 Actual: 0.8     MSE: 0.0000
Optimum Reached at Step 30
</pre>
<p>So it now hits the optimal solution at the 30th step instead of the 1,100th step (although it really seems to reach it at step 20, I think the difference is a rounding problem).</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Gradient Descent Mean Squared Error"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Training Repetition"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"MSE"</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)),</span> <span class="n">errors</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="gradient_descent_error.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/gradient_descent_error.png"></p>
</div>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Gradient Descent Mean Squared Error vs Weights"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Weight"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"MSE"</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="gradient_descent_weights_vs_error.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/gradient_descent_weights_vs_error.png"></p>
</div>
<p>The plots show what we already saw in the output, that Gradient Descent converges on a solution much faster than Hot and Cold Learning does.</p>
</div>
<div class="outline-3" id="outline-container-org79d5b21">
<h3 id="org79d5b21">Why multiply the error by the input?</h3>
<div class="outline-text-3" id="text-org79d5b21">
<p>This has three main effects called <i>stopping, negative reversal</i>, and <i>scaling</i>.</p>
</div>
<div class="outline-4" id="outline-container-orga4243b6">
<h4 id="orga4243b6">What is Stopping?</h4>
<div class="outline-text-4" id="text-orga4243b6">
<p>Stopping refers to the case where the input is 0. If that's the case then we don't want to adjust the weight so multiplying the error by the input nullifies it.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgcae3176">
<h4 id="orgcae3176">What is Negative Reversal?</h4>
<div class="outline-text-4" id="text-orgcae3176">
<p>The sign of the input changes which direction we want the weight to change, so multiplying it by the input keeps the change moving in the right direction even when the sign of the input changes.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgb91ca7a">
<h4 id="orgb91ca7a">What is Scaling?</h4>
<div class="outline-text-4" id="text-orgb91ca7a">
<p>The larger the input, the greater the amount of change it will add. This can be a bad thing, since the inputs can now have an outsized (negative) effect.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc309271">
<h2 id="orgc309271">A Discursion On Derivatives</h2>
<div class="outline-text-2" id="text-orgc309271">
<p>What we're doing when we train our model to minimize our error. In the Mean Squared Error equation:</p>
<p>\[ MSE = \frac{1}{n} \sum_{i=1}^n ((input \times weight) - actual)^2 \]</p>
<p>The only thing we can change is the <code>weight</code>, the <code>input</code> and <code>actual output</code> is set by the data. So what we're interested in is how the error changes as we change the weight. The relationship between how the output changes in relationship to how the input changes is the <a href="https://en.wikipedia.org/wiki/Derivative">derivative</a>. One way to think of the derivative is the slope at a point on a line. If you have a straight line the slope will be the same everywhere on it, but if it is curved then different points will have different slopes.</p>
<p>In our case our input is the <code>weight</code> and the output is the <code>error</code>. If you think about slope as \[\frac{rise}{run}\] you'll notice that the bigger the rise, the bigger the slope (since we're taking it at a point the <i>run</i> is infinitesimal), and it's positive going up and negative going down, so if you think of the plot of the MSE earlier, the further you go away from the center (where the error is zero), the steeper the slope, and moving away from the center is always moving up, so the slope is always positive, and moving toward the center where the error is zero is always moving down, so the slope is negative.</p>
<p>What we want, then, is to move our weights in the opposite direction of the slope. There's more math involved to explain this than I can handle right now, but when we calculate our weight adjustment, we are calculating the derivative, and since we want to move in the opposite direction of the derivative, we negate it. And the further away we are from the true value (where our error is zero), the greater the difference is, as we would expect from the slope of our line.</p>
<p>\[ \Delta = prediction - actual\\ \Delta_{weighted} = \Delta \times input\\ weight' = weight - \Delta_{weighted} \]</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgfbce50c">
<h2 id="orgfbce50c">When does this work?</h2>
<div class="outline-text-2" id="text-orgfbce50c">
<p>Well, it's easier to look at when it doesn't work than when it does.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">OneNode</span><span class="p">:</span>
    <span class="sd">"""Implements a single-node network</span>

<span class="sd">    Args:</span>
<span class="sd">     weight: the starting weight for the edge from the input to the output</span>
<span class="sd">     input_value: the input to the node</span>
<span class="sd">     actual: the actual output we are trying to predict</span>

<span class="sd">     training_steps: how many times to train the model</span>
<span class="sd">     tolerance: how close to zero we need our error to be</span>
<span class="sd">     print_every: how often to print training status</span>
<span class="sd">     stop_after: how many times to keep going after the optimal was found</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">input_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">training_steps</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                 <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.1</span><span class="o">**</span><span class="mi">8</span><span class="p">,</span>
                 <span class="n">print_every</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stop_after</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_value</span> <span class="o">=</span> <span class="n">input_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_steps</span> <span class="o">=</span> <span class="n">training_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_every</span> <span class="o">=</span> <span class="n">print_every</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="o">=</span> <span class="n">stop_after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">"""list of MSE values"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">"""List of weights built during training"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">"""List of predictions made"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">"""The current model's prediction"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_value</span>

    <span class="k">def</span> <span class="nf">mean_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">"""The mean squared error for the prediction"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">except</span> <span class="ne">OverflowError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"prediction: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"actual: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">print_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">,</span>
                    <span class="n">force_print</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">store_error</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">"""Prints the (mean) squared error</span>

<span class="sd">       Args:</span>
<span class="sd">        step: what step this is</span>
<span class="sd">        separator: How to separate the output</span>
<span class="sd">        force_print: ignore the step count and print anyway</span>
<span class="sd">        store_error: whether to add to the errors</span>
<span class="sd">       Returns:</span>
<span class="sd">        mse: the error</span>
<span class="sd">       """</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">store_error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force_print</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_every</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Input: {} Actual Output: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_value</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"Step: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">),</span>
                                  <span class="s2">"Weight: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">),</span>
                                  <span class="s2">"Predicted: {:.2f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">),</span>
                                  <span class="s2">"MSE: {:.4f}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">error</span>

    <span class="k">def</span> <span class="nf">adjust_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Takes the gradient descent step"""</span>
        <span class="n">scaled_derivative</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">-=</span> <span class="n">scaled_derivative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Trains our model on the values</span>

<span class="sd">       """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_value</span>
        <span class="n">optimal_step</span> <span class="o">=</span> <span class="n">optimal_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">force_print</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">store_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">adjust_weight</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">optimal_step</span> <span class="ow">and</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span>
                <span class="n">optimal_step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">optimal_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">optimal_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Optimum Reached at Step {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">optimal_step</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">plot_errors_over_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Plots the error as it is trained</span>

<span class="sd">       Args:</span>
<span class="sd">        scale: y-axis scale</span>
<span class="sd">       """</span>
        <span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Gradient Descent Mean Squared Error"</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Training Repetition"</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"MSE"</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">plot_errors_vs_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Plots errors given weights"""</span>
        <span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Gradient Descent Mean Squared Error vs Weights"</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Weight"</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"MSE"</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">plot_weight_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Plots the distribution of the weights"""</span>
        <span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Distribution Of Weights"</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Resets the properties"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_weight</span>
        <span class="k">return</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org0838bb8">
<h3 id="org0838bb8">Really Big Inputs</h3>
<div class="outline-text-3" id="text-org0838bb8">/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">network</span> <span class="o">=</span> <span class="n">OneNode</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">input_value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">print_every</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">network</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
<pre class="example">
Input: 5 Actual Output: 0.1
Step: 1 Weight: 0.1     Predicted: 0.50 MSE: 0.1600
Input: 5 Actual Output: 0.1
Step: 30        Weight: -8.496029205125367e+38  Predicted: -4248014602562683567255766167412625375232.00 MSE: 18045628063585794511112671022597693816764790617265863683813015097617735965736960.0000
Input: 5 Actual Output: 0.1
Step: 60        Weight: -2.1654753676302967e+80 Predicted: -1082737683815148355196656106977575165473067380893761893846901009426287310965571584.00       MSE: 1172320891953392254658250331342439625964504567088377053437708818301948653571886896236931555371967400274585017142698424782066192956435576184566862647806273773371392.0000
Input: 5 Actual Output: 0.1
Step: 90        Weight: -5.51938258990998e+121  Predicted: -275969129495499010312802960568845701886516344963538842611688052470072992651229004282112996195046030793242534509005731004416.00      MSE: 76158960434503501277477316231095001035615545032300898123025508833954593912013767638712660721529293958181614329406854402338675069139074333788043867020532267345247209268079568592806683870329999393916410491701860464641755145654976460424275531137024.0000
(34, 'Numerical result out of range')
prediction: 1.5336245888098994e+154
actual: 0.1
</pre>
<p>So, when the input is too big, the prediction explodes.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">plot_errors_over_time</span><span class="p">()</span>
</pre></div>
<div class="figure">
<p><img alt="too_big_errors.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/too_big_errors.png"></p>
</div>
<p>It looks at first like there was no error and then all of a sudden it got huge - but if you look at the scale of the y-axis it maxes out at over \(4\times10^{305}\) and then the overflow error causes it to quit. So when the input is too large, the network goes out of control.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">plot_errors_vs_weights</span><span class="p">()</span>
</pre></div>
<p><img alt="too_big_errors_vs_weights.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/too_big_errors_vs_weights.png"> So now it looks like there aren't really many weights, but if you look at both the X and Y scales you can see that they're really huge, so most of the points are probably centered around 0 (relative to the overall scale) and then all of a sudden they go crazy on the last two points.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span>
<span class="n">network</span><span class="o">.</span><span class="n">plot_weight_distribution</span><span class="p">()</span>
</pre></div>
<div class="figure">
<p><img alt="too_big_distribution_of_weights.png" src="/posts/grokking/04_gradient_descent/compare-and-learn/too_big_distribution_of_weights.png"></p>
</div>
<p>So we have a small number of weights that are very large. Or a lot of very large weights with a small number of very-very-large weights.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
<pre class="example">
count     1.130000e+02
mean     2.605805e+151
std      2.888965e+152
min     -1.278020e+152
25%      -6.526920e+74
50%      -1.900000e+00
75%       1.566461e+76
max      3.067249e+153
dtype: float64

</pre>
<p>So the median is -1.9 and the mean is \(0.6 \times 10^{151}\). Looks like there are some outliers.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org155e060">
<h2 id="org155e060">Fixing the Big Input Problem</h2>
<div class="outline-text-2" id="text-org155e060">
<p>The problem with big inputs is that they cause the gradient descent to explode. Remember our error function:</p>
<p>\[ error = input \times (predicted - actual)\\ = input \times ((input \times weights) - actual) \]</p>
<p>If the input is big the error will be big, and since our correction to the weights is based on the error:</p>
<p>\[ weights' = weights - error \]</p>
<p>our weights can start to swing wildly back and forth with the error growing larger and larger and swinginig between positive and negative numbers. The larger the input, the larger the error, the larger the derivative will be in the opposite direction.</p>
<p>The fix is to only update using a fraction of the correction. We find some value (\(\alpha\)) and multiply it by the change to reduce the influence any one change has. How do we find \(\alpha\)? Well, that turns out to be done by trial and error. If your error goes up as you train, then you probably have to make it smaller.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">AlphaNode</span><span class="p">(</span><span class="n">OneNode</span><span class="p">):</span>
    <span class="sd">"""Incorporates weight update reduction</span>

<span class="sd">    Args:</span>
<span class="sd">     alpha: amount to weight the update</span>

<span class="sd">     weight: the starting weight for the edge from the input to the output</span>
<span class="sd">     input_value: the input to the node</span>
<span class="sd">     actual: the actual output we are trying to predict</span>

<span class="sd">     training_steps: how many times to train the model</span>
<span class="sd">     tolerance: how close to zero we need our error to be</span>
<span class="sd">     print_every: how often to print training status</span>
<span class="sd">     stop_after: how many times to keep going after the optimal was found</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="vm">__class__</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">adjust_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sd">"""Takes the gradient descent step with alpha weight"""</span>
        <span class="n">scaled_derivative</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">scaled_derivative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">return</span>
</pre></div>
<p>Why does this help? Our problem is that the large inputs cause the gradient descent to overshoot past the value that would give zero error and by reducing the amount any one change can have we reduce the likelihood that this will happen.</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">alpha_network</span> <span class="o">=</span> <span class="n">AlphaNode</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">input_value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">actual</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">print_every</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">alpha_network</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
<pre class="example">
Input: 5 Actual Output: 0.8
Step: 1 Weight: 0.5     Predicted: 2.50 MSE: 2.8900
Input: 5 Actual Output: 0.8
Step: 30        Weight: -43463.41342612052      Predicted: -217317.07   MSE: 47227055374.1942
Input: 5 Actual Output: 0.8
Step: 60        Weight: -8334186242.344855      Predicted: -41670931211.72      MSE: 1736466508118929965056.0000
Input: 5 Actual Output: 0.8
Step: 90        Weight: -1598089039844441.2     Predicted: -7990445199222206.00 MSE: 63847214481773219178788224499712.0000
Input: 5 Actual Output: 0.8
Step: 120       Weight: -3.064352661386353e+20  Predicted: -1532176330693176459264.00   MSE: 2347564308336405932287023519199639310958592.0000
Input: 5 Actual Output: 0.8
Step: 150       Weight: -5.875928686839428e+25  Predicted: -293796434341971398081118208.00      MSE: 86316344832056315635271476663737243674922770633850880.0000
Input: 5 Actual Output: 0.8
Step: 180       Weight: -1.1267155496783526e+31 Predicted: -56335777483917627928853446918144.00 MSE: 3173719824717480263078840848567916525595895306706307529098395648.0000
Optimum Reached at Step 0
</pre>
<p>Okay, so that still didn't work, maybe if \(\alpha\) was smaller?</p>
/home/brunhilde/.virtualenvs/In-Too-Deep/bin/python3: No module named virtualfish
<div class="highlight">
<pre><span></span><span class="n">alpha_network</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">alpha_network</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
<pre class="example">
Input: 5 Actual Output: 0.8
Step: 1 Weight: 0.5     Predicted: 2.50 MSE: 2.8900
Input: 5 Actual Output: 0.8
Step: 30        Weight: 0.1600809572142104      Predicted: 0.80 MSE: 0.0000
Input: 5 Actual Output: 0.8
Step: 60        Weight: 0.16000001445750855     Predicted: 0.80 MSE: 0.0000
Optimum Reached at Step 34

</pre>
<p>So now our model is able to reach the correct value again. Can you figure out what the best \(\alpha\) is ahead of time? The magic eight ball says no. At this point in time the best way to find the hyperparameters for machine learning is to try them until you find the ones that perform the best.</p>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="/categories/gradient-descent/" rel="tag">gradient descent</a></li>
<li><a class="tag p-category" href="/categories/grokking/" rel="tag">grokking</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/nano/introduction-to-neural-networks/logistic-regression/" rel="prev" title="Logistic Regression">Previous post</a></li>
<li class="next"><a href="/posts/nano/introduction-to-neural-networks/gradient-descent/" rel="next" title="Gradient Descent">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents  2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
