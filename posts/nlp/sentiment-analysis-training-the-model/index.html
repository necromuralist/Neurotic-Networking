<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Training the deep learning sentiment analysis model." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Sentiment Analysis: Training the Model | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/sentiment-analysis-training-the-model/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../sentiment-analysis-defining-the-model/" rel="prev" title="Sentiment Analysis: Defining the Model" type="text/html">
<link href="../sentiment-analysis-testing-the-model/" rel="next" title="Sentiment Analysis: Testing the Model" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Sentiment Analysis: Training the Model" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/sentiment-analysis-training-the-model/" property="og:url">
<meta content="Training the deep learning sentiment analysis model." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-12-23T15:49:53-08:00" property="article:published_time">
<meta content="neural networks" property="article:tag">
<meta content="nlp" property="article:tag">
<meta content="sentiment analysis" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Sentiment Analysis: Training the Model</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2020-12-23T15:49:53-08:00" itemprop="datePublished" title="2020-12-23 15:49">2020-12-23 15:49</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf927cf2">Training the Model</a>
<ul>
<li><a href="#org92ec5a2">Imports</a></li>
</ul>
</li>
<li><a href="#orgdbe771a">Middle</a>
<ul>
<li><a href="#org39d239d">The Dataset</a></li>
<li><a href="#orgb8af838">Here's the Model</a></li>
<li><a href="#org4570eaa">Bundle It Up</a>
<ul>
<li><a href="#orgff793ed">Imports</a></li>
<li><a href="#org901d9c6">The Trainer</a></li>
</ul>
</li>
<li><a href="#org1716efa">Practice In Making Predictions</a>
<ul>
<li><a href="#org0278189">Compare 1 to 1 rather than comparing True to 1.</a></li>
</ul>
</li>
<li><a href="#orgb893dcf">Evaluation</a>
<ul>
<li><a href="#org38bd092">5.1 Computing the accuracy of a batch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0f55ae2">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgf927cf2">
<h2 id="orgf927cf2">Training the Model</h2>
<div class="outline-text-2" id="text-orgf927cf2">
<p>In the <a href="../sentiment-analysis-defining-the-model/">previous post</a> we defined our Deep Learning model for Sentiment Analysis. Now we'll turn to training it on our data.</p>
<p>To train a model on a task, Trax defines an abstraction <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.TrainTask"><code>trax.supervised.training.TrainTask</code></a> which packages the training data, loss and optimizer (among other things) together into an object.</p>
<p>Similarly to training a model, Trax defines an abstraction <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.EvalTask"><code>trax.supervised.training.EvalTask</code></a> which packages the eval data and metrics (among other things) into another object.</p>
<p>The final piece tying things together is the <a href="https://trax-ml.readthedocs.io/en/latest/trax.supervised.html#trax.supervised.training.Loop"><code>trax.supervised.training.Loop</code></a> abstraction that is a very simpl eand flexible way to put everything together and train the model, all the while evaluating it and saving checkpoints. Using <code>Loop</code> will save you a lot of code compared to always writing the training loop by hand, like you did in courses 1 and 2. More importantly, you are less likely to have a bug in that code that would ruin your training.</p>
</div>
<div class="outline-3" id="outline-container-org92ec5a2">
<h3 id="org92ec5a2">Imports</h3>
<div class="outline-text-3" id="text-org92ec5a2">
<div class="highlight">
<pre><span></span><span class="c1"># from python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">trax.supervised</span> <span class="kn">import</span> <span class="n">training</span>

<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">trax</span>
<span class="kn">import</span> <span class="nn">trax.layers</span> <span class="k">as</span> <span class="nn">trax_layers</span>
<span class="kn">import</span> <span class="nn">trax.fastmath.numpy</span> <span class="k">as</span> <span class="nn">numpy</span>

<span class="c1"># this project</span>
<span class="kn">from</span> <span class="nn">neurotic.nlp.twitter.tensor_generator</span> <span class="kn">import</span> <span class="n">TensorBuilder</span><span class="p">,</span> <span class="n">TensorGenerator</span>
</pre></div>
<p>This next part (re-downloading the dataset) is just because I have to keep setting up new containers to get trax to workâ€¦</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"twitter_samples"</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="s2">"/home/neurotic/data/datasets/nltk_data/"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgdbe771a">
<h2 id="orgdbe771a">Middle</h2>
<div class="outline-text-2" id="text-orgdbe771a"></div>
<div class="outline-3" id="outline-container-org39d239d">
<h3 id="org39d239d">The Dataset</h3>
<div class="outline-text-3" id="text-org39d239d">
<div class="highlight">
<pre><span></span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">converter</span> <span class="o">=</span> <span class="n">TensorBuilder</span><span class="p">()</span>


<span class="n">train_generator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">TensorGenerator</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span>
                                     <span class="n">positive_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">positive_training</span><span class="p">,</span>
                                     <span class="n">negative_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">negative_training</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">training_generator</span> <span class="o">=</span> <span class="n">train_generator</span><span class="p">()</span>

<span class="n">valid_generator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">TensorGenerator</span><span class="p">,</span>
                          <span class="n">converter</span><span class="p">,</span>
                          <span class="n">positive_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">positive_validation</span><span class="p">,</span>
                          <span class="n">negative_data</span><span class="o">=</span><span class="n">converter</span><span class="o">.</span><span class="n">negative_validation</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">validation_generator</span> <span class="o">=</span> <span class="n">valid_generator</span><span class="p">()</span>

<span class="n">size_of_vocabulary</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb8af838">
<h3 id="orgb8af838">Here's the Model</h3>
<div class="outline-text-3" id="text-orgb8af838">
<p>This was defined in the last post. It seems like too much trouble not to just copy it over.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">classifier</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">size_of_vocabulary</span><span class="p">,</span>
               <span class="n">embedding_dim</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
               <span class="n">output_dim</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Creates the classifier model</span>

<span class="sd">    Args:</span>
<span class="sd">     vocab_size: number of tokens in the training vocabulary</span>
<span class="sd">     embedding_dim: output dimension for the Embedding layer</span>
<span class="sd">     output_dim: dimension for the Dense layer</span>

<span class="sd">    Returns:</span>
<span class="sd">     the composed layer-model</span>
<span class="sd">    """</span>
    <span class="n">embed_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
        <span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="c1"># Size of the vocabulary</span>
        <span class="n">d_feature</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">)</span>  <span class="c1"># Embedding dimension</span>

    <span class="n">mean_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">dense_output_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span> <span class="o">=</span> <span class="n">output_dim</span><span class="p">)</span>

    <span class="n">log_softmax_layer</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
      <span class="n">embed_layer</span><span class="p">,</span>
      <span class="n">mean_layer</span><span class="p">,</span>
      <span class="n">dense_output_layer</span><span class="p">,</span>
      <span class="n">log_softmax_layer</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
<p>Now to train the model.</p>
<p>First define the <code>TrainTask</code>, <code>EvalTask</code> and <code>Loop</code> in preparation to training the model.</p>
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">271</span><span class="p">)</span>

<span class="c1"># train_generator(batch_size=batch_size, shuffle=True),</span>

<span class="n">train_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
    <span class="n">labeled_data</span><span class="o">=</span><span class="n">training_generator</span><span class="p">,</span>
    <span class="n">loss_layer</span><span class="o">=</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
    <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">eval_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
    <span class="n">labeled_data</span><span class="o">=</span><span class="n">validation_generator</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span>
<span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">()</span>
</pre></div>
<p>This defines a model trained using <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.CrossEntropyLoss">tl.CrossEntropyLoss</a> optimized with the <a href="https://trax-ml.readthedocs.io/en/latest/trax.optimizers.html#trax.optimizers.adam.Adam">trax.optimizers.Adam</a> optimizer, all the while tracking the accuracy using <a href="https://trax-ml.readthedocs.io/en/latest/trax.layers.html#trax.layers.metrics.Accuracy">tl.Accuracy</a> metric. We also track <code>tl.CrossEntropyLoss</code> on the validation set.</p>
<p>Now let's make an output directory and train the model.</p>
<div class="highlight">
<pre><span></span><span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/models/"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">output_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">train_task</span><span class="p">,</span> <span class="n">eval_task</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create and run the training loop</span>

<span class="sd">    Args: </span>
<span class="sd">       classifier - the model you are building</span>
<span class="sd">       train_task - Training task</span>
<span class="sd">       eval_task - Evaluation task</span>
<span class="sd">       n_steps - the evaluation steps</span>
<span class="sd">       output_dir - folder to save your files</span>
<span class="sd">    Returns:</span>
<span class="sd">       trainer -  trax trainer</span>
<span class="sd">    """</span>
    <span class="n">training_loop</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span>
                                <span class="n">model</span><span class="o">=</span><span class="n">classifier</span><span class="p">,</span> <span class="c1"># The learning model</span>
                                <span class="n">tasks</span><span class="o">=</span><span class="n">train_task</span><span class="p">,</span> <span class="c1"># The training task</span>
                                <span class="n">eval_tasks</span> <span class="o">=</span> <span class="n">eval_task</span><span class="p">,</span> <span class="c1"># The evaluation task</span>
                                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="p">)</span> <span class="c1"># The output directory</span>

    <span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span> <span class="o">=</span> <span class="n">n_steps</span><span class="p">)</span>
    <span class="c1"># Return the training_loop, since it has the model.</span>
    <span class="k">return</span> <span class="n">training_loop</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">training_loop</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_task</span><span class="p">,</span> <span class="n">eval_task</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
</pre></div>
<pre class="example" id="orge4f384a">

Step    110: Ran 10 train steps in 6.06 secs
Step    110: train CrossEntropyLoss |  0.00527583
Step    110: eval  CrossEntropyLoss |  0.00304692
Step    110: eval          Accuracy |  1.00000000

Step    120: Ran 10 train steps in 2.06 secs
Step    120: train CrossEntropyLoss |  0.02130376
Step    120: eval  CrossEntropyLoss |  0.00000677
Step    120: eval          Accuracy |  1.00000000

Step    130: Ran 10 train steps in 0.75 secs
Step    130: train CrossEntropyLoss |  0.01026674
Step    130: eval  CrossEntropyLoss |  0.00424393
Step    130: eval          Accuracy |  1.00000000

Step    140: Ran 10 train steps in 1.33 secs
Step    140: train CrossEntropyLoss |  0.00172522
Step    140: eval  CrossEntropyLoss |  0.00004072
Step    140: eval          Accuracy |  1.00000000

Step    150: Ran 10 train steps in 0.77 secs
Step    150: train CrossEntropyLoss |  0.00002847
Step    150: eval  CrossEntropyLoss |  0.00000232
Step    150: eval          Accuracy |  1.00000000

Step    160: Ran 10 train steps in 0.78 secs
Step    160: train CrossEntropyLoss |  0.00002123
Step    160: eval  CrossEntropyLoss |  0.00104654
Step    160: eval          Accuracy |  1.00000000

Step    170: Ran 10 train steps in 0.79 secs
Step    170: train CrossEntropyLoss |  0.00001706
Step    170: eval  CrossEntropyLoss |  0.00000080
Step    170: eval          Accuracy |  1.00000000

Step    180: Ran 10 train steps in 0.83 secs
Step    180: train CrossEntropyLoss |  0.00001554
Step    180: eval  CrossEntropyLoss |  0.00000989
Step    180: eval          Accuracy |  1.00000000

Step    190: Ran 10 train steps in 0.85 secs
Step    190: train CrossEntropyLoss |  0.00639312
Step    190: eval  CrossEntropyLoss |  0.00255337
Step    190: eval          Accuracy |  1.00000000

Step    200: Ran 10 train steps in 0.85 secs
Step    200: train CrossEntropyLoss |  0.00124322
Step    200: eval  CrossEntropyLoss |  0.02190475
Step    200: eval          Accuracy |  1.00000000
</pre></div>
</div>
<div class="outline-3" id="outline-container-org4570eaa">
<h3 id="org4570eaa">Bundle It Up</h3>
<div class="outline-text-3" id="text-org4570eaa">
<div class="highlight">
<pre><span></span><span class="o">&lt;&lt;</span><span class="n">imports</span><span class="o">&gt;&gt;</span>


<span class="o">&lt;&lt;</span><span class="n">model</span><span class="o">-</span><span class="n">trainer</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">the</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">training</span><span class="o">-</span><span class="n">task</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="nb">eval</span><span class="o">-</span><span class="n">task</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">training</span><span class="o">-</span><span class="n">loop</span><span class="o">&gt;&gt;</span>

    <span class="o">&lt;&lt;</span><span class="n">fit</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">model</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgff793ed">
<h4 id="orgff793ed">Imports</h4>
<div class="outline-text-4" id="text-orgff793ed">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># from pypi</span>
<span class="kn">from</span> <span class="nn">trax.supervised</span> <span class="kn">import</span> <span class="n">training</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">trax</span>
<span class="kn">import</span> <span class="nn">trax.layers</span> <span class="k">as</span> <span class="nn">trax_layers</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org901d9c6">
<h4 id="org901d9c6">The Trainer</h4>
<div class="outline-text-4" id="text-org901d9c6">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SentimentNetwork</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Builds and Trains the Sentiment Analysis Model</span>

<span class="sd">    Args:</span>
<span class="sd">     training_generator: generator of training batches</span>
<span class="sd">     validation_generator: generator of validation batches</span>
<span class="sd">     vocabulary_size: number of tokens in the training vocabulary</span>
<span class="sd">     training_loops: number of times to run the training loop</span>
<span class="sd">     output_path: path to where to store the model</span>
<span class="sd">     embedding_dimension: output dimension for the Embedding layer</span>
<span class="sd">     output_dimension: dimension for the Dense layer</span>
<span class="sd">    """</span>
    <span class="n">vocabulary_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">training_generator</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">validation_generator</span><span class="p">:</span> <span class="nb">object</span>
    <span class="n">training_loops</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">embedding_dimension</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">256</span>
    <span class="n">output_dimension</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">_model</span><span class="p">:</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training_task</span><span class="p">:</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_evaluation_task</span><span class="p">:</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training_loop</span><span class="p">:</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<ul class="org-ul">
<li><a id="org00d74b4"></a>The Model<br>
<div class="outline-text-5" id="text-org00d74b4">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The Embeddings model"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">trax_layers</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
                <span class="n">vocab_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">,</span>
                <span class="n">d_feature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dimension</span><span class="p">),</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dimension</span><span class="p">),</span>
            <span class="n">trax_layers</span><span class="o">.</span><span class="n">LogSoftmax</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</pre></div>
</div>
</li>
<li><a id="orge992f14"></a>The Training Task<br>
<div class="outline-text-5" id="text-orge992f14">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The training task for training the model"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">TrainTask</span><span class="p">(</span>
            <span class="n">labeled_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_generator</span><span class="p">,</span>
            <span class="n">loss_layer</span><span class="o">=</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">trax</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
            <span class="n">n_steps_per_checkpoint</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_task</span>
</pre></div>
</div>
</li>
<li><a id="org16e0a78"></a>Evaluation Task<br>
<div class="outline-text-5" id="text-org16e0a78">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">evaluation_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The validation evaluation task"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_task</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">EvalTask</span><span class="p">(</span>
            <span class="n">labeled_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_generator</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">trax_layers</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(),</span>
                     <span class="n">trax_layers</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()],</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_task</span>
</pre></div>
</div>
</li>
<li><a id="orgb582ec2"></a>Training Loop<br>
<div class="outline-text-5" id="text-orgb582ec2">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""The thing to run the training"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_loop</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">Loop</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_task</span><span class="p">,</span>
            <span class="n">eval_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_task</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span> 
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_loop</span>
</pre></div>
</div>
</li>
<li><a id="org3b6433f"></a>Fitting the Model<br>
<div class="outline-text-5" id="text-org3b6433f">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Runs the training loop"""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">training_loop</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_loops</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org1716efa">
<h3 id="org1716efa">Practice In Making Predictions</h3>
<div class="outline-text-3" id="text-org1716efa">
<p>Now that you have trained a model, you can access it as <code>training_loop.model</code> object. We will actually use <code>training_loop.eval_model</code> and in the next weeks you will learn why we sometimes use a different model for evaluation, e.g., one without dropout. For now, make predictions with your model.</p>
<p>Use the training data just to see how the prediction process works.</p>
<ul class="org-ul">
<li>Later, you will use validation data to evaluate your model's performance.</li>
</ul>
<p>Create a generator object.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_train_generator</span> <span class="o">=</span> <span class="n">train_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
<p>Get one batch.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_train_generator</span><span class="p">)</span>
</pre></div>
<p>Position 0 has the model inputs (tweets as tensors). Position 1 has the targets (the actual labels).</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_inputs</span><span class="p">,</span> <span class="n">tmp_targets</span><span class="p">,</span> <span class="n">tmp_example_weights</span> <span class="o">=</span> <span class="n">tmp_batch</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The batch is a tuple of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp_batch</span><span class="p">)</span><span class="si">}</span><span class="s2"> because position 0 contains the tweets, and position 1 contains the targets."</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The shape of the tweet tensors is </span><span class="si">{</span><span class="n">tmp_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> (num of examples, length of tweet tensors)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The shape of the labels is </span><span class="si">{</span><span class="n">tmp_targets</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, which is the batch size."</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The shape of the example_weights is </span><span class="si">{</span><span class="n">tmp_example_weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, which is the same as inputs/targets size."</span><span class="p">)</span>
</pre></div>
<pre class="example">
The batch is a tuple of length 3 because position 0 contains the tweets, and position 1 contains the targets.
The shape of the tweet tensors is (16, 14) (num of examples, length of tweet tensors)
The shape of the labels is (16,), which is the batch size.
The shape of the example_weights is (16,), which is the same as inputs/targets size.
</pre>
<p>Feed the tweet tensors into the model to get a prediction.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_pred</span> <span class="o">=</span> <span class="n">training_loop</span><span class="o">.</span><span class="n">eval_model</span><span class="p">(</span><span class="n">tmp_inputs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The prediction shape is </span><span class="si">{</span><span class="n">tmp_pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, num of tensor_tweets as rows"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Column 0 is the probability of a negative sentiment (class 0)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Column 1 is the probability of a positive sentiment (class 1)"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"View the prediction array"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_pred</span><span class="p">)</span>
</pre></div>
<pre class="example" id="orga4924c9">
The prediction shape is (16, 2), num of tensor_tweets as rows
Column 0 is the probability of a negative sentiment (class 0)
Column 1 is the probability of a positive sentiment (class 1)

View the prediction array
[[-1.2960873e+01 -2.3841858e-06]
 [-5.6474457e+00 -3.5326481e-03]
 [-5.3460855e+00 -4.7781467e-03]
 [-7.6736917e+00 -4.6515465e-04]
 [-5.2682662e+00 -5.1658154e-03]
 [-1.0566207e+01 -2.5749207e-05]
 [-5.6388092e+00 -3.5634041e-03]
 [-3.9540453e+00 -1.9363165e-02]
 [ 0.0000000e+00 -2.0700916e+01]
 [ 0.0000000e+00 -2.2949795e+01]
 [ 0.0000000e+00 -2.3168846e+01]
 [ 0.0000000e+00 -2.4553205e+01]
 [-9.5367432e-07 -1.3878939e+01]
 [ 0.0000000e+00 -1.6655178e+01]
 [ 0.0000000e+00 -1.5975946e+01]
 [ 0.0000000e+00 -2.0577690e+01]]
</pre>
<p>To turn these probabilities into categories (negative or positive sentiment prediction), for each row:</p>
<ul class="org-ul">
<li>Compare the probabilities in each column.</li>
<li>If column 1 has a value greater than column 0, classify that as a positive tweet.</li>
<li>Otherwise if column 1 is less than or equal to column 0, classify that example as a negative tweet.</li>
</ul>
<p>Turn probabilites into category predictions.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_is_positive</span> <span class="o">=</span> <span class="n">tmp_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tmp_pred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_is_positive</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Neg log prob </span><span class="si">{</span><span class="n">tmp_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s2">Pos log prob </span><span class="si">{</span><span class="n">tmp_pred</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\t</span><span class="s2"> is positive? </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\t</span><span class="s2"> actual </span><span class="si">{</span><span class="n">tmp_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example" id="org15952f4">
Neg log prob -12.9609   Pos log prob -0.0000     is positive? True       actual 1
Neg log prob -5.6474    Pos log prob -0.0035     is positive? True       actual 1
Neg log prob -5.3461    Pos log prob -0.0048     is positive? True       actual 1
Neg log prob -7.6737    Pos log prob -0.0005     is positive? True       actual 1
Neg log prob -5.2683    Pos log prob -0.0052     is positive? True       actual 1
Neg log prob -10.5662   Pos log prob -0.0000     is positive? True       actual 1
Neg log prob -5.6388    Pos log prob -0.0036     is positive? True       actual 1
Neg log prob -3.9540    Pos log prob -0.0194     is positive? True       actual 1
Neg log prob 0.0000     Pos log prob -20.7009    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -22.9498    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -23.1688    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -24.5532    is positive? False      actual 0
Neg log prob -0.0000    Pos log prob -13.8789    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -16.6552    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -15.9759    is positive? False      actual 0
Neg log prob 0.0000     Pos log prob -20.5777    is positive? False      actual 0
</pre>
<p>Notice that since you are making a prediction using a training batch, it's more likely that the model's predictions match the actual targets (labels).</p>
<ul class="org-ul">
<li>Every prediction that the tweet is positive is also matching the actual target of 1 (positive sentiment).</li>
<li>Similarly, all predictions that the sentiment is not positive matches the actual target of 0 (negative sentiment)</li>
</ul>
<p>One more useful thing to know is how to compare if the prediction is matching the actual target (label).</p>
<ul class="org-ul">
<li>The result of calculation <code>is_positive</code> is a boolean.</li>
<li>The target is a type trax.fastmath.numpy.int32</li>
<li>If you expect to be doing division, you may prefer to work with decimal numbers with the data type type trax.fastmath.numpy.int32</li>
</ul>
<p>View the array of booleans.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Array of booleans"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_is_positive</span><span class="p">)</span>
</pre></div>
<pre class="example">
Array of booleans
DeviceArray([ True,  True,  True,  True,  True,  True,  True,  True,
             False, False, False, False, False, False, False, False],            dtype=bool)
</pre>
<p>Convert booleans to type int32.</p>
<ul class="org-ul">
<li>True is converted to 1</li>
<li>False is converted to 0</li>
</ul>
<div class="highlight">
<pre><span></span><span class="n">tmp_is_positive_int</span> <span class="o">=</span> <span class="n">tmp_is_positive</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">trax</span><span class="o">.</span><span class="n">fastmath</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</pre></div>
<p>View the array of integers.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Array of integers"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_is_positive_int</span><span class="p">)</span>
</pre></div>
<pre class="example">
Array of integers
DeviceArray([1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0], dtype=int32)
</pre>
<p>Convert boolean to type float32.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_is_positive_float</span> <span class="o">=</span> <span class="n">tmp_is_positive</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
<p>View the array of floats.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Array of floats"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tmp_is_positive_float</span><span class="p">)</span>
</pre></div>
<pre class="example">
Array of floats
DeviceArray([1., 1., 1., 1., 1., 1., 1., 1., 0., 0., 0., 0., 0., 0., 0.,
             0.], dtype=float32)
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tmp_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
<pre class="example">
(16, 2)
</pre>
<p>Note that Python usually does type conversion for you when you compare a boolean to an integer.</p>
<ul class="org-ul">
<li>True compared to 1 is True, otherwise any other integer is False.</li>
<li>False compared to 0 is True, otherwise any ohter integer is False.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"True == 1: </span><span class="si">{</span><span class="kc">True</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"True == 2: </span><span class="si">{</span><span class="kc">True</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"False == 0: </span><span class="si">{</span><span class="kc">False</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"False == 2: </span><span class="si">{</span><span class="kc">False</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
True == 1: True
True == 2: False
False == 0: True
False == 2: False
</pre>
<p>However, we recommend that you keep track of the data type of your variables to avoid unexpected outcomes. So it helps to convert the booleans into integers.</p>
</div>
<div class="outline-4" id="outline-container-org0278189">
<h4 id="org0278189">Compare 1 to 1 rather than comparing True to 1.</h4>
<div class="outline-text-4" id="text-org0278189">
<p>Hopefully you are now familiar with what kinds of inputs and outputs the model uses when making a prediction.</p>
<ul class="org-ul">
<li>This will help you implement a function that estimates the accuracy of the model's predictions.</li>
</ul>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb893dcf">
<h3 id="orgb893dcf">Evaluation</h3>
<div class="outline-text-3" id="text-orgb893dcf"></div>
<div class="outline-4" id="outline-container-org38bd092">
<h4 id="org38bd092">5.1 Computing the accuracy of a batch</h4>
<div class="outline-text-4" id="text-org38bd092">
<p>You will now write a function that evaluates your model on the validation set and returns the accuracy.</p>
<ul class="org-ul">
<li><code>preds</code> contains the predictions.</li>
<li>Its dimensions are <code>(batch_size, output_dim)</code>. <code>output_dim</code> is two in this case. Column 0 contains the probability that the tweet belongs to class 0 (negative sentiment). Column 1 contains probability that it belongs to class 1 (positive sentiment).</li>
<li>If the probability in column 1 is greater than the probability in column 0, then interpret this as the model's prediction that the example has label 1 (positive sentiment).</li>
<li>Otherwise, if the probabilities are equal or the probability in column 0 is higher, the model's prediction is 0 (negative sentiment).</li>
<li><code>y</code> contains the actual labels.</li>
<li><code>y_weights</code> contains the weights to give to predictions.</li>
</ul>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">compute_accuracy</span><span class="p">(</span><span class="n">preds</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">y_weights</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute a batch accuracy</span>

<span class="sd">    Args: </span>
<span class="sd">       preds: a tensor of shape (dim_batch, output_dim) </span>
<span class="sd">       y: a tensor of shape (dim_batch,) with the true labels</span>
<span class="sd">       y_weights: a n.ndarray with the a weight for each example</span>

<span class="sd">    Returns: </span>
<span class="sd">       accuracy: a float between 0-1 </span>
<span class="sd">       weighted_num_correct (np.float32): Sum of the weighted correct predictions</span>
<span class="sd">       sum_weights (np.float32): Sum of the weights</span>
<span class="sd">    """</span>
    <span class="c1"># Create an array of booleans, </span>
    <span class="c1"># True if the probability of positive sentiment is greater than</span>
    <span class="c1"># the probability of negative sentiment</span>
    <span class="c1"># else False</span>
    <span class="n">is_pos</span> <span class="o">=</span>  <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># convert the array of booleans into an array of np.int32</span>
    <span class="n">is_pos_int</span> <span class="o">=</span> <span class="n">is_pos</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># compare the array of predictions (as int32) with the target (labels) of type int32</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">is_pos_int</span> <span class="o">==</span> <span class="n">y</span>

    <span class="c1"># Count the sum of the weights.</span>
    <span class="n">sum_weights</span> <span class="o">=</span> <span class="n">y_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># convert the array of correct predictions (boolean) into an arrayof np.float32</span>
    <span class="n">correct_float</span> <span class="o">=</span> <span class="n">correct</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Multiply each prediction with its corresponding weight.</span>
    <span class="n">weighted_correct_float</span> <span class="o">=</span> <span class="n">correct_float</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y_weights</span><span class="p">)</span>

    <span class="c1"># Sum up the weighted correct predictions (of type np.float32), to go in the</span>
    <span class="c1"># denominator.</span>
    <span class="n">weighted_num_correct</span> <span class="o">=</span> <span class="n">weighted_correct_float</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Divide the number of weighted correct predictions by the sum of the</span>
    <span class="c1"># weights.</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">weighted_num_correct</span><span class="o">/</span><span class="n">sum_weights</span>

    <span class="k">return</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">weighted_num_correct</span><span class="p">,</span> <span class="n">sum_weights</span>
</pre></div>
<p>Get one batch.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_val_generator</span> <span class="o">=</span> <span class="n">valid_generator</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">tmp_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_val_generator</span><span class="p">)</span>
</pre></div>
<p>Position 0 has the model inputs (tweets as tensors) position 1 has the targets (the actual labels)</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_inputs</span><span class="p">,</span> <span class="n">tmp_targets</span><span class="p">,</span> <span class="n">tmp_example_weights</span> <span class="o">=</span> <span class="n">tmp_batch</span>
</pre></div>
<p>Feed the tweet tensors into the model to get a prediction.</p>
<div class="highlight">
<pre><span></span><span class="n">tmp_pred</span> <span class="o">=</span> <span class="n">training_loop</span><span class="o">.</span><span class="n">eval_model</span><span class="p">(</span><span class="n">tmp_inputs</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">tmp_acc</span><span class="p">,</span> <span class="n">tmp_num_correct</span><span class="p">,</span> <span class="n">tmp_num_predictions</span> <span class="o">=</span> <span class="n">compute_accuracy</span><span class="p">(</span><span class="n">preds</span><span class="o">=</span><span class="n">tmp_pred</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">tmp_targets</span><span class="p">,</span> <span class="n">y_weights</span><span class="o">=</span><span class="n">tmp_example_weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model's prediction accuracy on a single training batch is: </span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tmp_acc</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Weighted number of correct predictions </span><span class="si">{</span><span class="n">tmp_num_correct</span><span class="si">}</span><span class="s2">; weighted number of total observations predicted </span><span class="si">{</span><span class="n">tmp_num_predictions</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Model's prediction accuracy on a single training batch is: 100.0%
Weighted number of correct predictions 64.0; weighted number of total observations predicted 64
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0f55ae2">
<h2 id="org0f55ae2">End</h2>
<div class="outline-text-2" id="text-org0f55ae2">
<p>Now that we have a trained model, in the <a href="../sentiment-analysis-testing-the-model/">next post</a> we'll test how well it did.</p>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/neural-networks/" rel="tag">neural networks</a></li>
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/sentiment-analysis/" rel="tag">sentiment analysis</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../sentiment-analysis-defining-the-model/" rel="prev" title="Sentiment Analysis: Defining the Model">Previous post</a></li>
<li class="next"><a href="../sentiment-analysis-testing-the-model/" rel="next" title="Sentiment Analysis: Testing the Model">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Scribbles by <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a>
<div id="license" xmlns:cc="http://creativecommons.org/ns#">This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" rel="license noopener noreferrer" style="display:inline-block;" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"></a></div>
</footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
