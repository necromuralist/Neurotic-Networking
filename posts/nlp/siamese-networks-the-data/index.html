<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Looking at the Quora Dataset." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Siamese Networks: The Data | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/siamese-networks-the-data/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../siamese-networks-duplicate-questions/" rel="prev" title="Siamese Networks: Duplicate Questions" type="text/html">
<link href="../siamese-networks-the-data-generator/" rel="next" title="Siamese Networks: The Data Generator" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Siamese Networks: The Data" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/nlp/siamese-networks-the-data/" property="og:url">
<meta content="Looking at the Quora Dataset." property="og:description">
<meta content="article" property="og:type">
<meta content="2021-01-25T19:32:40-08:00" property="article:published_time">
<meta content="nlp" property="article:tag">
<meta content="siamese networks" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Siamese Networks: The Data</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-01-25T19:32:40-08:00" itemprop="datePublished" title="2021-01-25 19:32">2021-01-25 19:32</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb300316">Transforming the Data</a>
<ul>
<li><a href="#org56fb996">Imports</a></li>
<li><a href="#orgd14c8cd">Set Up</a>
<ul>
<li><a href="#org14fa6ae">The Timer</a></li>
<li><a href="#org0d65c69">NLTK</a></li>
<li><a href="#org93592ef">The Training Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3a1ace5">Middle</a>
<ul>
<li><a href="#org9b2daa1">Inspecting the Data</a></li>
<li><a href="#orga7e6479">Train Test Split</a></li>
<li><a href="#orgd1b87b9">Filtering Out Non-Duplicates</a></li>
<li><a href="#org89874a5">Encoding the Words</a>
<ul>
<li><a href="#orgafb1791">Build the Vocabulary</a></li>
</ul>
</li>
<li><a href="#org43706d1">Converting a question to a tensor</a></li>
<li><a href="#org6375a94">Validation Set</a></li>
</ul>
</li>
<li><a href="#org4ef1508">Bundling It Up</a>
<ul>
<li><a href="#org446dc32">Imports</a></li>
<li><a href="#org967d9f1">NLTK Setup</a></li>
<li><a href="#org9c327d3">Constants and Data</a></li>
<li><a href="#orgd5eddc0">The Data Tokenizer</a>
<ul>
<li><a href="#org788d748">Question 1</a></li>
<li><a href="#org4fae38f">Question 2</a></li>
</ul>
</li>
<li><a href="#org1d8d325">The Data Tensorizer</a>
<ul>
<li><a href="#org2cd2533">Tensorized 1</a></li>
<li><a href="#org0c47295">Tensorized 2</a></li>
<li><a href="#org919341b">To Index</a></li>
</ul>
</li>
<li><a href="#org9cfdb4b">The Data Transformer</a>
<ul>
<li><a href="#org91cb349">Data Path</a></li>
<li><a href="#org967866f">Data</a></li>
<li><a href="#org00b454b">Training Data</a></li>
<li><a href="#org86ae09e">Testing Data</a></li>
<li><a href="#org06dfe4b">Duplicates</a></li>
<li><a href="#org5396a59">Train Tokenizer</a></li>
<li><a href="#org5417101">Test Tokenizer</a></li>
<li><a href="#orgfb6ae93">The Vocabulary</a></li>
<li><a href="#org1958946">Tensorized Train</a></li>
<li><a href="#orgf021969">Tensorized Test</a></li>
<li><a href="#org16ab985">Test Labels</a></li>
<li><a href="#orgb26247c">The Final Data</a></li>
</ul>
</li>
<li><a href="#orgc62cd45">Test It Out</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb300316">
<h2 id="orgb300316">Transforming the Data</h2>
<div class="outline-text-2" id="text-orgb300316">
<p>We'll will be using the <a href="https://www.kaggle.com/c/quora-question-pairs/">Quora question answer</a> dataset to build a model that could identify similar questions. This is a useful task because you don't want to have several versions of the same question posted. Several times when teaching I end up responding to similar questions on piazza, or on other community forums. This data set has been labeled for you. Run the cell below to import some of the packages you will be using.</p>
</div>
<div class="outline-3" id="outline-container-org56fb996">
<h3 id="org56fb996">Imports</h3>
<div class="outline-text-3" id="text-org56fb996">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="n">expect</span><span class="p">,</span> <span class="n">contain_exactly</span>

<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my other stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd14c8cd">
<h3 id="orgd14c8cd">Set Up</h3>
<div class="outline-text-3" id="text-orgd14c8cd"></div>
<div class="outline-4" id="outline-container-org14fa6ae">
<h4 id="org14fa6ae">The Timer</h4>
<div class="outline-text-4" id="text-org14fa6ae">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0d65c69">
<h4 id="org0d65c69">NLTK</h4>
<div class="outline-text-4" id="text-org0d65c69">
<p>We need to download the <code>punkt</code> data to be able to tokenize our sentences.</p>
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"punkt"</span><span class="p">)</span>
</pre></div>
<pre class="example">
[nltk_data] Downloading package punkt to
[nltk_data]     /home/neurotic/data/datasets/nltk_data...
[nltk_data]   Package punkt is already up-to-date!
</pre></div>
</div>
<div class="outline-4" id="outline-container-org93592ef">
<h4 id="org93592ef">The Training Data</h4>
<div class="outline-text-4" id="text-org93592ef">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="s2">"posts/nlp/.env"</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"QUORA_TRAIN"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3a1ace5">
<h2 id="org3a1ace5">Middle</h2>
<div class="outline-text-2" id="text-org3a1ace5"></div>
<div class="outline-3" id="outline-container-org9b2daa1">
<h3 id="org9b2daa1">Inspecting the Data</h3>
<div class="outline-text-3" id="text-org9b2daa1">
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Rows: </span><span class="si">{</span><span class="n">rows</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> Columns: </span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Rows: 404,290 Columns: 6
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
id                                                              0
qid1                                                            1
qid2                                                            2
question1       What is the step by step guide to invest in sh...
question2       What is the step by step guide to invest in sh...
is_duplicate                                                    0
Name: 0, dtype: object
</pre>
<p>So, you can see that we have a row ID, followed by IDs for each of the questions, followed by the question-pair, and finally a label of whether the two questions are duplicates (1) or not (0).</p>
</div>
</div>
<div class="outline-3" id="outline-container-orga7e6479">
<h3 id="orga7e6479">Train Test Split</h3>
<div class="outline-text-3" id="text-orga7e6479">
<p>For the moment we're going to use a straight splitting of the dataset, rather than using a shuffled split. We're going for a roughly 75-25 split.</p>
<div class="highlight">
<pre><span></span><span class="n">training_size</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">5</span>
<span class="n">training_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">training_size</span><span class="p">]</span>
<span class="n">testing_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">training_size</span><span class="p">:]</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">training_size</span>
</pre></div>
<p>Since the data set is large, we'll delete the original pandas DataFrame to save memory.</p>
<div class="highlight">
<pre><span></span><span class="k">del</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd1b87b9">
<h3 id="orgd1b87b9">Filtering Out Non-Duplicates</h3>
<div class="outline-text-3" id="text-orgd1b87b9">
<p>We are going to use only the question pairs that are duplicate to train the model.</p>
<p>We build two batches as input for the Siamese network and we assume that question \(q1_i\) (question <i>i</i> in the first batch) is a duplicate of \(q2_i\) (question <i>i</i> in the second batch), but all other questions in the second batch are not duplicates of \(q1_i\).</p>
<p>The test set uses the original pairs of questions and the status describing if the questions are duplicates.</p>
<div class="highlight">
<pre><span></span><span class="n">duplicates</span> <span class="o">=</span> <span class="n">training_data</span><span class="p">[</span><span class="n">training_data</span><span class="o">.</span><span class="n">is_duplicate</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
<span class="n">example</span> <span class="o">=</span> <span class="n">duplicates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">question1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">question2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">is_duplicate</span><span class="p">)</span>
</pre></div>
<pre class="example">
Astrology: I am a Capricorn Sun Cap moon and cap rising...what does that say about me?
I'm a triple Capricorn (Sun, Moon and ascendant in Capricorn) What does this say about me?
1
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> duplicates for the training data."</span><span class="p">)</span>
</pre></div>
<pre class="example">
There are 111,473 duplicates for the training data.
</pre>
<p>We only took the duplicated questions for training our model because the data generator will produce batches \(([q1_1, q1_2, q1_3, ...]\), [q2_1, q2_2,q2_3, â€¦])\) where \(q1_i\) and \(q2_k\) are duplicate if and only if \(i = k\).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org89874a5">
<h3 id="org89874a5">Encoding the Words</h3>
<div class="outline-text-3" id="text-org89874a5">
<p>Now we'll encode each word of the selected duplicate pairs with an index. Given a question, we can then just encode it as a list of numbers.</p>
<p>First we'll tokenize the questions using <code>nltk.word_tokenize</code>.</p>
<p>We'll also need a python default dictionary which later, during inference, assigns the value <i>0</i> to all Out Of Vocabulary (OOV) words.</p>
</div>
<div class="outline-4" id="outline-container-orgafb1791">
<h4 id="orgafb1791">Build the Vocabulary</h4>
<div class="outline-text-4" id="text-orgafb1791">
<p>We'll start by resetting the index. Pandas preserves the original index, but since we dropped the non-duplicates it's missing rows so resetting it will start it at 0 again. By default it normally keeps the original index as a column, but passing in <code>drop=True</code> prevents that.</p>
<div class="highlight">
<pre><span></span><span class="n">reindexed</span> <span class="o">=</span> <span class="n">duplicates</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>Now we'll build the vocabulary by mapping the words to the "index" for that word in the dictionary.</p>
<div class="highlight">
<pre><span></span><span class="n">vocabulary</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">vocabulary</span><span class="p">[</span><span class="s1">'&lt;PAD&gt;'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">question_1_train</span> <span class="o">=</span> <span class="n">duplicates</span><span class="o">.</span><span class="n">question1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">)</span>
    <span class="n">question_2_train</span> <span class="o">=</span> <span class="n">duplicates</span><span class="o">.</span><span class="n">question2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">question_1_train</span> <span class="o">+</span> <span class="n">question_2_train</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">combined</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vocabulary</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> words in the vocabulary."</span><span class="p">)</span>            
</pre></div>
<pre class="example">
Started: 2021-01-30 18:36:26.773827
Ended: 2021-01-30 18:36:46.522680
Elapsed: 0:00:19.748853
There are 36,278 words in the vocabulary.
</pre>
<p>Some example vocabulary words.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="s1">'&lt;PAD&gt;'</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="s1">'Astrology'</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">[</span><span class="s1">'Astronomy'</span><span class="p">])</span>
</pre></div>
<pre class="example">
1
7
0
</pre>
<p>The last <code>0</code> indicates that, while <i>Astrology</i> is in our vocabulary, <i>Astronomy</i> is not. Peculiar.</p>
<p>Now we'll set up the test arrays. One of the Question 1 entries is empty so we'll have to drop it first.</p>
<div class="highlight">
<pre><span></span><span class="n">testing_data</span> <span class="o">=</span> <span class="n">testing_data</span><span class="p">[</span><span class="o">~</span><span class="n">testing_data</span><span class="o">.</span><span class="n">question1</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">Q1_test_words</span> <span class="o">=</span> <span class="n">testing_data</span><span class="o">.</span><span class="n">question1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">)</span>
    <span class="n">Q2_test_words</span> <span class="o">=</span> <span class="n">testing_data</span><span class="o">.</span><span class="n">question2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">)</span>
</pre></div>
<pre class="example">
Started: 2021-01-30 16:43:08.891230
Ended: 2021-01-30 16:43:27.954422
Elapsed: 0:00:19.063192
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org43706d1">
<h3 id="org43706d1">Converting a question to a tensor</h3>
<div class="outline-text-3" id="text-org43706d1">
<p>We'll now convert every question to a tensor, or an array of numbers, using the vocabulary we built above.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">words_to_index</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>

<span class="n">Q1_train</span> <span class="o">=</span> <span class="n">question_1_train</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">words_to_index</span><span class="p">)</span>
<span class="n">Q2_train</span> <span class="o">=</span> <span class="n">question_2_train</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">words_to_index</span><span class="p">)</span>

<span class="n">Q1_test</span> <span class="o">=</span> <span class="n">Q1_test_words</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">words_to_index</span><span class="p">)</span>
<span class="n">Q2_test</span> <span class="o">=</span> <span class="n">Q2_test_words</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">words_to_index</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'first question in the train set:</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">question_1_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">'encoded version:'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Q1_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<pre class="example">
first question in the train set:

['Astrology', ':', 'I', 'am', 'a', 'Capricorn', 'Sun', 'Cap', 'moon', 'and', 'cap', 'rising', '...', 'what', 'does', 'that', 'say', 'about', 'me', '?'] 

encoded version:
[7, 6, 17, 26, 22, 12, 15, 14, 2, 24, 16, 19, 31, 8, 9, 21, 25, 3, 23, 29] 

</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
77,068
</pre></div>
</div>
<div class="outline-3" id="outline-container-org6375a94">
<h3 id="org6375a94">Validation Set</h3>
<div class="outline-text-3" id="text-org6375a94">
<p>You will now split your train set into a training/validation set so that you can use it to train and evaluate your Siamese model.</p>
<div class="highlight">
<pre><span></span><span class="n">TRAINING_FRACTION</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">cut_off</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">question_1_train</span><span class="p">)</span> <span class="o">*</span> <span class="n">TRAINING_FRACTION</span><span class="p">)</span>
<span class="n">train_question_1</span><span class="p">,</span> <span class="n">train_question_2</span> <span class="o">=</span> <span class="n">Q1_train</span><span class="p">[:</span><span class="n">cut_off</span><span class="p">],</span> <span class="n">Q2_train</span><span class="p">[:</span><span class="n">cut_off</span><span class="p">]</span>
<span class="n">validation_question_1</span><span class="p">,</span> <span class="n">validation_question_2</span> <span class="o">=</span> <span class="n">Q1_train</span><span class="p">[</span><span class="n">cut_off</span><span class="p">:</span> <span class="p">],</span> <span class="n">Q2_train</span><span class="p">[</span><span class="n">cut_off</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of duplicate questions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">Q1_train</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The length of the training set is:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_question_1</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The length of the validation set is: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_question_1</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Number of duplicate questions: 111,473
The length of the training set is:  89,178
The length of the validation set is: 22,295
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org4ef1508">
<h2 id="org4ef1508">Bundling It Up</h2>
<div class="outline-text-2" id="text-org4ef1508"></div>
<div class="outline-3" id="outline-container-org446dc32">
<h3 id="org446dc32">Imports</h3>
<div class="outline-text-3" id="text-org446dc32">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org967d9f1">
<h3 id="org967d9f1">NLTK Setup</h3>
<div class="outline-text-3" id="text-org967d9f1">
<div class="highlight">
<pre><span></span><span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"punkt"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9c327d3">
<h3 id="org9c327d3">Constants and Data</h3>
<div class="outline-text-3" id="text-org9c327d3">
<div class="highlight">
<pre><span></span><span class="n">Tokens</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Tokens"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"unknown"</span><span class="p">,</span> <span class="s2">"padding"</span><span class="p">,</span> <span class="s2">"padding_token"</span><span class="p">])</span>
<span class="n">TOKENS</span> <span class="o">=</span> <span class="n">Tokens</span><span class="p">(</span><span class="n">unknown</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">padding_token</span><span class="o">=</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">)</span>

<span class="n">Question</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Question"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"question_one"</span><span class="p">,</span> <span class="s2">"question_two"</span><span class="p">])</span>
<span class="n">Data</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Data"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"train"</span><span class="p">,</span> <span class="s2">"validate"</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">,</span> <span class="s2">"y_test"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd5eddc0">
<h3 id="orgd5eddc0">The Data Tokenizer</h3>
<div class="outline-text-3" id="text-orgd5eddc0">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataTokenizer</span><span class="p">:</span>
    <span class="sd">"""Converts questions to tokens</span>

<span class="sd">    Args:</span>
<span class="sd">     data: the data-frame to tokenize</span>
<span class="sd">    """</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">_question_1</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_question_2</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org788d748">
<h4 id="org788d748">Question 1</h4>
<div class="outline-text-4" id="text-org788d748">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">question_1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">"""tokenized version of question 1"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_question_1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_question_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">question1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_question_1</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4fae38f">
<h4 id="org4fae38f">Question 2</h4>
<div class="outline-text-4" id="text-org4fae38f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">question_2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">"""tokenized version of question 2"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_question_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_question_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">question2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_question_2</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org1d8d325">
<h3 id="org1d8d325">The Data Tensorizer</h3>
<div class="outline-text-3" id="text-org1d8d325">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataTensorizer</span><span class="p">:</span>
    <span class="sd">"""Convert tokenized words to numbers</span>

<span class="sd">    Args:</span>
<span class="sd">     vocabulary: word to integer mapping</span>
<span class="sd">     question_1: data to convert</span>
<span class="sd">     question_2: other data to convert</span>
<span class="sd">    """</span>
    <span class="n">vocabulary</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">question_1</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span>
    <span class="n">question_2</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span>
    <span class="n">_tensorized_1</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tensorized_2</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org2cd2533">
<h4 id="org2cd2533">Tensorized 1</h4>
<div class="outline-text-4" id="text-org2cd2533">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tensorized_1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">"""numeric version of question 1"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">question_1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_index</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_1</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0c47295">
<h4 id="org0c47295">Tensorized 2</h4>
<div class="outline-text-4" id="text-org0c47295">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tensorized_2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">"""Numeric version of question 2"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">question_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_index</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_2</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org919341b">
<h4 id="org919341b">To Index</h4>
<div class="outline-text-4" id="text-org919341b">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">"""Convert list of words to list of integers"""</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org9cfdb4b">
<h3 id="org9cfdb4b">The Data Transformer</h3>
<div class="outline-text-3" id="text-org9cfdb4b">
<div class="highlight">
<pre><span></span><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sd">"""Loads and transforms the data</span>

<span class="sd">    Args:</span>
<span class="sd">     env: The path to the .env file with the raw-data path</span>
<span class="sd">     key: key in the environment with the path to the data</span>
<span class="sd">     train_validation_size: number of entries for the training/validation set</span>
<span class="sd">     training_fraction: what fraction of the training/valdiation set for training</span>
<span class="sd">    """</span>
    <span class="n">env</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"posts/nlp/.env"</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"QUORA_TRAIN"</span>
    <span class="n">train_validation_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">300000</span>
    <span class="n">training_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="n">_data_path</span><span class="p">:</span> <span class="n">Path</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_raw_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_training_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_testing_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_duplicates</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tokenized_train</span><span class="p">:</span> <span class="n">DataTokenizer</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tokenized_test</span><span class="p">:</span> <span class="n">DataTokenizer</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_vocabulary</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tensorized_train</span><span class="p">:</span> <span class="n">DataTensorizer</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_tensorized_test</span><span class="p">:</span> <span class="n">DataTensorizer</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">_test_labels</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="o">=</span><span class="kc">None</span>    
    <span class="n">_data</span><span class="p">:</span> <span class="n">namedtuple</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org91cb349">
<h4 id="org91cb349">Data Path</h4>
<div class="outline-text-4" id="text-org91cb349">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sd">"""Where to find the data file"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">load_dotenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org967866f">
<h4 id="org967866f">Data</h4>
<div class="outline-text-4" id="text-org967866f">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">"""The raw-data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span><span class="o">.</span><span class="n">question1</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span><span class="o">.</span><span class="n">question2</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>        
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org00b454b">
<h4 id="org00b454b">Training Data</h4>
<div class="outline-text-4" id="text-org00b454b">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">"""The training/validation part of the data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">train_validation_size</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org86ae09e">
<h4 id="org86ae09e">Testing Data</h4>
<div class="outline-text-4" id="text-org86ae09e">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">testing_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">"""The testing portion of the raw data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testing_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_testing_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_validation_size</span><span class="p">:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testing_data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org06dfe4b">
<h4 id="org06dfe4b">Duplicates</h4>
<div class="outline-text-4" id="text-org06dfe4b">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">"""training-validation data that has duplicate questions"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duplicates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duplicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">is_duplicate</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duplicates</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5396a59">
<h4 id="org5396a59">Train Tokenizer</h4>
<div class="outline-text-4" id="text-org5396a59">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tokenized_train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataTokenizer</span><span class="p">:</span>
    <span class="sd">"""training tokenized    </span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenized_train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokenized_train</span> <span class="o">=</span> <span class="n">DataTokenizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenized_train</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5417101">
<h4 id="org5417101">Test Tokenizer</h4>
<div class="outline-text-4" id="text-org5417101">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tokenized_test</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataTokenizer</span><span class="p">:</span>
    <span class="sd">"""Test Tokenizer"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenized_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokenized_test</span> <span class="o">=</span> <span class="n">DataTokenizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testing_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenized_test</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfb6ae93">
<h4 id="orgfb6ae93">The Vocabulary</h4>
<div class="outline-text-4" id="text-orgfb6ae93">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">"""The token:index map"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">TOKENS</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">TOKENS</span><span class="o">.</span><span class="n">padding_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">TOKENS</span><span class="o">.</span><span class="n">padding</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenized_train</span><span class="o">.</span><span class="n">question_1</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenized_train</span><span class="o">.</span><span class="n">question_2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">combined</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary</span>            
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1958946">
<h4 id="org1958946">Tensorized Train</h4>
<div class="outline-text-4" id="text-org1958946">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tensorized_train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataTensorizer</span><span class="p">:</span>
    <span class="sd">"""Tensorizer for the training data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_train</span> <span class="o">=</span> <span class="n">DataTensorizer</span><span class="p">(</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
            <span class="n">question_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenized_train</span><span class="o">.</span><span class="n">question_1</span><span class="p">,</span>
            <span class="n">question_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenized_train</span><span class="o">.</span><span class="n">question_2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_train</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf021969">
<h4 id="orgf021969">Tensorized Test</h4>
<div class="outline-text-4" id="text-orgf021969">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">tensorized_test</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataTensorizer</span><span class="p">:</span>
    <span class="sd">"""Tensorizer for the testing data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_test</span> <span class="o">=</span> <span class="n">DataTensorizer</span><span class="p">(</span>
            <span class="n">vocabulary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">,</span>
            <span class="n">question_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenized_test</span><span class="o">.</span><span class="n">question_1</span><span class="p">,</span>
            <span class="n">question_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenized_test</span><span class="o">.</span><span class="n">question_2</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tensorized_test</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org16ab985">
<h4 id="org16ab985">Test Labels</h4>
<div class="outline-text-4" id="text-org16ab985">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">test_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">"""The labels for the test data</span>

<span class="sd">    0 : not duplicate questions</span>
<span class="sd">    1 : is duplicate</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing_data</span><span class="o">.</span><span class="n">is_duplicate</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_labels</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb26247c">
<h4 id="orgb26247c">The Final Data</h4>
<div class="outline-text-4" id="text-orgb26247c">
<div class="highlight">
<pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
    <span class="sd">"""The final tensorized data"""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cut_off</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_fraction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span>
            <span class="n">train</span><span class="o">=</span><span class="n">Question</span><span class="p">(</span>
                <span class="n">question_one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorized_train</span><span class="o">.</span><span class="n">tensorized_1</span><span class="p">[:</span><span class="n">cut_off</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">question_two</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorized_train</span><span class="o">.</span><span class="n">tensorized_2</span><span class="p">[:</span><span class="n">cut_off</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
            <span class="n">validate</span><span class="o">=</span><span class="n">Question</span><span class="p">(</span>
                <span class="n">question_one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorized_train</span><span class="o">.</span><span class="n">tensorized_1</span><span class="p">[</span><span class="n">cut_off</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">question_two</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorized_train</span><span class="o">.</span><span class="n">tensorized_2</span><span class="p">[</span><span class="n">cut_off</span><span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
            <span class="n">test</span><span class="o">=</span><span class="n">Question</span><span class="p">(</span>
                <span class="n">question_one</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorized_test</span><span class="o">.</span><span class="n">tensorized_1</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">question_two</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorized_test</span><span class="o">.</span><span class="n">tensorized_2</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
            <span class="n">y_test</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc62cd45">
<h3 id="orgc62cd45">Test It Out</h3>
<div class="outline-text-3" id="text-orgc62cd45">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.nlp.siamese_networks</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">data</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Number of duplicate questions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">duplicates</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The length of the training set is:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">question_one</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The length of the validation set is: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">question_one</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Number of duplicate questions: 111,474
The length of the training set is:  89,179
The length of the validation set is: 22,295
</pre>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'first question in the train set:</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">duplicates</span><span class="o">.</span><span class="n">question1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'encoded version:'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">question_one</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">question_one</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">contain_exactly</span><span class="p">(</span><span class="o">*</span><span class="n">Q1_train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
<pre class="example">
first question in the train set:

Astrology: I am a Capricorn Sun Cap moon and cap rising...what does that say about me?
encoded version:
[7, 6, 17, 26, 22, 12, 15, 14, 2, 24, 16, 19, 31, 8, 9, 21, 25, 3, 23, 29] 

</pre>
<div class="highlight">
<pre><span></span><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
77,068
</pre></div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/nlp/" rel="tag">nlp</a></li>
<li><a class="tag p-category" href="../../../categories/siamese-networks/" rel="tag">siamese networks</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../siamese-networks-duplicate-questions/" rel="prev" title="Siamese Networks: Duplicate Questions">Previous post</a></li>
<li class="next"><a href="../siamese-networks-the-data-generator/" rel="next" title="Siamese Networks: The Data Generator">Next post</a></li>
</ul>
</nav>
</aside>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']],},

        });
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script>
<script>

    MathJax = {
        tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true,
            processEnvironments: true,
        }
    }
</script>
<link href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.js"></script></article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
