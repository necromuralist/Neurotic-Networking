#+BEGIN_COMMENT
.. title: Is it a raccoon?
.. slug: fastai-lesson-0-is-it-a-bird
.. date: 2022-11-07 16:12:55 UTC-08:00
.. tags: fastai
.. category: FastAI
.. link: 
.. description: 
.. type: text

#+END_COMMENT
#+PROPERTY: header-args :session ~/.local/share/jupyter/runtime/kernel-35844eaa-8d1f-423c-a97e-c3d79528dfb8-ssh.json
#+OPTIONS: ^:{}
#+OPTIONS: H:5
#+TOC: headlines 2
#+BEGIN_SRC python :session fastai :results none :exports none
%load_ext autoreload
%autoreload 2
#+END_SRC
* What Is This?
This is a run-through of some of the ideas from Lesson 0 of the FastAI [[https://course.fast.ai/][Practical Deep Learning for Coders]] course (sort of, there's a 2022 version that I'm using which doesn't seem to exactly match the lectures on the website). In it we search for photos using a search engine and build a neural-network to classify the images that belong to one of the two classes of photos that we use. This is an image classification example, like the {{% lancelot "Cats vs Dogs" %}}fastai-cats-and-dogs{{% /lancelot %}} post but it has the added feature of demonstrating how to build your own dataset using a search-engine. I'll be using [[https://en.wikipedia.org/wiki/Japanese_raccoon_dog][Tanuki (the Japanese Raccoon Dog)]] and [[https://en.wikipedia.org/wiki/Raccoon][Raccoon]] images as the categories to classify.

** Imports

For the search engine we'll use [[https://duckduckgo.com/][DuckDuckGo]] via the [[https://github.com/deedy5/duckduckgo_search][duckduckgo-search]] package (from [[https://pypi.org/project/duckduckgo-search/][pypi]]).

#+begin_src python :results none
# python
from functools import partial
from pathlib import Path
from time import sleep

# pypi
from duckduckgo_search import ddg_images

# fastai
from fastcore.all import L as ListLike
from fastai.data.all import (
    CategoryBlock,
    DataBlock,
    parent_label,
    RandomSplitter,
)
from fastai.vision.all import (
    download_images,
    get_image_files,
    ImageBlock,
    Resize,
    resnet18,
    resize_images,
    verify_images,
    vision_learner,
    error_rate,
    PILImage,
)
from fastdownload import download_url

# monkey shines
from graeae import Timer

TIMER = Timer()
#+end_src

* Getting the Images
We're going to create an alias for the ~ddg_images~ function to make the search and then return only the URLs of the images that DuckDuckGo finds. 

#+begin_src python :results none
def get_image_urls(keywords: str,
                   max_images: int=200,
                   license_image: str="any",
                   key="image") -> ListLike:
    """Search duckduckgo images

    Args:
     keywords: A string with keywords to give to duckduckgo
     max_images: the upper limit for how many images to return

    Returns:
     a list-like object with the URLs of the images found
    """
    return ListLike(
        ddg_images(keywords,
                   type_image="photo",
                   license_image=license_image,
                   max_results=max_images)).itemgot(key)
#+end_src

** A Test Of Tanuki
We'll start by checking that our searcher is working using the keywords "tanuki" and "racoon". First, what does ~ddg_images~ return?

#+begin_src python :results output :exports both
o = ddg_images("tanuki", type_image="photo", max_results=1)
print(o)
#+end_src

#+RESULTS:
: [{'title': 'Tanuki | Animal Jam Fanon Wiki | Fandom', 'image': 'https://vignette.wikia.nocookie.net/ajfanideas/images/6/6a/God_damnit.png/revision/latest?cb=20190222141158', 'thumbnail': 'https://tse3.mm.bing.net/th?id=OIP.74LPltCuN75QxFq2RHLhywHaFj&pid=Api', 'url': 'https://ajfanideas.fandom.com/wiki/Tanuki', 'height': 1200, 'width': 1600, 'source': 'Bing'}]

So it looks like it returns a list of json/dict objects.

#+begin_src python :results output :exports both
print("|Key | Value|")
print("|-+-|")
for key, value in o[0].items():
    print(f"|{key}| {value}|")
#+end_src

#+RESULTS:
| Key       | Value                                                                                                       |                       |        |
|-----------+-------------------------------------------------------------------------------------------------------------+-----------------------+--------|
| title     | Tanuki                                                                                                      | Animal Jam Fanon Wiki | Fandom |
| image     | https://vignette.wikia.nocookie.net/ajfanideas/images/6/6a/God_damnit.png/revision/latest?cb=20190222141158 |                       |        |
| thumbnail | https://tse3.mm.bing.net/th?id=OIP.74LPltCuN75QxFq2RHLhywHaFj&pid=Api                                       |                       |        |
| url       | https://ajfanideas.fandom.com/wiki/Tanuki                                                                   |                       |        |
| height    | 1200                                                                                                        |                       |        |
| width     | 1600                                                                                                        |                       |        |
| source    | Bing                                                                                                        |                       |        |

Our helper function above (~get_image_urls~) uses the ~ListLike~ (actually ~L~) class to extract the values for the "image" key, which, returns the URL to the image, as opposed to the "url" key which returns the URL to the page that holds the image. Let's test our function using an image that was explicitly identified as Public Domain so I don't have to worry about the different Creative Commons license conditions.

#+begin_src python :results output :exports both
URLS = get_image_urls("tanuki", max_images=1, license_image="Public")
print(URLS[0])
#+end_src

#+RESULTS:
: https://c.pxhere.com/photos/04/ff/animal_marten_raccoon_dog_tanuki_enok_obstfuchs_omnivore_fur-705793.jpg!d

And now let's try and download a thumbnail of it.

#+begin_src python :results none
THUMBS = get_image_urls("tanuki", max_images=1, license_image="Public", key="thumbnail")
TANUKI_OUTPUT = "/tmp/tanuki_thumb.jpg"
download_url(THUMBS[0], TANUKI_OUTPUT, show_progress=False)
#+end_src

And Here's the thumbnail we downloaded.

[[file:tanuki_thumb.jpg]]

Seems to work.

Now for the raccoon.

#+begin_src python :results none
RACCOON_OUTPUT = "/tmp/raccoon_thumb.jpg"
RACCOON_URLS = get_image_urls("raccoon",
                             max_images=1,
                             license_image="Public", key="thumbnail")

download_url(RACCOON_URLS[0],
             RACCOON_OUTPUT,
             show_progress=False)
#+end_src


[[file:raccoon_thumb.jpg]]

** Build A Data Set

#+begin_src python :results output :exports both
KEYWORDS = ("tanuki", "raccoon")
DATA_PATH = Path("/tmp/tanuki-or-raccoon/")
PAUSE = 10
PAUSE_BETWEEN_SEARCHES = partial(sleep, PAUSE)
CONDITIONS = tuple(("", "sun ", "shade "))
IMAGE_MAXIMUM = 400

print(f"Estimated Run Time: {len(CONDITIONS) * len(KEYWORDS) * PAUSE} seconds")

with TIMER:
    for keyword in KEYWORDS:
        destination = DATA_PATH/keyword
        destination.mkdir(exist_ok=True, parents=True)        
        
        for condition in CONDITIONS:
            SEARCH_TERMS = f"{keyword} {condition}"
            print(SEARCH_TERMS)
            download_images(
                destination,
                urls=search_images(SEARCH_TERMS)
            )
            PAUSE_BETWEEN_SEARCHES()
            resize_images(destination,
                          max_size=IMAGE_MAXIMUM,
                          dest=destination)
#+end_src

#+RESULTS:
: Estimated Run Time: 60 seconds
: Started: 2022-11-20 19:36:39.001160
: tanuki 
: tanuki sun 
: tanuki shade 
: raccoon 
: raccoon sun 
: raccoon shade 
: Ended: 2022-11-20 19:39:27.331436
: Elapsed: 0:02:48.330276



** Verify the Dataset

Some of the images might be invalid for whatever reason, we'll use a fastai builtin function (~verify_images~) to check them and [[https://docs.python.org/3/library/pathlib.html#pathlib.Path.unlink][Path.unlnk]] to delete the files that were deemed invalid.

#+begin_src python :results output :exports both
failed = verify_images(get_image_files(DATA_PATH))
failed.map(Path.unlink)
print(f"{len(failed)} images were deemed failures.")
#+end_src

#+RESULTS:
: 15 images were deemed failures.

* Training the Model

#+begin_src python :results none
loaders = DataBlock(
    blocks=(ImageBlock, CategoryBlock), 
    get_items=get_image_files, 
    splitter=RandomSplitter(valid_pct=0.2, seed=42),
    get_y=parent_label,
    item_tfms=[Resize(192, method='squish')]
).dataloaders(DATA_PATH)
#+end_src

| Parameter | Argument                      | Description                                                               |
|-----------+-------------------------------+---------------------------------------------------------------------------|
| blocks    | (~ImageBlock, CategoryBlock~) | Defines the inputs as images and outputs as categories                    |
| get_items | ~get_image_files~             | A function to search for image files.                                     |
| splitter  | ~RandomSplitter~              | A class to split the data into training (80%) and validation (20%)        |
| get_y     | ~parent_label~                | A function that grabs the name of the folder an image is in as the label. |
| item_tfms | ~Resize~                      | Resize all the images to a uniform size (192 x 192)                       |


#+begin_src python :results output :exports both
learner = vision_learner(loaders, resnet18, metrics=error_rate)
with learner.no_bar():
    learner.fine_tune(3)
#+end_src

#+RESULTS:
: /home/athena/.conda/envs/neurotic-fastai/lib/python3.9/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and may be removed in the future, please use 'weights' instead.
:   warnings.warn(
: /home/athena/.conda/envs/neurotic-fastai/lib/python3.9/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=ResNet18_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet18_Weights.DEFAULT` to get the most up-to-date weights.
:   warnings.warn(msg)
: [0, 0.5389516949653625, 0.23803706467151642, 0.08648648858070374, '01:22']
: [0, 0.1865328848361969, 0.1018112376332283, 0.03567567467689514, '01:52']
: [1, 0.08857729285955429, 0.09243999421596527, 0.0324324332177639, '01:51']
: [2, 0.04247060418128967, 0.07865928113460541, 0.031351350247859955, '01:52']

It looks like fastai has to update their code to match pytorch eventually.

* Some Examples

** A Helper

#+begin_src python :results none
def predict_category(path: str, learner) -> tuple:
    
    with learner.no_bar():
        prediction, probability_index, probabilities = learner.predict(
            PILImage.create(path))
    print(f"This is a {prediction}.")
    print(f"Probability it's a {prediction}: {float(probabilities[int(probability_index)]):.2f}")
    return prediction, probability_index, probabilities

predict = partial(predict_category, learner=learner)
#+end_src

** A Rabbit

Let's look at the output of the ~learner.predict~ method when we pass the model the picture of a rabbit that we looked at when we were looking at the duckduckgo search example.

#+begin_src python :results output :exports both
prediction, probability_index, probabilities = predict(RABBIT_OUTPUT)
#+end_src

#+RESULTS:
: This is a rabbit.
: Probability it's a rabbit: 1.00

The ~prediction~ returned by ~learner.predict~ is a string version of whatever your labeling function (~parent_label~ in this case) returns.

#+begin_src python :results output :exports both
print(prediction)
#+end_src

#+RESULTS:
: rabbit

The ~probabilities~ is a ~TensorBase~ which, for our purposes, acts like a list of the probabilities for each classification matching our image.

#+begin_src python :results output :exports both
print(probabilities)
#+end_src

#+RESULTS:
: TensorBase([2.9848e-07, 1.0000e+00])

The ~probability_index~ tells you which one of the probabilities matches the predicted classification.

#+begin_src python :results output :exports both
print(probability_index)
#+end_src

#+RESULTS:
: TensorBase(1)

So, since the probability index is 1, the "rabbit" category matches the second entry in the ~probabilities~ collection.

** It's a Bird, It's a Plane
Let's look at a couple of examples to see how the model does. First, a crow.

[[file:crow.jpg]]

#+begin_src python :results output :exports both
predict("/tmp/crow.jpg")
#+end_src

#+RESULTS:
: This is a pig.
: Probability it's a pig: 1.00

It's not surprising that we got it wrong, since we only have "rabbit" and "pig" as our categories. It's odd how certain the model is that it's a pig, though. I wonder what features of the crow make it more pig than rabbit?

We did the rabbit when we looked at the output of the ~predict~ method so let's try our pig here.

#+begin_src python :results output :exports both
predict(PIG_OUTPUT)
#+end_src

#+RESULTS:
: This is a pig.
: Probability it's a pig: 1.00

The rabbit and pig images were part of the dataset we used to build the training and validation sets so we shouldn't get too excited about their ability to predict the images, but these examples show you how you would use the model once it's been re-trained.

* Sources
- [[https://commons.wikimedia.org/wiki/File:Corvus_corone_-near_Canford_Cliffs,_Poole,_England-8.jpg][Crow Image]]: Ian Kirk from Broadstone, Dorset, UK, CC BY 2.0, via Wikimedia Commons
