<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Creating a dataset for image identification using duckduckgo." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Raccoon Or Raccoon Dog? | Neurotic Networking</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/posts/fastai/fastai-lesson-0-is-it-a-bird/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<link href="../../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../fastai-quickstart-tabular-data/" rel="prev" title="FastAI QuickStart Tabular Data" type="text/html">
<link href="../fastai-saving-a-model/" rel="next" title="FastAI: Saving a Model" type="text/html">
<meta content="Neurotic Networking" property="og:site_name">
<meta content="Raccoon Or Raccoon Dog?" property="og:title">
<meta content="https://necromuralist.github.io/Neurotic-Networking/posts/fastai/fastai-lesson-0-is-it-a-bird/" property="og:url">
<meta content="Creating a dataset for image identification using duckduckgo." property="og:description">
<meta content="article" property="og:type">
<meta content="2022-11-07T16:12:55-08:00" property="article:published_time">
<meta content="fastai" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../../"><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../../rss.xml">RSS feed</a></li>
<li class="nav-item"><a class="nav-link" href="https://necromuralist.github.io/">Cloistered Monkey</a></li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Raccoon Or Raccoon Dog?</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2022-11-07T16:12:55-08:00" itemprop="datePublished" title="2022-11-07 16:12">2022-11-07 16:12</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org15cc105">What Is This?</a>
<ul>
<li><a href="#org460206a">Imports</a></li>
</ul>
</li>
<li><a href="#org2266d11">Getting the Images</a>
<ul>
<li><a href="#orgbb14e46">A Test Of Tanuki</a></li>
<li><a href="#org293e51a">Build A Data Set</a></li>
<li><a href="#org87eb0ac">Verify the Dataset</a></li>
</ul>
</li>
<li><a href="#org2236c9e">Training the Model</a></li>
<li><a href="#org7515ae9">Some Examples</a>
<ul>
<li><a href="#orgef89894">A Helper</a></li>
<li><a href="#org594c7bc">A Tanuki</a></li>
<li><a href="#orgb83b887">Now, a Raccoon</a></li>
</ul>
</li>
<li><a href="#org7999e22">And Then, the End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org15cc105">
<h2 id="org15cc105">What Is This?</h2>
<div class="outline-text-2" id="text-org15cc105">
<p>This is a run-through of some of the ideas from Lesson 0 of the FastAI <a href="https://course.fast.ai/">Practical Deep Learning for Coders</a> course (sort of, there's a 2022 version that I'm using which doesn't seem to exactly match the lectures on the website). In it we search for photos using a search engine and build a neural-network to classify the images that belong to one of the two classes of photos that we use. This is an image classification example, like the <a href="../fastai-cats-and-dogs/">Cats vs Dogs</a> post but it has the added feature of demonstrating how to build your own dataset using a search-engine. I'll be using <a href="https://en.wikipedia.org/wiki/Japanese_raccoon_dog">Tanuki (the Japanese Raccoon Dog)</a> and <a href="https://en.wikipedia.org/wiki/Raccoon">Raccoon</a> images as the categories to classify.</p>
</div>
<div class="outline-3" id="outline-container-org460206a">
<h3 id="org460206a">Imports</h3>
<div class="outline-text-3" id="text-org460206a">
<p>For the search engine we'll use <a href="https://duckduckgo.com/">DuckDuckGo</a> via the <a href="https://github.com/deedy5/duckduckgo_search">duckduckgo-search</a> package (from <a href="https://pypi.org/project/duckduckgo-search/">pypi</a>) and its <a href="../../duckduckgo-image-search/"><code>ddg_images</code></a> function..</p>
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">warnings</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">duckduckgo_search</span> <span class="kn">import</span> <span class="n">ddg_images</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># fastai</span>
<span class="kn">from</span> <span class="nn">fastai.data.all</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CategoryBlock</span><span class="p">,</span>
    <span class="n">DataBlock</span><span class="p">,</span>
    <span class="n">parent_label</span><span class="p">,</span>
    <span class="n">RandomSplitter</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">download_images</span><span class="p">,</span>
    <span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">ImageBlock</span><span class="p">,</span>
    <span class="n">Resize</span><span class="p">,</span>
    <span class="n">resnet18</span><span class="p">,</span>
    <span class="n">resize_images</span><span class="p">,</span>
    <span class="n">verify_images</span><span class="p">,</span>
    <span class="n">vision_learner</span><span class="p">,</span>
    <span class="n">error_rate</span><span class="p">,</span>
    <span class="n">PILImage</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">fastcore.net</span> <span class="kn">import</span> <span class="n">urlsave</span>

<span class="c1"># monkey shines</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"FASTAI_DATA"</span><span class="p">])</span><span class="o">/</span><span class="s2">"raccoon-vs-tanuki"</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
</pre></div>
<p><b>Note:</b> The <code>DATA_PATH</code> is where we're going to store the images we download. We are going to use a function (<code>parent_label</code>) that uses the folders within this directory to label the images within the folders (so images in a folder named "herbert" will be labeled "herbert"). This means that it should only have the folders that we are going to use to build the model. I originally set it to the fastai root root data path which then made the data loader think that all the other data folders were labels as well, so I created a sub-folder named "raccoon-vs-tanuki" to isolate the images I need to train the model.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2266d11">
<h2 id="org2266d11">Getting the Images</h2>
<div class="outline-text-2" id="text-org2266d11">
<p>We're going to create an alias for the <a href="../../duckduckgo-image-search/"><code>ddg_images</code></a> function to make the search and then return only the URLs of the images (or their thumbnails) that DuckDuckGo finds.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_image_urls</span><span class="p">(</span><span class="n">keywords</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">max_images</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                   <span class="n">license_image</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"any"</span><span class="p">,</span>
                   <span class="n">key</span><span class="o">=</span><span class="s2">"image"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Search duckduckgo images</span>

<span class="sd">    Args:</span>
<span class="sd">     keywords: A string with keywords to give to duckduckgo</span>
<span class="sd">     max_images: the upper limit for how many images to return</span>

<span class="sd">    Returns:</span>
<span class="sd">     a list-like object with the URLs of the images found</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> 
            <span class="n">ddg_images</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span>
                       <span class="n">type_image</span><span class="o">=</span><span class="s2">"photo"</span><span class="p">,</span>
                       <span class="n">license_image</span><span class="o">=</span><span class="n">license_image</span><span class="p">,</span>
                       <span class="n">max_results</span><span class="o">=</span><span class="n">max_images</span><span class="p">)]</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgbb14e46">
<h3 id="orgbb14e46">A Test Of Tanuki</h3>
<div class="outline-text-3" id="text-orgbb14e46">
<p>We'll start by checking that our searcher is working using the keywords "tanuki" and "racoon". First, what does <code>ddg_images</code> return when we search for tanuki?</p>
<div class="highlight">
<pre><span></span><span class="n">o</span> <span class="o">=</span> <span class="n">ddg_images</span><span class="p">(</span><span class="s2">"tanuki"</span><span class="p">,</span> <span class="n">type_image</span><span class="o">=</span><span class="s2">"photo"</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</pre></div>
<pre class="example">
[{'title': 'Tanuki | Animal Jam Fanon Wiki | Fandom', 'image': 'https://vignette.wikia.nocookie.net/ajfanideas/images/6/6a/God_damnit.png/revision/latest?cb=20190222141158', 'thumbnail': 'https://tse3.mm.bing.net/th?id=OIP.74LPltCuN75QxFq2RHLhywHaFj&amp;pid=Api', 'url': 'https://ajfanideas.fandom.com/wiki/Tanuki', 'height': 1200, 'width': 1600, 'source': 'Bing'}]
</pre>
<p>So it looks like it returns a list of json/dict objects. I'll print it out in a table to maybe make it easier to see. First, the title contains 'pipes' that break the table so I'll replace them with dashes.</p>
<div class="highlight">
<pre><span></span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"title"</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"title"</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"|"</span><span class="p">,</span> <span class="s2">","</span><span class="p">)</span>
</pre></div>
<p>Now the table.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"|Key | Value|"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"|-+-|"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">| </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">|"</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Key</th>
<th class="org-left" scope="col">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">title</td>
<td class="org-left">Tanuki , Animal Jam Fanon Wiki , Fandom</td>
</tr>
<tr>
<td class="org-left">image</td>
<td class="org-left"><img alt="latest?cb=20190222141158" src="https://vignette.wikia.nocookie.net/ajfanideas/images/6/6a/God_damnit.png/revision/latest?cb=20190222141158"></td>
</tr>
<tr>
<td class="org-left">thumbnail</td>
<td class="org-left"><a href="https://tse3.mm.bing.net/th?id=OIP.74LPltCuN75QxFq2RHLhywHaFj&amp;pid=Api">https://tse3.mm.bing.net/th?id=OIP.74LPltCuN75QxFq2RHLhywHaFj&amp;pid=Api</a></td>
</tr>
<tr>
<td class="org-left">url</td>
<td class="org-left"><a href="https://ajfanideas.fandom.com/wiki/Tanuki">https://ajfanideas.fandom.com/wiki/Tanuki</a></td>
</tr>
<tr>
<td class="org-left">height</td>
<td class="org-left">1200</td>
</tr>
<tr>
<td class="org-left">width</td>
<td class="org-left">1600</td>
</tr>
<tr>
<td class="org-left">source</td>
<td class="org-left">Bing</td>
</tr>
</tbody>
</table>
<p>Looking at the image URL you might not guess that it was an image of a tanuki (is the tanuki named "God damnit"?), but the title suggests that it is. Interestingly, if you follow the URL to the page where the image comes from you'll see that it's a wiki dedicated to a game called "Animal Jam" but the author of the page says that they couldn't find an image of the tanuki from the game so it is, indeed, a photo of a real tanuki, not a game character.</p>
<p>That's the output of <code>ddg_images</code> but we created <code>get_image_urls</code> to make it a little simpler to get just the URLs so let's search for "tanuki" images again but this time I'm going to download and show the image so I'll specify that I want to pull the image from the Public Domain.</p>
<div class="highlight">
<pre><span></span><span class="n">TANUKI_URLS</span> <span class="o">=</span> <span class="n">get_image_urls</span><span class="p">(</span><span class="s2">"tanuki"</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">license_image</span><span class="o">=</span><span class="s2">"Public"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TANUKI_URLS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
https://c.pxhere.com/photos/04/ff/animal_marten_raccoon_dog_tanuki_enok_obstfuchs_omnivore_fur-705793.jpg!d
</pre>
<p>The images are usually pretty big so let's download a thumbnail of the image and take a look at it to make sure we're getting the image we expect. The original fastai notebook uses the fastai <code>download_url</code> function (which appears to come from another fastai project called <a href="https://github.com/fastai/fastdownload/tree/master/">fastdownload (github</a>, <a href="https://fastdownload.fast.ai/">documentation</a>)) but, it looks like all this function is doing is starting a progress bar (which I can't use here) and then calling <code>urlsave</code> from another fastai library called <a href="https://github.com/fastai/fastcore">fastcore</a> (<a href="https://fastcore.fast.ai/">documentation</a>) so I'll use <code>urlsave</code> instead.</p>
<div class="highlight">
<pre><span></span><span class="n">THUMBS</span> <span class="o">=</span> <span class="n">get_image_urls</span><span class="p">(</span><span class="s2">"tanuki"</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">license_image</span><span class="o">=</span><span class="s2">"Public"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">"thumbnail"</span><span class="p">)</span>
<span class="n">TANUKI_OUTPUT</span> <span class="o">=</span> <span class="s2">"/tmp/tanuki_thumb.jpg"</span>
<span class="n">urlsave</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">THUMBS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">TANUKI_OUTPUT</span><span class="p">)</span>
</pre></div>
<p>And Here's the thumbnail we downloaded.</p>
<div class="figure" id="orge90505d">
<p><img alt="tanuki_thumb.jpg" src="tanuki_thumb.jpg"></p>
</div>
<p>Seems to work. One disadvantage to using the <code>get_image_urls</code> to alias the <code>ddg_images</code> function is that we end up throwing away the other information, so to get the source URL to see the page where the image comes from we have to make another function call.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_image_urls</span><span class="p">(</span><span class="s2">"tanuki"</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">license_image</span><span class="o">=</span><span class="s2">"Public"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">"url"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
https://pxhere.com/en/photo/705793
</pre>
<p>This image comes from <a href="https://pxhere.com/">pxhere.com</a> which appears to be a public domain image hosting site.</p>
<p>Now for the raccoon.</p>
<div class="highlight">
<pre><span></span><span class="n">RACCOON_OUTPUT</span> <span class="o">=</span> <span class="s2">"/tmp/raccoon_thumb.jpg"</span>
<span class="n">RACCOON_URLS</span> <span class="o">=</span> <span class="n">get_image_urls</span><span class="p">(</span><span class="s2">"raccoon"</span><span class="p">,</span>
                             <span class="n">max_images</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">license_image</span><span class="o">=</span><span class="s2">"Public"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">"thumbnail"</span><span class="p">)</span>

<span class="n">urlsave</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">RACCOON_URLS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">RACCOON_OUTPUT</span><span class="p">)</span>
</pre></div>
<div class="figure" id="org43e8bd6">
<p><img alt="raccoon_thumb.jpg" src="raccoon_thumb.jpg"></p>
</div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">get_image_urls</span><span class="p">(</span><span class="s2">"raccoon"</span><span class="p">,</span>
                     <span class="n">max_images</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">license_image</span><span class="o">=</span><span class="s2">"Public"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">"url"</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<pre class="example">
http://www.publicdomainpictures.net/view-image.php?image=33712&amp;picture=raccoon-4&amp;large=1
</pre></div>
</div>
<div class="outline-3" id="outline-container-org293e51a">
<h3 id="org293e51a">Build A Data Set</h3>
<div class="outline-text-3" id="text-org293e51a">
<p>Now that we've done a little check of what our function does we can move on to creating our dataset using it. When you download an archived dataset from fastai it saves it to the <code>~/.fastai/</code> directory, so I'll put this dataset there too. I'll use fastai's <code>download_images</code> function to do the actual downloading.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">download_images</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
<pre class="example">
Download images listed in text file `url_file` to path `dest`, at most `max_pics`
</pre>
<p>These are the arguments it takes.</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Argument</th>
<th class="org-left" scope="col">Meaning</th>
<th class="org-left" scope="col">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">dest</td>
<td class="org-left">Folder Path to save files to</td>
<td class="org-left">None (required)</td>
</tr>
<tr>
<td class="org-left">url_file</td>
<td class="org-left">Text file with one URL per line to use as source</td>
<td class="org-left">None (only used if <code>urls</code> is None)</td>
</tr>
<tr>
<td class="org-left">urls</td>
<td class="org-left">Iterable collection of URLs to download</td>
<td class="org-left">None</td>
</tr>
<tr>
<td class="org-left">max_pics</td>
<td class="org-left">Limit on the number of images to download</td>
<td class="org-left">1000</td>
</tr>
<tr>
<td class="org-left">n_workers</td>
<td class="org-left">Number of parallel threads to use</td>
<td class="org-left">8</td>
</tr>
<tr>
<td class="org-left">timeout</td>
<td class="org-left">Seconds to allow for a download</td>
<td class="org-left">4</td>
</tr>
<tr>
<td class="org-left">preserve_filename</td>
<td class="org-left">Whether to use the filename in the URL</td>
<td class="org-left">False</td>
</tr>
</tbody>
</table>
<p>We'll add two extra keywords - "sun" and "shade" to the search to hopefully get images that match those conditions and between each search query I'll put in a sleep so that we aren't hitting the server too hard. We'll also use fastai's <code>resize_images</code> to make sure that none of the images are too big. The argument <code>max_size</code> gives the maximum number of pixels either dimension (height or width) can have.</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">download_and_resize</span><span class="p">(</span><span class="n">destination</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">search_terms</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Download images and resize them</span>

<span class="sd">    Args:</span>
<span class="sd">     destination: path to parent folder</span>
<span class="sd">     search_terms: keywords to use to search for images</span>
<span class="sd">     max_size: maximum size for height and width of images</span>
<span class="sd">    """</span>
    <span class="n">download_images</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
        <span class="n">urls</span><span class="o">=</span><span class="n">get_image_urls</span><span class="p">(</span><span class="n">SEARCH_TERMS</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">resize_images</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
                  <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                  <span class="n">dest</span><span class="o">=</span><span class="n">destination</span><span class="p">)</span>
    <span class="k">return</span>
</pre></div>
<p>The <code>path</code> argument is the <i>source</i> of the images and the <code>dest</code> is where you want to put the resized images. Normally I don't suppose you'd want to remove the original images, but in this case I do so they're set to the same folder.</p>
<div class="highlight">
<pre><span></span><span class="n">ANIMALS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"tanuki"</span><span class="p">,</span> <span class="s2">"raccoon"</span><span class="p">)</span>

<span class="n">PAUSE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">PAUSE_BETWEEN_SEARCHES</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">sleep</span><span class="p">,</span> <span class="n">PAUSE</span><span class="p">)</span>
<span class="n">CONDITIONS</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"sun "</span><span class="p">,</span> <span class="s2">"shade "</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Estimated Run Time: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">CONDITIONS</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">ANIMALS</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PAUSE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">15</span><span class="si">}</span><span class="s2"> seconds"</span><span class="p">)</span>

<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Searching for:"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">ANIMALS</span><span class="p">:</span>
        <span class="n">destination</span> <span class="o">=</span> <span class="n">DATA_PATH</span><span class="o">/</span><span class="n">animal</span>
        <span class="n">destination</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">CONDITIONS</span><span class="p">:</span>
            <span class="n">SEARCH_TERMS</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">animal</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2">"</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - '</span><span class="si">{</span><span class="n">SEARCH_TERMS</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
            <span class="n">download_and_resize</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">SEARCH_TERMS</span><span class="p">)</span>
            <span class="n">PAUSE_BETWEEN_SEARCHES</span><span class="p">()</span>
</pre></div>
<pre class="example" id="org3f50b4d">
Estimated Run Time: 75 seconds
Started: 2022-12-08 18:24:00.371278
Searching for:
 - 'tanuki '
 - 'tanuki sun '
 - 'tanuki shade '
 - 'raccoon '
 - 'raccoon sun '
 - 'raccoon shade '
Ended: 2022-12-08 18:27:07.360951
Elapsed: 0:03:06.989673
</pre></div>
</div>
<div class="outline-3" id="outline-container-org87eb0ac">
<h3 id="org87eb0ac">Verify the Dataset</h3>
<div class="outline-text-3" id="text-org87eb0ac">
<p>Some of the images might be invalid for whatever reason, we'll use a fastai builtin function (<code>verify_images</code>) to check them and <a href="https://docs.python.org/3/library/pathlib.html#pathlib.Path.unlink">Path.unlnk</a> to delete the files that were deemed invalid. <code>verify_images</code> works by trying to open each file as an image. It adds some parallelism to speed it up but isn't doing anything fancy and, depending on how many files you have and their size, might take a little while to cmoplete.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="n">verify_images</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">))</span>
    <span class="n">failed</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">unlink</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span><span class="si">}</span><span class="s2"> images were deemed failures."</span><span class="p">)</span>
</pre></div>
<pre class="example">
Started: 2022-12-08 18:28:17.277347
Ended: 2022-12-08 18:28:22.806488
Elapsed: 0:00:05.529141
18 images were deemed failures.
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org2236c9e">
<h2 id="org2236c9e">Training the Model</h2>
<div class="outline-text-2" id="text-org2236c9e">
<div class="highlight">
<pre><span></span><span class="n">loaders</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">CategoryBlock</span><span class="p">),</span> 
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span> 
    <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(</span><span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">parent_label</span><span class="p">,</span>
    <span class="n">item_tfms</span><span class="o">=</span><span class="p">[</span><span class="n">Resize</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'squish'</span><span class="p">)]</span>
<span class="p">)</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">)</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Parameter</th>
<th class="org-left" scope="col">Argument</th>
<th class="org-left" scope="col">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">blocks</td>
<td class="org-left">(<code>ImageBlock, CategoryBlock</code>)</td>
<td class="org-left">Defines the inputs as images and outputs as categories</td>
</tr>
<tr>
<td class="org-left">get_items</td>
<td class="org-left"><code>get_image_files</code></td>
<td class="org-left">A function to search for image files.</td>
</tr>
<tr>
<td class="org-left">splitter</td>
<td class="org-left"><code>RandomSplitter</code></td>
<td class="org-left">A class to split the data into training (80%) and validation (20%)</td>
</tr>
<tr>
<td class="org-left">get_y</td>
<td class="org-left"><code>parent_label</code></td>
<td class="org-left">A function that grabs the name of the folder to use as an image label.</td>
</tr>
<tr>
<td class="org-left">item_tfms</td>
<td class="org-left"><code>Resize</code></td>
<td class="org-left">Resize all the images to a uniform size (192 x 192) by squishing them.</td>
</tr>
</tbody>
</table>
<p>And now we train the categorizer.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="k">as</span> <span class="n">catcher</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">vision_learner</span><span class="p">(</span><span class="n">loaders</span><span class="p">,</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">)</span>

<span class="k">with</span> <span class="n">learner</span><span class="o">.</span><span class="n">no_bar</span><span class="p">()</span> <span class="k">as</span> <span class="n">nobar</span><span class="p">,</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">timmy</span><span class="p">:</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
<pre class="example">
Started: 2022-12-08 18:28:55.158226
[0, 0.29742079973220825, 0.0608036108314991, 0.020555555820465088, '00:12']
[0, 0.05481018126010895, 0.0367087759077549, 0.009444444440305233, '00:16']
[1, 0.029521549120545387, 0.0178204495459795, 0.004999999888241291, '00:17']
[2, 0.012186083942651749, 0.013458597473800182, 0.006666666828095913, '00:17']
Ended: 2022-12-08 18:29:59.272703
Elapsed: 0:01:04.114477
</pre>
<p>I put the supression of the warnings in because somebody (I assume FastAI) is calling pytorch with deprecated arguments.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org7515ae9">
<h2 id="org7515ae9">Some Examples</h2>
<div class="outline-text-2" id="text-org7515ae9"></div>
<div class="outline-3" id="outline-container-orgef89894">
<h3 id="orgef89894">A Helper</h3>
<div class="outline-text-3" id="text-orgef89894">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">predict_category</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">learner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>

    <span class="k">with</span> <span class="n">learner</span><span class="o">.</span><span class="n">no_bar</span><span class="p">():</span>
        <span class="n">prediction</span><span class="p">,</span> <span class="n">probability_index</span><span class="p">,</span> <span class="n">probabilities</span> <span class="o">=</span> <span class="n">learner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"This is a </span><span class="si">{</span><span class="n">prediction</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Probability it's a </span><span class="si">{</span><span class="n">prediction</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">probability_index</span><span class="p">)])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">probability_index</span><span class="p">,</span> <span class="n">probabilities</span>

<span class="n">predict</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">predict_category</span><span class="p">,</span> <span class="n">learner</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org594c7bc">
<h3 id="org594c7bc">A Tanuki</h3>
<div class="outline-text-3" id="text-org594c7bc">
<p>Let's look at the output of the <code>learner.predict</code> method when we pass the model the picture of a raccoon dog that we looked at when we were looking at the duckduckgo search example.</p>
<div class="highlight">
<pre><span></span><span class="n">TANUKI_PATH</span> <span class="o">=</span> <span class="s2">"/tmp/tanuki_image.jpg"</span>
<span class="n">urlsave</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">TANUKI_URLS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">TANUKI_PATH</span><span class="p">)</span>
<span class="n">prediction</span><span class="p">,</span> <span class="n">probability_index</span><span class="p">,</span> <span class="n">probabilities</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">TANUKI_PATH</span><span class="p">)</span>
</pre></div>
<pre class="example">
This is a raccoon.
Probability it's a raccoon: 0.99
</pre>
<div class="figure" id="orgbb98f06">
<p><img alt="tanuki_image.jpg" src="tanuki_image.jpg"></p>
</div>
</div>
<div class="outline-4" id="outline-container-org8935d61">
<h4 id="org8935d61">Prediction</h4>
<div class="outline-text-4" id="text-org8935d61">
<p>The <code>prediction</code> returned by <code>learner.predict</code> is a string version of whatever your labeling function (<code>parent_label</code> in this case) returns.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</pre></div>
<pre class="example">
raccoon
</pre>
<p>In this case it thinks it's a raccoon, not a raccoon dog, so our model probably isn't ready for prime-time, but let's look at rest of the output anyway.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org068fb51">
<h4 id="org068fb51">Probabilities</h4>
<div class="outline-text-4" id="text-org068fb51">
<p>The <code>probabilities</code> is a <code>TensorBase</code> which, for our purposes, acts like a list of the probabilities that our image belongs to one of the classifications.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>
</pre></div>
<pre class="example">
TensorBase([0.9894, 0.0106])
</pre>
<p>There are two probabilities because we have two classifications (raccoon and tanuki). When I first encountered fastai one of the things I couldn't figure out is which probability matches which classification. To figure that out you need our next value, the <code>probability_index</code>.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgdd23ae5">
<h4 id="orgdd23ae5">Probability Index</h4>
<div class="outline-text-4" id="text-orgdd23ae5">
<p>The <code>probability_index</code> tells you which one of the probabilities matches the predicted classification.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">probability_index</span><span class="p">)</span>
</pre></div>
<pre class="example">
TensorBase(0)
</pre>
<p>Our model predicted that the image was a raccon and since the probability index is 0, the "raccoon" category matches the first entry in the <code>probabilities</code> collection, and looking back at the <code>probabilities</code> this means that the model is 99% sure that this is a raccoon.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb83b887">
<h3 id="orgb83b887">Now, a Raccoon</h3>
<div class="outline-text-3" id="text-orgb83b887">
<div class="highlight">
<pre><span></span><span class="n">RACCOON_PATH</span> <span class="o">=</span> <span class="s2">"/tmp/raccoon_image.jpg"</span>
<span class="n">urlsave</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">RACCOON_URLS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="n">RACCOON_PATH</span><span class="p">)</span>
<span class="n">prediction</span><span class="p">,</span> <span class="n">probability_index</span><span class="p">,</span> <span class="n">probabilities</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">RACCOON_PATH</span><span class="p">)</span>
</pre></div>
<pre class="example">
This is a raccoon.
Probability it's a raccoon: 1.00
</pre>
<div class="figure" id="org16748f7">
<p><img alt="raccoon_image.jpg" src="raccoon_image.jpg"></p>
</div>
<p>It's really sure this is a raccoon.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org7999e22">
<h2 id="org7999e22">And Then, the End</h2>
<div class="outline-text-2" id="text-org7999e22">
<p>The final loss for the model during training was pretty low (less than 1%) but it wasn't able to identify our one tanuki test image. On the one hand, less than 1% loss isn't 0 loss, so I might just have chosen one example that is particularly hard. It might also be important that tanuki and raccoons do look quite a bit alike, so this is a harder problem than, say, cats versus dogs. Also, our method for gathering images isn't checking that the images are unique (although the URLs are, they might be redundant postings), and tanuki might be obscure enough that there aren't a huge variety of images out there, making it harder for the model to train to identify them.</p>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/fastai/" rel="tag">fastai</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../fastai-quickstart-tabular-data/" rel="prev" title="FastAI QuickStart Tabular Data">Previous post</a></li>
<li class="next"><a href="../fastai-saving-a-model/" rel="next" title="FastAI: Saving a Model">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer"><a href="https://creativecommons.org/licenses/by/4.0/" rel="license"><img alt="Creative Commons License" id="license-image" src="https://licensebuttons.net/l/by/4.0/80x15.png" style="border-width:0"></a>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>. <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
