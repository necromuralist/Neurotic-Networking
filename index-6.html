<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Studies in Deep Learning." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Neurotic Networking (old posts, page 6) | Neurotic Networking</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Neurotic-Networking/index-6.html" rel="canonical">
<link href="index-7.html" rel="prev" type="text/html">
<link href="index-5.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<link href="apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="site.webmanifest" rel="manifest">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="."><span id="blog-title">Neurotic Networking</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="pages/">Pages</a></li>
<li class="nav-item"><a class="nav-link" href="archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Monkey Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">The Cloistered Monkey</a> <a class="dropdown-item" href="https://necromuralist.github.io/Ape-Iron/">Ape Iron</a> <a class="dropdown-item" href="https://necromuralist.github.io/Bowling-For-Data/">Bowling For Data</a> <a class="dropdown-item" href="https://necromuralist.github.io/Beach-Pig-Thigh/">Beach-Pig Rump & Thigh</a> <a class="dropdown-item" href="https://necromuralist.github.io/Visions-Voices-Data/">Visions, Voices, Data</a></div>
</li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/Neurotic-Networking/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/autoencoders/convolutional-autoencoder/index.html">Convolutional Autoencoder</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-19T12:15:02-08:00" itemprop="datePublished" title="2018-12-19 12:15">2018-12-19 12:15</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#orge009018">Introduction</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#org6647fe5">Compressed Representation</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#orgb434d86">Set Up</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#orgc4692eb">The Data</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#org1211ce3">Visualize the Data</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#org0cf8149">Convolutional Autoencoder</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#org20d7abe">Transpose Convolutions, Decoder</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#org5d85637">Initialize The NN</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#org5a62d8b">Training</a></li>
<li><a href="posts/nano/autoencoders/convolutional-autoencoder/index.html#orgf93395a">Checking out the results</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orge009018">
<h2 id="orge009018">Introduction</h2>
<div class="outline-text-2" id="text-orge009018">
<p>Sticking with the <a href="https://en.wikipedia.org/wiki/MNIST_database">MNIST</a> dataset, let's improve our autoencoder's performance using convolutional layers. We'll build a convolutional autoencoder to compress the MNIST dataset.</p>
<ul class="org-ul">
<li>The encoder portion will be made of convolutional and pooling layers and the decoder will be made of <b>transpose convolutional layers</b> that learn to "upsample" a compressed representation.</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org6647fe5">
<h2 id="org6647fe5">Compressed Representation</h2>
<div class="outline-text-2" id="text-org6647fe5">
<p>A compressed representation can be great for saving and sharing any kind of data in a way that is more efficient than storing raw data. In practice, the compressed representation often holds key information about an input image and we can use it for denoising images or other kinds of reconstruction and transformation!</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgb434d86">
<h2 id="orgb434d86">Set Up</h2>
<div class="outline-text-2" id="text-orgb434d86"></div>
<div class="outline-3" id="outline-container-orgc046801">
<h3 id="orgc046801">Imports</h3>
<div class="outline-text-3" id="text-orgc046801"></div>
<div class="outline-4" id="outline-container-org3662552">
<h4 id="org3662552">Python Standard Library</h4>
<div class="outline-text-4" id="text-org3662552">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb92b990">
<h4 id="orgb92b990">From PyPi</h4>
<div class="outline-text-4" id="text-orgb92b990">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Graph</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org82ad27d">
<h3 id="org82ad27d">Plotting</h3>
<div class="outline-text-3" id="text-org82ad27d">
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1a7966b">
<h3 id="org1a7966b">Test for <a href="http://pytorch.org/docs/stable/cuda.html">CUDA</a></h3>
<div class="outline-text-3" id="text-org1a7966b">
<p>The test-code uses the check later on so I'll save it to the <code>train_on_gpu</code> variable.</p>
<div class="highlight">
<pre><span></span><span class="n">train_on_gpu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda:0"</span> <span class="k">if</span> <span class="n">train_on_gpu</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Using: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
</pre></div>
<pre class="example">
Using: cuda:0
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc4692eb">
<h2 id="orgc4692eb">The Data</h2>
<div class="outline-text-2" id="text-orgc4692eb"></div>
<div class="outline-3" id="outline-container-orgcd9045b">
<h3 id="orgcd9045b">Setup the Data Transform</h3>
<div class="outline-text-3" id="text-orgcd9045b">
<div class="highlight">
<pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org61ac05c">
<h3 id="org61ac05c">Load the Training and Test Datasets</h3>
<div class="outline-text-3" id="text-org61ac05c">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/datasets/MNIST/"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">())</span>
</pre></div>
<pre class="example">
/home/hades/datasets/MNIST
True
</pre>
<div class="highlight">
<pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org2c8e636">
<h3 id="org2c8e636">Create training and test dataloaders</h3>
<div class="outline-text-3" id="text-org2c8e636">
<div class="highlight">
<pre><span></span><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># how many samples per batch to load</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1ffbb03">
<h3 id="org1ffbb03">Prepare Data Loaders</h3>
<div class="outline-text-3" id="text-org1ffbb03">
<div class="highlight">
<pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> 
                                           <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                                           <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                                          <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1211ce3">
<h2 id="org1211ce3">Visualize the Data</h2>
<div class="outline-text-2" id="text-org1211ce3"></div>
<div class="outline-3" id="outline-container-orgd5bae29">
<h3 id="orgd5bae29">Obtain One Batch of Training Images</h3>
<div class="outline-text-3" id="text-orgd5bae29">
<div class="highlight">
<pre><span></span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org269f4f7">
<h3 id="org269f4f7">Get One Image From the Batch</h3>
<div class="outline-text-3" id="text-org269f4f7">
<div class="highlight">
<pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb7b33fe">
<h3 id="orgb7b33fe">Plot</h3>
<div class="outline-text-3" id="text-orgb7b33fe">
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"First Image"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
</pre></div>
<div class="figure" id="orgc25c957">
<p><img alt="first_image.png" src="posts/nano/autoencoders/convolutional-autoencoder/first_image.png"></p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0cf8149">
<h2 id="org0cf8149">Convolutional Autoencoder</h2>
<div class="outline-text-2" id="text-org0cf8149"></div>
<div class="outline-3" id="outline-container-org683334c">
<h3 id="org683334c">Encoder</h3>
<div class="outline-text-3" id="text-org683334c">
<p>The encoder part of the network will be a typical convolutional pyramid. Each convolutional layer will be followed by a max-pooling layer to reduce the dimensions of the layers.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org950f161">
<h3 id="org950f161">Decoder</h3>
<div class="outline-text-3" id="text-org950f161">
<p>The decoder, though, might be something new to you. The decoder needs to convert from a narrow representation to a wide, reconstructed image. For example, the representation could be a 7x7x4 max-pool layer. This is the output of the encoder, but also the input to the decoder. We want to get a 28x28x1 image out from the decoder so we need to work our way back up from the compressed representation. A schematic of the network is shown below.</p>
<div class="highlight">
<pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">)</span>

<span class="c1"># Input layer</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"28x28x1 Input"</span><span class="p">)</span>

<span class="c1"># the Encoder</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"28x28x16 Convolution"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"c"</span><span class="p">,</span> <span class="s2">"14x14x16 MaxPool"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="s2">"14x14x4 Convolution"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"e"</span><span class="p">,</span> <span class="s2">"7x7x4 MaxPool"</span><span class="p">)</span>

<span class="c1"># The Decoder</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"f"</span><span class="p">,</span> <span class="s2">"14x14x16 Transpose Convolution"</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"g"</span><span class="p">,</span> <span class="s2">"28x28x1 Transpose Convolution"</span><span class="p">)</span>

<span class="c1"># The Output</span>
<span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">"h"</span><span class="p">,</span> <span class="s2">"28x28x1 Output"</span><span class="p">)</span>

<span class="n">edges</span> <span class="o">=</span> <span class="s2">"abcdefgh"</span>
<span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">([</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

<span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"graphs/network_graph.dot"</span><span class="p">)</span>
<span class="n">graph</span>
</pre></div>
<p># Out[12]: <img alt="network_graph.dot.png" src="posts/files/posts/nano/autoencoders/convolutional-autoencoder/network_graph.dot.png"></p>
<p>:END:</p>
<div class="figure" id="org213a07f">
<p><img alt="network_graph.dot.png" src="posts/nano/autoencoders/convolutional-autoencoder/network_graph.dot.png"></p>
</div>
<p>Here our final encoder layer has size 7x7x4 = 196. The original images have size 28x28 = 784, so the encoded vector is 25% the size of the original image. These are just suggested sizes for each of the layers. Feel free to change the depths and sizes, in fact, you're encouraged to add additional layers to make this representation even smaller! Remember our goal here is to find a small representation of the input data.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org20d7abe">
<h2 id="org20d7abe">Transpose Convolutions, Decoder</h2>
<div class="outline-text-2" id="text-org20d7abe">
<p>This decoder uses <b>transposed convolutional</b> layers to increase the width and height of the input layers. They work almost exactly the same as convolutional layers, but in reverse. A stride in the input layer results in a larger stride in the transposed convolution layer. For example, if you have a 3x3 kernel, a 3x3 patch in the input layer will be reduced to one unit in a convolutional layer. Comparatively, one unit in the input layer will be expanded to a 3x3 path in a transposed convolution layer. PyTorch provides us with an easy way to create the layers, <a href="https://pytorch.org/docs/stable/nn.html#convtranspose2d"><code>nn.ConvTranspose2d</code></a>.</p>
<p>It is important to note that transpose convolution layers can lead to artifacts in the final images, such as checkerboard patterns. This is due to overlap in the kernels which can be avoided by setting the stride and kernel size equal. In <a href="http://distill.pub/2016/deconv-checkerboard/">this Distill article</a> from Augustus Odena, <b>et al</b>, the authors show that these checkerboard artifacts can be avoided by resizing the layers using nearest neighbor or bilinear interpolation (upsampling) followed by a convolutional layer.</p>
<p>We'll show this approach in another notebook, so you can experiment with it and see the difference.</p>
<ul class="org-ul">
<li>Build the encoder out of a series of convolutional and pooling layers.</li>
<li>When building the decoder, recall that transpose convolutional layers can upsample an input by a factor of 2 using a stride and kernel_size of 2.</li>
</ul>
<p>See:</p>
<ul class="org-ul">
<li><a href="https://pytorch.org/docs/stable/nn.html?highlight=conv2d#torch.nn.Conv2d">Conv2d</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html?highlight=maxpool#torch.nn.MaxPool2d">MaxPool2d</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html#relu">ReLU</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html#sigmoid">Sigmoid</a></li>
</ul>
<p>To get the output size of our Convolutional Layers you use the formula:</p>
<p>\[ o = \frac{W - F + 2P}{S} + 1 \]</p>
<p>Where <i>W</i> is the input size (28 here), <i>F</i> is the filter size, <i>P</i> is the zero-padding, and <i>S</i> is the stride. For our first layer we want to keep the output the same size as the input.</p>
<p>The output for a maxpool layer uses a similar set of equations.</p>
\begin{align} W_2 &amp;= \frac{W_1 - F}{S} + 1\\ H_2 &amp;= \frac{H_Y - F}{S} + 1\\ D_2 = D_1\\ \end{align}
<p>Where <i>W</i> is the width, <i>H</i> is the height, and <i>D</i> is the depth.</p>
<div class="highlight">
<pre><span></span><span class="n">Layer</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Layer"</span><span class="p">,</span> <span class="s2">"kernel stride depth padding"</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">Layer</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="k">def</span> <span class="nf">output_size</span><span class="p">(</span><span class="n">input_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculates the output size of the layer</span>

<span class="sd">    Args:</span>
<span class="sd">     input_size: the size of the input to the layer</span>
<span class="sd">     layer: named tuple with values for the layer</span>
<span class="sd">     expected: the value you are expecting</span>

<span class="sd">    Returns:</span>
<span class="sd">     the size of the output</span>

<span class="sd">    Raises:</span>
<span class="sd">     AssertionError: the calculated value wasn't the expected one</span>
<span class="sd">    """</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">input_size</span> <span class="o">-</span> <span class="n">layer</span><span class="o">.</span><span class="n">kernel</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">layer</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span><span class="o">/</span><span class="n">layer</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Layer Output Size: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">size</span> <span class="o">==</span> <span class="n">expected</span>
    <span class="k">return</span> <span class="n">size</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgce648b7">
<h3 id="orgce648b7">The Encoder Layers</h3>
<div class="outline-text-3" id="text-orgce648b7"></div>
<div class="outline-4" id="outline-container-org39c1021">
<h4 id="org39c1021">Layer One</h4>
<div class="outline-text-4" id="text-org39c1021">
<p>The first layer is a Convolutional Layer that we want to have the same size output as the input but with a depth of sixteen. The <a href="https://cs231n.github.io/convolutional-networks/">CS 231</a> page notes that to keep the size of the output the same as the input you should set the stride to one and once you have decided on your kernle size (<i>F</i>) then you can find your padding using this equation:</p>
<p>\[ P = \frac{F - 1}{2} \]</p>
<p>In this case I'm going to use a filter size of three so our padding will be:</p>
\begin{align} P &amp;= \frac{3 - 1}{2}\\ &amp;= 1\\ \end{align}
<p>We can double-check this by plugging the values back intoo the equation for output size.</p>
\begin{align} W' &amp;= \frac{W - F + 2P}{S} + 1\\ &amp;= \frac{28 - 3 + 2(1)}{1} + 1\\ &amp;= 28\\ \end{align}
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Variable</th>
<th class="org-left" scope="col">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><i>W</i></td>
<td class="org-left">One dimension of the input</td>
</tr>
<tr>
<td class="org-left"><i>F</i></td>
<td class="org-left">One dimension of the Kernel (filter)</td>
</tr>
<tr>
<td class="org-left"><i>S</i></td>
<td class="org-left">Stride</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span> <span class="n">layer_one</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                   <span class="n">padding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>

 <span class="n">INPUT_ONE</span> <span class="o">=</span> <span class="mi">28</span>
 <span class="n">OUTPUT_ONE</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">INPUT_ONE</span><span class="p">,</span> <span class="n">layer_one</span><span class="p">,</span> <span class="n">INPUT_ONE</span><span class="p">)</span>
 <span class="n">INPUT_DEPTH</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
<pre class="example">
Layer(kernel=3, stride=1, depth=16, padding=1)
Layer Output Size: 28.0
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgac6b27f">
<h4 id="orgac6b27f">Layer Two</h4>
<div class="outline-text-4" id="text-orgac6b27f">
<p>The second layer is a MaxPool layer that will keep the depth of six but will halve the size to fourteen. According to the <a href="https://cs231n.github.io/convolutional-networks/">CS 231 n</a> page on Convolutional Networks, there are only two values for the kernel size that are usually used - 2 and 3, and the stride is usually just 2, with a kernel size of 2 being more common, and as it turns out, a kernel size of 2 and a stride of 2 will reduce our input dimensions by a half, which is what we want.</p>
\begin{align} W &amp;= \frac{28 - 2}{2} + 1\\ &amp;= 14\\ \end{align}
<div class="highlight">
<pre><span></span> <span class="n">layer_two</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
 <span class="n">OUTPUT_TWO</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">OUTPUT_ONE</span><span class="p">,</span> <span class="n">layer_two</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
</pre></div>
<pre class="example">
Layer(kernel=2, stride=2, depth=16, padding=0)
Layer Output Size: 14.0
</pre></div>
</div>
<div class="outline-4" id="outline-container-org30d48fc">
<h4 id="org30d48fc">Layer Three</h4>
<div class="outline-text-4" id="text-org30d48fc">
<p>Our third layer is another convolutional layer that preserves the input width and height but this time the output will have a depth of 4.</p>
<div class="highlight">
<pre><span></span><span class="n">layer_three</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">OUTPUT_THREE</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">OUTPUT_TWO</span><span class="p">,</span> <span class="n">layer_three</span><span class="p">,</span> <span class="n">OUTPUT_TWO</span><span class="p">)</span>
</pre></div>
<pre class="example">
Layer(kernel=3, stride=1, depth=4, padding=1)
Layer Output Size: 14.0
</pre></div>
</div>
<div class="outline-4" id="outline-container-org1809acb">
<h4 id="org1809acb">Layer Four</h4>
<div class="outline-text-4" id="text-org1809acb">
<p>The last layer in the encoder is a max pool layer that reduces the previous layer by half (to dimensions of 7) while preserving the depth.</p>
<div class="highlight">
<pre><span></span><span class="n">layer_four</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
<span class="n">OUTPUT_FOUR</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">(</span><span class="n">OUTPUT_THREE</span><span class="p">,</span> <span class="n">layer_four</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</pre></div>
<pre class="example">
Layer(kernel=2, stride=2, depth=4, padding=0)
Layer Output Size: 7.0
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6329930">
<h3 id="org6329930">Decoders</h3>
<div class="outline-text-3" id="text-org6329930"></div>
<div class="outline-4" id="outline-container-org1b5cf80">
<h4 id="org1b5cf80">Layer Five</h4>
<div class="outline-text-4" id="text-org1b5cf80">
<p>We want an output of 14 x 14 x 16 from an input of 7 x 7 x 4. The comments given with this exercise say that using a kernel of 2 and stride of 2 will double the dimensions, much as those same values halve the dimensions with Max-Pooling.</p>
<div class="highlight">
<pre><span></span><span class="n">layer_five</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdafbbbe">
<h4 id="orgdafbbbe">Layer Six</h4>
<div class="outline-text-4" id="text-orgdafbbbe">
<p>This layer will expand the image back to its original size of 28 x 28 x 1</p>
<div class="highlight">
<pre><span></span><span class="n">layer_six</span> <span class="o">=</span> <span class="n">Layer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgdf37b46">
<h3 id="orgdf37b46">Define the NN Architecture</h3>
<div class="outline-text-3" id="text-orgdf37b46">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">ConvAutoencoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A CNN AutoEncoder-Decoder"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1">## encoder layers ##</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convolution_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">INPUT_DEPTH</span><span class="p">,</span>
                                       <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> 
                                       <span class="n">stride</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
                                       <span class="n">padding</span><span class="o">=</span><span class="n">layer_one</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_two</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
                                       <span class="n">stride</span><span class="o">=</span><span class="n">layer_two</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">convolution_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">layer_two</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                                       <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
                                       <span class="n">stride</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
                                       <span class="n">padding</span><span class="o">=</span><span class="n">layer_three</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>

        <span class="c1">## decoder layers ##</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">layer_four</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> 
            <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="n">layer_five</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> 
            <span class="n">out_channels</span><span class="o">=</span><span class="n">layer_six</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">layer_six</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">layer_six</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="c1">## encode ##</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convolution_1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="c1">## decode ##</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transpose_convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">ConvAutoencoder</span><span class="p">()</span>
<span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">convolution_1</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">max_pool_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">max_pool_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">transpose_convolution_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">transpose_convolution_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
</pre></div>
<pre class="example">
torch.Size([20, 16, 28, 28])
torch.Size([20, 16, 14, 14])
torch.Size([20, 16, 14, 14])
torch.Size([20, 4, 14, 14])
torch.Size([20, 4, 7, 7])
torch.Size([20, 4, 7, 7])
torch.Size([20, 16, 14, 14])
torch.Size([20, 16, 14, 14])
torch.Size([20, 1, 28, 28])
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org5d85637">
<h2 id="org5d85637">Initialize The NN</h2>
<div class="outline-text-2" id="text-org5d85637">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ConvAutoencoder</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
<pre class="example">
ConvAutoencoder(
  (convolution_1): Conv2d(1, 16, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (max_pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  (convolution_2): Conv2d(16, 4, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (transpose_convolution_1): ConvTranspose2d(4, 16, kernel_size=(2, 2), stride=(2, 2))
  (transpose_convolution_2): ConvTranspose2d(16, 1, kernel_size=(2, 2), stride=(2, 2))
  (relu): ReLU()
  (sigmoid): Sigmoid()
)
</pre></div>
</div>
<div class="outline-2" id="outline-container-org5a62d8b">
<h2 id="org5a62d8b">Training</h2>
<div class="outline-text-2" id="text-org5a62d8b">
<p>Here I'll write a bit of code to train the network. I'm not too interested in validation here, so I'll just monitor the training loss and the test loss afterwards.</p>
<p>We are not concerned with labels in this case, just images, which we can get from the <code>train_loader</code>. Because we're comparing pixel values in input and output images, it will be best to use a loss that is meant for a regression task. Regression is all about comparing quantities rather than probabilistic values. So, in this case, I'll use <a href="https://pytorch.org/docs/stable/nn.html?highlight=mseloss#torch.nn.MSELoss">MSELoss</a>. And compare output images and input images as follows:</p>
<div class="highlight">
<pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
</pre></div>
<p>Otherwise, this is pretty straightfoward training with PyTorch. Since this is a convolutional autoencoder, our images <i>do not</i> need to be flattened before being passed in an input to our model.</p>
</div>
<div class="outline-3" id="outline-container-orgff26ec4">
<h3 id="orgff26ec4">Train the Model</h3>
<div class="outline-text-3" id="text-orgff26ec4">
<div class="highlight">
<pre><span></span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">started</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># monitor training loss</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1">###################</span>
    <span class="c1"># train the model #</span>
    <span class="c1">###################</span>

    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
        <span class="c1"># _ stands in for labels, here</span>
        <span class="c1"># no need to flatten images</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># clear the gradients of all optimized variables</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="c1"># forward pass: compute predicted outputs by passing inputs to the model</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="c1"># calculate the loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
        <span class="c1"># backward pass: compute gradient of the loss with respect to model parameters</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="c1"># perform a single optimization step (parameter update)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># update running training loss</span>
        <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># print avg training statistics </span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\t</span><span class="s1">Training Loss: </span><span class="si">{:.6f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">epoch</span><span class="p">,</span> 
        <span class="n">train_loss</span>
        <span class="p">))</span>
<span class="n">ended</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Ended: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ended</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Elapsed: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ended</span> <span class="o">-</span> <span class="n">started</span><span class="p">))</span>
</pre></div>
<pre class="example" id="org2df4055">
Epoch: 1        Training Loss: 0.259976
Epoch: 2        Training Loss: 0.244956
Epoch: 3        Training Loss: 0.235354
Epoch: 4        Training Loss: 0.226544
Epoch: 5        Training Loss: 0.216255
Epoch: 6        Training Loss: 0.207204
Epoch: 7        Training Loss: 0.200490
Epoch: 8        Training Loss: 0.195582
Epoch: 9        Training Loss: 0.191870
Epoch: 10       Training Loss: 0.189247
Epoch: 11       Training Loss: 0.187027
Epoch: 12       Training Loss: 0.185084
Epoch: 13       Training Loss: 0.183055
Epoch: 14       Training Loss: 0.181224
Epoch: 15       Training Loss: 0.179749
Epoch: 16       Training Loss: 0.178564
Epoch: 17       Training Loss: 0.177572
Epoch: 18       Training Loss: 0.176735
Epoch: 19       Training Loss: 0.176076
Epoch: 20       Training Loss: 0.175518
Epoch: 21       Training Loss: 0.175040
Epoch: 22       Training Loss: 0.174629
Epoch: 23       Training Loss: 0.174230
Epoch: 24       Training Loss: 0.173856
Epoch: 25       Training Loss: 0.173497
Epoch: 26       Training Loss: 0.173166
Epoch: 27       Training Loss: 0.172838
Epoch: 28       Training Loss: 0.172520
Epoch: 29       Training Loss: 0.172212
Epoch: 30       Training Loss: 0.171920
Ended: 2018-12-21 17:41:26.461977
Elapsed: 0:07:50.942721
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf93395a">
<h2 id="orgf93395a">Checking out the results</h2>
<div class="outline-text-2" id="text-orgf93395a">
<p>Below I've plotted some of the test images along with their reconstructions. These look a little rough around the edges, likely due to the checkerboard effect we mentioned above that tends to happen with transpose layers.</p>
</div>
<div class="outline-3" id="outline-container-orgfce7779">
<h3 id="orgfce7779">Obtain One Batch Of Test Images</h3>
<div class="outline-text-3" id="text-orgfce7779">
<div class="highlight">
<pre><span></span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6f6a54e">
<h3 id="org6f6a54e">Get Sample Outputs</h3>
<div class="outline-text-3" id="text-org6f6a54e">
<div class="highlight">
<pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1ea9717">
<h3 id="org1ea9717">Prep Images for Display</h3>
<div class="outline-text-3" id="text-org1ea9717">
<div class="highlight">
<pre><span></span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8cd898e">
<h3 id="org8cd898e">Output Is Resized Into a Batch Of Images</h3>
<div class="outline-text-3" id="text-org8cd898e">
<div class="highlight">
<pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd8792d3">
<h3 id="orgd8792d3">Use Detach When It's An Output That Requires Grad</h3>
<div class="outline-text-3" id="text-orgd8792d3">
<div class="highlight">
<pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org18235c4">
<h3 id="org18235c4">plot the first ten input images and then reconstructed images</h3>
<div class="outline-text-3" id="text-org18235c4">
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Auto-Encoded/Decoded Images"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="c1"># input images on top row, reconstructions on bottom</span>
<span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">images</span><span class="p">,</span> <span class="n">output</span><span class="p">],</span> <span class="n">axes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<div class="figure" id="orgf67b3dd">
<p><img alt="reconstructed.png" src="posts/nano/autoencoders/convolutional-autoencoder/reconstructed.png"></p>
</div>
<p>That is better than I would have thought it would be.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/autoencoders/simple-autoencoder/index.html">Simple Autoencoder</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/autoencoders/simple-autoencoder/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-17T23:30:13-08:00" itemprop="datePublished" title="2018-12-17 23:30">2018-12-17 23:30</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/autoencoders/simple-autoencoder/index.html#orgf9d3e69">Introduction</a></li>
<li><a href="posts/nano/autoencoders/simple-autoencoder/index.html#orgdc3d9d8">Compressed Representation</a></li>
<li><a href="posts/nano/autoencoders/simple-autoencoder/index.html#org17310e9">Set Up</a></li>
<li><a href="posts/nano/autoencoders/simple-autoencoder/index.html#org571971e">Visualize the Data</a></li>
<li><a href="posts/nano/autoencoders/simple-autoencoder/index.html#org3dc6394">Linear Autoencoder</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgf9d3e69">
<h2 id="orgf9d3e69">Introduction</h2>
<div class="outline-text-2" id="text-orgf9d3e69">
<p>We'll start off by building a simple autoencoder to compress the MNIST dataset. With autoencoders, we pass input data through an encoder that makes a compressed representation of the input. Then, this representation is passed through a decoder to reconstruct the input data. Generally the encoder and decoder will be built with neural networks, then trained on example data.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgdc3d9d8">
<h2 id="orgdc3d9d8">Compressed Representation</h2>
<div class="outline-text-2" id="text-orgdc3d9d8">
<p>A compressed representation can be great for saving and sharing any kind of data in a way that is more efficient than storing raw data. In practice, the compressed representation often holds key information about an input image and we can use it for denoising images or other kinds of reconstruction and transformation!</p>
</div>
</div>
<div class="outline-2" id="outline-container-org17310e9">
<h2 id="org17310e9">Set Up</h2>
<div class="outline-text-2" id="text-org17310e9">
<p>In this notebook, we'll be build a simple network architecture for the encoder and decoder. Let's get started by importing our libraries and getting the dataset.</p>
</div>
<div class="outline-3" id="outline-container-orgd0d6e4b">
<h3 id="orgd0d6e4b">Imports</h3>
<div class="outline-text-3" id="text-orgd0d6e4b"></div>
<div class="outline-4" id="outline-container-orgd33f07c">
<h4 id="orgd33f07c">PyPi</h4>
<div class="outline-text-4" id="text-orgd33f07c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org57d222f">
<h4 id="org57d222f">This Project</h4>
<div class="outline-text-4" id="text-org57d222f">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">neurotic.tangles.data_paths</span> <span class="kn">import</span> <span class="n">DataPathTwo</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org7beaedb">
<h3 id="org7beaedb">Plotting</h3>
<div class="outline-text-3" id="text-org7beaedb">
<div class="highlight">
<pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org82f1e70">
<h3 id="org82f1e70">The Data</h3>
<div class="outline-text-3" id="text-org82f1e70"></div>
<div class="outline-4" id="outline-container-org4365553">
<h4 id="org4365553">Data Transformer</h4>
<div class="outline-text-4" id="text-org4365553">
<div class="highlight">
<pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org123638a">
<h4 id="org123638a">Load the Data</h4>
<div class="outline-text-4" id="text-org123638a">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">DataPathTwo</span><span class="p">(</span><span class="n">folder_key</span><span class="o">=</span><span class="s2">"MNIST"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
</pre></div>
<pre class="example">
/home/hades/datasets/MNIST
</pre>
<div class="highlight">
<pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd0cbade">
<h4 id="orgd0cbade">Training and Test Batch Loaders</h4>
<div class="outline-text-4" id="text-orgd0cbade"></div>
<ul class="org-ul">
<li><a id="org7dabca1"></a>Some Constants<br>
<div class="outline-text-5" id="text-org7dabca1">
<div class="highlight">
<pre><span></span><span class="c1"># number of subprocesses to use for data loading</span>
<span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># how many samples per batch to load</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
<p>Prepare the loaders.</p>
<div class="highlight">
<pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span>
                                           <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                                           <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                                          <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org571971e">
<h2 id="org571971e">Visualize the Data</h2>
<div class="outline-text-2" id="text-org571971e"></div>
<div class="outline-3" id="outline-container-org640677e">
<h3 id="org640677e">Obtain One Batch of Training Images</h3>
<div class="outline-text-3" id="text-org640677e">
<div class="highlight">
<pre><span></span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org7d9d54b">
<h3 id="org7d9d54b">Get One Image From the Batch</h3>
<div class="outline-text-3" id="text-org7d9d54b">
<div class="highlight">
<pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"First Image"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
</pre></div>
<div class="figure" id="org55ce5ff">
<p><img alt="first_image.png" src="posts/nano/autoencoders/simple-autoencoder/first_image.png"></p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3dc6394">
<h2 id="org3dc6394">Linear Autoencoder</h2>
<div class="outline-text-2" id="text-org3dc6394"></div>
<div class="outline-3" id="outline-container-org10208dd">
<h3 id="org10208dd">Description</h3>
<div class="outline-text-3" id="text-org10208dd">
<p>We'll train an autoencoder with these images by flattening them into 784 length vectors. The images from this dataset are already normalized such that the values are between 0 and 1. Let's start by building a simple autoencoder. The encoder and decoder should be made of <b>one linear layer</b>. The units that connect the encoder and decoder will be the <i>compressed representation</i>.</p>
<p>Since the images are normalized between 0 and 1, we need to use a <b>sigmoid activation on the output layer</b> to get values that match this input value range.</p>
<ul class="org-ul">
<li>The input images will be flattened into 784 length vectors. The targets are the same as the inputs.</li>
<li>The encoder and decoder will be made of two linear layers, each.</li>
<li>The depth dimensions should change as follows: 784 inputs &gt; <b>encoding_dim</b> &gt; 784 outputs.</li>
<li>All layers will have ReLu activations applied except for the final output layer, which has a sigmoid activation.</li>
</ul>
<p><b>The compressed representation should be a vector with dimension <code>encoding_dim=32</code>.</b></p>
</div>
</div>
<div class="outline-3" id="outline-container-org5a90f0d">
<h3 id="org5a90f0d">Architecture Definition</h3>
<div class="outline-text-3" id="text-org5a90f0d">
<div class="highlight">
<pre><span></span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
<span class="n">IMAGE_DIMENSION</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">columns</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">Autoencoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">""""" simple autoencoder-decoder</span>

<span class="sd">    Args:</span>
<span class="sd">     encoding_dim: the dimension of the encoded image</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoding_dim</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">IMAGE_DIMENSION</span><span class="p">,</span> <span class="n">encoding_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation_one</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">encoding_dim</span><span class="p">,</span> <span class="n">IMAGE_DIMENSION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation_output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Does one feed-forward pass</span>

<span class="sd">       Args:</span>
<span class="sd">        x: flattened MNIST image</span>

<span class="sd">       Returns:</span>
<span class="sd">        the encoded-decoded version of the image</span>
<span class="sd">       """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5c11a66">
<h3 id="org5c11a66">Initialize the Auto-Encoder</h3>
<div class="outline-text-3" id="text-org5c11a66">
<div class="highlight">
<pre><span></span><span class="n">encoding_dim</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Autoencoder</span><span class="p">(</span><span class="n">encoding_dim</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
Autoencoder(
  (encoder): Linear(in_features=784, out_features=32, bias=True)
  (activation_one): ReLU()
  (decoder): Linear(in_features=32, out_features=784, bias=True)
  (activation_output): Sigmoid()
)
</pre></div>
</div>
<div class="outline-3" id="outline-container-org46624cd">
<h3 id="org46624cd">Training</h3>
<div class="outline-text-3" id="text-org46624cd">
<p>Here I'll write a bit of code to train the network. I'm not too interested in validation here, so I'll just monitor the training loss and the test loss afterwards.</p>
<p>We are not concerned with labels in this case, just images, which we can get from the <code>train_loader</code>. Because we're comparing pixel values in input and output images, it will be best to use a loss that is meant for a regression task. Regression is all about comparing <i>quantities</i> rather than probabilistic values. So, in this case, I'll use <a href="https://pytorch.org/docs/stable/nn.html?highlight=mseloss#torch.nn.MSELoss"><code>MSELoss</code></a>, which calculates the Mean-Squared Error between the predicted and the actual value, and compare output images and input images as follows:</p>
<div class="highlight">
<pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
</pre></div>
<p>Otherwise, this is pretty straightfoward training with PyTorch. We flatten our images, pass them into the autoencoder, and record the training loss as we go.</p>
</div>
<div class="outline-4" id="outline-container-org27eca2c">
<h4 id="org27eca2c">Specify the Loss Function</h4>
<div class="outline-text-4" id="text-org27eca2c">
<div class="highlight">
<pre><span></span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd344236">
<h4 id="orgd344236">Specifiy the Optimizer</h4>
<div class="outline-text-4" id="text-orgd344236">
<p>We're going to use the <a href="https://pytorch.org/docs/stable/optim.html?highlight=adam#torch.optim.Adam">Adam</a> optimizer instead of Stochastic Gradient Descent.</p>
<div class="highlight">
<pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge21e0cd">
<h4 id="orge21e0cd">And Now We Train</h4>
<div class="outline-text-4" id="text-orge21e0cd">
<div class="highlight">
<pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">20</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># monitor training loss</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1">###################</span>
    <span class="c1"># train the model #</span>
    <span class="c1">###################</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
        <span class="c1"># _ stands in for labels, here</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data</span>
        <span class="c1"># flatten images</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># clear the gradients of all optimized variables</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="c1"># forward pass: compute predicted outputs by passing inputs to the model</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="c1"># calculate the loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
        <span class="c1"># backward pass: compute gradient of the loss with respect to model parameters</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="c1"># perform a single optimization step (parameter update)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># update running training loss</span>
        <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># print avg training statistics </span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\t</span><span class="s1">Training Loss: </span><span class="si">{:.6f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">epoch</span><span class="p">,</span> 
        <span class="n">train_loss</span>
        <span class="p">))</span>
</pre></div>
<pre class="example" id="org125255d">
Epoch: 1        Training Loss: 0.622334
Epoch: 2        Training Loss: 0.297601
Epoch: 3        Training Loss: 0.258895
Epoch: 4        Training Loss: 0.250710
Epoch: 5        Training Loss: 0.247124
Epoch: 6        Training Loss: 0.244808
Epoch: 7        Training Loss: 0.243222
Epoch: 8        Training Loss: 0.242119
Epoch: 9        Training Loss: 0.241254
Epoch: 10       Training Loss: 0.240563
Epoch: 11       Training Loss: 0.239997
Epoch: 12       Training Loss: 0.239529
Epoch: 13       Training Loss: 0.239120
Epoch: 14       Training Loss: 0.238747
Epoch: 15       Training Loss: 0.238395
Epoch: 16       Training Loss: 0.238030
Epoch: 17       Training Loss: 0.237546
Epoch: 18       Training Loss: 0.237213
Epoch: 19       Training Loss: 0.236916
Epoch: 20       Training Loss: 0.236473
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org367e001">
<h3 id="org367e001">Checking out the results</h3>
<div class="outline-text-3" id="text-org367e001">
<p>Below I've plotted some of the test images along with their reconstructions. For the most part these look pretty good except for some blurriness in some parts.</p>
</div>
<div class="outline-4" id="outline-container-org41a069f">
<h4 id="org41a069f">Obtain One Batch Of Test Images</h4>
<div class="outline-text-4" id="text-org41a069f">
<div class="highlight">
<pre><span></span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

<span class="n">images_flatten</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># get sample outputs</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images_flatten</span><span class="p">)</span>
<span class="c1"># prep images for display</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>


<span class="c1"># output is resized into a batch of images</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="c1"># use detach when it's an output that requires_grad</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="c1"># input images on top row, reconstructions on bottom</span>
<span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">images</span><span class="p">,</span> <span class="n">output</span><span class="p">],</span> <span class="n">axes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<div class="figure" id="org1880dea">
<p><img alt="recomposed.png" src="posts/nano/autoencoders/simple-autoencoder/recomposed.png"></p>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/weight-initialization/index.html">Weight Initialization</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/weight-initialization/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-17T13:03:41-08:00" itemprop="datePublished" title="2018-12-17 13:03">2018-12-17 13:03</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org90ec7be">Introduction</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#orgb58f414">Initial Weights and Observing Training Loss</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org24248a8">Dataset and Model</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org6c33b93">Import Libraries and Load the Data</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org47e3199">Visualize Some Training Data</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org4551d2d">Define the Model Architecture</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org761468f">Initialize Weights</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org90db6b5">Compare Model Behavior</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#orgf896e05">General rule for setting weights</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#orga494a12">Normal Distribution</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org3654062">Automatic Initialization</a></li>
<li><a href="posts/nano/cnn/weight-initialization/index.html#org78058e0">evaluate the behavior using helpers</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org90ec7be">
<h2 id="org90ec7be">Introduction</h2>
<div class="outline-text-2" id="text-org90ec7be">
<p>In this lesson, you'll learn how to find good initial weights for a neural network. Weight initialization happens once, when a model is created and before it trains. Having good initial weights can place the neural network close to the optimal solution. This allows the neural network to come to the best solution quicker.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgb58f414">
<h2 id="orgb58f414">Initial Weights and Observing Training Loss</h2>
<div class="outline-text-2" id="text-orgb58f414">
<p>To see how different weights perform, we'll test on the same dataset and neural network. That way, we know that any changes in model behavior are due to the weights and not any changing data or model structure. We'll instantiate at least two of the same models, with <i>different</i> initial weights and see how the training loss decreases over time.</p>
<p>Sometimes the differences in training loss, over time, will be large and other times, certain weights offer only small improvements.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org24248a8">
<h2 id="org24248a8">Dataset and Model</h2>
<div class="outline-text-2" id="text-org24248a8">
<p>We'll train an MLP to classify images from the <a href="https://github.com/zalandoresearch/fashion-mnist">Fashion-MNIST database</a> to demonstrate the effect of different initial weights. As a reminder, the FashionMNIST dataset contains images of clothing types; <code>classes = ['T-shirt/top', 'Trouser', 'Pullover', 'Dress', 'Coat', 'Sandal', 'Shirt', 'Sneaker', 'Bag', 'Ankle boot']</code>. The images are normalized so that their pixel values are in a range [0.0 - 1.0). Run the cell below to download and load the dataset.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org6c33b93">
<h2 id="org6c33b93">Import Libraries and Load the <a href="http://pytorch.org/docs/stable/torchvision/datasets.html">Data</a></h2>
<div class="outline-text-2" id="text-org6c33b93"></div>
<div class="outline-3" id="outline-container-orgbaa73bb">
<h3 id="orgbaa73bb">Imports</h3>
<div class="outline-text-3" id="text-orgbaa73bb">
<div class="highlight">
<pre><span></span># python
from functools import partial
from typing import Collection, Tuple
# from pypi
from dotenv import load_dotenv
from sklearn.model_selection import train_test_split
from torch.utils.data.sampler import SubsetRandomSampler
from torchvision import datasets
import matplotlib.pyplot as pyplot
import numpy
import seaborn
import torch
import torch.nn as nn
import torch.nn.functional as F
import torchvision.transforms as transforms

# udacity
import nano.helpers as helpers

# this project
from neurotic.tangles.data_paths import DataPathTwo
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9c825bb">
<h3 id="org9c825bb">Load the Data</h3>
<div class="outline-text-3" id="text-org9c825bb">
<div class="highlight">
<pre><span></span># number of subprocesses to use for data loading
subprocesses = 0
# how many samples per batch to load
batch_size = 100
# percentage of training set to use as validation
VALIDATION_FRACTION = 0.2
</pre></div>
<p>Convert the data to a torch.FloatTensor.</p>
<div class="highlight">
<pre><span></span>transform = transforms.ToTensor()
</pre></div>
<div class="highlight">
<pre><span></span>load_dotenv()
path = DataPathTwo(folder_key="FASHION")
print(path.folder)
</pre></div>
<pre class="example">
/home/brunhilde/datasets/FASHION
</pre>
<p>Choose the training and test datasets.</p>
<div class="highlight">
<pre><span></span>train_data = datasets.FashionMNIST(root=path.folder, train=True,
                                   download=True, transform=transform)
test_data = datasets.FashionMNIST(root=path.folder, train=False,
                                  download=True, transform=transform)
</pre></div>
<pre class="example" id="orgdec41c0">
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-images-idx3-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-labels-idx1-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-images-idx3-ubyte.gz
Downloading http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-labels-idx1-ubyte.gz
Processing...
Done!
</pre>
<p>Obtain training indices that will be used for validation.</p>
<div class="highlight">
<pre><span></span>indices = list(range(len(train_data)))
train_idx, valid_idx = train_test_split(
    indices,
    test_size=VALIDATION_FRACTION)
</pre></div>
<p>Define samplers for obtaining training and validation batches.</p>
<div class="highlight">
<pre><span></span>train_sampler = SubsetRandomSampler(train_idx)
valid_sampler = SubsetRandomSampler(valid_idx)
</pre></div>
<p>Prepare data loaders (combine dataset and sampler).</p>
<div class="highlight">
<pre><span></span>train_loader = torch.utils.data.DataLoader(train_data, batch_size=batch_size,
                                           sampler=train_sampler, num_workers=subprocesses)
valid_loader = torch.utils.data.DataLoader(train_data, batch_size=batch_size, 
                                           sampler=valid_sampler, num_workers=subprocesses)
test_loader = torch.utils.data.DataLoader(test_data, batch_size=batch_size, 
                                          num_workers=subprocesses)
</pre></div>
<div class="highlight">
<pre><span></span>classes = ['T-shirt/top', 'Trouser', 'Pullover', 'Dress', 'Coat', 
    'Sandal', 'Shirt', 'Sneaker', 'Bag', 'Ankle boot']
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org47e3199">
<h2 id="org47e3199">Visualize Some Training Data</h2>
<div class="outline-text-2" id="text-org47e3199">
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
get_ipython().run_line_magic('config', "InlineBackend.figure_format = 'retina'")
seaborn.set(style="whitegrid",
            rc={"axes.grid": False,
                "font.family": ["sans-serif"],
                "font.sans-serif": ["Open Sans", "Latin Modern Sans", "Lato"],
                "figure.figsize": (10, 8)},
            font_scale=1)
</pre></div>
<p>Obtain one batch of training images.</p>
<div class="highlight">
<pre><span></span>dataiter = iter(train_loader)
images, labels = dataiter.next()
images = images.numpy()
</pre></div>
<p>Plot the images in the batch, along with the corresponding labels.</p>
<div class="highlight">
<pre><span></span>fig = pyplot.figure(figsize=(12, 10))
fig.suptitle("Sample FASHION Images", weight="bold")
for idx in np.arange(20):
    ax = fig.add_subplot(2, 20/2, idx+1, xticks=[], yticks=[])
    ax.imshow(np.squeeze(images[idx]), cmap='gray')
    ax.set_title(classes[labels[idx]])
</pre></div>
<div class="figure" id="org754165c">
<p><img alt="image_one.png" src="posts/nano/cnn/weight-initialization/image_one.png"></p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4551d2d">
<h2 id="org4551d2d">Define the Model Architecture</h2>
<div class="outline-text-2" id="text-org4551d2d">
<p>We've defined the MLP that we'll use for classifying the dataset.</p>
</div>
<div class="outline-3" id="outline-container-orgf324555">
<h3 id="orgf324555">Neural Network</h3>
<div class="outline-text-3" id="text-orgf324555">
<ul class="org-ul">
<li>A 3 layer MLP with hidden dimensions of 256 and 128.</li>
<li>This MLP accepts a flattened image (784-value long vector) as input and produces 10 class scores as output.</li>
</ul>
<p>We'll test the effect of different initial weights on this 3 layer neural network with ReLU activations and an Adam optimizer. The lessons you learn apply to other neural networks, including different activations and optimizers.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org761468f">
<h2 id="org761468f">Initialize Weights</h2>
<div class="outline-text-2" id="text-org761468f">
<p>Let's start looking at some initial weights.</p>
</div>
<div class="outline-3" id="outline-container-org8034e13">
<h3 id="org8034e13">All Zeros or Ones</h3>
<div class="outline-text-3" id="text-org8034e13">
<p>If you follow the principle of <a href="https://en.wikipedia.org/wiki/Occam's_razor">Occam's razor</a>, you might think setting all the weights to 0 or 1 would be the best solution. This is not the case.</p>
<p>With every weight the same, all the neurons at each layer are producing the same output. This makes it hard to decide which weights to adjust.</p>
<p>Let's compare the loss with all ones and all zero weights by defining two models with those constant weights.</p>
<p>Below, we are using PyTorch's <a href="https://pytorch.org/docs/stable/nn.html#torch-nn-init">nn.init</a> to initialize each Linear layer with a constant weight. The init library provides a number of weight initialization functions that give you the ability to initialize the weights of each layer according to layer type.</p>
<p>In the case below, we look at every layer/module in our model. If it is a Linear layer (as all three layers are for this MLP), then we initialize those layer weights to be a <code>constant_weight</code> with <code>bias=0</code> using the following code:</p>
<div class="highlight">
<pre><span></span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">constant_weight</span><span class="p">)</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
<p>The <code>constant_weight</code> is a value that you can pass in when you instantiate the model.</p>
</div>
<div class="outline-4" id="outline-container-orgd53a68e">
<h4 id="orgd53a68e">Define the NN architecture</h4>
<div class="outline-text-4" id="text-orgd53a68e">
<div class="highlight">
<pre><span></span>class Net(nn.Module):
    def __init__(self, hidden_1=256, hidden_2=128, constant_weight=None):
        super(Net, self).__init__()
        # linear layer (784 -&gt; hidden_1)
        self.fc1 = nn.Linear(28 * 28, hidden_1)
        # linear layer (hidden_1 -&gt; hidden_2)
        self.fc2 = nn.Linear(hidden_1, hidden_2)
        # linear layer (hidden_2 -&gt; 10)
        self.fc3 = nn.Linear(hidden_2, 10)
        # dropout layer (p=0.2)
        self.dropout = nn.Dropout(0.2)

        # initialize the weights to a specified, constant value
        if(constant_weight is not None):
            for m in self.modules():
                if isinstance(m, nn.Linear):
                    nn.init.constant_(m.weight, constant_weight)
                    nn.init.constant_(m.bias, 0)


    def forward(self, x):
        # flatten image input
        x = x.view(-1, 28 * 28)
        # add hidden layer, with relu activation function
        x = F.relu(self.fc1(x))
        # add dropout layer
        x = self.dropout(x)
        # add hidden layer, with relu activation function
        x = F.relu(self.fc2(x))
        # add dropout layer
        x = self.dropout(x)
        # add output layer
        x = self.fc3(x)
        return x
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org90db6b5">
<h2 id="org90db6b5">Compare Model Behavior</h2>
<div class="outline-text-2" id="text-org90db6b5">
<p>Below, we are using <code>helpers.compare_init_weights</code> to compare the training and validation loss for the two models we defined above, <code>model_0</code> and <code>model_1</code>. This function takes in a list of models (each with different initial weights), the name of the plot to produce, and the training and validation dataset loaders. For each given model, it will plot the training loss for the first 100 batches and print out the validation accuracy after 2 training epochs. <b>Note: if you've used a small batch_size, you may want to increase the number of epochs here to better compare how models behave after seeing a few hundred images.</b></p>
<p>We plot the loss over the first 100 batches to better judge which model weights performed better at the start of training. <b>I recommend that you take a look at the code in <code>helpers.py</code> to look at the details behind how the models are trained, validated, and compared.</b></p>
<p>Run the cell below to see the difference between weights of all zeros against all ones.</p>
<p>Initialize two NN's with 0 and 1 constant weights.</p>
<div class="highlight">
<pre><span></span>model_0 = Net(constant_weight=0)
model_1 = Net(constant_weight=1)
</pre></div>
<p>Put them in list form to compare.</p>
<div class="highlight">
<pre><span></span>model_list = [(model_0, 'All Zeros'),
              (model_1, 'All Ones')]
</pre></div>
<div class="highlight">
<pre><span></span>ModelLabel = Tuple[nn.Module, str]
ModelLabels = Collection[ModelLabel]
</pre></div>
<div class="highlight">
<pre><span></span>def plot_models(title:str, models_labels:ModelLabels):
    """Plots the models

    Args:
     title: the title for the plots
     models_labels: collections of model, plot-label tuples
    """
    figure, axe = pyplot.subplots()
    figure.suptitle(title, weight="bold")    
    axe.set_xlabel("Batches")
    axe.set_ylabel("Loss")

    for model, label in models_labels:
        loss, validation_accuracy = helpers._get_loss_acc(model, train_loader, valid_loader)
        axe.plot(loss[:100], label=label)
    legend = axe.legend()
    return
</pre></div>
<p>Plot the loss over the first 100 batches.</p>
<div class="highlight">
<pre><span></span>plot_models("All Zeros vs All Ones",
            ((model_0, "All Zeros"),
             (model_1, "All ones")))
</pre></div>
<div class="figure" id="org01f6c4e">
<p><img alt="zeros_ones.png" src="posts/nano/cnn/weight-initialization/zeros_ones.png"></p>
</div>
<pre class="example" id="orgbcf6534">
After 2 Epochs:
Validation Accuracy
    9.475% -- All Zeros
   10.175% -- All Ones
Training Loss
    2.304  -- All Zeros
  1914.703  -- All Ones
</pre>
<p>As you can see the accuracy is close to guessing for both zeros and ones, around 10%.</p>
<p>The neural network is having a hard time determining which weights need to be changed, since the neurons have the same output for each layer. To avoid neurons with the same output, let's use unique weights. We can also randomly select these weights to avoid being stuck in a local minimum for each run.</p>
<p>A good solution for getting these random weights is to sample from a uniform distribution.</p>
</div>
<div class="outline-3" id="outline-container-orgd3dccc6">
<h3 id="orgd3dccc6">Uniform Distribution</h3>
<div class="outline-text-3" id="text-orgd3dccc6">
<p>A <a href="https://en.wikipedia.org/wiki/Uniform_distribution">uniform distribution</a> has the equal probability of picking any number from a set of numbers. We'll be picking from a continuous distribution, so the chance of picking the same number is low. We'll use NumPy's <code>np.random.uniform</code> function to pick random numbers from a uniform distribution.</p>
<p><a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.random.uniform.html"><code>np.random_uniform(low=0.0, high=1.0, size=None)</code></a></p>
<p>Outputs random values from a uniform distribution.</p>
<p>The generated values follow a uniform distribution in the range [low, high). The lower bound minval is included in the range, while the upper bound maxval is excluded.</p>
<ul class="org-ul">
<li><b>low:</b> The lower bound on the range of random values to generate. Defaults to 0.</li>
<li><b>high:</b> The upper bound on the range of random values to generate. Defaults to 1.</li>
<li><b>size:</b> An int or tuple of ints that specify the shape of the output array.</li>
</ul>
<p>We can visualize the uniform distribution by using a histogram. Let's map the values from <code>np.random_uniform(-3, 3, [1000])</code> to a histogram using the <code>helper.hist_dist</code> function. This will be <code>1000</code> random float values from <code>-3</code> to <code>3</code>, excluding the value <code>3</code>.</p>
<div class="highlight">
<pre><span></span>figure, axe = pyplot.subplots()
figure.suptitle("Random Uniform", weight="bold")
data = numpy.random.uniform(-3, 3, [1000])
grid = seaborn.distplot(data)
#helpers.hist_dist('Random Uniform (low=-3, high=3)', )
</pre></div>
<div class="figure" id="org3eef00c">
<p><img alt="uniform_distribution.png" src="posts/nano/cnn/weight-initialization/uniform_distribution.png"></p>
</div>
<p>Now that you understand the uniform function, let's use PyTorch's <code>nn.init</code> to apply it to a model's initial weights.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgb671c60">
<h3 id="orgb671c60">Uniform Initialization, Baseline</h3>
<div class="outline-text-3" id="text-orgb671c60">
<p>Let's see how well the neural network trains using a uniform weight initialization, where <code>low=0.0</code> and <code>high=1.0</code>. Below, I'll show you another way (besides in the Net class code) to initialize the weights of a network. To define weights outside of the model definition, you can:</p>
<ol class="org-ol">
<li>Define a function that assigns weights by the type of network layer, <b>then</b></li>
<li>Apply those weights to an initialized model using <code>model.apply(fn)</code>, which applies a function to each model layer.</li>
</ol>
<p>This time, we'll use <code>weight.data.uniform_</code> to initialize the weights of our model, directly.</p>
<div class="highlight">
<pre><span></span>def weights_init_uniform(m: nn.Module, start=0.0, stop=1.0) -&gt; None:
    """takes in a module and applies the specified weight initialization

    Args:
     m: A model instance
    """
    classname = m.__class__.__name__
    # for every Linear layer in a model..
    if classname.startswith('Linear'):
        # apply a uniform distribution to the weights and a bias=0
        m.weight.data.uniform_(start, stop)
        m.bias.data.fill_(0)
    return
</pre></div>
</div>
<div class="outline-4" id="outline-container-org21508ba">
<h4 id="org21508ba">Create A New Model With These Weights</h4>
</div>
<div class="outline-4" id="outline-container-org3f6315d">
<h4 id="org3f6315d">Evaluate Behavior</h4>
<div class="outline-text-4" id="text-org3f6315d">
<div class="highlight">
<pre><span></span>model_uniform = Net()
model_uniform.apply(weights_init_uniform)
plot_models("Uniform Baseline", ((model_uniform, "UNIFORM WEIGHTS"),))
</pre></div>
<div class="figure" id="orgb731202">
<p><img alt="uniform_weights.png" src="posts/nano/cnn/weight-initialization/uniform_weights.png"></p>
</div>
<p>The loss graph is showing the neural network is learning, which it didn't with all zeros or all ones. We're headed in the right direction!</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf896e05">
<h2 id="orgf896e05">General rule for setting weights</h2>
<div class="outline-text-2" id="text-orgf896e05">
<p>The general rule for setting the weights in a neural network is to set them to be close to zero without being too small. A good practice is to start your weights in the range of \([-y, y]\) where \(y=1/\sqrt{n}\) (\(n\) is the number of inputs to a given neuron).</p>
<p>Let's see if this holds true; let's create a baseline to compare with and center our uniform range over zero by shifting it over by 0.5. This will give us the range [-0.5, 0.5).</p>
<div class="highlight">
<pre><span></span>weights_init_uniform_center = partial(weights_init_uniform, -0.5, 0.5)
</pre></div>
</div>
<div class="outline-3" id="outline-container-org4e392af">
<h3 id="org4e392af">create a new model with these weights</h3>
<div class="outline-text-3" id="text-org4e392af">
<div class="highlight">
<pre><span></span>model_centered = Net()
model_centered.apply(weights_init_uniform_center)
</pre></div>
<p>Now let's create a distribution and model that uses the <b>general rule</b> for weight initialization; using the range \([-y, y]\), where \(y=1/\sqrt{n}\) .</p>
<p>And finally, we'll compare the two models.</p>
<div class="highlight">
<pre><span></span>def weights_init_uniform_rule(m: nn.Module) -&gt; None:
    """takes in a module and applies the specified weight initialization

    Args:
     m: Model instance
    """
    classname = m.__class__.__name__
    # for every Linear layer in a model..
    if classname.find('Linear') != -1:
        # get the number of the inputs
        n = m.in_features
        y = 1.0/numpy.sqrt(n)
        m.weight.data.uniform_(-y, y)
        m.bias.data.fill_(0)
    return
</pre></div>
<div class="highlight">
<pre><span></span>model_rule = Net()
model_rule.apply(weights_init_uniform_rule)
</pre></div>
<div class="highlight">
<pre><span></span>plot_models("Uniform Centered vs General Rule", (
    (model_centered, 'Centered Weights [-0.5, 0.5)'), 
    (model_rule, 'General Rule [-y, y)'),
))
</pre></div>
<p><img alt="general_rule.png" src="posts/nano/cnn/weight-initialization/general_rule.png"> This behavior is really promising! Not only is the loss decreasing, but it seems to do so very quickly for our uniform weights that follow the general rule; after only two epochs we get a fairly high validation accuracy and this should give you some intuition for why starting out with the right initial weights can really help your training process!</p>
<p>Since the uniform distribution has the same chance to pick <b>any value</b> in a range, what if we used a distribution that had a higher chance of picking numbers closer to 0? Let's look at the normal distribution.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orga494a12">
<h2 id="orga494a12">Normal Distribution</h2>
<div class="outline-text-2" id="text-orga494a12">
<p>Unlike the uniform distribution, the <a href="https://en.wikipedia.org/wiki/Normal_distribution">normal distribution</a> has a higher likelihood of picking number close to it's mean. To visualize it, let's plot values from NumPy's <code>np.random.normal</code> function to a histogram.</p>
<p><a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.random.normal.html">np.random.normal(loc=0.0, scale=1.0, size=None)</a></p>
<p>Outputs random values from a normal distribution.</p>
<ul class="org-ul">
<li><b>loc:</b> The mean of the normal distribution.</li>
<li><b>scale:</b> The standard deviation of the normal distribution.</li>
<li><b>shape:</b> The shape of the output array.</li>
</ul>
<div class="highlight">
<pre><span></span>figure, axe = pyplot.subplots()
figure.suptitle("Standard Normal Distribution", weight="bold")
grid = seaborn.distplot(numpy.random.normal(size=[1000]))
</pre></div>
<div class="figure" id="org1c48c16">
<p><img alt="normal_distribution.png" src="posts/nano/cnn/weight-initialization/normal_distribution.png"></p>
</div>
<p>Let's compare the normal distribution against the previous, rule-based, uniform distribution.</p>
<p>The normal distribution should have a mean of 0 and a standard deviation of \(y=1/\sqrt{n}\)</p>
<div class="highlight">
<pre><span></span>def weights_init_normal(m: nn.Module) -&gt; None:
    '''Takes in a module and initializes all linear layers with weight
       values taken from a normal distribution.'''

    classname = m.__class__.__name__
    if classname.startswith("Linear"):    
        m.weight.data.normal_(mean=0, std=1/numpy.sqrt(m.in_features))
        m.bias.data.fill_(0)
    return
</pre></div>
<p>create a new model with the rule-based, uniform weights</p>
<div class="highlight">
<pre><span></span>model_uniform_rule = Net()
model_uniform_rule.apply(weights_init_uniform_rule)
</pre></div>
<p>create a new model with the rule-based, NORMAL weights</p>
<div class="highlight">
<pre><span></span>model_normal_rule = Net()
model_normal_rule.apply(weights_init_normal)
</pre></div>
<p>compare the two models</p>
<div class="highlight">
<pre><span></span>plot_models('Uniform vs Normal',
            ((model_uniform_rule, 'Uniform Rule [-y, y)'), 
             (model_normal_rule, 'Normal Distribution')))
</pre></div>
<div class="figure" id="org1ea78b0">
<p><img alt="normal_vs_uniform.png" src="posts/nano/cnn/weight-initialization/normal_vs_uniform.png"></p>
</div>
<p>The normal distribution gives us pretty similar behavior compared to the uniform distribution, in this case. This is likely because our network is so small; a larger neural network will pick more weight values from each of these distributions, magnifying the effect of both initialization styles. In general, a normal distribution will result in better performance for a model.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org3654062">
<h2 id="org3654062">Automatic Initialization</h2>
<div class="outline-text-2" id="text-org3654062">
<p>Let's quickly take a look at what happens <b>without any explicit weight initialization</b>.</p>
</div>
<div class="outline-3" id="outline-container-orgc035352">
<h3 id="orgc035352">Instantiate a model with <span class="underline">no</span> explicit weight initialization</h3>
</div>
</div>
<div class="outline-2" id="outline-container-org78058e0">
<h2 id="org78058e0">evaluate the behavior using helpers</h2>
<div class="outline-text-2" id="text-org78058e0">
<div class="highlight">
<pre><span></span>model_normal_rule = Net()
model_normal_rule.apply(weights_init_normal)
model_default = Net()
model_rule = Net()
model_rule.apply(weights_init_uniform_rule)

plot_models("Default vs Normal vs General Rule", (
    (model_default, "Default"),
    (model_normal_rule, "Normal"),
    (model_rule, "General Rule")))
</pre></div>
<div class="figure" id="orgf009786">
<p><img alt="default.png" src="posts/nano/cnn/weight-initialization/default.png"></p>
</div>
<p>They all sort of look the same at this point.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/transfer-learning-exercise/index.html">Transfer Learning Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/transfer-learning-exercise/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-15T14:50:47-08:00" itemprop="datePublished" title="2018-12-15 14:50">2018-12-15 14:50</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#org0b078f1">Introduction</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#orgb10f74b">Imports</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#orge54fd46">Flower power</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#orgecc6aed">Download the Data</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#org3901a33">Transforming the Data</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#org0945e78">DataLoaders and Data Visualization</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#orgf3aa5dd">Visualize some sample data</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#orgbf808ee">Plot The Images In The Batch, Along With The Corresponding Labels</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#org4e98603">Define the Model</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#org14b0573">Final Classifier Layer</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#orgbef46a6">Specify Loss Function and Optimizer</a></li>
<li><a href="posts/nano/cnn/transfer-learning-exercise/index.html#org6ac7add">Training</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org0b078f1">
<h2 id="org0b078f1">Introduction</h2>
<div class="outline-text-2" id="text-org0b078f1">
<p>Most of the time you won't want to train a whole convolutional network yourself. Modern ConvNets training on huge datasets like ImageNet take weeks on multiple GPUs. Instead, most people use a pretrained network either as a fixed feature extractor, or as an initial network to fine tune.</p>
<p>In this notebook, you'll be using <a href="https://arxiv.org/pdf/1409.1556.pdf">VGGNet</a> trained on the <a href="http://www.image-net.org/">ImageNet dataset</a> as a feature extractor.</p>
<p>VGGNet is great because it's simple and has great performance, coming in second in the ImageNet competition. The idea here is that we keep all the convolutional layers, but <b>replace the final fully-connected layer</b> with our own classifier. This way we can use VGGNet as a <b>fixed feature extractor</b> for our images then easily train a simple classifier on top of that.</p>
<ul class="org-ul">
<li>Use all but the last fully-connected layer as a fixed feature extractor.</li>
<li>Define a new, final classification layer and apply it to a task of our choice!</li>
</ul>
<p>You can read more about transfer learning from <a href="http://cs231n.github.io/transfer-learning/">the CS231n Stanford course notes</a>.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgb10f74b">
<h2 id="orgb10f74b">Imports</h2>
<div class="outline-text-2" id="text-orgb10f74b">
<div class="highlight">
<pre><span></span># python
from collections import OrderedDict
from datetime import datetime
import os

# pypi
from dotenv import load_dotenv
from torch import nn
from sklearn.model_selection import train_test_split
from torch.utils.data.sampler import SubsetRandomSampler

import matplotlib
import numpy
import seaborn
import torch
import torch.optim as optimize
import torchvision
from torchvision import datasets, models, transforms
import matplotlib.pyplot as pyplot

# this project
from neurotic.tangles.data_paths import DataPathTwo
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgd2a825d">
<h3 id="orgd2a825d">Plotting</h3>
<div class="outline-text-3" id="text-orgd2a825d">
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
get_ipython().run_line_magic('config', "InlineBackend.figure_format = 'retina'")
seaborn.set(style="whitegrid",
            rc={"axes.grid": False,
                "font.size": 8,
                "font.family": ["sans-serif"],
                "font.sans-serif": ["Latin Modern Sans", "Lato"],
                "figure.figsize": (8, 6)},
            font_scale=3)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orge54fd46">
<h2 id="orge54fd46">Flower power</h2>
<div class="outline-text-2" id="text-orge54fd46">
<p>Here we'll be using VGGNet to classify images of flowers. We'll start, as usual, by importing our usual resources. And checking if we can train our model on the GPU.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgecc6aed">
<h2 id="orgecc6aed">Download the Data</h2>
<div class="outline-text-2" id="text-orgecc6aed">
<p>Download the flower data from <a href="https://s3.amazonaws.com/video.udacity-data.com/topher/2018/September/5baa60a0_flower-photos/flower-photos.zip">this link</a>, save it in the home directory of this notebook and extract the zip file to get the directory <code>flower_photos/</code>. <b>Make sure the directory has this exact name for accessing data: flower_photos</b>.</p>
<div class="highlight">
<pre><span></span>load_dotenv()
path = DataPathTwo(folder_key="FLOWERS")
print(path.folder)
for target in path.folder.iterdir():
    print(target)
</pre></div>
<pre class="example">
/home/hades/datasets/flower_photos
/home/hades/datasets/flower_photos/.DS_Store
/home/hades/datasets/flower_photos/train
/home/hades/datasets/flower_photos/test
/home/hades/datasets/flower_photos/LICENSE.txt
</pre></div>
<div class="outline-3" id="outline-container-orgc6c82cc">
<h3 id="orgc6c82cc">Check If CUDA Is Available</h3>
<div class="outline-text-3" id="text-orgc6c82cc">
<div class="highlight">
<pre><span></span>device = "cuda:0" if torch.cuda.is_available() else "cpu"
print(device)
</pre></div>
<pre class="example">
cuda:0
</pre>
<p>CUDA is running out of memory and crashing so don't use CUDA.</p>
<div class="highlight">
<pre><span></span>device = "cpu"
print(device)
</pre></div>
<pre class="example">
cpu
</pre></div>
</div>
<div class="outline-3" id="outline-container-org219ec3a">
<h3 id="org219ec3a">Load and Transform our Data</h3>
<div class="outline-text-3" id="text-org219ec3a">
<p>We'll be using PyTorch's <a href="https://pytorch.org/docs/stable/torchvision/datasets.html#imagefolder">ImageFolder</a> class which makes is very easy to load data from a directory. For example, the training images are all stored in a directory path that looks like this:</p>
<pre class="example" id="org6c7d9f3">
root/class_1/xxx.png
root/class_1/xxy.png
root/class_1/xxz.png

root/class_2/123.png
root/class_2/nsdf3.png
root/class_2/asd932_.png
</pre>
<p>Where, in this case, the root folder for training is <code>flower_photos/train/</code> and the classes are the names of flower types.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgd4c6dd3">
<h3 id="orgd4c6dd3">Define Training and Test Data Directories</h3>
<div class="outline-text-3" id="text-orgd4c6dd3">
<div class="highlight">
<pre><span></span>train_dir = path.folder.joinpath('train/')
test_dir = path.folder.joinpath('test/')
print(train_dir)
print(test_dir)
</pre></div>
<pre class="example">
/home/hades/datasets/flower_photos/train
/home/hades/datasets/flower_photos/test
</pre>
<p><i>Classes</i> are folders in each directory with these names:</p>
<div class="highlight">
<pre><span></span>classes = ['daisy', 'dandelion', 'roses', 'sunflowers', 'tulips']
CLASS_COUNT = len(classes)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3901a33">
<h2 id="org3901a33">Transforming the Data</h2>
<div class="outline-text-2" id="text-org3901a33">
<p>When we perform transfer learning, we have to shape our input data into the shape that the pre-trained model expects. VGG16 expects `224`-dim square images as input and so, we resize each flower image to fit this mold.</p>
</div>
<div class="outline-3" id="outline-container-org5a61625">
<h3 id="org5a61625">Load And Transform Data Using ImageFolder</h3>
<div class="outline-text-3" id="text-org5a61625">
<p>VGG-16 Takes 224x224 images as input, so we resize all of them.</p>
<div class="highlight">
<pre><span></span>data_transform = transforms.Compose([transforms.RandomResizedCrop(224), 
                                      transforms.ToTensor()])

train_data = datasets.ImageFolder(train_dir, transform=data_transform)
test_data = datasets.ImageFolder(test_dir, transform=data_transform)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9f0de8d">
<h3 id="org9f0de8d">Print Out Some Data Stats</h3>
<div class="outline-text-3" id="text-org9f0de8d">
<div class="highlight">
<pre><span></span>print('Num training images: ', len(train_data))
print('Num test images: ', len(test_data))
</pre></div>
<pre class="example">
Num training images:  3130
Num test images:  540
</pre>
<div class="highlight">
<pre><span></span>VALIDATION_FRACTION = 0.2
</pre></div>
<div class="highlight">
<pre><span></span>indices = list(range(len(train_data)))
training_indices, validation_indices = train_test_split(
    indices,
    test_size=VALIDATION_FRACTION)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0945e78">
<h2 id="org0945e78">DataLoaders and Data Visualization</h2>
<div class="outline-text-2" id="text-org0945e78"></div>
<div class="outline-3" id="outline-container-org7a2ebbc">
<h3 id="org7a2ebbc">Define Dataloader Parameters</h3>
<div class="outline-text-3" id="text-org7a2ebbc">
<div class="highlight">
<pre><span></span>BATCH_SIZE = 20
NUM_WORKERS=4
</pre></div>
<div class="highlight">
<pre><span></span>train_sampler = SubsetRandomSampler(training_indices)
valid_sampler = SubsetRandomSampler(validation_indices)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc39dad3">
<h3 id="orgc39dad3">Prepare Data Loaders</h3>
<div class="outline-text-3" id="text-orgc39dad3">
<div class="highlight">
<pre><span></span>train_loader = torch.utils.data.DataLoader(train_data, batch_size=BATCH_SIZE, 
                                           sampler=train_sampler,
                                           num_workers=NUM_WORKERS)
valid_loader = torch.utils.data.DataLoader(train_data, batch_size=BATCH_SIZE, 
                                           sampler=valid_sampler, num_workers=NUM_WORKERS)
test_loader = torch.utils.data.DataLoader(test_data, batch_size=batch_size, 
                                          num_workers=num_workers, shuffle=True)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf3aa5dd">
<h2 id="orgf3aa5dd">Visualize some sample data</h2>
<div class="outline-text-2" id="text-orgf3aa5dd"></div>
<div class="outline-3" id="outline-container-orgbf6a23d">
<h3 id="orgbf6a23d">obtain one batch of training images</h3>
<div class="outline-text-3" id="text-orgbf6a23d">
<div class="highlight">
<pre><span></span>dataiter = iter(train_loader)
images, labels = dataiter.next()
images = images.numpy() # convert images to numpy for display
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgbf808ee">
<h2 id="orgbf808ee">Plot The Images In The Batch, Along With The Corresponding Labels</h2>
<div class="outline-text-2" id="text-orgbf808ee">
<div class="highlight">
<pre><span></span>fig = pyplot.figure(figsize=(12, 10))
pyplot.rc("axes", titlesize=10)
for idx in numpy.arange(20):
    ax = fig.add_subplot(2, 20/2, idx+1, xticks=[], yticks=[])
    pyplot.imshow(numpy.transpose(images[idx], (1, 2, 0)))
    ax.set_title(classes[labels[idx]])
</pre></div>
<div class="figure" id="orgb33a92c">
<p><img alt="sample_batches.png" src="posts/nano/cnn/transfer-learning-exercise/sample_batches.png"></p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4e98603">
<h2 id="org4e98603">Define the Model</h2>
<div class="outline-text-2" id="text-org4e98603">
<p>To define a model for training we'll follow these steps:</p>
<ol class="org-ol">
<li>Load in a pre-trained VGG16 model</li>
<li>"Freeze" all the parameters, so the net acts as a fixed feature extractor</li>
<li>Remove the last layer</li>
<li>Replace the last layer with a linear classifier of our own</li>
</ol>
<p>/Freezing simply means that the parameters in the pre-trained model will <b>not</b> change during training.**</p>
<p>Load the pretrained model from pytorch</p>
<div class="highlight">
<pre><span></span>vgg16 = models.vgg16(pretrained=True)
</pre></div>
<p>Print Out The Model Structure</p>
<div class="highlight">
<pre><span></span>print(vgg16)
</pre></div>
<pre class="example" id="orgc1464f4">
VGG(
  (features): Sequential(
    (0): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU(inplace)
    (2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (3): ReLU(inplace)
    (4): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (5): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (6): ReLU(inplace)
    (7): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (8): ReLU(inplace)
    (9): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (10): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (11): ReLU(inplace)
    (12): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (13): ReLU(inplace)
    (14): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (15): ReLU(inplace)
    (16): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (17): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (18): ReLU(inplace)
    (19): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (20): ReLU(inplace)
    (21): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (22): ReLU(inplace)
    (23): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (24): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (25): ReLU(inplace)
    (26): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (27): ReLU(inplace)
    (28): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (29): ReLU(inplace)
    (30): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  )
  (classifier): Sequential(
    (0): Linear(in_features=25088, out_features=4096, bias=True)
    (1): ReLU(inplace)
    (2): Dropout(p=0.5)
    (3): Linear(in_features=4096, out_features=4096, bias=True)
    (4): ReLU(inplace)
    (5): Dropout(p=0.5)
    (6): Linear(in_features=4096, out_features=1000, bias=True)
  )
)
</pre>
<p>Since we're only going to change the last (classification) layer, it might be helpful to see how many inputs and outpts it has.</p>
<div class="highlight">
<pre><span></span>print(vgg16.classifier[6].in_features) 
print(vgg16.classifier[6].out_features) 
</pre></div>
<pre class="example">
4096
1000
</pre>
<p>So, the original model output 1,000 classes - we're going to need to change that to our five classes (eventually).</p>
<p>Freeze training for all "features" layers</p>
<div class="highlight">
<pre><span></span>for param in vgg16.features.parameters():
    param.requires_grad = False
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org14b0573">
<h2 id="org14b0573">Final Classifier Layer</h2>
<div class="outline-text-2" id="text-org14b0573">
<p>Once you have the pre-trained feature extractor, you just need to modify and/or add to the final, fully-connected classifier layers. In this case, we suggest that you replace the last layer in the vgg classifier group of layers.</p>
<p>This layer should see as input the number of features produced by the portion of the network that you are not changing, and produce an appropriate number of outputs for the flower classification task.</p>
<p>You can access any layer in a pretrained network by name and (sometimes) number, i.e. <code>vgg16.classifier[6]</code> is the sixth layer in a group of layers named "classifier".</p>
<div class="highlight">
<pre><span></span>classifier = nn.Sequential(OrderedDict([
    ("Fullly Connected Classifier", nn.Linear(in_features=4096, out_features=CLASS_COUNT, bias=True)),
]))
vgg16.classifier[6] = classifier
</pre></div>
<p>after completing your model, if GPU is available, move the model to GPU</p>
<div class="highlight">
<pre><span></span>vgg16.to(device)
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgbef46a6">
<h2 id="orgbef46a6">Specify <a href="http://pytorch.org/docs/stable/nn.html#loss-functions">Loss Function</a> and <a href="http://pytorch.org/docs/stable/optim.html">Optimizer</a></h2>
<div class="outline-text-2" id="text-orgbef46a6">
<p>Below we'll use cross-entropy loss and stochastic gradient descent with a small learning rate. Note that the optimizer accepts as input <i>only</i> the trainable parameters <code>vgg.classifier.parameters()</code>.</p>
</div>
<div class="outline-3" id="outline-container-orgf99f031">
<h3 id="orgf99f031">Specify Loss Function (Categorical Cross-Entropy)</h3>
<div class="outline-text-3" id="text-orgf99f031">
<div class="highlight">
<pre><span></span>criterion = nn.CrossEntropyLoss()
</pre></div>
<p>specify optimizer (stochastic gradient descent) and learning rate = 0.001</p>
<div class="highlight">
<pre><span></span>optimizer = optimize.SGD(vgg16.classifier.parameters(), lr=0.001)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org6ac7add">
<h2 id="org6ac7add">Training</h2>
<div class="outline-text-2" id="text-org6ac7add">
<p>Here, we'll train the network.</p>
<p><b>Exercise:</b> So far we've been providing the training code for you. Here, I'm going to give you a bit more of a challenge and have you write the code to train the network. Of course, you'll be able to see my solution if you need help.</p>
<p>number of epochs to train the model</p>
<div class="highlight">
<pre><span></span>n_epochs = EPOCHS = 2
def train(model: nn.Module, epochs: int=EPOCHS, model_number: int=0,
          epoch_offset: int=1, print_every: int=10) -&gt; tuple:
    """Train, validate, and save the model
    This trains the model and validates it, saving the best 
    (based on validation loss) as =model_&lt;number&gt;_cifar.pth=

    Args:
     model: the network to train
     epochs: number of times to repeat training
     model_number: an identifier for the saved hyperparameters file
     epoch_offset: amount of epochs that have occurred previously
     print_every: how often to print output
    Returns:
     filename, training-loss, validation-loss, improvements: the outcomes for the training
    """
    optimizer = optimize.SGD(model.parameters(), lr=0.001)
    criterion = nn.CrossEntropyLoss()
    output_file = "model_{}_vgg.pth".format(model_number)
    training_losses = []
    validation_losses = []
    improvements = []
    valid_loss_min = numpy.Inf # track change in validation loss
    epoch_start = epoch_offset
    last_epoch = epoch_start + epochs + 1
    for epoch in range(epoch_start, last_epoch):

        # keep track of training and validation loss
        train_loss = 0.0
        valid_loss = 0.0

        model.train()
        for data, target in train_loader:
            # move tensors to GPU if CUDA is available            
            data, target = data.to(device), target.to(device)
            # clear the gradients of all optimized variables
            optimizer.zero_grad()
            # forward pass: compute predicted outputs by passing inputs to the model
            output = model(data)
            # calculate the batch loss
            loss = criterion(output, target)
            # backward pass: compute gradient of the loss with respect to model parameters
            loss.backward()
            # perform a single optimization step (parameter update)
            optimizer.step()
            # update training loss
            train_loss += loss.item() * data.size(0)

        model.eval()
        for data, target in valid_loader:
            # move tensors to GPU if CUDA is available
            data, target = data.to(device), target.to(device)
            # forward pass: compute predicted outputs by passing inputs to the model
            output = model(data)
            # calculate the batch loss
            loss = criterion(output, target)
            # update total validation loss 
            valid_loss += loss.item() * data.size(0)

        # calculate average losses
        train_loss = train_loss/len(train_loader.dataset)
        valid_loss = valid_loss/len(valid_loader.dataset)

        # print training/validation statistics 
        if not (epoch % print_every):
            print('Epoch: {} \tTraining Loss: {:.6f} \tValidation Loss: {:.6f}'.format(
                epoch, train_loss, valid_loss))
        training_losses.append(train_loss)
        validation_losses.append(valid_loss)
        # save model if validation loss has decreased
        if valid_loss &lt;= valid_loss_min:
            print('Validation loss decreased ({:.6f} --&gt; {:.6f}).  Saving model ...'.format(
            valid_loss_min,
            valid_loss))
            torch.save(model.state_dict(), output_file)
            valid_loss_min = valid_loss
            improvements.append(epoch - 1)
    return output_file, training_losses, validation_losses, improvements
</pre></div>
<div class="highlight">
<pre><span></span>def test(best_model):
    criterion = nn.CrossEntropyLoss()
    # track test loss
    test_loss = 0.0
    class_correct = list(0. for i in range(10))
    class_total = list(0. for i in range(10))

    best_model.to(device)
    best_model.eval()
    # iterate over test data
    for data, target in test_loader:
        # move tensors to GPU if CUDA is available
        data, target = data.to(device), target.to(device)
        # forward pass: compute predicted outputs by passing inputs to the model
        output = best_model(data)
        # calculate the batch loss
        loss = criterion(output, target)
        # update test loss 
        test_loss += loss.item() * data.size(0)
        # convert output probabilities to predicted class
        _, pred = torch.max(output, 1)    
        # compare predictions to true label
        correct_tensor = pred.eq(target.data.view_as(pred))
        correct = (
            numpy.squeeze(correct_tensor.numpy())
            if not train_on_gpu
            else numpy.squeeze(correct_tensor.cpu().numpy()))
        # calculate test accuracy for each object class
        for i in range(BATCH_SIZE):
            label = target.data[i]
            class_correct[label] += correct[i].item()
            class_total[label] += 1

    # average test loss
    test_loss = test_loss/len(test_loader.dataset)
    print('Test Loss: {:.6f}\n'.format(test_loss))

    for i in range(10):
        if class_total[i] &gt; 0:
            print('Test Accuracy of %5s: %2d%% (%2d/%2d)' % (
                classes[i], 100 * class_correct[i] / class_total[i],
                numpy.sum(class_correct[i]), numpy.sum(class_total[i])))
        else:
            print('Test Accuracy of %5s: N/A (no training examples)' % (classes[i]))

    print('\nTest Accuracy (Overall): %2d%% (%2d/%2d)' % (
        100. * numpy.sum(class_correct) / numpy.sum(class_total),
        numpy.sum(class_correct), numpy.sum(class_total)))
</pre></div>
<div class="highlight">
<pre><span></span>output_file, training_losses, validation_losses, improvements = train(vgg16, print_every=1)
</pre></div>
<div class="highlight">
<pre><span></span>training_losses = []
validation_losses = []
improvements = []
valid_loss_min = numpy.Inf # track change in validation loss
for epoch in range(1, 3):

    # keep track of training and validation loss
    train_loss = 0.0
    valid_loss = 0.0

    vgg16.train()
    for data, target in train_loader:
        # move tensors to GPU if CUDA is available            
        data, target = data.to(device), target.to(device)
        # clear the gradients of all optimized variables
        optimizer.zero_grad()
        # forward pass: compute predicted outputs by passing inputs to the model
        output = vgg16(data)
        # calculate the batch loss
        loss = criterion(output, target)
        # backward pass: compute gradient of the loss with respect to model parameters
        loss.backward()
        # perform a single optimization step (parameter update)
        optimizer.step()
        # update training loss
        train_loss += loss.item() * data.size(0)

    vgg16.eval()
    for data, target in valid_loader:
        # move tensors to GPU if CUDA is available
        data, target = data.to(device), target.to(device)
        # forward pass: compute predicted outputs by passing inputs to the model
        output = vgg16(data)
        # calculate the batch loss
        loss = criterion(output, target)
        # update total validation loss 
        valid_loss += loss.item() * data.size(0)

    # calculate average losses
    train_loss = train_loss/len(train_loader.dataset)
    valid_loss = valid_loss/len(valid_loader.dataset)

    # print training/validation statistics 
    print('Epoch: {} \tTraining Loss: {:.6f} \tValidation Loss: {:.6f}'.format(
        epoch, train_loss, valid_loss))
    training_losses.append(train_loss)
    validation_losses.append(valid_loss)
    # save model if validation loss has decreased
    if valid_loss &lt;= valid_loss_min:
        print('Validation loss decreased ({:.6f} --&gt; {:.6f}).  Saving model ...'.format(
        valid_loss_min,
        valid_loss))
        torch.save(vgg16.state_dict(), output_file)
        valid_loss_min = valid_loss
        improvements.append(epoch - 1)
</pre></div>
<p>test_loss = 0.0 class_correct = list(0. for i in range(5)) class_total = list(0. for i in range(5))</p>
<p>vgg16.eval() # eval mode</p>
<p>for data, target in test_loader:</p>
<p>if train_on_gpu: data, target = data.cuda(), target.cuda()</p>
<p>output = vgg16(data)</p>
<p>loss = criterion(output, target)</p>
<p>test_loss += loss.item()*data.size(0)</p>
<p>_, pred = torch.max(output, 1)</p>
<p>correct_tensor = pred.eq(target.data.view_as(pred)) correct = np.squeeze(correct_tensor.numpy()) if not train_on_gpu else np.squeeze(correct_tensor.cpu().numpy())</p>
<p>for i in range(batch_size): label = target.data[i] class_correct[label] += correct[i].item() class_total[label] += 1</p>
<p>test_loss = test_loss/len(test_loader.dataset) print('Test Loss: {:.6f}\n'.format(test_loss))</p>
<p>for i in range(5): if class_total[i] &gt; 0: print('Test Accuracy of %5s: %2d%% (%2d/%2d)' % ( classes[i], 100 * class_correct[i] / class_total[i], np.sum(class_correct[i]), np.sum(class_total[i]))) else: print('Test Accuracy of %5s: N/A (no training examples)' % (classes[i]))</p>
<p>print('\nTest Accuracy (Overall): %2d%% (%2d/%2d)' % (</p>
<ol class="org-ol">
<li>* np.sum(class_correct) / np.sum(class_total),</li>
</ol>
<p>np.sum(class_correct), np.sum(class_total)))</p>
<p>dataiter = iter(test_loader) images, labels = dataiter.next() images.numpy()</p>
<p>if train_on_gpu: images = images.cuda()</p>
<p>output = vgg16(images)</p>
<p>_, preds_tensor = torch.max(output, 1) preds = np.squeeze(preds_tensor.numpy()) if not train_on_gpu else np.squeeze(preds_tensor.cpu().numpy())</p>
<p>fig = plt.figure(figsize=(25, 4)) for idx in np.arange(20): ax = fig.add_subplot(2, 20/2, idx+1, xticks=[], yticks=[]) plt.imshow(np.transpose(images[idx], (1, 2, 0))) ax.set_title("{} ({})".format(classes[preds[idx]], classes[labels[idx]]), color=("green" if preds[idx]==labels[idx].item() else "red"))</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/convolutional-layers-in-pytorch/index.html">Convolutional Layers in PyTorch</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/convolutional-layers-in-pytorch/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-06T21:46:04-08:00" itemprop="datePublished" title="2018-12-06 21:46">2018-12-06 21:46</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/convolutional-layers-in-pytorch/index.html#org3a53943">Introduction</a></li>
<li><a href="posts/nano/cnn/convolutional-layers-in-pytorch/index.html#org0149469">Convolutional Layers in PyTorch</a></li>
<li><a href="posts/nano/cnn/convolutional-layers-in-pytorch/index.html#org42febb9">Questions</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org3a53943">
<h2 id="org3a53943">Introduction</h2>
<div class="outline-text-2" id="text-org3a53943">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org0149469">
<h2 id="org0149469">Convolutional Layers in PyTorch</h2>
<div class="outline-text-2" id="text-org0149469">
<p>The Convolutional class (Conv2D) is part of the <code>nn</code> module so you have to import that.</p>
<div class="highlight">
<pre><span></span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org42febb9">
<h2 id="org42febb9">Questions</h2>
<div class="outline-text-2" id="text-org42febb9">
<div class="highlight">
<pre><span></span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org2217bba">
<h3 id="org2217bba">Question 1</h3>
<div class="outline-text-3" id="text-org2217bba">
<p>After going through the four-layer sequence, what is the depth of the final output?</p>
<ul class="org-ul">
<li class="off"><code>[&nbsp;]</code> 1</li>
<li class="off"><code>[&nbsp;]</code> 3</li>
<li class="off"><code>[&nbsp;]</code> 10</li>
<li class="off"><code>[&nbsp;]</code> 20</li>
<li class="off"><code>[&nbsp;]</code> 40</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org79e71b9">
<h3 id="org79e71b9">Question 2</h3>
<div class="outline-text-3" id="text-org79e71b9">
<p>What is the x-y size of the output of the final maxpooling layer?</p>
<ul class="org-ul">
<li class="off"><code>[&nbsp;]</code> 8</li>
<li class="off"><code>[&nbsp;]</code> 15</li>
<li class="off"><code>[&nbsp;]</code> 16</li>
<li class="off"><code>[&nbsp;]</code> 30</li>
<li class="off"><code>[&nbsp;]</code> 32</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org46fa4f0">
<h3 id="org46fa4f0">Question 3</h3>
<div class="outline-text-3" id="text-org46fa4f0">
<p>How many parameters, total, will be left after an image passes through all four of the above layers in sequence?</p>
<ul class="org-ul">
<li class="off"><code>[&nbsp;]</code> 4 x 4 x 20</li>
<li class="off"><code>[&nbsp;]</code> 128 x 20</li>
<li class="off"><code>[&nbsp;]</code> 16 x 16 x 20</li>
<li class="off"><code>[&nbsp;]</code> 32 x 32 x 20</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/cifar-10/index.html">CIFAR-10</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/cifar-10/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-04T15:26:15-08:00" itemprop="datePublished" title="2018-12-04 15:26">2018-12-04 15:26</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/cifar-10/index.html#orgb25197e">Introduction</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#orge539d58">Set Up</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#orgf05b040">Visualize a Batch of Training Data</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#orgc2378d4">Define the Network Architecture</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#org60f182a">Define a model with multiple convolutional layers, and define the feedforward network behavior.</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#org0b4a27a">Output volume for a convolutional layer</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#org016f7a8">Specify Loss Function and Optimizer</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#orgeb37d0c">Train the Network</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#orgccd69e8">Load the Model with the Lowest Validation Loss</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#org2844828">Test the Trained Network</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#orgb3f3e9b">Make it Easier</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#org320325a">Take two</a></li>
<li><a href="posts/nano/cnn/cifar-10/index.html#orgc691fab">Change the Training and Validation Sets</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb25197e">
<h2 id="orgb25197e">Introduction</h2>
<div class="outline-text-2" id="text-orgb25197e">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree. This will use a <b>Convolutional Neural Network (CNN)</b> to classify images from the <a href="https://en.wikipedia.org/wiki/CIFAR-10">CIFAR-10</a> data set.</p>
<p>The images in this data set are small color images that fall into one of ten classes:</p>
<ul class="org-ul">
<li>airplane</li>
<li>automobile</li>
<li>bird</li>
<li>cat</li>
<li>deer</li>
<li>dog</li>
<li>frog</li>
<li>horse</li>
<li>ship</li>
<li>truck</li>
</ul>
<p>There is another description of it on the <a href="https://www.cs.toronto.edu/~kriz/cifar.html">University of Toronto's</a> page for it.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orge539d58">
<h2 id="orge539d58">Set Up</h2>
<div class="outline-text-2" id="text-orge539d58"></div>
<div class="outline-3" id="outline-container-org06a184c">
<h3 id="org06a184c">Imports</h3>
<div class="outline-text-3" id="text-org06a184c"></div>
<div class="outline-4" id="outline-container-orga8f16a1">
<h4 id="orga8f16a1">From Python</h4>
<div class="outline-text-4" id="text-orga8f16a1">
<div class="highlight">
<pre><span></span>from datetime import datetime
from pathlib import Path
from typing import Tuple
import os
import pickle
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8fa4244">
<h4 id="org8fa4244">From PyPi</h4>
<div class="outline-text-4" id="text-org8fa4244">
<div class="highlight">
<pre><span></span>from dotenv import load_dotenv
from sklearn.model_selection import train_test_split
from torchvision import datasets
from torch.utils.data.sampler import SubsetRandomSampler
import matplotlib.pyplot as pyplot
import numpy
import seaborn
import torch
import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optimize
import torchvision.transforms as transforms
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9059efb">
<h4 id="org9059efb">This Project</h4>
<div class="outline-text-4" id="text-org9059efb">
<div class="highlight">
<pre><span></span>from neurotic.tangles.data_paths import DataPathTwo
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org9e145b1">
<h3 id="org9e145b1">Plotting</h3>
<div class="outline-text-3" id="text-org9e145b1">
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
get_ipython().run_line_magic('config', "InlineBackend.figure_format = 'retina'")
seaborn.set(style="whitegrid",
            rc={"axes.grid": False,
                "font.family": ["sans-serif"],
                "font.sans-serif": ["Latin Modern Sans", "Lato"],
                "figure.figsize": (8, 6)},
            font_scale=3)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc0456d0">
<h3 id="orgc0456d0">Test for <a href="http://pytorch.org/docs/stable/cuda.html">CUDA</a></h3>
<div class="outline-text-3" id="text-orgc0456d0">
<p>The test-code uses the check later on so I'll save it to the <code>train_on_gpu</code> variable.</p>
<div class="highlight">
<pre><span></span>if os.environ.get("USER") == "brunhilde":
    train_on_gpu = False
    device = torch.device("cpu")
else:
    train_on_gpu = torch.cuda.is_available()
    device = torch.device("cuda:0" if train_on_gpu else "cpu")
print("Using: {}".format(device))
</pre></div>
<pre class="example">
Using: cuda:0
</pre></div>
</div>
<div class="outline-3" id="outline-container-orge2f022e">
<h3 id="orge2f022e">Load the <a href="http://pytorch.org/docs/stable/torchvision/datasets.html">Data</a></h3>
<div class="outline-text-3" id="text-orge2f022e">
<div class="highlight">
<pre><span></span># subprocesses to use
NUM_WORKERS = 0
# how many samples per batch to load
BATCH_SIZE = 20
# percentage of training set to use as validation
VALIDATION_FRACTION = 0.2

IMAGE_SIZE = 32
</pre></div>
<p>Convert the data to a normalized <code>torch.FloatTensor</code> using a pipeline. I'm also going to introduce some randomness to help the model generalize.</p>
<div class="highlight">
<pre><span></span>means = deviations = (0.5, 0.5, 0.5)
train_transform = transforms.Compose([
    transforms.RandomRotation(30),
    transforms.RandomResizedCrop(IMAGE_SIZE),
    transforms.RandomHorizontalFlip(),
    transforms.ToTensor(),
    transforms.Normalize(means, deviations)
    ])
test_transforms = transforms.Compose([
    transforms.ToTensor(),
    transforms.Normalize(means,
                         deviations)])
</pre></div>
<p>Choose the training and test datasets.</p>
<div class="highlight">
<pre><span></span>load_dotenv()
path = DataPathTwo(folder_key="CIFAR")
print(path.folder)
</pre></div>
<pre class="example">
/home/hades/datasets/CIFAR
</pre>
<div class="highlight">
<pre><span></span>training_data = datasets.CIFAR10(path.folder, train=True,
                              download=True, transform=train_transform)
test_data = datasets.CIFAR10(path.folder, train=False,
                             download=True, transform=test_transforms)
</pre></div>
<pre class="example">
Files already downloaded and verified
Files already downloaded and verified
</pre>
<div class="highlight">
<pre><span></span>for item in path.folder.iterdir():
    print(item)
</pre></div>
<pre class="example">
/home/hades/datasets/CIFAR/cifar-10-batches-py
/home/hades/datasets/CIFAR/cifar-10-python.tar.gz
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgc0cf829">
<h3 id="orgc0cf829">Obtain Training Indices For Validation</h3>
<div class="outline-text-3" id="text-orgc0cf829">
<div class="highlight">
<pre><span></span>indices = list(range(len(training_data)))
training_indices, validation_indices = train_test_split(
    indices,
    test_size=VALIDATION_FRACTION)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5dda5d4">
<h3 id="org5dda5d4">Define Samplers For Training And Validation Batches</h3>
<div class="outline-text-3" id="text-org5dda5d4">
<div class="highlight">
<pre><span></span>train_sampler = SubsetRandomSampler(training_indices)
valid_sampler = SubsetRandomSampler(validation_indices)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf5c280e">
<h3 id="orgf5c280e">Prepare Data Loaders</h3>
<div class="outline-text-3" id="text-orgf5c280e">
<div class="highlight">
<pre><span></span>train_loader = torch.utils.data.DataLoader(training_data, batch_size=BATCH_SIZE,
    sampler=train_sampler, num_workers=NUM_WORKERS)
valid_loader = torch.utils.data.DataLoader(training_data, batch_size=BATCH_SIZE, 
    sampler=valid_sampler, num_workers=NUM_WORKERS)
test_loader = torch.utils.data.DataLoader(test_data, batch_size=BATCH_SIZE, 
    num_workers=NUM_WORKERS)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org805fab6">
<h3 id="org805fab6">The Image Classes</h3>
<div class="outline-text-3" id="text-org805fab6">
<div class="highlight">
<pre><span></span>classes = ['airplane', 'automobile', 'bird', 'cat', 'deer',
           'dog', 'frog', 'horse', 'ship', 'truck']
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf05b040">
<h2 id="orgf05b040">Visualize a Batch of Training Data</h2>
<div class="outline-text-2" id="text-orgf05b040"></div>
<div class="outline-3" id="outline-container-org4a5bf22">
<h3 id="org4a5bf22">helper function to un-normalize and display an image</h3>
<div class="outline-text-3" id="text-org4a5bf22">
<div class="highlight">
<pre><span></span>def imshow(img):
    img = img / 2 + 0.5  # unnormalize
    pyplot.imshow(numpy.transpose(img, (1, 2, 0)))  # convert from Tensor image
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org9cf1649">
<h3 id="org9cf1649">obtain one batch of training images</h3>
<div class="outline-text-3" id="text-org9cf1649">
<div class="highlight">
<pre><span></span>dataiter = iter(train_loader)
images, labels = dataiter.next()
images = images.numpy() # convert images to numpy for display
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orga190d2e">
<h3 id="orga190d2e">plot the images in the batch, along with the corresponding labels</h3>
<div class="outline-text-3" id="text-orga190d2e">
<div class="highlight">
<pre><span></span>figure = pyplot.figure(figsize=(25, 4))
# display 20 images
figure.suptitle("Batch Sample", weight="bold")
for idx in numpy.arange(20):
    ax = figure.add_subplot(2, 20/2, idx+1, xticks=[], yticks=[])
    imshow(images[idx])
    ax.set_title(classes[labels[idx]])
#pyplot.subplots_adjust(top=0.7)
pyplot.tight_layout(rect=[0, 0.03, 1, 0.95])
</pre></div>
<div class="figure" id="org15d30c1">
<p><img alt="batch.png" src="posts/nano/cnn/cifar-10/batch.png"></p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org9a39489">
<h3 id="org9a39489">View an Image in More Detail</h3>
<div class="outline-text-3" id="text-org9a39489">
<p>Here, we look at the normalized red, green, and blue (RGB) color channels as three separate, grayscale intensity images.</p>
<div class="highlight">
<pre><span></span>rgb_img = numpy.squeeze(images[3])
channels = ['red channel', 'green channel', 'blue channel']

fig = pyplot.figure(figsize = (36, 36)) 
for idx in numpy.arange(rgb_img.shape[0]):
    ax = fig.add_subplot(1, 3, idx + 1)
    img = rgb_img[idx]
    ax.imshow(img, cmap='gray')
    ax.set_title(channels[idx])
    width, height = img.shape
    thresh = img.max()/2.5
    for x in range(width):
        for y in range(height):
            val = round(img[x][y],2) if img[x][y] !=0 else 0
            ax.annotate(str(val), xy=(y,x),
                    horizontalalignment='center',
                    verticalalignment='center', size=8,
                    color='white' if img[x][y]&lt;thresh else 'black')
</pre></div>
<div class="figure" id="org9c38695">
<p><img alt="rgb.png" src="posts/nano/cnn/cifar-10/rgb.png"></p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc2378d4">
<h2 id="orgc2378d4">Define the Network <a href="http://pytorch.org/docs/stable/nn.html">Architecture</a></h2>
<div class="outline-text-2" id="text-orgc2378d4">
<p>This time, you'll define a CNN architecture. Instead of an MLP, which used linear, fully-connected layers, you'll use the following:</p>
<ul class="org-ul">
<li><a href="https://pytorch.org/docs/stable/nn.html#conv2d">Convolutional layers</a>, which can be thought of as stack of filtered images.</li>
<li><a href="https://pytorch.org/docs/stable/nn.html#maxpool2d">Maxpooling layers</a>, which reduce the x-y size of an input, keeping only the most <i>active</i> pixels from the previous layer.</li>
<li>The usual Linear + Dropout layers to avoid overfitting and produce a 10-dim output.</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org60f182a">
<h2 id="org60f182a">Define a model with multiple convolutional layers, and define the feedforward network behavior.</h2>
<div class="outline-text-2" id="text-org60f182a">
<p>The more convolutional layers you include, the more complex patterns in color and shape a model can detect. It's suggested that your final model include 2 or 3 convolutional layers as well as linear layers + dropout in between to avoid overfitting.</p>
<p>It's good practice to look at existing research and implementations of related models as a starting point for defining your own models. You may find it useful to look at <a href="https://github.com/pytorch/tutorials/blob/master/beginner_source/blitz/cifar10_tutorial.py">this PyTorch classification example</a> or <a href="https://github.com/keras-team/keras/blob/master/examples/cifar10_cnn.py">this, more complex Keras example</a> to help decide on a final structure.</p>
<p>This is taken from the <a href="https://pytorch.org/tutorials/beginner/blitz/cifar10_tutorial.html#training-an-image-classifier">pytorch tutorial</a>, with padding and dropout added. I also changed the kernel size to 3.</p>
<p>See:</p>
<ul class="org-ul">
<li><a href="https://pytorch.org/docs/stable/nn.html?highlight=conv2d#torch.nn.Conv2d">Conv2d</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html?highlight=nn%20maxpool#torch.nn.MaxPool2d">MaxPool2d</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html#linear-layers">Linear</a></li>
<li><a href="https://pytorch.org/docs/stable/nn.html#dropout-layers">Dropout</a></li>
<li><a href="https://pytorch.org/docs/stable/tensors.html?highlight=view#torch.Tensor.view">view</a></li>
</ul>
<div class="highlight">
<pre><span></span>KERNEL_SIZE = 3
CHANNELS_IN = 3
CHANNELS_OUT_1 = 6
CHANNELS_OUT_2 = 16
CLASSES = 10
PADDING = 1
STRIDE = 1
</pre></div>
<div class="highlight">
<pre><span></span>convolutional_1 = nn.Conv2d(CHANNELS_IN, CHANNELS_OUT_1,
                            KERNEL_SIZE, 
                            stride=STRIDE, padding=PADDING)
pool = nn.MaxPool2d(2, 2)
convolutional_2 = nn.Conv2d(CHANNELS_OUT_1, CHANNELS_OUT_2,
                            KERNEL_SIZE,
                            stride=STRIDE, padding=PADDING)

c_no_padding_1 = nn.Conv2d(CHANNELS_IN, CHANNELS_OUT_1, KERNEL_SIZE)
c_no_padding_2 = nn.Conv2d(CHANNELS_OUT_1, CHANNELS_OUT_2, KERNEL_SIZE)
fully_connected_1 = nn.Linear(CHANNELS_OUT_2 * (KERNEL_SIZE + PADDING)**3, 120)
fully_connected_1A = nn.Linear(CHANNELS_OUT_2 * (KERNEL_SIZE)**2, 120)
fully_connected_2 = nn.Linear(120, 84)
fully_connected_3 = nn.Linear(84, CLASSES)
cnn_dropout = nn.Dropout(0.25)
connected_dropout = nn.Dropout(0.5)

dataiter = iter(train_loader)
images, labels = dataiter.next()
input_image = torch.Tensor(images)
</pre></div>
<div class="highlight">
<pre><span></span>print("Input Shape: {}".format(input_image.shape))
x = cnn_dropout(pool(F.relu(convolutional_1(input_image))))
print("Output 1: {}".format(x.shape))
x = cnn_dropout(pool(F.relu(convolutional_2(x))))
print("Output 2: {}".format(x.shape))
x = x.view(x.size()[0], -1)
print("reshaped: {}".format(x.shape))
x = connected_dropout(F.relu(fully_connected_1(x)))
print("Connected Shape: {}".format(x.shape))
x = F.relu(fully_connected_2(x))
print("Connected Shape 2: {}".format(x.shape))
x = fully_connected_3(x)
print("Connected Shape 3: {}".format(x.shape))
</pre></div>
<pre class="example">
Input Shape: torch.Size([20, 3, 32, 32])
Output 1: torch.Size([20, 6, 16, 16])
Output 2: torch.Size([20, 16, 8, 8])
reshaped: torch.Size([20, 1024])
Connected Shape: torch.Size([20, 120])
Connected Shape 2: torch.Size([20, 84])
Connected Shape 3: torch.Size([20, 10])
</pre>
<div class="highlight">
<pre><span></span>print("Input Shape: {}".format(input_image.shape))
x = cnn_dropout(pool(F.relu(c_no_padding_1(input_image))))
print("Output 1: {}".format(x.shape))
x = cnn_dropout(pool(F.relu(c_no_padding_2(x))))
print("Output 2: {}".format(x.shape))
x = x.view(-1, CHANNELS_OUT_2 * (KERNEL_SIZE)**2)
print("reshaped: {}".format(x.shape))
x = connected_dropout(F.relu(fully_connected_1A(x)))
print("Connected Shape: {}".format(x.shape))
x = F.relu(fully_connected_2(x))
print("Connected Shape 2: {}".format(x.shape))
x = fully_connected_3(x)
print("Connected Shape 3: {}".format(x.shape))
</pre></div>
<pre class="example">
Input Shape: torch.Size([20, 3, 32, 32])
Output 1: torch.Size([20, 6, 15, 15])
Output 2: torch.Size([20, 16, 6, 6])
reshaped: torch.Size([80, 144])
Connected Shape: torch.Size([80, 120])
Connected Shape 2: torch.Size([80, 84])
Connected Shape 3: torch.Size([80, 10])
</pre>
<div class="highlight">
<pre><span></span>class CNN(nn.Module):
    """A convolutional neural network for CIFAR-10 images"""
    def __init__(self, filter_size=5) -&gt; None:
        super().__init__()
        self.convolutional_1 = nn.Conv2d(CHANNELS_IN, CHANNELS_OUT_1,
                                         KERNEL_SIZE, 
                                         stride=STRIDE, padding=PADDING)
        self.pool = nn.MaxPool2d(2, 2)
        self.convolutional_2 = nn.Conv2d(CHANNELS_OUT_1, CHANNELS_OUT_2,
                                         KERNEL_SIZE,
                                         stride=STRIDE, padding=PADDING)
        self.fully_connected_1 = nn.Linear(CHANNELS_OUT_2 * (KERNEL_SIZE + PADDING)**3, 120)
        self.fully_connected_2 = nn.Linear(120, 84)
        self.fully_connected_3 = nn.Linear(84, CLASSES)
        self.cnn_dropout = nn.Dropout(0.25)
        self.connected_dropout = nn.Dropout(0.5)
        return

    def forward(self, x: torch.Tensor) -&gt; torch.Tensor:
        """Passes the image through the layers of the network

        Args:
         image: CIFAR image to process
        """
        x = self.cnn_dropout(self.pool(F.relu(self.convolutional_1(x))))
        x = self.cnn_dropout(self.pool(F.relu(self.convolutional_2(x))))
        # flatten to a vector
        x = x.view(x.size()[0], -1)
        x = self.connected_dropout(F.relu(self.fully_connected_1(x)))
        x = F.relu(self.fully_connected_2(x))
        return self.fully_connected_3(x)
</pre></div>
<div class="highlight">
<pre><span></span>model = CNN()
dataiter = iter(train_loader)
images, labels = dataiter.next()
print(images.shape)
print(labels.shape)
output = model(images)
print(output.shape)
</pre></div>
<pre class="example">
torch.Size([20, 3, 32, 32])
torch.Size([20])
torch.Size([20, 10])
</pre></div>
</div>
<div class="outline-2" id="outline-container-org0b4a27a">
<h2 id="org0b4a27a">Output volume for a convolutional layer</h2>
<div class="outline-text-2" id="text-org0b4a27a">
<p>To compute the output size of a given convolutional layer we can perform the following calculation (taken from <a href="http://cs231n.github.io/convolutional-networks/#layers">Stanford's cs231n course</a>):</p>
<p>We can compute the spatial size of the output volume as a function of the input volume size (W), the kernel/filter size (F), the stride with which they are applied (S), and the amount of zero padding used (P) on the border. The correct formula for calculating how many neurons define the output_W is given by <code>(WF+2P)/S+1</code>.</p>
<p>For example for a 7x7 input and a 3x3 filter with stride 1 and pad 0 we would get a 5x5 output. With stride 2 we would get a 3x3 output.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org016f7a8">
<h2 id="org016f7a8">Specify <a href="http://pytorch.org/docs/stable/nn.html#loss-functions">Loss Function</a> and <a href="http://pytorch.org/docs/stable/optim.html">Optimizer</a></h2>
<div class="outline-text-2" id="text-org016f7a8">
<p>Decide on a loss and optimization function that is best suited for this classification task. The linked code examples from above, may be a good starting point; <a href="https://github.com/pytorch/tutorials/blob/master/beginner_source/blitz/cifar10_tutorial.py">this PyTorch classification example</a> or <a href="https://github.com/keras-team/keras/blob/master/examples/cifar10_cnn.py">this, more complex Keras example</a>. Pay close attention to the value for <b>learning rate</b> as this value determines how your model converges to a small error.</p>
<div class="highlight">
<pre><span></span>criterion = nn.CrossEntropyLoss()
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgeb37d0c">
<h2 id="orgeb37d0c">Train the Network</h2>
<div class="outline-text-2" id="text-orgeb37d0c">
<p>Remember to look at how the training and validation loss decreases over time; if the validation loss ever increases it indicates possible overfitting.</p>
<div class="highlight">
<pre><span></span>def train(model: nn.Module, epochs: int=10, model_number: int=0, 
          epoch_offset: int=1, print_every: int=10) -&gt; tuple:
    """Train, validate, and save the model
    This trains the model and validates it, saving the best 
    (based on validation loss) as =model_&lt;number&gt;_cifar.pth=

    Args:
     model: the network to train
     epochs: number of times to repeat training
     model_number: an identifier for the saved hyperparameters file
     epoch_offset: amount of epochs that have occurred previously
     print_every: how often to print output
    Returns:
     filename, training-loss, validation-loss, improvements: the outcomes for the training
    """
    optimizer = optimize.SGD(model.parameters(), lr=0.001, momentum=0.9)
    criterion = nn.CrossEntropyLoss()
    output_file = "model_{}_cifar.pth".format(model_number)
    training_losses = []
    validation_losses = []
    improvements = []
    valid_loss_min = numpy.Inf # track change in validation loss
    epoch_start = epoch_offset
    last_epoch = epoch_start + epochs + 1
    for epoch in range(epoch_start, last_epoch):

        # keep track of training and validation loss
        train_loss = 0.0
        valid_loss = 0.0

        model.train()
        for data, target in train_loader:
            # move tensors to GPU if CUDA is available            
            data, target = data.to(device), target.to(device)
            # clear the gradients of all optimized variables
            optimizer.zero_grad()
            # forward pass: compute predicted outputs by passing inputs to the model
            output = model(data)
            # calculate the batch loss
            loss = criterion(output, target)
            # backward pass: compute gradient of the loss with respect to model parameters
            loss.backward()
            # perform a single optimization step (parameter update)
            optimizer.step()
            # update training loss
            train_loss += loss.item() * data.size(0)

        model.eval()
        for data, target in valid_loader:
            # move tensors to GPU if CUDA is available
            data, target = data.to(device), target.to(device)
            # forward pass: compute predicted outputs by passing inputs to the model
            output = model(data)
            # calculate the batch loss
            loss = criterion(output, target)
            # update total validation loss 
            valid_loss += loss.item() * data.size(0)

        # calculate average losses
        train_loss = train_loss/len(train_loader.dataset)
        valid_loss = valid_loss/len(valid_loader.dataset)

        # print training/validation statistics 
        if not (epoch % print_every):
            print('Epoch: {} \tTraining Loss: {:.6f} \tValidation Loss: {:.6f}'.format(
                epoch, train_loss, valid_loss))
        training_losses.append(train_loss)
        validation_losses.append(valid_loss)
        # save model if validation loss has decreased
        if valid_loss &lt;= valid_loss_min:
            print('Validation loss decreased ({:.6f} --&gt; {:.6f}).  Saving model ...'.format(
            valid_loss_min,
            valid_loss))
            torch.save(model.state_dict(), output_file)
            valid_loss_min = valid_loss
            improvements.append(epoch - 1)
    return output_file, training_losses, validation_losses, improvements
</pre></div>
</div>
<div class="outline-3" id="outline-container-org0749ae9">
<h3 id="org0749ae9">Pytorch Tutorial Model</h3>
<div class="outline-text-3" id="text-org0749ae9">
<div class="highlight">
<pre><span></span>EPOCHS = 250
</pre></div>
<p>This is only to avoid re-running the initial training and use the saved model. <b>Note:</b> If you use DataParallel you need to save the model using <code>model.module.state_dict()</code> in order to load it later without it. This won't matter if you always use it or never use it, but here I have a model that was trained on a GPU and I'm trying to extend the training with a computer whos GPU is too old for pytorch to use it, so it crashes unless I disable the DataParallel (because I didn't originally save it with <code>model.module.state_dict</code>).</p>
<p><b>Note 2</b>: But if you don't have it in DataParallel then don't use <code>model.module.state_dict</code> because it won't have the <code>module</code> attribute.</p>
<div class="highlight">
<pre><span></span>def train_and_pickle(model:nn.Module, epochs:int=EPOCHS,
                     model_number:int=2, print_every: int=10) -&gt; dict:
    """Trains and pickles the outcomes of training"""
    path = Path("model_{}_outcomes.pkl".format(model_number))
    existed = False
    epoch_offset = 0
    if path.is_file():
        existed = True
        with path.open("rb") as reader:
            outcomes = pickle.load(reader)
            epoch_offset = len(outcomes["training_loss"])
            model.load_state_dict(torch.load(
                outcome["hyperparameters_file"],
                map_location=device))
    filename, training_loss, validation_loss, improvements  = train(
        model,
        epochs=epochs,
        model_number=model_number,
        epoch_offset=epoch_offset,
        print_every=print_every,
        )

    if existed:
        outcomes["training_loss"] += outcomes["training_loss"]
        outcomes["validation_loss"] += outcomes["validation_loss"]
        outcomes["improvements"] += outcomes["improvements"]
    else:
        outcomes = dict(
            hyperparameters_file=filename,
            outcomes_pickle=path.name,
            training_loss=training_loss,
            validation_loss=validation_loss,
            improvements=improvements,
        )
    with path.open("wb") as writer:
        pickle.dump(outcomes, writer)
    return outcomes
</pre></div>
<div class="highlight">
<pre><span></span>def update_outcome(outcome: dict, new_outcome: dict) -&gt; dict:
    """Updates the lists in the outcome

    Args:
     outcome: original output of train_and_pickle
     new_outcome: new output of train_and_pickle

    Returns:
     outcome: updated outcome
    """
    for key in ("training_loss", "validation_loss", "improvements"):
        outcome[key] += new_outcome[key]
    return outcome
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd7f7f94">
<h3 id="orgd7f7f94">First Model Training</h3>
<div class="outline-text-3" id="text-orgd7f7f94">
<div class="highlight">
<pre><span></span>model_2 = CNN()
model_2.to(device)
start = datetime.now()
outcome = train_and_pickle(
    model_2,
    epochs=100,
    model_number=2)
print("Elapsed: {}".format(datetime.now() - start))
</pre></div>
<pre class="example" id="org79b2b1d">
Epoch: 0        Training Loss: 1.834230         Validation Loss: 0.446434
Validation loss decreased (inf --&gt; 0.446434).  Saving model ...
Epoch: 1        Training Loss: 1.685185         Validation Loss: 0.403314
Validation loss decreased (0.446434 --&gt; 0.403314).  Saving model ...
Epoch: 2        Training Loss: 1.602409         Validation Loss: 0.389758
Validation loss decreased (0.403314 --&gt; 0.389758).  Saving model ...
Epoch: 3        Training Loss: 1.551087         Validation Loss: 0.376669
Validation loss decreased (0.389758 --&gt; 0.376669).  Saving model ...
Epoch: 4        Training Loss: 1.524230         Validation Loss: 0.371581
Validation loss decreased (0.376669 --&gt; 0.371581).  Saving model ...
Epoch: 5        Training Loss: 1.496748         Validation Loss: 0.367056
Validation loss decreased (0.371581 --&gt; 0.367056).  Saving model ...
Epoch: 6        Training Loss: 1.479645         Validation Loss: 0.359889
Validation loss decreased (0.367056 --&gt; 0.359889).  Saving model ...
Epoch: 7        Training Loss: 1.462357         Validation Loss: 0.358887
Validation loss decreased (0.359889 --&gt; 0.358887).  Saving model ...
Epoch: 8        Training Loss: 1.454448         Validation Loss: 0.353885
Validation loss decreased (0.358887 --&gt; 0.353885).  Saving model ...
Epoch: 9        Training Loss: 1.442392         Validation Loss: 0.349046
Validation loss decreased (0.353885 --&gt; 0.349046).  Saving model ...
Epoch: 10       Training Loss: 1.435758         Validation Loss: 0.345204
Validation loss decreased (0.349046 --&gt; 0.345204).  Saving model ...
Epoch: 11       Training Loss: 1.428880         Validation Loss: 0.344610
Validation loss decreased (0.345204 --&gt; 0.344610).  Saving model ...
Epoch: 12       Training Loss: 1.420400         Validation Loss: 0.343866
Validation loss decreased (0.344610 --&gt; 0.343866).  Saving model ...
Epoch: 13       Training Loss: 1.409974         Validation Loss: 0.341221
Validation loss decreased (0.343866 --&gt; 0.341221).  Saving model ...
Epoch: 14       Training Loss: 1.400003         Validation Loss: 0.340469
Validation loss decreased (0.341221 --&gt; 0.340469).  Saving model ...
Epoch: 15       Training Loss: 1.396430         Validation Loss: 0.338332
Validation loss decreased (0.340469 --&gt; 0.338332).  Saving model ...
Epoch: 16       Training Loss: 1.396793         Validation Loss: 0.338963
Epoch: 17       Training Loss: 1.391945         Validation Loss: 0.337340
Validation loss decreased (0.338332 --&gt; 0.337340).  Saving model ...
Epoch: 18       Training Loss: 1.383872         Validation Loss: 0.335848
Validation loss decreased (0.337340 --&gt; 0.335848).  Saving model ...
Epoch: 19       Training Loss: 1.371348         Validation Loss: 0.335116
Validation loss decreased (0.335848 --&gt; 0.335116).  Saving model ...
Epoch: 20       Training Loss: 1.374097         Validation Loss: 0.330697
Validation loss decreased (0.335116 --&gt; 0.330697).  Saving model ...
Epoch: 21       Training Loss: 1.373342         Validation Loss: 0.334281
Epoch: 22       Training Loss: 1.366379         Validation Loss: 0.331197
Epoch: 23       Training Loss: 1.366043         Validation Loss: 0.332052
Epoch: 24       Training Loss: 1.359814         Validation Loss: 0.328743
Validation loss decreased (0.330697 --&gt; 0.328743).  Saving model ...
Epoch: 25       Training Loss: 1.359745         Validation Loss: 0.328860
Epoch: 26       Training Loss: 1.353130         Validation Loss: 0.329480
Epoch: 27       Training Loss: 1.352457         Validation Loss: 0.329386
Epoch: 28       Training Loss: 1.348608         Validation Loss: 0.331024
Epoch: 29       Training Loss: 1.346584         Validation Loss: 0.325815
Validation loss decreased (0.328743 --&gt; 0.325815).  Saving model ...
Epoch: 30       Training Loss: 1.341498         Validation Loss: 0.332342
Epoch: 31       Training Loss: 1.339088         Validation Loss: 0.325358
Validation loss decreased (0.325815 --&gt; 0.325358).  Saving model ...
Epoch: 32       Training Loss: 1.347376         Validation Loss: 0.326178
Epoch: 33       Training Loss: 1.342424         Validation Loss: 0.331979
Epoch: 34       Training Loss: 1.339343         Validation Loss: 0.324638
Validation loss decreased (0.325358 --&gt; 0.324638).  Saving model ...
Epoch: 35       Training Loss: 1.332784         Validation Loss: 0.322740
Validation loss decreased (0.324638 --&gt; 0.322740).  Saving model ...
Epoch: 36       Training Loss: 1.335403         Validation Loss: 0.324083
Epoch: 37       Training Loss: 1.332313         Validation Loss: 0.334746
Epoch: 38       Training Loss: 1.329136         Validation Loss: 0.324193
Epoch: 39       Training Loss: 1.327429         Validation Loss: 0.327056
Epoch: 40       Training Loss: 1.328106         Validation Loss: 0.327257
Epoch: 41       Training Loss: 1.330462         Validation Loss: 0.321711
Validation loss decreased (0.322740 --&gt; 0.321711).  Saving model ...
Epoch: 42       Training Loss: 1.326317         Validation Loss: 0.324698
Epoch: 43       Training Loss: 1.325379         Validation Loss: 0.324895
Epoch: 44       Training Loss: 1.322629         Validation Loss: 0.322434
Epoch: 45       Training Loss: 1.320261         Validation Loss: 0.326130
Epoch: 46       Training Loss: 1.316204         Validation Loss: 0.325013
Epoch: 47       Training Loss: 1.315747         Validation Loss: 0.324042
Epoch: 48       Training Loss: 1.313305         Validation Loss: 0.324592
Epoch: 49       Training Loss: 1.313723         Validation Loss: 0.318290
Validation loss decreased (0.321711 --&gt; 0.318290).  Saving model ...
Epoch: 50       Training Loss: 1.313054         Validation Loss: 0.320845
Epoch: 51       Training Loss: 1.316062         Validation Loss: 0.321215
Epoch: 52       Training Loss: 1.316187         Validation Loss: 0.319871
Epoch: 53       Training Loss: 1.312232         Validation Loss: 0.324769
Epoch: 54       Training Loss: 1.315246         Validation Loss: 0.321788
Epoch: 55       Training Loss: 1.307923         Validation Loss: 0.318943
Epoch: 56       Training Loss: 1.316049         Validation Loss: 0.324919
Epoch: 57       Training Loss: 1.310584         Validation Loss: 0.319344
Epoch: 58       Training Loss: 1.305451         Validation Loss: 0.320848
Epoch: 59       Training Loss: 1.309900         Validation Loss: 0.322148
Epoch: 60       Training Loss: 1.306200         Validation Loss: 0.323148
Epoch: 61       Training Loss: 1.303626         Validation Loss: 0.322406
Epoch: 62       Training Loss: 1.304654         Validation Loss: 0.322471
Epoch: 63       Training Loss: 1.302740         Validation Loss: 0.322596
Epoch: 64       Training Loss: 1.306964         Validation Loss: 0.323696
Epoch: 65       Training Loss: 1.301964         Validation Loss: 0.319375
Epoch: 66       Training Loss: 1.302925         Validation Loss: 0.320327
Epoch: 67       Training Loss: 1.302062         Validation Loss: 0.319882
Epoch: 68       Training Loss: 1.299821         Validation Loss: 0.318813
Epoch: 69       Training Loss: 1.298885         Validation Loss: 0.325837
Epoch: 70       Training Loss: 1.303130         Validation Loss: 0.320493
Epoch: 71       Training Loss: 1.301353         Validation Loss: 0.321375
Epoch: 72       Training Loss: 1.294933         Validation Loss: 0.315513
Validation loss decreased (0.318290 --&gt; 0.315513).  Saving model ...
Epoch: 73       Training Loss: 1.303322         Validation Loss: 0.322531
Epoch: 74       Training Loss: 1.298327         Validation Loss: 0.323503
Epoch: 75       Training Loss: 1.298817         Validation Loss: 0.318616
Epoch: 76       Training Loss: 1.296895         Validation Loss: 0.323739
Epoch: 77       Training Loss: 1.301932         Validation Loss: 0.325410
Epoch: 78       Training Loss: 1.291901         Validation Loss: 0.327083
Epoch: 79       Training Loss: 1.295766         Validation Loss: 0.317765
Epoch: 80       Training Loss: 1.295147         Validation Loss: 0.316187
Epoch: 81       Training Loss: 1.294392         Validation Loss: 0.318913
Epoch: 82       Training Loss: 1.290720         Validation Loss: 0.320984
Epoch: 83       Training Loss: 1.296386         Validation Loss: 0.322005
Epoch: 84       Training Loss: 1.294445         Validation Loss: 0.319135
Epoch: 85       Training Loss: 1.288677         Validation Loss: 0.317673
Epoch: 86       Training Loss: 1.292154         Validation Loss: 0.318644
Epoch: 87       Training Loss: 1.292221         Validation Loss: 0.317595
Epoch: 88       Training Loss: 1.295039         Validation Loss: 0.319856
Epoch: 89       Training Loss: 1.289999         Validation Loss: 0.320703
Epoch: 90       Training Loss: 1.290199         Validation Loss: 0.317269
Epoch: 91       Training Loss: 1.289213         Validation Loss: 0.318887
Epoch: 92       Training Loss: 1.284553         Validation Loss: 0.320420
Epoch: 93       Training Loss: 1.292121         Validation Loss: 0.319414
Epoch: 94       Training Loss: 1.281610         Validation Loss: 0.314129
Validation loss decreased (0.315513 --&gt; 0.314129).  Saving model ...
Epoch: 95       Training Loss: 1.292147         Validation Loss: 0.317541
Epoch: 96       Training Loss: 1.288869         Validation Loss: 0.316178
Epoch: 97       Training Loss: 1.284419         Validation Loss: 0.326122
Epoch: 98       Training Loss: 1.292448         Validation Loss: 0.314851
Epoch: 99       Training Loss: 1.287391         Validation Loss: 0.315212
Epoch: 100      Training Loss: 1.285748         Validation Loss: 0.320298
Elapsed: 1:26:31.644031
</pre>
<div class="highlight">
<pre><span></span>pickle_path = Path("model_2_outcomes.pkl")
with pickle_path.open("rb") as reader:
    outcome = pickle.load(reader)
</pre></div>
<div class="highlight">
<pre><span></span>model_2 = CNN()
model_2.to(device)
start = datetime.now()
model_2.load_state_dict(torch.load(outcome["hyperparameters_file"],
                                   map_location=device))
outcome_2 = train_and_pickle(model_2, epochs=200, model_number=2)
outcome = update_outcome(outcome, outcome_2)
print("Elapsed: {}".format(datetime.now() - start))
</pre></div>
<pre class="example" id="orgcb0fb91">
Epoch: 101      Training Loss: 1.293572         Validation Loss: 0.323292
Validation loss decreased (inf --&gt; 0.323292).  Saving model ...
Epoch: 102      Training Loss: 1.286175         Validation Loss: 0.316041
Validation loss decreased (0.323292 --&gt; 0.316041).  Saving model ...
Epoch: 103      Training Loss: 1.292286         Validation Loss: 0.318805
Epoch: 104      Training Loss: 1.287122         Validation Loss: 0.318283
Epoch: 105      Training Loss: 1.285004         Validation Loss: 0.316454
Epoch: 106      Training Loss: 1.288655         Validation Loss: 0.328694
Epoch: 107      Training Loss: 1.286483         Validation Loss: 0.311118
Validation loss decreased (0.316041 --&gt; 0.311118).  Saving model ...
Epoch: 108      Training Loss: 1.286722         Validation Loss: 0.322617
Epoch: 109      Training Loss: 1.281688         Validation Loss: 0.317284
Epoch: 110      Training Loss: 1.286374         Validation Loss: 0.316699
Epoch: 111      Training Loss: 1.285399         Validation Loss: 0.315800
Epoch: 112      Training Loss: 1.283735         Validation Loss: 0.321917
Epoch: 113      Training Loss: 1.283596         Validation Loss: 0.311436
Epoch: 114      Training Loss: 1.285218         Validation Loss: 0.314240
Epoch: 115      Training Loss: 1.282439         Validation Loss: 0.315108
Epoch: 116      Training Loss: 1.282893         Validation Loss: 0.317056
Epoch: 117      Training Loss: 1.282942         Validation Loss: 0.313947
Epoch: 118      Training Loss: 1.287284         Validation Loss: 0.316639
Epoch: 119      Training Loss: 1.285622         Validation Loss: 0.321113
Epoch: 120      Training Loss: 1.284308         Validation Loss: 0.319277
Epoch: 121      Training Loss: 1.282111         Validation Loss: 0.314455
Epoch: 122      Training Loss: 1.283129         Validation Loss: 0.313159
Epoch: 123      Training Loss: 1.284335         Validation Loss: 0.322168
Epoch: 124      Training Loss: 1.278320         Validation Loss: 0.318971
Epoch: 125      Training Loss: 1.281218         Validation Loss: 0.313987
Epoch: 126      Training Loss: 1.279132         Validation Loss: 0.328925
Epoch: 127      Training Loss: 1.279555         Validation Loss: 0.316594
Epoch: 128      Training Loss: 1.273169         Validation Loss: 0.315559
Epoch: 129      Training Loss: 1.277613         Validation Loss: 0.319802
Epoch: 130      Training Loss: 1.280081         Validation Loss: 0.322822
Epoch: 131      Training Loss: 1.281299         Validation Loss: 0.317239
Epoch: 132      Training Loss: 1.280862         Validation Loss: 0.317907
Epoch: 133      Training Loss: 1.280196         Validation Loss: 0.323627
Epoch: 134      Training Loss: 1.278056         Validation Loss: 0.315584
Epoch: 135      Training Loss: 1.271644         Validation Loss: 0.317295
Epoch: 136      Training Loss: 1.276935         Validation Loss: 0.325810
Epoch: 137      Training Loss: 1.279832         Validation Loss: 0.320269
Epoch: 138      Training Loss: 1.276127         Validation Loss: 0.320572
Epoch: 139      Training Loss: 1.276283         Validation Loss: 0.319130
Epoch: 140      Training Loss: 1.274293         Validation Loss: 0.324264
Epoch: 141      Training Loss: 1.276226         Validation Loss: 0.318521
Epoch: 142      Training Loss: 1.273648         Validation Loss: 0.317698
Epoch: 143      Training Loss: 1.280384         Validation Loss: 0.318762
Epoch: 144      Training Loss: 1.271613         Validation Loss: 0.321056
Epoch: 145      Training Loss: 1.279159         Validation Loss: 0.319677
Epoch: 146      Training Loss: 1.277133         Validation Loss: 0.313412
Epoch: 147      Training Loss: 1.273115         Validation Loss: 0.316693
Epoch: 148      Training Loss: 1.276824         Validation Loss: 0.324270
Epoch: 149      Training Loss: 1.271500         Validation Loss: 0.317610
Epoch: 150      Training Loss: 1.274339         Validation Loss: 0.319794
Epoch: 151      Training Loss: 1.276326         Validation Loss: 0.316618
Epoch: 152      Training Loss: 1.274265         Validation Loss: 0.317560
Epoch: 153      Training Loss: 1.273693         Validation Loss: 0.315664
Epoch: 154      Training Loss: 1.271308         Validation Loss: 0.314383
Epoch: 155      Training Loss: 1.275785         Validation Loss: 0.311731
Epoch: 156      Training Loss: 1.269926         Validation Loss: 0.317802
Epoch: 157      Training Loss: 1.272163         Validation Loss: 0.326034
Epoch: 158      Training Loss: 1.272792         Validation Loss: 0.323937
Epoch: 159      Training Loss: 1.270623         Validation Loss: 0.314596
Epoch: 160      Training Loss: 1.274752         Validation Loss: 0.318708
Epoch: 161      Training Loss: 1.269636         Validation Loss: 0.315447
Epoch: 162      Training Loss: 1.268630         Validation Loss: 0.318611
Epoch: 163      Training Loss: 1.269201         Validation Loss: 0.321739
Epoch: 164      Training Loss: 1.268440         Validation Loss: 0.318679
Epoch: 165      Training Loss: 1.267896         Validation Loss: 0.317043
Epoch: 166      Training Loss: 1.268580         Validation Loss: 0.319146
Epoch: 167      Training Loss: 1.275538         Validation Loss: 0.317928
Epoch: 168      Training Loss: 1.268560         Validation Loss: 0.323980
Epoch: 169      Training Loss: 1.268632         Validation Loss: 0.313479
Epoch: 170      Training Loss: 1.264794         Validation Loss: 0.318113
Epoch: 171      Training Loss: 1.270822         Validation Loss: 0.313195
Epoch: 172      Training Loss: 1.267813         Validation Loss: 0.317769
Epoch: 173      Training Loss: 1.270347         Validation Loss: 0.315005
Epoch: 174      Training Loss: 1.266662         Validation Loss: 0.314660
Epoch: 175      Training Loss: 1.268849         Validation Loss: 0.319801
Epoch: 176      Training Loss: 1.271820         Validation Loss: 0.320086
Epoch: 177      Training Loss: 1.273374         Validation Loss: 0.318641
Epoch: 178      Training Loss: 1.265961         Validation Loss: 0.314708
Epoch: 179      Training Loss: 1.271811         Validation Loss: 0.322507
Epoch: 180      Training Loss: 1.263662         Validation Loss: 0.323136
Epoch: 181      Training Loss: 1.269750         Validation Loss: 0.314223
Epoch: 182      Training Loss: 1.269853         Validation Loss: 0.321011
Epoch: 183      Training Loss: 1.267138         Validation Loss: 0.313789
Epoch: 184      Training Loss: 1.271545         Validation Loss: 0.321742
Epoch: 185      Training Loss: 1.268025         Validation Loss: 0.316022
Epoch: 186      Training Loss: 1.272954         Validation Loss: 0.324468
Epoch: 187      Training Loss: 1.267895         Validation Loss: 0.314698
Epoch: 188      Training Loss: 1.266716         Validation Loss: 0.318999
Epoch: 189      Training Loss: 1.263130         Validation Loss: 0.319963
Epoch: 190      Training Loss: 1.270730         Validation Loss: 0.319453
Epoch: 191      Training Loss: 1.265955         Validation Loss: 0.314691
Epoch: 192      Training Loss: 1.267399         Validation Loss: 0.321611
Epoch: 193      Training Loss: 1.264792         Validation Loss: 0.320243
Epoch: 194      Training Loss: 1.262446         Validation Loss: 0.314628
Epoch: 195      Training Loss: 1.262605         Validation Loss: 0.312932
Epoch: 196      Training Loss: 1.265456         Validation Loss: 0.313259
Epoch: 197      Training Loss: 1.269357         Validation Loss: 0.311136
Epoch: 198      Training Loss: 1.262179         Validation Loss: 0.312693
Epoch: 199      Training Loss: 1.266902         Validation Loss: 0.313880
Epoch: 200      Training Loss: 1.265160         Validation Loss: 0.312400
Epoch: 201      Training Loss: 1.266844         Validation Loss: 0.316210
Epoch: 202      Training Loss: 1.264941         Validation Loss: 0.317070
Epoch: 203      Training Loss: 1.267308         Validation Loss: 0.321297
Epoch: 204      Training Loss: 1.265302         Validation Loss: 0.318993
Epoch: 205      Training Loss: 1.265829         Validation Loss: 0.313469
Epoch: 206      Training Loss: 1.261570         Validation Loss: 0.321749
Epoch: 207      Training Loss: 1.266412         Validation Loss: 0.310708
Validation loss decreased (0.311118 --&gt; 0.310708).  Saving model ...
Epoch: 208      Training Loss: 1.266944         Validation Loss: 0.318451
Epoch: 209      Training Loss: 1.265850         Validation Loss: 0.315396
Epoch: 210      Training Loss: 1.264065         Validation Loss: 0.315393
Epoch: 211      Training Loss: 1.258434         Validation Loss: 0.315945
Epoch: 212      Training Loss: 1.262104         Validation Loss: 0.317880
Epoch: 213      Training Loss: 1.266053         Validation Loss: 0.326606
Epoch: 214      Training Loss: 1.264815         Validation Loss: 0.317249
Epoch: 215      Training Loss: 1.265139         Validation Loss: 0.319844
Epoch: 216      Training Loss: 1.266425         Validation Loss: 0.320103
Epoch: 217      Training Loss: 1.265218         Validation Loss: 0.313683
Epoch: 218      Training Loss: 1.261013         Validation Loss: 0.316373
Epoch: 219      Training Loss: 1.262247         Validation Loss: 0.313101
Epoch: 220      Training Loss: 1.264393         Validation Loss: 0.314501
Epoch: 221      Training Loss: 1.264149         Validation Loss: 0.315623
Epoch: 222      Training Loss: 1.259319         Validation Loss: 0.318756
Epoch: 223      Training Loss: 1.258570         Validation Loss: 0.319732
Epoch: 224      Training Loss: 1.259029         Validation Loss: 0.311516
Epoch: 225      Training Loss: 1.266348         Validation Loss: 0.314770
Epoch: 226      Training Loss: 1.259851         Validation Loss: 0.321516
Epoch: 227      Training Loss: 1.262397         Validation Loss: 0.314634
Epoch: 228      Training Loss: 1.258319         Validation Loss: 0.314885
Epoch: 229      Training Loss: 1.257705         Validation Loss: 0.313776
Epoch: 230      Training Loss: 1.265772         Validation Loss: 0.317983
Epoch: 231      Training Loss: 1.256625         Validation Loss: 0.315058
Epoch: 232      Training Loss: 1.259640         Validation Loss: 0.315233
Epoch: 233      Training Loss: 1.257951         Validation Loss: 0.312612
Epoch: 234      Training Loss: 1.259246         Validation Loss: 0.318067
Epoch: 235      Training Loss: 1.254118         Validation Loss: 0.319640
Epoch: 236      Training Loss: 1.261764         Validation Loss: 0.323842
Epoch: 237      Training Loss: 1.257337         Validation Loss: 0.312940
Epoch: 238      Training Loss: 1.261468         Validation Loss: 0.312802
Epoch: 239      Training Loss: 1.256006         Validation Loss: 0.317805
Epoch: 240      Training Loss: 1.259415         Validation Loss: 0.313486
Epoch: 241      Training Loss: 1.256178         Validation Loss: 0.314875
Epoch: 242      Training Loss: 1.256519         Validation Loss: 0.313054
Epoch: 243      Training Loss: 1.255753         Validation Loss: 0.310222
Validation loss decreased (0.310708 --&gt; 0.310222).  Saving model ...
Epoch: 244      Training Loss: 1.258942         Validation Loss: 0.329567
Epoch: 245      Training Loss: 1.258942         Validation Loss: 0.311769
Epoch: 246      Training Loss: 1.262446         Validation Loss: 0.313582
Epoch: 247      Training Loss: 1.261230         Validation Loss: 0.318076
Epoch: 248      Training Loss: 1.261161         Validation Loss: 0.314736
Epoch: 249      Training Loss: 1.259770         Validation Loss: 0.313956
Epoch: 250      Training Loss: 1.256420         Validation Loss: 0.312800
Epoch: 251      Training Loss: 1.262006         Validation Loss: 0.316093
Epoch: 252      Training Loss: 1.259628         Validation Loss: 0.314459
Epoch: 253      Training Loss: 1.255323         Validation Loss: 0.320948
Epoch: 254      Training Loss: 1.251152         Validation Loss: 0.312966
Epoch: 255      Training Loss: 1.263651         Validation Loss: 0.324031
Epoch: 256      Training Loss: 1.258022         Validation Loss: 0.317772
Epoch: 257      Training Loss: 1.260936         Validation Loss: 0.316249
Epoch: 258      Training Loss: 1.257661         Validation Loss: 0.318002
Epoch: 259      Training Loss: 1.253739         Validation Loss: 0.317531
Epoch: 260      Training Loss: 1.259165         Validation Loss: 0.318186
Epoch: 261      Training Loss: 1.255523         Validation Loss: 0.315747
Epoch: 262      Training Loss: 1.260258         Validation Loss: 0.323450
Epoch: 263      Training Loss: 1.256247         Validation Loss: 0.315790
Epoch: 264      Training Loss: 1.256523         Validation Loss: 0.322588
Epoch: 265      Training Loss: 1.256251         Validation Loss: 0.316159
Epoch: 266      Training Loss: 1.254540         Validation Loss: 0.317133
Epoch: 267      Training Loss: 1.256788         Validation Loss: 0.320573
Epoch: 268      Training Loss: 1.261198         Validation Loss: 0.326142
Epoch: 269      Training Loss: 1.255286         Validation Loss: 0.311760
Epoch: 270      Training Loss: 1.256038         Validation Loss: 0.320824
Epoch: 271      Training Loss: 1.252561         Validation Loss: 0.313171
Epoch: 272      Training Loss: 1.257770         Validation Loss: 0.318307
Epoch: 273      Training Loss: 1.254161         Validation Loss: 0.309804
Validation loss decreased (0.310222 --&gt; 0.309804).  Saving model ...
Epoch: 274      Training Loss: 1.256829         Validation Loss: 0.318989
Epoch: 275      Training Loss: 1.264886         Validation Loss: 0.317026
Epoch: 276      Training Loss: 1.250972         Validation Loss: 0.315094
Epoch: 277      Training Loss: 1.255500         Validation Loss: 0.324168
Epoch: 278      Training Loss: 1.253158         Validation Loss: 0.321396
Epoch: 279      Training Loss: 1.258170         Validation Loss: 0.320225
Epoch: 280      Training Loss: 1.258867         Validation Loss: 0.318569
Epoch: 281      Training Loss: 1.254345         Validation Loss: 0.316465
Epoch: 282      Training Loss: 1.255778         Validation Loss: 0.314160
Epoch: 283      Training Loss: 1.254325         Validation Loss: 0.313069
Epoch: 284      Training Loss: 1.253357         Validation Loss: 0.328138
Epoch: 285      Training Loss: 1.251017         Validation Loss: 0.316133
Epoch: 286      Training Loss: 1.252227         Validation Loss: 0.316984
Epoch: 287      Training Loss: 1.253182         Validation Loss: 0.313943
Epoch: 288      Training Loss: 1.250671         Validation Loss: 0.318114
Epoch: 289      Training Loss: 1.255845         Validation Loss: 0.316618
Epoch: 290      Training Loss: 1.255237         Validation Loss: 0.312792
Epoch: 291      Training Loss: 1.262059         Validation Loss: 0.314828
Epoch: 292      Training Loss: 1.255877         Validation Loss: 0.318905
Epoch: 293      Training Loss: 1.254416         Validation Loss: 0.314216
Epoch: 294      Training Loss: 1.253497         Validation Loss: 0.314790
Epoch: 295      Training Loss: 1.255368         Validation Loss: 0.321991
Epoch: 296      Training Loss: 1.257793         Validation Loss: 0.317706
Epoch: 297      Training Loss: 1.251250         Validation Loss: 0.316808
Epoch: 298      Training Loss: 1.252172         Validation Loss: 0.315334
Epoch: 299      Training Loss: 1.251001         Validation Loss: 0.314154
Epoch: 300      Training Loss: 1.252786         Validation Loss: 0.320209
Epoch: 301      Training Loss: 1.257268         Validation Loss: 0.319915
Elapsed: 1:15:46.335776
</pre>
<p>It seems to be improving, but really slowly.</p>
<div class="highlight">
<pre><span></span>test(model_2)
</pre></div>
<pre class="example" id="org8ac1b11">
Test Loss: 1.307058

Test Accuracy of airplane: 57% (572/1000)
Test Accuracy of automobile: 73% (735/1000)
Test Accuracy of  bird: 26% (266/1000)
Test Accuracy of   cat: 35% (357/1000)
Test Accuracy of  deer: 52% (525/1000)
Test Accuracy of   dog: 19% (193/1000)
Test Accuracy of  frog: 79% (798/1000)
Test Accuracy of horse: 59% (598/1000)
Test Accuracy of  ship: 81% (810/1000)
Test Accuracy of truck: 49% (494/1000)

Test Accuracy (Overall): 53% (5348/10000)
</pre>
<div class="highlight">
<pre><span></span>model_2 = CNN()
model_2.to(device)
start = datetime.now()
model_2.load_state_dict(torch.load(outcome["hyperparameters_file"],
                                   map_location=device))
outcome_2 = train_and_pickle(model_2, epochs=200, model_number=2)
outcome = update_outcome(outcome, outcome_2)
print("Elapsed: {}".format(datetime.now() - start))
model_2.load_state_dict(torch.load(outcome["hyperparameters_file"],
                                   map_location=device))

test(model_2)
</pre></div>
<pre class="example" id="orgffadd67">
Epoch: 202      Training Loss: 1.256388         Validation Loss: 0.313784
Validation loss decreased (inf --&gt; 0.313784).  Saving model ...
Epoch: 203      Training Loss: 1.258825         Validation Loss: 0.317360
Epoch: 204      Training Loss: 1.256599         Validation Loss: 0.316243
Epoch: 205      Training Loss: 1.253339         Validation Loss: 0.322061
Epoch: 206      Training Loss: 1.260164         Validation Loss: 0.319589
Epoch: 207      Training Loss: 1.252303         Validation Loss: 0.318219
Epoch: 208      Training Loss: 1.257676         Validation Loss: 0.326530
Epoch: 209      Training Loss: 1.258256         Validation Loss: 0.322288
Epoch: 210      Training Loss: 1.257436         Validation Loss: 0.316848
Epoch: 211      Training Loss: 1.256364         Validation Loss: 0.313047
Validation loss decreased (0.313784 --&gt; 0.313047).  Saving model ...
Epoch: 212      Training Loss: 1.259785         Validation Loss: 0.321005
Epoch: 213      Training Loss: 1.254453         Validation Loss: 0.307325
Validation loss decreased (0.313047 --&gt; 0.307325).  Saving model ...
Epoch: 214      Training Loss: 1.254806         Validation Loss: 0.320826
Epoch: 215      Training Loss: 1.252779         Validation Loss: 0.320929
Epoch: 216      Training Loss: 1.252038         Validation Loss: 0.320515
Epoch: 217      Training Loss: 1.252444         Validation Loss: 0.317522
Epoch: 218      Training Loss: 1.254665         Validation Loss: 0.313467
Epoch: 219      Training Loss: 1.255900         Validation Loss: 0.315710
Epoch: 220      Training Loss: 1.252430         Validation Loss: 0.321523
Epoch: 221      Training Loss: 1.256561         Validation Loss: 0.310884
Epoch: 222      Training Loss: 1.255160         Validation Loss: 0.309861
Epoch: 223      Training Loss: 1.254754         Validation Loss: 0.319757
Epoch: 224      Training Loss: 1.255497         Validation Loss: 0.318309
Epoch: 225      Training Loss: 1.260697         Validation Loss: 0.314599
Epoch: 226      Training Loss: 1.253136         Validation Loss: 0.318721
Epoch: 227      Training Loss: 1.257839         Validation Loss: 0.312620
Epoch: 228      Training Loss: 1.248965         Validation Loss: 0.320385
Epoch: 229      Training Loss: 1.251453         Validation Loss: 0.318191
Epoch: 230      Training Loss: 1.252814         Validation Loss: 0.324980
Epoch: 231      Training Loss: 1.256732         Validation Loss: 0.318312
Epoch: 232      Training Loss: 1.251452         Validation Loss: 0.319930
Epoch: 233      Training Loss: 1.251726         Validation Loss: 0.311095
Epoch: 234      Training Loss: 1.250112         Validation Loss: 0.318118
Epoch: 235      Training Loss: 1.255064         Validation Loss: 0.311329
Epoch: 236      Training Loss: 1.250156         Validation Loss: 0.322847
Epoch: 237      Training Loss: 1.249897         Validation Loss: 0.310835
Epoch: 238      Training Loss: 1.251495         Validation Loss: 0.322079
Epoch: 239      Training Loss: 1.247715         Validation Loss: 0.321563
Epoch: 240      Training Loss: 1.248373         Validation Loss: 0.328171
Epoch: 241      Training Loss: 1.250492         Validation Loss: 0.321683
Epoch: 242      Training Loss: 1.255231         Validation Loss: 0.313710
Epoch: 243      Training Loss: 1.247742         Validation Loss: 0.318332
Epoch: 244      Training Loss: 1.251414         Validation Loss: 0.315995
Epoch: 245      Training Loss: 1.258454         Validation Loss: 0.317433
Epoch: 246      Training Loss: 1.253335         Validation Loss: 0.317605
Epoch: 247      Training Loss: 1.253148         Validation Loss: 0.316049
Epoch: 248      Training Loss: 1.251510         Validation Loss: 0.312951
Epoch: 249      Training Loss: 1.251977         Validation Loss: 0.321403
Epoch: 250      Training Loss: 1.256146         Validation Loss: 0.320409
Epoch: 251      Training Loss: 1.248189         Validation Loss: 0.317272
Epoch: 252      Training Loss: 1.254679         Validation Loss: 0.317682
Epoch: 253      Training Loss: 1.253137         Validation Loss: 0.317845
Epoch: 254      Training Loss: 1.258417         Validation Loss: 0.317278
Epoch: 255      Training Loss: 1.253359         Validation Loss: 0.319818
Epoch: 256      Training Loss: 1.247390         Validation Loss: 0.320857
Epoch: 257      Training Loss: 1.255359         Validation Loss: 0.317702
Epoch: 258      Training Loss: 1.247608         Validation Loss: 0.316204
Epoch: 259      Training Loss: 1.249561         Validation Loss: 0.312899
Epoch: 260      Training Loss: 1.248591         Validation Loss: 0.322027
Epoch: 261      Training Loss: 1.248232         Validation Loss: 0.316189
Epoch: 262      Training Loss: 1.252761         Validation Loss: 0.317912
Epoch: 263      Training Loss: 1.246621         Validation Loss: 0.317565
Epoch: 264      Training Loss: 1.249730         Validation Loss: 0.321344
Epoch: 265      Training Loss: 1.253313         Validation Loss: 0.317789
Epoch: 266      Training Loss: 1.250943         Validation Loss: 0.319828
Epoch: 267      Training Loss: 1.248345         Validation Loss: 0.319927
Epoch: 268      Training Loss: 1.248811         Validation Loss: 0.316677
Epoch: 269      Training Loss: 1.250617         Validation Loss: 0.311661
Epoch: 270      Training Loss: 1.250927         Validation Loss: 0.324976
Epoch: 271      Training Loss: 1.246129         Validation Loss: 0.321428
Epoch: 272      Training Loss: 1.247270         Validation Loss: 0.313739
Epoch: 273      Training Loss: 1.252439         Validation Loss: 0.314271
Epoch: 274      Training Loss: 1.249031         Validation Loss: 0.315256
Epoch: 275      Training Loss: 1.248926         Validation Loss: 0.318519
Epoch: 276      Training Loss: 1.253851         Validation Loss: 0.317292
Epoch: 277      Training Loss: 1.248241         Validation Loss: 0.312578
Epoch: 278      Training Loss: 1.246958         Validation Loss: 0.317017
Epoch: 279      Training Loss: 1.247038         Validation Loss: 0.317870
Epoch: 280      Training Loss: 1.247711         Validation Loss: 0.320040
Epoch: 281      Training Loss: 1.250939         Validation Loss: 0.319092
Epoch: 282      Training Loss: 1.250168         Validation Loss: 0.318878
Epoch: 283      Training Loss: 1.249140         Validation Loss: 0.323233
Epoch: 284      Training Loss: 1.247192         Validation Loss: 0.320423
Epoch: 285      Training Loss: 1.248637         Validation Loss: 0.321254
Epoch: 286      Training Loss: 1.246468         Validation Loss: 0.322253
Epoch: 287      Training Loss: 1.247990         Validation Loss: 0.316660
Epoch: 288      Training Loss: 1.245704         Validation Loss: 0.327530
Epoch: 289      Training Loss: 1.244317         Validation Loss: 0.316667
Epoch: 290      Training Loss: 1.247457         Validation Loss: 0.316587
Epoch: 291      Training Loss: 1.244423         Validation Loss: 0.323431
Epoch: 292      Training Loss: 1.245140         Validation Loss: 0.319670
Epoch: 293      Training Loss: 1.247903         Validation Loss: 0.315965
Epoch: 294      Training Loss: 1.248071         Validation Loss: 0.314560
Epoch: 295      Training Loss: 1.244779         Validation Loss: 0.321430
Epoch: 296      Training Loss: 1.250301         Validation Loss: 0.314018
Epoch: 297      Training Loss: 1.251302         Validation Loss: 0.316015
Epoch: 298      Training Loss: 1.253560         Validation Loss: 0.315506
Epoch: 299      Training Loss: 1.246812         Validation Loss: 0.323061
Epoch: 300      Training Loss: 1.248937         Validation Loss: 0.315299
Epoch: 301      Training Loss: 1.248918         Validation Loss: 0.318701
Epoch: 302      Training Loss: 1.247325         Validation Loss: 0.315778
Epoch: 303      Training Loss: 1.241974         Validation Loss: 0.315274
Epoch: 304      Training Loss: 1.250347         Validation Loss: 0.315380
Epoch: 305      Training Loss: 1.244912         Validation Loss: 0.316511
Epoch: 306      Training Loss: 1.247815         Validation Loss: 0.317746
Epoch: 307      Training Loss: 1.250566         Validation Loss: 0.314758
Epoch: 308      Training Loss: 1.249454         Validation Loss: 0.317377
Epoch: 309      Training Loss: 1.249325         Validation Loss: 0.316275
Epoch: 310      Training Loss: 1.248658         Validation Loss: 0.319433
Epoch: 311      Training Loss: 1.244979         Validation Loss: 0.312409
Epoch: 312      Training Loss: 1.250389         Validation Loss: 0.319627
Epoch: 313      Training Loss: 1.245450         Validation Loss: 0.318461
Epoch: 314      Training Loss: 1.247308         Validation Loss: 0.318554
Epoch: 315      Training Loss: 1.247195         Validation Loss: 0.316582
Epoch: 316      Training Loss: 1.244136         Validation Loss: 0.318103
Epoch: 317      Training Loss: 1.249054         Validation Loss: 0.319848
Epoch: 318      Training Loss: 1.248777         Validation Loss: 0.323786
Epoch: 319      Training Loss: 1.247198         Validation Loss: 0.315047
Epoch: 320      Training Loss: 1.251294         Validation Loss: 0.318657
Epoch: 321      Training Loss: 1.249177         Validation Loss: 0.337516
Epoch: 322      Training Loss: 1.247499         Validation Loss: 0.326684
Epoch: 323      Training Loss: 1.246539         Validation Loss: 0.319658
Epoch: 324      Training Loss: 1.248925         Validation Loss: 0.313511
Epoch: 325      Training Loss: 1.243196         Validation Loss: 0.315549
Epoch: 326      Training Loss: 1.244999         Validation Loss: 0.321060
Epoch: 327      Training Loss: 1.248777         Validation Loss: 0.317293
Epoch: 328      Training Loss: 1.248694         Validation Loss: 0.317218
Epoch: 329      Training Loss: 1.251560         Validation Loss: 0.317921
Epoch: 330      Training Loss: 1.252284         Validation Loss: 0.317201
Epoch: 331      Training Loss: 1.246083         Validation Loss: 0.321029
Epoch: 332      Training Loss: 1.244893         Validation Loss: 0.316990
Epoch: 333      Training Loss: 1.240543         Validation Loss: 0.317590
Epoch: 334      Training Loss: 1.246393         Validation Loss: 0.325721
Epoch: 335      Training Loss: 1.248191         Validation Loss: 0.320632
Epoch: 336      Training Loss: 1.241560         Validation Loss: 0.324130
Epoch: 337      Training Loss: 1.243119         Validation Loss: 0.318852
Epoch: 338      Training Loss: 1.242660         Validation Loss: 0.319926
Epoch: 339      Training Loss: 1.249028         Validation Loss: 0.315266
Epoch: 340      Training Loss: 1.244741         Validation Loss: 0.324272
Epoch: 341      Training Loss: 1.244523         Validation Loss: 0.318710
Epoch: 342      Training Loss: 1.241070         Validation Loss: 0.319939
Epoch: 343      Training Loss: 1.244101         Validation Loss: 0.321822
Epoch: 344      Training Loss: 1.239239         Validation Loss: 0.315630
Epoch: 345      Training Loss: 1.245509         Validation Loss: 0.318808
Epoch: 346      Training Loss: 1.245012         Validation Loss: 0.320597
Epoch: 347      Training Loss: 1.251397         Validation Loss: 0.318575
Epoch: 348      Training Loss: 1.240546         Validation Loss: 0.313607
Epoch: 349      Training Loss: 1.245582         Validation Loss: 0.317309
Epoch: 350      Training Loss: 1.240588         Validation Loss: 0.319662
Epoch: 351      Training Loss: 1.241194         Validation Loss: 0.316204
Epoch: 352      Training Loss: 1.243081         Validation Loss: 0.321423
Epoch: 353      Training Loss: 1.244287         Validation Loss: 0.316278
Epoch: 354      Training Loss: 1.248997         Validation Loss: 0.322080
Epoch: 355      Training Loss: 1.243133         Validation Loss: 0.314357
Epoch: 356      Training Loss: 1.240463         Validation Loss: 0.317619
Epoch: 357      Training Loss: 1.249085         Validation Loss: 0.317623
Epoch: 358      Training Loss: 1.244508         Validation Loss: 0.316843
Epoch: 359      Training Loss: 1.252762         Validation Loss: 0.317262
Epoch: 360      Training Loss: 1.246585         Validation Loss: 0.321501
Epoch: 361      Training Loss: 1.240622         Validation Loss: 0.318065
Epoch: 362      Training Loss: 1.246144         Validation Loss: 0.317386
Epoch: 363      Training Loss: 1.246127         Validation Loss: 0.314560
Epoch: 364      Training Loss: 1.244285         Validation Loss: 0.318059
Epoch: 365      Training Loss: 1.244826         Validation Loss: 0.317295
Epoch: 366      Training Loss: 1.244527         Validation Loss: 0.313897
Epoch: 367      Training Loss: 1.244683         Validation Loss: 0.325274
Epoch: 368      Training Loss: 1.245969         Validation Loss: 0.325050
Epoch: 369      Training Loss: 1.245889         Validation Loss: 0.317678
Epoch: 370      Training Loss: 1.240173         Validation Loss: 0.321540
Epoch: 371      Training Loss: 1.244970         Validation Loss: 0.318374
Epoch: 372      Training Loss: 1.242400         Validation Loss: 0.322875
Epoch: 373      Training Loss: 1.245613         Validation Loss: 0.319608
Epoch: 374      Training Loss: 1.243773         Validation Loss: 0.322040
Epoch: 375      Training Loss: 1.243070         Validation Loss: 0.320554
Epoch: 376      Training Loss: 1.245695         Validation Loss: 0.321315
Epoch: 377      Training Loss: 1.245310         Validation Loss: 0.321394
Epoch: 378      Training Loss: 1.240203         Validation Loss: 0.316470
Epoch: 379      Training Loss: 1.245251         Validation Loss: 0.317234
Epoch: 380      Training Loss: 1.250027         Validation Loss: 0.330051
Epoch: 381      Training Loss: 1.243686         Validation Loss: 0.322005
Epoch: 382      Training Loss: 1.243251         Validation Loss: 0.315280
Epoch: 383      Training Loss: 1.243953         Validation Loss: 0.326072
Epoch: 384      Training Loss: 1.245808         Validation Loss: 0.316741
Epoch: 385      Training Loss: 1.242827         Validation Loss: 0.315943
Epoch: 386      Training Loss: 1.244012         Validation Loss: 0.310488
Epoch: 387      Training Loss: 1.245015         Validation Loss: 0.314874
Epoch: 388      Training Loss: 1.244292         Validation Loss: 0.317309
Epoch: 389      Training Loss: 1.250823         Validation Loss: 0.313929
Epoch: 390      Training Loss: 1.248937         Validation Loss: 0.314966
Epoch: 391      Training Loss: 1.249134         Validation Loss: 0.321290
Epoch: 392      Training Loss: 1.246164         Validation Loss: 0.316047
Epoch: 393      Training Loss: 1.249995         Validation Loss: 0.318678
Epoch: 394      Training Loss: 1.240377         Validation Loss: 0.327256
Epoch: 395      Training Loss: 1.247659         Validation Loss: 0.317254
Epoch: 396      Training Loss: 1.238285         Validation Loss: 0.314723
Epoch: 397      Training Loss: 1.245013         Validation Loss: 0.324809
Epoch: 398      Training Loss: 1.247650         Validation Loss: 0.330501
Epoch: 399      Training Loss: 1.250368         Validation Loss: 0.318667
Epoch: 400      Training Loss: 1.246211         Validation Loss: 0.323798
Epoch: 401      Training Loss: 1.239634         Validation Loss: 0.322877
Epoch: 402      Training Loss: 1.248236         Validation Loss: 0.321464
Elapsed: 1:17:57.592411
Test Loss: 1.336450

Test Accuracy of airplane: 55% (553/1000)
Test Accuracy of automobile: 58% (583/1000)
Test Accuracy of  bird: 23% (234/1000)
Test Accuracy of   cat: 30% (307/1000)
Test Accuracy of  deer: 36% (365/1000)
Test Accuracy of   dog: 25% (257/1000)
Test Accuracy of  frog: 88% (880/1000)
Test Accuracy of horse: 69% (694/1000)
Test Accuracy of  ship: 76% (766/1000)
Test Accuracy of truck: 61% (611/1000)

Test Accuracy (Overall): 52% (5250/10000)
</pre>
<div class="highlight">
<pre><span></span>model_2 = CNN()
model_2.to(device)
start = datetime.now()
model_2.load_state_dict(torch.load(outcome["hyperparameters_file"],
                                   map_location=device))
outcome_2 = train_and_pickle(model_2, epochs=200, model_number=2)
outcome = update_outcome(outcome, outcome_2)
print("Elapsed: {}".format(datetime.now() - start))
model_2.load_state_dict(torch.load(outcome["hyperparameters_file"],
                                   map_location=device))
test(model_2)
</pre></div>
<pre class="example" id="org287493a">
Epoch: 400      Training Loss: 1.085763         Validation Loss: 0.282825
Validation loss decreased (inf --&gt; 0.282825).  Saving model ...
Epoch: 401      Training Loss: 1.094224         Validation Loss: 0.282336
Validation loss decreased (0.282825 --&gt; 0.282336).  Saving model ...
Epoch: 402      Training Loss: 1.090027         Validation Loss: 0.283988
Epoch: 403      Training Loss: 1.088251         Validation Loss: 0.282374
Epoch: 404      Training Loss: 1.088617         Validation Loss: 0.280398
Validation loss decreased (0.282336 --&gt; 0.280398).  Saving model ...
Epoch: 405      Training Loss: 1.092081         Validation Loss: 0.280428
Epoch: 406      Training Loss: 1.091815         Validation Loss: 0.278766
Validation loss decreased (0.280398 --&gt; 0.278766).  Saving model ...
Epoch: 407      Training Loss: 1.088024         Validation Loss: 0.281447
Epoch: 408      Training Loss: 1.094500         Validation Loss: 0.283386
Epoch: 409      Training Loss: 1.089597         Validation Loss: 0.281148
Epoch: 410      Training Loss: 1.091652         Validation Loss: 0.283893
Epoch: 411      Training Loss: 1.087357         Validation Loss: 0.281366
Epoch: 412      Training Loss: 1.091122         Validation Loss: 0.286320
Epoch: 413      Training Loss: 1.089693         Validation Loss: 0.282684
Epoch: 414      Training Loss: 1.088109         Validation Loss: 0.284077
Epoch: 415      Training Loss: 1.087701         Validation Loss: 0.280002
Epoch: 416      Training Loss: 1.085328         Validation Loss: 0.282377
Epoch: 417      Training Loss: 1.089087         Validation Loss: 0.282623
Epoch: 418      Training Loss: 1.086825         Validation Loss: 0.278291
Validation loss decreased (0.278766 --&gt; 0.278291).  Saving model ...
Epoch: 419      Training Loss: 1.086601         Validation Loss: 0.282585
Epoch: 420      Training Loss: 1.082824         Validation Loss: 0.282660
Epoch: 421      Training Loss: 1.089363         Validation Loss: 0.281838
Epoch: 422      Training Loss: 1.087070         Validation Loss: 0.279197
Epoch: 423      Training Loss: 1.084032         Validation Loss: 0.281605
Epoch: 424      Training Loss: 1.087307         Validation Loss: 0.281069
Epoch: 425      Training Loss: 1.090275         Validation Loss: 0.286235
Epoch: 426      Training Loss: 1.084863         Validation Loss: 0.286024
Epoch: 427      Training Loss: 1.086919         Validation Loss: 0.283765
Epoch: 428      Training Loss: 1.087431         Validation Loss: 0.287237
Epoch: 429      Training Loss: 1.084115         Validation Loss: 0.279592
Epoch: 430      Training Loss: 1.093677         Validation Loss: 0.283081
Epoch: 431      Training Loss: 1.090348         Validation Loss: 0.281837
Epoch: 432      Training Loss: 1.088213         Validation Loss: 0.277247
Validation loss decreased (0.278291 --&gt; 0.277247).  Saving model ...
Epoch: 433      Training Loss: 1.089605         Validation Loss: 0.278821
Epoch: 434      Training Loss: 1.085192         Validation Loss: 0.276951
Validation loss decreased (0.277247 --&gt; 0.276951).  Saving model ...
Epoch: 435      Training Loss: 1.085776         Validation Loss: 0.281023
Epoch: 436      Training Loss: 1.086465         Validation Loss: 0.283929
Epoch: 437      Training Loss: 1.087985         Validation Loss: 0.282887
Epoch: 438      Training Loss: 1.086791         Validation Loss: 0.278656
Epoch: 439      Training Loss: 1.087146         Validation Loss: 0.284559
Epoch: 440      Training Loss: 1.086268         Validation Loss: 0.284008
Epoch: 441      Training Loss: 1.074737         Validation Loss: 0.282008
Epoch: 442      Training Loss: 1.090836         Validation Loss: 0.280691
Epoch: 443      Training Loss: 1.086444         Validation Loss: 0.283169
Epoch: 444      Training Loss: 1.083751         Validation Loss: 0.277424
Epoch: 445      Training Loss: 1.084478         Validation Loss: 0.282735
Epoch: 446      Training Loss: 1.087853         Validation Loss: 0.279917
Epoch: 447      Training Loss: 1.087905         Validation Loss: 0.278547
Epoch: 448      Training Loss: 1.083655         Validation Loss: 0.284014
Epoch: 449      Training Loss: 1.085713         Validation Loss: 0.284066
Epoch: 450      Training Loss: 1.082967         Validation Loss: 0.283472
Epoch: 451      Training Loss: 1.087737         Validation Loss: 0.281544
Epoch: 452      Training Loss: 1.084897         Validation Loss: 0.283131
Epoch: 453      Training Loss: 1.085416         Validation Loss: 0.283956
Epoch: 454      Training Loss: 1.079511         Validation Loss: 0.284032
Epoch: 455      Training Loss: 1.081187         Validation Loss: 0.277546
Epoch: 456      Training Loss: 1.081564         Validation Loss: 0.283062
Epoch: 457      Training Loss: 1.090161         Validation Loss: 0.277227
Epoch: 458      Training Loss: 1.082555         Validation Loss: 0.281654
Epoch: 459      Training Loss: 1.084783         Validation Loss: 0.282357
Epoch: 460      Training Loss: 1.086960         Validation Loss: 0.283228
Epoch: 461      Training Loss: 1.088104         Validation Loss: 0.283043
Epoch: 462      Training Loss: 1.079098         Validation Loss: 0.280849
Epoch: 463      Training Loss: 1.077743         Validation Loss: 0.279460
Epoch: 464      Training Loss: 1.080590         Validation Loss: 0.281254
Epoch: 465      Training Loss: 1.083514         Validation Loss: 0.280558
Epoch: 466      Training Loss: 1.089853         Validation Loss: 0.277356
Epoch: 467      Training Loss: 1.080071         Validation Loss: 0.279764
Epoch: 468      Training Loss: 1.083149         Validation Loss: 0.280320
Epoch: 469      Training Loss: 1.086154         Validation Loss: 0.278509
Epoch: 470      Training Loss: 1.075413         Validation Loss: 0.277589
Epoch: 471      Training Loss: 1.090838         Validation Loss: 0.284972
Epoch: 472      Training Loss: 1.083023         Validation Loss: 0.280417
Epoch: 473      Training Loss: 1.078518         Validation Loss: 0.279890
Epoch: 474      Training Loss: 1.081342         Validation Loss: 0.282047
Epoch: 475      Training Loss: 1.082641         Validation Loss: 0.277632
Epoch: 476      Training Loss: 1.077731         Validation Loss: 0.282896
Epoch: 477      Training Loss: 1.074824         Validation Loss: 0.278524
Epoch: 478      Training Loss: 1.081040         Validation Loss: 0.282670
Epoch: 479      Training Loss: 1.078880         Validation Loss: 0.281313
Epoch: 480      Training Loss: 1.077215         Validation Loss: 0.280679
Epoch: 481      Training Loss: 1.081206         Validation Loss: 0.278332
Epoch: 482      Training Loss: 1.084885         Validation Loss: 0.278158
Epoch: 483      Training Loss: 1.075072         Validation Loss: 0.277820
Epoch: 484      Training Loss: 1.081011         Validation Loss: 0.284402
Epoch: 485      Training Loss: 1.081351         Validation Loss: 0.281961
Epoch: 486      Training Loss: 1.083745         Validation Loss: 0.279679
Epoch: 487      Training Loss: 1.081245         Validation Loss: 0.280318
Epoch: 488      Training Loss: 1.075557         Validation Loss: 0.278577
Epoch: 489      Training Loss: 1.079408         Validation Loss: 0.278910
Epoch: 490      Training Loss: 1.082496         Validation Loss: 0.280904
Epoch: 491      Training Loss: 1.078611         Validation Loss: 0.277847
Epoch: 492      Training Loss: 1.087269         Validation Loss: 0.280784
Epoch: 493      Training Loss: 1.080308         Validation Loss: 0.280509
Epoch: 494      Training Loss: 1.079977         Validation Loss: 0.280467
Epoch: 495      Training Loss: 1.071035         Validation Loss: 0.277071
Epoch: 496      Training Loss: 1.081492         Validation Loss: 0.279537
Epoch: 497      Training Loss: 1.076939         Validation Loss: 0.277763
Epoch: 498      Training Loss: 1.076834         Validation Loss: 0.277170
Epoch: 499      Training Loss: 1.077066         Validation Loss: 0.281241
Epoch: 500      Training Loss: 1.078915         Validation Loss: 0.278007
Elapsed: 1:41:06.408824
</pre>
<div class="highlight">
<pre><span></span>test(model_2)
</pre></div>
<pre class="example" id="org79a937a">
Test Loss: 1.336450

Test Accuracy of airplane: 55% (553/1000)
Test Accuracy of automobile: 58% (583/1000)
Test Accuracy of  bird: 23% (234/1000)
Test Accuracy of   cat: 30% (307/1000)
Test Accuracy of  deer: 36% (365/1000)
Test Accuracy of   dog: 25% (257/1000)
Test Accuracy of  frog: 88% (880/1000)
Test Accuracy of horse: 69% (694/1000)
Test Accuracy of  ship: 76% (766/1000)
Test Accuracy of truck: 61% (611/1000)

Test Accuracy (Overall): 52% (5250/10000)
</pre>
<div class="highlight">
<pre><span></span>figure, axe = pyplot.subplots()
figure.suptitle("Filter Size 5 Training/Validation Loss", weight="bold")
x = numpy.arange(len(training_loss_2))
axe.plot(x, training_loss_2, label="Training")
axe.plot(x, validation_loss_2, label="Validation")
axe.set_xlabel("Epoch")
axe.set_ylabel("Cross-Entropy Loss")
labeled = False
for improvement in improvements_2:
    label = "_" if labeled else "Model Improved"
    axe.axvline(improvement, color='r', linestyle='--', label=label)
    labeled = True
legend = axe.legend()
</pre></div>
<div class="figure" id="org28d8990">
<p><img alt="model_2_training.png" src="posts/nano/cnn/cifar-10/model_2_training.png"></p>
</div>
<p>It looks like the model from the Pytorch tutorial starts to overfit after the 15th epoch (by count, not index).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org78ac14a">
<h3 id="org78ac14a">Udacity Model</h3>
<div class="outline-text-3" id="text-org78ac14a">
<div class="highlight">
<pre><span></span>model_1 = CNN(3)
model_1.to(device)
filename_1, training_loss_1, validation_loss_1, improvements_1  = train(model_1, epochs=30, model_number=1)
</pre></div>
<pre class="example" id="org62fd96e">
Epoch: 1        Training Loss: 1.764122         Validation Loss: 0.408952
Validation loss decreased (inf --&gt; 0.408952).  Saving model ...
Epoch: 2        Training Loss: 1.586364         Validation Loss: 0.383241
Validation loss decreased (0.408952 --&gt; 0.383241).  Saving model ...
Epoch: 3        Training Loss: 1.519929         Validation Loss: 0.371740
Validation loss decreased (0.383241 --&gt; 0.371740).  Saving model ...
Epoch: 4        Training Loss: 1.488349         Validation Loss: 0.362653
Validation loss decreased (0.371740 --&gt; 0.362653).  Saving model ...
Epoch: 5        Training Loss: 1.455125         Validation Loss: 0.358624
Validation loss decreased (0.362653 --&gt; 0.358624).  Saving model ...
Epoch: 6        Training Loss: 1.431836         Validation Loss: 0.353852
Validation loss decreased (0.358624 --&gt; 0.353852).  Saving model ...
Epoch: 7        Training Loss: 1.406383         Validation Loss: 0.351643
Validation loss decreased (0.353852 --&gt; 0.351643).  Saving model ...
Epoch: 8        Training Loss: 1.396167         Validation Loss: 0.342488
Validation loss decreased (0.351643 --&gt; 0.342488).  Saving model ...
Epoch: 9        Training Loss: 1.374800         Validation Loss: 0.344513
Epoch: 10       Training Loss: 1.365321         Validation Loss: 0.339705
Validation loss decreased (0.342488 --&gt; 0.339705).  Saving model ...
Epoch: 11       Training Loss: 1.350646         Validation Loss: 0.334100
Validation loss decreased (0.339705 --&gt; 0.334100).  Saving model ...
Epoch: 12       Training Loss: 1.336463         Validation Loss: 0.342720
Epoch: 13       Training Loss: 1.327740         Validation Loss: 0.329569
Validation loss decreased (0.334100 --&gt; 0.329569).  Saving model ...
Epoch: 14       Training Loss: 1.318054         Validation Loss: 0.330011
Epoch: 15       Training Loss: 1.318000         Validation Loss: 0.331113
Epoch: 16       Training Loss: 1.307698         Validation Loss: 0.325177
Validation loss decreased (0.329569 --&gt; 0.325177).  Saving model ...
Epoch: 17       Training Loss: 1.300564         Validation Loss: 0.324221
Validation loss decreased (0.325177 --&gt; 0.324221).  Saving model ...
Epoch: 18       Training Loss: 1.298909         Validation Loss: 0.323380
Validation loss decreased (0.324221 --&gt; 0.323380).  Saving model ...
Epoch: 19       Training Loss: 1.284629         Validation Loss: 0.317989
Validation loss decreased (0.323380 --&gt; 0.317989).  Saving model ...
Epoch: 20       Training Loss: 1.284566         Validation Loss: 0.316856
Validation loss decreased (0.317989 --&gt; 0.316856).  Saving model ...
Epoch: 21       Training Loss: 1.276280         Validation Loss: 0.320113
Epoch: 22       Training Loss: 1.274713         Validation Loss: 0.320777
Epoch: 23       Training Loss: 1.267952         Validation Loss: 0.317876
Epoch: 24       Training Loss: 1.270328         Validation Loss: 0.311076
Validation loss decreased (0.316856 --&gt; 0.311076).  Saving model ...
Epoch: 25       Training Loss: 1.258179         Validation Loss: 0.313508
Epoch: 26       Training Loss: 1.253091         Validation Loss: 0.314421
Epoch: 27       Training Loss: 1.254100         Validation Loss: 0.312774
Epoch: 28       Training Loss: 1.244802         Validation Loss: 0.311225
Epoch: 29       Training Loss: 1.242637         Validation Loss: 0.310512
Validation loss decreased (0.311076 --&gt; 0.310512).  Saving model ...
Epoch: 30       Training Loss: 1.245316         Validation Loss: 0.311031
</pre>
<div class="highlight">
<pre><span></span>figure, axe = pyplot.subplots()
figure.suptitle("Filter Size 3 Training/Validation Loss", weight="bold")
x = numpy.arange(len(training_loss_1))
axe.plot(x, training_loss_1, label="Training")
axe.plot(x, validation_loss_1, label="Validation")
axe.set_xlabel("Epoch")
axe.set_ylabel("Cross-Entropy Loss")
labeled = False
for improvement in improvements_1:
    label = "_" if labeled else "Model Improved"
    axe.axvline(improvement, color='r', linestyle='--', label=label)
    labeled = True
legend = axe.legend()
</pre></div>
<div class="figure" id="org5181cde">
<p><img alt="model_1_training.png" src="posts/nano/cnn/cifar-10/model_1_training.png"></p>
</div>
<p>So it looks like there isn't much difference between the models, but the filter size of 3 did slightly better.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgccd69e8">
<h2 id="orgccd69e8">Load the Model with the Lowest Validation Loss</h2>
<div class="outline-text-2" id="text-orgccd69e8">
<div class="highlight">
<pre><span></span>model_2.load_state_dict(torch.load(outcome["hyperparameters_file"]))
best_model = model_2
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org2844828">
<h2 id="org2844828">Test the Trained Network</h2>
<div class="outline-text-2" id="text-org2844828">
<p>Test your trained model on previously unseen data! A "good" result will be a CNN that gets around 70% (or more, try your best!) accuracy on these test images.</p>
<div class="highlight">
<pre><span></span>def test(best_model):
    criterion = nn.CrossEntropyLoss()
    # track test loss
    test_loss = 0.0
    class_correct = list(0. for i in range(10))
    class_total = list(0. for i in range(10))

    best_model.to(device)
    best_model.eval()
    # iterate over test data
    for data, target in test_loader:
        # move tensors to GPU if CUDA is available
        data, target = data.to(device), target.to(device)
        # forward pass: compute predicted outputs by passing inputs to the model
        output = best_model(data)
        # calculate the batch loss
        loss = criterion(output, target)
        # update test loss 
        test_loss += loss.item() * data.size(0)
        # convert output probabilities to predicted class
        _, pred = torch.max(output, 1)    
        # compare predictions to true label
        correct_tensor = pred.eq(target.data.view_as(pred))
        correct = (
            numpy.squeeze(correct_tensor.numpy())
            if not train_on_gpu
            else numpy.squeeze(correct_tensor.cpu().numpy()))
        # calculate test accuracy for each object class
        for i in range(BATCH_SIZE):
            label = target.data[i]
            class_correct[label] += correct[i].item()
            class_total[label] += 1

    # average test loss
    test_loss = test_loss/len(test_loader.dataset)
    print('Test Loss: {:.6f}\n'.format(test_loss))

    for i in range(10):
        if class_total[i] &gt; 0:
            print('Test Accuracy of %5s: %2d%% (%2d/%2d)' % (
                classes[i], 100 * class_correct[i] / class_total[i],
                numpy.sum(class_correct[i]), numpy.sum(class_total[i])))
        else:
            print('Test Accuracy of %5s: N/A (no training examples)' % (classes[i]))

    print('\nTest Accuracy (Overall): %2d%% (%2d/%2d)' % (
        100. * numpy.sum(class_correct) / numpy.sum(class_total),
        numpy.sum(class_correct), numpy.sum(class_total)))
</pre></div>
<p>dataiter = iter(test_loader) images, labels = dataiter.next() images.numpy()</p>
<p>if train_on_gpu: images = images.cuda()</p>
<p>output = model(images)</p>
<p>_, preds_tensor = torch.max(output, 1) preds = np.squeeze(preds_tensor.numpy()) if not train_on_gpu else np.squeeze(preds_tensor.cpu().numpy())</p>
<p>fig = plt.figure(figsize=(25, 4)) for idx in np.arange(20): ax = fig.add_subplot(2, 20/2, idx+1, xticks=[], yticks=[]) imshow(images[idx]) ax.set_title("{} ({})".format(classes[preds[idx]], classes[labels[idx]]), color=("green" if preds[idx]==labels[idx].item() else "red"))</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgb3f3e9b">
<h2 id="orgb3f3e9b">Make it Easier</h2>
<div class="outline-text-2" id="text-orgb3f3e9b">
<div class="highlight">
<pre><span></span>means = deviations = (0.5, 0.5, 0.5)
train_transform = transforms.Compose([
    transforms.ToTensor(),
    transforms.Normalize(means, deviations)
    ])
test_transforms = transforms.Compose([
    transforms.ToTensor(),
    transforms.Normalize(means,
                         deviations)])
</pre></div>
<div class="highlight">
<pre><span></span>training_data = datasets.CIFAR10(path.folder, train=True,
                              download=True, transform=train_transform)
test_data = datasets.CIFAR10(path.folder, train=False,
                             download=True, transform=test_transforms)
</pre></div>
<pre class="example">
Files already downloaded and verified
Files already downloaded and verified
</pre>
<div class="highlight">
<pre><span></span>indices = list(range(len(training_data)))
training_indices, validation_indices = train_test_split(
    indices,
    test_size=VALIDATION_FRACTION)
</pre></div>
<div class="highlight">
<pre><span></span>train_sampler = SubsetRandomSampler(training_indices)
valid_sampler = SubsetRandomSampler(validation_indices)
</pre></div>
<div class="highlight">
<pre><span></span>train_loader = torch.utils.data.DataLoader(training_data, batch_size=BATCH_SIZE,
    sampler=train_sampler, num_workers=NUM_WORKERS)
valid_loader = torch.utils.data.DataLoader(training_data, batch_size=BATCH_SIZE, 
    sampler=valid_sampler, num_workers=NUM_WORKERS)
test_loader = torch.utils.data.DataLoader(test_data, batch_size=BATCH_SIZE, 
    num_workers=NUM_WORKERS)
</pre></div>
<div class="highlight">
<pre><span></span>def load_and_train(model_number:int=3, epochs:int=100) -&gt; dict:
    """Load the model using hyperparameters in the dict

    Args:
     model_number: identifier for the model (and its pickles)
     epochs: how many times to repeat training

    Returns:
     outcome: trained model and outcome dict
    """
    model = CNN()
    model = model.to(device)
    start = datetime.now()
    outcome = train_and_pickle(
        model,
        epochs=epochs,
        model_number=model_number)
    model.load_state_dict(torch.load(outcome["hyperparameters_file"],
                                     map_location=device))
    test(model)
    ended = datetime.now()
    print("Ended: {}".format(ended))
    print("Elapsed: {}".format(ended - start))
    return outcome
</pre></div>
<div class="highlight">
<pre><span></span>model_3 = CNN()
model_3.to(device)
start = datetime.now()
outcome = train_and_pickle(
    model_3,
    epochs=100,
    model_number=3)
print("Elapsed: {}".format(datetime.now() - start))
model_3.load_state_dict(torch.load(outcome["hyperparameters_file"],
                                   map_location=device))
test(model_3)
</pre></div>
<pre class="example" id="org6adfa72">
Epoch: 404      Training Loss: 1.766535         Validation Loss: 0.404297
Validation loss decreased (inf --&gt; 0.404297).  Saving model ...
Epoch: 405      Training Loss: 1.539740         Validation Loss: 0.351437
Validation loss decreased (0.404297 --&gt; 0.351437).  Saving model ...
Epoch: 406      Training Loss: 1.408876         Validation Loss: 0.327341
Validation loss decreased (0.351437 --&gt; 0.327341).  Saving model ...
Epoch: 407      Training Loss: 1.325226         Validation Loss: 0.303032
Validation loss decreased (0.327341 --&gt; 0.303032).  Saving model ...
Epoch: 408      Training Loss: 1.260864         Validation Loss: 0.291623
Validation loss decreased (0.303032 --&gt; 0.291623).  Saving model ...
Epoch: 409      Training Loss: 1.214102         Validation Loss: 0.283056
Validation loss decreased (0.291623 --&gt; 0.283056).  Saving model ...
Epoch: 410      Training Loss: 1.178166         Validation Loss: 0.275751
Validation loss decreased (0.283056 --&gt; 0.275751).  Saving model ...
Epoch: 411      Training Loss: 1.146879         Validation Loss: 0.264309
Validation loss decreased (0.275751 --&gt; 0.264309).  Saving model ...
Epoch: 412      Training Loss: 1.121644         Validation Loss: 0.258764
Validation loss decreased (0.264309 --&gt; 0.258764).  Saving model ...
Epoch: 413      Training Loss: 1.097969         Validation Loss: 0.252846
Validation loss decreased (0.258764 --&gt; 0.252846).  Saving model ...
Epoch: 414      Training Loss: 1.078815         Validation Loss: 0.250729
Validation loss decreased (0.252846 --&gt; 0.250729).  Saving model ...
Epoch: 415      Training Loss: 1.055899         Validation Loss: 0.241823
Validation loss decreased (0.250729 --&gt; 0.241823).  Saving model ...
Epoch: 416      Training Loss: 1.041387         Validation Loss: 0.238933
Validation loss decreased (0.241823 --&gt; 0.238933).  Saving model ...
Epoch: 417      Training Loss: 1.029270         Validation Loss: 0.234940
Validation loss decreased (0.238933 --&gt; 0.234940).  Saving model ...
Epoch: 418      Training Loss: 1.016113         Validation Loss: 0.232727
Validation loss decreased (0.234940 --&gt; 0.232727).  Saving model ...
Epoch: 419      Training Loss: 1.005521         Validation Loss: 0.226466
Validation loss decreased (0.232727 --&gt; 0.226466).  Saving model ...
Epoch: 420      Training Loss: 0.992684         Validation Loss: 0.226542
Epoch: 421      Training Loss: 0.978596         Validation Loss: 0.225691
Validation loss decreased (0.226466 --&gt; 0.225691).  Saving model ...
Epoch: 422      Training Loss: 0.976063         Validation Loss: 0.228258
Epoch: 423      Training Loss: 0.961974         Validation Loss: 0.221933
Validation loss decreased (0.225691 --&gt; 0.221933).  Saving model ...
Epoch: 424      Training Loss: 0.954803         Validation Loss: 0.220159
Validation loss decreased (0.221933 --&gt; 0.220159).  Saving model ...
Epoch: 425      Training Loss: 0.948879         Validation Loss: 0.219641
Validation loss decreased (0.220159 --&gt; 0.219641).  Saving model ...
Epoch: 426      Training Loss: 0.945494         Validation Loss: 0.220472
Epoch: 427      Training Loss: 0.935160         Validation Loss: 0.215726
Validation loss decreased (0.219641 --&gt; 0.215726).  Saving model ...
Epoch: 428      Training Loss: 0.928077         Validation Loss: 0.215445
Validation loss decreased (0.215726 --&gt; 0.215445).  Saving model ...
Epoch: 429      Training Loss: 0.925603         Validation Loss: 0.212353
Validation loss decreased (0.215445 --&gt; 0.212353).  Saving model ...
Epoch: 430      Training Loss: 0.921984         Validation Loss: 0.208420
Validation loss decreased (0.212353 --&gt; 0.208420).  Saving model ...
Epoch: 431      Training Loss: 0.912180         Validation Loss: 0.218620
Epoch: 432      Training Loss: 0.909916         Validation Loss: 0.208612
Epoch: 433      Training Loss: 0.902665         Validation Loss: 0.208177
Validation loss decreased (0.208420 --&gt; 0.208177).  Saving model ...
Epoch: 434      Training Loss: 0.899616         Validation Loss: 0.210920
Epoch: 435      Training Loss: 0.895718         Validation Loss: 0.212328
Epoch: 436      Training Loss: 0.883933         Validation Loss: 0.204341
Validation loss decreased (0.208177 --&gt; 0.204341).  Saving model ...
Epoch: 437      Training Loss: 0.888972         Validation Loss: 0.206792
Epoch: 438      Training Loss: 0.878481         Validation Loss: 0.204317
Validation loss decreased (0.204341 --&gt; 0.204317).  Saving model ...
Epoch: 439      Training Loss: 0.879559         Validation Loss: 0.204447
Epoch: 440      Training Loss: 0.871985         Validation Loss: 0.203039
Validation loss decreased (0.204317 --&gt; 0.203039).  Saving model ...
Epoch: 441      Training Loss: 0.870123         Validation Loss: 0.202717
Validation loss decreased (0.203039 --&gt; 0.202717).  Saving model ...
Epoch: 442      Training Loss: 0.870877         Validation Loss: 0.201654
Validation loss decreased (0.202717 --&gt; 0.201654).  Saving model ...
Epoch: 443      Training Loss: 0.863020         Validation Loss: 0.204858
Epoch: 444      Training Loss: 0.861419         Validation Loss: 0.202981
Epoch: 445      Training Loss: 0.864864         Validation Loss: 0.200853
Validation loss decreased (0.201654 --&gt; 0.200853).  Saving model ...
Epoch: 446      Training Loss: 0.859879         Validation Loss: 0.202888
Epoch: 447      Training Loss: 0.859062         Validation Loss: 0.199505
Validation loss decreased (0.200853 --&gt; 0.199505).  Saving model ...
Epoch: 448      Training Loss: 0.853924         Validation Loss: 0.196931
Validation loss decreased (0.199505 --&gt; 0.196931).  Saving model ...
Epoch: 449      Training Loss: 0.849512         Validation Loss: 0.201266
Epoch: 450      Training Loss: 0.845482         Validation Loss: 0.196021
Validation loss decreased (0.196931 --&gt; 0.196021).  Saving model ...
Epoch: 451      Training Loss: 0.844360         Validation Loss: 0.195308
Validation loss decreased (0.196021 --&gt; 0.195308).  Saving model ...
Epoch: 452      Training Loss: 0.844023         Validation Loss: 0.197164
Epoch: 453      Training Loss: 0.839186         Validation Loss: 0.194882
Validation loss decreased (0.195308 --&gt; 0.194882).  Saving model ...
Epoch: 454      Training Loss: 0.838193         Validation Loss: 0.198097
Epoch: 455      Training Loss: 0.837155         Validation Loss: 0.197095
Epoch: 456      Training Loss: 0.831614         Validation Loss: 0.195633
Epoch: 457      Training Loss: 0.827912         Validation Loss: 0.195327
Epoch: 458      Training Loss: 0.830631         Validation Loss: 0.192197
Validation loss decreased (0.194882 --&gt; 0.192197).  Saving model ...
Epoch: 459      Training Loss: 0.825767         Validation Loss: 0.195351
Epoch: 460      Training Loss: 0.824248         Validation Loss: 0.192982
Epoch: 461      Training Loss: 0.822047         Validation Loss: 0.191864
Validation loss decreased (0.192197 --&gt; 0.191864).  Saving model ...
Epoch: 462      Training Loss: 0.824057         Validation Loss: 0.191095
Validation loss decreased (0.191864 --&gt; 0.191095).  Saving model ...
Epoch: 463      Training Loss: 0.821909         Validation Loss: 0.190179
Validation loss decreased (0.191095 --&gt; 0.190179).  Saving model ...
Epoch: 464      Training Loss: 0.820941         Validation Loss: 0.193425
Epoch: 465      Training Loss: 0.820359         Validation Loss: 0.193750
Epoch: 466      Training Loss: 0.815640         Validation Loss: 0.194663
Epoch: 467      Training Loss: 0.818372         Validation Loss: 0.192682
Epoch: 468      Training Loss: 0.817113         Validation Loss: 0.192452
Epoch: 469      Training Loss: 0.817581         Validation Loss: 0.196727
Epoch: 470      Training Loss: 0.809651         Validation Loss: 0.190927
Epoch: 471      Training Loss: 0.811329         Validation Loss: 0.194151
Epoch: 472      Training Loss: 0.806093         Validation Loss: 0.192417
Epoch: 473      Training Loss: 0.806517         Validation Loss: 0.189602
Validation loss decreased (0.190179 --&gt; 0.189602).  Saving model ...
Epoch: 474      Training Loss: 0.807954         Validation Loss: 0.191487
Epoch: 475      Training Loss: 0.807010         Validation Loss: 0.191636
Epoch: 476      Training Loss: 0.801799         Validation Loss: 0.190896
Epoch: 477      Training Loss: 0.798797         Validation Loss: 0.187708
Validation loss decreased (0.189602 --&gt; 0.187708).  Saving model ...
Epoch: 478      Training Loss: 0.799128         Validation Loss: 0.189194
Epoch: 479      Training Loss: 0.799459         Validation Loss: 0.194036
Epoch: 480      Training Loss: 0.795995         Validation Loss: 0.190724
Epoch: 481      Training Loss: 0.798655         Validation Loss: 0.190721
Epoch: 482      Training Loss: 0.792206         Validation Loss: 0.188309
Epoch: 483      Training Loss: 0.799025         Validation Loss: 0.187985
Epoch: 484      Training Loss: 0.791694         Validation Loss: 0.186556
Validation loss decreased (0.187708 --&gt; 0.186556).  Saving model ...
Epoch: 485      Training Loss: 0.784249         Validation Loss: 0.184879
Validation loss decreased (0.186556 --&gt; 0.184879).  Saving model ...
Epoch: 486      Training Loss: 0.793165         Validation Loss: 0.185806
Epoch: 487      Training Loss: 0.791051         Validation Loss: 0.189010
Epoch: 488      Training Loss: 0.787608         Validation Loss: 0.186931
Epoch: 489      Training Loss: 0.789344         Validation Loss: 0.195780
Epoch: 490      Training Loss: 0.792061         Validation Loss: 0.191099
Epoch: 491      Training Loss: 0.786356         Validation Loss: 0.189476
Epoch: 492      Training Loss: 0.784223         Validation Loss: 0.192026
Epoch: 493      Training Loss: 0.785188         Validation Loss: 0.189652
Epoch: 494      Training Loss: 0.782519         Validation Loss: 0.188833
Epoch: 495      Training Loss: 0.786059         Validation Loss: 0.192020
Epoch: 496      Training Loss: 0.782317         Validation Loss: 0.187162
Epoch: 497      Training Loss: 0.785475         Validation Loss: 0.191352
Epoch: 498      Training Loss: 0.778186         Validation Loss: 0.193208
Epoch: 499      Training Loss: 0.780198         Validation Loss: 0.190525
Epoch: 500      Training Loss: 0.778074         Validation Loss: 0.194126
Epoch: 501      Training Loss: 0.778832         Validation Loss: 0.186440
Epoch: 502      Training Loss: 0.776556         Validation Loss: 0.188577
Epoch: 503      Training Loss: 0.774062         Validation Loss: 0.190385
Epoch: 504      Training Loss: 0.776408         Validation Loss: 0.188763
Elapsed: 0:28:16.205032
Test Loss: 0.925722

Test Accuracy of airplane: 70% (703/1000)
Test Accuracy of automobile: 75% (753/1000)
Test Accuracy of  bird: 47% (470/1000)
Test Accuracy of   cat: 56% (562/1000)
Test Accuracy of  deer: 69% (697/1000)
Test Accuracy of   dog: 53% (536/1000)
Test Accuracy of  frog: 80% (803/1000)
Test Accuracy of horse: 67% (670/1000)
Test Accuracy of  ship: 82% (825/1000)
Test Accuracy of truck: 75% (756/1000)

Test Accuracy (Overall): 67% (6775/10000)
</pre>
<div class="highlight">
<pre><span></span>test(model_3)
</pre></div>
<pre class="example" id="org30bdff1">
Test Loss: 0.954966

Test Accuracy of airplane: 62% (629/1000)
Test Accuracy of automobile: 76% (766/1000)
Test Accuracy of  bird: 50% (506/1000)
Test Accuracy of   cat: 44% (449/1000)
Test Accuracy of  deer: 66% (666/1000)
Test Accuracy of   dog: 52% (521/1000)
Test Accuracy of  frog: 82% (827/1000)
Test Accuracy of horse: 72% (721/1000)
Test Accuracy of  ship: 82% (829/1000)
Test Accuracy of truck: 67% (672/1000)

Test Accuracy (Overall): 65% (6586/10000)
</pre>
<div class="highlight">
<pre><span></span>outcome = load_and_train(outcome)
</pre></div>
<pre class="example" id="org934b85b">
Validation loss decreased (inf --&gt; 0.396734).  Saving model ...
Validation loss decreased (0.396734 --&gt; 0.353406).  Saving model ...
Validation loss decreased (0.353406 --&gt; 0.312288).  Saving model ...
Validation loss decreased (0.312288 --&gt; 0.292421).  Saving model ...
Validation loss decreased (0.292421 --&gt; 0.281344).  Saving model ...
Validation loss decreased (0.281344 --&gt; 0.267129).  Saving model ...
Validation loss decreased (0.267129 --&gt; 0.259950).  Saving model ...
Validation loss decreased (0.259950 --&gt; 0.255096).  Saving model ...
Validation loss decreased (0.255096 --&gt; 0.249626).  Saving model ...
Epoch: 110      Training Loss: 1.074378         Validation Loss: 0.241995
Validation loss decreased (0.249626 --&gt; 0.241995).  Saving model ...
Validation loss decreased (0.241995 --&gt; 0.234253).  Saving model ...
Validation loss decreased (0.234253 --&gt; 0.233744).  Saving model ...
Validation loss decreased (0.233744 --&gt; 0.226195).  Saving model ...
Validation loss decreased (0.226195 --&gt; 0.225804).  Saving model ...
Validation loss decreased (0.225804 --&gt; 0.223489).  Saving model ...
Validation loss decreased (0.223489 --&gt; 0.221263).  Saving model ...
Validation loss decreased (0.221263 --&gt; 0.217546).  Saving model ...
Validation loss decreased (0.217546 --&gt; 0.215720).  Saving model ...
Validation loss decreased (0.215720 --&gt; 0.213332).  Saving model ...
Epoch: 120      Training Loss: 0.952941         Validation Loss: 0.209708
Validation loss decreased (0.213332 --&gt; 0.209708).  Saving model ...
Validation loss decreased (0.209708 --&gt; 0.207232).  Saving model ...
Validation loss decreased (0.207232 --&gt; 0.205873).  Saving model ...
Validation loss decreased (0.205873 --&gt; 0.199750).  Saving model ...
Epoch: 130      Training Loss: 0.898597         Validation Loss: 0.197858
Validation loss decreased (0.199750 --&gt; 0.197858).  Saving model ...
Validation loss decreased (0.197858 --&gt; 0.195818).  Saving model ...
Validation loss decreased (0.195818 --&gt; 0.194920).  Saving model ...
Validation loss decreased (0.194920 --&gt; 0.194267).  Saving model ...
Validation loss decreased (0.194267 --&gt; 0.193904).  Saving model ...
Epoch: 140      Training Loss: 0.856769         Validation Loss: 0.203387
Validation loss decreased (0.193904 --&gt; 0.187780).  Saving model ...
Epoch: 150      Training Loss: 0.842055         Validation Loss: 0.190620
Validation loss decreased (0.187780 --&gt; 0.186874).  Saving model ...
Validation loss decreased (0.186874 --&gt; 0.183554).  Saving model ...
Epoch: 160      Training Loss: 0.821771         Validation Loss: 0.186012
Validation loss decreased (0.183554 --&gt; 0.183435).  Saving model ...
Validation loss decreased (0.183435 --&gt; 0.183237).  Saving model ...
Epoch: 170      Training Loss: 0.807321         Validation Loss: 0.185445
Epoch: 180      Training Loss: 0.796137         Validation Loss: 0.182606
Validation loss decreased (0.183237 --&gt; 0.182606).  Saving model ...
Validation loss decreased (0.182606 --&gt; 0.180978).  Saving model ...
Validation loss decreased (0.180978 --&gt; 0.179344).  Saving model ...
Epoch: 190      Training Loss: 0.792454         Validation Loss: 0.181462
Epoch: 200      Training Loss: 0.777160         Validation Loss: 0.187384
Ended: 2018-12-14 15:45:54.887063
Elapsed: 1:09:07.537337
Test Loss: 0.913029

Test Accuracy of airplane: 71% (715/1000)
Test Accuracy of automobile: 80% (803/1000)
Test Accuracy of  bird: 44% (445/1000)
Test Accuracy of   cat: 49% (496/1000)
Test Accuracy of  deer: 73% (733/1000)
Test Accuracy of   dog: 54% (540/1000)
Test Accuracy of  frog: 78% (788/1000)
Test Accuracy of horse: 74% (747/1000)
Test Accuracy of  ship: 84% (840/1000)
Test Accuracy of truck: 75% (750/1000)

Test Accuracy (Overall): 68% (6857/10000)
</pre>
<div class="highlight">
<pre><span></span>outcome = load_and_train(outcome)
</pre></div>
<pre class="example" id="orgb800110">
Validation loss decreased (inf --&gt; 0.405255).  Saving model ...
Validation loss decreased (0.405255 --&gt; 0.347472).  Saving model ...
Validation loss decreased (0.347472 --&gt; 0.318586).  Saving model ...
Validation loss decreased (0.318586 --&gt; 0.301050).  Saving model ...
Validation loss decreased (0.301050 --&gt; 0.287208).  Saving model ...
Validation loss decreased (0.287208 --&gt; 0.279541).  Saving model ...
Epoch: 410      Training Loss: 1.188729         Validation Loss: 0.269707
Validation loss decreased (0.279541 --&gt; 0.269707).  Saving model ...
Validation loss decreased (0.269707 --&gt; 0.262379).  Saving model ...
Validation loss decreased (0.262379 --&gt; 0.254531).  Saving model ...
Validation loss decreased (0.254531 --&gt; 0.252625).  Saving model ...
Validation loss decreased (0.252625 --&gt; 0.240125).  Saving model ...
Validation loss decreased (0.240125 --&gt; 0.235959).  Saving model ...
Validation loss decreased (0.235959 --&gt; 0.234190).  Saving model ...
Validation loss decreased (0.234190 --&gt; 0.231890).  Saving model ...
Validation loss decreased (0.231890 --&gt; 0.226316).  Saving model ...
Epoch: 420      Training Loss: 1.003592         Validation Loss: 0.228944
Validation loss decreased (0.226316 --&gt; 0.224643).  Saving model ...
Validation loss decreased (0.224643 --&gt; 0.222303).  Saving model ...
Validation loss decreased (0.222303 --&gt; 0.221804).  Saving model ...
Validation loss decreased (0.221804 --&gt; 0.219019).  Saving model ...
Validation loss decreased (0.219019 --&gt; 0.211782).  Saving model ...
Epoch: 430      Training Loss: 0.933949         Validation Loss: 0.211028
Validation loss decreased (0.211782 --&gt; 0.211028).  Saving model ...
Validation loss decreased (0.211028 --&gt; 0.210736).  Saving model ...
Validation loss decreased (0.210736 --&gt; 0.207784).  Saving model ...
Validation loss decreased (0.207784 --&gt; 0.204068).  Saving model ...
Validation loss decreased (0.204068 --&gt; 0.202933).  Saving model ...
Validation loss decreased (0.202933 --&gt; 0.201327).  Saving model ...
Epoch: 440      Training Loss: 0.893833         Validation Loss: 0.201305
Validation loss decreased (0.201327 --&gt; 0.201305).  Saving model ...
Validation loss decreased (0.201305 --&gt; 0.200246).  Saving model ...
Validation loss decreased (0.200246 --&gt; 0.199212).  Saving model ...
Validation loss decreased (0.199212 --&gt; 0.198127).  Saving model ...
Validation loss decreased (0.198127 --&gt; 0.197780).  Saving model ...
Epoch: 450      Training Loss: 0.869887         Validation Loss: 0.193194
Validation loss decreased (0.197780 --&gt; 0.193194).  Saving model ...
Validation loss decreased (0.193194 --&gt; 0.192689).  Saving model ...
Validation loss decreased (0.192689 --&gt; 0.191178).  Saving model ...
Epoch: 460      Training Loss: 0.845976         Validation Loss: 0.193641
Validation loss decreased (0.191178 --&gt; 0.190434).  Saving model ...
Epoch: 470      Training Loss: 0.831866         Validation Loss: 0.190801
Validation loss decreased (0.190434 --&gt; 0.189088).  Saving model ...
Epoch: 480      Training Loss: 0.814776         Validation Loss: 0.190064
Validation loss decreased (0.189088 --&gt; 0.189077).  Saving model ...
Validation loss decreased (0.189077 --&gt; 0.188256).  Saving model ...
Validation loss decreased (0.188256 --&gt; 0.185333).  Saving model ...
Epoch: 490      Training Loss: 0.804873         Validation Loss: 0.190370
Epoch: 500      Training Loss: 0.792694         Validation Loss: 0.188568
Ended: 2018-12-14 22:04:39.786682
Elapsed: 0:28:03.912152
Test Loss: 0.933276

Test Accuracy of airplane: 75% (756/1000)
Test Accuracy of automobile: 74% (744/1000)
Test Accuracy of  bird: 48% (482/1000)
Test Accuracy of   cat: 44% (443/1000)
Test Accuracy of  deer: 68% (686/1000)
Test Accuracy of   dog: 50% (502/1000)
Test Accuracy of  frog: 80% (801/1000)
Test Accuracy of horse: 68% (681/1000)
Test Accuracy of  ship: 82% (823/1000)
Test Accuracy of truck: 77% (770/1000)

Test Accuracy (Overall): 66% (6688/10000)
</pre>
<p>The overall test-accuracy is going down - is it overfitting?</p>
<div class="highlight">
<pre><span></span>with open("model_3_outcomes.pkl", "rb") as reader:
    outcome = pickle.load(reader)

outcome = load_and_train(outcome)
</pre></div>
<pre class="example" id="org7faafcb">
Validation loss decreased (inf --&gt; 0.400317).  Saving model ...
Validation loss decreased (0.400317 --&gt; 0.339392).  Saving model ...
Epoch: 810      Training Loss: 1.361320         Validation Loss: 0.310385
Validation loss decreased (0.339392 --&gt; 0.310385).  Saving model ...
Validation loss decreased (0.310385 --&gt; 0.295311).  Saving model ...
Validation loss decreased (0.295311 --&gt; 0.283410).  Saving model ...
Validation loss decreased (0.283410 --&gt; 0.274456).  Saving model ...
Validation loss decreased (0.274456 --&gt; 0.266069).  Saving model ...
Validation loss decreased (0.266069 --&gt; 0.262745).  Saving model ...
Validation loss decreased (0.262745 --&gt; 0.247262).  Saving model ...
Validation loss decreased (0.247262 --&gt; 0.237769).  Saving model ...
Epoch: 820      Training Loss: 1.028606         Validation Loss: 0.236005
Validation loss decreased (0.237769 --&gt; 0.236005).  Saving model ...
Validation loss decreased (0.236005 --&gt; 0.230968).  Saving model ...
Validation loss decreased (0.230968 --&gt; 0.228058).  Saving model ...
Validation loss decreased (0.228058 --&gt; 0.224573).  Saving model ...
Validation loss decreased (0.224573 --&gt; 0.223884).  Saving model ...
Validation loss decreased (0.223884 --&gt; 0.219913).  Saving model ...
Validation loss decreased (0.219913 --&gt; 0.217769).  Saving model ...
Epoch: 830      Training Loss: 0.942998         Validation Loss: 0.215061
Validation loss decreased (0.217769 --&gt; 0.215061).  Saving model ...
Validation loss decreased (0.215061 --&gt; 0.212656).  Saving model ...
Validation loss decreased (0.212656 --&gt; 0.212616).  Saving model ...
Validation loss decreased (0.212616 --&gt; 0.210596).  Saving model ...
Validation loss decreased (0.210596 --&gt; 0.207554).  Saving model ...
Epoch: 840      Training Loss: 0.900498         Validation Loss: 0.208390
Validation loss decreased (0.207554 --&gt; 0.206364).  Saving model ...
Validation loss decreased (0.206364 --&gt; 0.205531).  Saving model ...
Validation loss decreased (0.205531 --&gt; 0.203900).  Saving model ...
Epoch: 850      Training Loss: 0.872049         Validation Loss: 0.205466
Validation loss decreased (0.203900 --&gt; 0.198664).  Saving model ...
Validation loss decreased (0.198664 --&gt; 0.196482).  Saving model ...
Validation loss decreased (0.196482 --&gt; 0.195664).  Saving model ...
Epoch: 860      Training Loss: 0.845757         Validation Loss: 0.198456
Validation loss decreased (0.195664 --&gt; 0.193952).  Saving model ...
Epoch: 870      Training Loss: 0.826413         Validation Loss: 0.195060
Validation loss decreased (0.193952 --&gt; 0.193670).  Saving model ...
Validation loss decreased (0.193670 --&gt; 0.192782).  Saving model ...
Validation loss decreased (0.192782 --&gt; 0.188631).  Saving model ...
Epoch: 880      Training Loss: 0.818928         Validation Loss: 0.199424
Epoch: 890      Training Loss: 0.808009         Validation Loss: 0.191352
Epoch: 900      Training Loss: 0.801281         Validation Loss: 0.196643
Ended: 2018-12-14 22:37:13.843477
Elapsed: 0:29:26.736300
Test Loss: 0.945705

Test Accuracy of airplane: 72% (725/1000)
Test Accuracy of automobile: 78% (782/1000)
Test Accuracy of  bird: 47% (473/1000)
Test Accuracy of   cat: 48% (488/1000)
Test Accuracy of  deer: 70% (705/1000)
Test Accuracy of   dog: 52% (527/1000)
Test Accuracy of  frog: 77% (776/1000)
Test Accuracy of horse: 69% (696/1000)
Test Accuracy of  ship: 84% (844/1000)
Test Accuracy of truck: 70% (703/1000)

Test Accuracy (Overall): 67% (6719/10000)
</pre>
<p>It looks like the overall accuracy dropped slightly beacause the best categories (truck, ship, frog) did worse but the worst categories did slightly better - although not bird for some reason.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org320325a">
<h2 id="org320325a">Take two</h2>
<div class="outline-text-2" id="text-org320325a">
<p>It looks like I wasn't loading the model between each round of epochs</p>
<div class="highlight">
<pre><span></span>outcome = load_and_train(model_number=4, epochs=200)
</pre></div>
<pre class="example" id="org8efc4ac">
Epoch: 0        Training Loss: 1.784692         Validation Loss: 0.410727
Validation loss decreased (inf --&gt; 0.410727).  Saving model ...
Validation loss decreased (0.410727 --&gt; 0.360800).  Saving model ...
Validation loss decreased (0.360800 --&gt; 0.314237).  Saving model ...
Validation loss decreased (0.314237 --&gt; 0.293987).  Saving model ...
Validation loss decreased (0.293987 --&gt; 0.283064).  Saving model ...
Validation loss decreased (0.283064 --&gt; 0.275761).  Saving model ...
Validation loss decreased (0.275761 --&gt; 0.270119).  Saving model ...
Validation loss decreased (0.270119 --&gt; 0.261688).  Saving model ...
Validation loss decreased (0.261688 --&gt; 0.254598).  Saving model ...
Epoch: 10       Training Loss: 1.092668         Validation Loss: 0.254406
Validation loss decreased (0.254598 --&gt; 0.254406).  Saving model ...
Validation loss decreased (0.254406 --&gt; 0.248653).  Saving model ...
Validation loss decreased (0.248653 --&gt; 0.245797).  Saving model ...
Validation loss decreased (0.245797 --&gt; 0.240849).  Saving model ...
Validation loss decreased (0.240849 --&gt; 0.238558).  Saving model ...
Validation loss decreased (0.238558 --&gt; 0.237812).  Saving model ...
Validation loss decreased (0.237812 --&gt; 0.230956).  Saving model ...
Epoch: 20       Training Loss: 0.991010         Validation Loss: 0.225704
Validation loss decreased (0.230956 --&gt; 0.225704).  Saving model ...
Validation loss decreased (0.225704 --&gt; 0.221112).  Saving model ...
Validation loss decreased (0.221112 --&gt; 0.218632).  Saving model ...
Epoch: 30       Training Loss: 0.938513         Validation Loss: 0.220019
Validation loss decreased (0.218632 --&gt; 0.216886).  Saving model ...
Validation loss decreased (0.216886 --&gt; 0.215869).  Saving model ...
Validation loss decreased (0.215869 --&gt; 0.214766).  Saving model ...
Validation loss decreased (0.214766 --&gt; 0.212452).  Saving model ...
Epoch: 40       Training Loss: 0.896510         Validation Loss: 0.212819
Validation loss decreased (0.212452 --&gt; 0.209142).  Saving model ...
Validation loss decreased (0.209142 --&gt; 0.208595).  Saving model ...
Validation loss decreased (0.208595 --&gt; 0.205967).  Saving model ...
Validation loss decreased (0.205967 --&gt; 0.205484).  Saving model ...
Epoch: 50       Training Loss: 0.875811         Validation Loss: 0.207912
Validation loss decreased (0.205484 --&gt; 0.205164).  Saving model ...
Epoch: 60       Training Loss: 0.856581         Validation Loss: 0.208312
Validation loss decreased (0.205164 --&gt; 0.204649).  Saving model ...
Validation loss decreased (0.204649 --&gt; 0.203608).  Saving model ...
Epoch: 70       Training Loss: 0.846062         Validation Loss: 0.214614
Validation loss decreased (0.203608 --&gt; 0.203064).  Saving model ...
Epoch: 80       Training Loss: 0.826153         Validation Loss: 0.212527
Validation loss decreased (0.203064 --&gt; 0.201932).  Saving model ...
Validation loss decreased (0.201932 --&gt; 0.200173).  Saving model ...
Epoch: 90       Training Loss: 0.823697         Validation Loss: 0.204494
Validation loss decreased (0.200173 --&gt; 0.199886).  Saving model ...
Validation loss decreased (0.199886 --&gt; 0.198804).  Saving model ...
Epoch: 100      Training Loss: 0.808043         Validation Loss: 0.205323
Epoch: 110      Training Loss: 0.805417         Validation Loss: 0.201136
Epoch: 120      Training Loss: 0.805155         Validation Loss: 0.204370
Epoch: 130      Training Loss: 0.793174         Validation Loss: 0.214048
Validation loss decreased (0.198804 --&gt; 0.194650).  Saving model ...
Epoch: 140      Training Loss: 0.783871         Validation Loss: 0.200537
Epoch: 150      Training Loss: 0.781592         Validation Loss: 0.203295
Epoch: 160      Training Loss: 0.774657         Validation Loss: 0.199732
Epoch: 170      Training Loss: 0.770487         Validation Loss: 0.205331
Epoch: 180      Training Loss: 0.767693         Validation Loss: 0.202990
Epoch: 190      Training Loss: 0.767225         Validation Loss: 0.203797
Epoch: 200      Training Loss: 0.769268         Validation Loss: 0.196108
Test Loss: 0.974566

Test Accuracy of airplane: 70% (707/1000)
Test Accuracy of automobile: 73% (732/1000)
Test Accuracy of  bird: 45% (453/1000)
Test Accuracy of   cat: 53% (533/1000)
Test Accuracy of  deer: 71% (719/1000)
Test Accuracy of   dog: 42% (429/1000)
Test Accuracy of  frog: 81% (814/1000)
Test Accuracy of horse: 66% (666/1000)
Test Accuracy of  ship: 82% (823/1000)
Test Accuracy of truck: 72% (720/1000)

Test Accuracy (Overall): 65% (6596/10000)
Ended: 2018-12-15 08:33:22.925579
Elapsed: 0:55:24.733457
</pre>
<div class="highlight">
<pre><span></span>outcome = load_and_train(model_number=4, epochs=200)
</pre></div>
<pre class="example" id="org113b7f6">
Validation loss decreased (inf --&gt; 0.203577).  Saving model ...
Validation loss decreased (0.203577 --&gt; 0.201161).  Saving model ...
Validation loss decreased (0.201161 --&gt; 0.198027).  Saving model ...
Epoch: 210      Training Loss: 0.785905         Validation Loss: 0.199885
Epoch: 220      Training Loss: 0.780148         Validation Loss: 0.199842
Validation loss decreased (0.198027 --&gt; 0.197471).  Saving model ...
Epoch: 230      Training Loss: 0.773492         Validation Loss: 0.206471
Validation loss decreased (0.197471 --&gt; 0.195811).  Saving model ...
Epoch: 240      Training Loss: 0.777896         Validation Loss: 0.201046
Epoch: 250      Training Loss: 0.767602         Validation Loss: 0.203973
Epoch: 260      Training Loss: 0.765374         Validation Loss: 0.205219
Epoch: 270      Training Loss: 0.764604         Validation Loss: 0.202613
Epoch: 280      Training Loss: 0.755534         Validation Loss: 0.201307
Epoch: 290      Training Loss: 0.754538         Validation Loss: 0.199495
Epoch: 300      Training Loss: 0.759395         Validation Loss: 0.206451
Epoch: 310      Training Loss: 0.750621         Validation Loss: 0.203110
Epoch: 320      Training Loss: 0.751456         Validation Loss: 0.206920
Epoch: 330      Training Loss: 0.747122         Validation Loss: 0.199856
Epoch: 340      Training Loss: 0.742640         Validation Loss: 0.211159
Epoch: 350      Training Loss: 0.743110         Validation Loss: 0.214833
Epoch: 360      Training Loss: 0.741861         Validation Loss: 0.207520
Epoch: 370      Training Loss: 0.740826         Validation Loss: 0.210348
Epoch: 380      Training Loss: 0.740333         Validation Loss: 0.207724
Epoch: 390      Training Loss: 0.739157         Validation Loss: 0.204985
Epoch: 400      Training Loss: 0.742582         Validation Loss: 0.204150
Test Loss: 0.979350

Test Accuracy of airplane: 64% (648/1000)
Test Accuracy of automobile: 75% (751/1000)
Test Accuracy of  bird: 43% (430/1000)
Test Accuracy of   cat: 50% (507/1000)
Test Accuracy of  deer: 76% (766/1000)
Test Accuracy of   dog: 44% (443/1000)
Test Accuracy of  frog: 81% (818/1000)
Test Accuracy of horse: 63% (630/1000)
Test Accuracy of  ship: 86% (868/1000)
Test Accuracy of truck: 68% (680/1000)

Test Accuracy (Overall): 65% (6541/10000)
Ended: 2018-12-15 11:19:36.845565
Elapsed: 0:55:22.008796
</pre></div>
</div>
<div class="outline-2" id="outline-container-orgc691fab">
<h2 id="orgc691fab">Change the Training and Validation Sets</h2>
<div class="outline-text-2" id="text-orgc691fab">
<div class="highlight">
<pre><span></span>INDICES = list(range(len(training_data)))
DataIterators = (torch.utils.data.dataloader.DataLoader,
                 torch.utils.data.dataloader.DataLoader)

def split_data() -&gt; DataIterators:
    training_indices, validation_indices = train_test_split(
        INDICES,
        test_size=VALIDATION_FRACTION)
    train_sampler = SubsetRandomSampler(training_indices)
    valid_sampler = SubsetRandomSampler(validation_indices)
    train_loader = torch.utils.data.DataLoader(
        training_data, batch_size=BATCH_SIZE,
        sampler=train_sampler, num_workers=NUM_WORKERS)
    valid_loader = torch.utils.data.DataLoader(
        training_data, batch_size=BATCH_SIZE, 
        sampler=valid_sampler, num_workers=NUM_WORKERS)
    return train_loader, valid_loader
</pre></div>
<div class="highlight">
<pre><span></span>train_loader, valid_loader = split_data()
</pre></div>
<div class="highlight">
<pre><span></span>for epoch in range(8):
    outcome = load_and_train(model_number=4, epochs=50)
</pre></div>
<pre class="example" id="org87dac39">
Validation loss decreased (inf --&gt; 0.178021).  Saving model ...
Validation loss decreased (0.178021 --&gt; 0.164977).  Saving model ...
Epoch: 410      Training Loss: 0.790843         Validation Loss: 0.180614
Epoch: 420      Training Loss: 0.779451         Validation Loss: 0.184705
Epoch: 430      Training Loss: 0.776067         Validation Loss: 0.188225
Epoch: 440      Training Loss: 0.767443         Validation Loss: 0.189623
Epoch: 450      Training Loss: 0.763348         Validation Loss: 0.190223
Test Loss: 0.994385

Test Accuracy of airplane: 63% (632/1000)
Test Accuracy of automobile: 73% (738/1000)
Test Accuracy of  bird: 43% (432/1000)
Test Accuracy of   cat: 55% (551/1000)
Test Accuracy of  deer: 73% (731/1000)
Test Accuracy of   dog: 38% (384/1000)
Test Accuracy of  frog: 82% (828/1000)
Test Accuracy of horse: 63% (632/1000)
Test Accuracy of  ship: 88% (880/1000)
Test Accuracy of truck: 65% (658/1000)

Test Accuracy (Overall): 64% (6466/10000)
Ended: 2018-12-15 11:57:44.922535
Elapsed: 0:14:05.152783
Validation loss decreased (inf --&gt; 0.170476).  Saving model ...
Epoch: 810      Training Loss: 0.791785         Validation Loss: 0.185611
Epoch: 820      Training Loss: 0.775938         Validation Loss: 0.185072
Epoch: 830      Training Loss: 0.776210         Validation Loss: 0.187146
Epoch: 840      Training Loss: 0.768063         Validation Loss: 0.182017
Epoch: 850      Training Loss: 0.769061         Validation Loss: 0.196850
Test Loss: 1.012101

Test Accuracy of airplane: 62% (624/1000)
Test Accuracy of automobile: 73% (738/1000)
Test Accuracy of  bird: 42% (429/1000)
Test Accuracy of   cat: 55% (551/1000)
Test Accuracy of  deer: 73% (730/1000)
Test Accuracy of   dog: 42% (420/1000)
Test Accuracy of  frog: 85% (854/1000)
Test Accuracy of horse: 60% (604/1000)
Test Accuracy of  ship: 84% (843/1000)
Test Accuracy of truck: 67% (679/1000)

Test Accuracy (Overall): 64% (6472/10000)
Ended: 2018-12-15 12:12:04.058599
Elapsed: 0:14:19.132241
Validation loss decreased (inf --&gt; 0.174863).  Saving model ...
Epoch: 1610     Training Loss: 0.797948         Validation Loss: 0.176395
Validation loss decreased (0.174863 --&gt; 0.172779).  Saving model ...
Validation loss decreased (0.172779 --&gt; 0.170694).  Saving model ...
Epoch: 1620     Training Loss: 0.789980         Validation Loss: 0.178468
Epoch: 1630     Training Loss: 0.772959         Validation Loss: 0.183980
Epoch: 1640     Training Loss: 0.776142         Validation Loss: 0.198711
Epoch: 1650     Training Loss: 0.767914         Validation Loss: 0.208851
Test Loss: 0.987713

Test Accuracy of airplane: 62% (624/1000)
Test Accuracy of automobile: 74% (743/1000)
Test Accuracy of  bird: 43% (436/1000)
Test Accuracy of   cat: 52% (525/1000)
Test Accuracy of  deer: 73% (734/1000)
Test Accuracy of   dog: 47% (473/1000)
Test Accuracy of  frog: 83% (831/1000)
Test Accuracy of horse: 63% (631/1000)
Test Accuracy of  ship: 84% (845/1000)
Test Accuracy of truck: 68% (682/1000)

Test Accuracy (Overall): 65% (6524/10000)
Ended: 2018-12-15 12:26:50.701191
Elapsed: 0:14:46.638712
Validation loss decreased (inf --&gt; 0.181906).  Saving model ...
Validation loss decreased (0.181906 --&gt; 0.175381).  Saving model ...
Validation loss decreased (0.175381 --&gt; 0.169833).  Saving model ...
Epoch: 3220     Training Loss: 0.776567         Validation Loss: 0.178259
Epoch: 3230     Training Loss: 0.777072         Validation Loss: 0.180300
Epoch: 3240     Training Loss: 0.770289         Validation Loss: 0.192919
Epoch: 3250     Training Loss: 0.762633         Validation Loss: 0.192530
Epoch: 3260     Training Loss: 0.760599         Validation Loss: 0.195964
Test Loss: 0.982302

Test Accuracy of airplane: 66% (665/1000)
Test Accuracy of automobile: 75% (756/1000)
Test Accuracy of  bird: 44% (444/1000)
Test Accuracy of   cat: 56% (565/1000)
Test Accuracy of  deer: 68% (686/1000)
Test Accuracy of   dog: 40% (407/1000)
Test Accuracy of  frog: 85% (855/1000)
Test Accuracy of horse: 63% (639/1000)
Test Accuracy of  ship: 84% (844/1000)
Test Accuracy of truck: 68% (683/1000)

Test Accuracy (Overall): 65% (6544/10000)
Ended: 2018-12-15 12:41:47.333383
Elapsed: 0:14:56.629183
Validation loss decreased (inf --&gt; 0.187802).  Saving model ...
Validation loss decreased (0.187802 --&gt; 0.184430).  Saving model ...
Validation loss decreased (0.184430 --&gt; 0.183925).  Saving model ...
Validation loss decreased (0.183925 --&gt; 0.180367).  Saving model ...
Validation loss decreased (0.180367 --&gt; 0.173719).  Saving model ...
Epoch: 6440     Training Loss: 0.778801         Validation Loss: 0.190905
Epoch: 6450     Training Loss: 0.771958         Validation Loss: 0.182070
Epoch: 6460     Training Loss: 0.764318         Validation Loss: 0.190349
Epoch: 6470     Training Loss: 0.766295         Validation Loss: 0.192508
Epoch: 6480     Training Loss: 0.761968         Validation Loss: 0.189583
Test Loss: 0.987995

Test Accuracy of airplane: 66% (661/1000)
Test Accuracy of automobile: 76% (763/1000)
Test Accuracy of  bird: 44% (443/1000)
Test Accuracy of   cat: 55% (557/1000)
Test Accuracy of  deer: 72% (728/1000)
Test Accuracy of   dog: 41% (415/1000)
Test Accuracy of  frog: 85% (853/1000)
Test Accuracy of horse: 60% (600/1000)
Test Accuracy of  ship: 84% (849/1000)
Test Accuracy of truck: 66% (669/1000)

Test Accuracy (Overall): 65% (6538/10000)
Ended: 2018-12-15 12:56:04.438153
Elapsed: 0:14:17.094202
Validation loss decreased (inf --&gt; 0.191682).  Saving model ...
Validation loss decreased (0.191682 --&gt; 0.182732).  Saving model ...
Validation loss decreased (0.182732 --&gt; 0.181846).  Saving model ...
Epoch: 12870    Training Loss: 0.770414         Validation Loss: 0.185177
Validation loss decreased (0.181846 --&gt; 0.179913).  Saving model ...
Epoch: 12880    Training Loss: 0.772306         Validation Loss: 0.191702
Epoch: 12890    Training Loss: 0.768497         Validation Loss: 0.181795
Epoch: 12900    Training Loss: 0.760247         Validation Loss: 0.183884
Epoch: 12910    Training Loss: 0.757400         Validation Loss: 0.197759
Test Loss: 0.995634

Test Accuracy of airplane: 64% (648/1000)
Test Accuracy of automobile: 75% (755/1000)
Test Accuracy of  bird: 37% (377/1000)
Test Accuracy of   cat: 55% (557/1000)
Test Accuracy of  deer: 72% (726/1000)
Test Accuracy of   dog: 45% (459/1000)
Test Accuracy of  frog: 85% (857/1000)
Test Accuracy of horse: 59% (590/1000)
Test Accuracy of  ship: 84% (842/1000)
Test Accuracy of truck: 69% (696/1000)

Test Accuracy (Overall): 65% (6507/10000)
Ended: 2018-12-15 13:10:05.720077
Elapsed: 0:14:01.278026
Validation loss decreased (inf --&gt; 0.190403).  Saving model ...
Validation loss decreased (0.190403 --&gt; 0.187068).  Saving model ...
Epoch: 25730    Training Loss: 0.768132         Validation Loss: 0.185507
Validation loss decreased (0.187068 --&gt; 0.185507).  Saving model ...
Validation loss decreased (0.185507 --&gt; 0.177258).  Saving model ...
Epoch: 25740    Training Loss: 0.772002         Validation Loss: 0.190112
Epoch: 25750    Training Loss: 0.760312         Validation Loss: 0.195855
Epoch: 25760    Training Loss: 0.759808         Validation Loss: 0.204542
Epoch: 25770    Training Loss: 0.756103         Validation Loss: 0.193606
Test Loss: 0.979529

Test Accuracy of airplane: 66% (663/1000)
Test Accuracy of automobile: 76% (769/1000)
Test Accuracy of  bird: 39% (396/1000)
Test Accuracy of   cat: 57% (578/1000)
Test Accuracy of  deer: 74% (749/1000)
Test Accuracy of   dog: 41% (414/1000)
Test Accuracy of  frog: 83% (833/1000)
Test Accuracy of horse: 61% (618/1000)
Test Accuracy of  ship: 84% (844/1000)
Test Accuracy of truck: 68% (687/1000)

Test Accuracy (Overall): 65% (6551/10000)
Ended: 2018-12-15 13:24:12.319440
Elapsed: 0:14:06.595121
Validation loss decreased (inf --&gt; 0.186117).  Saving model ...
Validation loss decreased (0.186117 --&gt; 0.182822).  Saving model ...
Epoch: 51460    Training Loss: 0.767829         Validation Loss: 0.189161
Epoch: 51470    Training Loss: 0.763347         Validation Loss: 0.194681
Validation loss decreased (0.182822 --&gt; 0.179458).  Saving model ...
Epoch: 51480    Training Loss: 0.756280         Validation Loss: 0.187176
Epoch: 51490    Training Loss: 0.757250         Validation Loss: 0.198088
Epoch: 51500    Training Loss: 0.754145         Validation Loss: 0.204468
Test Loss: 0.973007

Test Accuracy of airplane: 67% (676/1000)
Test Accuracy of automobile: 74% (749/1000)
Test Accuracy of  bird: 41% (415/1000)
Test Accuracy of   cat: 57% (579/1000)
Test Accuracy of  deer: 75% (752/1000)
Test Accuracy of   dog: 41% (412/1000)
Test Accuracy of  frog: 81% (815/1000)
Test Accuracy of horse: 65% (653/1000)
Test Accuracy of  ship: 85% (850/1000)
Test Accuracy of truck: 69% (696/1000)

Test Accuracy (Overall): 65% (6597/10000)
Ended: 2018-12-15 13:38:06.475872
Elapsed: 0:13:54.151685
</pre>
<p>So, this model seems pretty much stuck. I cheated and peaked at the lecturer's solution, but this post is getting too long so I'll save that for another one.</p>
<div class="highlight">
<pre><span></span>figure, axe = pyplot.subplots()
figure.suptitle("Loss")
x = list(range(len(outcome["training_loss"])))
training = numpy.array(outcome["training_loss"])
limit = 500
axe.plot(x[:limit], training[:limit], ".", label="Training")
axe.plot(x[:limit], outcome["validation_loss"][:limit], ".", label="Validation")
legend = axe.legend()
</pre></div>
<div class="figure" id="org97269f5">
<p><img alt="final_model.png" src="posts/nano/cnn/cifar-10/final_model.png"></p>
</div>
<p>So it looks like there's something wrong with my code. I'll have to figure this out (or just stick with straight epochs).</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/visualizing-max-pooling/index.html">Visualizing Max Pooling</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/visualizing-max-pooling/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-03T07:25:07-08:00" itemprop="datePublished" title="2018-12-03 07:25">2018-12-03 07:25</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/visualizing-max-pooling/index.html#org69f17ad">Introduction</a></li>
<li><a href="posts/nano/cnn/visualizing-max-pooling/index.html#org6947a85">Set Up</a></li>
<li><a href="posts/nano/cnn/visualizing-max-pooling/index.html#org3acff72">Define and visualize the filters</a></li>
<li><a href="posts/nano/cnn/visualizing-max-pooling/index.html#org60b758f">Define convolutional and pooling layers</a></li>
<li><a href="posts/nano/cnn/visualizing-max-pooling/index.html#orgf255448">Visualize the output of each filter</a></li>
<li><a href="posts/nano/cnn/visualizing-max-pooling/index.html#org0ca1059">ReLu activation</a></li>
<li><a href="posts/nano/cnn/visualizing-max-pooling/index.html#org3ca05ed">Visualize the output of the pooling layer</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org69f17ad">
<h2 id="org69f17ad">Introduction</h2>
<div class="outline-text-2" id="text-org69f17ad">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree.</p>
<p>In this notebook, we will visualize the output of a maxpooling layer in a CNN.</p>
<p>A convolutional layer + activation function, followed by a pooling layer, and a linear layer (to create a desired output size) make up the basic layers of a CNN.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org6947a85">
<h2 id="org6947a85">Set Up</h2>
<div class="outline-text-2" id="text-org6947a85"></div>
<div class="outline-3" id="outline-container-orgf9c61bd">
<h3 id="orgf9c61bd">Imports</h3>
<div class="outline-text-3" id="text-orgf9c61bd"></div>
<div class="outline-4" id="outline-container-orgb5953b5">
<h4 id="orgb5953b5">PyPi</h4>
<div class="outline-text-4" id="text-orgb5953b5">
<div class="highlight">
<pre><span></span>from dotenv import load_dotenv
import cv2
import matplotlib.pyplot as pyplot
import numpy
import seaborn
import torch
import torch.nn as nn
import torch.nn.functional as F
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd044587">
<h4 id="orgd044587">This Project</h4>
<div class="outline-text-4" id="text-orgd044587">
<div class="highlight">
<pre><span></span>from neurotic.tangles.data_paths import DataPathTwo
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org6487e6f">
<h3 id="org6487e6f">Plotting</h3>
<div class="outline-text-3" id="text-org6487e6f">
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
seaborn.set(style="whitegrid",
            rc={"axes.grid": False,
                "font.family": ["sans-serif"],
                "font.sans-serif": ["Latin Modern Sans", "Lato"],
                "figure.figsize": (14, 12)},
            font_scale=3)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org597b7ce">
<h3 id="org597b7ce">Load the Data</h3>
<div class="outline-text-3" id="text-org597b7ce">
<div class="highlight">
<pre><span></span>load_dotenv()
path = DataPathTwo("rodin.jpg", "CNN")
print(path.from_folder)
assert path.from_folder.is_file()
</pre></div>
<pre class="example">
/home/brunhilde/datasets/cnn/rodin.jpg
</pre>
<div class="highlight">
<pre><span></span>bgr_img = cv2.imread(str(path.from_folder))
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgc2f3514">
<h4 id="orgc2f3514">Convert To Grayscale</h4>
<div class="outline-text-4" id="text-orgc2f3514">
<div class="highlight">
<pre><span></span>gray_img = cv2.cvtColor(bgr_img, cv2.COLOR_BGR2GRAY)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc4c0944">
<h4 id="orgc4c0944">Normalize: Rescale Entries To Lie In [0,1]</h4>
<div class="outline-text-4" id="text-orgc4c0944">
<div class="highlight">
<pre><span></span>gray_img = gray_img.astype("float32")/255
</pre></div>
<div class="highlight">
<pre><span></span>image = pyplot.imshow(gray_img, cmap='gray')
</pre></div>
<div class="figure" id="orga372fda">
<p><img alt="gray_image.png" src="posts/nano/cnn/visualizing-max-pooling/gray_image.png"></p>
</div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3acff72">
<h2 id="org3acff72">Define and visualize the filters</h2>
<div class="outline-text-2" id="text-org3acff72">
<div class="highlight">
<pre><span></span>filter_vals = numpy.array([[-1, -1, -1],
                           [-1, 8, -1],
                           [-1, -1, -1]])
</pre></div>
<div class="highlight">
<pre><span></span>print('Filter shape: ', filter_vals.shape)
</pre></div>
<pre class="example">
Filter shape:  (3, 3)
</pre></div>
<div class="outline-3" id="outline-container-org424b22e">
<h3 id="org424b22e">Defining four different filters,</h3>
<div class="outline-text-3" id="text-org424b22e">
<p>All of these are linear combinations of the <code>filter_vals</code> defined above</p>
<div class="highlight">
<pre><span></span>filter_1 = filter_vals
filter_2 = -filter_1
filter_3 = filter_1.T
filter_4 = -filter_3
filters = numpy.array([filter_1, filter_2, filter_3, filter_4])
</pre></div>
<div class="highlight">
<pre><span></span>print('Filter 1: \n', filter_4)
</pre></div>
<pre class="example">
Filter 1: 
 [[ 1  1  1]
 [ 1 -8  1]
 [ 1  1  1]]
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org60b758f">
<h2 id="org60b758f">Define convolutional and pooling layers</h2>
<div class="outline-text-2" id="text-org60b758f">
<p>You've seen how to define a convolutional layer, next is a <b>Pooling Layer</b>.</p>
<p>In the next cell, we initialize a convolutional layer so that it contains all the created filters. Then add a maxpooling layer, <a href="http://pytorch.org/docs/stable/_modules/torch/nn/modules/pooling.html">documented here</a>, with a kernel size of (2x2) so you can see that the image resolution has been reduced after this step.</p>
<p>A maxpooling layer reduces the x-y size of an input and only keeps the most <b>active</b> pixel values. Below is an example of a 2x2 pooling kernel, with a stride of 2, appied to a small patch of grayscale pixel values; reducing the x-y size of the patch by a factor of 2. Only the maximum pixel values in 2x2 remain in the new, pooled output.</p>
<p>Define a neural network with a convolutional layer with four filters <i>and</i> a pooling layer of size (2, 2).</p>
</div>
<div class="outline-3" id="outline-container-orgaa86249">
<h3 id="orgaa86249">The Model</h3>
<div class="outline-text-3" id="text-orgaa86249">
<div class="highlight">
<pre><span></span>class Net(nn.Module):
    """A convolutional neural network to process 4 filters

    Args:
     weight: matrix of filters
    """
    def __init__(self, weight: numpy.ndarray) -&gt; None:
        super(Net, self).__init__()
        # initializes the weights of the convolutional layer to be the weights of the 4 defined filters
        k_height, k_width = weight.shape[2:]
        # assumes there are 4 grayscale filters
        self.conv = nn.Conv2d(1, 4, kernel_size=(k_height, k_width), bias=False)
        self.conv.weight = torch.nn.Parameter(weight)
        # define a pooling layer
        self.pool = nn.MaxPool2d(2, 2)
        return

    def forward(self, x: torch.Tensor):
        """calculates the output of a convolutional layer

        Args:
         x: image to process

        Returns:
         layers: convolutional, activated, and pooled layers
        """
        conv_x = self.conv(x)
        activated_x = F.relu(conv_x)

        # applies pooling layer
        pooled_x = self.pool(activated_x)

        # returns all layers
        return conv_x, activated_x, pooled_x
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgde60aa8">
<h3 id="orgde60aa8">instantiate the model and set the weights</h3>
<div class="outline-text-3" id="text-orgde60aa8">
<div class="highlight">
<pre><span></span>weight = torch.from_numpy(filters).unsqueeze(1).type(torch.FloatTensor)
model = Net(weight)
</pre></div>
<div class="highlight">
<pre><span></span>print(model)
</pre></div>
<pre class="example">
Net(
  (conv): Conv2d(1, 4, kernel_size=(3, 3), stride=(1, 1), bias=False)
  (pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
)
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf255448">
<h2 id="orgf255448">Visualize the output of each filter</h2>
<div class="outline-text-2" id="text-orgf255448">
<p>First, we'll define a helper function, <code>viz_layer</code> that takes in a specific layer and number of filters (optional argument), and displays the output of that layer once an image has been passed through.</p>
<div class="highlight">
<pre><span></span>def viz_layer(layer, n_filters= 4):
    fig = pyplot.figure(figsize=(20, 20))

    for i in range(n_filters):
        ax = fig.add_subplot(1, n_filters, i+1)
        # grab layer outputs
        ax.imshow(numpy.squeeze(layer[0,i].data.numpy()), cmap='gray')
        ax.set_title('Output %s' % str(i+1))
    return
</pre></div>
<p>Let's look at the output of a convolutional layer after a ReLu activation function is applied.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org0ca1059">
<h2 id="org0ca1059">ReLu activation</h2>
<div class="outline-text-2" id="text-org0ca1059">
<p>A ReLu function turns all negative pixel values in 0's (black). See the equation pictured below for input pixel values, <code>x</code>.</p>
<div class="figure" id="org84f9f62">
<p><img alt="gray_image.png" src="posts/nano/cnn/visualizing-max-pooling/gray_image.png"></p>
</div>
</div>
<div class="outline-3" id="outline-container-orgf644671">
<h3 id="orgf644671">Visualize All the Filters</h3>
<div class="outline-text-3" id="text-orgf644671">
<div class="highlight">
<pre><span></span>fig = pyplot.figure(figsize=(12, 6))
fig.subplots_adjust(left=0, right=1.5, bottom=0.8, top=1, hspace=0.05, wspace=0.05)
for i in range(4):
    ax = fig.add_subplot(1, 4, i+1, xticks=[], yticks=[])
    ax.imshow(filters[i], cmap='gray')
    ax.set_title('Filter %s' % str(i+1))
</pre></div>
<div class="figure" id="org41f3b7b">
<p><img alt="filters.png" src="posts/nano/cnn/visualizing-max-pooling/filters.png"></p>
</div>
</div>
<div class="outline-4" id="outline-container-org22c04b3">
<h4 id="org22c04b3">convert the image into an input Tensor</h4>
<div class="outline-text-4" id="text-org22c04b3">
<div class="highlight">
<pre><span></span>gray_img_tensor = torch.from_numpy(gray_img).unsqueeze(0).unsqueeze(1)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4cdb46b">
<h4 id="org4cdb46b">get all the layers</h4>
<div class="outline-text-4" id="text-org4cdb46b">
<div class="highlight">
<pre><span></span>conv_layer, activated_layer, pooled_layer = model(gray_img_tensor)
</pre></div>
<p>visualize the output of the activated conv layer</p>
<div class="highlight">
<pre><span></span>viz_layer(activated_layer)
</pre></div>
<div class="figure" id="org4377c35">
<p><img alt="activated_layer.png" src="posts/nano/cnn/visualizing-max-pooling/activated_layer.png"></p>
</div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3ca05ed">
<h2 id="org3ca05ed">Visualize the output of the pooling layer</h2>
<div class="outline-text-2" id="text-org3ca05ed">
<p>Then, take a look at the output of a pooling layer. The pooling layer takes as input the feature maps pictured above and reduces the dimensionality of those maps, by some pooling factor, by constructing a new, smaller image of only the maximum (brightest) values in a given kernel area.</p>
<p>Take a look at the values on the x, y axes to see how the image has changed size.</p>
<div class="highlight">
<pre><span></span>viz_layer(pooled_layer)
</pre></div>
<div class="figure" id="orgc3d7706">
<p><img alt="pooled_layer.png" src="posts/nano/cnn/visualizing-max-pooling/pooled_layer.png"></p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/visualizing-convolving/index.html">Visualizing Convolving</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/visualizing-convolving/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-02T19:23:25-08:00" itemprop="datePublished" title="2018-12-02 19:23">2018-12-02 19:23</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#org9521bee">Introduction</a></li>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#org1e22ed6">Imports</a></li>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#org4238cb7">The Image</a></li>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#org4f9c596">Plot the Image</a></li>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#org269cd48">Define and Visualize the Filters</a></li>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#orgf290fb9">Defining four different filters,</a></li>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#org917b5f8">Define a convolutional layer</a></li>
<li><a href="posts/nano/cnn/visualizing-convolving/index.html#orgc3bfde1">ReLu activation</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org9521bee">
<h2 id="org9521bee">Introduction</h2>
<div class="outline-text-2" id="text-org9521bee">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree.</p>
<p>In this notebook, we visualize four filtered outputs (a.k.a. activation maps) of a convolutional layer.</p>
<p>In this example, <b>we</b> are defining four filters that are applied to an input image by initializing the <b>weights</b> of a convolutional layer, but a trained CNN will learn the values of these weights.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org1e22ed6">
<h2 id="org1e22ed6">Imports</h2>
<div class="outline-text-2" id="text-org1e22ed6"></div>
<div class="outline-3" id="outline-container-org7e1f15f">
<h3 id="org7e1f15f">PyPi</h3>
<div class="outline-text-3" id="text-org7e1f15f">
<div class="highlight">
<pre><span></span>from dotenv import load_dotenv
import cv2
import matplotlib.pyplot as pyplot
import numpy
import seaborn
import torch
import torch.nn as nn
import torch.nn.functional as F
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc2b1607">
<h3 id="orgc2b1607">This Project</h3>
<div class="outline-text-3" id="text-orgc2b1607">
<div class="highlight">
<pre><span></span>from neurotic.tangles.data_paths import DataPathTwo
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgeef0262">
<h3 id="orgeef0262">Set Up Plotting</h3>
<div class="outline-text-3" id="text-orgeef0262">
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
seaborn.set(style="whitegrid",
            rc={"axes.grid": False,
                "font.family": ["sans-serif"],
                "font.sans-serif": ["Latin Modern Sans", "Lato"],
                "figure.figsize": (14, 12)},
            font_scale=3)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4238cb7">
<h2 id="org4238cb7">The Image</h2>
<div class="outline-text-2" id="text-org4238cb7">
<div class="highlight">
<pre><span></span>load_dotenv()
path = DataPathTwo("udacity_sdc.png", folder_key="CNN")
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgd5fea2c">
<h3 id="orgd5fea2c">Load the Image</h3>
<div class="outline-text-3" id="text-orgd5fea2c">
<div class="highlight">
<pre><span></span>bgr_img = cv2.imread(str(path.from_folder))
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org71b3ad8">
<h3 id="org71b3ad8">Convert It To Grayscale</h3>
<div class="outline-text-3" id="text-org71b3ad8">
<div class="highlight">
<pre><span></span>gray_img = cv2.cvtColor(bgr_img, cv2.COLOR_BGR2GRAY)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd190328">
<h3 id="orgd190328">Normalize By Rescaling the Entries To Lie In [0,1]</h3>
<div class="outline-text-3" id="text-orgd190328">
<div class="highlight">
<pre><span></span>gray_img = gray_img.astype("float32")/255
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4f9c596">
<h2 id="org4f9c596">Plot the Image</h2>
<div class="outline-text-2" id="text-org4f9c596">
<div class="highlight">
<pre><span></span>image = pyplot.imshow(gray_img, cmap='gray')
</pre></div>
<div class="figure" id="org273e3ef">
<p><img alt="grayscale.png" src="posts/nano/cnn/visualizing-convolving/grayscale.png"></p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org269cd48">
<h2 id="org269cd48">Define and Visualize the Filters</h2>
<div class="outline-text-2" id="text-org269cd48">
<div class="highlight">
<pre><span></span>filter_vals = numpy.array([[-1, -1, 1, 1], [-1, -1, 1, 1], [-1, -1, 1, 1], [-1, -1, 1, 1]])

print('Filter shape: ', filter_vals.shape)
</pre></div>
<pre class="example">
Filter shape:  (4, 4)
</pre></div>
</div>
<div class="outline-2" id="outline-container-orgf290fb9">
<h2 id="orgf290fb9">Defining four different filters,</h2>
<div class="outline-text-2" id="text-orgf290fb9">
<p>All of these are linear combinations of the <code>filter_vals</code> defined above.</p>
<div class="highlight">
<pre><span></span>filter_1 = filter_vals
filter_2 = -filter_1
filter_3 = filter_1.T
filter_4 = -filter_3
filters = numpy.array([filter_1, filter_2, filter_3, filter_4])
</pre></div>
<p>Here's what <code>filter_1</code> has.</p>
<div class="highlight">
<pre><span></span>print('Filter 1: \n', filter_1)
</pre></div>
<pre class="example">
Filter 1: 
 [[-1 -1  1  1]
 [-1 -1  1  1]
 [-1 -1  1  1]
 [-1 -1  1  1]]
</pre></div>
<div class="outline-3" id="outline-container-org9a11a25">
<h3 id="org9a11a25">Visualize All Four Filters</h3>
<div class="outline-text-3" id="text-org9a11a25">
<div class="highlight">
<pre><span></span>fig = pyplot.figure(figsize=(10, 5))
for i in range(4):
    ax = fig.add_subplot(1, 4, i+1, xticks=[], yticks=[])
    ax.imshow(filters[i], cmap='gray')
    ax.set_title('Filter %s' % str(i+1))
    width, height = filters[i].shape
    for x in range(width):
        for y in range(height):
            ax.annotate(str(filters[i][x][y]), xy=(y,x),
                        horizontalalignment='center',
                        verticalalignment='center',
                        color='white' if filters[i][x][y]&lt;0 else 'black')
</pre></div>
<div class="figure" id="orgdc34b0e">
<p><img alt="four_filters.png" src="posts/nano/cnn/visualizing-convolving/four_filters.png"></p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org917b5f8">
<h2 id="org917b5f8">Define a convolutional layer</h2>
<div class="outline-text-2" id="text-org917b5f8">
<p>The various layers that make up any neural network are documented, <a href="http://pytorch.org/docs/stable/nn.html">here</a>. For a convolutional neural network, we'll start by defining a:</p>
<ul class="org-ul">
<li>Convolutional Layer</li>
</ul>
<p>Initialize a single convolutional layer so that it contains all your created filters. Note that you are not training this network; you are initializing the weights in a convolutional layer so that you can visualize what happens after a forward pass through this network!</p>
</div>
<div class="outline-3" id="outline-container-orgf2b5b05">
<h3 id="orgf2b5b05"><code>__init__</code> and <code>forward</code></h3>
<div class="outline-text-3" id="text-orgf2b5b05">
<p>To define a neural network in PyTorch, you define the layers of a model in the <code>__init__</code> method and define the forward behavior of a network that applyies those initialized layers to an input (<code>x</code>) in the <code>forward</code> method. In PyTorch we convert all inputs into the Tensor datatype, which is similar to a list data type in Python.</p>
<p>Below is a class called <code>Net</code> that has a convolutional layer that can contain four 3x3 grayscale filters.</p>
<p>This will be a neural network with a single convolutional layer with four filters.</p>
<div class="highlight">
<pre><span></span>class Net(nn.Module):
    """CNN To apply 4 filters

    initializes the weights of the convolutional layer to be the 
    weights of the 4 defined filters

    Args:
     weights: array with the four filters
    """
    def __init__(self, weight):
        super(Net, self).__init__()
        k_height, k_width = weight.shape[2:]
        # assumes there are 4 grayscale filters
        self.conv = nn.Conv2d(1, 4, kernel_size=(k_height, k_width), bias=False)
        self.conv.weight = torch.nn.Parameter(weight)
        return

    def forward(self, x):
        """calculates the output of a convolutional layer
        pre- and post-activation

        Args:
         x: the image to apply the convolution to

        Returns:
         tuple: convolution output, relu output
        """
        conv_x = self.conv(x)
        activated_x = F.relu(conv_x)

        # returns both layers
        return conv_x, activated_x
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org99ace94">
<h3 id="org99ace94">Instantiate the Model and Set the Weights</h3>
<div class="outline-text-3" id="text-org99ace94">
<div class="highlight">
<pre><span></span>weight = torch.from_numpy(filters).unsqueeze(1).type(torch.FloatTensor)
model = Net(weight)
</pre></div>
<div class="highlight">
<pre><span></span>print(model)
</pre></div>
<pre class="example">
Net(
  (conv): Conv2d(1, 4, kernel_size=(4, 4), stride=(1, 1), bias=False)
)
</pre></div>
</div>
<div class="outline-3" id="outline-container-org328d38a">
<h3 id="org328d38a">Visualize the output of each filter</h3>
<div class="outline-text-3" id="text-org328d38a">
<p>First, we'll define a helper function, <code>viz_layer</code> that takes in a specific layer and number of filters (optional argument), and displays the output of that layer once an image has been passed through.</p>
<div class="highlight">
<pre><span></span>def viz_layer(layer, n_filters= 4):
    fig = pyplot.figure(figsize=(20, 20))

    for i in range(n_filters):
        ax = fig.add_subplot(1, n_filters, i+1, xticks=[], yticks=[])
        # grab layer outputs
        ax.imshow(numpy.squeeze(layer[0,i].data.numpy()), cmap='gray')
        ax.set_title('Output %s' % str(i+1))
    return
</pre></div>
<p>Let's look at the output of a convolutional layer, before and after a ReLu activation function is applied. First, here's our original image again.</p>
<div class="highlight">
<pre><span></span>image = pyplot.imshow(gray_img, cmap='gray')
</pre></div>
<div class="figure" id="org2fc198b">
<p><img alt="gray_2.png" src="posts/nano/cnn/visualizing-convolving/gray_2.png"></p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org3582d58">
<h3 id="org3582d58">visualize all filters</h3>
<div class="outline-text-3" id="text-org3582d58">
<div class="highlight">
<pre><span></span>fig = pyplot.figure(figsize=(12, 6))
fig.subplots_adjust(left=0, right=1.5, bottom=0.8, top=1, hspace=0.05, wspace=0.05)
for i in range(4):
    ax = fig.add_subplot(1, 4, i+1, xticks=[], yticks=[])
    ax.imshow(filters[i], cmap='gray')
    ax.set_title('Filter %s' % str(i+1))
</pre></div>
<div class="figure" id="org6d9381c">
<p><img alt="filtered.png" src="posts/nano/cnn/visualizing-convolving/filtered.png"></p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc4e28c8">
<h3 id="orgc4e28c8">Convert The Image Into An Input Tensor</h3>
<div class="outline-text-3" id="text-orgc4e28c8">
<div class="highlight">
<pre><span></span>gray_img_tensor = torch.from_numpy(gray_img).unsqueeze(0).unsqueeze(1)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org4850f2d">
<h3 id="org4850f2d">Get The Convolutional Layer (Pre and Post Activation)</h3>
<div class="outline-text-3" id="text-org4850f2d">
<div class="highlight">
<pre><span></span>conv_layer, activated_layer = model(gray_img_tensor)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgcab1f32">
<h3 id="orgcab1f32">Visualize the Output of a Convolutional Layer</h3>
<div class="outline-text-3" id="text-orgcab1f32">
<div class="highlight">
<pre><span></span>viz_layer(conv_layer)
</pre></div>
<div class="figure" id="org00c6481">
<p><img alt="layer_1.png" src="posts/nano/cnn/visualizing-convolving/layer_1.png"></p>
</div>
<p>Sort of gives it a bas-relief look.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc3bfde1">
<h2 id="orgc3bfde1">ReLu activation</h2>
<div class="outline-text-2" id="text-orgc3bfde1">
<p>In this model, we've used an activation function that scales the output of the convolutional layer. We've chose a ReLu function to do this, and this function simply turns all negative pixel values to 0's (black). See the equation pictured below for input pixel values, <code>x</code>.</p>
<p>Visualize the output of an activated conv layer after a ReLu is applied.</p>
<div class="highlight">
<pre><span></span>viz_layer(activated_layer)
</pre></div>
<div class="figure" id="org80f00bf">
<p><img alt="activated_layer.png" src="posts/nano/cnn/visualizing-convolving/activated_layer.png"></p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/custom-filters/index.html">Custom Filters</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/custom-filters/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-12-02T16:06:32-08:00" itemprop="datePublished" title="2018-12-02 16:06">2018-12-02 16:06</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/custom-filters/index.html#org375bf87">Introduction</a></li>
<li><a href="posts/nano/cnn/custom-filters/index.html#orga24353b">Set Up</a></li>
<li><a href="posts/nano/cnn/custom-filters/index.html#org8115184">Read in the image</a></li>
<li><a href="posts/nano/cnn/custom-filters/index.html#org3f0027c">Convert the image to grayscale</a></li>
<li><a href="posts/nano/cnn/custom-filters/index.html#org1ce9948">Create a custom kernel</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org375bf87">
<h2 id="org375bf87">Introduction</h2>
<div class="outline-text-2" id="text-org375bf87">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orga24353b">
<h2 id="orga24353b">Set Up</h2>
<div class="outline-text-2" id="text-orga24353b"></div>
<div class="outline-3" id="outline-container-org37cf263">
<h3 id="org37cf263">Imports</h3>
<div class="outline-text-3" id="text-org37cf263"></div>
<div class="outline-4" id="outline-container-orgd9117dc">
<h4 id="orgd9117dc">From PyPi</h4>
<div class="outline-text-4" id="text-orgd9117dc">
<div class="highlight">
<pre><span></span>from dotenv import load_dotenv
import matplotlib.pyplot as pyplot
import matplotlib.image as mpimg
import cv2
import numpy
import seaborn
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6463efa">
<h4 id="org6463efa">This Project</h4>
<div class="outline-text-4" id="text-org6463efa">
<div class="highlight">
<pre><span></span>from neurotic.tangles.data_paths import DataPathTwo
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd87016b">
<h3 id="orgd87016b">Set Up</h3>
<div class="outline-text-3" id="text-orgd87016b">
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
seaborn.set(style="whitegrid",
            rc={"axes.grid": False,
                "font.family": ["sans-serif"],
                "font.sans-serif": ["Latin Modern Sans", "Lato"],
                "figure.figsize": (14, 12)},
            font_scale=3)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8115184">
<h2 id="org8115184">Read in the image</h2>
<div class="outline-text-2" id="text-org8115184">
<div class="highlight">
<pre><span></span>load_dotenv()
path = DataPathTwo("curved_lane.jpg", folder_key="CNN")
print(path.from_folder)
assert path.from_folder.is_file()
</pre></div>
<pre class="example">
/home/hades/datasets/cnn/curved_lane.jpg
</pre>
<div class="highlight">
<pre><span></span>image = mpimg.imread(path.from_folder)

axe_image = pyplot.imshow(image)
</pre></div>
<div class="figure" id="orgebdb191">
<p><img alt="curved_lane.png" src="posts/nano/cnn/custom-filters/curved_lane.png"></p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3f0027c">
<h2 id="org3f0027c">Convert the image to grayscale</h2>
<div class="outline-text-2" id="text-org3f0027c">
<div class="highlight">
<pre><span></span>gray = cv2.cvtColor(image, cv2.COLOR_RGB2GRAY)
axe_image = pyplot.imshow(gray, cmap='gray')
</pre></div>
<div class="figure" id="org6fca5af">
<p><img alt="gray_curved.png" src="posts/nano/cnn/custom-filters/gray_curved.png"></p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1ce9948">
<h2 id="org1ce9948">Create a custom kernel</h2>
<div class="outline-text-2" id="text-org1ce9948">
<p>Below, you've been given one common type of edge detection filter: a Sobel operator.</p>
<p>The Sobel filter is very commonly used in edge detection and in finding patterns in intensity in an image. Applying a Sobel filter to an image is a way of <b>taking (an approximation) of the derivative of the image</b> in the x or y direction, separately. The operators look as follows.</p>
<div class="figure" id="orgfab2dd8">
<p><img alt="sobel_ops.png" src="posts/nano/cnn/custom-filters/sobel_ops.png"></p>
</div>
<p>For a challenge, see if you can put the image through a series of filters: first one that blurs the image (takes an average of pixels), and then one that detects the edges.</p>
<p>3x3 array for edge detection</p>
<div class="highlight">
<pre><span></span>sobel_y = numpy.array([[ -1, -2, -1], 
                       [  0, 0, 0], 
                       [ 1, 2, 1]])
</pre></div>
<div class="highlight">
<pre><span></span>filtered_image = cv2.filter2D(gray, -1, sobel_y)

axe_image = pyplot.imshow(filtered_image, cmap='gray')
</pre></div>
<div class="figure" id="org74260a7">
<p><img alt="sobel_1.png" src="posts/nano/cnn/custom-filters/sobel_1.png"></p>
</div>
</div>
<div class="outline-3" id="outline-container-orgb7d8312">
<h3 id="orgb7d8312">Prewitt</h3>
<div class="outline-text-3" id="text-orgb7d8312">
<p>This matrix is from <a href="https://hipersayanx.blogspot.com/2015/08/convolutional-edge-detection-filters.html">this</a> blog post.</p>
<div class="highlight">
<pre><span></span>prewitt = numpy.array([[-1, -1, -1],
                       [0, 0, 0],
                       [1, 1, 1]])
</pre></div>
<div class="highlight">
<pre><span></span>filtered_prewitt = cv2.filter2D(gray, -1, prewitt)

axe_image = pyplot.imshow(filtered_prewitt, cmap='gray')
</pre></div>
<div class="figure" id="orgebf86c9">
<p><img alt="prewitt.png" src="posts/nano/cnn/custom-filters/prewitt.png"></p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgac183e9">
<h3 id="orgac183e9">Sharpen</h3>
<div class="outline-text-3" id="text-orgac183e9">
<p>This is from the <a href="https://en.wikipedia.org/wiki/Kernel_(image_processing)">Wikipedia article</a> about kernels for image processing.</p>
<div class="highlight">
<pre><span></span>mask = numpy.array([[0, -1, 0],
                    [-1, 5, -1],
                    [0, -1, 0]])
sharpened = cv2.filter2D(gray, -1, mask)

axe_image = pyplot.imshow(sharpened, cmap='gray')
</pre></div>
<div class="figure" id="org3dcfeae">
<p><img alt="sharpen.png" src="posts/nano/cnn/custom-filters/sharpen.png"></p>
</div>
<p>This one isn't so obvious, but if you compare it to the original grayscale image you'll see that it is a little less blurry.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html">MNIST Multi-Layer Perceptron with Validation</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html" rel="bookmark"><time class="published dt-published" datetime="2018-11-27T12:02:56-08:00" itemprop="datePublished" title="2018-11-27 12:02">2018-11-27 12:02</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#org07f929f">Introduction</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#orgc076fc5">Setup</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#orgf35059c">The Data</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#org3084f1e">Visualize a Batch of Training Data</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#orgcf4414d">Define the Network Architecture</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#org62a662e">Specify the Loss Function and Optimizer</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#org5eb865e">Train the Network</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#org19a5a14">Testing the Best Model</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#orga324222">Visualize Test Results</a></li>
<li><a href="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/index.html#orge26da5d">Object-Oriented Trainer</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org07f929f">
<h2 id="org07f929f">Introduction</h2>
<div class="outline-text-2" id="text-org07f929f">
<p>This is from <a href="https://github.com/udacity/deep-learning-v2-pytorch.git">Udacity's Deep Learning Repository</a> which supports their Deep Learning Nanodegree.</p>
<p>We are going to train a <a href="https://en.wikipedia.org/wiki/Multilayer_perceptron">Multi-Layer Perceptron</a> to classify images from the <a href="http://yann.lecun.com/exdb/mnist/">MNIST database</a> of hand-written digits.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgc076fc5">
<h2 id="orgc076fc5">Setup</h2>
<div class="outline-text-2" id="text-orgc076fc5"></div>
<div class="outline-3" id="outline-container-org9d37524">
<h3 id="org9d37524">Imports</h3>
<div class="outline-text-3" id="text-org9d37524"></div>
<div class="outline-4" id="outline-container-org14c785f">
<h4 id="org14c785f">From Python</h4>
<div class="outline-text-4" id="text-org14c785f">
<div class="highlight">
<pre><span></span> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
 <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
 <span class="kn">import</span> <span class="nn">gc</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1b2a2e4">
<h4 id="org1b2a2e4">From PyPi</h4>
<div class="outline-text-4" id="text-org1b2a2e4">
<div class="highlight">
<pre><span></span> <span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
 <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
 <span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pyplot</span>
 <span class="kn">import</span> <span class="nn">seaborn</span>
 <span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
 <span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
 <span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
 <span class="kn">import</span> <span class="nn">torch</span>
 <span class="kn">import</span> <span class="nn">numpy</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgad6ffb0">
<h4 id="orgad6ffb0">This Project</h4>
<div class="outline-text-4" id="text-orgad6ffb0">
<div class="highlight">
<pre><span></span> <span class="kn">from</span> <span class="nn">neurotic.tangles.data_paths</span> <span class="kn">import</span> <span class="n">DataPathTwo</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org8ab9eb9">
<h3 id="org8ab9eb9">Setup the Plotting</h3>
<div class="outline-text-3" id="text-org8ab9eb9">
<div class="highlight">
<pre><span></span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
 <span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
             <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                 <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                 <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">)},</span>
             <span class="n">font_scale</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc226952">
<h3 id="orgc226952">Types</h3>
<div class="outline-text-3" id="text-orgc226952">
<div class="highlight">
<pre><span></span> <span class="n">Outcome</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf35059c">
<h2 id="orgf35059c">The Data</h2>
<div class="outline-text-2" id="text-orgf35059c"></div>
<div class="outline-3" id="outline-container-org0f93916">
<h3 id="org0f93916">The Path To the Data</h3>
<div class="outline-text-3" id="text-org0f93916">
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">DataPathTwo</span><span class="p">(</span><span class="n">folder_key</span><span class="o">=</span><span class="s2">"MNIST"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</pre></div>
<pre class="example">
/home/hades/datasets/MNIST
</pre></div>
</div>
<div class="outline-3" id="outline-container-org702bf85">
<h3 id="org702bf85">Some Settings</h3>
<div class="outline-text-3" id="text-org702bf85">
<p>Since I downloaded the data earlier for some other exercise forking sub-processes is probably unnecessary, and for the training and testing we'll use a relatively small batch-size of 20.</p>
<div class="highlight">
<pre><span></span><span class="n">WORKERS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">VALIDATION_PROPORTION</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb478365">
<h3 id="orgb478365">A Transform</h3>
<div class="outline-text-3" id="text-orgb478365">
<p>We're just going to convert the images to tensors.</p>
<div class="highlight">
<pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0e4f99a">
<h3 id="org0e4f99a">Split Up the Training and Testing Data</h3>
<div class="outline-text-3" id="text-org0e4f99a">
<div class="highlight">
<pre><span></span><span class="n">training_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org1de5ee4">
<h3 id="org1de5ee4">Make a Validation Set</h3>
<div class="outline-text-3" id="text-org1de5ee4">
<p>Now we're going to re-split the training-data into training and validation data. First we're going to generate indices for each set using sklearn's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html"><code>train_test_split</code></a>.</p>
<div class="highlight">
<pre><span></span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_data</span><span class="p">)))</span>
<span class="n">training_indices</span><span class="p">,</span> <span class="n">validation_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">VALIDATION_PROPORTION</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_indices</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_indices</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_indices</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="n">VALIDATION_PROPORTION</span>
</pre></div>
<pre class="example">
48000
12000
</pre>
<p>Now that we have our indices we need to create some samplers that can be passed to the Data Loaders. We need them to create the batches from our data.</p>
<div class="highlight">
<pre><span></span><span class="n">training_sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">SubsetRandomSampler</span><span class="p">(</span><span class="n">training_indices</span><span class="p">)</span>
<span class="n">validation_sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">SubsetRandomSampler</span><span class="p">(</span><span class="n">validation_indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org084f4ba">
<h3 id="org084f4ba">Create The Data Loaders</h3>
<div class="outline-text-3" id="text-org084f4ba">
<p>Now we will create the batch-iterators.</p>
<div class="highlight">
<pre><span></span><span class="n">training_batches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">training_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">training_sampler</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">WORKERS</span><span class="p">)</span>
</pre></div>
<p>For the validation batch we pass in the training data and use the validation-sampler to create a separate set of batches.</p>
<div class="highlight">
<pre><span></span><span class="n">validation_batches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">training_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">validation_sampler</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">WORKERS</span><span class="p">)</span>
</pre></div>
<p>Since we're not splitting the testing data it doesn't get a sampler.</p>
<div class="highlight">
<pre><span></span><span class="n">test_batches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">WORKERS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org3084f1e">
<h2 id="org3084f1e">Visualize a Batch of Training Data</h2>
<div class="outline-text-2" id="text-org3084f1e">
<p>Our first step is to take a look at the data, make sure it is loaded in correctly, then make any initial observations about patterns in that data.</p>
</div>
<div class="outline-3" id="outline-container-orgd3b2e4d">
<h3 id="orgd3b2e4d">Grab a batch</h3>
<div class="outline-text-3" id="text-orgd3b2e4d">
<div class="highlight">
<pre><span></span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">training_batches</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
<p>Now that we have a batch we're going to plot the images in the batch, along with the corresponding labels.</p>
<div class="highlight">
<pre><span></span><span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"First Batch"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="c1"># print out the correct label for each image</span>
    <span class="c1"># .item() gets the value contained in a Tensor</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
</pre></div>
<div class="figure" id="orgc04313a">
<p><img alt="batch.png" src="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/batch.png"></p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org6ce662a">
<h3 id="org6ce662a">View a Single Image</h3>
<div class="outline-text-3" id="text-org6ce662a">
<p>Now we're going to take a closer look at the second image in the batch.</p>
<div class="highlight">
<pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">"white"</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span> 
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">"xx-large"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mf">2.5</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">image</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">),</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">'white'</span> <span class="k">if</span> <span class="n">image</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span><span class="o">&lt;</span><span class="n">threshold</span> <span class="k">else</span> <span class="s1">'black'</span><span class="p">)</span>
</pre></div>
<div class="figure" id="org0ac6168">
<p><img alt="image.png" src="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/image.png"></p>
</div>
<p>We're looking at a single image with the normalized values for each pixel superimposed on it. It looks like black is 0 and white is 1, although for this image most of the 'white' pixels are just a little less than one.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgcf4414d">
<h2 id="orgcf4414d">Define the Network <a href="http://pytorch.org/docs/stable/nn.html">Architecture</a></h2>
<div class="outline-text-2" id="text-orgcf4414d">
<p>The architecture will be responsible for seeing as input a 784-dim Tensor of pixel values for each image, and producing a Tensor of length 10 (our number of classes) that indicates the class scores for an input image. This particular example uses two hidden layers and dropout to avoid overfitting.</p>
<p>These values are based on the <a href="https://github.com/keras-team/keras/blob/master/examples/mnist_mlp.py">keras</a> example implementation.</p>
<div class="highlight">
<pre><span></span><span class="n">INPUT_NODES</span> <span class="o">=</span> <span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span>
<span class="n">HIDDEN_NODES_1</span> <span class="o">=</span> <span class="n">HIDDEN_NODES_2</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">DROPOUT</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">CLASSES</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">MultiLayerPerceptron</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A Multi-Layer Perceptron</span>

<span class="sd">    This is a network with 2 hidden layers</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">fully_connected_layer_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">INPUT_NODES</span><span class="p">,</span> <span class="n">HIDDEN_NODES_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fully_connected_layer_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">HIDDEN_NODES_1</span><span class="p">,</span> <span class="n">HIDDEN_NODES_2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">HIDDEN_NODES_2</span><span class="p">,</span> <span class="n">CLASSES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">DROPOUT</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""One feed-forward through the network</span>

<span class="sd">       Args:</span>
<span class="sd">        x: a 28 x 28 tensor</span>

<span class="sd">       Returns:</span>
<span class="sd">        tensor: output of the network without activation</span>
<span class="sd">       """</span>
        <span class="c1"># flatten image input</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">INPUT_NODES</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fully_connected_layer_1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fully_connected_layer_2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org6ee99de">
<h3 id="org6ee99de">Initialize the Neural Network</h3>
<div class="outline-text-3" id="text-org6ee99de">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">MultiLayerPerceptron</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
<pre class="example">
MultiLayerPerceptron(
  (fully_connected_layer_1): Linear(in_features=784, out_features=512, bias=True)
  (fully_connected_layer_2): Linear(in_features=512, out_features=512, bias=True)
  (output): Linear(in_features=512, out_features=10, bias=True)
  (dropout): Dropout(p=0.2)
)
</pre></div>
</div>
<div class="outline-3" id="outline-container-orga5ae92b">
<h3 id="orga5ae92b">A Little CUDA</h3>
<div class="outline-text-3" id="text-orga5ae92b">
<p>This sets it up to use CUDA (if available).</p>
<div class="highlight">
<pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Using </span><span class="si">{}</span><span class="s2"> GPUs"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Only 1 GPU available"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Only 1 GPU available
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org62a662e">
<h2 id="org62a662e">Specify the <a href="http://pytorch.org/docs/stable/nn.html#loss-functions">Loss Function</a> and <a href="http://pytorch.org/docs/stable/optim.html">Optimizer</a></h2>
<div class="outline-text-2" id="text-org62a662e">
<p>We're going to use <a href="http://pytorch.org/docs/stable/nn.html#loss-functions">cross-entropy loss</a> for classification. PyTorch's cross entropy function applies a softmax function to the output layer <b>and</b> then calculates the log loss (so you don't want to do softmax as part of the model output).</p>
<div class="highlight">
<pre><span></span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LEARNING_RATE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org5eb865e">
<h2 id="org5eb865e">Train the Network</h2>
<div class="outline-text-2" id="text-org5eb865e">
<p>We're going to do a quasi-search by optimizing over 50 epochs and keeping the model that has the best validation score.</p>
<div class="highlight">
<pre><span></span><span class="c1"># number of epochs to train the model</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">SAVED_MODEL</span><span class="o">=</span> <span class="s1">'multilayer_perceptron.pt'</span>
</pre></div>
<div class="highlight">
<pre><span></span> <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                   <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="p">:</span>
<span class="w">     </span><span class="sd">"""process one batch of the data</span>

<span class="sd">     Args:</span>
<span class="sd">      model: model to predict target</span>
<span class="sd">      data: data to use to predict target</span>
<span class="sd">      target: what we're trying to predict</span>
<span class="sd">      device: cpu or gpu</span>

<span class="sd">     Returns:</span>
<span class="sd">      outcome: loss and correct count</span>
<span class="sd">     """</span>
     <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
     <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
     <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
     <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
          <span class="n">batches</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
          <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Perform one forward pass through the batches</span>

<span class="sd">    Args:</span>
<span class="sd">     model: thing to train</span>
<span class="sd">     batches: batch-iterator of training data</span>
<span class="sd">     device: cpu or cuda device</span>

<span class="sd">    Returns:</span>
<span class="sd">     outcome: cumulative loss, accuracy for the batches</span>
<span class="sd">    """</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">correct</span> <span class="o">=</span> <span class="n">process_batch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">total_correct</span> <span class="o">+=</span> <span class="n">correct</span>
        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">total_correct</span><span class="o">/</span><span class="n">count</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
             <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate the loss for the model</span>

<span class="sd">    Args:</span>
<span class="sd">     model: the model to validate</span>
<span class="sd">     batches: the batch-iterator of validation data</span>
<span class="sd">     device: cuda or cpu</span>

<span class="sd">    Returns:</span>
<span class="sd">     Outcome: Cumulative loss, Accuracy over batches</span>
<span class="sd">    """</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">total_correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">correct</span> <span class="o">=</span> <span class="n">process_batch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">total_correct</span> <span class="o">+=</span> <span class="n">correct</span>
        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">total_correct</span><span class="o">/</span><span class="n">count</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="c1"># initialize tracker for minimum validation loss</span>
<span class="n">lowest_validation_loss</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">Inf</span>
<span class="n">training_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">validation_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">training_accuracies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">validation_accuracies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">EPOCHS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">training_batches</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">training_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="n">mean_training_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">training_batches</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">training_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>

    <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">validation_batches</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">validation_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="n">mean_validation_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_batches</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">validation_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mean_validation_loss</span> <span class="o">&lt;=</span> <span class="n">lowest_validation_loss</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">{}</span><span class="s1">: Validation loss decreased (</span><span class="si">{:.6f}</span><span class="s1"> --&gt; </span><span class="si">{:.6f}</span><span class="s1">).  Saving model ...'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">epoch</span><span class="p">,</span>
            <span class="n">lowest_validation_loss</span><span class="p">,</span>
            <span class="n">mean_validation_loss</span><span class="p">))</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">SAVED_MODEL</span><span class="p">)</span>
        <span class="n">lowest_validation_loss</span> <span class="o">=</span> <span class="n">mean_validation_loss</span>
</pre></div>
<pre class="example" id="org76dd4bb">
Epoch 1: Validation loss decreased (inf --&gt; 0.076556).  Saving model ...
Epoch 2: Validation loss decreased (0.076556 --&gt; 0.058478).  Saving model ...
Epoch 3: Validation loss decreased (0.058478 --&gt; 0.049405).  Saving model ...
Epoch 4: Validation loss decreased (0.049405 --&gt; 0.043155).  Saving model ...
Epoch 5: Validation loss decreased (0.043155 --&gt; 0.037079).  Saving model ...
Epoch 6: Validation loss decreased (0.037079 --&gt; 0.032932).  Saving model ...
Epoch 7: Validation loss decreased (0.032932 --&gt; 0.029682).  Saving model ...
Epoch 8: Validation loss decreased (0.029682 --&gt; 0.028046).  Saving model ...
Epoch 9: Validation loss decreased (0.028046 --&gt; 0.025318).  Saving model ...
Epoch 10: Validation loss decreased (0.025318 --&gt; 0.023867).  Saving model ...
Epoch 11: Validation loss decreased (0.023867 --&gt; 0.022447).  Saving model ...
Epoch 12: Validation loss decreased (0.022447 --&gt; 0.021411).  Saving model ...
Epoch 13: Validation loss decreased (0.021411 --&gt; 0.020793).  Saving model ...
Epoch 14: Validation loss decreased (0.020793 --&gt; 0.019830).  Saving model ...
Epoch 15: Validation loss decreased (0.019830 --&gt; 0.018676).  Saving model ...
Epoch 16: Validation loss decreased (0.018676 --&gt; 0.018644).  Saving model ...
Epoch 17: Validation loss decreased (0.018644 --&gt; 0.017666).  Saving model ...
Epoch 18: Validation loss decreased (0.017666 --&gt; 0.017635).  Saving model ...
Epoch 20: Validation loss decreased (0.017635 --&gt; 0.016688).  Saving model ...
Epoch 21: Validation loss decreased (0.016688 --&gt; 0.016489).  Saving model ...
Epoch 22: Validation loss decreased (0.016489 --&gt; 0.016364).  Saving model ...
Epoch 23: Validation loss decreased (0.016364 --&gt; 0.015944).  Saving model ...
Epoch 24: Validation loss decreased (0.015944 --&gt; 0.015633).  Saving model ...
Epoch 26: Validation loss decreased (0.015633 --&gt; 0.015446).  Saving model ...
Epoch 27: Validation loss decreased (0.015446 --&gt; 0.015257).  Saving model ...
Epoch 30: Validation loss decreased (0.015257 --&gt; 0.015216).  Saving model ...
Epoch 31: Validation loss decreased (0.015216 --&gt; 0.015175).  Saving model ...
Epoch 34: Validation loss decreased (0.015175 --&gt; 0.014866).  Saving model ...
Epoch 36: Validation loss decreased (0.014866 --&gt; 0.014530).  Saving model ...
</pre>
<p>The training and validation loss seems surprisingly good.</p>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_losses</span><span class="p">)))</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Loss Per Batch"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Training"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">validation_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Validation"</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
<div class="figure" id="org3efb20f">
<p><img alt="losses.png" src="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/losses.png"></p>
</div>
<p>So it looks like it improves fairly quickly then after 36 epochs the model stops improving.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org19a5a14">
<h2 id="org19a5a14">Testing the Best Model</h2>
<div class="outline-text-2" id="text-org19a5a14">
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">SAVED_MODEL</span><span class="p">))</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">test_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">class_correct</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">class_total</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">test_batches</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># calculate the loss</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="c1"># update test loss </span>
    <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># convert output probabilities to predicted class</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># compare predictions to true label</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">)))</span>
    <span class="c1"># calculate test accuracy for each object class</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">class_correct</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">class_total</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># calculate and print avg test loss</span>
<span class="n">test_loss</span> <span class="o">=</span> <span class="n">test_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">test_batches</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Test Loss: </span><span class="si">{:.6f}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_loss</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">class_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Test Accuracy of </span><span class="si">%5s</span><span class="s1">: </span><span class="si">%2d%%</span><span class="s1"> (</span><span class="si">%2d</span><span class="s1">/</span><span class="si">%2d</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">class_correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">class_total</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">class_correct</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">class_total</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Test Accuracy of </span><span class="si">%5s</span><span class="s1">: N/A (no training examples)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>
<pre class="example" id="org50e0153">
Test Loss: 0.059497

Test Accuracy of     0: 99% (974/980)
Test Accuracy of     1: 99% (1127/1135)
Test Accuracy of     2: 97% (1009/1032)
Test Accuracy of     3: 98% (994/1010)
Test Accuracy of     4: 97% (960/982)
Test Accuracy of     5: 97% (867/892)
Test Accuracy of     6: 98% (941/958)
Test Accuracy of     7: 98% (1008/1028)
Test Accuracy of     8: 97% (947/974)
Test Accuracy of     9: 97% (986/1009)
</pre></div>
</div>
<div class="outline-2" id="outline-container-orga324222">
<h2 id="orga324222">Visualize Test Results</h2>
<div class="outline-text-2" id="text-orga324222">
<div class="highlight">
<pre><span></span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">test_batches</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="c1"># matplotlib doesn't like the CUDA and the model doesn't like the CPU... too bad for the model.</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># prep images for display</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># plot the images in the batch, along with predicted and true labels</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Test Predictions"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">))</span>

<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())),</span>
                 <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s2">"green"</span> <span class="k">if</span> <span class="n">preds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">else</span> <span class="s2">"red"</span><span class="p">))</span>
<span class="n">figure</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
<div class="figure" id="org5ccf086">
<p><img alt="test_results.png" src="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/test_results.png"></p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orge26da5d">
<h2 id="orge26da5d">Object-Oriented Trainer</h2>
<div class="outline-text-2" id="text-orge26da5d">
<p>This just bundles up the earlier stuff.</p>
<div class="highlight">
<pre><span></span> <span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
<span class="w">     </span><span class="sd">"""Train-test-validate the model</span>

<span class="sd">     Args:</span>
<span class="sd">      train: training batches</span>
<span class="sd">      validate: validation batches</span>
<span class="sd">      test: testing batches</span>
<span class="sd">      epochs: number of times to repeat training over the batches</span>
<span class="sd">      model_filename: name to save the hyperparameters of best model</span>
<span class="sd">      learning_rate: how much to update the weights</span>
<span class="sd">     """</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
                  <span class="n">validate</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
                  <span class="n">test</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
                  <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                  <span class="n">model_filename</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"multilayer_perceptron.pth"</span><span class="p">,</span>
                  <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">training_batches</span> <span class="o">=</span> <span class="n">train</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">validation_batches</span> <span class="o">=</span> <span class="n">validate</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">test_batches</span> <span class="o">=</span> <span class="n">test</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">save_as</span> <span class="o">=</span> <span class="n">model_filename</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">validation_losses</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">training_losses</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">validation_accuracies</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">training_accuracies</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">best_parameters</span> <span class="o">=</span> <span class="kc">None</span>
         <span class="k">return</span>

     <span class="nd">@property</span>
     <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">         </span><span class="sd">"""The Multi-Layer Perceptron"""</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span> <span class="o">=</span> <span class="n">MultiLayerPerceptron</span><span class="p">()</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>

     <span class="nd">@property</span>
     <span class="k">def</span> <span class="nf">criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">         </span><span class="sd">"""The Loss Measurer"""</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span>

     <span class="nd">@property</span>
     <span class="k">def</span> <span class="nf">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">         </span><span class="sd">"""The gradient descent"""</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                                               <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span>

     <span class="nd">@property</span>
     <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">         </span><span class="sd">"""The CPU or GPU"""</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">)</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span>


     <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="p">:</span>
<span class="w">         </span><span class="sd">"""process one batch of the data</span>

<span class="sd">        Args:</span>
<span class="sd">         data: data to use to predict target</span>
<span class="sd">         target: what we're trying to predict</span>
<span class="sd">         device: cpu or gpu</span>

<span class="sd">        Returns:</span>
<span class="sd">         outcome: loss and correct count</span>
<span class="sd">        """</span>
         <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
         <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
         <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
         <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

     <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="p">:</span>
<span class="w">         </span><span class="sd">"""Perform one forward pass through the batches</span>

<span class="sd">        Returns:</span>
<span class="sd">         outcome: cumulative loss, accuracy for the batches</span>
<span class="sd">        """</span>
         <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
         <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">total_correct</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
         <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_batches</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
             <span class="n">loss</span><span class="p">,</span> <span class="n">correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
             <span class="n">count</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
             <span class="n">total_correct</span> <span class="o">+=</span> <span class="n">correct</span>
             <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span>
             <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
             <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
             <span class="k">del</span> <span class="n">loss</span>
         <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_loss</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_correct</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="p">:</span>
<span class="w">         </span><span class="sd">"""Calculate the loss for the model</span>

<span class="sd">        Returns:</span>
<span class="sd">         Outcome: Cumulative loss, Accuracy over batches</span>
<span class="sd">        """</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
         <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
         <span class="n">total_correct</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_batches</span><span class="p">:</span>
             <span class="n">loss</span><span class="p">,</span> <span class="n">correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
             <span class="n">count</span> <span class="o">+=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
             <span class="n">total_correct</span> <span class="o">+=</span> <span class="n">correct</span>
             <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
             <span class="k">del</span> <span class="n">loss</span>
         <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_loss</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_correct</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">run_training</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">         </span><span class="sd">"""Runs the training and validation"""</span>
         <span class="n">lowest_validation_loss</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">Inf</span>
         <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
             <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
             <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">training_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
             <span class="n">mean_training_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_batches</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">training_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
             <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">validation_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
             <span class="n">mean_validation_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_batches</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">validation_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>

             <span class="k">if</span> <span class="n">mean_validation_loss</span> <span class="o">&lt;=</span> <span class="n">lowest_validation_loss</span><span class="p">:</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">{}</span><span class="s1">: Validation loss decreased (</span><span class="si">{:.6f}</span><span class="s1"> --&gt; </span><span class="si">{:.6f}</span><span class="s1">).  Saving model ...'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="n">epoch</span><span class="p">,</span>
                     <span class="n">lowest_validation_loss</span><span class="p">,</span>
                     <span class="n">mean_validation_loss</span><span class="p">))</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">best_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
                 <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_as</span><span class="p">)</span>
                 <span class="n">lowest_validation_loss</span> <span class="o">=</span> <span class="n">mean_validation_loss</span>
         <span class="k">return</span>

     <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">         </span><span class="sd">"""Test Our Model"""</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"call ``run_training`` or set ``best_parameters"</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_parameters</span><span class="p">)</span>
         <span class="n">test_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
         <span class="n">digits</span> <span class="o">=</span> <span class="mi">10</span>
         <span class="n">class_correct</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">digits</span>
         <span class="n">class_total</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">digits</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

         <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_batches</span><span class="p">:</span>
             <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
             <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
             <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
             <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

             <span class="n">_</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
             <span class="n">correct</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span>
                 <span class="n">target</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">predictions</span><span class="p">)))</span>
             <span class="c1"># calculate test accuracy for each object class</span>
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
                 <span class="n">label</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                 <span class="n">class_correct</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                 <span class="n">class_total</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

         <span class="c1"># calculate and print avg test loss</span>
         <span class="n">test_loss</span> <span class="o">=</span> <span class="n">test_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_batches</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
         <span class="nb">print</span><span class="p">(</span><span class="s1">'Test Loss: </span><span class="si">{:.6f}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_loss</span><span class="p">))</span>

         <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
             <span class="k">if</span> <span class="n">class_total</span><span class="p">[</span><span class="n">digit</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">'Test Accuracy of </span><span class="si">%5s</span><span class="s1">: </span><span class="si">%2d%%</span><span class="s1"> (</span><span class="si">%2d</span><span class="s1">/</span><span class="si">%2d</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">digit</span><span class="p">),</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">class_correct</span><span class="p">[</span><span class="n">digit</span><span class="p">]</span> <span class="o">/</span> <span class="n">class_total</span><span class="p">[</span><span class="n">digit</span><span class="p">],</span>
                     <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">class_correct</span><span class="p">[</span><span class="n">digit</span><span class="p">]),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">class_total</span><span class="p">[</span><span class="n">digit</span><span class="p">])))</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s1">'Test Accuracy of </span><span class="si">%5s</span><span class="s1">: N/A (no training examples)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">digit</span><span class="p">]))</span>
         <span class="k">return</span>
</pre></div>
<p>For some reason, this raises an error when the backward propagation step is run.</p>
<pre class="example" id="org09b81de">
RuntimeError: CUDA error: out of memory
</pre>
<p>So I can't run it until I figure out what's going on. <b>Update</b> - it looks like casting the outputs of the functions to floats solved the problem. Apparently even they look like floats, whatever the <code>item()</code> method returns prevents the freeing up of the memory, so casting them to floats fixes the memory problem.</p>
<div class="highlight">
<pre><span></span> <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">training_batches</span><span class="p">,</span> <span class="n">validation_batches</span><span class="p">,</span> <span class="n">test_batches</span><span class="p">)</span>
 <span class="n">trainer</span><span class="o">.</span><span class="n">run_training</span><span class="p">()</span>
</pre></div>
<pre class="example" id="org64172d5">
Epoch 1: Validation loss decreased (inf --&gt; 0.077417).  Saving model ...
Epoch 2: Validation loss decreased (0.077417 --&gt; 0.058746).  Saving model ...
Epoch 3: Validation loss decreased (0.058746 --&gt; 0.048325).  Saving model ...
Epoch 4: Validation loss decreased (0.048325 --&gt; 0.040851).  Saving model ...
Epoch 5: Validation loss decreased (0.040851 --&gt; 0.036083).  Saving model ...
Epoch 6: Validation loss decreased (0.036083 --&gt; 0.032722).  Saving model ...
Epoch 7: Validation loss decreased (0.032722 --&gt; 0.028545).  Saving model ...
Epoch 8: Validation loss decreased (0.028545 --&gt; 0.026376).  Saving model ...
Epoch 9: Validation loss decreased (0.026376 --&gt; 0.024063).  Saving model ...
Epoch 10: Validation loss decreased (0.024063 --&gt; 0.023637).  Saving model ...
Epoch 11: Validation loss decreased (0.023637 --&gt; 0.021980).  Saving model ...
Epoch 12: Validation loss decreased (0.021980 --&gt; 0.020723).  Saving model ...
Epoch 13: Validation loss decreased (0.020723 --&gt; 0.019802).  Saving model ...
Epoch 14: Validation loss decreased (0.019802 --&gt; 0.019013).  Saving model ...
Epoch 15: Validation loss decreased (0.019013 --&gt; 0.018458).  Saving model ...
Epoch 16: Validation loss decreased (0.018458 --&gt; 0.017919).  Saving model ...
Epoch 17: Validation loss decreased (0.017919 --&gt; 0.017918).  Saving model ...
Epoch 18: Validation loss decreased (0.017918 --&gt; 0.017127).  Saving model ...
Epoch 19: Validation loss decreased (0.017127 --&gt; 0.016704).  Saving model ...
Epoch 20: Validation loss decreased (0.016704 --&gt; 0.016167).  Saving model ...
Epoch 22: Validation loss decreased (0.016167 --&gt; 0.016154).  Saving model ...
Epoch 23: Validation loss decreased (0.016154 --&gt; 0.015817).  Saving model ...
Epoch 24: Validation loss decreased (0.015817 --&gt; 0.015352).  Saving model ...
Epoch 25: Validation loss decreased (0.015352 --&gt; 0.015075).  Saving model ...
Epoch 27: Validation loss decreased (0.015075 --&gt; 0.015059).  Saving model ...
Epoch 28: Validation loss decreased (0.015059 --&gt; 0.014940).  Saving model ...
Epoch 32: Validation loss decreased (0.014940 --&gt; 0.014644).  Saving model ...
Epoch 34: Validation loss decreased (0.014644 --&gt; 0.014383).  Saving model ...
Epoch 46: Validation loss decreased (0.014383 --&gt; 0.014357).  Saving model ...
</pre>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">training_accuracies</span><span class="p">)))</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Model Accuracy"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">training_accuracies</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Training"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">validation_accuracies</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Validation"</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
<div class="figure" id="orgdffa086">
<p><img alt="accuracy.png" src="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/accuracy.png"></p>
</div>
<p>Although the validation loss decreases for a while, it nearly reaches its peak accuracy around 10 epochs. The training worked out a little differently this time, so here's the losses again.</p>
<div class="highlight">
<pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">training_losses</span><span class="p">)))</span>
<span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Loss Per Batch"</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">"bold"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">training_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Training"</span><span class="p">)</span>
<span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">validation_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Validation"</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">axe</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
<div class="figure" id="orgc13ec5a">
<p><img alt="losses_2.png" src="posts/nano/cnn/mnist-multi-layer-perceptron-with-validation/losses_2.png"></p>
</div>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="previous"><a href="index-7.html" rel="prev">Newer posts</a></li>
<li class="next"><a href="index-5.html" rel="next">Older posts</a></li>
</ul>
<!--End of body content-->
<footer id="footer">Scribbles by <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a>
<div id="license" xmlns:cc="http://creativecommons.org/ns#">This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" rel="license noopener noreferrer" style="display:inline-block;" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"></a></div>
</footer>
</div>
</div>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
